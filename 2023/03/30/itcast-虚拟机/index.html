

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="JVM内存结构">
<meta property="og:type" content="article">
<meta property="og:title" content="虚拟机-itcast">
<meta property="og:url" content="http://example.com/2023/03/30/itcast-%E8%99%9A%E6%8B%9F%E6%9C%BA/index.html">
<meta property="og:site_name" content="FGCY-BLOG">
<meta property="og:description" content="JVM内存结构">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/images/itcast.png">
<meta property="article:published_time" content="2023-03-30T09:56:03.000Z">
<meta property="article:modified_time" content="2023-03-30T14:03:34.178Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="java虚拟机-itcast">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/images/itcast.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>虚拟机-itcast - FGCY-BLOG</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":333,"cursorChar":"%","loop":true,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>FGCY-BLOG</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>主页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签列表</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于我</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/playlist/">
                <i class="iconfont icon-music"></i>
                <span>音乐</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="虚拟机-itcast"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-03-30 17:56" pubdate>
          March 30, 2023 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    

    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> views
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">虚拟机-itcast</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="JVM内存结构"><a href="#JVM内存结构" class="headerlink" title="JVM内存结构"></a>JVM内存结构</h2><span id="more"></span> 

<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823215451825.png" srcset="/img/loading.gif" lazyload alt="image-20220823215451825"></p>
<ol>
<li>创建main线程（有JVM栈为其分配内存）</li>
<li>看方法区中是否有main方法所属类的信息，没有就会触发类加载行为【将字节码文件的所有原始信息(类名，继承关系，成员变量，方法)都行加载进方法区】</li>
<li>将方法区中的main方法提取到栈中运行</li>
<li>遇到类查看方法区中是否有该类，如果没有就触发类加载</li>
<li>方法中的局部变量占有的是当前线程的栈内存，对象占用的是堆内存<br>虚拟机栈:在JVM规范中，方法分为本地方法和java方法，如hashcode是本地方法，study是java方法；但是，oracle的hotspot虚拟机没有实现此规范，只有一个JVM 			Stack；要使用本地方法就要通过本地方法接口调用本地库<br>程序计数器:程序计数器用于记录当前线程执行到第几行代码，即使线程被切换了，回来的时候也能记住是从第几行代码开始恢复执行<br>垃圾回收：当没有任何一个变量引用对象地址时，当内存不足时，就会触发垃圾回收gc，此时就会将没有被引用的对象所占的空间释放开<br>解释器：cup只认识机器码，并不认识字节码，需要通过解释器对字节码进行翻译；<br>即时编译器：即时编译器JIT负责发现热点代码，并将热点代码翻译成机器码，缓存起来的；等待下次有人调用这段代码时，直接从缓存中拿出机器码交给cpu执行，少了解释那一步，效率疯涨<br>属于线程私有的内存结构有:程序计数器、虚拟机栈<br>属于线程共享的内存结构有:堆和方法区</li>
</ol>
<h2 id="哪些部分会出现内存溢出"><a href="#哪些部分会出现内存溢出" class="headerlink" title="哪些部分会出现内存溢出"></a>哪些部分会出现内存溢出</h2><p>不会出现内存溢出的区域-程序计数器<br>出现OutOfMemoryError的情况</p>
<ol>
<li>堆内存耗尽-对象越来越多,又一直在使用,不能被垃圾回收</li>
<li>方法区内存耗尽-加载的类越来越多,很多框架都会在运行期间动态产生新的类（可以给方法区的内存设置上限，超过这个上限就会出OutOfMemoryError）；但是默认不会设置上限，即物理内存有多大，方法区就有多大</li>
<li>虚拟机栈累积-每个线程最多会占用1M内存,线程个数越来越多,而又长时间运行不销毁时【线程过多】出现StackOverflowError的情况虚拟机栈内部-方法调用次数过多(编程能力不足造成的，比如递归没有设置好出口)；溢出是因为每个线程最多占用1M内存，每次调用方法都需要从1M中拿部分内存，当线程内的1M内存用完了就会出现StackOverflowError【方法过多】</li>
</ol>
<h2 id="方法区与永久代、元空间之间的关系"><a href="#方法区与永久代、元空间之间的关系" class="headerlink" title="方法区与永久代、元空间之间的关系"></a>方法区与永久代、元空间之间的关系</h2><p>方法区是【JVM规范】中定义的一块内存区域,用来存储类元数据、方法字节码、即时编译器需要的信息等<br>永久代是Hotspot虚拟机对JVM规范的实现(1.8之前)<br>元空间是Hotspot虚拟机对JVM规范的实现(1.8以后),使用本地内存作为这些信息的存储空间【物理内存有多大，方法区就有多大】</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823215942253.png" srcset="/img/loading.gif" lazyload alt="image-20220823215942253"></p>
<hr>
<p>当对象c不再被人引用时，Y这个类也没人在使用；此时队中的c对象，Y.class对象可以被垃圾回收；但此时Y类在元空间中的信息不可以被卸载；只有当整个类加载器不再被使用时，被它加载的类的元空间信息才会被卸载；<br>当内存不足，触发gc，将所有没人引用的对象清除掉；此时类加载器发现自己所有的类都被回收了，那它也会被回收；类加载器没了之后才会去将元空间中相关类的原始信息卸载掉<br>一般来说，系统的类加载器是没有机会被回收的，只有自定义的类加载器才有可能被回收</p>
<h2 id="对于JVM内存配置参数"><a href="#对于JVM内存配置参数" class="headerlink" title="对于JVM内存配置参数"></a>对于JVM内存配置参数</h2><h3 id="堆内存设置"><a href="#堆内存设置" class="headerlink" title="堆内存设置"></a>堆内存设置</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs routeros">-Xmx10240m -Xms10240m -Xmn5120m -XX:<span class="hljs-attribute">SurvivorRatio</span>=3其最小内存值和Survivor区总大小分别是<br><br>-Xmx10240m：JVM最大内存是10G<br>-Xms10240m：JVM最小内存是10G<br>-Xmn5120m：JVM新生代内存是5G<br><span class="hljs-attribute">SurvivorRatio</span>=3：eden区比from区是3：1<br>survivor区包含<span class="hljs-keyword">from</span>区和<span class="hljs-keyword">to</span>区(1:1)<br></code></pre></td></tr></table></figure>

<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823220056427.png" srcset="/img/loading.gif" lazyload alt="image-20220823220056427"></p>
<hr>
<p>最小内存是5G survivor内存大小为2G</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823220147367.png" srcset="/img/loading.gif" lazyload alt="image-20220823220147367"></p>
<hr>
<h3 id="元空间内存分类"><a href="#元空间内存分类" class="headerlink" title="元空间内存分类"></a>元空间内存分类</h3><hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823220319923.png" srcset="/img/loading.gif" lazyload alt="image-20220823220319923"></p>
<hr>
<p>class space：放置类的基本信息 类名，方法入口【包含两个表，itable和vtable】<br>non-class space：放置方法的字节码，类上的注解<br>-XX:CompressedClassSpaceSize:用来设置class-space区的上限大小，默认初始是一个G<br>–XX:MaxMetaspaceSize:最大元空间大小上限【默认是不设置的，即没有大小限制，物理硬盘有多大，原空间大小就有多大】</p>
<h3 id="代码缓存"><a href="#代码缓存" class="headerlink" title="代码缓存"></a>代码缓存</h3><hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823220442153.png" srcset="/img/loading.gif" lazyload alt="image-20220823220442153"></p>
<hr>
<p>JIT即时编译器:将热点代码编译成机器码缓存起来，缓存的地方就是CodeCache<br>当<code>-XX:ReservedCodeCacheSize&lt;240m</code>时，会将所有的机器码放在一块<br><code>当-XX:ReservedCodeCacheSize&gt;=240m</code>时,会分为三个区域；<br>    1. non-nmthods:jit自己使用的一些代码<br>    2. prodflednmthods:部分优化后的代码<br>    3. non-profilednmthods:经过完整优化后的代码</p>
<h3 id="线程内存"><a href="#线程内存" class="headerlink" title="线程内存"></a>线程内存</h3><hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823220526715.png" srcset="/img/loading.gif" lazyload alt="image-20220823220526715"></p>
<hr>
<p>控制每个线程占用的内存，64位的linux操作系统每个线程占用一兆内存</p>
<h2 id="JVM垃圾回收算法"><a href="#JVM垃圾回收算法" class="headerlink" title="JVM垃圾回收算法"></a>JVM垃圾回收算法</h2><ol>
<li>标记清除</li>
</ol>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823220603957.png" srcset="/img/loading.gif" lazyload alt="image-20220823220603957"></p>
<hr>
<ol>
<li>找到GC Root对象(一定不能被回收的对象)【局部变量正在使用的对象，静态变量引用的对象】</li>
<li>找根对象以及被根对象直接或间接引用的对象，给它加上标记</li>
<li>有标记的对象给它保留下来，没有标记的对象直接给他清除</li>
</ol>
<p>问题：<br>释放后的内存大概率时不连续的，造成内存碎片问题<br>当想要创建一片连续的空间时，发现内存还是不足<br>所以现在大部分的垃圾回收器都不使用标记清除算法</p>
<ol start="2">
<li>标记整理</li>
</ol>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-26_13-06-20.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<ol>
<li><p>找到根对象以及根对象直接或间接引用的对象</p>
</li>
<li><p>对这些对象进行标记</p>
</li>
<li><p>将没有标记的对象释放掉</p>
</li>
<li><p>将存活的对象向一边无缝隙靠拢(解决内存碎片问题)<br>因为多了整理的步骤【发生内存复制，计算引用地址】所以效率变低</p>
</li>
<li><p>标记复制</p>
</li>
</ol>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-26_13-15-10.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<p>FROM空间专门用来存储对象，TO空间一开始什么东西都不存</p>
<ol>
<li>找到GC Root对象以及被他们直接或间接引用的对象</li>
<li>对这些对象进行标记</li>
<li>将有标记的对象复制一份到TO(空闲区)【也不存在内存碎片问题】</li>
<li>将FROM区中的对象全部释放掉<br>问题<br>  空间换时间，内存占用多</li>
</ol>
<ul>
<li>小结</li>
</ul>
<p>标记清除法，现在已经没有使用的<br>复制标记法比较适合新生代的垃圾回收【存活的对象少，清除的对象多】<br>复制标记法不适合老年代的垃圾回收【存活的对象多 ，清除的对象少】，所以老年代更适合标记整理法</p>
<h2 id="说说GC和分代回收算法"><a href="#说说GC和分代回收算法" class="headerlink" title="说说GC和分代回收算法"></a>说说GC和分代回收算法</h2><p>GC的目的在于</p>
<ol>
<li>实现无用对象内存自动释放,</li>
<li>减少内存碎片</li>
<li>加快分配速度</li>
</ol>
<p>GC要点:</p>
<pre><code class="hljs">   1. 回收区域是堆内存,不包括虚拟机栈,在方法调用结束会自动释放方法占用内存
   2. 判断无用对象,使用可达性分析算法【找到GC Root以及被它直接或间接引用的对象】,三色标记法标记存活对象,回收未标记对象
   3. GC具体的实现称为垃圾回收器【并行垃圾回收器，CMS垃圾回收器，GOne垃圾回收器】
   4. GC大都采用了分代回收思想,理论依据是大部分对象朝生夕灭,用完立刻就可以回收,另有少部分对象会长时间存活,每次很难回收,根据这两类对象的特性将回收区域分为新生代【朝生夕灭的对象，频繁运行GC】和老年代【长时间存活的对象，长间隔运行GC】,不同区域应用不同的回收策略
   5. 根据GC的规模可以分成 Minor GC【对新生代进行垃圾回收，小范围垃圾回收，暂停时间短，对系统影响较小】, Mixed GC【新生代发生垃圾回收，部分老年代也发生垃圾回收】, Full GC【对新生代和老年代都进行一次垃圾回收，暂停时间长，能明显感受到系统卡顿】
</code></pre>
<h2 id="分代回收与GC规模"><a href="#分代回收与GC规模" class="headerlink" title="分代回收与GC规模"></a>分代回收与GC规模</h2><h3 id="分代回收"><a href="#分代回收" class="headerlink" title="分代回收"></a>分代回收</h3><p>伊甸园 eden,最初对象都分配到这里,与幸存区合称新生代<br>幸存区survivor,当伊甸园内存不足,回收后的幸存对象到这里,分成from 和to,采用标记复制算法<br>老年代old,当幸存区对象熬过(不确定)几次回收(最多15次,即熬过15次必晋升),晋升到老年代(幸存区内存不足或大对象会导致提前晋升)</p>
<ul>
<li>1</li>
</ul>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823220858278.png" srcset="/img/loading.gif" lazyload alt="image-20220823220858278"></p>
<hr>
<ul>
<li>2</li>
</ul>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-26_15-34-36.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<ul>
<li>3</li>
</ul>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823221046921.png" srcset="/img/loading.gif" lazyload alt="image-20220823221046921"></p>
<hr>
<ul>
<li>4</li>
</ul>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-26_15-44-23.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<h3 id="GC规模"><a href="#GC规模" class="headerlink" title="GC规模"></a>GC规模</h3><ol>
<li>Minor GC发生在新生代的垃圾回收,暂停时间短【上面演示的都是发生在新生代的Minor GC】</li>
<li>Mixed GC新生代(新生代全部回收一遍)+老年代部分区域(老年区划分为多个区域，挑其中回收价值较高的区域)的垃圾回收, G1收集器特有</li>
<li>Full GC新生代+老年代完整垃圾回收,暂停时间长,应尽力避免</li>
</ol>
<h2 id="三色标记与并发漏标问题"><a href="#三色标记与并发漏标问题" class="headerlink" title="三色标记与并发漏标问题"></a>三色标记与并发漏标问题</h2><h3 id="用三种颜色记录对象的标记状态"><a href="#用三种颜色记录对象的标记状态" class="headerlink" title="用三种颜色记录对象的标记状态"></a>用三种颜色记录对象的标记状态</h3><p>黑色-已标记<br>    沿着根对象找到的引用对象，并且该对象内部的其他引用也已经完成了标记<br>灰色-标记中<br>    沿着根对象找到的引用对象，但是该对象内部的其他引用还未被处理完【正在处理中】<br>白色-还未标记<br>    沿着根对象找到的引用对象，该对象没有被处理且该对象内部的其他引用也没被处理</p>
<ul>
<li>总结</li>
</ul>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823221225381.png" srcset="/img/loading.gif" lazyload alt="image-20220823221225381"></p>
<hr>
<p>正在处理的对象标记为灰色，被它引用的对象标记为白色<br>处理完成的对象标记为黑色，被它引用的对象标记为灰色<br>没有被处理的对象标记为白色，被它引用的对象标记为白色<br>沿着引用链进行迭代，最后将黑色标记的对象保留，将白色标记的对象清除</p>
<h3 id="并发漏标问题"><a href="#并发漏标问题" class="headerlink" title="并发漏标问题"></a>并发漏标问题</h3><p>标记对象状态是使用垃圾回收线程执行的（垃圾回收线程）<br>用户编写的业务代码是在用户线程中运行的（用户线程）<br>在早期的垃圾回收器中，垃圾回收线程和用户线程是不能同时运行的，垃圾回收线程一但执行，用户线程就得马上停止<br>现在的垃圾回收器支持并发，但不是所有情况下都能并发<br>一种典型的并发场景：老年代的垃圾回收器在进行标记的时候是可以并发的；</p>
<ul>
<li>漏标问题-记录标记过程中变化</li>
</ul>
<ol>
<li>Incremental Update(增量更新)<br>只要赋值发生,【被赋值的对象】就会被记录<br>垃圾回收线程会记录所有的赋值动作，将被赋值的对象的标记改为灰色；<br>当并发标记完成后，会让用户线程停止，对并发标记过程中，记录下来的 标记改变的对象进行处理(重新标记)</li>
<li>Snapshot At The Beginning(原始快照), SATB<br>新加对象会被记录<br>被删除引用关系的对象也被记录<br>当并发标记完成后，会让用户线程停止，对并发标记过程中，记录下来的 标记改变的对象进行处理(重新标记)</li>
</ol>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-26_16-57-15.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<h2 id="垃圾回收器"><a href="#垃圾回收器" class="headerlink" title="垃圾回收器"></a>垃圾回收器</h2><h3 id="1-Parallel-GC（并行的垃圾回收）"><a href="#1-Parallel-GC（并行的垃圾回收）" class="headerlink" title="1. Parallel GC（并行的垃圾回收）"></a>1. Parallel GC（并行的垃圾回收）</h3><p>有两个垃圾回收器组成:工作代&amp;新生代、工作代老年代<br>特点：</p>
<ol>
<li>eden 内存不足发生Minor GC(新生代),回收算法：标记复制STW(Stop ths work)应用程序暂停，暂停时间短</li>
<li>old 内存不足发生Full GC【新生代和老年代都要进行GC】,新生代使用的回收算法:标记复制法，暂停时间短；老年代使用的算法：标记整理STW，暂停时间长</li>
<li>注重吞吐量</li>
<li>虽然会暂停，但它会启动多个线程执行垃圾回收</li>
</ol>
<h3 id="2-ConcurrentMarkSweep-GC"><a href="#2-ConcurrentMarkSweep-GC" class="headerlink" title="2. ConcurrentMarkSweep GC"></a>2. ConcurrentMarkSweep GC</h3><ol>
<li>old并发标记【有漏标问题】,重新标记时需要STW,并发清除，标记和清除的时候用户线程和GC都可以同时运行，但是重新标记的时候必须停止用户线程【使用标记清除算法，有内存碎片问题】</li>
<li>Failback【并发失败的保底策略，并发速度小于对象创造速度就会失败，失败就会触发—–》 Full GC【stw停止用户线程，让新生代和老年代都进行一次彻底GC】</li>
<li>注重响应时间</li>
<li>在最新的jdk中把它标记为废弃</li>
</ol>
<h3 id="3-G1-GC"><a href="#3-G1-GC" class="headerlink" title="3. G1 GC"></a>3. G1 GC</h3><ol>
<li>响应时间与吞吐量兼顾，综合能力强</li>
<li>将整个堆内存划分成多个大小相等的区域,每个区域都可以充当eden,survivor, old, humongous【存放大对象】</li>
<li>新生代回收:eden 内存不足,标记复制STW</li>
<li>并发标记:old并发标记,重新标记时需要STW</li>
<li>混合收集(既有新生代的内存释放，又有老年代的内存释放):并发标记完成,开始混合收集,参与复制的有eden、survivor, old,其中 old会根据暂停时间目标,选择部分回收价值高的区域,复制时STW</li>
<li>Failback Full GC</li>
</ol>
<p>【jdk9默认的垃圾回收器】</p>
<ul>
<li>新生代垃圾回收1</li>
</ul>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823221538595.png" srcset="/img/loading.gif" lazyload alt="image-20220823221538595"></p>
<hr>
<ol>
<li>将整个堆内存划分为多个大小相等的区域，这些区域叫region，每个区域都可以充当eden,survivor, old, humongous</li>
<li>当我们创建对象时就会挑选一些空的区域作为eden区</li>
<li>随着对象越来越多，之前创建的eden区内存用完了【eden的大小会受到整个新生代的限制的，G1会自动调整新生代内存大小，有限制，在一定范围内波动】，触发GC</li>
<li>垃圾回收算法采用标记复制算法，标记和复制的过程都会stw复制到survivor</li>
<li>复制完成后可以将Eden区释放掉，是释放Eden区，不是仅仅释放对象</li>
</ol>
<ul>
<li>新生代垃圾回收2</li>
</ul>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823221800589.png" srcset="/img/loading.gif" lazyload alt="image-20220823221800589"></p>
<hr>
<ol>
<li>当创建的对象越来越多，eden区的空间已经全部用完时，触发GC</li>
<li>将Eden区和上一个survivor区的幸存者对象复制到新的survivor区中；当发现上一个survivor区中有对象满足晋升条件时，会晋升到老年代</li>
<li>释放掉eden区和上一次的survivor区</li>
</ol>
<ul>
<li>并发标记1</li>
</ul>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823221909009.png" srcset="/img/loading.gif" lazyload alt="image-20220823221909009"></p>
<hr>
<p>老年代的占比达到整个堆内存的45%以上<br>在老年代中寻找存活对象，对其做出标记，与用户线程并发执行【采用原始快照法，解决漏标问题】<br>在老年代中挑选存活对象少，回收价值高的区域进行回收,还有eden区，上一批survivor区，做一次垃圾回收；<br>eden区，survivor区中，存活下来的对象，复制到新的survivor区<br>上一批达到晋升条件的survivor区中的对象，和old区中存活的对象，复制到新的old区<br>释放掉eden区，survivor区，old区的内存<br>多次执行混合收集，逐步将old区的内存释放掉，然后循环执行新生代回收，并发标记，混合回收<br>当对象清除速度小于对象创造速度，就会触发保底策略，Full GC</p>
<h2 id="项目什么情况下会内存溢出，怎么解决"><a href="#项目什么情况下会内存溢出，怎么解决" class="headerlink" title="项目什么情况下会内存溢出，怎么解决"></a>项目什么情况下会内存溢出，怎么解决</h2><h3 id="误用线程池导致的内存溢出1"><a href="#误用线程池导致的内存溢出1" class="headerlink" title="误用线程池导致的内存溢出1"></a>误用线程池导致的内存溢出1</h3><ul>
<li>Executors.newFixedThreadPool</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> day03;<br><br><span class="hljs-keyword">import</span> day02.LoggerUtils;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.ExecutorService;<br><span class="hljs-keyword">import</span> java.util.concurrent.Executors;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-comment">// -Xmx64m</span><br><span class="hljs-comment">// 模拟短信发送超时，但这时仍有大量的任务进入队列导致内存溢出</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestOomThreadPool</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">2</span>);<br>        LoggerUtils.get().debug(<span class="hljs-string">&quot;begin...&quot;</span>);<br>        <span class="hljs-comment">//不停创建任务提交到线程池中</span><br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-comment">//前两个任务由线程池的两个核心线程为其服务，后面提交的任务添加到阻塞队列中</span><br>            executor.submit(()-&gt;&#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    LoggerUtils.get().debug(<span class="hljs-string">&quot;send sms...&quot;</span>);<br>                    <span class="hljs-comment">//是对Thread.sleep方法的包装，实现是一样的，只是多了时间单位转换和验证，然而TimeUnit枚举成员的方法却提供更好的可读性</span><br>                    TimeUnit.SECONDS.sleep(<span class="hljs-number">30</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;);<br>        &#125;<br>    &#125;<br>&#125;<br>------------------------Executors---------------------------------------------<br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ExecutorService <span class="hljs-title function_">newFixedThreadPool</span><span class="hljs-params">(<span class="hljs-type">int</span> nThreads)</span> &#123;<br>    <span class="hljs-comment">//核心线程数=最大线程数，即 救急线程数0</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(nThreads, nThreads,<br>                                      <span class="hljs-comment">//救急线程不工作多长时间就会被回收</span><br>                                      <span class="hljs-number">0L</span>, TimeUnit.MILLISECONDS,<br>                                      <span class="hljs-comment">//存放任务的阻塞队列，不填参数就是整数有多大，它的容量有多大</span><br>                                      <span class="hljs-comment">//Integer.MAX_VALUE 0x7fffffff</span><br>                                      <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;());<br>&#125;<br><br><br>=======================<br>[DEBUG] <span class="hljs-number">10</span>:<span class="hljs-number">03</span>:<span class="hljs-number">36.331</span> [main] - begin... <br>[DEBUG] <span class="hljs-number">10</span>:<span class="hljs-number">03</span>:<span class="hljs-number">36.333</span> [pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>] - send sms... <br>[DEBUG] <span class="hljs-number">10</span>:<span class="hljs-number">03</span>:<span class="hljs-number">36.333</span> [pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">2</span>] - send sms... <br><br>Exception: java.lang.OutOfMemoryError thrown from the UncaughtExceptionHandler in thread <span class="hljs-string">&quot;main&quot;</span><br><br>进程已结束，退出代码为 <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>





<ul>
<li>Executors.newCachedThreadPool</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> day03;<br><br><span class="hljs-keyword">import</span> day02.LoggerUtils;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.ExecutorService;<br><span class="hljs-keyword">import</span> java.util.concurrent.Executors;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><br><span class="hljs-comment">// 模拟发送大量短信，此时创建大量线程运行任务，导致系统线程数用完</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestOomThreadPool</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newCachedThreadPool();<br>        LoggerUtils.get().debug(<span class="hljs-string">&quot;begin...&quot;</span>);<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            executor.submit(() -&gt; &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    LoggerUtils.get().debug(<span class="hljs-string">&quot;send sms...&quot;</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;);<br>        &#125;<br>    &#125;<br>&#125;<br>---------------------------Executors.newCachedThreadPool--------------------------------------<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ExecutorService <span class="hljs-title function_">newCachedThreadPool</span><span class="hljs-params">()</span> &#123;<br>    	<span class="hljs-comment">//核心线程数量为0，救急线程数量为整数最大值</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(<span class="hljs-number">0</span>, Integer.MAX_VALUE,<br>                                      <span class="hljs-comment">//救急线程不工作60秒就会被回收</span><br>                                      <span class="hljs-number">60L</span>, TimeUnit.SECONDS,<br>                                      <span class="hljs-comment">//创建一个只能容纳一个任务的队列</span><br>                                      <span class="hljs-keyword">new</span> <span class="hljs-title class_">SynchronousQueue</span>&lt;Runnable&gt;());<br>    &#125;<br><br>===================================================<br>别跑这段代码，会死机<br></code></pre></td></tr></table></figure>





<h3 id="查询数据量太大导致的内存溢出"><a href="#查询数据量太大导致的内存溢出" class="headerlink" title="查询数据量太大导致的内存溢出"></a>查询数据量太大导致的内存溢出</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> day03;<br><br><span class="hljs-keyword">import</span> org.openjdk.jol.info.ClassLayout;<br><br><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br><br><span class="hljs-comment">// 演示对象的内存估算</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestOomTooManyObject</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">// 【jol-core】对象本身内存仅包含对象头以及基本数据类型的成员变量的大小</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> ClassLayout.parseInstance(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>()).instanceSize();<br>        System.out.println(<span class="hljs-string">&quot;对象本身内存仅包含对象头以及基本数据类型的成员变量的大小:(Product)&quot;</span> + a);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;联想小新Air14轻薄本 英特尔酷睿i5 14英寸全面屏学生笔记本电脑(i5-1135G7 16G 512G MX450独显 高色域)银&quot;</span>;<br>        <span class="hljs-comment">// 一个字符串占用内存【就只是字符串对象的对象头大小，不包含内容】</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> ClassLayout.parseInstance(name).instanceSize();<br>        System.out.println(<span class="hljs-string">&quot;对象本身内存仅包含对象头以及基本数据类型的成员变量的大小(String):&quot;</span> + b);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">desc</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;【全金属全面屏】学生商务办公，全新11代处理器，MX450独显，100%sRGB高色域，指纹识别，快充（更多好货）&quot;</span>;<br>        <span class="hljs-comment">// 一个字符串占用内存【就只是字符串对象的对象头大小，不包含内容】</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> ClassLayout.parseInstance(desc).instanceSize();<br>        System.out.println(<span class="hljs-string">&quot;对象本身内存仅包含对象头以及基本数据类型的成员变量的大小(String):&quot;</span> + c);<br>        <span class="hljs-comment">//字节数组头以及基本数据类型的成员变量的大小16字节，加上存放数据的字节数组大小</span><br>        System.out.println(<span class="hljs-string">&quot;String对象头大小+数组对象头和属性大小+字节数组大小：(name)&quot;</span> + (<span class="hljs-number">16</span> + name.getBytes(StandardCharsets.UTF_8).length));<br>        System.out.println(<span class="hljs-string">&quot;String对象头大小+数组对象头和属性大小+字节数组大小：(desc)&quot;</span> + (<span class="hljs-number">16</span> + desc.getBytes(StandardCharsets.UTF_8).length));<br>        <span class="hljs-comment">// 一个对象估算的内存</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">avg</span> <span class="hljs-operator">=</span> a + b + c + <span class="hljs-number">16</span> + name.getBytes(StandardCharsets.UTF_8).length + <span class="hljs-number">16</span> + desc.getBytes(StandardCharsets.UTF_8).length;<br>        System.out.println(<span class="hljs-string">&quot;一个商品的大小：&quot;</span> + avg);<br>        <span class="hljs-comment">// ArrayList 24【对象头以及基本数据类型的成员变量的大小24字节】, Object[] 16 【数组头以及基本数据类型的成员变量的大小16字节】共 40</span><br>        <span class="hljs-comment">//一百万个商品对象+集合本身大小</span><br>        System.out.println(<span class="hljs-string">&quot;一百万个商品对象+集合本身大小:&quot;</span> + (<span class="hljs-number">1_000_000</span> * avg + <span class="hljs-number">40</span>) / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span> + <span class="hljs-string">&quot;Mb&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> id;<br>        <span class="hljs-keyword">private</span> String name;<br>        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> price;<br>        <span class="hljs-keyword">private</span> String desc;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> id;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> &#123;<br>            <span class="hljs-built_in">this</span>.id = id;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> name;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>            <span class="hljs-built_in">this</span>.name = name;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getPrice</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> price;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPrice</span><span class="hljs-params">(<span class="hljs-type">int</span> price)</span> &#123;<br>            <span class="hljs-built_in">this</span>.price = price;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDesc</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> desc;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setDesc</span><span class="hljs-params">(String desc)</span> &#123;<br>            <span class="hljs-built_in">this</span>.desc = desc;<br>        &#125;<br>    &#125;<br>&#125;<br>=========================================<br># WARNING: Unable to get Instrumentation. Dynamic Attach failed. You may add <span class="hljs-built_in">this</span> JAR as -javaagent manually, or supply -Djdk.attach.allowAttachSelf<br># WARNING: Unable to attach Serviceability Agent. sun.jvm.hotspot.memory.Universe.getNarrowOopBase()<br>对象本身内存仅包含对象头以及基本数据类型的成员变量的大小:(Product)<span class="hljs-number">32</span><br>对象本身内存仅包含对象头以及基本数据类型的成员变量的大小(String):<span class="hljs-number">24</span><br>对象本身内存仅包含对象头以及基本数据类型的成员变量的大小(String):<span class="hljs-number">24</span><br>String对象头大小+数组对象头和属性大小+字节数组大小：(name)<span class="hljs-number">144</span><br>String对象头大小+数组对象头和属性大小+字节数组大小：(desc)<span class="hljs-number">157</span><br>一个商品的大小：<span class="hljs-number">381</span><br>一百万个商品对象+集合本身大小:363Mb<br><br>进程已结束，退出代码为 <span class="hljs-number">0</span><span class="hljs-comment">//不要findAll</span><br></code></pre></td></tr></table></figure>







<h3 id="动态生成类导致的内存溢出"><a href="#动态生成类导致的内存溢出" class="headerlink" title="动态生成类导致的内存溢出"></a>动态生成类导致的内存溢出</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-keyword">package</span> day03;<br><br><span class="hljs-keyword">import</span> groovy.lang.GroovyShell;<br><br><span class="hljs-keyword">import</span> java.io.FileReader;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicInteger;<br><br><span class="hljs-comment">// -XX:MaxMetaspaceSize=24m</span><br><span class="hljs-comment">// 模拟不断生成类, 但类无法卸载的情况</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestOomTooManyClass</span> &#123;<br>    <span class="hljs-comment">//这个类的内部有一个自定义的类加载器，用于加载执行脚本的时候会动态生成类</span><br>    <span class="hljs-comment">//只要类加载器存在，或类存在，或实例存在，那么在元空间中这个类将一直存在</span><br>    <span class="hljs-comment">//又因为该引用该对象的变量用static修饰，所以这个对象将一直存在，它的成员变量类加载器也会一直存在，元空间中的类信息不会卸载，造成oom</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-type">GroovyShell</span> <span class="hljs-variable">shell</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GroovyShell</span>();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>();<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-keyword">try</span> (<span class="hljs-type">FileReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>(<span class="hljs-string">&quot;script&quot;</span>)) &#123;<br>                <span class="hljs-comment">//执行脚本的时候会动态生成类（每次都会生成一个）</span><br>                shell.evaluate(reader);<br>                System.out.println(c.incrementAndGet());<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br>=============================================<br>跑了<span class="hljs-number">2595</span>就耗尽元空间<br>Exception in thread <span class="hljs-string">&quot;main&quot;</span> java.lang.OutOfMemoryError: Metaspace<br>进程已结束，退出代码为 <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>





<ul>
<li>解决</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> day03;<br><br><span class="hljs-keyword">import</span> groovy.lang.GroovyShell;<br><br><span class="hljs-keyword">import</span> java.io.FileReader;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicInteger;<br><br><span class="hljs-comment">// -XX:MaxMetaspaceSize=24m</span><br><span class="hljs-comment">// 模拟不断生成类, 但类无法卸载的情况</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestOomTooManyClass</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>();<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-keyword">try</span> (<span class="hljs-type">FileReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>(<span class="hljs-string">&quot;script&quot;</span>)) &#123;<br>                <span class="hljs-comment">//将类定义成局部变量，这个对象不会一直存在，当方法跑完了，这个对象就不会被使用</span><br>                <span class="hljs-comment">//当堆内存不足触发GC时，会将这些没人使用的对象清除掉，此时，哪些动态生成的类，实例，加载这些类的类加载器全部被清除，会清除元空间这些类信息</span><br>                <span class="hljs-type">GroovyShell</span> <span class="hljs-variable">shell</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GroovyShell</span>();<br>                <span class="hljs-comment">//执行脚本的时候会动态生成类（每次都会生成一个）</span><br>                shell.evaluate(reader);<br>                System.out.println(c.incrementAndGet());<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br>======================================<br>跑到<span class="hljs-number">35546</span>，一点事都没有<br></code></pre></td></tr></table></figure>



<ul>
<li>打开jconsole观察</li>
</ul>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-27_11-49-55.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<h2 id="类加载过程"><a href="#类加载过程" class="headerlink" title="类加载过程"></a>类加载过程</h2><ul>
<li><p>类加载过程分为三个阶段</p>
<ol>
<li><p>加载</p>
</li>
<li><p>将类的字节码载入方法区,并创建 类.class对象(类对象)【加载到方法区中的字节码java代码是无法直接访问的，因为字节码里面的数据结构是采C++实现的】类对象存储在堆中</p>
</li>
<li><p>如果此类的父类|接口没有加载,先加载父类|接口</p>
</li>
<li><p>加载是懒惰执行 【当需要用到该类时，才会触发类加载】</p>
</li>
<li><p>连接</p>
</li>
<li><p>验证 验证类是否符合Class规范,合法性、安全性检查</p>
</li>
<li><p>准备 为static变量分配空间,设置默认值【赋值语句是在最后的初始化才执行的】</p>
</li>
<li><p>解析 将常量池的符号引用解析为直接引用 </p>
</li>
<li><p>初始化</p>
</li>
<li><p>执行静态代码块与非final静态变量的赋值【有final修饰的变量在准备阶段就会赋好值，在初始化时不会重复赋值】【没有final修饰的静态变量，其初始化在静态代码块中执行】</p>
</li>
<li><p>初始化是懒惰执行 【new 类】</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestLazy</span> &#123;<br>    <span class="hljs-keyword">private</span> Class&lt;?&gt; studentClass;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        System.out.println(<span class="hljs-string">&quot;未用到 Student&quot;</span>);<br>        <span class="hljs-comment">//需要输入一行数据，否则阻塞</span><br>        System.in.read();<br><br>        System.out.println(Student.class);   <span class="hljs-comment">// 关键代码1，会触发类加载</span><br>        System.out.println(<span class="hljs-string">&quot;已加载 Student&quot;</span>);<br>        <span class="hljs-type">TestLazy</span> <span class="hljs-variable">testLazy</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TestLazy</span>();<br>        testLazy.studentClass = Student.class;<br>        System.in.read();<br><br>        <span class="hljs-type">Student</span> <span class="hljs-variable">stu</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>();        <span class="hljs-comment">// 关键代码2，会触发类初始化</span><br>        System.out.println(<span class="hljs-string">&quot;已初始化 Student&quot;</span>);<br>        System.in.read();<br>    &#125;<br>&#125;<br>=============================================================<br>未用到 Student<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">day03</span>.loader.Student<br>已加载 Student<br></code></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs vim">使用jdk17的一个调试工具:jhsdb.<span class="hljs-keyword">exe</span>【观察内存状态】<br>C:\Users\fgcy&gt;<span class="hljs-keyword">cd</span> /d D:\sofeware\Idea\jdk-<span class="hljs-number">17.0</span>.<span class="hljs-number">2</span>\bin<br>D:\sofeware\Idea\jdk-<span class="hljs-number">17.0</span>.<span class="hljs-number">2</span>\bin&gt;jhsdb.<span class="hljs-keyword">exe</span><br>    clhsdb              <span class="hljs-keyword">command</span> <span class="hljs-built_in">line</span> debugger<br>    hsdb                ui debugger<br>    debugd --<span class="hljs-keyword">help</span>       <span class="hljs-keyword">to</span> <span class="hljs-built_in">get</span> more information<br>    jstack --<span class="hljs-keyword">help</span>       <span class="hljs-keyword">to</span> <span class="hljs-built_in">get</span> more information<br>    jmap   --<span class="hljs-keyword">help</span>       <span class="hljs-keyword">to</span> <span class="hljs-built_in">get</span> more information<br>    jinfo  --<span class="hljs-keyword">help</span>       <span class="hljs-keyword">to</span> <span class="hljs-built_in">get</span> more information<br>    jsnap  --<span class="hljs-keyword">help</span>       <span class="hljs-keyword">to</span> <span class="hljs-built_in">get</span> more information<br><br>D:\sofeware\Idea\jdk-<span class="hljs-number">17.0</span>.<span class="hljs-number">2</span>\bin&gt;jhsdb.<span class="hljs-keyword">exe</span> hsdb<br><br>-----------------------------------------------------<br>D:\sofeware\Idea\jdk-<span class="hljs-number">17.0</span>.<span class="hljs-number">2</span>\bin&gt;jps<br><span class="hljs-number">14000</span><br><span class="hljs-number">2080</span> Launcher<br><span class="hljs-number">21556</span> Jps<br><span class="hljs-number">18296</span> RemoteMavenServer36<br><span class="hljs-number">78412</span> TestLazy<br></code></pre></td></tr></table></figure>

<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-27_14-15-58.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-27_14-09-48.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823222155785.png" srcset="/img/loading.gif" lazyload alt="image-20220823222155785"></p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-27_14-14-15.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-27_14-17-00.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-27_14-17-26.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-27_14-18-43.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<ul>
<li>证明类的初始化才能给静态变量赋初始值</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//查看堆的范围</span><br>hsdb&gt; universe<br>Heap Parameters:<br>garbage-first heap [Ox00000000ff000000, Ox0000000100000000] region size 1024K<br><br><span class="hljs-comment">//查看G1划分的许多Region的范围</span><br>hsdb&gt; glregiondetails<br>Region Details:<br>Region: Ox00000000ff000000, Ox00000000ff100000, Ox00000000ff100000:<span class="hljs-number">01d</span><br>Region: Ox00000000ff100000, Ox00000000ff200000,Ox00000000ff200000:0ld<br>Region: Ox00000000ff200000, <span class="hljs-number">0x00000000ff300000</span>, Ox00000000ff300000:<span class="hljs-number">01d</span><br>Region: Ox00000000ff300000, Ox00000000ff371e00, Ox00000000ff400000:<span class="hljs-number">01d</span><br>Region: Ox00000000ff400000, <span class="hljs-number">0x00000000ff400000</span>,Ox00000000ff500000:Free<br>Region: Ox00000000ff500000, Ox00000000ff500000,Ox00000000ff600000: Free<br>Region: Ox00000000ff600000, <span class="hljs-number">0x00000000ff600000</span>,<span class="hljs-number">0x00000000ff700000</span>:Free<br>Region: Ox00000000ff700000, Ox00000000ff700000,Ox00000000ff800000: Free<br>Region: Ox00000000ff800000, Ox00000000ff800000,Ox00000000ff900000: Free<br>Region: Ox00000000ff900000, Ox00000000ffa00000, Ox00000000ffa00000:Survivor<br>Region: Ox00000000ffa00000, <span class="hljs-number">0x00000000ffa00000</span>, Ox00000000ffbo0000: Free<br>Region: Ox00000000ffbo0000,0x00000000ffbo0000,Ox00000000ffco0000: Free<br>Region: Ox00000000ffc00000, Ox00000000ffco0000, Ox00000000ffdo0000: Free<br>Region: Ox00000000ffd00000, Ox00000000ffd00000, Ox00000000ffe00000: Free<br>Region: Ox00000000ffe00000, <span class="hljs-number">0x00000000ffe2e240</span>,<span class="hljs-number">0x00000000fff00000</span>:Eden<br><span class="hljs-comment">//用于查看某个对象的信息（给对象地址）</span><br>hsdb&gt; inspect Ox00000000fff389a8<br>instance of oop <span class="hljs-keyword">for</span> java/lang/Class@ Ox00000000fff389a8 @ Ox00000000fff389a8 (size = <span class="hljs-number">1</span> <br>a: <span class="hljs-number">0</span><span class="hljs-comment">//只是用static修饰，在初始化阶段赋值</span><br>b: <span class="hljs-number">0</span><span class="hljs-comment">//只是用static修饰，在初始化阶段赋值</span><br>c: <span class="hljs-number">153</span><span class="hljs-comment">//用static、final修饰，在连接阶段赋值</span><br></code></pre></td></tr></table></figure>

<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-27_15-00-10.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-27_15-00-46.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<ul>
<li>证明类对象属于堆内存</li>
</ul>
<p>scanoops begin end 全类名 ：查找某个范围内某种类型的全部对象的地址<br>inspect 对象地址  ：查看对象的信息<br>因为随便跑一个程序，需要运行的类对象就会有上千个，要找一个类对象十分困难<br>所以将类对象赋给某个类的实例变量，找某个类的一两个实例比较容易，通过这个实例的成员方法定位类对象的地址<br>通过insptect 地址查看类对象信息</p>
<h2 id="静态代码块原理"><a href="#静态代码块原理" class="headerlink" title="静态代码块原理"></a>静态代码块原理</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> day03.loader;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x77</span>;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Student.class init&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x88</span>;<br>    <br>	<span class="hljs-comment">//基本数据类型的常量不会出现在c-init方法中</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x99</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> Short.MAX_VALUE + <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br><br>    <span class="hljs-type">int</span> <span class="hljs-variable">d</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x55</span>;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x66</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//将编译器编译后的字节码文件翻译成人类可读的形式</span><br>D:\learn\tencentClass\interview\interview\target\classes\day03\loader&gt;javap -p -c -p Student.class<br>    <br><span class="hljs-comment">//编译器将所有静态代码的赋值语句，静态代码块中的语句，合并到一个静态方法中【按照原来的顺序存放】，该方法会在类的初始化时才会调用，名叫c-init</span><br> <span class="hljs-keyword">static</span> &#123;&#125;;<br>    Code:<br>       <span class="hljs-number">0</span>: bipush        <span class="hljs-number">119</span>   				<span class="hljs-comment">//准备了一个常数119</span><br>       <span class="hljs-number">2</span>: putstatic     #<span class="hljs-number">18</span>                 <span class="hljs-comment">// Field a:I  将常数赋值给a</span><br>       <span class="hljs-number">5</span>: getstatic     #<span class="hljs-number">21</span>                 <span class="hljs-comment">// Field java/lang/System.out:Ljava/io/PrintStream拿到一个静态变量printStream</span><br>       <span class="hljs-number">8</span>: ldc           #<span class="hljs-number">27</span>                 <span class="hljs-comment">// String Student.class init  准备好一个字符串【从常量池中取出#27的常量】</span><br>      <span class="hljs-number">10</span>: invokevirtual #<span class="hljs-number">29</span>                 <span class="hljs-comment">// Method java/io/PrintStream.println:(Ljava/lang/String;)V  调用printStream的成员方法println，将字符串当成是参数传给println</span><br>      <span class="hljs-number">13</span>: sipush        <span class="hljs-number">136</span>					<span class="hljs-comment">//准备一个常量 136</span><br>      <span class="hljs-number">16</span>: putstatic     #<span class="hljs-number">35</span>                 <span class="hljs-comment">// Field b:I 将常数赋值给b</span><br>          <br>      <span class="hljs-number">19</span>: <span class="hljs-keyword">new</span>           #<span class="hljs-number">4</span>                  <span class="hljs-comment">// class java/lang/Object</span><br>      <span class="hljs-number">22</span>: dup<br>      <span class="hljs-number">23</span>: invokespecial #<span class="hljs-number">3</span>                  <span class="hljs-comment">// Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br>      <span class="hljs-comment">//上面三行语句，创建一个Object对象</span><br>      <span class="hljs-number">26</span>: putstatic     #<span class="hljs-number">38</span>                 <span class="hljs-comment">// Field n:Ljava/lang/Object; 将Object对象赋值给变量n</span><br>      <span class="hljs-number">29</span>: <span class="hljs-keyword">return</span><br><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//在申明变量时已经确定下来值，不用在后续的初始化中对其进行赋值</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> c;<br>    descriptor: I<br>    flags: ACC_STATIC, ACC_FINAL<br>    ConstantValue: <span class="hljs-type">int</span> <span class="hljs-number">153</span><br><br>  <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> m;<br>    descriptor: I<br>    flags: ACC_STATIC, ACC_FINAL<br>    ConstantValue: <span class="hljs-type">int</span> <span class="hljs-number">32768</span><br><br></code></pre></td></tr></table></figure>



<h2 id="final修饰基本数据类型变量原理"><a href="#final修饰基本数据类型变量原理" class="headerlink" title="final修饰基本数据类型变量原理"></a>final修饰基本数据类型变量原理</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> day03.loader;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestFinal</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">// c 是 final static 基本类型,不会触发Student类加载</span><br>        System.out.println(Student.c);<br>        System.in.read();<br><br>        <span class="hljs-comment">// m 是 final static 基本类型不会触发类加载</span><br>        System.out.println(Student.m);<br>        System.in.read();<br><br>        <span class="hljs-comment">// n 是 final static 引用类型，即会导致Student类的加载 又会导致Student类的初始化</span><br>        System.out.println(Student.n);<br>        System.in.read();<br>    &#125;<br>&#125;<br>--------------------------------------------------------------------------------<br><span class="hljs-keyword">package</span> day03.loader;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x77</span>;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Student.class init&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x88</span>;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x99</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> Short.MAX_VALUE + <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br><br>    <span class="hljs-type">int</span> <span class="hljs-variable">d</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x55</span>;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x66</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>方法区中类的原始信息(Student)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//类的名字  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">day03</span>.loader.Student @<span class="hljs-number">0x0000000800c01a00</span><br>View Class Hierarchy<br>Create .<span class="hljs-keyword">class</span> <span class="hljs-title class_">File</span><br>    <br><span class="hljs-comment">//类继承的父类|接口    </span><br>Super Class<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">java</span>.lang.Object @<span class="hljs-number">0x0000000800000d58</span><br>  <br><span class="hljs-comment">//类的成员(静态成员、实例成员)    </span><br>Fields<br><span class="hljs-keyword">static</span> <span class="hljs-type">int</span> a; (offset = <span class="hljs-number">116</span>)<br><span class="hljs-keyword">static</span> <span class="hljs-type">int</span> b; (offset = <span class="hljs-number">120</span>)<br><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> c; (offset = <span class="hljs-number">124</span>)<br><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> m; (offset = <span class="hljs-number">128</span>)<br><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> java.lang.Object n; (offset = <span class="hljs-number">112</span>)<br><span class="hljs-type">int</span> d; (offset = <span class="hljs-number">12</span>)<br><span class="hljs-type">int</span> e; (offset = <span class="hljs-number">16</span>)<br><br><span class="hljs-comment">//类的方法</span><br>Methods<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> &lt;init&gt;() @<span class="hljs-number">0x0000026d6cc06058</span>;<br><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> &lt;clinit&gt;() @<span class="hljs-number">0x0000026d6cc06108</span>;<br><br><span class="hljs-comment">//类的常量池</span><br>Constant Pool<br>Constant Pool of [<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">day03</span>.loader.Student @<span class="hljs-number">0x0000000800c01a00</span>] @<span class="hljs-number">0x0000026d6cc03d58</span><br></code></pre></td></tr></table></figure>



<ul>
<li>基本数据类型的常量不会触发类加载</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> day03.loader;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestFinal</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">// c 是 final static 基本类型,不会触发Student类加载</span><br>        System.out.println(Student.c);<br>        System.in.read();<br><br>        <span class="hljs-comment">// m 是 final static 基本类型不会触发类加载</span><br>        System.out.println(Student.m);<br>        System.in.read();<br><br>        <span class="hljs-comment">// n 是 final static 引用类型，即会导致Student类的加载 又会导致Student类的初始化</span><br>        System.out.println(Student.n);<br>        System.in.read();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java">Constant pool:<br>   #<span class="hljs-number">1</span> = Methodref          #<span class="hljs-number">2.</span>#<span class="hljs-number">3</span>          <span class="hljs-comment">// java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br>     .......<br>  #<span class="hljs-number">30</span> = Utf8               ()I<br>  #<span class="hljs-number">31</span> = Integer            <span class="hljs-number">32768</span><br>  #<span class="hljs-number">32</span> = Fieldref           #<span class="hljs-number">13.</span>#<span class="hljs-number">33</span>        <span class="hljs-comment">// day03/loader/Student.n:Ljava/lang/Object;</span><br> .................<br>  #<span class="hljs-number">54</span> = Utf8               TestFinal.java<br> <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(java.lang.String[])</span> <span class="hljs-keyword">throws</span> java.io.IOException;<br>    descriptor: ([Ljava/lang/String;)V<br>    flags: ACC_PUBLIC, ACC_STATIC<br>    Code:<br>      stack=<span class="hljs-number">2</span>, locals=<span class="hljs-number">1</span>, args_size=<span class="hljs-number">1</span><br>         <span class="hljs-number">0</span>: getstatic     #<span class="hljs-number">7</span>                  <span class="hljs-comment">// Field java/lang/System.out:Ljava/io/PrintStream;//获取一个printStream对象</span><br>         <span class="hljs-number">3</span>: sipush        <span class="hljs-number">153</span>				  <span class="hljs-comment">//准备一个常量，写死在main方法中</span><br>         <span class="hljs-number">6</span>: invokevirtual #<span class="hljs-number">15</span>                 <span class="hljs-comment">// Method java/io/PrintStream.println:(I)V 调用printStream对象的println方法</span><br>         <span class="hljs-number">9</span>: getstatic     #<span class="hljs-number">21</span>                 <span class="hljs-comment">// Field java/lang/System.in:Ljava/io/InputStream;///获取一个InputStream对象</span><br>        <span class="hljs-number">12</span>: invokevirtual #<span class="hljs-number">25</span>                 <span class="hljs-comment">// Method java/io/InputStream.read:()I 调用inputstream的read方法</span><br>        <span class="hljs-number">15</span>: pop<br>        <span class="hljs-number">16</span>: getstatic     #<span class="hljs-number">7</span>                  <span class="hljs-comment">// Field java/lang/System.out:Ljava/io/PrintStream;</span><br>        <span class="hljs-number">19</span>: ldc           #<span class="hljs-number">31</span>                 <span class="hljs-comment">// int 32768   从常量池中获取#31的常量</span><br></code></pre></td></tr></table></figure>



<ul>
<li>小结</li>
</ul>
<ol>
<li>每个类都有自己的常量池</li>
<li>一个类使用另一个类的基本数据类型的常量，不会对目标类进行类加载包括后续行为，因为他会将本类中要使用目标类的基本常量写死到代码中，或存储到常量池中</li>
<li>如果数值&lt;&#x3D;short的范围，直接写死在代码中，否则放入该类的常量池中</li>
<li>short(32768 ~ -1,0 ~ 32767)</li>
</ol>
<h2 id="双亲委派"><a href="#双亲委派" class="headerlink" title="双亲委派"></a>双亲委派</h2><p>所谓的双亲委派,就是指优先委派上级类加载器进行加载,如果上级类加载器<br>能找到这个类,由上级加载,加载后该类也对下级加载器可见【对上级不可见】<br>找不到这个类,则下级类加载器才有资格执行加载<br>直接层层往上报，到Bootstrap ClassLoader 如果有就直接加载，对下级可见；没有就权力下放给Extension ClassLoader加载 如果有就加载，对下级可见，没有就将权力下放给Application ClassLoader加载</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-27_20-10-09.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<p>启动类加载器  tr.jar </p>
<p>扩展类加载器<br>应用程序加载器<br>自定义类加载器</p>
<ul>
<li>自己编写类加载器就能加载一个假冒的java.lang.System 【不能】</li>
</ul>
<ol>
<li>假设你自己的类加载器用双亲委派,那么优先由启动类加载器加载真正的java.lang.System,自然不会加载假冒的</li>
<li>假设你自己的类加载器不用双亲委派,那么你的类加载器加载假冒的java.lang.System 时,它需要先加载父类java.lang.Object,而你没有用委派,找不到java.lang.Object所以加载会失败</li>
</ol>
<p>以上也仅仅是假设。实际操作你就会发现自定义类加载器加载以java.打头的类时,会抛安全异常,在jdk9以上版本这些特殊包名都与模块进行了绑定,更连编译都过不了</p>
<ul>
<li>双亲委派的目的有两点</li>
</ul>
<p>让上级类加载器中的类对下级共享(反之不行),即能让你的类能依赖到jdk提供的核心类<br>让类的加载有忧先次序,保证核心类优先加载</p>
<h2 id="对象引用类型分为哪几类"><a href="#对象引用类型分为哪几类" class="headerlink" title="对象引用类型分为哪几类"></a>对象引用类型分为哪几类</h2><ol>
<li>强引用</li>
</ol>
<p>只要用赋值运算符让变量引用对象都是强引用，A a&#x3D;new A();<br>通过GC Root的引用链,如果强引用不到该对象,该对象才能被回收</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-27_21-02-08.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<ol start="2">
<li>软引用(SoftReference)</li>
</ol>
<p>例如: SoftReference a &#x3D; new SoftReference(new A());【变量直接引用软引用，软引用里面包装类其他对象】<br>如果仅有软引用该对象时,首次垃圾回收不会回收该对象,如果内存仍不足,再次回收时才会释放对象；【GC可以强行断开软引用包装的对象与变量之间的关系】<br>软引用自身需要配合引用队列来释放【GC不能断开变量与软引用对象之间的关系】<br>典型例子是反射数据 </p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-27_21-02-37.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<ol start="3">
<li>弱引用(WeakReference)</li>
</ol>
<p>例如: WeakReference a &#x3D; new WeakReference(new A());<br>如果仅有弱引用引用该对象时,只要发生垃圾回收,就会释放该对象<br>弱引用自身需要配合引用队列来<br>释放典型例子是ThreadLocalMap 中的Entry对象 key与key的值之间是弱引用</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-27_21-03-02.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<ol start="4">
<li>虚引用(PhantomReference)</li>
</ol>
<p>例如: PhantomReference a &#x3D; new PhantomReference(newA());<br>必须配合引用队列一起使用,当虚引用引用的对象被回收时,会将虚引用对象入队,由Reference Handler线程释放其关联的外部资源<br>典型例子是Cleaner释放DirectByteBuffer 占用的直接内存 </p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823223533970.png" srcset="/img/loading.gif" lazyload alt="image-20220823223533970"></p>
<hr>
<h3 id="虚引用"><a href="#虚引用" class="headerlink" title="虚引用"></a>虚引用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> day03.reference;<br><br><span class="hljs-keyword">import</span> day02.LoggerUtils;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.ref.*;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestPhantomReference</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, InterruptedException &#123;<br>        <span class="hljs-comment">//引用队列</span><br>        ReferenceQueue&lt;String&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceQueue</span>&lt;&gt;();<br>        List&lt;MyResource&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        list.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyResource</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-string">&quot;a&quot;</span>), queue));<br>        <span class="hljs-comment">//&quot;b&quot;是在字符串常量池中的，GC不会清除它</span><br>        list.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyResource</span>(<span class="hljs-string">&quot;b&quot;</span>, queue));<br>        list.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyResource</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-string">&quot;c&quot;</span>), queue));<br>        <span class="hljs-comment">// 主动触发垃圾回收</span><br>        System.gc();<br>        Thread.sleep(<span class="hljs-number">100</span>);<br>        Object ref;<br>        <span class="hljs-comment">//从队列中取元素</span><br>        <span class="hljs-keyword">while</span> ((ref = queue.poll()) != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">//这个因该是相当于MyResource resource =(MyResource)resource</span><br>            <span class="hljs-keyword">if</span> (ref <span class="hljs-keyword">instanceof</span> MyResource resource) &#123;<br>                resource.clean();<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyResource</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">PhantomReference</span>&lt;String&gt; &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyResource</span><span class="hljs-params">(String referent, ReferenceQueue&lt;? <span class="hljs-built_in">super</span> String&gt; q)</span> &#123;<br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">                Reference(T referent, ReferenceQueue&lt;? super T&gt; queue) &#123;</span><br><span class="hljs-comment">                //虚引用对象引用的对象</span><br><span class="hljs-comment">                this.referent = referent;</span><br><span class="hljs-comment">                //虚引用对象引用的对象被垃圾回收后，虚引用对象需要进入的队列</span><br><span class="hljs-comment">                this.queue = (queue == null) ? ReferenceQueue.NULL : queue;</span><br><span class="hljs-comment">                 &#125;</span><br><span class="hljs-comment">            * */</span><br>            <span class="hljs-built_in">super</span>(referent, q);<br>        &#125;<br><br>        <span class="hljs-comment">// 释放外部资源的方法</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clean</span><span class="hljs-params">()</span> &#123;<br>            LoggerUtils.get().debug(<span class="hljs-string">&quot;clean&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br>=====================================<br>[DEBUG] <span class="hljs-number">21</span>:<span class="hljs-number">13</span>:<span class="hljs-number">58.130</span> [main] - clean <br>[DEBUG] <span class="hljs-number">21</span>:<span class="hljs-number">13</span>:<span class="hljs-number">58.131</span> [main] - clean <br>    <br>进程已结束，退出代码为 <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>



<h3 id="弱引用"><a href="#弱引用" class="headerlink" title="弱引用"></a>弱引用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> day03.reference;<br><br><span class="hljs-keyword">import</span> java.lang.ref.ReferenceQueue;<br><span class="hljs-keyword">import</span> java.lang.ref.WeakReference;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestWeakReference</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">MyWeakMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyWeakMap</span>();<br>        map.put(<span class="hljs-number">0</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-string">&quot;a&quot;</span>), <span class="hljs-string">&quot;1&quot;</span>);<br>        map.put(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;b&quot;</span>, <span class="hljs-string">&quot;2&quot;</span>);<br>        map.put(<span class="hljs-number">2</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-string">&quot;c&quot;</span>), <span class="hljs-string">&quot;3&quot;</span>);<br>        map.put(<span class="hljs-number">3</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-string">&quot;d&quot;</span>), <span class="hljs-string">&quot;4&quot;</span>);<br>        System.out.println(map);<br><br>        System.gc();<br>        System.out.println(<span class="hljs-string">&quot;键为a的value是：&quot;</span> + map.get(<span class="hljs-string">&quot;a&quot;</span>));<br>        System.out.println(<span class="hljs-string">&quot;键为b的value是：&quot;</span> + map.get(<span class="hljs-string">&quot;b&quot;</span>));<br>        System.out.println(<span class="hljs-string">&quot;键为c的value是：&quot;</span> + map.get(<span class="hljs-string">&quot;c&quot;</span>));<br>        System.out.println(<span class="hljs-string">&quot;键为d的value是：&quot;</span> + map.get(<span class="hljs-string">&quot;d&quot;</span>));<br>        System.out.println(<span class="hljs-string">&quot;gc后的map是：&quot;</span> + map);<br>        map.clean();<br>        System.out.println(map);<br>    &#125;<br><br>    <span class="hljs-comment">// 模拟 ThreadLocalMap 的内存泄漏问题以及一种解决方法</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyWeakMap</span> &#123;<br>        <span class="hljs-comment">//jdk的ThreadLoalMap没有用这队列</span><br>        <span class="hljs-comment">//存放弱引用的引用队列</span><br>        <span class="hljs-keyword">static</span> ReferenceQueue&lt;Object&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceQueue</span>&lt;&gt;();<br><br>        <span class="hljs-comment">//弱引用类  table————————》entry--------------》String</span><br>        <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Entry</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WeakReference</span>&lt;String&gt; &#123;<br>            String value;<br><br>            <span class="hljs-keyword">public</span> <span class="hljs-title function_">Entry</span><span class="hljs-params">(String key, String value)</span> &#123;<br>                <span class="hljs-comment">//键是弱引用，当key的值(对象)被释放后，会将当前Entry实例放到队列中</span><br>                <span class="hljs-built_in">super</span>(key, queue);<br>                <span class="hljs-comment">//值是强引用</span><br>                <span class="hljs-built_in">this</span>.value = value;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clean</span><span class="hljs-params">()</span> &#123;<br>            Object ref;<br>            <span class="hljs-keyword">while</span> ((ref = queue.poll()) != <span class="hljs-literal">null</span>) &#123;<br>                System.out.println(ref);<br>                <span class="hljs-comment">//遍历Entry数组</span><br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; table.length; i++) &#123;<br>                    <span class="hljs-comment">//只要引用队列中的Entry对象，与table中的entry对象是同一个就可以将该table元素设置为null</span><br>                    <span class="hljs-keyword">if</span> (table[i] == ref) &#123;<br>                        <span class="hljs-comment">//table 与多个entry之间的强引用就没了，下次GC就可以清除</span><br>                        table[i] = <span class="hljs-literal">null</span>;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        Entry[] table = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>[<span class="hljs-number">4</span>];<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(<span class="hljs-type">int</span> index, String key, String value)</span> &#123;<br>            table[index] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>(key, value);<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">get</span><span class="hljs-params">(String key)</span> &#123;<br>            <span class="hljs-keyword">for</span> (Entry entry : table) &#123;<br>                <span class="hljs-keyword">if</span> (entry != <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-comment">//通过弱引用的get方法获取用弱引用包装的对象【键的值】</span><br>                    <span class="hljs-type">String</span> <span class="hljs-variable">k</span> <span class="hljs-operator">=</span> entry.get();<br>                    <span class="hljs-keyword">if</span> (k != <span class="hljs-literal">null</span> &amp;&amp; k.equals(key)) &#123;<br>                        <span class="hljs-keyword">return</span> entry.value;<br>                    &#125;<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>            sb.append(<span class="hljs-string">&quot;[&quot;</span>);<br>            <span class="hljs-keyword">for</span> (Entry entry : table) &#123;<br>                <span class="hljs-keyword">if</span> (entry != <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">k</span> <span class="hljs-operator">=</span> entry.get();<br>                    sb.append(k).append(<span class="hljs-string">&quot;:&quot;</span>).append(entry.value).append(<span class="hljs-string">&quot;,&quot;</span>);<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (sb.length() &gt; <span class="hljs-number">1</span>) &#123;<br>                sb.deleteCharAt(sb.length() - <span class="hljs-number">1</span>);<br>            &#125;<br>            sb.append(<span class="hljs-string">&quot;]&quot;</span>);<br>            <span class="hljs-keyword">return</span> sb.toString();<br>        &#125;<br>    &#125;<br>&#125;<br>===================================================================<br>[a:<span class="hljs-number">1</span>,b:<span class="hljs-number">2</span>,c:<span class="hljs-number">3</span>,d:<span class="hljs-number">4</span>]<br>键为a的value是：<span class="hljs-literal">null</span><br>键为b的value是：<span class="hljs-number">2</span><br>键为c的value是：<span class="hljs-literal">null</span><br>键为d的value是：<span class="hljs-literal">null</span><br>gc后的map是：[<span class="hljs-literal">null</span>:<span class="hljs-number">1</span>,b:<span class="hljs-number">2</span>,<span class="hljs-literal">null</span>:<span class="hljs-number">3</span>,<span class="hljs-literal">null</span>:<span class="hljs-number">4</span>]<br>day03.reference.TestWeakReference$MyWeakMap$Entry@621be5d1<br>day03.reference.TestWeakReference$MyWeakMap$Entry@573fd745<br>day03.reference.TestWeakReference$MyWeakMap$Entry@15327b79<br>[b:<span class="hljs-number">2</span>]<br></code></pre></td></tr></table></figure>



<h3 id="Cleaner"><a href="#Cleaner" class="headerlink" title="Cleaner"></a>Cleaner</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> day03.reference;<br><br><span class="hljs-keyword">import</span> day02.LoggerUtils;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.ref.Cleaner;<br><br><span class="hljs-comment">// 前面讲的弱、虚引用配合引用队列，目的都是为了找到哪些 java对象被回收，确定弱引用对象，从而进行对它们关联的资源进行进一步清理</span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 为了简化 api 难度，从 java 9 开始引入了 Cleaner 对象，cleaner对象里面其实也是一些虚引用，弱引用，引用队列；但它专门开辟了一个线程用于对在引用队列中的引用释放相关资源</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestCleaner1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">Cleaner</span> <span class="hljs-variable">cleaner</span> <span class="hljs-operator">=</span> Cleaner.create();<br>        <span class="hljs-comment">//第一个参数是可能被GC回收的资源，第二个参数是回收之后执行的逻辑</span><br>        cleaner.register(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyResource</span>(), () -&gt; LoggerUtils.get().debug(<span class="hljs-string">&quot;clean 1&quot;</span>));<br>        cleaner.register(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyResource</span>(), () -&gt; LoggerUtils.get().debug(<span class="hljs-string">&quot;clean 2&quot;</span>));<br>        cleaner.register(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyResource</span>(), () -&gt; LoggerUtils.get().debug(<span class="hljs-string">&quot;clean 3&quot;</span>));<br>        <span class="hljs-type">MyResource</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyResource</span>();<br>        cleaner.register(obj, () -&gt; LoggerUtils.get().debug(<span class="hljs-string">&quot;clean 4&quot;</span>));<br>        cleaner.register(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyResource</span>(), () -&gt; LoggerUtils.get().debug(<span class="hljs-string">&quot;clean 5&quot;</span>));<br>        cleaner.register(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyResource</span>(), () -&gt; LoggerUtils.get().debug(<span class="hljs-string">&quot;clean 6&quot;</span>));<br><br>        System.gc();<br><br>        <span class="hljs-comment">//执行回收后逻辑的线程是守护线程，如果main线程执行完毕，守护线程也会结束</span><br>        System.in.read();<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyResource</span> &#123;<br>    &#125;<br>&#125;<br>======================================<br>[DEBUG] <span class="hljs-number">23</span>:<span class="hljs-number">38</span>:<span class="hljs-number">15.732</span> [Cleaner-<span class="hljs-number">0</span>] - clean <span class="hljs-number">6</span> <br>[DEBUG] <span class="hljs-number">23</span>:<span class="hljs-number">38</span>:<span class="hljs-number">15.733</span> [Cleaner-<span class="hljs-number">0</span>] - clean <span class="hljs-number">5</span> <br>[DEBUG] <span class="hljs-number">23</span>:<span class="hljs-number">38</span>:<span class="hljs-number">15.734</span> [Cleaner-<span class="hljs-number">0</span>] - clean <span class="hljs-number">3</span> <br>[DEBUG] <span class="hljs-number">23</span>:<span class="hljs-number">38</span>:<span class="hljs-number">15.734</span> [Cleaner-<span class="hljs-number">0</span>] - clean <span class="hljs-number">2</span> <br>[DEBUG] <span class="hljs-number">23</span>:<span class="hljs-number">38</span>:<span class="hljs-number">15.734</span> [Cleaner-<span class="hljs-number">0</span>] - clean <span class="hljs-number">1</span> <br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> day03.reference;<br><br><span class="hljs-keyword">import</span> day02.LoggerUtils;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-comment">//jdk内部使用的类(直接内存会使用到这个类)</span><br><span class="hljs-keyword">import</span> jdk.internal.ref.Cleaner;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestCleaner2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">Cleaner</span> <span class="hljs-variable">cleaner1</span> <span class="hljs-operator">=</span> Cleaner.create(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyResource</span>(), () -&gt; LoggerUtils.get().debug(<span class="hljs-string">&quot;clean 1&quot;</span>));<br>        <span class="hljs-type">Cleaner</span> <span class="hljs-variable">cleaner2</span> <span class="hljs-operator">=</span> Cleaner.create(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyResource</span>(), () -&gt; LoggerUtils.get().debug(<span class="hljs-string">&quot;clean 2&quot;</span>));<br>        <span class="hljs-type">Cleaner</span> <span class="hljs-variable">cleaner3</span> <span class="hljs-operator">=</span> Cleaner.create(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyResource</span>(), () -&gt; LoggerUtils.get().debug(<span class="hljs-string">&quot;clean 3&quot;</span>));<br>        <span class="hljs-type">Cleaner</span> <span class="hljs-variable">cleaner4</span> <span class="hljs-operator">=</span> Cleaner.create(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyResource</span>(), () -&gt; LoggerUtils.get().debug(<span class="hljs-string">&quot;clean 4&quot;</span>));<br><br>        System.gc();<br>        System.in.read();<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyResource</span> &#123;<br>    &#125;<br>&#125;<br>==================================<br><span class="hljs-comment">//不会调参数</span><br></code></pre></td></tr></table></figure>



<h2 id="finalize的理解"><a href="#finalize的理解" class="headerlink" title="finalize的理解"></a>finalize的理解</h2><p>一般的回答是:它是Object中的一个方法,子类重写它,垃圾回收子类对象时，子类对象重写的finalize方法会被调用,可以在其中进行一些资源释放和清理工作<br>较为优秀的回答是:将资源释放和清理放在finalize方法中非常不好,非常影响性能,严重时甚至会引起0OM,从Java9 开始就被标注为@Deprecated,不建议被使用了</p>
<ul>
<li>代码体现</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> day03.reference;<br><br><span class="hljs-keyword">import</span> org.slf4j.Logger;<br><span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestFinalize</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">fgcy</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(<span class="hljs-string">&quot;fgcy&quot;</span>);<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> &#123;<br>        <span class="hljs-keyword">private</span> String name;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">Dog</span><span class="hljs-params">(String name)</span> &#123;<br>            <span class="hljs-built_in">this</span>.name = name;<br>        &#125;<br><br>        <span class="hljs-comment">//重写Objcet类的finalize方法，当该对象被GC回收时，会先掉调用该方法，再回收对象</span><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">finalize</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>            fgcy.debug(<span class="hljs-string">&quot;&#123;&#125;被干掉了?&quot;</span>, <span class="hljs-built_in">this</span>.name);<br>            <span class="hljs-comment">//如果将 finalize 中的代码出现异常，会发现根本没有异常输出</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span> / <span class="hljs-number">0</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>(<span class="hljs-string">&quot;大傻&quot;</span>);<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>(<span class="hljs-string">&quot;二哈&quot;</span>);<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>(<span class="hljs-string">&quot;三笨&quot;</span>);<br>        System.gc();<br>        <span class="hljs-comment">//运行finalize方法的Finalizer线程是一个守护线程，当main线程不再运行时，Finalizer线程也会消亡</span><br>        <span class="hljs-comment">//使主线程处于等待状态</span><br>        System.in.read();<br>    &#125;<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    第一，从表面上我们能看出来 finalize 方法的调用次序并不能保证,因为我们不能决定gc回收对象的顺序</span><br><span class="hljs-comment">    第二，日志中的 Finalizer 表示输出日志的线程名称，从这我们看出是这个叫做 Finalizer 的线程调用的 finalize 方法</span><br><span class="hljs-comment">    第三，你不能注释掉 `System.in.read()`，否则会发现（绝大概率）并不会有任何输出结果了，从这我们看出 finalize 中的代码并不能保证被执行</span><br><span class="hljs-comment">    第四，如果将 finalize 中的代码出现异常，会发现根本没有异常输出</span><br><span class="hljs-comment">    第五，还有个疑问，垃圾回收时就会立刻调用  finalize 方法吗？</span><br><span class="hljs-comment">     */</span><br>&#125;<br>======================================<br>[DEBUG] <span class="hljs-number">17</span>:<span class="hljs-number">14</span>:<span class="hljs-number">39.577</span> [Finalizer] - 二哈被干掉了? <br>[DEBUG] <span class="hljs-number">17</span>:<span class="hljs-number">14</span>:<span class="hljs-number">39.580</span> [Finalizer] - 三笨被干掉了? <br>[DEBUG] <span class="hljs-number">17</span>:<span class="hljs-number">14</span>:<span class="hljs-number">39.580</span> [Finalizer] - 大傻被干掉了? <br></code></pre></td></tr></table></figure>



<h2 id="finalize的执行原理"><a href="#finalize的执行原理" class="headerlink" title="finalize的执行原理"></a>finalize的执行原理</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//1. 创建狗对象  </span><br><span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>(<span class="hljs-string">&quot;大傻&quot;</span>);<br><span class="hljs-comment">//2.调用父类Object构造器</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">Object</span><span class="hljs-params">()</span> &#123;&#125;<br><br><span class="hljs-comment">//3. 通过finalizer类的register方法，将狗对象包装成Finalizer对象</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">(Object finalizee)</span> &#123;<br>     <span class="hljs-keyword">new</span> <span class="hljs-title class_">Finalizer</span>(finalizee);<br>&#125;<br><span class="hljs-comment">//4. 初始化finalizer对象，并将其添加到链表中</span><br><span class="hljs-keyword">private</span> <span class="hljs-title function_">Finalizer</span><span class="hljs-params">(Object finalizee)</span> &#123;<br>        <span class="hljs-built_in">super</span>(finalizee, queue);<br>        <span class="hljs-comment">// push onto unfinalized</span><br>        <span class="hljs-keyword">synchronized</span> (lock) &#123;<br>            <span class="hljs-keyword">if</span> (unfinalized != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-built_in">this</span>.next = unfinalized;<br>                unfinalized.prev = <span class="hljs-built_in">this</span>;<br>            &#125;<br>            <span class="hljs-comment">//unfinalized是一个双向链表，用于存储finalizer对象</span><br>            <span class="hljs-comment">//unfinalized就是一个finalizer类型的实例，用于管理所有重写了finalized方法的对象</span><br>            unfinalized = <span class="hljs-built_in">this</span>;<br>        &#125;<br>    &#125;<br><br><span class="hljs-comment">//5. 创建一个名为Finalizer的守护线程</span><br> <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FinalizerThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> running;<br>        FinalizerThread(ThreadGroup g) &#123;<br>            <span class="hljs-built_in">super</span>(g, <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;Finalizer&quot;</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">false</span>);<br>        &#125;<br>     <span class="hljs-comment">//线程主要是从引用队列中拿出jvm想要清除的狗对象关联的finalizer对象</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-comment">// in case of recursive call to run()</span><br>            <span class="hljs-keyword">if</span> (running)<br>                <span class="hljs-keyword">return</span>;<br><br>            <span class="hljs-comment">// Finalizer thread starts before System.initializeSystemClass</span><br>            <span class="hljs-comment">// is called.  Wait until JavaLangAccess is available</span><br>            <span class="hljs-keyword">while</span> (VM.initLevel() == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-comment">// delay until VM completes initialization</span><br>                <span class="hljs-keyword">try</span> &#123;<br>                    VM.awaitInitLevel(<span class="hljs-number">1</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException x) &#123;<br>                    <span class="hljs-comment">// ignore and continue</span><br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">JavaLangAccess</span> <span class="hljs-variable">jla</span> <span class="hljs-operator">=</span> SharedSecrets.getJavaLangAccess();<br>            running = <span class="hljs-literal">true</span>;<br>            <span class="hljs-keyword">for</span> (;;) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-comment">//拿出jvm想要清除的狗对象关联的finalizer对象</span><br>                    <span class="hljs-type">Finalizer</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> (Finalizer)queue.remove();<br>                    <span class="hljs-comment">//操作finalizer对象</span><br>                    f.runFinalizer(jla);<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException x) &#123;<br>                    <span class="hljs-comment">// ignore and continue</span><br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>	<span class="hljs-comment">//操作finalizer对象</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">runFinalizer</span><span class="hljs-params">(JavaLangAccess jla)</span> &#123;<br>        <span class="hljs-comment">//将finialzer对象从unfianlized双列表中断开</span><br>        <span class="hljs-keyword">synchronized</span> (lock) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.next == <span class="hljs-built_in">this</span>)      <span class="hljs-comment">// already finalized</span><br>                <span class="hljs-keyword">return</span>;<br>            <span class="hljs-comment">// unlink from unfinalized</span><br>            <span class="hljs-keyword">if</span> (unfinalized == <span class="hljs-built_in">this</span>)<br>                unfinalized = <span class="hljs-built_in">this</span>.next;<br>            <span class="hljs-keyword">else</span><br>                <span class="hljs-built_in">this</span>.prev.next = <span class="hljs-built_in">this</span>.next;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.next != <span class="hljs-literal">null</span>)<br>                <span class="hljs-built_in">this</span>.next.prev = <span class="hljs-built_in">this</span>.prev;<br>            <span class="hljs-built_in">this</span>.prev = <span class="hljs-literal">null</span>;<br>            <span class="hljs-built_in">this</span>.next = <span class="hljs-built_in">this</span>;           <span class="hljs-comment">// mark as finalized</span><br>        &#125;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">finalizee</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.get();<br>            <span class="hljs-keyword">assert</span> finalizee != <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">if</span> (!(finalizee <span class="hljs-keyword">instanceof</span> java.lang.Enum)) &#123;<br>                <br>               <span class="hljs-comment">//调用finalizee(狗对象)的finalized方法</span><br>                jla.invokeFinalize(finalizee);<br><br>                <span class="hljs-comment">// Clear stack slot containing this variable, to decrease</span><br>                <span class="hljs-comment">// the chances of false retention with a conservative GC</span><br>                finalizee = <span class="hljs-literal">null</span>;<br>            &#125;<br>            <span class="hljs-comment">//当发生异常时什么也不做，俗称把异常吞了，调用者甚至不知道有没有释放资源</span><br>        &#125; <span class="hljs-keyword">catch</span> (Throwable x) &#123; &#125;<br>        <span class="hljs-built_in">super</span>.clear();<br>    &#125;<br></code></pre></td></tr></table></figure>

<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-29_17-57-46.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<ul>
<li>unfinalized队列</li>
</ul>
<p>当重写了finalize方法的对象,在构造方法调用之时,JVM都会将其包装成一个Finalizer 对象,并加入 unfinalized 队列中(静态成员变量、双向链表结构) </p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-29_19-37-23.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<ul>
<li>ReferenceQueue队列</li>
</ul>
<p>第二个重要的队列,也是Finalizer类中一个静态成员变量,名为queue(是一个单向链表结构),刚开始它是空的。当狗对象可以被当作垃圾回收时,就会把这些狗对象对应的Finalizer 对象加入这个队列，但注意，此时狗对象并没有被回收，因为还要调用finalized方法；等下一次内存不足触发GC这些狗对象才有可能被清除掉</p>
<h3 id="真正回收时机"><a href="#真正回收时机" class="headerlink" title="真正回收时机"></a>真正回收时机</h3><hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-29_20-01-43.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<p>即使Dog对象没人引用,垃圾回收时也没法立刻回收它,因为Finalizer还在引用它嘛,为的是【先别着急回收啊,等我调完finalize方法,再回收】<br>查看FinalizerThread 线程内的代码,这个线程从ReferenceQueue 中逐一取出每个Finalizer对象,把它们从链表断开,这样没谁能引用到它,以及其对应的狗对象,所以下次gc时就可以被回收了。</p>
<h2 id="为什么finalize方法非常不好-非常影响性能"><a href="#为什么finalize方法非常不好-非常影响性能" class="headerlink" title="为什么finalize方法非常不好,非常影响性能"></a>为什么finalize方法非常不好,非常影响性能</h2><h3 id="非常不好"><a href="#非常不好" class="headerlink" title="非常不好"></a>非常不好</h3><ol>
<li>FinalizerThread 是守护线程,代码很有可能没来得及执行完,线程就结束了,造成资源没有正确释放</li>
<li>异常被吞掉这个就太糟了,你甚至不能判断有没有在释放资源时发生错误.</li>
</ol>
<h3 id="影响性能"><a href="#影响性能" class="headerlink" title="影响性能"></a>影响性能</h3><ol>
<li>重写了finalize 方法的对象在第一次被gc时,并不能及时释放它占用的内存,因为要等着FinalizerThread 调用完finalize,把它从第一个unfinalized队列移除后,第二次gc时才能真正释放内存</li>
<li>可以想象gc本就因为内存不足引起,finalize 调用又很慢(两个队列的移除操作,都是串行执行的,用来释放连接类的资源也应该不快),不能及时释放内存,对象释放不及时就会逐渐移入老年代,老年代垃圾积累过多就会容易full gc, full gc后释放速度如果仍跟不上创建新对象的速度,就会OOM<br>质疑</li>
</ol>
<h3 id="质疑"><a href="#质疑" class="headerlink" title="质疑"></a>质疑</h3><p>有的文章提到【Finalizer线程会和我们的主线程进行竞争,不过由于它的优先级较低,获取到的CPU时间较少,因此它永远也赶不上主线程的步伐】这个显然是错误的, FinalizerThread的优先级较普通线程更高,赶不上步伐的原因应该是finalize执行慢等原因综合导致</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> &#123;<br>       <span class="hljs-type">ThreadGroup</span> <span class="hljs-variable">tg</span> <span class="hljs-operator">=</span> Thread.currentThread().getThreadGroup();<br>       <span class="hljs-keyword">for</span> (<span class="hljs-type">ThreadGroup</span> <span class="hljs-variable">tgn</span> <span class="hljs-operator">=</span> tg;<br>            tgn != <span class="hljs-literal">null</span>;<br>            tg = tgn, tgn = tg.getParent());<br>       <span class="hljs-type">Thread</span> <span class="hljs-variable">finalizer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FinalizerThread</span>(tg);<br>    	<span class="hljs-comment">//普通线程优先级是五，这个是八</span><br>       finalizer.setPriority(Thread.MAX_PRIORITY - <span class="hljs-number">2</span>);<br>    	<span class="hljs-comment">//这是一个守护线程，即当其他的非守护线程都结束了，守护线程就要结束</span><br>       finalizer.setDaemon(<span class="hljs-literal">true</span>);<br>       finalizer.start();<br>   &#125;<br></code></pre></td></tr></table></figure>


                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E8%A7%86%E9%A2%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="category-chain-item">视频学习笔记</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/java%E8%99%9A%E6%8B%9F%E6%9C%BA-itcast/">#java虚拟机-itcast</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>虚拟机-itcast</div>
      <div>http://example.com/2023/03/30/itcast-虚拟机/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>John Doe</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>March 30, 2023</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/03/30/itcast-%E6%A1%86%E6%9E%B6%E7%AF%87/" title="框架篇-itcast">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">框架篇-itcast</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/03/30/Java%E5%9F%BA%E7%A1%80-%E5%BE%90%E7%A3%8A-File%E4%B8%8E%E9%80%92%E5%BD%92%E4%B8%8EIO/" title="File与递归与IO-heima">
                        <span class="hidden-mobile">File与递归与IO-heima</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>WAITING</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
