<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>框架篇-itcast | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="ApplicationContext refreshrefresh 12 个步骤1是做一些准备工作2-6创建和准备beanfactory对象 bean的创建 bean的依赖注入 bean的初始化都是由beanfactory对象完成的7-12为applicationContext特有的功能作准备11是创建的单例bean的创建和初始化">
<meta property="og:type" content="article">
<meta property="og:title" content="框架篇-itcast">
<meta property="og:url" content="http://example.com/2023/03/30/%E6%A1%86%E6%9E%B6%E7%AF%87-itcast/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="ApplicationContext refreshrefresh 12 个步骤1是做一些准备工作2-6创建和准备beanfactory对象 bean的创建 bean的依赖注入 bean的初始化都是由beanfactory对象完成的7-12为applicationContext特有的功能作准备11是创建的单例bean的创建和初始化">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823212602150.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823212644428.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823212740972.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-30_15-34-57.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-31_09-55-51.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-31_10-16-44.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-31_10-26-16.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-31_16-15-00.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-04-01_20-53-03.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-04-01_21-30-27.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823214405224.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-04-01_21-40-40.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-04-01_23-19-04.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-04-01_23-19-53.png">
<meta property="article:published_time" content="2023-03-30T09:56:27.000Z">
<meta property="article:modified_time" content="2023-03-30T14:14:41.482Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="java框架-itcast">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823212602150.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-框架篇-itcast" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/03/30/%E6%A1%86%E6%9E%B6%E7%AF%87-itcast/" class="article-date">
  <time class="dt-published" datetime="2023-03-30T09:56:27.000Z" itemprop="datePublished">2023-03-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E8%A7%86%E9%A2%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">视频学习笔记</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      框架篇-itcast
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="ApplicationContext-refresh"><a href="#ApplicationContext-refresh" class="headerlink" title="ApplicationContext refresh"></a>ApplicationContext refresh</h2><h2 id="refresh-12-个步骤"><a href="#refresh-12-个步骤" class="headerlink" title="refresh 12 个步骤"></a>refresh 12 个步骤</h2><p><code>1</code>是做一些准备工作<br><code>2-6</code>创建和准备beanfactory对象 bean的创建 bean的依赖注入 bean的初始化都是由beanfactory对象完成的<br><code>7-12</code>为applicationContext特有的功能作准备<br><code>11</code>是创建的单例bean的创建和初始化</p>
<span id="more"></span> 

<h3 id="1-prepareRefresh"><a href="#1-prepareRefresh" class="headerlink" title="1.prepareRefresh"></a>1.prepareRefresh</h3><hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823212602150.png" alt="image-20220823212602150"></p>
<hr>
<p>Environment管理各种键值信息<br>Environment 的作用之一是为后续 @Value,值注入时提供键值</p>
<ul>
<li>代码体现</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> day04.refresh;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.QualifierAnnotationAutowireCandidateResolver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.config.BeanExpressionContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.config.DependencyDescriptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.support.DefaultListableBeanFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.expression.StandardBeanExpressionResolver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.env.Environment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.env.StandardEnvironment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.ClassPathResource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.support.ResourcePropertySource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如何获得和解析 @Value 内容</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestEnvironment</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchFieldException, IOException &#123;</span><br><span class="line">        <span class="comment">// 1) 获得 @Value 的值</span></span><br><span class="line">        System.out.println(<span class="string">&quot;仅获取 @Value 值&quot;</span>);</span><br><span class="line">        <span class="type">QualifierAnnotationAutowireCandidateResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QualifierAnnotationAutowireCandidateResolver</span>();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">name</span> <span class="operator">=</span> resolver.getSuggestedValue(<span class="keyword">new</span> <span class="title class_">DependencyDescriptor</span>(Bean1.class.getDeclaredField(<span class="string">&quot;name&quot;</span>), <span class="literal">false</span>));</span><br><span class="line">        System.out.println(name);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2) 解析 @Value 的值</span></span><br><span class="line">        System.out.println(<span class="string">&quot;获取 @Value 值, 并解析$&#123;&#125;&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">javaHome</span> <span class="operator">=</span> resolver.getSuggestedValue(<span class="keyword">new</span> <span class="title class_">DependencyDescriptor</span>(Bean1.class.getDeclaredField(<span class="string">&quot;javaHome&quot;</span>), <span class="literal">false</span>));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">jdbcName</span> <span class="operator">=</span> resolver.getSuggestedValue(<span class="keyword">new</span> <span class="title class_">DependencyDescriptor</span>(Bean1.class.getDeclaredField(<span class="string">&quot;jdbcName&quot;</span>), <span class="literal">false</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;值:&quot;</span> + javaHome);</span><br><span class="line">        System.out.println(<span class="string">&quot;执行解析后$&#123;&#125;:&quot;</span> + getEnvironment().resolvePlaceholders(javaHome.toString()));</span><br><span class="line">        System.out.println(<span class="string">&quot;执行解析后$&#123;&#125;:&quot;</span> + getEnvironment().resolvePlaceholders(String.valueOf(jdbcName)));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3) 解析 SpEL 表达式</span></span><br><span class="line">        System.out.println(<span class="string">&quot;获取 @Value 值, 并解析#&#123;&#125;&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">expression</span> <span class="operator">=</span> resolver.getSuggestedValue(<span class="keyword">new</span> <span class="title class_">DependencyDescriptor</span>(Bean1.class.getDeclaredField(<span class="string">&quot;expression&quot;</span>), <span class="literal">false</span>));</span><br><span class="line">        <span class="comment">//拿到了对应的值</span></span><br><span class="line">        System.out.println(<span class="string">&quot;值:&quot;</span> + expression);</span><br><span class="line">        <span class="comment">//将 $&#123;键&#125; 替换成对应的值</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">v1</span> <span class="operator">=</span> getEnvironment().resolvePlaceholders(expression.toString());</span><br><span class="line">        System.out.println(<span class="string">&quot;执行解析后$&#123;&#125;:&quot;</span> + v1);</span><br><span class="line">        <span class="comment">//将 #&#123;&#125; 中的表达式内容进行计算得出结果</span></span><br><span class="line">        System.out.println(<span class="string">&quot;执行解析#&#123;&#125;后:&quot;</span> + <span class="keyword">new</span> <span class="title class_">StandardBeanExpressionResolver</span>().evaluate(v1, <span class="keyword">new</span> <span class="title class_">BeanExpressionContext</span>(<span class="keyword">new</span> <span class="title class_">DefaultListableBeanFactory</span>(), <span class="literal">null</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Environment <span class="title function_">getEnvironment</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">StandardEnvironment</span> <span class="variable">env</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StandardEnvironment</span>();</span><br><span class="line">        env.getPropertySources().addLast(<span class="keyword">new</span> <span class="title class_">ResourcePropertySource</span>(<span class="string">&quot;jdbc&quot;</span>, <span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;jdbc.properties&quot;</span>)));</span><br><span class="line">        <span class="keyword">return</span> env;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Bean1</span> &#123;</span><br><span class="line">        <span class="meta">@Value(&quot;hello&quot;)</span></span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Value(&quot;$&#123;JAVA_HOME&#125;&quot;)</span></span><br><span class="line">        <span class="keyword">private</span> String javaHome;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Value(&quot;$&#123;jdbc.username&#125;&quot;)</span></span><br><span class="line">        <span class="keyword">private</span> String jdbcName;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Value(&quot;#&#123;&#x27;class version:&#x27; + &#x27;$&#123;java.class.version&#125;&#x27;&#125;&quot;)</span></span><br><span class="line">        <span class="keyword">private</span> String expression;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">==========================================</span><br><span class="line">仅获取 <span class="meta">@Value</span> 值</span><br><span class="line">hello</span><br><span class="line">获取 <span class="meta">@Value</span> 值, 并解析$&#123;&#125;</span><br><span class="line">值:$&#123;JAVA_HOME&#125;</span><br><span class="line">执行解析后$&#123;&#125;:D:\sofeware\Idea\JDK1<span class="number">.8</span></span><br><span class="line">执行解析后$&#123;&#125;:root</span><br><span class="line">获取 <span class="meta">@Value</span> 值, 并解析#&#123;&#125;</span><br><span class="line">值:#&#123;<span class="string">&#x27;class version:&#x27;</span> + <span class="string">&#x27;$&#123;java.class.version&#125;&#x27;</span>&#125;</span><br><span class="line">执行解析后$&#123;&#125;:#&#123;<span class="string">&#x27;class version:&#x27;</span> + <span class="string">&#x27;61.0&#x27;</span>&#125;</span><br><span class="line">执行解析#&#123;&#125;后:<span class="keyword">class</span> <span class="title class_">version</span>:<span class="number">61.0</span></span><br></pre></td></tr></table></figure>





<h3 id="2-obtainFreshBeanFactory"><a href="#2-obtainFreshBeanFactory" class="headerlink" title="2.obtainFreshBeanFactory"></a>2.obtainFreshBeanFactory</h3><hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823212644428.png" alt="image-20220823212644428"></p>
<hr>
<p>BeanFactory 的作用是负责 bean 的创建、依赖注入和初始化<br>BeanDefinition 作为bean 的设计蓝图,规定了bean的特征,如单例多例、依赖关系、初始销毁方法等<br>BeanDefinition的来源有多种多样,可以是通过xml获得、通过配置类获得、通过组件扫描获得,也可以是编程添加 </p>
<ul>
<li>BeanDefinition来源</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> day04.refresh;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.support.BeanDefinitionBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.support.DefaultListableBeanFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.xml.XmlBeanDefinitionReader;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ClassPathBeanDefinitionScanner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ConfigurationClassPostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.ClassPathResource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 演示各种 BeanDefinition 的来源</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBeanDefinition</span> &#123;</span><br><span class="line">    	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;========一开始========&quot;</span>);</span><br><span class="line">            <span class="comment">//BeanFactory的一个重要的实现类</span></span><br><span class="line">            <span class="type">DefaultListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultListableBeanFactory</span>();</span><br><span class="line">            <span class="comment">//获取BeanFactory中所有的 BeanDefinition</span></span><br><span class="line">            System.out.println(Arrays.toString(beanFactory.getBeanDefinitionNames()));</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;======== 1从 xml 获取=======&quot;</span>);</span><br><span class="line">            <span class="comment">//XmlBeanDefinitionReader是专门用来解析xml文件的类，并且构造参器的入参就是BeanFactory实例</span></span><br><span class="line">            <span class="comment">//即 会将从xml文件中解析到的BeanDefinition添加到BeanFactory</span></span><br><span class="line">            <span class="type">XmlBeanDefinitionReader</span> <span class="variable">reader1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XmlBeanDefinitionReader</span>(beanFactory);</span><br><span class="line">            reader1.loadBeanDefinitions(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;bd.xml&quot;</span>));</span><br><span class="line">            System.out.println(Arrays.toString(beanFactory.getBeanDefinitionNames()));</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;==========2从配置类获取============&quot;</span>);</span><br><span class="line">            <span class="comment">//借助spring的工具方法，将Config1类包装成一个名为config1的BeanDefinition对象，再将BeanDefinition对象加入到BeanFactory中</span></span><br><span class="line">            beanFactory.registerBeanDefinition(<span class="string">&quot;config1&quot;</span>, BeanDefinitionBuilder.genericBeanDefinition(Config1.class).getBeanDefinition());</span><br><span class="line"></span><br><span class="line">            <span class="comment">//ConfigurationClassPostProcessor是BeanFactory的后处理器，对BeanFactory进行功能加强</span></span><br><span class="line">            <span class="comment">//即可以解析方法上的注解，将有注解标注的类包装成BeanDefinition添加到BeanFactory中</span></span><br><span class="line">            <span class="comment">//因为配置类是在方法上加@Bean注解，spring的基础功能不能识别并将其包装成BeanDefinition</span></span><br><span class="line">            <span class="comment">//会通过ConfigurationClassPostProcessor进行处理</span></span><br><span class="line">            <span class="type">ConfigurationClassPostProcessor</span> <span class="variable">postProcessor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConfigurationClassPostProcessor</span>();</span><br><span class="line">            postProcessor.postProcessBeanDefinitionRegistry(beanFactory);</span><br><span class="line">            System.out.println(Arrays.toString(beanFactory.getBeanDefinitionNames()));</span><br><span class="line">            beanFactory.registerBeanDefinition(<span class="string">&quot;config2&quot;</span>, BeanDefinitionBuilder.genericBeanDefinition(Config1.class).getBeanDefinition());</span><br><span class="line">            System.out.println(Arrays.toString(beanFactory.getBeanDefinitionNames()));</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;===========3扫描获取=============&quot;</span>);</span><br><span class="line">            <span class="type">ClassPathBeanDefinitionScanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathBeanDefinitionScanner</span>(beanFactory);</span><br><span class="line">            scanner.scan(<span class="string">&quot;day04.refresh&quot;</span>);</span><br><span class="line">            System.out.println(Arrays.toString(beanFactory.getBeanDefinitionNames()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Bean1</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Bean2</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Config1</span> &#123;</span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="keyword">public</span> Bean2 <span class="title function_">bean2</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Bean2</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Config2</span> &#123;</span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="keyword">public</span> Bean2 <span class="title function_">bean3</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Bean2</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//给组件器别名，不然 TestBeanDefinition.bean44</span></span><br><span class="line">    <span class="meta">@Component(&quot;bean44&quot;)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Bean44</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">===============================================</span><br><span class="line">=======一开始========</span><br><span class="line">[]</span><br><span class="line">======== <span class="number">1</span>从 xml 获取=======</span><br><span class="line">[bean1]</span><br><span class="line">==========<span class="number">2</span>从配置类获取============</span><br><span class="line">[bean1, config1, bean2]</span><br><span class="line">[bean1, config1, bean2, config2]</span><br><span class="line">===========<span class="number">3</span>扫描获取=============</span><br><span class="line">[bean1, config1, bean2, config2, bean44, bean3, org.springframework.context.annotation.internalConfigurationAnnotationProcessor, org.springframework.context.annotation.internalAutowiredAnnotationProcessor, org.springframework.context.annotation.internalCommonAnnotationProcessor, org.springframework.context.event.internalEventListenerProcessor, org.springframework.context.event.internalEventListenerFactory]</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="3-prepareBeanFactory"><a href="#3-prepareBeanFactory" class="headerlink" title="3.prepareBeanFactory"></a>3.prepareBeanFactory</h3><hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823212740972.png" alt="image-20220823212740972"></p>
<hr>
<ul>
<li>小结</li>
</ul>
<ol>
<li>StandardBeanExpressionResolver 解析 SpEL</li>
<li>ResourceEditorRegistrar 会注释类型转换器,并应用 ApplicationContext 提供的Environment完成${}解析</li>
<li>特殊 bean 指 beanFactory 以及 ApplicationContext【本质上就是对象还不是bean】,通过 registerResolvableDependency 来注册它们</li>
<li>ApplicationContextAwareProcessor 用来解析 Aware 接口 ,对bean的各个阶段进行功能加强</li>
</ol>
<h3 id="4-postProcessBeanFactory"><a href="#4-postProcessBeanFactory" class="headerlink" title="4.postProcessBeanFactory"></a>4.postProcessBeanFactory</h3><ol>
<li>AbstractApplicationContext类的postProcessBeanFactory方法是空实现，目的是有子类来实现该方法【体现模板方法思想】</li>
<li>Application主要有两大类实现，第一种是Web环境下的子类，另一种就是非Web环境下的子类；Web环境下的子类初始化BeanFactory需要更多的信息，比如他需要注册更多的scrope(作用域)sington、prototype、request、session</li>
<li>一般Web 环境的ApplicationContext 都要利用它注册新的Scope,完善 Web 下的BeanFactory</li>
<li>体现的是模板方法设计模式</li>
</ol>
<h3 id="5-invokeBeanFactoryPostProcessors"><a href="#5-invokeBeanFactoryPostProcessors" class="headerlink" title="5.invokeBeanFactoryPostProcessors"></a>5.invokeBeanFactoryPostProcessors</h3><hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-30_15-34-57.png"></p>
<hr>
<ol>
<li>beanFactory 后处理器,充当beanFactory 的扩展点,可以用来补充或修改BeanDefinition</li>
<li>ConfigurationClassPostProcessor - 解析 @Configuration, @Bean, @lmport. @PropertySource 等  </li>
<li>一般的BeanFactory中没有这些方法，如果要使用就需要借助BeanFactory的后处理器，目的是可以添加更多的BeanDefinition到BeanDefinitionMap中</li>
</ol>
<h3 id="6-registerBeanPostProcessors"><a href="#6-registerBeanPostProcessors" class="headerlink" title="6.registerBeanPostProcessors"></a>6.registerBeanPostProcessors</h3><ol>
<li>Bean的后处理器，对bean的创建过程中进行的各种功能增强</li>
<li>在BeanDefinitionMap中寻找每一个BeanDefinition看是否有实现PostPorcessors接口，如果有说明这又是一个特殊的bean【bean的后处理器】，将其添加到     BeanProcessors集合中 ，在真正的bean创建时就会使用这些后处理器</li>
<li>bean 后处理器,充当bean 的扩展点,可以工作在bean的实例化、依赖注入、初始化阶段</li>
<li>AutowiredAnnotationBeanPostProcessor 功能有解析 @Autowired, @Value 注解</li>
<li>CommonAnnotationBeanPostProcessor 功能有解析 @Resource, @PostConstruct, @PreDestroy</li>
<li>AnnotationAwareAspectjAutoProxyCreator 功能有:为符合切点的目标bean 自动创建代理 </li>
<li>registerBeanPostProcessors这一步只是创建了bean后处理器，并将其添加到某一个集合中，实际调用得在后续创建bean时</li>
</ol>
<ul>
<li>代码体现</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> day04.refresh;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Before;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.aspectj.annotation.AnnotationAwareAspectJAutoProxyCreator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.support.BeanDefinitionBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.support.DefaultListableBeanFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.CommonAnnotationBeanPostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.GenericApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 一些重要的Bean后处理器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBeanPostProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//ApplicationContext的一个简单实现【标准的beanFactory缺失一些功能】需要扩展功能</span></span><br><span class="line">        <span class="comment">//加入多个bean(bean的后处理器)</span></span><br><span class="line">        <span class="type">GenericApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericApplicationContext</span>();</span><br><span class="line">        <span class="comment">//通过applicationContext拿到它内部的一个BeanFactory</span></span><br><span class="line">        <span class="type">DefaultListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> context.getDefaultListableBeanFactory();</span><br><span class="line">        <span class="comment">//通过编程的方式注入了一些Bean</span></span><br><span class="line">        <span class="comment">//即创建一些固定名称的BeanDefinition对象添加到beanFactory中</span></span><br><span class="line">        beanFactory.registerBeanDefinition(<span class="string">&quot;bean1&quot;</span>, BeanDefinitionBuilder.genericBeanDefinition(Bean1.class).getBeanDefinition());</span><br><span class="line">        beanFactory.registerBeanDefinition(<span class="string">&quot;bean2&quot;</span>, BeanDefinitionBuilder.genericBeanDefinition(Bean2.class).getBeanDefinition());</span><br><span class="line">        beanFactory.registerBeanDefinition(<span class="string">&quot;bean3&quot;</span>, BeanDefinitionBuilder.genericBeanDefinition(Bean3.class).getBeanDefinition());</span><br><span class="line">        beanFactory.registerBeanDefinition(<span class="string">&quot;aspect1&quot;</span>, BeanDefinitionBuilder.genericBeanDefinition(Aspect1.class).getBeanDefinition());</span><br><span class="line">        <span class="comment">//当需要创建bean时，就会有人去扫描beanFactory，扫描出bean的后处理器</span></span><br><span class="line">        <span class="comment">//AutowiredAnnotationBeanPostProcessor用于解析@Autowired\@Value</span></span><br><span class="line">        beanFactory.registerBeanDefinition(<span class="string">&quot;processor1&quot;</span>,</span><br><span class="line">                BeanDefinitionBuilder.genericBeanDefinition(AutowiredAnnotationBeanPostProcessor.class).getBeanDefinition());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//CommonAnnotationBeanPostProcessor解析 @Resource, @PostConstruct, @PreDestroy注解</span></span><br><span class="line">        beanFactory.registerBeanDefinition(<span class="string">&quot;processor2&quot;</span>,</span><br><span class="line">                BeanDefinitionBuilder.genericBeanDefinition(CommonAnnotationBeanPostProcessor.class).getBeanDefinition());</span><br><span class="line">        <span class="comment">//AnnotationAwareAspectJAutoProxyCreator解析@Aspect注解和@Before注解</span></span><br><span class="line">        <span class="comment">//当发现有某个方法契合切面类定义的el表达式时，就不会创建普通的bean，而是会创建代理对象</span></span><br><span class="line">        <span class="comment">//在代理对象中进行功能增强，先调用前置通知，然后调用真正的目标方法</span></span><br><span class="line">        beanFactory.registerBeanDefinition(<span class="string">&quot;processor3&quot;</span>,</span><br><span class="line">                BeanDefinitionBuilder.genericBeanDefinition(AnnotationAwareAspectJAutoProxyCreator.class).getBeanDefinition());</span><br><span class="line">        <span class="comment">//通过调用context的refresh方法配置好容器</span></span><br><span class="line">        context.refresh();</span><br><span class="line">        <span class="comment">//拿到BeanFactory对象从中拿一个指定类型的bean</span></span><br><span class="line">        <span class="comment">//然后调用其foo方法</span></span><br><span class="line">        beanFactory.getBean(Bean1.class).foo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Bean1</span> &#123;</span><br><span class="line">        Bean2 bean2;</span><br><span class="line">        Bean3 bean3;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Autowired</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBean2</span><span class="params">(Bean2 bean2)</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;发生了依赖注入...&quot;</span> + bean2);</span><br><span class="line">            <span class="built_in">this</span>.bean2 = bean2;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Resource</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBean3</span><span class="params">(Bean3 bean3)</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;发生了依赖注入...&quot;</span> + bean3);</span><br><span class="line">            <span class="built_in">this</span>.bean3 = bean3;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">foo</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;foo&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Bean2</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Bean3</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//一个切面类</span></span><br><span class="line">    <span class="meta">@Aspect</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Aspect1</span> &#123;</span><br><span class="line">        <span class="comment">//给符合expression表达式的方法添加一个前置通知</span></span><br><span class="line">        <span class="meta">@Before(&quot;execution(* foo())&quot;)</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;before...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">====================================================</span><br><span class="line">发生了依赖注入...day04.refresh.TestBeanPostProcessor$Bean3@19b843ba</span><br><span class="line">发生了依赖注入...day04.refresh.TestBeanPostProcessor$Bean2<span class="meta">@dc9876b</span></span><br><span class="line">before...</span><br><span class="line">foo</span><br></pre></td></tr></table></figure>



<h3 id="7-initMessageSource"><a href="#7-initMessageSource" class="headerlink" title="7.initMessageSource"></a>7.initMessageSource</h3><ol>
<li>ApplicatonContext的一个多有功能，beanFactroy中没有</li>
<li>实现国际化</li>
<li>容器【beanDefinition】中一个名为messageSource 的bean,如果没有,则提供空的MessageSource 实现</li>
</ol>
<h3 id="8-initApplicationEventMulticaster"><a href="#8-initApplicationEventMulticaster" class="headerlink" title="8.initApplicationEventMulticaster"></a>8.initApplicationEventMulticaster</h3><hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-31_09-55-51.png"></p>
<hr>
<ol>
<li>用来发布事件给监听器</li>
<li>可以从容器【beanDefinitionMap】中找名为 applicationEventMulticaster 的bean作为事件广播器,若没有,也会新建默认的事件广播器</li>
<li>可以调用 ApplicationContext.publishEvent(事件对象)来发布事件</li>
<li>applicationEventMulticaster中有一个集合，存放所有的监听器，当applicationEventMulticaster发布事件时，会遍历集合找到对该事件感兴趣的监听器</li>
</ol>
<h3 id="9-onRefresh"><a href="#9-onRefresh" class="headerlink" title="9.onRefresh"></a>9.onRefresh</h3><ol>
<li>这一步是空实现，留给子类扩展</li>
<li>SpringBoot 中的子类可以在这里准备WebServer,即内嵌web容器，SpringBoot中有内嵌的web容器</li>
<li>体现的是模板方法设计模式</li>
</ol>
<h3 id="10-registerListeners"><a href="#10-registerListeners" class="headerlink" title="10.registerListeners"></a>10.registerListeners</h3><ol>
<li>用来接收事件</li>
<li>一部分监听器是事先编程添加的、另一部分监听器来自容器中的bean、还有一部分来自于@EventListener的方法的解析</li>
<li>实现ApplicationListener接口,重写其中 onApplicationEvent(E e)方法即可 ，然后会将该监听器添加到applicationEvenMulticaster的集合中</li>
</ol>
<h3 id="11-finishBeanFactorylnitialization"><a href="#11-finishBeanFactorylnitialization" class="headerlink" title="11.finishBeanFactorylnitialization"></a>11.finishBeanFactorylnitialization</h3><hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-31_10-16-44.png"></p>
<hr>
<ol>
<li>conversionService也是一套转换机制,作为对PropertyEditor 的补充</li>
<li>embeddedValueResolvers(内嵌值解析器)用来解析 @Value 中的${},借用的是Environment 的功能</li>
<li>singletonObjects(单例池)【一个Map集合】用来缓存所有非延迟单例对象,对象的创建都分三个阶段【bean的创建、依赖注入和初始化】,每一阶段都有不同的bean后处理器参与进来,扩展功能</li>
</ol>
<h3 id="12-finishRefresh"><a href="#12-finishRefresh" class="headerlink" title="12.finishRefresh"></a>12.finishRefresh</h3><hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-31_10-26-16.png"></p>
<hr>
<ol>
<li>lifecycleProcessor【生命周期处理器】用来控制容器内需要生命周期管理的bean</li>
<li>如果容器【beanDefinitionMap】中有名称为lifecycleProcessor的bean 就用它,否则创建默认的生命周期管理器</li>
<li>调用 context的start,即可触发所有实现LifeCycle接口 bean 的start </li>
<li>调用context 的 stop,即可触发所有实现LifeCycle接口bean的stop</li>
<li>最后会发布ContextRefreshed事件，表示整个refresh阶段完成【整个Spring容器已经初始化完成】</li>
</ol>
<h2 id="refresh的总结"><a href="#refresh的总结" class="headerlink" title="refresh的总结"></a>refresh的总结</h2><ol>
<li><p>prepareRefresh - 创建一个Environment对象，为spring后续的功能做好准备一些键值信息</p>
</li>
<li><p>obtainFreshBeanFactory - 创建或获取 BeanFactory</p>
</li>
<li><p>prepareBeanFactory - 准备 BeanFactory【为beanFactory准备好成员变量；如:EL表达式的解析器，类型转换器】</p>
</li>
<li><p>postProcessBeanFactory - 子类拓展 BeanFactory</p>
</li>
<li><p>invokeBeanFactoryPostProcessors - BeanFactory后处理器，可以解析配置类的相关注解如@Configuration、@Bean，@Import</p>
</li>
<li><p>registerBeanPostProcessors - 准备 Bean 后处理器，在后续bean的创建、依赖注入、初始化时使用@Autowired，@Value、@PostConstruct, @PreDestroy、@Aspect</p>
</li>
<li><p>initMessageSource - 为 ApplicationContext 提供国际化功能</p>
</li>
<li><p>initApplicationEventMulticaster - 为 ApplicationContext 提供事件发布器，里面有一个集合，用于维护所有实现了applicationListener的bean</p>
</li>
<li><p>onRefresh - 留给子类扩展</p>
</li>
<li><p>registerListeners - ApplicationContext 准备监听器</p>
</li>
<li><p>finishBeanFactorylnitialization - 初始化非延迟单例Bean,在创建每一个bean时，执行Bean 后处理器扩展</p>
</li>
<li><p>finishRefresh - 准备生命周期管理器,由事件发布器发布 ContextRefreshed 事件</p>
</li>
</ol>
<h2 id="Spring-Bean的生命周期"><a href="#Spring-Bean的生命周期" class="headerlink" title="Spring Bean的生命周期"></a>Spring Bean的生命周期</h2><p>从创建到销毁，spring主要做了什么事情</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//入口</span></span><br><span class="line"><span class="comment">//spring中的bean都符合懒惰式加载的，即一开始spring并不会创建这些bean，只有当第一次想要获取这个bean时，才会创建bean，然后依赖注入，然后初始化</span></span><br><span class="line"> <span class="keyword">protected</span> &lt;T&gt; T <span class="title function_">doGetBean</span><span class="params">(String name, <span class="meta">@Nullable</span> Class&lt;T&gt; requiredType, <span class="meta">@Nullable</span> Object[] args, <span class="type">boolean</span> typeCheckOnly)</span> <span class="keyword">throws</span> BeansException </span><br></pre></td></tr></table></figure>



<h3 id="阶段1-处理名称-检查缓存"><a href="#阶段1-处理名称-检查缓存" class="headerlink" title="阶段1:处理名称,检查缓存"></a>阶段1:处理名称,检查缓存</h3><ol>
<li>别名处理，一个bean可以有多个别名，先把别名解析为实际名称,再使用真实的名称进行后续处理</li>
<li>FactoryBean，用于生产对象的工厂bean，若要FactoryBean 本身,需要使用&amp;名称获取，如果不加&amp;会取工厂中的产品</li>
<li>singletonObjects 是一级缓存,放单例成品对象【当想要获取bean时，先看缓存有没有这个bean如果没有，看一下父有没有容器，再找父容器，父容器没有才考虑创建】</li>
<li>singletonFactories 是三级缓存,放单例工厂【用于解决循环依赖】</li>
<li>earlySingletonObjects 是二级缓存,放单例工厂的产品,可称为提前单例对象 【解决既有代理，又有循环有依赖】</li>
</ol>
<h3 id="阶段2-检查父工厂"><a href="#阶段2-检查父工厂" class="headerlink" title="阶段2:检查父工厂"></a>阶段2:检查父工厂</h3><ol>
<li>当想要获取bean时，先看缓存有没有这个bean如果没有，看一下父有没有容器，再找父容器，父容器没有才考虑创建</li>
<li>父子容器的bean名称可以重复</li>
<li>优先找子容器的bean,找到了直接返回,找不到继续到父容器找</li>
</ol>
<h3 id="阶段3-检查DependsOn"><a href="#阶段3-检查DependsOn" class="headerlink" title="阶段3:检查DependsOn"></a>阶段3:检查DependsOn</h3><p>有dependsOn时的bean初始化顺序：dependsOn用在非显示依赖的bean的创建顺序控制，A dependsOn B B先创建</p>
<h3 id="阶段4-按Scope创建bean"><a href="#阶段4-按Scope创建bean" class="headerlink" title="阶段4:按Scope创建bean"></a>阶段4:按Scope创建bean</h3><p>常见的作用域:singleton、prototype、request、session、application</p>
<ul>
<li>代码体现</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> day04.bean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> day02.LoggerUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.CommonAnnotationBeanPostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.GenericApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.mock.web.MockHttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestScope;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.ServletWebRequest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.PreDestroy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestScope</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//testSingletonScope();//容器结束前</span></span><br><span class="line">        <span class="comment">//testPrototypeScope();//自己调用</span></span><br><span class="line">        testRequestScope();<span class="comment">//请求结束前</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 单例 bean 从 refresh 被创建, 到 close 被销毁, BeanFactory 会记录哪些 bean 要调用销毁方法</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">testSingletonScope</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//创建一个最简单spring容器</span></span><br><span class="line">        <span class="type">GenericApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericApplicationContext</span>();</span><br><span class="line">        <span class="comment">//注册一个名为BeanDefinition的对象添加到beanDefinitionMap中</span></span><br><span class="line">        context.registerBean(<span class="string">&quot;bean1&quot;</span>, Bean1.class);</span><br><span class="line">        <span class="comment">//注册一个bean的后处理器，用于解析@Resource @PostConstruct @PreDestroy</span></span><br><span class="line">        context.registerBean(CommonAnnotationBeanPostProcessor.class);</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// 【单例bean】准备好spring容器 就相当于调用容器的getBean方法，创建或获取每一个单例bean，维护在单例池中</span></span><br><span class="line">        context.refresh();</span><br><span class="line">        <span class="comment">//【单例bean】当容器调用close方法时，此时会遍历容器中的bean看是否有销毁方法，有就会调用</span></span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 多例 bean 从首次 getBean 被创建, 到调用 BeanFactory 的 destroyBean 被销毁</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">testPrototypeScope</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">GenericApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericApplicationContext</span>();</span><br><span class="line">        <span class="comment">//默认的作用域时singletonScope，当需要使用其他作用域时，需要在蓝图中进行指定</span></span><br><span class="line">        context.registerBean(<span class="string">&quot;bean1&quot;</span>, Bean1.class, bd -&gt; bd.setScope(<span class="string">&quot;prototype&quot;</span>));</span><br><span class="line">        <span class="comment">//注册一个bean的后处理器，用于解析@Resource @PostConstruct @PreDestroy</span></span><br><span class="line">        context.registerBean(CommonAnnotationBeanPostProcessor.class);</span><br><span class="line">        <span class="comment">//准备好spring容器0【多例模式下是不会提前创建每一个bean维护在单例池中，想要用的时候自己getBean】</span></span><br><span class="line">        context.refresh();</span><br><span class="line">        <span class="comment">//获取指定类型的bean</span></span><br><span class="line">        <span class="type">Bean1</span> <span class="variable">bean</span> <span class="operator">=</span> context.getBean(Bean1.class);</span><br><span class="line">        <span class="comment">// 没谁记录该 bean 要调用销毁方法, 需要我们自行调用</span></span><br><span class="line">        context.getDefaultListableBeanFactory().destroyBean(bean);</span><br><span class="line"></span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// request bean 从首次 getBean 被创建, 到 request 结束前被销毁</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">testRequestScope</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//定义一个简单的容器实现</span></span><br><span class="line">        <span class="type">GenericApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericApplicationContext</span>();</span><br><span class="line">        <span class="comment">//在非web的环境下需要自己添加RequestScope的bean</span></span><br><span class="line">        context.getDefaultListableBeanFactory().registerScope(<span class="string">&quot;request&quot;</span>, <span class="keyword">new</span> <span class="title class_">RequestScope</span>());</span><br><span class="line">        <span class="comment">//默认的作用域时singletonScope，当需要使用其他作用域时，需要在蓝图中进行指定</span></span><br><span class="line">        context.registerBean(<span class="string">&quot;bean1&quot;</span>, Bean1.class, bd -&gt; bd.setScope(<span class="string">&quot;request&quot;</span>));</span><br><span class="line">        <span class="comment">//bean后处理器</span></span><br><span class="line">        context.registerBean(CommonAnnotationBeanPostProcessor.class);</span><br><span class="line">        <span class="comment">//主备好容器</span></span><br><span class="line">        context.refresh();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                <span class="comment">//spring提供的假的request对象，用于测试</span></span><br><span class="line">                <span class="type">MockHttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MockHttpServletRequest</span>();</span><br><span class="line">                <span class="comment">//将request对象进行封装</span></span><br><span class="line">                <span class="comment">// 每个 webRequest 对象会记录哪些 bean 要调用销毁方法</span></span><br><span class="line">                <span class="type">ServletWebRequest</span> <span class="variable">webRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletWebRequest</span>(request);</span><br><span class="line">                <span class="comment">//将ServletWebRequest绑定到当前线程</span></span><br><span class="line">                RequestContextHolder.setRequestAttributes(webRequest);</span><br><span class="line">                <span class="comment">//当bean创建出来后就会存放在request中</span></span><br><span class="line">                <span class="type">Bean1</span> <span class="variable">bean</span> <span class="operator">=</span> context.getBean(Bean1.class);</span><br><span class="line">                <span class="comment">//在同一个request中是同一个bean</span></span><br><span class="line">                LoggerUtils.get().debug(<span class="string">&quot;&#123;&#125;&quot;</span>, bean);</span><br><span class="line">                LoggerUtils.get().debug(<span class="string">&quot;&#123;&#125;&quot;</span>, request.getAttribute(<span class="string">&quot;bean1&quot;</span>));</span><br><span class="line"></span><br><span class="line">                <span class="comment">//请求结束前调用 request域中保存的bean的销毁方法</span></span><br><span class="line">                webRequest.requestCompleted();</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Bean1</span> &#123;</span><br><span class="line">        <span class="comment">//初始化方法</span></span><br><span class="line">        <span class="meta">@PostConstruct</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">            LoggerUtils.get().debug(<span class="string">&quot;&#123;&#125; - init&quot;</span>, <span class="built_in">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//销毁方法</span></span><br><span class="line">        <span class="meta">@PreDestroy</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">            LoggerUtils.get().debug(<span class="string">&quot;&#123;&#125; - destroy&quot;</span>, <span class="built_in">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">=======================testSingletonScope==========================</span><br><span class="line">[DEBUG] <span class="number">15</span>:<span class="number">53</span>:<span class="number">31.373</span> [main] - day04.bean.TestScope$Bean1@1fa121e2 - init </span><br><span class="line">[DEBUG] <span class="number">15</span>:<span class="number">53</span>:<span class="number">31.395</span> [main] - day04.bean.TestScope$Bean1@1fa121e2 - destroy </span><br><span class="line"></span><br><span class="line">=======================testPrototypeScope==========================</span><br><span class="line">[DEBUG] <span class="number">15</span>:<span class="number">54</span>:<span class="number">13.690</span> [main] - day04.bean.TestScope$Bean1@37883b97 - init </span><br><span class="line">[DEBUG] <span class="number">15</span>:<span class="number">54</span>:<span class="number">13.693</span> [main] - day04.bean.TestScope$Bean1@37883b97 - destroy    </span><br><span class="line">        </span><br><span class="line">=======================testRequestScope==========================</span><br><span class="line">[DEBUG] <span class="number">15</span>:<span class="number">54</span>:<span class="number">43.628</span> [Thread-<span class="number">0</span>] - day04.bean.TestScope$Bean1@14b6092f - init </span><br><span class="line">[DEBUG] <span class="number">15</span>:<span class="number">54</span>:<span class="number">43.628</span> [Thread-<span class="number">1</span>] - day04.bean.TestScope$Bean1@<span class="number">69316170</span> - init </span><br><span class="line">[DEBUG] <span class="number">15</span>:<span class="number">54</span>:<span class="number">43.631</span> [Thread-<span class="number">0</span>] - day04.bean.TestScope$Bean1@14b6092f </span><br><span class="line">[DEBUG] <span class="number">15</span>:<span class="number">54</span>:<span class="number">43.631</span> [Thread-<span class="number">1</span>] - day04.bean.TestScope$Bean1@<span class="number">69316170</span> </span><br><span class="line">[DEBUG] <span class="number">15</span>:<span class="number">54</span>:<span class="number">43.631</span> [Thread-<span class="number">0</span>] - day04.bean.TestScope$Bean1@14b6092f </span><br><span class="line">[DEBUG] <span class="number">15</span>:<span class="number">54</span>:<span class="number">43.631</span> [Thread-<span class="number">1</span>] - day04.bean.TestScope$Bean1@<span class="number">69316170</span> </span><br><span class="line">[DEBUG] <span class="number">15</span>:<span class="number">54</span>:<span class="number">43.631</span> [Thread-<span class="number">1</span>] - day04.bean.TestScope$Bean1@<span class="number">69316170</span> - destroy </span><br><span class="line">[DEBUG] <span class="number">15</span>:<span class="number">54</span>:<span class="number">43.631</span> [Thread-<span class="number">0</span>] - day04.bean.TestScope$Bean1@14b6092f - destroy </span><br></pre></td></tr></table></figure>

<ul>
<li>小结</li>
</ul>
<ol>
<li>scope 理解为从xxx范围内找这个bean更加贴切</li>
<li>singleton scope 表示从单例池范围内获取bean,如果没有,则创建并放入单例池</li>
<li>prototype scope 表示从不缓存 bean,每次都创建新的</li>
<li>request scope 表示从 request 对象范围内获取 bean,如果没有,则创建并放入request…</li>
</ol>
<h3 id="阶段5-创建bean"><a href="#阶段5-创建bean" class="headerlink" title="阶段5:创建bean"></a>阶段5:创建bean</h3><hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-31_16-15-00.png"></p>
<hr>
<ul>
<li>创建阶段—主要掌握两种</li>
</ul>
<p>AutowiredAnnotationBeanPostPrecessor选择构造:优先选择带有@Autowired注解的构造器初始化bean；如有唯一的 带参数的构造器，也会使用该构造</p>
<p>采用默认构造:【保底策略】如果AutowiredAnnotationBeanPostPrecessor后处理器和BeanDefinition都没有找到构造，采用默认的无参构造，即使是私有的【暴力反射】</p>
<ul>
<li>依赖注入阶段</li>
</ul>
<ol>
<li>AutowiredAnnotationBeanPostProcessor(注解匹配)：识别 @Autowired 及 @Value 标注的成员,将这些成员封装为InjectionMetadata ，然后由InjectionMetadata 进行依赖注入</li>
<li>CommonAnnotationBeanPostProcessor(注解匹配)：识别@Resource 标注的成员,封装为InjectionMetadata ，然后由InjectionMetadata 进行依赖注入</li>
<li>AUTOWIRE_BY_NAME(根据名字匹配):定义bean的时候可以添加这个配置，根据成员名字到容器中寻找有么有该名字的bean 对象,有就完成接下来的依赖注入；修改 mbd 的 propertyValues,不会考虑简单类型的成员</li>
<li>AUTOWIRE_BY_TYPE(根据类型匹配)：定义bean的时候可以添加这个配置，根据成员类型到容器中寻找有么有该类型的bean ，有就完成接下来的依赖注入resolveDependency找到依赖注入的值,修改mbd 的 propertyValues<br>5.applyPropertyValues(xml中 &lt;property name reflvalue(精确指定)&#x2F;&gt;)：在xml文件中指定某个bean需要某个值，根据 mbd propertyValues 进行依赖注入</li>
</ol>
<ul>
<li>代码体现</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> day04.bean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.config.RuntimeBeanReference;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.support.AbstractBeanDefinition;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.support.RootBeanDefinition;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.AnnotationConfigUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.GenericApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试如果对同一属性进行的 @Autowired 注入、AUTOWIRE_BY_NAME、精确指定注入名称, 优先级是怎样的</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestInjection</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">GenericApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericApplicationContext</span>();</span><br><span class="line">        AnnotationConfigUtils.registerAnnotationConfigProcessors(context.getDefaultListableBeanFactory());</span><br><span class="line">        <span class="comment">//将bean1的蓝图添加到beanDefinitionMap中，并在蓝图中指定依赖注入的方式</span></span><br><span class="line">        context.registerBean(<span class="string">&quot;bean1&quot;</span>, Bean1.class, bd -&gt; &#123;</span><br><span class="line">            <span class="comment">// 优先级最高的：精确指定注入 bean 的名称 &lt;property name=&quot;bean3&quot; ref=&quot;bean2&quot;/&gt;【精准匹配 1】</span></span><br><span class="line">            bd.getPropertyValues().add(<span class="string">&quot;bean3&quot;</span>, <span class="keyword">new</span> <span class="title class_">RuntimeBeanReference</span>(<span class="string">&quot;bean2&quot;</span>));</span><br><span class="line">            <span class="comment">// 优先级次之的：通过 AUTOWIRE_BY_NAME 匹配【名字匹配 2】</span></span><br><span class="line">            ((RootBeanDefinition) bd).setAutowireMode(AbstractBeanDefinition.AUTOWIRE_BY_NAME);</span><br><span class="line">        &#125;);</span><br><span class="line">        context.registerBean(<span class="string">&quot;bean2&quot;</span>, Bean2.class);</span><br><span class="line">        context.registerBean(<span class="string">&quot;bean3&quot;</span>, Bean3.class);</span><br><span class="line">        context.registerBean(<span class="string">&quot;bean4&quot;</span>, Bean4.class);</span><br><span class="line"></span><br><span class="line">        context.refresh();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Bean1</span> &#123;</span><br><span class="line">        MyInterface bean;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 优先级最低的：@Autowired 匹配【注解匹配 3】</span></span><br><span class="line">        <span class="meta">@Autowired</span><span class="comment">//给MyInterface bean进行依赖注入</span></span><br><span class="line">        <span class="meta">@Qualifier(&quot;bean4&quot;)</span><span class="comment">//类型相同时【bean2、bean3、bean4类型都是MyInterface】，需要指定名字匹配</span></span><br><span class="line">        <span class="comment">//根据名字匹配是根据setter的名字进行匹配 此处是bean3</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBean3</span><span class="params">(MyInterface bean)</span> &#123;</span><br><span class="line">            System.out.println(bean);</span><br><span class="line">            <span class="built_in">this</span>.bean = bean;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">interface</span> <span class="title class_">MyInterface</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Bean2</span> <span class="keyword">implements</span> <span class="title class_">MyInterface</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Bean3</span> <span class="keyword">implements</span> <span class="title class_">MyInterface</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Bean4</span> <span class="keyword">implements</span> <span class="title class_">MyInterface</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">========================================</span><br><span class="line">day04.bean.TestInjection$Bean2@434a63ab</span><br><span class="line">    </span><br></pre></td></tr></table></figure>



<ul>
<li>初始化阶段</li>
</ul>
<ol>
<li>内置Aware接口的装配 包括BeanNameAware接口, BeanFactoryAware接口等 只要bean实现了Aware接口 那么在bean的初始化阶段 beanFactory就会回调这些方法</li>
<li>扩展Aware接口的装配</li>
<li>@PostConstruct 标注这是这个bean的初始化方法，该注解是通过一个bean后处理器(CommonAnnotationBeanPostProcessor)进行识别和调用，执行时机在postProcessBeforeInitialization</li>
<li>实现由spring提供的initializingBean接口，在bean初始化阶段时通过接口回调实现初始化</li>
<li>在beanDefinition中规定哪个方法是初始化方法，有两种方式指定：一、在xml中<bean init-method> 二、@Bean(initMethod)</li>
<li>通过AnnotationAwareAspectJAutoProxyCreator 一个bean后处理器识别@Aspect注解，创建aop代理，执行时机在postProcessAfterInitialization【在初始化的最后一步创建aop代理】</li>
</ol>
<ul>
<li>代码体现</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> day04.bean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.BeanFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.BeanFactoryAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.InitializingBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.CommonAnnotationBeanPostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.GenericApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestInitialization</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">GenericApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericApplicationContext</span>();</span><br><span class="line">        context.registerBean(CommonAnnotationBeanPostProcessor.class);</span><br><span class="line">        <span class="comment">// &lt;bean init-method=&quot;initMethod&quot;&gt;</span></span><br><span class="line">        context.registerBean(<span class="string">&quot;bean1&quot;</span>, Bean1.class, bd -&gt; bd.setInitMethodName(<span class="string">&quot;initMethod&quot;</span>));</span><br><span class="line">        context.refresh();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Bean1</span> <span class="keyword">implements</span> <span class="title class_">InitializingBean</span>, BeanFactoryAware &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//实现spring提供的InitializingBean接口进行初始化【第三】</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            System.out.println(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//使用CommonAnnotationBeanPostProcessor解析@postConstruce经行初始化【第二】</span></span><br><span class="line">        <span class="meta">@PostConstruct</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//通过在蓝图中指定初始化方法最后【第四】</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initMethod</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(<span class="number">3</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//实现Aware接口的方法进行初始化优先级最高</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBeanFactory</span><span class="params">(BeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">            System.out.println(<span class="number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">=================================</span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">3</span></span><br></pre></td></tr></table></figure>





<ul>
<li>注册可销毁bean</li>
</ul>
<p>判断依据</p>
<pre><code>  1. 如果实现了DisposableBean【与InitializingBean接口对应，一个是实现初始化接口、一个是销毁接口】 或 AutoCloseable 接口,则为可销毁bean
  2. 如果自定义了destroyMethod,则为可销毁bean. @Bean(destroyMethod=&#39;xxx&#39;)
  3. 如果采用 @Bean 没有指定destroyMethod,则采用自动推断方式获取销毁方法名(close, shutdown).
  4. 如果有@PreDestroy 标注的方法CommonAnnotationBeanPostProcessor bean后处理器
     存储位置
  5. singleton scope的可销bean 会存储于beanFactory的成员当中【这个成员变量是一个集合】【当beanFactory调用close方法时，会遍历集合中的bean，调用其销毁方法】
  6. 自定义scope的可销毁bean会存储于对应的域对象当中 例如request、session；当与对象的生命周期结束时，会找到域中的bean并调用其销毁方法
  7. prototype scope 不会存储,需要自己找到此对象销毁
  8. 存储时都会封装为DisposableBeanAdapter类型对销毁方法的调用进行适配【体现适配器模式】
</code></pre>
<ul>
<li>阶段6 类型转化</li>
</ul>
<p>​		如果 getBean 的requiredType 参数与实际得到的对象类型不同,会尝试进行类型转换</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (requiredType != <span class="literal">null</span> &amp;&amp; !requiredType.isInstance(bean)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Object</span> <span class="variable">convertedBean</span> <span class="operator">=</span> <span class="built_in">this</span>.getTypeConverter().convertIfNecessary(bean, requiredType);</span><br><span class="line">                <span class="keyword">if</span> (convertedBean == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanNotOfRequiredTypeException</span>(name, requiredType, bean.getClass());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> convertedBean;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (TypeMismatchException var5) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">this</span>.logger.isTraceEnabled()) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.logger.trace(<span class="string">&quot;Failed to convert bean &#x27;&quot;</span> + name + <span class="string">&quot;&#x27; to required type &#x27;&quot;</span> + ClassUtils.getQualifiedName(requiredType) + <span class="string">&quot;&#x27;&quot;</span>, var5);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanNotOfRequiredTypeException</span>(name, requiredType, bean.getClass());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> bean;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>阶段7：销毁bean</li>
</ul>
<ol>
<li>singleton bean 的销毁在 ApplicationContext.close 时,此时会找到所有实现DisposableBean接口的bean,逐一销毁</li>
<li>自定义 scope bean 的销毁在作用域对象生命周期结束时</li>
<li>prototype bean 的销毁可以通过自己手动调用 AutowireCapableBeanFactory.destroyBean 方法执行销毁将bean作为方法参数传入</li>
<li>同一bean 中不同形式销毁方法的调用次序.<br>优先后处理器销毁,即@PreDestroy.<br>其次DisposableBean 接口销毁.<br>最后destroyMethod 销毁(包括自定义名称,推断名称,AutoCloseable接口 多选一)</li>
</ol>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>阶段1:处理名称,检查缓存 将别名换成真实名称，取缓存中找bean<br>阶段2:检查父工厂 自己没有这个bean 看父工厂有没有 没有才创建<br>阶段3:检查DependsOn 先创建所依赖的bean 或是创建指定先创建的bean<br>阶段4:按Scope创建bean 将其存放在不同的位置中 注意 prototype不会特地使用某个集合进行管理，需要自己管理<br>    ① 创建singleton<br>    ② 创建 prototype<br>    ③ 创建其它scope request、session、application<br>阶段5:创建bean<br>    1.创建bean实例-@Autowired、唯一带参构造、默认无参构造<br>    2.依赖注入- @Autowired @Value, @Resource, ByName ByType, 精确指定<br>    3.初始化 - Aware 接口处理, @PostConstruct, InitializingBean, initMethod 创建代理对象<br>    4.登记可销毁bean DisposableBean接口和AutoCloseable接口 #Bean(destroyMethod&#x3D;’xxx’) @Predestroy、<br>阶段6:类型转换<br>阶段7:销毁bean</p>
<h2 id="Spring事务失效几种场景和解决方法"><a href="#Spring事务失效几种场景和解决方法" class="headerlink" title="Spring事务失效几种场景和解决方法"></a>Spring事务失效几种场景和解决方法</h2><h3 id="1-抛出检查异常导致事务不能正确回滚"><a href="#1-抛出检查异常导致事务不能正确回滚" class="headerlink" title="1. 抛出检查异常导致事务不能正确回滚"></a>1. 抛出检查异常导致事务不能正确回滚</h3><p>原因: Spring默认只会回滚非检查异常<br>解法: 配置rollbackFor属性</p>
<ul>
<li>account.sql</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> account;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> account</span><br><span class="line">(</span><br><span class="line">    accountNo <span class="type">int</span> <span class="keyword">primary</span> key auto_increment,</span><br><span class="line">    balance   <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">)ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;#记住数据库引擎式InnoDB【不然不会启动事务】</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> account (accountNo, balance)</span><br><span class="line"><span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1000</span>),</span><br><span class="line">       (<span class="number">2</span>, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>



<ul>
<li>jdbc.properties</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jdbc.driverClassName</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="attr">jdbc.jdbcUrl</span>=<span class="string">jdbc:mysql://localhost:3306/test?useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line"><span class="attr">jdbc.username</span>=<span class="string">test</span></span><br><span class="line"><span class="attr">jdbc.password</span>=<span class="string">test123</span></span><br></pre></td></tr></table></figure>



<ul>
<li>AppConfigure</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> day04.tx;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.zaxxer.hikari.HikariDataSource;</span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.SqlSessionFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.annotation.MapperScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.ClassPathResource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.datasource.DataSourceTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.datasource.init.DataSourceInitializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.datasource.init.DatabasePopulator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.datasource.init.ResourceDatabasePopulator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.PlatformTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.AnnotationTransactionAttributeSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.interceptor.TransactionAttributeSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span><span class="comment">//配置类</span></span><br><span class="line"><span class="meta">@PropertySource(&quot;classpath:jdbc.properties&quot;)</span><span class="comment">//读取配置文件</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span><span class="comment">//申明式的事务管理</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy(exposeProxy = true)</span><span class="comment">//开启了AOP</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;day04.tx.app.service&quot;)</span><span class="comment">//spring包扫描</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;day04.tx.app.mapper&quot;)</span><span class="comment">//mybatis的包扫描</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 配置数据源</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(&quot;jdbc&quot;)</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HikariDataSource</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 数据源的初始化器</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSourceInitializer <span class="title function_">dataSourceInitializer</span><span class="params">(DataSource dataSource, DatabasePopulator populator)</span> &#123;</span><br><span class="line">        <span class="type">DataSourceInitializer</span> <span class="variable">dataSourceInitializer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataSourceInitializer</span>();</span><br><span class="line">        dataSourceInitializer.setDataSource(dataSource);</span><br><span class="line">        dataSourceInitializer.setDatabasePopulator(populator);</span><br><span class="line">        <span class="keyword">return</span> dataSourceInitializer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 每次初始化就会执行sql脚本 DDL 保证数据一致</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DatabasePopulator <span class="title function_">databasePopulator</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResourceDatabasePopulator</span>(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;account.sql&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 因为要使用到mybatis 所以要有sqlSessionFactory</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SqlSessionFactoryBean <span class="title function_">sqlSessionFactory</span><span class="params">(DataSource dataSource)</span> &#123;</span><br><span class="line">        <span class="type">SqlSessionFactoryBean</span> <span class="variable">factoryBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBean</span>();</span><br><span class="line">        factoryBean.setDataSource(dataSource);</span><br><span class="line">        <span class="keyword">return</span> factoryBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 配合Mybatis一起使用的事务管理器【申明式事务】</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PlatformTransactionManager <span class="title function_">transactionManager</span><span class="params">(DataSource dataSource)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DataSourceTransactionManager</span>(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="comment">// 只要 beanFactory 的 allowBeanDefinitionOverriding==true, 即使系统的 @Bean 定义没有 @ConditionalOnMissingBean 条件，也会被我们的同名 @Bean 覆盖掉</span></span><br><span class="line">    <span class="comment">//@Transaction注解默认只能对public的方法生效【非public方法加上也不会报错，但就是不会开启事务】，此处将入参设置为false，此时在其他修饰符的方法上加@Transaction注解，依然可以开启事务【不推荐】</span></span><br><span class="line">    <span class="keyword">public</span> TransactionAttributeSource <span class="title function_">transactionAttributeSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AnnotationTransactionAttributeSource</span>(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<ul>
<li>AccountMapper</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> day04.tx.app.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Param;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Select;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Update;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AccountMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Update(&quot;update account set balance=balance+#&#123;balance&#125; where accountNo=#&#123;accountNo&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(<span class="meta">@Param(&quot;accountNo&quot;)</span> <span class="type">int</span> accountNo, <span class="meta">@Param(&quot;balance&quot;)</span> <span class="type">int</span> balance)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select(&quot;select balance from account where accountNo=#&#123;accountNo&#125; for update&quot;)</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">findBalanceBy</span><span class="params">(<span class="type">int</span> accountNo)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<ul>
<li>AccountService</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> day04.tx.app.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> day04.tx.app.mapper.AccountMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Service1</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountMapper accountMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//spring默认只会 对 RuntimeException 或 Error 经行回滚操作</span></span><br><span class="line">    <span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(<span class="type">int</span> from, <span class="type">int</span> to, <span class="type">int</span> amount)</span> <span class="keyword">throws</span> FileNotFoundException &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">fromBalance</span> <span class="operator">=</span> accountMapper.findBalanceBy(from);</span><br><span class="line">        <span class="keyword">if</span> (fromBalance - amount &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            accountMapper.update(from, -<span class="number">1</span> * amount);</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">            accountMapper.update(to, amount);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>TestAccountService</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> day04.tx.app.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> day04.tx.AppConfig;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationPropertiesBindingPostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.AnnotationConfigUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.GenericApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestService1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> FileNotFoundException &#123;</span><br><span class="line">        <span class="type">GenericApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericApplicationContext</span>();</span><br><span class="line">        AnnotationConfigUtils.registerAnnotationConfigProcessors(context.getDefaultListableBeanFactory());</span><br><span class="line">        ConfigurationPropertiesBindingPostProcessor.register(context.getDefaultListableBeanFactory());</span><br><span class="line">        context.registerBean(AppConfig.class);</span><br><span class="line">        context.refresh();</span><br><span class="line"></span><br><span class="line">        <span class="type">Service1</span> <span class="variable">bean</span> <span class="operator">=</span> context.getBean(Service1.class);</span><br><span class="line">        bean.transfer(<span class="number">1</span>, <span class="number">2</span>, <span class="number">500</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">==========================================</span><br><span class="line">[INFO] <span class="number">10</span>:<span class="number">26</span>:<span class="number">55.248</span> [main] - HikariPool-<span class="number">1</span> - Starting... </span><br><span class="line">[INFO] <span class="number">10</span>:<span class="number">26</span>:<span class="number">55.365</span> [main] - HikariPool-<span class="number">1</span> - Start completed. </span><br><span class="line">[DEBUG] <span class="number">10</span>:<span class="number">26</span>:<span class="number">55.468</span> [main] - Creating <span class="keyword">new</span> <span class="title class_">transaction</span> with name [day04.tx.app.service.Service1.transfer]: PROPAGATION_REQUIRED,ISOLATION_DEFAULT,-java.lang.Exception </span><br><span class="line">[DEBUG] <span class="number">10</span>:<span class="number">26</span>:<span class="number">55.468</span> [main] - Acquired Connection [HikariProxyConnection@<span class="number">405950359</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@64f555e7] <span class="keyword">for</span> JDBC transaction </span><br><span class="line">[DEBUG] <span class="number">10</span>:<span class="number">26</span>:<span class="number">55.469</span> [main] - Switching JDBC Connection [HikariProxyConnection@<span class="number">405950359</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@64f555e7] to manual commit </span><br><span class="line">[DEBUG] <span class="number">10</span>:<span class="number">26</span>:<span class="number">55.482</span> [main] - ==&gt;  Preparing: select balance from account where accountNo=? <span class="keyword">for</span> update  </span><br><span class="line">[DEBUG] <span class="number">10</span>:<span class="number">26</span>:<span class="number">55.499</span> [main] - ==&gt; Parameters: <span class="number">1</span>(Integer) </span><br><span class="line">[DEBUG] <span class="number">10</span>:<span class="number">26</span>:<span class="number">55.521</span> [main] - &lt;==      Total: <span class="number">1</span> </span><br><span class="line">[DEBUG] <span class="number">10</span>:<span class="number">26</span>:<span class="number">55.526</span> [main] - ==&gt;  Preparing: update account set balance=balance+? where accountNo=?  </span><br><span class="line">[DEBUG] <span class="number">10</span>:<span class="number">26</span>:<span class="number">55.526</span> [main] - ==&gt; Parameters: -<span class="number">500</span>(Integer), <span class="number">1</span>(Integer) </span><br><span class="line">[DEBUG] <span class="number">10</span>:<span class="number">26</span>:<span class="number">55.528</span> [main] - &lt;==    Updates: <span class="number">1</span> </span><br><span class="line">[DEBUG] <span class="number">10</span>:<span class="number">26</span>:<span class="number">55.528</span> [main] - Initiating transaction rollback </span><br><span class="line">[DEBUG] <span class="number">10</span>:<span class="number">26</span>:<span class="number">55.528</span> [main] - Rolling back JDBC transaction on Connection [HikariProxyConnection@<span class="number">405950359</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@64f555e7] </span><br><span class="line">[DEBUG] <span class="number">10</span>:<span class="number">26</span>:<span class="number">55.537</span> [main] - Releasing JDBC Connection [HikariProxyConnection@<span class="number">405950359</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@64f555e7] after transaction </span><br><span class="line">Exception in thread <span class="string">&quot;main&quot;</span> java.io.FileNotFoundException: aaa (系统找不到指定的文件。) </span><br></pre></td></tr></table></figure>





<h3 id="2-业务方法内自己try-catch异常导致事务不能正确回滚"><a href="#2-业务方法内自己try-catch异常导致事务不能正确回滚" class="headerlink" title="2. 业务方法内自己try catch异常导致事务不能正确回滚"></a>2. 业务方法内自己try catch异常导致事务不能正确回滚</h3><p>原因:<br>当在配置类中定义了申明式事务，从容器中获取bean时，得到的不是原来的业务对象，而是一个代理对象，通过代理对象内部会添加事务控制，在事务通知内部才会调用原始的业务方法；事务通知只有捉到了目标抛出的异常,才能进行后续的回滚处理,如果目标自己处理掉异常,事务通知无法知悉，它就不会调用回滚<br>解法<br>    1:异常原样抛出解法<br>    2:手动设置TransactionStatus.setRollbackOnly()</p>
<ul>
<li>AccountService</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> day04.tx.app.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> day04.tx.app.mapper.AccountMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.interceptor.TransactionInterceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Service2</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountMapper accountMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(<span class="type">int</span> from, <span class="type">int</span> to, <span class="type">int</span> amount)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">fromBalance</span> <span class="operator">=</span> accountMapper.findBalanceBy(from);</span><br><span class="line">            <span class="keyword">if</span> (fromBalance - amount &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                accountMapper.update(from, -<span class="number">1</span> * amount);</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">                accountMapper.update(to, amount);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="comment">//抛的如果不是运行时异常，就需要在方法上throws 异常给调用者</span></span><br><span class="line">            <span class="comment">//throw new RuntimeException(e);</span></span><br><span class="line">            <span class="comment">//告诉外层调用者，此时应该回滚了</span></span><br><span class="line">            TransactionInterceptor.currentTransactionStatus().setRollbackOnly();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">=========================================</span><br><span class="line">[INFO] <span class="number">11</span>:<span class="number">17</span>:<span class="number">01.466</span> [main] - HikariPool-<span class="number">1</span> - Starting... </span><br><span class="line">[INFO] <span class="number">11</span>:<span class="number">17</span>:<span class="number">01.580</span> [main] - HikariPool-<span class="number">1</span> - Start completed. </span><br><span class="line">[DEBUG] <span class="number">11</span>:<span class="number">17</span>:<span class="number">01.681</span> [main] - Creating <span class="keyword">new</span> <span class="title class_">transaction</span> with name [day04.tx.app.service.Service2.transfer]: PROPAGATION_REQUIRED,ISOLATION_DEFAULT,-java.lang.Exception </span><br><span class="line">[DEBUG] <span class="number">11</span>:<span class="number">17</span>:<span class="number">01.681</span> [main] - Acquired Connection [HikariProxyConnection@<span class="number">405950359</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@64f555e7] <span class="keyword">for</span> JDBC transaction </span><br><span class="line">[DEBUG] <span class="number">11</span>:<span class="number">17</span>:<span class="number">01.682</span> [main] - Switching JDBC Connection [HikariProxyConnection@<span class="number">405950359</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@64f555e7] to manual commit </span><br><span class="line">[DEBUG] <span class="number">11</span>:<span class="number">17</span>:<span class="number">01.697</span> [main] - ==&gt;  Preparing: select balance from account where accountNo=? <span class="keyword">for</span> update  </span><br><span class="line">[DEBUG] <span class="number">11</span>:<span class="number">17</span>:<span class="number">01.713</span> [main] - ==&gt; Parameters: <span class="number">1</span>(Integer) </span><br><span class="line">[DEBUG] <span class="number">11</span>:<span class="number">17</span>:<span class="number">01.731</span> [main] - &lt;==      Total: <span class="number">1</span> </span><br><span class="line">[DEBUG] <span class="number">11</span>:<span class="number">17</span>:<span class="number">01.735</span> [main] - ==&gt;  Preparing: update account set balance=balance+? where accountNo=?  </span><br><span class="line">[DEBUG] <span class="number">11</span>:<span class="number">17</span>:<span class="number">01.735</span> [main] - ==&gt; Parameters: -<span class="number">500</span>(Integer), <span class="number">1</span>(Integer) </span><br><span class="line">[DEBUG] <span class="number">11</span>:<span class="number">17</span>:<span class="number">01.736</span> [main] - &lt;==    Updates: <span class="number">1</span> </span><br><span class="line">[DEBUG] <span class="number">11</span>:<span class="number">17</span>:<span class="number">01.737</span> [main] - Initiating transaction rollback </span><br><span class="line">[DEBUG] <span class="number">11</span>:<span class="number">17</span>:<span class="number">01.738</span> [main] - Rolling back JDBC transaction on Connection [HikariProxyConnection@<span class="number">405950359</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@64f555e7] </span><br><span class="line">java.io.FileNotFoundException: aaa (系统找不到指定的文件。)</span><br></pre></td></tr></table></figure>



<h3 id="3-aop切面顺序导致导致事务不能正确回滚"><a href="#3-aop切面顺序导致导致事务不能正确回滚" class="headerlink" title="3.aop切面顺序导致导致事务不能正确回滚"></a>3.aop切面顺序导致导致事务不能正确回滚</h3><p>原因:事务切面优先级最低,但如果自定义的切面优先级和他一样,则还是自定义切面在内层,这时若自定义切面没有正确抛出异常，异常被内部消化了，事务通知认为是正确的情况，不会处理【回滚】<br>解法:<br>    让切面外抛异常【推荐】<br>    让切面修改事务状态<br>    修改切面和事务通知的优先级@Order(数值越大，优先级越小)</p>
<ul>
<li>TestAccountService</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> day04.tx.app.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> day02.LoggerUtils;</span><br><span class="line"><span class="keyword">import</span> day04.tx.AppConfig;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Around;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationPropertiesBindingPostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.AnnotationConfigUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.GenericApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.Ordered;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.annotation.Order;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.interceptor.TransactionInterceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestService3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> FileNotFoundException &#123;</span><br><span class="line">        <span class="comment">//applicationContext的简单实现</span></span><br><span class="line">        <span class="type">GenericApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericApplicationContext</span>();</span><br><span class="line">        <span class="comment">//提供一些必要的bean处理器和beanFactory处理器</span></span><br><span class="line">        AnnotationConfigUtils.registerAnnotationConfigProcessors(context.getDefaultListableBeanFactory());</span><br><span class="line">        ConfigurationPropertiesBindingPostProcessor.register(context.getDefaultListableBeanFactory());</span><br><span class="line">        <span class="comment">//将切面类和配置类添加到beanDefinition容器中</span></span><br><span class="line">        context.registerBean(MyAspect.class);</span><br><span class="line">        context.registerBean(AppConfig.class);</span><br><span class="line">        context.refresh();</span><br><span class="line"></span><br><span class="line">        <span class="type">Service3</span> <span class="variable">bean</span> <span class="operator">=</span> context.getBean(Service3.class);</span><br><span class="line">        bean.transfer(<span class="number">1</span>, <span class="number">2</span>, <span class="number">500</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Aspect</span></span><br><span class="line">    <span class="meta">@Order(Ordered.LOWEST_PRECEDENCE - 1)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyAspect</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//环绕增强（transfer方法）</span></span><br><span class="line">        <span class="meta">@Around(&quot;execution(* transfer(..))&quot;)</span></span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">around</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">            LoggerUtils.get().debug(<span class="string">&quot;log:&#123;&#125;&quot;</span>, pjp.getTarget());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//有下一个通知就调用下一个通知</span></span><br><span class="line">                <span class="comment">//没有下一个通知就调用目标方法</span></span><br><span class="line">                <span class="keyword">return</span> pjp.proceed();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                <span class="comment">//向事务通知抛异常</span></span><br><span class="line">                <span class="comment">//throw new RuntimeException();</span></span><br><span class="line">                <span class="comment">//调用事务拦截器，获取当前事务状态，设置为回滚</span></span><br><span class="line">                TransactionInterceptor.currentTransactionStatus().setRollbackOnly();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">=============================================================</span><br><span class="line">[INFO] <span class="number">13</span>:<span class="number">49</span>:<span class="number">29.769</span> [main] - HikariPool-<span class="number">1</span> - Starting... </span><br><span class="line">[INFO] <span class="number">13</span>:<span class="number">49</span>:<span class="number">29.890</span> [main] - HikariPool-<span class="number">1</span> - Start completed. </span><br><span class="line">[DEBUG] <span class="number">13</span>:<span class="number">49</span>:<span class="number">30.027</span> [main] - log:day04.tx.app.service.Service3@3104f7bd <span class="comment">//改变优先级</span></span><br><span class="line">[DEBUG] <span class="number">13</span>:<span class="number">49</span>:<span class="number">30.028</span> [main] - Creating <span class="keyword">new</span> <span class="title class_">transaction</span> with name [day04.tx.app.service.Service3.transfer]: PROPAGATION_REQUIRED,ISOLATION_DEFAULT,-java.lang.Exception </span><br><span class="line">[DEBUG] <span class="number">13</span>:<span class="number">49</span>:<span class="number">30.028</span> [main] - Acquired Connection [HikariProxyConnection@<span class="number">1498705150</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@29ea78b1] <span class="keyword">for</span> JDBC transaction </span><br><span class="line">[DEBUG] <span class="number">13</span>:<span class="number">49</span>:<span class="number">30.029</span> [main] - Switching JDBC Connection [HikariProxyConnection@<span class="number">1498705150</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@29ea78b1] to manual commit </span><br><span class="line">[DEBUG] <span class="number">13</span>:<span class="number">49</span>:<span class="number">30.043</span> [main] - ==&gt;  Preparing: select balance from account where accountNo=? <span class="keyword">for</span> update  </span><br><span class="line">[DEBUG] <span class="number">13</span>:<span class="number">49</span>:<span class="number">30.058</span> [main] - ==&gt; Parameters: <span class="number">1</span>(Integer) </span><br><span class="line">[DEBUG] <span class="number">13</span>:<span class="number">49</span>:<span class="number">30.078</span> [main] - &lt;==      Total: <span class="number">1</span> </span><br><span class="line">[DEBUG] <span class="number">13</span>:<span class="number">49</span>:<span class="number">30.082</span> [main] - ==&gt;  Preparing: update account set balance=balance+? where accountNo=?  </span><br><span class="line">[DEBUG] <span class="number">13</span>:<span class="number">49</span>:<span class="number">30.082</span> [main] - ==&gt; Parameters: -<span class="number">500</span>(Integer), <span class="number">1</span>(Integer) </span><br><span class="line">[DEBUG] <span class="number">13</span>:<span class="number">49</span>:<span class="number">30.083</span> [main] - &lt;==    Updates: <span class="number">1</span> </span><br><span class="line">[DEBUG] <span class="number">13</span>:<span class="number">49</span>:<span class="number">30.084</span> [main] - Initiating transaction rollback </span><br><span class="line">[DEBUG] <span class="number">13</span>:<span class="number">49</span>:<span class="number">30.084</span> [main] - Rolling back JDBC transaction on Connection [HikariProxyConnection@<span class="number">1498705150</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@29ea78b1] </span><br><span class="line">[DEBUG] <span class="number">13</span>:<span class="number">49</span>:<span class="number">30.094</span> [main] - Releasing JDBC Connection [HikariProxyConnection@<span class="number">1498705150</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@29ea78b1] after transaction </span><br><span class="line">java.io.FileNotFoundException: aaa (系统找不到指定的文件。)</span><br></pre></td></tr></table></figure>





<h3 id="4-非public方法导致的事务失效"><a href="#4-非public方法导致的事务失效" class="headerlink" title="4.非public方法导致的事务失效"></a>4.非public方法导致的事务失效</h3><p>原因: Spring 为方法创建代理、添加事务通知、前提条件都是该方法是public的<br>解法:改为public方法 </p>
<h3 id="5-父子容器导致的事务失效"><a href="#5-父子容器导致的事务失效" class="headerlink" title="5.父子容器导致的事务失效"></a>5.父子容器导致的事务失效</h3><p>原因:子容器扫描范围过大,把未加事务配置的service扫描进来【子容器中没有配置解析事务的相关bean，子容器扫到service就直接将其放到子容器中，但没有被相关的bean处理，没有开启事务；此时控制器通过依赖注入使用service,控制器在子容器中，子容器中又有service，就近原则到子容器中取这个service是没有事物的，所以就会出事】<br>父容器放 service mapper datasource 子容器放controller springMVC【相关配置】<br>解法1:各扫描各的,不要图简便<br>解法2:不要用父子容器,所有bean放在同一容器【springBoot就会把所有的bean放在同一个容器中】</p>
<ul>
<li>TestAccountService</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> day04.tx.app.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> day04.tx.AppConfig;</span><br><span class="line"><span class="keyword">import</span> day04.tx.WebConfig;</span><br><span class="line"><span class="keyword">import</span> day04.tx.app.controller.AccountController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationPropertiesBindingPostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.AnnotationConfigUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.GenericApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestService5</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> FileNotFoundException &#123;</span><br><span class="line">        <span class="comment">//简单的applicationContext 作为父容器</span></span><br><span class="line">        <span class="type">GenericApplicationContext</span> <span class="variable">parent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericApplicationContext</span>();</span><br><span class="line">        <span class="comment">//添加基本的bean 后处理器和 beanFactory 后处理器</span></span><br><span class="line">        AnnotationConfigUtils.registerAnnotationConfigProcessors(parent.getDefaultListableBeanFactory());</span><br><span class="line">        ConfigurationPropertiesBindingPostProcessor.register(parent.getDefaultListableBeanFactory());</span><br><span class="line">        <span class="comment">//添加配置类</span></span><br><span class="line">        parent.registerBean(AppConfig.class);</span><br><span class="line">        <span class="comment">//准备好容器</span></span><br><span class="line">        parent.refresh();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//简单的applicationContext 作为子容器</span></span><br><span class="line">        <span class="type">GenericApplicationContext</span> <span class="variable">child</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericApplicationContext</span>();</span><br><span class="line">        AnnotationConfigUtils.registerAnnotationConfigProcessors(child.getDefaultListableBeanFactory());</span><br><span class="line">        <span class="comment">//设置父子容器关系</span></span><br><span class="line">        child.setParent(parent);</span><br><span class="line">        <span class="comment">//添加一个与父容器不同的配置类</span></span><br><span class="line">        child.registerBean(WebConfig.class);</span><br><span class="line">        <span class="comment">//准备好容器</span></span><br><span class="line">        child.refresh();</span><br><span class="line">        <span class="comment">//透过子容器获取控制器</span></span><br><span class="line">        <span class="type">AccountController</span> <span class="variable">bean</span> <span class="operator">=</span> child.getBean(AccountController.class);</span><br><span class="line">        bean.transfer(<span class="number">1</span>, <span class="number">2</span>, <span class="number">500</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>AppConfig【父容器配置类】</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> day04.tx;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.zaxxer.hikari.HikariDataSource;</span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.SqlSessionFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.annotation.MapperScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.ClassPathResource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.datasource.DataSourceTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.datasource.init.DataSourceInitializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.datasource.init.DatabasePopulator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.datasource.init.ResourceDatabasePopulator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.PlatformTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.AnnotationTransactionAttributeSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.interceptor.TransactionAttributeSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span><span class="comment">//配置类</span></span><br><span class="line"><span class="meta">@PropertySource(&quot;classpath:jdbc.properties&quot;)</span><span class="comment">//读取配置文件</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span><span class="comment">//申明式的事务管理</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy(exposeProxy = true)</span><span class="comment">//开启了AOP</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;day04.tx.app.service&quot;)</span><span class="comment">//spring包扫描</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;day04.tx.app.mapper&quot;)</span><span class="comment">//mybatis的包扫描</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 配置数据源</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(&quot;jdbc&quot;)</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HikariDataSource</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 数据源的初始化器</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSourceInitializer <span class="title function_">dataSourceInitializer</span><span class="params">(DataSource dataSource, DatabasePopulator populator)</span> &#123;</span><br><span class="line">        <span class="type">DataSourceInitializer</span> <span class="variable">dataSourceInitializer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataSourceInitializer</span>();</span><br><span class="line">        dataSourceInitializer.setDataSource(dataSource);</span><br><span class="line">        dataSourceInitializer.setDatabasePopulator(populator);</span><br><span class="line">        <span class="keyword">return</span> dataSourceInitializer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 每次初始化就会执行sql脚本 DDL 保证数据一致</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DatabasePopulator <span class="title function_">databasePopulator</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResourceDatabasePopulator</span>(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;account.sql&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 因为要使用到mybatis 所以要有sqlSessionFactory</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SqlSessionFactoryBean <span class="title function_">sqlSessionFactory</span><span class="params">(DataSource dataSource)</span> &#123;</span><br><span class="line">        <span class="type">SqlSessionFactoryBean</span> <span class="variable">factoryBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBean</span>();</span><br><span class="line">        factoryBean.setDataSource(dataSource);</span><br><span class="line">        <span class="keyword">return</span> factoryBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 配合Mybatis一起使用的事务管理器【申明式事务】</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PlatformTransactionManager <span class="title function_">transactionManager</span><span class="params">(DataSource dataSource)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DataSourceTransactionManager</span>(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="comment">// 只要 beanFactory 的 allowBeanDefinitionOverriding==true, 即使系统的 @Bean 定义没有 @ConditionalOnMissingBean 条件，也会被我们的同名 @Bean 覆盖掉</span></span><br><span class="line">    <span class="keyword">public</span> TransactionAttributeSource <span class="title function_">transactionAttributeSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AnnotationTransactionAttributeSource</span>(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>WebConfig【子容器配置类】</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> day04.tx;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ComponentScan(&quot;day04.tx.app&quot;)</span><span class="comment">//扫描到的包有service controller mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>AccountController</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> day04.tx.app.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> day04.tx.app.service.Service5;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> Service5 service;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(<span class="type">int</span> from, <span class="type">int</span> to, <span class="type">int</span> amount)</span> <span class="keyword">throws</span> FileNotFoundException &#123;</span><br><span class="line">        service.transfer(from, to, amount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>AccountService</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> day04.tx.app.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> day04.tx.app.mapper.AccountMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Service5</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountMapper accountMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(<span class="type">int</span> from, <span class="type">int</span> to, <span class="type">int</span> amount)</span> <span class="keyword">throws</span> FileNotFoundException &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">fromBalance</span> <span class="operator">=</span> accountMapper.findBalanceBy(from);</span><br><span class="line">        <span class="keyword">if</span> (fromBalance - amount &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            accountMapper.update(from, -<span class="number">1</span> * amount);</span><br><span class="line">            accountMapper.update(to, amount);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="6-调用本类方法导致传播行为失效"><a href="#6-调用本类方法导致传播行为失效" class="headerlink" title="6.调用本类方法导致传播行为失效"></a>6.调用本类方法导致传播行为失效</h3><p>原因:本类方法调用不经过代理,因此无法增强<br>解法1:依赖注入自己(代理)来调用<br>解法2:通过AopContext 拿到代理对象,来调用<br>解法3:通过CTW, LTW 实现功能增强</p>
<ul>
<li>Service</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> day04.tx.app.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> day02.LoggerUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.framework.AopContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Propagation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Service6</span> &#123;</span><br><span class="line">    <span class="comment">//自己注入自己有可能造成循环依赖</span></span><br><span class="line">    <span class="comment">//但此时从容器中得到的就是代理</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Service6 proxy;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//传播行为【Propagation.REQUIRED】当此时没有事务就会创建新的事务，如果已经有事务了就会添加已有事务</span></span><br><span class="line">    <span class="meta">@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">foo</span><span class="params">()</span> <span class="keyword">throws</span> FileNotFoundException &#123;</span><br><span class="line">        LoggerUtils.get().debug(<span class="string">&quot;foo&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;调用通过依赖注入的自己：&quot;</span> + proxy.getClass());</span><br><span class="line">        <span class="comment">//proxy.bar();</span></span><br><span class="line">        <span class="comment">//bar();</span></span><br><span class="line">        System.out.println(<span class="string">&quot;当前对象:&quot;</span> + <span class="built_in">this</span>.getClass());</span><br><span class="line">        <span class="comment">//通过类型获取AOP代理对象，再调用代理对象的方法</span></span><br><span class="line">        ((Service6) AopContext.currentProxy()).bar();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//是要有带有事务通知的代理对象调用该方法才能启用事务</span></span><br><span class="line">    <span class="comment">//一定会开启一个新的事务</span></span><br><span class="line">    <span class="meta">@Transactional(propagation = Propagation.REQUIRES_NEW, rollbackFor = Exception.class)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bar</span><span class="params">()</span> <span class="keyword">throws</span> FileNotFoundException &#123;</span><br><span class="line">        LoggerUtils.get().debug(<span class="string">&quot;bar&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">=========================================</span><br><span class="line">[INFO] <span class="number">17</span>:<span class="number">35</span>:<span class="number">17.947</span> [main] - HikariPool-<span class="number">1</span> - Starting... </span><br><span class="line">[INFO] <span class="number">17</span>:<span class="number">35</span>:<span class="number">18.065</span> [main] - HikariPool-<span class="number">1</span> - Start completed. </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">day04</span>.tx.app.service.Service6$$EnhancerBySpringCGLIB$$8c911253</span><br><span class="line">[DEBUG] <span class="number">17</span>:<span class="number">35</span>:<span class="number">18.165</span> [main] - Creating <span class="keyword">new</span> <span class="title class_">transaction</span> with name [day04.tx.app.service.Service6.foo]: PROPAGATION_REQUIRED,ISOLATION_DEFAULT,-java.lang.Exception </span><br><span class="line">[DEBUG] <span class="number">17</span>:<span class="number">35</span>:<span class="number">18.165</span> [main] - Acquired Connection [HikariProxyConnection@<span class="number">1693799911</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@71178a52] <span class="keyword">for</span> JDBC transaction </span><br><span class="line">[DEBUG] <span class="number">17</span>:<span class="number">35</span>:<span class="number">18.166</span> [main] - Switching JDBC Connection [HikariProxyConnection@<span class="number">1693799911</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@71178a52] to manual commit </span><br><span class="line">[DEBUG] <span class="number">17</span>:<span class="number">35</span>:<span class="number">18.170</span> [main] - foo </span><br><span class="line">调用通过依赖注入的自己：<span class="keyword">class</span> <span class="title class_">day04</span>.tx.app.service.Service6$$EnhancerBySpringCGLIB$$8c911253</span><br><span class="line">当前对象:<span class="keyword">class</span> <span class="title class_">day04</span>.tx.app.service.Service6</span><br><span class="line">[DEBUG] <span class="number">17</span>:<span class="number">35</span>:<span class="number">18.171</span> [main] - Suspending current transaction, creating <span class="keyword">new</span> <span class="title class_">transaction</span> with name [day04.tx.app.service.Service6.bar] </span><br><span class="line">[DEBUG] <span class="number">17</span>:<span class="number">35</span>:<span class="number">18.174</span> [main] - Acquired Connection [HikariProxyConnection@<span class="number">1676010932</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@13a37e2a] <span class="keyword">for</span> JDBC transaction </span><br><span class="line">[DEBUG] <span class="number">17</span>:<span class="number">35</span>:<span class="number">18.174</span> [main] - Switching JDBC Connection [HikariProxyConnection@<span class="number">1676010932</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@13a37e2a] to manual commit </span><br><span class="line">[DEBUG] <span class="number">17</span>:<span class="number">35</span>:<span class="number">18.174</span> [main] - bar </span><br><span class="line">[DEBUG] <span class="number">17</span>:<span class="number">35</span>:<span class="number">18.175</span> [main] - Initiating transaction commit </span><br><span class="line">[DEBUG] <span class="number">17</span>:<span class="number">35</span>:<span class="number">18.175</span> [main] - Committing JDBC transaction on Connection [HikariProxyConnection@<span class="number">1676010932</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@13a37e2a] </span><br><span class="line">[DEBUG] <span class="number">17</span>:<span class="number">35</span>:<span class="number">18.175</span> [main] - Releasing JDBC Connection [HikariProxyConnection@<span class="number">1676010932</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@13a37e2a] after transaction </span><br><span class="line">[DEBUG] <span class="number">17</span>:<span class="number">35</span>:<span class="number">18.175</span> [main] - Resuming suspended transaction after completion of inner transaction </span><br><span class="line">[DEBUG] <span class="number">17</span>:<span class="number">35</span>:<span class="number">18.175</span> [main] - Initiating transaction commit </span><br><span class="line">[DEBUG] <span class="number">17</span>:<span class="number">35</span>:<span class="number">18.175</span> [main] - Committing JDBC transaction on Connection [HikariProxyConnection@<span class="number">1693799911</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@71178a52] </span><br><span class="line">[DEBUG] <span class="number">17</span>:<span class="number">35</span>:<span class="number">18.175</span> [main] - Releasing JDBC Connection [HikariProxyConnection@<span class="number">1693799911</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@71178a52] after transaction </span><br></pre></td></tr></table></figure>



<ul>
<li>TestService</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> day04.tx.app.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> day04.tx.AppConfig;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationPropertiesBindingPostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.AnnotationConfigUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.GenericApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestService6</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> FileNotFoundException &#123;</span><br><span class="line">        <span class="type">GenericApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericApplicationContext</span>();</span><br><span class="line">        AnnotationConfigUtils.registerAnnotationConfigProcessors(context.getDefaultListableBeanFactory());</span><br><span class="line">        ConfigurationPropertiesBindingPostProcessor.register(context.getDefaultListableBeanFactory());</span><br><span class="line">        context.registerBean(AppConfig.class);</span><br><span class="line">        context.refresh();</span><br><span class="line"></span><br><span class="line">        <span class="type">Service6</span> <span class="variable">bean</span> <span class="operator">=</span> context.getBean(Service6.class);</span><br><span class="line">        System.out.println(bean.getClass());</span><br><span class="line">        bean.foo();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="7-Transactional-没有保证原子行为"><a href="#7-Transactional-没有保证原子行为" class="headerlink" title="7. @Transactional 没有保证原子行为"></a>7. @Transactional 没有保证原子行为</h3><p>原因:事务的原子性涵盖insert, update, delete, select… for update 语句, select 方法并不阻塞<br>@Transaction 【多线程下会发生线程安全问题 指令交错，确实保证了更新原子性，总数不变，但数目到达负数，不符合逻辑】</p>
<ul>
<li>问题体现</li>
<li>TestService</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> day04.tx.app.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> day04.tx.AppConfig;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.MDC;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationPropertiesBindingPostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.AnnotationConfigUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.GenericApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestService7</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">GenericApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericApplicationContext</span>();</span><br><span class="line">        AnnotationConfigUtils.registerAnnotationConfigProcessors(context.getDefaultListableBeanFactory());</span><br><span class="line">        ConfigurationPropertiesBindingPostProcessor.register(context.getDefaultListableBeanFactory());</span><br><span class="line">        context.registerBean(AppConfig.class);</span><br><span class="line">        context.refresh();</span><br><span class="line"></span><br><span class="line">        <span class="type">Service7</span> <span class="variable">bean</span> <span class="operator">=</span> context.getBean(Service7.class);</span><br><span class="line">        <span class="comment">//锁</span></span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">MyThread</span>(() -&gt; &#123;</span><br><span class="line">            bean.transfer(<span class="number">1</span>, <span class="number">2</span>, <span class="number">1000</span>);</span><br><span class="line">            latch.countDown();</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>, <span class="string">&quot;boldMagenta&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">MyThread</span>(() -&gt; &#123;</span><br><span class="line">            bean.transfer(<span class="number">1</span>, <span class="number">2</span>, <span class="number">1000</span>);</span><br><span class="line">            latch.countDown();</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>, <span class="string">&quot;boldBlue&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//等到t1、t2都执行完毕才会继续执行</span></span><br><span class="line">        latch.await();</span><br><span class="line">        System.out.println(bean.findBalance(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> String color;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">MyThread</span><span class="params">(Runnable target, String name, String color)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>(target, name);</span><br><span class="line">            <span class="built_in">this</span>.color = color;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            MDC.put(<span class="string">&quot;thread&quot;</span>, color);</span><br><span class="line">            <span class="built_in">super</span>.run();</span><br><span class="line">            MDC.remove(<span class="string">&quot;thread&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<ul>
<li>Service</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> day04.tx.app.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> day04.tx.app.mapper.AccountMapper;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Service7</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(Service7.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountMapper accountMapper;</span><br><span class="line">    <span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line">    <span class="comment">//没有锁住事务提交的代码，即可以在事务提交前获取到没有更新的金额</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(<span class="type">int</span> from, <span class="type">int</span> to, <span class="type">int</span> amount)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">fromBalance</span> <span class="operator">=</span> accountMapper.findBalanceBy(from);</span><br><span class="line">        logger.debug(<span class="string">&quot;更新前查询余额为: &#123;&#125;&quot;</span>, fromBalance);</span><br><span class="line">        <span class="keyword">if</span> (fromBalance - amount &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            accountMapper.update(from, -<span class="number">1</span> * amount);</span><br><span class="line">            accountMapper.update(to, amount);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">findBalance</span><span class="params">(<span class="type">int</span> accountNo)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> accountMapper.findBalanceBy(accountNo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<ul>
<li>结果</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">05</span>:<span class="number">57.810</span> [t2] - Creating <span class="keyword">new</span> <span class="title class_">transaction</span> with name [day04.tx.app.service.Service7.transfer]:</span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">05</span>:<span class="number">57.810</span> [t1] - Creating <span class="keyword">new</span> <span class="title class_">transaction</span> with name [day04.tx.app.service.Service7.transfer]: </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">05</span>:<span class="number">57.812</span> [t2] - Acquired Connection [HikariProxyConnection@<span class="number">1235355069</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@8b254bd] <span class="keyword">for</span> JDBC transaction </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">05</span>:<span class="number">57.812</span> [t1] - Acquired Connection [HikariProxyConnection@<span class="number">1060226540</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@7b50d1a8] <span class="keyword">for</span> JDBC transaction </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">05</span>:<span class="number">57.813</span> [t2] - Switching JDBC Connection [HikariProxyConnection@<span class="number">1235355069</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@8b254bd] to manual commit </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">05</span>:<span class="number">57.813</span> [t1] - Switching JDBC Connection [HikariProxyConnection@<span class="number">1060226540</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@7b50d1a8] to manual commit </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">05</span>:<span class="number">57.826</span> [t1] - ==&gt;  Preparing: select balance from account where accountNo=?  </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">05</span>:<span class="number">57.842</span> [t1] - ==&gt; Parameters: <span class="number">1</span>(Integer) </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">05</span>:<span class="number">57.868</span> [t1] - &lt;==      Total: <span class="number">1</span> </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">05</span>:<span class="number">57.870</span> [t1] - 更新前查询余额为: <span class="number">1000</span> </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">05</span>:<span class="number">57.872</span> [t1] - ==&gt;  Preparing: update account set balance=balance+? where accountNo=?  </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">05</span>:<span class="number">57.872</span> [t1] - ==&gt; Parameters: -<span class="number">1000</span>(Integer), <span class="number">1</span>(Integer) </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">05</span>:<span class="number">57.877</span> [t1] - &lt;==    Updates: <span class="number">1</span> </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">05</span>:<span class="number">57.877</span> [t1] - ==&gt;  Preparing: update account set balance=balance+? where accountNo=?  </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">05</span>:<span class="number">57.878</span> [t1] - ==&gt; Parameters: <span class="number">1000</span>(Integer), <span class="number">2</span>(Integer) </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">05</span>:<span class="number">57.878</span> [t1] - &lt;==    Updates: <span class="number">1</span> </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">05</span>:<span class="number">57.879</span> [t2] - ==&gt;  Preparing: select balance from account where accountNo=?<span class="comment">//t2在提交事务前查询了金额  </span></span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">05</span>:<span class="number">57.879</span> [t1] - Initiating transaction commit </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">05</span>:<span class="number">57.879</span> [t1] - Committing JDBC transaction on Connection <span class="comment">//线程t1提交事务</span></span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">05</span>:<span class="number">57.879</span> [t2] - ==&gt; Parameters: <span class="number">1</span>(Integer) </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">05</span>:<span class="number">57.879</span> [t2] - &lt;==      Total: <span class="number">1</span> </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">05</span>:<span class="number">57.880</span> [t2] - 更新前查询余额为: <span class="number">1000</span> </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">05</span>:<span class="number">57.880</span> [t2] - ==&gt;  Preparing: update account set balance=balance+? where accountNo=?  </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">05</span>:<span class="number">57.880</span> [t2] - ==&gt; Parameters: -<span class="number">1000</span>(Integer), <span class="number">1</span>(Integer) </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">05</span>:<span class="number">57.888</span> [t2] - &lt;==    Updates: <span class="number">1</span> </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">05</span>:<span class="number">57.889</span> [t1] - Releasing JDBC Connection [HikariProxyConnection@<span class="number">1060226540</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@7b50d1a8] after transaction </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">05</span>:<span class="number">57.889</span> [t2] - ==&gt;  Preparing: update account set balance=balance+? where accountNo=?  </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">05</span>:<span class="number">57.889</span> [t2] - ==&gt; Parameters: <span class="number">1000</span>(Integer), <span class="number">2</span>(Integer) </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">05</span>:<span class="number">57.890</span> [t2] - &lt;==    Updates: <span class="number">1</span> </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">05</span>:<span class="number">57.890</span> [t2] - Initiating transaction commit </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">05</span>:<span class="number">57.890</span> [t2] - Committing JDBC transaction on Connection [HikariProxyConnection@<span class="number">1235355069</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@8b254bd] </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">05</span>:<span class="number">57.891</span> [t2] - Releasing JDBC Connection [HikariProxyConnection@<span class="number">1235355069</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@8b254bd] after transaction </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">05</span>:<span class="number">57.892</span> [main] - ==&gt;  Preparing: select balance from account where accountNo=?  </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">05</span>:<span class="number">57.892</span> [main] - ==&gt; Parameters: <span class="number">1</span>(Integer) </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">05</span>:<span class="number">57.893</span> [main] - &lt;==      Total: <span class="number">1</span> </span><br><span class="line">-<span class="number">1000</span></span><br></pre></td></tr></table></figure>



<h3 id="8-Transactional-方法导致的-synchronized-失效"><a href="#8-Transactional-方法导致的-synchronized-失效" class="headerlink" title="8. @Transactional 方法导致的 synchronized 失效"></a>8. @Transactional 方法导致的 synchronized 失效</h3><p>原因: synchronized 保证的仅是目标方法的原子性,环绕目标方法的还有commit等操作,它们并未处于sync块内<br>解法1: synchronized 范围应扩大至代理方法调用<br>解法2:使用 select… for update 替换 select 【从数据库层面上保证select原子性】</p>
<ul>
<li>通过锁住代理类执行方法实现同步</li>
<li>TestService</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> day04.tx.app.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> day04.tx.AppConfig;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.MDC;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationPropertiesBindingPostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.AnnotationConfigUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.GenericApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestService7</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">GenericApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericApplicationContext</span>();</span><br><span class="line">        AnnotationConfigUtils.registerAnnotationConfigProcessors(context.getDefaultListableBeanFactory());</span><br><span class="line">        ConfigurationPropertiesBindingPostProcessor.register(context.getDefaultListableBeanFactory());</span><br><span class="line">        context.registerBean(AppConfig.class);</span><br><span class="line">        context.refresh();</span><br><span class="line"></span><br><span class="line">        <span class="type">Service7</span> <span class="variable">bean</span> <span class="operator">=</span> context.getBean(Service7.class);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">        <span class="comment">//锁</span></span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">MyThread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                bean.transfer(<span class="number">1</span>, <span class="number">2</span>, <span class="number">1000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            latch.countDown();</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>, <span class="string">&quot;boldMagenta&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">MyThread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                bean.transfer(<span class="number">1</span>, <span class="number">2</span>, <span class="number">1000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            latch.countDown();</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>, <span class="string">&quot;boldBlue&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//等到t1、t2都执行完毕才会继续执行</span></span><br><span class="line">        latch.await();</span><br><span class="line">        System.out.println(bean.findBalance(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> String color;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">MyThread</span><span class="params">(Runnable target, String name, String color)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>(target, name);</span><br><span class="line">            <span class="built_in">this</span>.color = color;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            MDC.put(<span class="string">&quot;thread&quot;</span>, color);</span><br><span class="line">            <span class="built_in">super</span>.run();</span><br><span class="line">            MDC.remove(<span class="string">&quot;thread&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>Service</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> day04.tx.app.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> day04.tx.app.mapper.AccountMapper;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Service7</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(Service7.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountMapper accountMapper;</span><br><span class="line">    <span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(<span class="type">int</span> from, <span class="type">int</span> to, <span class="type">int</span> amount)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">fromBalance</span> <span class="operator">=</span> accountMapper.findBalanceBy(from);</span><br><span class="line">        logger.debug(<span class="string">&quot;更新前查询余额为: &#123;&#125;&quot;</span>, fromBalance);</span><br><span class="line">        <span class="keyword">if</span> (fromBalance - amount &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            accountMapper.update(from, -<span class="number">1</span> * amount);</span><br><span class="line">            accountMapper.update(to, amount);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">findBalance</span><span class="params">(<span class="type">int</span> accountNo)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> accountMapper.findBalanceBy(accountNo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>结果</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[INFO] <span class="number">20</span>:<span class="number">32</span>:<span class="number">57.676</span> [main] - HikariPool-<span class="number">1</span> - Starting... </span><br><span class="line">[INFO] <span class="number">20</span>:<span class="number">32</span>:<span class="number">57.795</span> [main] - HikariPool-<span class="number">1</span> - Start completed. </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">32</span>:<span class="number">57.969</span> [t1] - Creating <span class="keyword">new</span> <span class="title class_">transaction</span> with name [day04.tx.app.service.Service7.transfer]: PROPAGATION_REQUIRED,ISOLATION_DEFAULT,-java.lang.Exception </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">32</span>:<span class="number">57.970</span> [t1] - Acquired Connection [HikariProxyConnection@<span class="number">1175084298</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@163dca8c] <span class="keyword">for</span> JDBC transaction </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">32</span>:<span class="number">57.971</span> [t1] - Switching JDBC Connection [HikariProxyConnection@<span class="number">1175084298</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@163dca8c] to manual commit </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">32</span>:<span class="number">57.984</span> [t1] - ==&gt;  Preparing: select balance from account where accountNo=?  </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">32</span>:<span class="number">58.000</span> [t1] - ==&gt; Parameters: <span class="number">1</span>(Integer) </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">32</span>:<span class="number">58.021</span> [t1] - &lt;==      Total: <span class="number">1</span> </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">32</span>:<span class="number">58.024</span> [t1] - 更新前查询余额为: <span class="number">1000</span> </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">32</span>:<span class="number">58.025</span> [t1] - ==&gt;  Preparing: update account set balance=balance+? where accountNo=?  </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">32</span>:<span class="number">58.025</span> [t1] - ==&gt; Parameters: -<span class="number">1000</span>(Integer), <span class="number">1</span>(Integer) </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">32</span>:<span class="number">58.029</span> [t1] - &lt;==    Updates: <span class="number">1</span> </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">32</span>:<span class="number">58.029</span> [t1] - ==&gt;  Preparing: update account set balance=balance+? where accountNo=?  </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">32</span>:<span class="number">58.029</span> [t1] - ==&gt; Parameters: <span class="number">1000</span>(Integer), <span class="number">2</span>(Integer) </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">32</span>:<span class="number">58.030</span> [t1] - &lt;==    Updates: <span class="number">1</span> </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">32</span>:<span class="number">58.030</span> [t1] - Initiating transaction commit </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">32</span>:<span class="number">58.031</span> [t1] - Committing JDBC transaction on Connection [HikariProxyConnection@<span class="number">1175084298</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@163dca8c] </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">32</span>:<span class="number">58.034</span> [t1] - Releasing JDBC Connection [HikariProxyConnection@<span class="number">1175084298</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@163dca8c] after transaction </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">32</span>:<span class="number">58.034</span> [t2] - Creating <span class="keyword">new</span> <span class="title class_">transaction</span> with name [day04.tx.app.service.Service7.transfer]: PROPAGATION_REQUIRED,ISOLATION_DEFAULT,-java.lang.Exception </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">32</span>:<span class="number">58.035</span> [t2] - Acquired Connection [HikariProxyConnection@<span class="number">1907265306</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@163dca8c] <span class="keyword">for</span> JDBC transaction </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">32</span>:<span class="number">58.035</span> [t2] - Switching JDBC Connection [HikariProxyConnection@<span class="number">1907265306</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@163dca8c] to manual commit </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">32</span>:<span class="number">58.036</span> [t2] - ==&gt;  Preparing: select balance from account where accountNo=?  </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">32</span>:<span class="number">58.036</span> [t2] - ==&gt; Parameters: <span class="number">1</span>(Integer) </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">32</span>:<span class="number">58.037</span> [t2] - &lt;==      Total: <span class="number">1</span> </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">32</span>:<span class="number">58.037</span> [t2] - 更新前查询余额为: <span class="number">0</span> </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">32</span>:<span class="number">58.037</span> [t2] - Initiating transaction commit </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">32</span>:<span class="number">58.037</span> [t2] - Committing JDBC transaction on Connection [HikariProxyConnection@<span class="number">1907265306</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@163dca8c] </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">32</span>:<span class="number">58.038</span> [t2] - Releasing JDBC Connection [HikariProxyConnection@<span class="number">1907265306</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@163dca8c] after transaction </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">32</span>:<span class="number">58.038</span> [main] - ==&gt;  Preparing: select balance from account where accountNo=?  </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">32</span>:<span class="number">58.039</span> [main] - ==&gt; Parameters: <span class="number">1</span>(Integer) </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">32</span>:<span class="number">58.039</span> [main] - &lt;==      Total: <span class="number">1</span> </span><br><span class="line"><span class="number">0</span></span><br></pre></td></tr></table></figure>



<ul>
<li>for update</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[INFO] <span class="number">20</span>:<span class="number">40</span>:<span class="number">53.572</span> [main] - HikariPool-<span class="number">1</span> - Starting... </span><br><span class="line">[INFO] <span class="number">20</span>:<span class="number">40</span>:<span class="number">53.704</span> [main] - HikariPool-<span class="number">1</span> - Start completed. </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">40</span>:<span class="number">53.801</span> [t2] - Creating <span class="keyword">new</span> <span class="title class_">transaction</span> with name [day04.tx.app.service.Service7.transfer]: PROPAGATION_REQUIRED,ISOLATION_DEFAULT,-java.lang.Exception </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">40</span>:<span class="number">53.801</span> [t1] - Creating <span class="keyword">new</span> <span class="title class_">transaction</span> with name [day04.tx.app.service.Service7.transfer]: PROPAGATION_REQUIRED,ISOLATION_DEFAULT,-java.lang.Exception </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">40</span>:<span class="number">53.802</span> [t2] - Acquired Connection [HikariProxyConnection@<span class="number">1091314678</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@50793d3a] <span class="keyword">for</span> JDBC transaction </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">40</span>:<span class="number">53.804</span> [t2] - Switching JDBC Connection [HikariProxyConnection@<span class="number">1091314678</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@50793d3a] to manual commit </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">40</span>:<span class="number">53.810</span> [t1] - Acquired Connection [HikariProxyConnection@<span class="number">1667859057</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@69130d63] <span class="keyword">for</span> JDBC transaction </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">40</span>:<span class="number">53.810</span> [t1] - Switching JDBC Connection [HikariProxyConnection@<span class="number">1667859057</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@69130d63] to manual commit </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">40</span>:<span class="number">53.818</span> [t1] - ==&gt;  Preparing: select balance from account where accountNo=? <span class="keyword">for</span> update  </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">40</span>:<span class="number">53.818</span> [t2] - ==&gt;  Preparing: select balance from account where accountNo=? <span class="keyword">for</span> update  <span class="comment">//只要t1的事务没有提交t2的select语句就会阻塞，等待t1事务结束</span></span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">40</span>:<span class="number">53.835</span> [t1] - ==&gt; Parameters: <span class="number">1</span>(Integer) </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">40</span>:<span class="number">53.835</span> [t2] - ==&gt; Parameters: <span class="number">1</span>(Integer) </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">40</span>:<span class="number">53.857</span> [t2] - &lt;==      Total: <span class="number">1</span> </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">40</span>:<span class="number">53.861</span> [t2] - 更新前查询余额为: <span class="number">1000</span> </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">40</span>:<span class="number">53.862</span> [t2] - ==&gt;  Preparing: update account set balance=balance+? where accountNo=?  </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">40</span>:<span class="number">53.862</span> [t2] - ==&gt; Parameters: -<span class="number">1000</span>(Integer), <span class="number">1</span>(Integer) </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">40</span>:<span class="number">53.863</span> [t2] - &lt;==    Updates: <span class="number">1</span> </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">40</span>:<span class="number">53.864</span> [t2] - ==&gt;  Preparing: update account set balance=balance+? where accountNo=?  </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">40</span>:<span class="number">53.864</span> [t2] - ==&gt; Parameters: <span class="number">1000</span>(Integer), <span class="number">2</span>(Integer) </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">40</span>:<span class="number">53.864</span> [t2] - &lt;==    Updates: <span class="number">1</span> </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">40</span>:<span class="number">53.865</span> [t2] - Initiating transaction commit </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">40</span>:<span class="number">53.865</span> [t2] - Committing JDBC transaction on Connection [HikariProxyConnection@<span class="number">1091314678</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@50793d3a] </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">40</span>:<span class="number">53.881</span> [t2] - Releasing JDBC Connection [HikariProxyConnection@<span class="number">1091314678</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@50793d3a] after transaction </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">40</span>:<span class="number">53.881</span> [t1] - &lt;==      Total: <span class="number">1</span> </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">40</span>:<span class="number">53.882</span> [t1] - 更新前查询余额为: <span class="number">0</span> </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">40</span>:<span class="number">53.882</span> [t1] - Initiating transaction commit </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">40</span>:<span class="number">53.882</span> [t1] - Committing JDBC transaction on Connection [HikariProxyConnection@<span class="number">1667859057</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@69130d63] </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">40</span>:<span class="number">53.882</span> [t1] - Releasing JDBC Connection [HikariProxyConnection@<span class="number">1667859057</span> wrapping com.mysql.cj.jdbc.ConnectionImpl@69130d63] after transaction </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">40</span>:<span class="number">53.882</span> [main] - ==&gt;  Preparing: select balance from account where accountNo=? <span class="keyword">for</span> update  </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">40</span>:<span class="number">53.883</span> [main] - ==&gt; Parameters: <span class="number">1</span>(Integer) </span><br><span class="line">[DEBUG] <span class="number">20</span>:<span class="number">40</span>:<span class="number">53.884</span> [main] - &lt;==      Total: <span class="number">1</span> </span><br><span class="line"><span class="number">0</span></span><br></pre></td></tr></table></figure>



<h2 id="SpringMvc的执行流程"><a href="#SpringMvc的执行流程" class="headerlink" title="SpringMvc的执行流程"></a>SpringMvc的执行流程</h2><h3 id="初始化阶段"><a href="#初始化阶段" class="headerlink" title="初始化阶段"></a>初始化阶段</h3><ol>
<li>在Web容器第一次用到DispatcherServlet 的时候,会创建其对象【由WEB容器进行创建的或在SpringBoot中就有可能由spring容器创建】并执行init方法</li>
<li>init 方法内会更具spring配置文件，创建Spring Web容器,并调用容器refresh方法，初始化Spring容器</li>
<li>refresh 过程中会创建并初始化SpringMVC中的重要组件,例如MultipartResolver, HandlerMapping,HandlerAdapter, HandlerExceptionResolver,ViewResolver 等</li>
<li>容器初始化后,会将上一步初始化好的重要组件,赋值给DispatcherServlet 的成员变量,留待后用</li>
</ol>
<p>​		HandlerMapping:根据请求路径找到对应的控制器，把一个请求映射到控制器的一个方法调用上<br>​		HandlerAdapter：由该类的对象执行控制器中的方法<br>​		HandlerExceptionResolver：当执行控制器中的方法发生异常时，是由该类的对象<br>​		ViewResolver：负责将名字解析成视图对象，视图对象会根据实现，跳转到jsp或模板引擎，进行视图渲染<br>​		例如MultipartResolver：用于处理文件上传时，处理Multipart格式的表单</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-04-01_20-53-03.png"></p>
<hr>
<h3 id="匹配阶段"><a href="#匹配阶段" class="headerlink" title="匹配阶段:"></a>匹配阶段:</h3><ol>
<li>用户发送的请求统一到达前端控制器DispatcherServlet【作为一个多请求的入口，不负责处理具体请求】<br>2.DispatcherServlet 遍历所有的 HandlerMapping ,找到与路径匹配的处理器【有处理器对象处理请求】<ul>
<li>HandlerMapping 有多,每HandlerMapping会返回不同的处理器对象【有不同实现】,谁先匹配,返回谁的处理器【一个请求由一个处理器处理】。其中能识别@RequestMapping的优先级最高</li>
<li>对应 @RequestMapping的处理器对象是HandlerMethod,它包含了控制器对象和控制器方法信息，即它可以知道哪个控制器的哪个方法调用的它</li>
<li>其中路径与处理器的映射关系在HandlerMapping初始化时就会建立好</li>
</ul>
</li>
<li>将HandlerMethod 连同匹配到的拦截器,生成调用链对象HandlerExecutionChain 返回【通过路径匹配找到一个处理器链，包含有处理器和拦截器s】<br>4.遍历HandlerAdapter处理器适配器,找到能处理HandlerMethod 的适配器对象【不同的适配器所支持的处理器不一样】,开始调用 【处理器是通过适配器进行调用的】</li>
</ol>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-04-01_21-30-27.png"></p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823214405224.png"></p>
<hr>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-04-01_21-40-40.png"></p>
<hr>
<h3 id="执行阶段"><a href="#执行阶段" class="headerlink" title="执行阶段"></a>执行阶段</h3><hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-04-01_23-19-04.png"></p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-04-01_23-19-53.png"></p>
<hr>
<p>在匹配阶段，准备好了HandlerExecutionChain对象【包含了多个拦截器对象和处理器】，以及执行处理器的适配器</p>
<ol>
<li><p>执行拦截器 preHandle 【由外到内依次执行拦截器，当返回值为true就会放行，执行后续调用，否则就会被拦截器拦截下来】</p>
</li>
<li><p>由HandlerAdapter 用 HandlerMethod</p>
<ul>
<li>调用前处理不同类型的参数【通过反射调用某个类的某个方法 】</li>
<li>调用后处理不同类型的返回值【看有无@ResponseBody，有转会成json形式的数据，并标记ModelAndView 已处理，不会进行视图渲染，直接返回json】</li>
</ul>
</li>
<li><p>第2步没有异常</p>
<ul>
<li>封装成ModelAndView，并返回【包含模型数据和视图相关信息】</li>
<li>执行拦截器 postHandle方法【由内到外调用】</li>
<li>解析视图,得到View对象,进行视图宣染【模型数据根据视图的实现不同，会存储到不同的位置，比如视图使用jsp实现的，那么就会将模型数据取出放到request作用域，视图从作用域中取出模型数据，渲染生成一个html返回】</li>
</ul>
</li>
<li><p>第2步有异常,进入HandlerExceptionResolver异常处理流程</p>
</li>
<li><p>最后都会执行拦截器的afterCompletion方法【由内到外逐一调用】</p>
</li>
<li><p>如果控制器方法标注了@ResponseBody注解,则在第2步,就会生成json结果,并标记ModelAndView 已处理,这样就不会执行第3步的视图宣染</p>
</li>
</ol>
<h2 id="Spirng注解大全"><a href="#Spirng注解大全" class="headerlink" title="Spirng注解大全"></a>Spirng注解大全</h2><h3 id="Configuration"><a href="#Configuration" class="headerlink" title="@Configuration"></a>@Configuration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> day04.boot;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.mapper.MapperScannerConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.AnnotationConfigUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.GenericApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestConfiguration</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//一个简单的spring容器的实现</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * ApplicationContext（spring容器）内部包含了一个重要的成员变量beanFactory</span></span><br><span class="line"><span class="comment">         * beanFactory中有一个重要的集合beanDefinitionMap存储用来创建bean的一切信息，键是bean的名字</span></span><br><span class="line"><span class="comment">         * 当没有添加beanFactory后处理器，则不能识别@Configuration注解，以及@Bean注解【只有myConfig这一个手动添加的hean】</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        <span class="type">GenericApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericApplicationContext</span>();</span><br><span class="line">        <span class="comment">//使用spring提供的一个工具类，将spring日程工作所需要bean后处理器以及beanFactory后处理器注册到容器中</span></span><br><span class="line">        <span class="comment">//@internalConfigurationAnnotationProcessor这是加载进容器的一个beanFactory后处理器</span></span><br><span class="line">        AnnotationConfigUtils.registerAnnotationConfigProcessors(context.getDefaultListableBeanFactory());</span><br><span class="line">        context.registerBean(<span class="string">&quot;myConfig&quot;</span>, MyConfig.class);</span><br><span class="line">        context.refresh();</span><br><span class="line">        System.out.println();</span><br><span class="line">        <span class="comment">//class day04.boot.TestConfiguration$MyConfig$$EnhancerBySpringCGLIB$$ecbe59a9已经被CGLIB增强了</span></span><br><span class="line">        <span class="comment">//System.out.println(context.getBean(MyConfig.class).getClass());</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注意点3: @Configuration 默认会为标注的类生成代理, 其目的是保证 @Bean 方法相互调用时, 仍然能保证其单例特性【所以说不互相调用有@Bean注解的方法，可以省略@Configration 不规范】</span></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="comment">//不会生成代理对象 为真就</span></span><br><span class="line">    <span class="comment">//@Configuration(proxyBeanMethods = false)</span></span><br><span class="line">    <span class="comment">//@MapperScan(&quot;aaa&quot;)</span></span><br><span class="line">    <span class="comment">// 注意点1: 配置类其实相当于一个工厂【bean】, 标注 @Bean 注解的方法相当于工厂方法</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * factoryBeanName = &quot;myConfig&quot;</span></span><br><span class="line"><span class="comment">     * factoryMethodName = &quot;bean1&quot;【实例工厂方法，先要有工厂对象，才会有工厂方法】</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyConfig</span> &#123;</span><br><span class="line">        <span class="comment">// 注意点2: @Bean 不支持方法重载, 如果有多个重载方法, 仅有一个能入选为工厂方法【入参的个数越多，优先级越高】</span></span><br><span class="line"><span class="comment">/*        @Bean</span></span><br><span class="line"><span class="comment">        public Bean1 bean1(Bean2 bean2) &#123;</span></span><br><span class="line"><span class="comment">            //当bean2作为入参时，所得到的bean2都是同一个对象</span></span><br><span class="line"><span class="comment">            System.out.println(&quot;bean1()&quot;);</span></span><br><span class="line"><span class="comment">            System.out.println(bean2);</span></span><br><span class="line"><span class="comment">            System.out.println(bean2);</span></span><br><span class="line"><span class="comment">            System.out.println(bean2);</span></span><br><span class="line"><span class="comment">            System.out.println(&quot;================&quot;);</span></span><br><span class="line"><span class="comment">            //但是当没有@Configuration注解，使用调用方法获取bean时，调用多少次方法就创建多少个单例</span></span><br><span class="line"><span class="comment">            //@Configuration标注的类，会在运行的时候为其生成一个代理对象；代理对象会先检查是否有该bean没有就创建，有就直接从容器中拿，就不会有多个单例的情况</span></span><br><span class="line"><span class="comment">            System.out.println(bean2());</span></span><br><span class="line"><span class="comment">            System.out.println(bean2());</span></span><br><span class="line"><span class="comment">            System.out.println(bean2());</span></span><br><span class="line"><span class="comment">            return new Bean1();</span></span><br><span class="line"><span class="comment">        &#125;*/</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*@Bean</span></span><br><span class="line"><span class="comment">        public Bean1 bean1(@Value(&quot;$&#123;java.class.version&#125;&quot;) String a) &#123;</span></span><br><span class="line"><span class="comment">            System.out.println(&quot;bean1(&quot; + a + &quot;)&quot;);</span></span><br><span class="line"><span class="comment">            return new Bean1();</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        @Bean</span></span><br><span class="line"><span class="comment">        public Bean1 bean1(@Value(&quot;$&#123;java.class.version&#125;&quot;) String a, @Value(&quot;$&#123;JAVA_HOME&#125;&quot;) String b) &#123;</span></span><br><span class="line"><span class="comment">            System.out.println(&quot;bean1(&quot; + a + &quot;, &quot; + b + &quot;)&quot;);</span></span><br><span class="line"><span class="comment">            return new Bean1();</span></span><br><span class="line"><span class="comment">        &#125;*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*        @Bean</span></span><br><span class="line"><span class="comment">        public Bean2 bean2() &#123;</span></span><br><span class="line"><span class="comment">            System.out.println(&quot;bean2()&quot;);</span></span><br><span class="line"><span class="comment">            return new Bean2();</span></span><br><span class="line"><span class="comment">        &#125;*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注意点4: @Configuration 中如果含有 BeanFactory 后处理器, 则实例工厂方法会导致 MyConfig 提前创建, 造成其依赖注入失败</span></span><br><span class="line">        <span class="comment">// 解决方法是该用静态工厂方法或直接为 @Bean 的方法参数依赖注入, 针对 MapperScanner 可以改用注解方式</span></span><br><span class="line">        <span class="meta">@Value(&quot;$&#123;java.class.version&#125;&quot;)</span></span><br><span class="line">        <span class="keyword">private</span> String version;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * MapperScannerConfigurer 实际上是 BeanFactoryPostProcessor bean工厂的后处理器</span></span><br><span class="line"><span class="comment">         * 又因为初始化容器的第五步是，创建 bean工厂的后处理器来实现对beanFactory的增强；这里的bean后处理器是一个实例方法，需要现有配置类对象</span></span><br><span class="line"><span class="comment">         * 此时各种bean后处理器【各种bean包括配置类对象，都是在11步创建的】还没有创建出来，@Value注解就没有人来解析就不能读取到信息</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 解决方法一:把获取beanFactory后处理器的方法改为静态方法，这样配置类对象就不会提前初始化【推荐】</span></span><br><span class="line"><span class="comment">         * 解决方法二:把需要设值注入的成员变量改为方法参数</span></span><br><span class="line"><span class="comment">         * 解决方法三:仅针对 MapperScannerConfigurer 在配置类上添加@MapperScan(&quot;aaa&quot;) 这样不会导致配置类对象提前创建</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> MapperScannerConfigurer <span class="title function_">configurer</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">MapperScannerConfigurer</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MapperScannerConfigurer</span>();</span><br><span class="line">            scanner.setBasePackage(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> scanner;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="keyword">public</span> Bean3 <span class="title function_">bean3</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;bean3() &quot;</span> + version);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Bean3</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Bean1</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Bean2</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Bean3</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="Import"><a href="#Import" class="headerlink" title="@Import"></a>@Import</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> day04.boot;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.support.DefaultListableBeanFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.GenericApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.type.AnnotationMetadata;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestDeferredImport</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">GenericApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericApplicationContext</span>();</span><br><span class="line">        <span class="type">DefaultListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> context.getDefaultListableBeanFactory();</span><br><span class="line">        beanFactory.setAllowBeanDefinitionOverriding(<span class="literal">false</span>); <span class="comment">// 不允许同名定义覆盖【默认可以】</span></span><br><span class="line">        AnnotationConfigUtils.registerAnnotationConfigProcessors(beanFactory);</span><br><span class="line">        context.registerBean(MyConfig.class);</span><br><span class="line">        context.refresh();</span><br><span class="line"></span><br><span class="line">        System.out.println(context.getBean(MyBean.class));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. 同一配置类中, @Import 先解析  @Bean 后解析</span></span><br><span class="line">    <span class="comment">// 2. 同名定义, 默认后面解析的会覆盖前面解析的【看到的是配置类中同名方法的实现】</span></span><br><span class="line">    <span class="comment">// 3. 不允许覆盖的情况下, 如何能够让 MyConfig(主配置类) 的配置优先? (虽然覆盖方式能解决)</span></span><br><span class="line">    <span class="comment">// 4. DeferredImportSelector 最后工作, 可以简单认为先解析 @Bean, 再 Import</span></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="comment">//将选择器中想要配置的bean放到比配置类要后的时机经行装配【只有当主配置没有配置的，才使用从属配置】</span></span><br><span class="line">    <span class="meta">@Import(MySelector.class)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyConfig</span> &#123; <span class="comment">// 主配置 - 程序员编写的</span></span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="keyword">public</span> MyBean <span class="title function_">myBean</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Bean1</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MySelector</span> <span class="keyword">implements</span> <span class="title class_">DeferredImportSelector</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;OtherConfig.class.getName()&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">OtherConfig</span> &#123; <span class="comment">// 从属配置 - 自动配置</span></span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="comment">//没有同名的myBean时才会创建</span></span><br><span class="line">        <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">        <span class="keyword">public</span> MyBean <span class="title function_">myBean</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Bean2</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">interface</span> <span class="title class_">MyBean</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Bean1</span> <span class="keyword">implements</span> <span class="title class_">MyBean</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Bean2</span> <span class="keyword">implements</span> <span class="title class_">MyBean</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="SpirngBoot自动装配原理"><a href="#SpirngBoot自动装配原理" class="headerlink" title="SpirngBoot自动装配原理"></a>SpirngBoot自动装配原理</h2><h3 id="SpringBootApplication"><a href="#SpringBootApplication" class="headerlink" title="@SpringBootApplication"></a>@SpringBootApplication</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootConfiguration</span><span class="meta">@ComponentScan</span>.excludeFilters -用来在组件扫描时进行排除,也会排除自动配置类<span class="meta">@EnableAutoConfiguration</span><span class="meta">@AutoConflgurationPackage</span> - 用来记住扫描的起始包.<span class="meta">@lmport(AutoConfigurationlmportSelector.class)</span> 用来加载 META-INF/spring.factories 中的自动配置类</span><br></pre></td></tr></table></figure>





<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootConfiguration</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@ComponentScan(excludeFilters = &#123;@Filter(type = FilterType.CUSTOM,classes = &#123;TypeExcludeFilter.class&#125;)</span></span><br><span class="line"><span class="meta">                                 , @Filter(type = FilterType.CUSTOM,classes = &#123;AutoConfigurationExcludeFilter.class&#125;)&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpringBootApplication </span><br></pre></td></tr></table></figure>



<h3 id="SpringBootConfiguration"><a href="#SpringBootConfiguration" class="headerlink" title="@SpringBootConfiguration"></a>@SpringBootConfiguration</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">@Indexed</span><br><span class="line">public @interface SpringBootConfiguration &#123;&#125;</span><br><span class="line"></span><br><span class="line">区别：</span><br><span class="line">@Configuration标注的配置类在整个应用程序中可以有多个；但@SpringBootConfigration在整个应用程序中只有一个</span><br><span class="line">根据这个唯一的配置类来判断主配置类</span><br></pre></td></tr></table></figure>



<h3 id="ComponentScan"><a href="#ComponentScan" class="headerlink" title="@ComponentScan"></a>@ComponentScan</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">可以扫描 有<span class="meta">@Component</span>、<span class="meta">@Configuration</span>、<span class="meta">@Service</span>、<span class="meta">@Controller</span>、<span class="meta">@Repository</span></span><br><span class="line"><span class="meta">@ComponentScan(excludeFilters = &#123;</span></span><br><span class="line"><span class="meta">//实现该接口（TypeExcludeFilter）的类，可以定义 排除一些能被扫描到的类，但又不希望这个类被装配到spring容器中的 规则</span></span><br><span class="line"><span class="meta">@Filter(type = FilterType.CUSTOM,classes = &#123;TypeExcludeFilter.class),</span></span><br><span class="line"><span class="meta">//将SpringBoot自带的一些自动配置类排除，这些类不是通过组件扫描的方式加载到容器中的，而是通过@EnableAutoConfiguraion的@Import装配到spring容器中的                                     </span></span><br><span class="line"><span class="meta">@Filter(type = FilterType.CUSTOM,classes = &#123;AutoConfigurationExcludeFilter.class)</span></span><br><span class="line"><span class="meta">&#125;</span></span><br></pre></td></tr></table></figure>



<h3 id="EnableAutoConfiguration"><a href="#EnableAutoConfiguration" class="headerlink" title="@EnableAutoConfiguration"></a>@EnableAutoConfiguration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//记录它所标注的类所在的包 【System.out.println(AutoConfigurationPackages.get(context.getDefaultListableBeanFactory()));】</span></span><br><span class="line"><span class="meta">@AutoConfigurationPackage</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">1.使主配置与从属配置解耦，不会通过主配置直接引用从属配置的类名，而是通过ImportSelector读取配置文件【classpath:META-INF/spring.factories</span></span><br><span class="line"><span class="comment">键是固定的 值可以有多个用逗号隔开 org.springframework.boot.autoconfigure.EnableAutoConfiguration=day04.boot.TestAutoConfiguration$OtherConfig</span></span><br><span class="line"><span class="comment">】中配置的默认配置类的类名，ImportSelector对象在工作时还会将SpringBoot自动配置的类都加载进容器中【通过配置文件添加类名的从属类是自己编写的类】</span></span><br><span class="line"><span class="comment">2.使得从属配置类的加载优先级最低 ，当主配置包含有与从属配置相同名字的bean时，优先使用主配置的，从属配置只作为默认实现</span></span><br><span class="line"><span class="comment">public class AutoConfigurationImportSelector implements DeferredImportSelector&#123;&#125;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">@Import(&#123;AutoConfigurationImportSelector.class&#125;)</span></span><br><span class="line"><span class="comment">public @interface EnableAutoConfiguration &#123;&#125;</span></span><br></pre></td></tr></table></figure>





<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> day04.boot;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.EnableAutoConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.AnnotationConfigUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.GenericApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">GenericApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericApplicationContext</span>();</span><br><span class="line">        AnnotationConfigUtils.registerAnnotationConfigProcessors(context.getDefaultListableBeanFactory());</span><br><span class="line"><span class="comment">//        context.getEnvironment().getPropertySources().addLast(new ResourcePropertySource(&quot;application.properties&quot;));</span></span><br><span class="line">        context.registerBean(MyConfig.class);</span><br><span class="line">        context.refresh();</span><br><span class="line"></span><br><span class="line"><span class="comment">//        System.out.println(AutoConfigurationPackages.get(context.getDefaultListableBeanFactory()));</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (String name : context.getBeanDefinitionNames()) &#123;</span><br><span class="line">            System.out.println(name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//        System.out.println(SpringFactoriesLoader.loadFactoryNames(EnableAutoConfiguration.class, EnableAutoConfiguration.class.getClassLoader()).stream()</span></span><br><span class="line"><span class="comment">//                .filter(name -&gt; !name.equals(OtherConfig.class.getName())).map(name -&gt; &quot;\&quot;&quot; + name + &quot;\&quot;&quot;).collect(Collectors.joining(&quot;,&quot;,&quot;&#123;&quot;,&quot;&#125;&quot;)));</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//    @AutoConfigurationPackage</span></span><br><span class="line">    <span class="meta">@EnableAutoConfiguration(excludeName = &#123;&quot;org.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.aop.AopAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.amqp.RabbitAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.batch.BatchAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.cache.CacheAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.cassandra.CassandraAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.context.ConfigurationPropertiesAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.context.LifecycleAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.context.MessageSourceAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.context.PropertyPlaceholderAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.couchbase.CouchbaseAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.dao.PersistenceExceptionTranslationAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.data.cassandra.CassandraDataAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.data.cassandra.CassandraReactiveDataAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.data.cassandra.CassandraReactiveRepositoriesAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.data.cassandra.CassandraRepositoriesAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.data.couchbase.CouchbaseDataAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.data.couchbase.CouchbaseReactiveDataAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.data.couchbase.CouchbaseReactiveRepositoriesAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.data.couchbase.CouchbaseRepositoriesAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.data.elasticsearch.ElasticsearchDataAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.data.elasticsearch.ElasticsearchRepositoriesAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.data.elasticsearch.ReactiveElasticsearchRepositoriesAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.data.elasticsearch.ReactiveElasticsearchRestClientAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.data.jdbc.JdbcRepositoriesAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.data.jpa.JpaRepositoriesAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.data.ldap.LdapRepositoriesAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.data.mongo.MongoDataAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.data.mongo.MongoReactiveDataAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.data.mongo.MongoReactiveRepositoriesAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.data.mongo.MongoRepositoriesAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.data.neo4j.Neo4jDataAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.data.neo4j.Neo4jReactiveDataAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.data.neo4j.Neo4jReactiveRepositoriesAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.data.neo4j.Neo4jRepositoriesAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.data.r2dbc.R2dbcDataAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.data.r2dbc.R2dbcRepositoriesAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.data.redis.RedisAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.data.redis.RedisReactiveAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.data.redis.RedisRepositoriesAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.data.rest.RepositoryRestMvcAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.data.web.SpringDataWebAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.elasticsearch.ElasticsearchRestClientAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.flyway.FlywayAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.freemarker.FreeMarkerAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.groovy.template.GroovyTemplateAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.gson.GsonAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.h2.H2ConsoleAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.hateoas.HypermediaAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.hazelcast.HazelcastAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.hazelcast.HazelcastJpaDependencyAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.http.HttpMessageConvertersAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.http.codec.CodecsAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.influx.InfluxDbAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.info.ProjectInfoAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.integration.IntegrationAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.jackson.JacksonAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.jdbc.JdbcTemplateAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.jdbc.JndiDataSourceAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.jdbc.XADataSourceAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.jdbc.DataSourceTransactionManagerAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.jms.JmsAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.jmx.JmxAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.jms.JndiConnectionFactoryAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.jms.activemq.ActiveMQAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.jms.artemis.ArtemisAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.jersey.JerseyAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.jooq.JooqAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.jsonb.JsonbAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.kafka.KafkaAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.availability.ApplicationAvailabilityAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.ldap.embedded.EmbeddedLdapAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.ldap.LdapAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.liquibase.LiquibaseAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.mail.MailSenderAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.mail.MailSenderValidatorAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.mongo.embedded.EmbeddedMongoAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.mongo.MongoAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.mongo.MongoReactiveAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.mustache.MustacheAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.neo4j.Neo4jAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.netty.NettyAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.orm.jpa.HibernateJpaAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.quartz.QuartzAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.r2dbc.R2dbcAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.r2dbc.R2dbcTransactionManagerAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.rsocket.RSocketMessagingAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.rsocket.RSocketRequesterAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.rsocket.RSocketServerAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.rsocket.RSocketStrategiesAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.security.servlet.SecurityAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.security.servlet.UserDetailsServiceAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.security.servlet.SecurityFilterAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.security.reactive.ReactiveSecurityAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.security.reactive.ReactiveUserDetailsServiceAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.security.rsocket.RSocketSecurityAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.security.saml2.Saml2RelyingPartyAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.sendgrid.SendGridAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.session.SessionAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.security.oauth2.client.servlet.OAuth2ClientAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.security.oauth2.client.reactive.ReactiveOAuth2ClientAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.security.oauth2.resource.servlet.OAuth2ResourceServerAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.security.oauth2.resource.reactive.ReactiveOAuth2ResourceServerAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.solr.SolrAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.sql.init.SqlInitializationAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.task.TaskExecutionAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.task.TaskSchedulingAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.thymeleaf.ThymeleafAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.transaction.TransactionAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.transaction.jta.JtaAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.validation.ValidationAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.web.client.RestTemplateAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.web.embedded.EmbeddedWebServerFactoryCustomizerAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.web.reactive.HttpHandlerAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.web.reactive.ReactiveWebServerFactoryAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.web.reactive.WebFluxAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.web.reactive.error.ErrorWebFluxAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.web.reactive.function.client.ClientHttpConnectorAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.web.reactive.function.client.WebClientAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.web.servlet.DispatcherServletAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.web.servlet.ServletWebServerFactoryAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.web.servlet.error.ErrorMvcAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.web.servlet.HttpEncodingAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.web.servlet.MultipartAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.web.servlet.WebMvcAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.websocket.reactive.WebSocketReactiveAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.websocket.servlet.WebSocketServletAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.websocket.servlet.WebSocketMessagingAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.webservices.WebServicesAutoConfiguration&quot;, &quot;org.springframework.boot.autoconfigure.webservices.client.WebServiceTemplateAutoConfiguration&quot;, &quot;org.mybatis.spring.boot.autoconfigure.MybatisLanguageDriverAutoConfiguration&quot;, &quot;org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration&quot;&#125;)</span></span><br><span class="line"><span class="comment">//    @Import(OtherConfig.class)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyConfig</span> &#123; <span class="comment">// 主配置</span></span><br><span class="line"><span class="comment">/*        @Bean</span></span><br><span class="line"><span class="comment">        public Bean1 bean1() &#123;</span></span><br><span class="line"><span class="comment">            System.out.println(&quot;MyConfig bean1()&quot;);</span></span><br><span class="line"><span class="comment">            return new Bean1();</span></span><br><span class="line"><span class="comment">        &#125;*/</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">OtherConfig</span> &#123; <span class="comment">// 从属配置(自动配置、默认配置)</span></span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">        <span class="keyword">public</span> Bean1 <span class="title function_">bean1</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;OtherConfig bean1()&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Bean1</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="keyword">public</span> Bean2 <span class="title function_">bean2</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Bean2</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Bean1</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Bean2</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">================================</span><br><span class="line">OtherConfig <span class="title function_">bean1</span><span class="params">()</span></span><br><span class="line">org.springframework.context.annotation.internalConfigurationAnnotationProcessor</span><br><span class="line">org.springframework.context.annotation.internalAutowiredAnnotationProcessor</span><br><span class="line">org.springframework.context.annotation.internalCommonAnnotationProcessor</span><br><span class="line">org.springframework.context.event.internalEventListenerProcessor</span><br><span class="line">org.springframework.context.event.internalEventListenerFactory</span><br><span class="line">day04.boot.TestAutoConfiguration$MyConfig</span><br><span class="line">org.springframework.boot.autoconfigure.AutoConfigurationPackages</span><br><span class="line">day04.boot.TestAutoConfiguration$OtherConfig</span><br><span class="line">bean1</span><br><span class="line">bean2</span><br></pre></td></tr></table></figure>





<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootConfiguration </span><br><span class="line">@ComponentScan.excludeFilters </span><br><span class="line">    - 用来在组件扫描时进行排除,也会排除自动配置类@EnableAutoConfiguration.</span><br><span class="line">@AutoConfigurationPackage </span><br><span class="line">    - 用来记住扫描的起始包.</span><br><span class="line">    -  @lmport(AutoConfigurationlmportSelector.class) 用来加载 META-INF/spring.factories 中的自动配置类</span><br></pre></td></tr></table></figure>





<h2 id="Spring中有哪些设计模式【11】"><a href="#Spring中有哪些设计模式【11】" class="headerlink" title="Spring中有哪些设计模式【11】"></a>Spring中有哪些设计模式【11】</h2><h3 id="1-Spring-中的-Singleton-Bean-是否是单例模式"><a href="#1-Spring-中的-Singleton-Bean-是否是单例模式" class="headerlink" title="1. Spring 中的 Singleton Bean 是否是单例模式?"></a>1. Spring 中的 Singleton Bean 是否是单例模式?</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">请大家区分 singleton pattern 与 Spring 中的 singleton bean.</span><br><span class="line">- 根据单例模式的目的Ensure a class only has one instance, and provide a global point of access to it.【确保一个类中只有一个实例，并且其提供一个全局的访问点】</span><br><span class="line">- 显然Spring中的singleton bean 并非实现了单例模式, singleton bean只能保证每个容器内,相同id的bean单实例【若id不同则可以有多个该类的实例】【而且sprng中是可以有多个容器的，不同容器，相同的id，相同的类型，也会有不同的实例】</span><br><span class="line">- 当然Spring 中也用到了单例模式,例如   org.springframework.transaction.TransactionDefinition#withDefaultsorg.springframework.aop.TruePointcut#INSTANCE org.springframework.aop.interceptor.Exposelnvocationlnterceptor#ADVISOR </span><br></pre></td></tr></table></figure>



<h3 id="2-Spring-中的Builder"><a href="#2-Spring-中的Builder" class="headerlink" title="2. Spring 中的Builder"></a>2. Spring 中的Builder</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Separate the construction of a complex object from its representation so that the same construction process can create different representations【构建器负责对象创造前的准备，最终调用.Build方法创建对象】</span><br><span class="line"></span><br><span class="line">它的主要亮点有三处:</span><br><span class="line">    1.较为灵活的构建产品对象</span><br><span class="line">    2.在不执行最后build方法前,产品对象都不可用</span><br><span class="line">    3.构建过程采用链式调用,看起来比较爽</span><br><span class="line">Spring 中体现Builder 模式的地方:</span><br><span class="line">org.springframework.beans.factory.support.BeanDefinitionBuilder 	org.springframework.web.util.UriComponentsBuilder.org.springframework.http.ResponseEntity.HeadersBuilder org.springframework.http.ResponseEntity.BodyBuilder </span><br></pre></td></tr></table></figure>



<h3 id="3-Spring-中的Factory-Method"><a href="#3-Spring-中的Factory-Method" class="headerlink" title="3. Spring 中的Factory Method"></a>3. Spring 中的Factory Method</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Define an interface for creating an object, but let subclasses decide which class to instantiate. Factory Method lets a class defer instantiation to subclasses【工厂方法模式，使得接口与实现相分离，降低耦合】</span><br><span class="line">根据上面的定义, Spring 中的ApplicationContext与BeanFactory 中的getBean 都可以视为工厂方法,它隐藏了bean (产品)的创建过程和具体实现</span><br><span class="line">Spring中其它工厂:.</span><br><span class="line">org.springframework.beans.factory.FactoryBean.</span><br><span class="line">@Bean 标注的静态方法【静态工厂方法】及实例方法【实例工厂方法】</span><br><span class="line">ObjectFactory 及 ObjectProvider</span><br><span class="line">前两种工厂主要封装第三方的bean的创建过程,后两种工厂可以推迟bean创建,解决循环依赖及单例注入多例等问题 </span><br></pre></td></tr></table></figure>



<h3 id="4-Spring-中的Adapter"><a href="#4-Spring-中的Adapter" class="headerlink" title="4. Spring 中的Adapter"></a>4. Spring 中的Adapter</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Convert the interface of a class into another interface clients expect. Adapter lets classes work together that couldn&#x27;t otherwise because of incompatible interfaces</span><br><span class="line">典型的实现有两处:org.springframework.web.servlet.HandlerAdapter - 因为控制器实现有各种各样,比如有大家熟悉的.</span><br><span class="line">@RequestMapping 标注的控制器实现.</span><br><span class="line">传统的基于Controller接口(不是@Controller注解啊)的实现</span><br><span class="line">.较新的基于RouterFunction接口的实现它们的处理方法都不一样,为了统一调用,必须适配为HandlerAdapter接口org.springframework.beans.factory.support.DisposableBeanAdapter - 因为销毁方法多种多样,因此都要适配为DisposableBean 来统一调用销毁方法. </span><br></pre></td></tr></table></figure>



<h3 id="5-Spring-中的Composite"><a href="#5-Spring-中的Composite" class="headerlink" title="5. Spring 中的Composite"></a>5. Spring 中的Composite</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Compose objects into tree structures to represent part-whole hierarchies. Composite lets clients treat individual objects and compositions of objects uniformly</span><br><span class="line">典型实现有:.org.springframework.web.method.support.HandlerMethodArgumentResolverComposite.org.springframework.web.method.support.HandlerMethodReturnValueHandlerComposite.org.springframework.web.servlet.handler.HandlerExceptionResolverComposite.org.springframework.web.servlet.view.ViewResolverComposite</span><br><span class="line">composite 对象的作用是,将分散的调用集中起来,统一调用入口,它的特征是,与具体干活的实现实现同一个接口,当调用 composite对象的接口方法时,其实是委托具体干活的实现来完成, </span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/03/30/%E6%A1%86%E6%9E%B6%E7%AF%87-itcast/" data-id="clfv77yrz000lj0cxa60q8aje" data-title="框架篇-itcast" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java%E6%A1%86%E6%9E%B6-itcast/" rel="tag">java框架-itcast</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2023/03/30/%E5%9F%BA%E7%A1%80%E7%AF%87-itcast/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          基础篇-itcast
        
      </div>
    </a>
  
  
    <a href="/2023/03/30/%E8%99%9A%E6%8B%9F%E6%9C%BA-itcast/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">虚拟机-itcast</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%8D%9A%E5%AE%A2%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">博客学习笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%A7%86%E9%A2%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">视频学习笔记</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AIO/" rel="tag">AIO</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/BIO/" rel="tag">BIO</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IO%E6%A8%A1%E5%9E%8B-heima/" rel="tag">IO模型-heima</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JVM-heima/" rel="tag">JVM-heima</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java%E5%9F%BA%E7%A1%80-heima/" rel="tag">Java基础-heima</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95-atguigu/" rel="tag">Java数据结构与算法-atguigu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mybatis-DongLi/" rel="tag">Mybatis-DongLi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NIO/" rel="tag">NIO</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-DongLi/" rel="tag">Spring-DongLi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringBoot-DongLi/" rel="tag">SpringBoot-DongLi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringMVC-DongLi/" rel="tag">SpringMVC-DongLi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringSecurity-sg/" rel="tag">SpringSecurity-sg</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue-atguigu/" rel="tag">Vue-atguigu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dubbo-heima/" rel="tag">dubbo-heima</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git-atguigu/" rel="tag">git-atguigu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java%E5%9F%BA%E7%A1%80-itcast/" rel="tag">java基础-itcast</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java%E5%B9%B6%E5%8F%91-itcast/" rel="tag">java并发-itcast</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java%E6%A1%86%E6%9E%B6-itcast/" rel="tag">java框架-itcast</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java%E8%99%9A%E6%8B%9F%E6%9C%BA-itcast/" rel="tag">java虚拟机-itcast</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/servlet/" rel="tag">servlet</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%8B%E5%8A%A1/" rel="tag">事务</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86-DongLi/" rel="tag">动态代理-DongLi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B0%9A%E7%A1%85%E8%B0%B7/" rel="tag">尚硅谷</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B0%9A%E7%A1%85%E8%B0%B7-%E5%AE%8B%E7%BA%A2%E5%BA%B7-MySQL-%E5%88%9D%E7%BA%A7/" rel="tag">尚硅谷-宋红康-MySQL(初级)</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B0%9A%E7%A1%85%E8%B0%B7-%E5%AE%8B%E7%BA%A2%E5%BA%B7-MySQL-%E9%AB%98%E7%BA%A7/" rel="tag">尚硅谷-宋红康-MySQL(高级)</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%9F%BA%E7%A1%80-msb/" rel="tag">操作系统基础-msb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/" rel="tag">网络基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%A9%AC%E5%A3%AB%E5%85%B5/" rel="tag">马士兵</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/AIO/" style="font-size: 10px;">AIO</a> <a href="/tags/BIO/" style="font-size: 10px;">BIO</a> <a href="/tags/IO%E6%A8%A1%E5%9E%8B-heima/" style="font-size: 10px;">IO模型-heima</a> <a href="/tags/JVM-heima/" style="font-size: 10px;">JVM-heima</a> <a href="/tags/Java%E5%9F%BA%E7%A1%80-heima/" style="font-size: 20px;">Java基础-heima</a> <a href="/tags/Java%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95-atguigu/" style="font-size: 10px;">Java数据结构与算法-atguigu</a> <a href="/tags/MySQL/" style="font-size: 10px;">MySQL</a> <a href="/tags/Mybatis-DongLi/" style="font-size: 10px;">Mybatis-DongLi</a> <a href="/tags/NIO/" style="font-size: 10px;">NIO</a> <a href="/tags/Spring-DongLi/" style="font-size: 10px;">Spring-DongLi</a> <a href="/tags/SpringBoot-DongLi/" style="font-size: 10px;">SpringBoot-DongLi</a> <a href="/tags/SpringMVC-DongLi/" style="font-size: 10px;">SpringMVC-DongLi</a> <a href="/tags/SpringSecurity-sg/" style="font-size: 10px;">SpringSecurity-sg</a> <a href="/tags/Vue-atguigu/" style="font-size: 10px;">Vue-atguigu</a> <a href="/tags/dubbo-heima/" style="font-size: 10px;">dubbo-heima</a> <a href="/tags/git-atguigu/" style="font-size: 10px;">git-atguigu</a> <a href="/tags/java%E5%9F%BA%E7%A1%80-itcast/" style="font-size: 10px;">java基础-itcast</a> <a href="/tags/java%E5%B9%B6%E5%8F%91-itcast/" style="font-size: 10px;">java并发-itcast</a> <a href="/tags/java%E6%A1%86%E6%9E%B6-itcast/" style="font-size: 10px;">java框架-itcast</a> <a href="/tags/java%E8%99%9A%E6%8B%9F%E6%9C%BA-itcast/" style="font-size: 10px;">java虚拟机-itcast</a> <a href="/tags/servlet/" style="font-size: 10px;">servlet</a> <a href="/tags/%E4%BA%8B%E5%8A%A1/" style="font-size: 10px;">事务</a> <a href="/tags/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86-DongLi/" style="font-size: 10px;">动态代理-DongLi</a> <a href="/tags/%E5%B0%9A%E7%A1%85%E8%B0%B7/" style="font-size: 10px;">尚硅谷</a> <a href="/tags/%E5%B0%9A%E7%A1%85%E8%B0%B7-%E5%AE%8B%E7%BA%A2%E5%BA%B7-MySQL-%E5%88%9D%E7%BA%A7/" style="font-size: 13.33px;">尚硅谷-宋红康-MySQL(初级)</a> <a href="/tags/%E5%B0%9A%E7%A1%85%E8%B0%B7-%E5%AE%8B%E7%BA%A2%E5%BA%B7-MySQL-%E9%AB%98%E7%BA%A7/" style="font-size: 16.67px;">尚硅谷-宋红康-MySQL(高级)</a> <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%9F%BA%E7%A1%80-msb/" style="font-size: 10px;">操作系统基础-msb</a> <a href="/tags/%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/" style="font-size: 10px;">网络基础</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 10px;">设计模式</a> <a href="/tags/%E9%A9%AC%E5%A3%AB%E5%85%B5/" style="font-size: 10px;">马士兵</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">March 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/03/30/%E7%AC%AC03%E7%AB%A0-%E5%9F%BA%E6%9C%AC%E7%9A%84SELECT%E8%AF%AD%E5%8F%A5-atguigu-shk/">第03章-基本的SELECT语句-atguigu-shk</a>
          </li>
        
          <li>
            <a href="/2023/03/30/char%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B-heima-xl/">char数据类型-heima-xl</a>
          </li>
        
          <li>
            <a href="/2023/03/30/Collection%E4%B8%8E%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8EList%E4%B8%8E%E6%B3%9B%E5%9E%8B%E6%B7%B1%E5%85%A5-heima-xl/">Collection与数据结构与List与泛型深入-heima-xl</a>
          </li>
        
          <li>
            <a href="/2023/03/30/JAVA-IO-%E4%B8%8B-heima-xl/">JAVA-IO-下-heima-xl</a>
          </li>
        
          <li>
            <a href="/2023/03/30/Set%E4%B8%8ECollections%E4%B8%8EMap%E4%B8%8E%E9%9B%86%E5%90%88%E5%B5%8C%E5%A5%97-heima-xl/">Set与Collections与Map与集合嵌套-heima-xl</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>