

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="一、什么是 JVM ? 定义： Java Virtual Machine【java虚拟机】 （java的运行二进制字节码的运行环境) 好处： 一次编写，到处运行的基石（jvm屏蔽了操作系统的差异） 自动内存管理，垃圾回收功能。对比于c、c++需要手动释放内存 数组下标越界检查。C语言也没有这种检查 多态，jvm使用虚方法表实现了多态">
<meta property="og:type" content="article">
<meta property="og:title" content="Java虚拟机-heima">
<meta property="og:url" content="http://example.com/2023/03/30/%E9%BB%91%E9%A9%AC-Java%E8%99%9A%E6%8B%9F%E6%9C%BA/index.html">
<meta property="og:site_name" content="FGCY-BLOG">
<meta property="og:description" content="一、什么是 JVM ? 定义： Java Virtual Machine【java虚拟机】 （java的运行二进制字节码的运行环境) 好处： 一次编写，到处运行的基石（jvm屏蔽了操作系统的差异） 自动内存管理，垃圾回收功能。对比于c、c++需要手动释放内存 数组下标越界检查。C语言也没有这种检查 多态，jvm使用虚方法表实现了多态">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/images/jvm.png">
<meta property="article:published_time" content="2023-03-30T12:05:39.000Z">
<meta property="article:modified_time" content="2023-03-30T13:36:26.490Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="JVM-heima">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/images/jvm.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>Java虚拟机-heima - FGCY-BLOG</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":333,"cursorChar":"%","loop":true,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>FGCY-BLOG</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>主页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签列表</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于我</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/playlist/">
                <i class="iconfont icon-music"></i>
                <span>音乐</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Java虚拟机-heima"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-03-30 20:05" pubdate>
          March 30, 2023 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    

    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> views
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Java虚拟机-heima</h1>
            
            
              <div class="markdown-body">
                
                <p>一、<strong>什么是</strong> <strong>JVM ?</strong></p>
<p>定义：</p>
<p>Java Virtual Machine【java虚拟机】 （java的运行二进制字节码的运行环境)</p>
<p>好处：</p>
<p>一次编写，到处运行的基石（jvm屏蔽了操作系统的差异）</p>
<p>自动内存管理，垃圾回收功能。对比于c、c++需要手动释放内存</p>
<p>数组下标越界检查。C语言也没有这种检查</p>
<p>多态，jvm使用<strong>虚方法</strong>表实现了多态</p>
<span id="more"></span>

<p>比较：JVM JRE  JDK</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807230659165.png" srcset="/img/loading.gif" lazyload alt="image-20220807230659165"></p>
<hr>
<h1 id="二、学习JVM有什么用"><a href="#二、学习JVM有什么用" class="headerlink" title="二、学习JVM有什么用"></a>二、学习JVM有什么用</h1><p>JVM是一种规范</p>
<p>各种的虚拟机才是才是具体的实现</p>
<p>如：</p>
<ul>
<li>oracle    的<code>hotspot</code></li>
<li>eclipse    的     <code>Open J9</code></li>
</ul>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807230745506.png" srcset="/img/loading.gif" lazyload alt="image-20220807230745506"></p>
<hr>
<h1 id="三、学习路线"><a href="#三、学习路线" class="headerlink" title="三、学习路线"></a><strong>三、学习路线</strong></h1><hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807230805350.png" srcset="/img/loading.gif" lazyload alt="image-20220807230805350"></p>
<hr>
<p><strong>分三大块：一、类加载器块 二、JVM内存结构  三、执行引擎</strong></p>
<ol>
<li>字节码文件通过类加载器加载进JVM中【方法区中】。</li>
<li>类是放在方法区中的。</li>
<li>类的实例与就是对象，是放在堆中。</li>
<li>对象调用方法时，又会使用到虚拟机栈（提供线程运行所需的内存空间），程序计数器（记录下一条字节码指令的地址），本地方法栈（提供运行本地方法所需的内存空间）。</li>
<li>每行代码使用解释器逐行进行解释。</li>
<li>即时编译器对热点代码（频繁执行的代码）进行优化</li>
<li>垃圾回收，会对堆中没有被引用的对象进行回收释放内存</li>
</ol>
<p>通过本地方法接口，来调用操作系统的一些方法</p>
<p><strong>本文章的书写顺序：</strong></p>
<p>内存结构—–&gt;垃圾回收—–&gt;编译优化—–&gt;类加载器（加载优化）—–&gt;即时编译器</p>
<h1 id="四、内存结构"><a href="#四、内存结构" class="headerlink" title="四、内存结构"></a><strong>四、内存结构</strong></h1><h2 id="1-0-程序计数器"><a href="#1-0-程序计数器" class="headerlink" title="1.0 程序计数器"></a>1.0 程序计数器</h2><p>Program Counter Register 程序计数器（寄存器）</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807230827013.png" srcset="/img/loading.gif" lazyload alt="image-20220807230827013"></p>
<hr>
<p>PC的作用：</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807230859677.png" srcset="/img/loading.gif" lazyload alt="image-20220807230859677"></p>
<hr>
<ol>
<li>java源代码会通过jdk中的javac工具转化为二进制的字节码文件。</li>
<li>通过类加载器将字节码文件加载进jvm中。</li>
<li>程序计数器先将第一条JVM指令的地址装载到pc中。</li>
<li>解释器就会到程序计数器里去取指令地址，根据地址找到一条指令，解释器将一行代码解释为机器码。</li>
<li>交由cpu执行（此时字节码解释器会通过改变这个计数器的值来选取下一条需要执行的字节码指令，分支、循环、跳转、异常处理、线程恢复等功能都需要依赖这个计数器来完成）。</li>
<li>重复解释器到pc中取地址，找指令，解释成机器码，交由cpu执行机器码。再去pc中取地址。</li>
</ol>
<p>注意：</p>
<p>每个线程都有自己的程序计数器</p>
<p>作用，是  <strong>记住</strong>   <code>下一条</code>   jvm指令的执行地址</p>
<p>程序计数器特点</p>
<p>1、<code>线程私有</code>的</p>
<p>2、JVM规范中规定了：PC是唯一 一个不会存在内存溢出的区（堆、栈、方法区都有内存溢出的问题）</p>
<h2 id="2-0-虚拟机栈"><a href="#2-0-虚拟机栈" class="headerlink" title="2.0 虚拟机栈"></a>2.0 虚拟机栈</h2><p>Java Virtual Machine Stacks （Java 虚拟机栈）</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807230926551.png" srcset="/img/loading.gif" lazyload alt="image-20220807230926551"></p>
<hr>
<p><strong>栈帧与栈的关系：</strong></p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/73e033033bd0f8da57564043341e3313.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<hr>
<ul>
<li>局部变量表 主要存放了编译期可知的各种数据类型（boolean、byte、char、short、int、float、long、double）、对象引用（reference 类型，它不同于对象本身，可能是一个指向对象起始地址的引用指针，也可能是指向一个代表对象的句柄或其他与此对象相关的位置）。</li>
<li>操作数栈 主要作为方法调用的中转站使用，用于存放方法执行过程中产生的中间计算结果。另外，计算过程中产生的临时变量也会放在操作数栈中。</li>
<li>动态链接 主要服务一个方法需要调用其他方法的场景。在 Java 源文件被编译成字节码文件时，所有的变量和方法引用都作为符号引用（Symbilic Reference）保存在 Class 文件的常量池里。当一个方法要调用其他方法，需要将常量池中指向方法的符号引用转化为其在内存地址中的直接引用。动态链接的作用就是为了  <strong>将符号引用转换为调用方法的直接引用</strong>。</li>
<li>返回地址，记录一个方法调用完一个方法后，结束的位置（这个方法结束后，下一条指令是什么）</li>
</ul>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/68747470733a2f2f67756964652d626c6f672d696d616765732e6f73732d636e2d7368656e7a68656e2e616c6979756e63732e636f6d2f6769746875622f6a61766167756964652f6a766d696d6167652d32303232303333313137353733383639322e706e67" srcset="/img/loading.gif" lazyload alt="img"></p>
<hr>
<p>每个  <strong>线程运行时所需要的内存</strong>，称为  <code>虚拟机栈</code></p>
<p>栈帧：<strong>方法运行时</strong>  <code>所需要的内存</code>。一个栈帧对应一个方法的调用。</p>
<p>每个栈由多个栈帧（Frame）组成，对应着每次方法调用时所占用的内存。</p>
<p><strong>每个线程</strong>只能  <strong>有一个活动栈帧</strong>，  对应   着  <strong>当前正在执行</strong>的<strong>那个方法</strong>（<strong>在栈顶</strong>）。</p>
<p>当前正在执行的方法对应的栈帧，叫做<strong>当前栈帧</strong>。</p>
<p>栈空间虽然不是无限的，但一般正常调用的情况下是不会出现问题的。不过，如果函数调用陷入无限循环的话，就会导致栈中被压入太多栈帧而占用太多空间，导致栈空间过深。那么当线程请求栈的深度超过当前 Java 虚拟机栈的最大深度的时候，就抛出 <code>StackOverFlowError</code> 错误。</p>
<p>Java 方法有两种返回方式，一种是<strong>return 语句正常返回</strong>，一种是<strong>抛出异常</strong>。不管哪种返回方式，都会导致栈帧被弹出。也就是说， 栈帧随着方法调用而创建，随着方法结束而销毁。无论方法正常完成还是异常完成都算作方法结束。</p>
<p>除了 StackOverFlowError 错误之外，栈还可能会出现OutOfMemoryError错误，这是因为如果栈的内存大小可以动态扩展， 如果虚拟机在动态扩展栈时无法申请到足够的内存空间，则抛出OutOfMemoryError异常。</p>
<p>简单总结一下程序运行中栈可能会出现两种错误：</p>
<ul>
<li><code>StackOverFlowError</code>： 若栈的内存大小不允许动态扩展，那么当线程请求栈的深度超过当前 Java 虚拟机栈的最大深度的时候，就抛出 StackOverFlowError 错误。</li>
<li><code>OutOfMemoryError</code>： 如果栈的内存大小可以动态扩展， 如果虚拟机在动态扩展栈时无法申请到足够的内存空间，则抛出OutOfMemoryError异常。</li>
</ul>
<p>问题辨析</p>
<ol>
<li><p>垃圾回收是否涉及栈内存？</p>
<p>垃圾回收  <strong>针对</strong>  <strong>堆内存中没有引用的对象</strong>  ，栈帧随着方法结束而出栈。</p>
<p>所以没有涉及垃圾回收。</p>
</li>
<li><p>栈内存分配越大越好吗？</p>
<p><code>Linux</code>、<code>MacOs</code>、<code>Solaris</code>默认是<code>1024k</code>。</p>
<p>Widow由   <code>默认的虚拟内存</code>  决定。</p>
<p>栈内存  <strong>不是</strong>  分配得越大越好，栈内存是线程运行所需要的内存空间，以为内存空间数量一定，<strong>栈内存空间越大</strong>，<strong>线程数量越少</strong>。</p>
<p>可以通过一个虚拟机参数指定 栈内存大小：<code>-Xss 1024k</code></p>
</li>
<li><p>方法内的局部变量是否线程安全？</p>
<p>看一个线程安不安全，就是看  <code>多个线程</code>  对 <code> 一个变量</code>  是否是共享的，还是私有的。</p>
<p>局部变量存在在于栈帧中，线程运行在虚拟机栈中，栈帧会压入方法栈中，栈帧提供方法运行所需内存。</p>
<p>每个线程都有自己的栈，所以局部变量是线程私有的，所以局部变量是线程安全的；</p>
</li>
</ol>
<p>​		需要一个前提：<code> 方法内局部变量</code>(入参，局部变量)  没有逃离方法的作用范围，它是线程安全的。如果是<code>局部变量  引用了  对象</code>，并<code>逃离方法的作用范围</code>，则需		要考虑线程安全。因为其他线程也可以通过引用修改到对象的值【堆是线程共享的】</p>
<p>当是一个静态变量，所有该类的对象都可以访问的变量：</p>
<p>那么就存在线程安全问题，因为这个变量不是线程私有的，而是多个线程共享的；</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220821103153346.png" srcset="/img/loading.gif" lazyload alt="image-20220821103153346"></p>
<hr>
<p>注意：</p>
<p>不能等主线程的核心逻辑都跑完才开始，启动一个新的线程；否则相当于单线程；</p>
<h3 id="2-1-栈内存溢出"><a href="#2-1-栈内存溢出" class="headerlink" title="2.1 栈内存溢出"></a>2.1 <strong>栈内存溢出</strong></h3><p>栈帧过多导致栈内存溢出（一般是这种情况比较多）</p>
<p>一般是方法递归导致的</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807231052698.png" srcset="/img/loading.gif" lazyload alt="image-20220807231052698"></p>
<hr>
<p>栈帧过大导致栈内存溢出（这种情况出现的可能性较小）</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807231118982.png" srcset="/img/loading.gif" lazyload alt="image-20220807231118982"></p>
<hr>
<p><strong>例子：方法无限递归导致StackOverflowError</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 演示栈内存溢出 java.lang.StackOverflowError</span><br><span class="hljs-comment"> * -Xss256k</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo1_2</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> count;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            method1();<br>        &#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;<br>            e.printStackTrace();<br>            System.out.println(count);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method1</span><span class="hljs-params">()</span> &#123;<br>        count++;<br>        method1();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus">java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.StackOverflowError</span><br>	at cn<span class="hljs-selector-class">.itcast</span><span class="hljs-selector-class">.jvm</span><span class="hljs-selector-class">.t1</span><span class="hljs-selector-class">.stack</span><span class="hljs-selector-class">.Demo1_2</span><span class="hljs-selector-class">.method1</span>(Demo1_2<span class="hljs-selector-class">.java</span>:<span class="hljs-number">21</span>)<br><br><br><span class="hljs-number">31601</span><br></code></pre></td></tr></table></figure>





<p>设置栈大小，改变虚拟机参数 <code>-Xss256k</code></p>
<p>步骤：</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807231252882.png" srcset="/img/loading.gif" lazyload alt="image-20220807231252882"></p>
<hr>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807231313227.png" srcset="/img/loading.gif" lazyload alt="image-20220807231313227"></p>
<hr>
<p>重新运行该方法</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807231332112.png" srcset="/img/loading.gif" lazyload alt="image-20220807231332112"></p>
<hr>
<p>**例子：两个类循环引用导致出现 无限递归  ** 【不是<code>自己写的递归无终点方法</code>  导致的栈内存溢出】</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t1.stack;<br><br><span class="hljs-keyword">import</span> com.fasterxml.jackson.annotation.JsonIgnore;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.core.JsonProcessingException;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;<br><br><span class="hljs-keyword">import</span> java.util.Arrays;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * json 数据转换</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo1_19</span> &#123;<br>	<span class="hljs-comment">//部门中有员工列表，员工中有部门</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> JsonProcessingException &#123;<br>        <span class="hljs-type">Dept</span> <span class="hljs-variable">d</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dept</span>();<br>        d.setName(<span class="hljs-string">&quot;Market&quot;</span>);<br><br>        <span class="hljs-type">Emp</span> <span class="hljs-variable">e1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Emp</span>();<br>        e1.setName(<span class="hljs-string">&quot;zhang&quot;</span>);<br>        e1.setDept(d);<br><br>        <span class="hljs-type">Emp</span> <span class="hljs-variable">e2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Emp</span>();<br>        e2.setName(<span class="hljs-string">&quot;li&quot;</span>);<br>        e2.setDept(d);<br><br>        d.setEmps(Arrays.asList(e1, e2));<br><br>        <span class="hljs-comment">// &#123; name: &#x27;Market&#x27;, emps: [&#123; name:&#x27;zhang&#x27;, dept:&#123; name:&#x27;&#x27;, emps: [ &#123;&#125;]&#125; &#125;,] &#125;</span><br>        <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br>        System.out.println(mapper.writeValueAsString(d));<br>    &#125;<br>&#125;<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Emp</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-keyword">private</span> Dept dept;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Dept <span class="hljs-title function_">getDept</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> dept;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setDept</span><span class="hljs-params">(Dept dept)</span> &#123;<br>        <span class="hljs-built_in">this</span>.dept = dept;<br>    &#125;<br>&#125;<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Dept</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> List&lt;Emp&gt; emps;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> List&lt;Emp&gt; <span class="hljs-title function_">getEmps</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> emps;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setEmps</span><span class="hljs-params">(List&lt;Emp&gt; emps)</span> &#123;<br>        <span class="hljs-built_in">this</span>.emps = emps;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<p>json映射异常，栈内存溢出</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus">Exception <span class="hljs-keyword">in</span> thread <span class="hljs-string">&quot;main&quot;</span> com<span class="hljs-selector-class">.fasterxml</span><span class="hljs-selector-class">.jackson</span><span class="hljs-selector-class">.databind</span><span class="hljs-selector-class">.JsonMappingException</span>: Infinite recursion (StackOverflowError) (through reference chain: cn<span class="hljs-selector-class">.itcast</span><span class="hljs-selector-class">.jvm</span><span class="hljs-selector-class">.t1</span><span class="hljs-selector-class">.stack</span><span class="hljs-selector-class">.Dept</span><span class="hljs-selector-attr">[<span class="hljs-string">&quot;emps&quot;</span>]</span>-&gt;java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.ArrayList</span><span class="hljs-selector-attr">[0]</span>-&gt;cn<span class="hljs-selector-class">.itcast</span><span class="hljs-selector-class">.jvm</span><span class="hljs-selector-class">.t1</span><span class="hljs-selector-class">.stack</span><span class="hljs-selector-class">.Emp</span><span class="hljs-selector-attr">[<span class="hljs-string">&quot;dept&quot;</span>]</span>-&gt;cn<span class="hljs-selector-class">.itcast</span><span class="hljs-selector-class">.jvm</span><span class="hljs-selector-class">.t1</span><span class="hljs-selector-class">.stack</span><span class="hljs-selector-class">.Dept</span><span class="hljs-selector-attr">[<span class="hljs-string">&quot;emps&quot;</span>]</span>-&gt;java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.ArrayList</span><span class="hljs-selector-attr">[0]</span>-&gt;cn<span class="hljs-selector-class">.itcast</span><span class="hljs-selector-class">.jvm</span><span class="hljs-selector-class">.t1</span><span class="hljs-selector-class">.stack</span><span class="hljs-selector-class">.Emp</span><span class="hljs-selector-attr">[<span class="hljs-string">&quot;dept&quot;</span>]</span>-&gt;cn<span class="hljs-selector-class">.itcast</span><span class="hljs-selector-class">.jvm</span><span class="hljs-selector-class">.t1</span><span class="hljs-selector-class">.stack</span><span class="hljs-selector-class">.Dept</span><span class="hljs-selector-attr">[<span class="hljs-string">&quot;emps&quot;</span>]</span>-&gt;java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.ArrayList</span><span class="hljs-selector-attr">[0]</span>-&gt;cn<span class="hljs-selector-class">.itcast</span><span class="hljs-selector-class">.jvm</span><span class="hljs-selector-class">.t1</span><span class="hljs-selector-class">.stack</span><span class="hljs-selector-class">.Emp</span><span class="hljs-selector-attr">[<span class="hljs-string">&quot;dept&quot;</span>]</span>-&gt;cn<span class="hljs-selector-class">.itcast</span><span class="hljs-selector-class">.jvm</span><span class="hljs-selector-class">.t1</span><span class="hljs-selector-class">.stack</span><span class="hljs-selector-class">.Dept</span><span class="hljs-selector-attr">[<span class="hljs-string">&quot;emps&quot;</span>]</span>-&gt;java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.ArrayList</span><span class="hljs-selector-attr">[0]</span>-&gt;cn<span class="hljs-selector-class">.itcast</span><span class="hljs-selector-class">.jvm</span><span class="hljs-selector-class">.t1</span><span class="hljs-selector-class">.stack</span><span class="hljs-selector-class">.Emp</span><span class="hljs-selector-attr">[<span class="hljs-string">&quot;dept&quot;</span>]</span>-&gt;cn<span class="hljs-selector-class">.itcast</span><span class="hljs-selector-class">.jvm</span><span class="hljs-selector-class">.t1</span><span class="hljs-selector-class">.stack</span><span class="hljs-selector-class">.Dept</span><span class="hljs-selector-attr">[<span class="hljs-string">&quot;emps&quot;</span>]</span>-&gt;java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.ArrayList</span><span class="hljs-selector-attr">[0]</span>-&gt;cn<span class="hljs-selector-class">.itcast</span><span class="hljs-selector-class">.jvm</span><span class="hljs-selector-class">.t1</span><span class="hljs-selector-class">.stack</span><span class="hljs-selector-class">.Emp</span><span class="hljs-selector-attr">[<span class="hljs-string">&quot;dept&quot;</span>]</span>-<br>......................................................<br>	at com<span class="hljs-selector-class">.fasterxml</span><span class="hljs-selector-class">.jackson</span><span class="hljs-selector-class">.databind</span><span class="hljs-selector-class">.ser</span><span class="hljs-selector-class">.std</span><span class="hljs-selector-class">.BeanSerializerBase</span><span class="hljs-selector-class">.serializeFields</span>(BeanSerializerBase<span class="hljs-selector-class">.java</span>:<span class="hljs-number">658</span>)<br></code></pre></td></tr></table></figure>



<p>解决：</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807231359023.png" srcset="/img/loading.gif" lazyload alt="image-20220807231359023"></p>
<hr>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs prolog">&#123;<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;Market&quot;</span>,<span class="hljs-string">&quot;emps&quot;</span>:[&#123;<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;zhang&quot;</span>&#125;,&#123;<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;li&quot;</span>&#125;]&#125;<br></code></pre></td></tr></table></figure>



<h3 id="2-2-线程运行诊断"><a href="#2-2-线程运行诊断" class="headerlink" title="2.2 线程运行诊断"></a>2.2 线程运行诊断</h3><p>Linux下跑一个  <strong>后台</strong>  的java程序</p>
<blockquote>
<p>nohub java 名字 &amp;</p>
</blockquote>
<p>IDEA中  监控某个进程对cpu、内存的占用情况</p>
<blockquote>
<p>top</p>
</blockquote>
<p>IDEA中 用ps命令进一步定位是  哪个线程<code>(十进制)</code>   引起的cpu占用过高</p>
<blockquote>
<p>ps H -eo pid,tid,%cpu | grep 进程id </p>
</blockquote>
<p>可以<strong>根据  线程id</strong> 找到有问题的线程<code>(十六进制)</code>，进一步定位到问题代码的源码行号</p>
<blockquote>
<p>jstack 进程id</p>
</blockquote>
<p>案例2：程序运行很长时间没有结果<code>(用上面的线程诊断步骤，来判断该程序发生死锁)</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t1.stack;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 演示线程死锁</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span>&#123;&#125;;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span>&#123;&#125;;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo1_3</span> &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">A</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">A</span>();<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">B</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">B</span>();<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(()-&gt;&#123;<br>            <span class="hljs-keyword">synchronized</span> (a) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    Thread.sleep(<span class="hljs-number">2000</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>                <span class="hljs-keyword">synchronized</span> (b) &#123;<br>                    System.out.println(<span class="hljs-string">&quot;我获得了 a 和 b&quot;</span>);<br>                &#125;<br>            &#125;<br>        &#125;).start();<br>        <br>        <span class="hljs-comment">//在这先等一秒，再开启下面的线程</span><br>        <span class="hljs-comment">//保证锁a一定被他人占有</span><br>        Thread.sleep(<span class="hljs-number">1000</span>);<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(()-&gt;&#123;<br>            <span class="hljs-keyword">synchronized</span> (b) &#123;<br>                <span class="hljs-comment">//在这停下来，尝试获取锁a</span><br>                <span class="hljs-keyword">synchronized</span> (a) &#123;<br>                    System.out.println(<span class="hljs-string">&quot;我获得了 a 和 b&quot;</span>);<br>                &#125;<br>            &#125;<br>        &#125;).start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<h2 id="3-0-本地方法栈"><a href="#3-0-本地方法栈" class="headerlink" title="3.0 本地方法栈"></a>3.0 本地方法栈</h2><hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807231425559.png" srcset="/img/loading.gif" lazyload alt="image-20220807231425559"></p>
<hr>
<p><strong>本地方法栈</strong>，给   <strong>本地的方法</strong>   运行提供一块<code>内存空间</code></p>
<p>本地方法：用<code>  C或C++语言 </code>编写的方法。用于  直接  <strong>调用操作系统底层的API</strong></p>
<p>例如：Object类中 	</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerNatives</span><span class="hljs-params">()</span>;<br> <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">native</span> Class&lt;?&gt; getClass();<br> <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">native</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span>;<br><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">native</span> Object <span class="hljs-title function_">clone</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> CloneNotSupportedException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">native</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notify</span><span class="hljs-params">()</span>;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">native</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyAll</span><span class="hljs-params">()</span>;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">native</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">wait</span><span class="hljs-params">(<span class="hljs-type">long</span> timeout)</span> <span class="hljs-keyword">throws</span> InterruptedException;<br></code></pre></td></tr></table></figure>

<p><strong>java代码</strong>  通过   <strong>本地方法接口 （JNI）</strong> 调用  <code>使用C或C++语言写的</code>  可以直接调用<code>底层操作系统的api</code>的方法</p>
<h2 id="4-0-堆"><a href="#4-0-堆" class="headerlink" title="4.0 堆"></a>4.0 堆</h2><hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807231448187.png" srcset="/img/loading.gif" lazyload alt="image-20220807231448187"></p>
<hr>
<p><strong>程序计数器、本地方法栈、虚拟机栈</strong>   这些JVM内存结构都是线程私有的</p>
<p>Heap(堆)  通过 new 关键字，创建对象都会使用堆内存</p>
<p>特点 ：</p>
<ul>
<li><p>它是<strong>线程共享</strong>的，<strong>堆中对象</strong>  <code>都  </code>需要考虑   <strong>线程安全</strong>  的问题</p>
</li>
<li><p>虚拟机栈中的局部变量需要考虑线程安全的情况：(<code>对象</code> &amp;&amp; <code>逃离方法作用范围</code>)</p>
</li>
<li><p>堆中有垃圾回收机制，当堆中的对象没有被引用时，就会被回收掉（以释放掉空闲的内存）</p>
</li>
</ul>
<h3 id="4-1-堆内存溢出"><a href="#4-1-堆内存溢出" class="headerlink" title="4.1 堆内存溢出"></a>4.1 堆内存溢出</h3><p>举例：OOM</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 演示堆内存溢出 java.lang.OutOfMemoryError: Java heap space</span><br><span class="hljs-comment"> * -Xmx8m</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo1_5</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            List&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hello&quot;</span>;<br>            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>                list.add(a); <span class="hljs-comment">// hello, hellohello, hellohellohellohello ...</span><br>                a = a + a;  <span class="hljs-comment">// hellohellohellohello</span><br>                i++;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;<br>            e.printStackTrace();<br>            System.out.println(i);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">java.lang.OutOfMemoryError: </span><span class="hljs-keyword">Java </span>heap space   堆空间不足导致的内存溢出现象<br><span class="hljs-number">24</span><br></code></pre></td></tr></table></figure>



<p>修改堆空间最大值：</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807231509013.png" srcset="/img/loading.gif" lazyload alt="image-20220807231509013"></p>
<hr>
<p>运行17次后<strong>OOM</strong><code>（内存溢出错误）</code>  【之前是1g】</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807231538365.png" srcset="/img/loading.gif" lazyload alt="image-20220807231538365"></p>
<hr>
<h3 id="4-2-堆-内-存-诊-断"><a href="#4-2-堆-内-存-诊-断" class="headerlink" title="4.2 堆 内 存 诊 断"></a>4.2 堆 内 存 诊 断</h3><p>1 . <code>jps  </code>工 具查看 当 前 系 统 中 有 哪 些 <code>java  进 程</code>  显示进程编号</p>
<ol start="2">
<li>j m a p  工 具 查 看    <code>某个java进程</code>   的  <code>堆 内 存 占 用 情 况 </code></li>
</ol>
<blockquote>
<p>​	 jmap  -  heap  进 程id </p>
</blockquote>
<p>注意：</p>
<p>这个监控的是 <code>某一个 时刻的</code></p>
<ol start="3">
<li>jconsole  工 具 <code>图 形 界 面 的 </code>，<code>多 功 能</code>  (线程，cpu)的 监 测 工 具 ， 可 以 <code>连 续 监 测</code></li>
</ol>
<p>例子1:（使用 JDK 中的工具 <code>jmap</code>）</p>
<p>步骤：</p>
<p>1、启动代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t1.heap;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 演示堆内存</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo1_4</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        System.out.println(<span class="hljs-string">&quot;1...&quot;</span>);<br>        Thread.sleep(<span class="hljs-number">30000</span>);<br><br><br><br>        <span class="hljs-type">byte</span>[] array = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">10</span>]; <span class="hljs-comment">// 10 Mb</span><br>        System.out.println(<span class="hljs-string">&quot;2...&quot;</span>);<br>        Thread.sleep(<span class="hljs-number">20000</span>);<br><br><br><br>        array = <span class="hljs-literal">null</span>;<br>        System.gc();<br>        System.out.println(<span class="hljs-string">&quot;3...&quot;</span>);<br>        Thread.sleep(<span class="hljs-number">1000000L</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>2、使用jdk中的<code>jps命令</code> 显示有哪些java进程</p>
<p>该程序一共有三个阶段，此时(执行程序后)处于第一个阶段 需要观察 <code>Demo1_4</code>的进程编号</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">D:\learn\黑马程序员\资料-解密<span class="hljs-keyword">JVM\代码\jvm&gt;jps </span>        -- 显示有哪些<span class="hljs-keyword">java进程</span><br><span class="hljs-keyword"></span><span class="hljs-number">24260</span> Demo1_4<br><span class="hljs-number">12312</span><br><span class="hljs-number">1704</span> <span class="hljs-keyword">Jps</span><br><span class="hljs-keyword"></span><span class="hljs-number">24232</span> Launcher<br><span class="hljs-number">9500</span> RemoteMavenServer36<br></code></pre></td></tr></table></figure>





<p>3、在控制台窗口输入命令  <code>jmap -heap 进程号</code></p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">D</span>:\learn\黑马程序员\资料-解密JVM\代码\jvm&gt;jmap -heap <span class="hljs-number">24260</span><br><span class="hljs-attribute">Attaching</span> to process ID <span class="hljs-number">24260</span>, please wait...<br><span class="hljs-attribute">Debugger</span> attached successfully.<br><span class="hljs-attribute">Server</span> compiler detected.<br><span class="hljs-attribute">JVM</span> version is <span class="hljs-number">25</span>.<span class="hljs-number">201</span>-b09<br><br><span class="hljs-attribute">using</span> thread-local object allocation.<br><span class="hljs-attribute">Parallel</span> GC with <span class="hljs-number">13</span> thread(s)<br><br><span class="hljs-attribute">Heap</span> Configuration:<br>   <span class="hljs-attribute">MinHeapFreeRatio</span>         = <span class="hljs-number">0</span><br>   <span class="hljs-attribute">MaxHeapFreeRatio</span>         = <span class="hljs-number">100</span><br>   <span class="hljs-attribute">MaxHeapSize</span>              = <span class="hljs-number">4257218560</span> (<span class="hljs-number">4060</span>.<span class="hljs-number">0</span>MB)     -- 最大堆内存空间<br>   <span class="hljs-attribute">NewSize</span>                  = <span class="hljs-number">88604672</span> (<span class="hljs-number">84</span>.<span class="hljs-number">5</span>MB)         -- 新生代 <br>   <span class="hljs-attribute">MaxNewSize</span>               = <span class="hljs-number">1418723328</span> (<span class="hljs-number">1353</span>.<span class="hljs-number">0</span>MB)<br>   <span class="hljs-attribute">OldSize</span>                  = <span class="hljs-number">177733632</span> (<span class="hljs-number">169</span>.<span class="hljs-number">5</span>MB)       --老年代<br>   <span class="hljs-attribute">NewRatio</span>                 = <span class="hljs-number">2</span><br>   <span class="hljs-attribute">SurvivorRatio</span>            = <span class="hljs-number">8</span>                         --幸存区<br>   <span class="hljs-attribute">MetaspaceSize</span>            = <span class="hljs-number">21807104</span> (<span class="hljs-number">20</span>.<span class="hljs-number">796875</span>MB)	--元空间<br>   <span class="hljs-attribute">CompressedClassSpaceSize</span> = <span class="hljs-number">1073741824</span> (<span class="hljs-number">1024</span>.<span class="hljs-number">0</span>MB)<br>   <span class="hljs-attribute">MaxMetaspaceSize</span>         = <span class="hljs-number">17592186044415</span> MB<br>   <span class="hljs-attribute">G1HeapRegionSize</span>         = <span class="hljs-number">0</span> (<span class="hljs-number">0</span>.<span class="hljs-number">0</span>MB)<br><br><span class="hljs-attribute">Heap</span> Usage:<br><span class="hljs-attribute">PS</span> Young Generation<br><span class="hljs-attribute">Eden</span> Space:             --伊甸园区空间<br>   <span class="hljs-attribute">capacity</span> = <span class="hljs-number">66584576</span> (<span class="hljs-number">63</span>.<span class="hljs-number">5</span>MB)<br>   <span class="hljs-attribute">used</span>     = <span class="hljs-number">7990264</span> (<span class="hljs-number">7</span>.<span class="hljs-number">620109558105469</span>MB)  -- 占用<span class="hljs-number">7</span>M<br>   <span class="hljs-attribute">free</span>     = <span class="hljs-number">58594312</span> (<span class="hljs-number">55</span>.<span class="hljs-number">87989044189453</span>MB)<br>   <span class="hljs-attribute">12</span>.<span class="hljs-number">000172532449557</span>% used<br><span class="hljs-attribute">From</span> Space:<br>   <span class="hljs-attribute">capacity</span> = <span class="hljs-number">11010048</span> (<span class="hljs-number">10</span>.<span class="hljs-number">5</span>MB)<br>   <span class="hljs-attribute">used</span>     = <span class="hljs-number">0</span> (<span class="hljs-number">0</span>.<span class="hljs-number">0</span>MB)<br>   <span class="hljs-attribute">free</span>     = <span class="hljs-number">11010048</span> (<span class="hljs-number">10</span>.<span class="hljs-number">5</span>MB)<br>   <span class="hljs-attribute">0</span>.<span class="hljs-number">0</span>% used<br><span class="hljs-attribute">To</span> Space:<br>   <span class="hljs-attribute">capacity</span> = <span class="hljs-number">11010048</span> (<span class="hljs-number">10</span>.<span class="hljs-number">5</span>MB)<br>   <span class="hljs-attribute">used</span>     = <span class="hljs-number">0</span> (<span class="hljs-number">0</span>.<span class="hljs-number">0</span>MB)<br>   <span class="hljs-attribute">free</span>     = <span class="hljs-number">11010048</span> (<span class="hljs-number">10</span>.<span class="hljs-number">5</span>MB)<br>   <span class="hljs-attribute">0</span>.<span class="hljs-number">0</span>% used<br><span class="hljs-attribute">PS</span> Old Generation<br>   <span class="hljs-attribute">capacity</span> = <span class="hljs-number">177733632</span> (<span class="hljs-number">169</span>.<span class="hljs-number">5</span>MB)<br>   <span class="hljs-attribute">used</span>     = <span class="hljs-number">0</span> (<span class="hljs-number">0</span>.<span class="hljs-number">0</span>MB)<br>   <span class="hljs-attribute">free</span>     = <span class="hljs-number">177733632</span> (<span class="hljs-number">169</span>.<span class="hljs-number">5</span>MB)<br>   <span class="hljs-attribute">0</span>.<span class="hljs-number">0</span>% used<br><br><span class="hljs-attribute">3157</span> interned Strings occupying <span class="hljs-number">280136</span> bytes.<br></code></pre></td></tr></table></figure>



<p>4、等控制台输出2时，在控制台窗口输入命令  <code>jmap -heap 进程号</code></p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs tap">-- 此时创建一个大小为10M的字节数组<br>D:\learn\黑马程序员\资料-解密JVM\代码\jvm&gt;jmap -heap 24260<br>Attaching to process ID 24260, please wait...<br>Debugger attached successfully.<br>Server compiler detected.<br>JVM version is 25.201-b09<br><br>using thread-local object allocation.<br>Parallel GC with<span class="hljs-number"> 13 </span>thread(s)<br><br>Heap Configuration:<br>   MinHeapFreeRatio         = 0<br>   MaxHeapFreeRatio         = 100<br>   MaxHeapSize              =<span class="hljs-number"> 4257218560 </span>(4060.0MB)<br>   NewSize                  =<span class="hljs-number"> 88604672 </span>(84.5MB)<br>   MaxNewSize               =<span class="hljs-number"> 1418723328 </span>(1353.0MB)<br>   OldSize                  =<span class="hljs-number"> 177733632 </span>(169.5MB)<br>   NewRatio                 = 2<br>   SurvivorRatio            = 8<br>   MetaspaceSize            =<span class="hljs-number"> 21807104 </span>(20.796875MB)<br>   CompressedClassSpaceSize =<span class="hljs-number"> 1073741824 </span>(1024.0MB)<br>   MaxMetaspaceSize         =<span class="hljs-number"> 17592186044415 </span>MB<br>   G1HeapRegionSize         =<span class="hljs-number"> 0 </span>(0.0MB)<br><br>Heap Usage:<br>PS Young Generation<br>Eden Space:<br>   capacity =<span class="hljs-number"> 66584576 </span>(63.5MB)<br>   used     =<span class="hljs-number"> 18476040 </span>(17.62012481689453MB)  -- 大概占用10M<br>   free     =<span class="hljs-number"> 48108536 </span>(45.87987518310547MB)<br>   27.748228058101624% used<br>From Space:<br>   capacity =<span class="hljs-number"> 11010048 </span>(10.5MB)<br>   used     =<span class="hljs-number"> 0 </span>(0.0MB)<br>   free     =<span class="hljs-number"> 11010048 </span>(10.5MB)<br>   0.0% used<br>To Space:<br>   capacity =<span class="hljs-number"> 11010048 </span>(10.5MB)<br>   used     =<span class="hljs-number"> 0 </span>(0.0MB)<br>   free     =<span class="hljs-number"> 11010048 </span>(10.5MB)<br>   0.0% used<br>PS Old Generation<br>   capacity =<span class="hljs-number"> 177733632 </span>(169.5MB)<br>   used     =<span class="hljs-number"> 0 </span>(0.0MB)<br>   free     =<span class="hljs-number"> 177733632 </span>(169.5MB)<br>   0.0% used<br><br>3158 interned Strings occupying<span class="hljs-number"> 280184 </span>bytes.<br></code></pre></td></tr></table></figure>





<p>5、等控制台输出3时，在控制台窗口输入命令  <code>jmap -heap 进程号</code></p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs tap">-- 启用GC  释放内存<br>D:\learn\黑马程序员\资料-解密JVM\代码\jvm&gt;jmap -heap 24260<br>Attaching to process ID 24260, please wait...<br>Debugger attached successfully.<br>Server compiler detected.<br>JVM version is 25.201-b09<br><br>using thread-local object allocation.<br>Parallel GC with<span class="hljs-number"> 13 </span>thread(s)<br><br>Heap Configuration:<br>   MinHeapFreeRatio         = 0<br>   MaxHeapFreeRatio         = 100<br>   MaxHeapSize              =<span class="hljs-number"> 4257218560 </span>(4060.0MB)<br>   NewSize                  =<span class="hljs-number"> 88604672 </span>(84.5MB)<br>   MaxNewSize               =<span class="hljs-number"> 1418723328 </span>(1353.0MB)<br>   OldSize                  =<span class="hljs-number"> 177733632 </span>(169.5MB)<br>   NewRatio                 = 2<br>   SurvivorRatio            = 8<br>   MetaspaceSize            =<span class="hljs-number"> 21807104 </span>(20.796875MB)<br>   CompressedClassSpaceSize =<span class="hljs-number"> 1073741824 </span>(1024.0MB)<br>   MaxMetaspaceSize         =<span class="hljs-number"> 17592186044415 </span>MB<br>   G1HeapRegionSize         =<span class="hljs-number"> 0 </span>(0.0MB)<br><br>Heap Usage:<br>PS Young Generation<br>Eden Space:<br>   capacity =<span class="hljs-number"> 66584576 </span>(63.5MB)<br>   used     =<span class="hljs-number"> 1331712 </span>(1.27001953125MB)   -- 占用1M<br>   free     =<span class="hljs-number"> 65252864 </span>(62.22998046875MB)<br>   2.0000307578740157% used<br>From Space:<br>   capacity =<span class="hljs-number"> 11010048 </span>(10.5MB)<br>   used     =<span class="hljs-number"> 0 </span>(0.0MB)<br>   free     =<span class="hljs-number"> 11010048 </span>(10.5MB)<br>   0.0% used<br>To Space:<br>   capacity =<span class="hljs-number"> 11010048 </span>(10.5MB)<br>   used     =<span class="hljs-number"> 0 </span>(0.0MB)<br>   free     =<span class="hljs-number"> 11010048 </span>(10.5MB)<br>   0.0% used<br>PS Old Generation<br>   capacity =<span class="hljs-number"> 177733632 </span>(169.5MB)<br>   used     =<span class="hljs-number"> 1047456 </span>(0.998931884765625MB)<br>   free     =<span class="hljs-number"> 176686176 </span>(168.50106811523438MB)<br>   0.5893403449944691% used<br><br>3144 interned Strings occupying<span class="hljs-number"> 279192 </span>bytes.<br></code></pre></td></tr></table></figure>



<p>例子2：使用 JDK 中的工具 <code>jconsole</code></p>
<p>使用步骤：</p>
<p>1：启动代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t1.heap;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 演示堆内存</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo1_4</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        System.out.println(<span class="hljs-string">&quot;1...&quot;</span>);<br>        Thread.sleep(<span class="hljs-number">30000</span>);<br><br><br><br>        <span class="hljs-type">byte</span>[] array = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">10</span>]; <span class="hljs-comment">// 10 Mb</span><br>        System.out.println(<span class="hljs-string">&quot;2...&quot;</span>);<br>        Thread.sleep(<span class="hljs-number">20000</span>);<br><br><br><br>        array = <span class="hljs-literal">null</span>;<br>        System.gc();<br>        System.out.println(<span class="hljs-string">&quot;3...&quot;</span>);<br>        Thread.sleep(<span class="hljs-number">1000000L</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<p>2、在控制台输入命令<code>jconsole</code></p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807231559110.png" srcset="/img/loading.gif" lazyload alt="image-20220807231559110"></p>
<hr>
<p>选择目标进程，连接</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807231613467.png" srcset="/img/loading.gif" lazyload alt="image-20220807231613467"></p>
<hr>
<p>点击不安全的连接</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807231628336.png" srcset="/img/loading.gif" lazyload alt="image-20220807231628336"></p>
<hr>
<p>3、等待控制台输出</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs erlang"><span class="hljs-number">1</span>....<br><span class="hljs-number">2</span>....<br><span class="hljs-number">3</span>....<br></code></pre></td></tr></table></figure>



<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807231659765.png" srcset="/img/loading.gif" lazyload alt="image-20220807231659765"></p>
<hr>
<p>案例 ：垃圾回收后，内存占用仍然很高</p>
<p>1、运行代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t1.heap;<br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 演示查看对象个数 堆转储 dump</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo1_13</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        List&lt;Student&gt; students = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">200</span>; i++) &#123;<br>            students.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>());<br>        &#125;<br>        Thread.sleep(<span class="hljs-number">1000000000L</span>);<br>    &#125;<br>&#125;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[] big = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>*<span class="hljs-number">1024</span>];<br>&#125;<br></code></pre></td></tr></table></figure>



<p>2、使用 <code>jmap -heap 进程id</code> <strong>（通过jps查看进程id）</strong></p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807231720443.png" srcset="/img/loading.gif" lazyload alt="image-20220807231720443"></p>
<hr>
<p>3、使用jconsole工具，执行一次gc；</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807231735587.png" srcset="/img/loading.gif" lazyload alt="image-20220807231735587"></p>
<hr>
<p>4、使用jconsole工具，查看新生代和老年代的内容</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807231801585.png" srcset="/img/loading.gif" lazyload alt="image-20220807231801585"></p>
<hr>
<p>发现：<strong>只是  释放了新生代的的堆内存</strong>，<strong>老年代的没有被释放</strong>。</p>
<p>使用 <code>jvisualvm</code> 命令进行进一步分析</p>
<p>步骤：</p>
<p>1、输入命令 <code>jvisualvm</code></p>
<p>命令打开工具</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807231820879.png" srcset="/img/loading.gif" lazyload alt="image-20220807231820879"></p>
<hr>
<p>选择类</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807231834399.png" srcset="/img/loading.gif" lazyload alt="image-20220807231834399"></p>
<hr>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807231852456.png" srcset="/img/loading.gif" lazyload alt="image-20220807231852456"></p>
<hr>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807231934732.png" srcset="/img/loading.gif" lazyload alt="image-20220807231934732"></p>
<hr>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807231949437.png" srcset="/img/loading.gif" lazyload alt="image-20220807231949437"></p>
<hr>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807232007594.png" srcset="/img/loading.gif" lazyload alt="image-20220807232007594"></p>
<hr>
<p><strong>小结：</strong></p>
<p>这里的Student引用一直被ArrayList持有，所以有被引用的对象不会被GC释放，内存也没有被释放</p>
<h2 id="5-0-方法区"><a href="#5-0-方法区" class="headerlink" title="5.0 方法区"></a>5.0 方法区</h2><hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807232028513.png" srcset="/img/loading.gif" lazyload alt="image-20220807232028513"></p>
<hr>
<h3 id="5-1-定义"><a href="#5-1-定义" class="headerlink" title="5.1 定义"></a>5.1 定义</h3><p>JVM虚拟机规范：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html">https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html</a></p>
</blockquote>
<p>1、方法区于堆一样都是线程共享的区域；</p>
<p>2、存储了与类的结构相关的信息：<strong>成员变量</strong>，方法数据，**方法   与   构造器的<code>代码部分</code>**；</p>
<p>3、方法区在虚拟机启动时被创建，<strong>逻辑上 ** 是堆的组成部分（但具体的JVM厂商，可以放到其他位置），</strong>JVM规范并不强制规定方法区的位置**</p>
<ul>
<li>Oracle的Hotspot在jdk8以前，方法区的实现叫永久代，这个永久代就是堆内存的一部分。</li>
<li>1.8的时候又换了一种实现，此时方法区叫做元空间，此时元空间（规范叫做方法区）使用的是系统的内存。</li>
</ul>
<p>4、方法区内存不足时，也会外抛一个 <code>OutOfMemoryError</code>的异常</p>
<h3 id="5-2-组成"><a href="#5-2-组成" class="headerlink" title="5.2 组成"></a>5.2 组成</h3><p>以下两图  基于  <strong>Oracle的Hotspot虚拟机</strong>：</p>
<p>JDK1.7以前，方法区（永久代）存在于堆中，而  <strong>字符串常量池</strong>存在于永久代（堆）中</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807232047685.png" srcset="/img/loading.gif" lazyload alt="image-20220807232047685"></p>
<hr>
<p>注意：</p>
<p>永久代（方法区）的内存回收效率很低。只有当发生FullGC时，永久代才会进行垃圾回收。</p>
<p>FullGC需要等待到，老年代的空间不足时才会触发。触发时机晚了；</p>
<p>JDK1.8及其后续版本，<strong>方法区位于物理内存中</strong>；而不是位于堆中，但此时<code>字符串常量池</code>位于堆中；</p>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807232106759.png" srcset="/img/loading.gif" lazyload alt="image-20220807232106759"></p>
<hr>
<p>小结：</p>
<p>1、JVM是一个规范，它规定了要有方法区这个东西；建议放在堆中；</p>
<p>2、Hotspot虚拟机中，字符串常量池无论那个版本都位于堆中；</p>
<h3 id="5-3-方法区内存溢出"><a href="#5-3-方法区内存溢出" class="headerlink" title="5.3 方法区内存溢出"></a>5.3 方法区内存溢出</h3><p>1.8 以前会导致永久代内存溢出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm;<br><br><br><span class="hljs-keyword">import</span> com.sun.xml.internal.ws.org.objectweb.asm.ClassWriter;<br><span class="hljs-keyword">import</span> com.sun.xml.internal.ws.org.objectweb.asm.Opcodes;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 演示永久代内存溢出  java.lang.OutOfMemoryError: PermGen space</span><br><span class="hljs-comment"> * -XX:MaxPermSize=1k</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo1_8</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ClassLoader</span> &#123; <span class="hljs-comment">// 可以用来加载类的二进制字节码</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Demo1_8</span> <span class="hljs-variable">test</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Demo1_8</span>();<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">20000</span>; i++, j++) &#123;<br>                <span class="hljs-comment">// ClassWriter 作用是生成类的二进制字节码</span><br>                <span class="hljs-type">ClassWriter</span> <span class="hljs-variable">cw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassWriter</span>(<span class="hljs-number">0</span>);<br>                <span class="hljs-comment">// 版本号， public， 类名, 包名, 父类， 接口</span><br>                cw.visit(Opcodes.V1_8, Opcodes.ACC_PUBLIC, <span class="hljs-string">&quot;Class&quot;</span> + i, <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;java/lang/Object&quot;</span>, <span class="hljs-literal">null</span>);<br>                <span class="hljs-comment">// 返回 byte[]</span><br>                <span class="hljs-type">byte</span>[] code = cw.toByteArray();<br>                <span class="hljs-comment">// 执行了类的加载</span><br>                test.defineClass(<span class="hljs-string">&quot;Class&quot;</span> + i, code, <span class="hljs-number">0</span>, code.length); <span class="hljs-comment">// Class 对象</span><br>            &#125;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            System.out.println(j);<br>       &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807232129808.png" srcset="/img/loading.gif" lazyload alt="image-20220807232129808"></p>
<hr>
<p>1.8 之后会导致元空间内存溢出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t1.metaspace;<br><br><span class="hljs-keyword">import</span> jdk.internal.org.objectweb.asm.ClassWriter;<br><span class="hljs-keyword">import</span> jdk.internal.org.objectweb.asm.Opcodes;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 演示元空间内存溢出 java.lang.OutOfMemoryError: Metaspace</span><br><span class="hljs-comment"> * -XX:MaxMetaspaceSize=10m</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo1_8</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ClassLoader</span> &#123; <span class="hljs-comment">// 可以用来加载类的二进制字节码</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Demo1_8</span> <span class="hljs-variable">test</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Demo1_8</span>();<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++, j++) &#123;<br>                <span class="hljs-comment">// ClassWriter 作用是生成类的二进制字节码</span><br>                <span class="hljs-type">ClassWriter</span> <span class="hljs-variable">cw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassWriter</span>(<span class="hljs-number">0</span>);<br>                <span class="hljs-comment">// 版本号， public， 类名, 包名, 父类， 接口</span><br>                cw.visit(Opcodes.V1_8, Opcodes.ACC_PUBLIC, <span class="hljs-string">&quot;Class&quot;</span> + i, <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;java/lang/Object&quot;</span>, <span class="hljs-literal">null</span>);<br>                <span class="hljs-comment">// 返回 byte[]</span><br>                <span class="hljs-type">byte</span>[] code = cw.toByteArray();<br>                <span class="hljs-comment">// 执行了类的加载</span><br>                test.defineClass(<span class="hljs-string">&quot;Class&quot;</span> + i, code, <span class="hljs-number">0</span>, code.length); <span class="hljs-comment">// Class 对象</span><br>            &#125;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            System.out.println(j);<br>       &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>元空间使用的是系统内存，默认没有设置上限，需要修改上限：</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807232149242.png" srcset="/img/loading.gif" lazyload alt="image-20220807232149242"></p>
<hr>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-number">3331</span><br>Exception <span class="hljs-keyword">in</span> thread <span class="hljs-string">&quot;main&quot;</span> java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.OutOfMemoryError</span>: Compressed class space<br>	at java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.ClassLoader</span><span class="hljs-selector-class">.defineClass1</span>(Native Method)<br>	at java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.ClassLoader</span><span class="hljs-selector-class">.defineClass</span>(ClassLoader<span class="hljs-selector-class">.java</span>:<span class="hljs-number">763</span>)<br>	at java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.ClassLoader</span><span class="hljs-selector-class">.defineClass</span>(ClassLoader<span class="hljs-selector-class">.java</span>:<span class="hljs-number">642</span>)<br>	at cn<span class="hljs-selector-class">.itcast</span><span class="hljs-selector-class">.jvm</span><span class="hljs-selector-class">.t1</span><span class="hljs-selector-class">.metaspace</span><span class="hljs-selector-class">.Demo1_8</span><span class="hljs-selector-class">.main</span>(Demo1_8<span class="hljs-selector-class">.java</span>:<span class="hljs-number">24</span>)<br><br>进程已结束，退出代码为 <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>



<p>场景：</p>
<p>在使用Spring、Mybatis时会使用到一些动态生成字节码，完成动态的类加载；</p>
<p>使用CGlib技术完成动态代理</p>
<p><code>ClassWriter</code>类作用，在JVM运行期间动态生成类的字节码（二进制），完成动态的类加载； </p>
<p>这样会导致在在运行过程中产生大量的类，造成OOM（OutOfMemory）</p>
<h3 id="5-4-运行时常量池"><a href="#5-4-运行时常量池" class="headerlink" title="5.4 运行时常量池"></a>5.4 运行时常量池</h3><p>常量池，就是一张表， <strong>虚拟机指令</strong>  根据这张常量表找到要执行的类名、方法名、参数类型、字面量 等信息 ；</p>
<p>运行时常量池，<strong>常量池</strong>  是 <code>*.class 文件</code>中的，当该类被加载，它的  <code> 常量池信息</code>  就会放入   <code>运行时常量池</code>，并把里面的  <strong>符号地址</strong>  变为  <strong>真实地址</strong></p>
<p>一个基本的HelloWorld.java文件  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t5;<br><br><span class="hljs-comment">// 二进制字节码（类基本信息，常量池，类方法定义-&gt;包含了虚拟机指令）</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloWorld</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;hello world&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>进入 HelloWorld.java文件所在目录，通过 <code>javac HelloWorld.java</code> 编译程序</p>
<p>进入HelloWorld.class文件所在目录，通过<code>javap -v HelloWorld.class</code> 进行反编译字节码文件</p>
<p>反编译信息如下：</p>
<p>类的基本信息</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk">Classfile <span class="hljs-regexp">/D:/</span>learn<span class="hljs-regexp">/黑马程序员/</span>资料-解密JVM<span class="hljs-regexp">/代码/</span>jvm<span class="hljs-regexp">/out/</span>production<span class="hljs-regexp">/jvm/</span>cn<span class="hljs-regexp">/itcast/</span>jvm<span class="hljs-regexp">/t5/</span>HelloWorld.class   <span class="hljs-regexp">//</span>文件所在的绝对路径<br>  Last modified <span class="hljs-number">2022</span>-<span class="hljs-number">7</span>-<span class="hljs-number">28</span>; size <span class="hljs-number">567</span> bytes         <span class="hljs-regexp">//</span>最后修改时间<br>  MD5 checksum <span class="hljs-number">8</span>efebdac91aa496515fa1c161184e354         <span class="hljs-regexp">//</span>签名<br>  Compiled from <span class="hljs-string">&quot;HelloWorld.java&quot;</span>				<span class="hljs-regexp">//</span>源文件<br>public class cn.itcast.jvm.t5.HelloWorld		<span class="hljs-regexp">//</span>权限修饰符 包名 类名<br>  minor version: <span class="hljs-number">0</span><br>  major version: <span class="hljs-number">52</span>                         <span class="hljs-regexp">//</span><span class="hljs-number">52</span>对应jdk8<br>  flags: ACC_PUBLIC, ACC_SUPER<br></code></pre></td></tr></table></figure>



<p>类方法定义：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-punctuation">&#123;</span><br>  public cn.itcast.jvm.t5.HelloWorld()<span class="hljs-punctuation">;</span>               <span class="hljs-comment">//默认构造</span><br><span class="hljs-symbol">    descriptor:</span> ()V<br><span class="hljs-symbol">    flags:</span> ACC_PUBLIC<br><span class="hljs-symbol">    Code:</span><br>      <span class="hljs-attr">stack</span><span class="hljs-operator">=</span><span class="hljs-number">1</span>, <span class="hljs-attr">locals</span><span class="hljs-operator">=</span><span class="hljs-number">1</span>, args_<span class="hljs-attr">size</span><span class="hljs-operator">=</span><span class="hljs-number">1</span><br>         <span class="hljs-number">0</span>: aload_0<br>         <span class="hljs-number">1</span>: invokespecial <span class="hljs-meta">#1                  <span class="hljs-comment">// Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br>         <span class="hljs-number">4</span>: return<br><span class="hljs-symbol">      LineNumberTable:</span><br>        line <span class="hljs-number">4</span>: <span class="hljs-number">0</span><br><span class="hljs-symbol">      LocalVariableTable:</span><br>        Start  Length  Slot  Name   Signature<br>            <span class="hljs-number">0</span>       <span class="hljs-number">5</span>     <span class="hljs-number">0</span>  this   Lcn<span class="hljs-keyword">/itcast/</span>jvm<span class="hljs-keyword">/t5/</span>HelloW<span class="hljs-attr">orld</span><span class="hljs-punctuation">;</span><br><br>  public static void main(java.lang.String[])<span class="hljs-punctuation">;</span>            <span class="hljs-comment">//main方法</span><br><span class="hljs-symbol">    descriptor:</span> ([Ljava<span class="hljs-keyword">/lang/</span>S<span class="hljs-attr">tring</span><span class="hljs-punctuation">;</span>)V<br><span class="hljs-symbol">    flags:</span> ACC_PUBLIC, ACC_STATIC<br><span class="hljs-symbol">    Code:</span>  <span class="hljs-comment">//一下是虚拟机指令  </span><br>      <span class="hljs-attr">stack</span><span class="hljs-operator">=</span><span class="hljs-number">2</span>, <span class="hljs-attr">locals</span><span class="hljs-operator">=</span><span class="hljs-number">1</span>, args_<span class="hljs-attr">size</span><span class="hljs-operator">=</span><span class="hljs-number">1</span><br>         <span class="hljs-number">0</span>: getstatic     <span class="hljs-meta">#2                  <span class="hljs-comment">// Field java/lang/System.out:Ljava/io/PrintStream;  //获取静态变量System.out</span></span><br>         <span class="hljs-number">3</span>: ldc           <span class="hljs-meta">#3                  <span class="hljs-comment">// String hello world</span></span><br>         <span class="hljs-number">5</span>: invokevirtual <span class="hljs-meta">#4                  <span class="hljs-comment">// Method java/io/PrintStream.println:(Ljava/lang/String;)V       //执行一次虚方法调用</span></span><br>         <span class="hljs-number">8</span>: return                                                                                           <span class="hljs-comment">//整个main方法执行结束</span><br><span class="hljs-symbol">      LineNumberTable:</span><br>        line <span class="hljs-number">6</span>: <span class="hljs-number">0</span><br>        line <span class="hljs-number">7</span>: <span class="hljs-number">8</span><br><span class="hljs-symbol">      LocalVariableTable:</span><br>        Start  Length  Slot  Name   Signature<br>            <span class="hljs-number">0</span>       <span class="hljs-number">9</span>     <span class="hljs-number">0</span>  args   [Ljava<span class="hljs-keyword">/lang/</span>S<span class="hljs-attr">tring</span><span class="hljs-punctuation">;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>



<p>常量池中的信息：</p>
<p>一直往下找</p>
<p>其中当常量池中的常量信息被加载进运行时常量池中时， <code>#数字</code> 会转为一个  <strong>内存地址</strong></p>
<figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs delphi">Constant pool:<br>   <span class="hljs-string">#1</span> = Methodref          <span class="hljs-string">#6</span>.<span class="hljs-string">#20</span>         <span class="hljs-comment">// java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br>   <span class="hljs-string">#2</span> = Fieldref           <span class="hljs-string">#21</span>.<span class="hljs-string">#22</span>        <span class="hljs-comment">// java/lang/System.out:Ljava/io/PrintStream;</span><br>   <span class="hljs-string">#3</span> = <span class="hljs-keyword">String</span>             <span class="hljs-string">#23</span>            <span class="hljs-comment">// hello world</span><br>   <span class="hljs-string">#4</span> = Methodref          <span class="hljs-string">#24</span>.<span class="hljs-string">#25</span>        <span class="hljs-comment">// java/io/PrintStream.println:(Ljava/lang/String;)V</span><br>   <span class="hljs-string">#5</span> = <span class="hljs-keyword">Class</span>              <span class="hljs-string">#26</span>            <span class="hljs-comment">// cn/itcast/jvm/t5/HelloWorld</span><br>   <span class="hljs-string">#6</span> = <span class="hljs-keyword">Class</span>              <span class="hljs-string">#27</span>            <span class="hljs-comment">// java/lang/Object</span><br>   <span class="hljs-string">#7</span> = Utf8               &lt;init&gt;<br>   <span class="hljs-string">#8</span> = Utf8               ()V<br>   <span class="hljs-string">#9</span> = Utf8               Code<br>  <span class="hljs-string">#10</span> = Utf8               LineNumberTable<br>  <span class="hljs-string">#11</span> = Utf8               LocalVariableTable<br>  <span class="hljs-string">#12</span> = Utf8               this<br>  <span class="hljs-string">#13</span> = Utf8               Lcn/itcast/jvm/t5/HelloWorld;<br>  <span class="hljs-string">#14</span> = Utf8               main<br>  <span class="hljs-string">#15</span> = Utf8               ([Ljava/lang/<span class="hljs-keyword">String</span>;)V<br>  <span class="hljs-string">#16</span> = Utf8               args<br>  <span class="hljs-string">#17</span> = Utf8               [Ljava/lang/<span class="hljs-keyword">String</span>;<br>  <span class="hljs-string">#18</span> = Utf8               SourceFile<br>  <span class="hljs-string">#19</span> = Utf8               HelloWorld.java<br>  <span class="hljs-string">#20</span> = NameAndType        <span class="hljs-string">#7</span>:<span class="hljs-string">#8</span>          <span class="hljs-comment">// &quot;&lt;init&gt;&quot;:()V</span><br>  <span class="hljs-string">#21</span> = <span class="hljs-keyword">Class</span>              <span class="hljs-string">#28</span>            <span class="hljs-comment">// java/lang/System</span><br>  <span class="hljs-string">#22</span> = NameAndType        <span class="hljs-string">#29</span>:<span class="hljs-string">#30</span>        <span class="hljs-comment">// out:Ljava/io/PrintStream;</span><br>  <span class="hljs-string">#23</span> = Utf8               hello world<br>  <span class="hljs-string">#24</span> = <span class="hljs-keyword">Class</span>              <span class="hljs-string">#31</span>            <span class="hljs-comment">// java/io/PrintStream</span><br>  <span class="hljs-string">#25</span> = NameAndType        <span class="hljs-string">#32</span>:<span class="hljs-string">#33</span>        <span class="hljs-comment">// println:(Ljava/lang/String;)V</span><br>  <span class="hljs-string">#26</span> = Utf8               cn/itcast/jvm/t5/HelloWorld<br>  <span class="hljs-string">#27</span> = Utf8               java/lang/<span class="hljs-keyword">Object</span><br>  <span class="hljs-string">#28</span> = Utf8               java/lang/System<br>  <span class="hljs-string">#29</span> = Utf8               <span class="hljs-keyword">out</span><br>  <span class="hljs-string">#30</span> = Utf8               Ljava/io/PrintStream;<br>  <span class="hljs-string">#31</span> = Utf8               java/io/PrintStream<br>  <span class="hljs-string">#32</span> = Utf8               println<br>  <span class="hljs-string">#33</span> = Utf8               (Ljava/lang/<span class="hljs-keyword">String</span>;)V<br></code></pre></td></tr></table></figure>



<h3 id="5-5-StringTable"><a href="#5-5-StringTable" class="headerlink" title="5.5 StringTable"></a>5.5 StringTable</h3><p>理解字符串常量池：</p>
<p>源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// StringTable [ &quot;a&quot;, &quot;b&quot; ,&quot;ab&quot; ]  hashtable （哈希表）结构，不能扩容</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo1_22</span> &#123;<br>    <span class="hljs-comment">// 常量池中的信息，都会被加载到运行时常量池中， 这时 a b ab 都是常量池中的 符号 ，还没有变为  java 字符串对象</span><br>    <span class="hljs-comment">// ldc #2       从#2位置中加载符号 然后会把 a 符号变为 &quot;a&quot; 字符串对象 找一下串池中有没有这个对象（值匹配），没有就加入到串池中；</span><br>    <span class="hljs-comment">// ldc #3       从#3位置中加载符号 会把 b 符号变为 &quot;b&quot; 字符串对象 找一下串池中有没有这个对象（值匹配），没有就加入到串池中；</span><br>    <span class="hljs-comment">// ldc #4 会把 ab 从#4位置中加载符号  符号变为 &quot;ab&quot; 字符串对象 找一下串池中有没有这个对象（值匹配），没有就加入到串池中；</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">s1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;a&quot;</span>; <span class="hljs-comment">//将字符串对象放到StringTable中的行为是懒惰的</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">s2</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;b&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">s3</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ab&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>反编译后的信息：</p>
<p>main方法：</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">(java.lang.<span class="hljs-type">String</span>[])</span></span>;<br>   descriptor: ([Ljava/lang/<span class="hljs-type">String</span>;)V<br>   flags: ACC_PUBLIC, ACC_STATIC<br>   Code:<br>     stack=<span class="hljs-number">1</span>, locals=<span class="hljs-number">4</span>, args_size=<span class="hljs-number">1</span><br>        <span class="hljs-number">0</span>: ldc           #<span class="hljs-number">2</span>             <span class="hljs-comment">// String a //到常量池中的#2位置中获取 信息 然后这里是将信息 变为一个字符串对象(并将这个对象放到串池中)</span><br>        <span class="hljs-number">2</span>: astore_1                                        <span class="hljs-comment">//将上一步获取的字符串对象，存放到mian方法栈帧中的局部变量中</span><br>        <span class="hljs-number">3</span>: ldc           #<span class="hljs-number">3</span>                  <span class="hljs-comment">// String b</span><br>        <span class="hljs-number">5</span>: astore_2<br>        <span class="hljs-number">6</span>: ldc           #<span class="hljs-number">4</span>                  <span class="hljs-comment">// String ab</span><br>        <span class="hljs-number">8</span>: astore_3<br>        <span class="hljs-number">9</span>: <span class="hljs-keyword">return</span><br>     LineNumberTable:<br>       line <span class="hljs-number">11</span>: <span class="hljs-number">0</span><br>       line <span class="hljs-number">12</span>: <span class="hljs-number">3</span><br>       line <span class="hljs-number">13</span>: <span class="hljs-number">6</span><br>       line <span class="hljs-number">21</span>: <span class="hljs-number">9</span><br>     LocalVariableTable:     <span class="hljs-comment">//局部变量表</span><br>       Start  Length  Slot  Name   Signature<br>           <span class="hljs-number">0</span>      <span class="hljs-number">10</span>     <span class="hljs-number">0</span>  args   [Ljava/lang/<span class="hljs-type">String</span>;<br>           <span class="hljs-number">3</span>       <span class="hljs-number">7</span>     <span class="hljs-number">1</span>    s1   Ljava/lang/<span class="hljs-type">String</span>;<br>           <span class="hljs-number">6</span>       <span class="hljs-number">4</span>     <span class="hljs-number">2</span>    s2   Ljava/lang/<span class="hljs-type">String</span>;<br>           <span class="hljs-number">9</span>       <span class="hljs-number">1</span>     <span class="hljs-number">3</span>    s3   Ljava/lang/<span class="hljs-type">String</span>;<br><br></code></pre></td></tr></table></figure>



<p>例子二：</p>
<p>源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// StringTable [ &quot;a&quot;, &quot;b&quot; ,&quot;ab&quot; ]  hashtable 结构，不能扩容</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo1_22</span> &#123;<br>    <span class="hljs-comment">// 常量池中的信息，都会被加载到运行时常量池中， 这时 a b ab 都是常量池中的符号，还没有变为 java 字符串对象</span><br>    <span class="hljs-comment">// ldc #2 会把 a 符号变为 &quot;a&quot; 字符串对象</span><br>    <span class="hljs-comment">// ldc #3 会把 b 符号变为 &quot;b&quot; 字符串对象</span><br>    <span class="hljs-comment">// ldc #4 会把 ab 符号变为 &quot;ab&quot; 字符串对象</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">s1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;a&quot;</span>; <span class="hljs-comment">// 懒惰的</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">s2</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;b&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">s3</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ab&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">s4</span> <span class="hljs-operator">=</span> s1 + s2; <span class="hljs-comment">// new StringBuilder().append(&quot;a&quot;).append(&quot;b&quot;).toString()  new String(&quot;ab&quot;)</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">s5</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;a&quot;</span> + <span class="hljs-string">&quot;b&quot;</span>;  <span class="hljs-comment">// javac 在编译期间的优化（因为这个在编译器就可以确定下来 ），结果已经在编译期确定为ab</span><br><br>        System.out.println(s3 == s5);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>反编译后信息：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> main(java.lang.String[]);<br>   descriptor: ([Ljava<span class="hljs-regexp">/lang/</span>String;)V<br>   flags: ACC_PUBLIC, ACC_STATIC<br>   Code:<br>     stack=<span class="hljs-number">3</span>, locals=<span class="hljs-number">6</span>, args_size=<span class="hljs-number">1</span><br>        <span class="hljs-number">0</span>: ldc           #<span class="hljs-number">2</span>                  <span class="hljs-comment">// String a</span><br>        <span class="hljs-number">2</span>: astore_1<br>        <span class="hljs-number">3</span>: ldc           #<span class="hljs-number">3</span>                  <span class="hljs-comment">// String b</span><br>        <span class="hljs-number">5</span>: astore_2<br>        <span class="hljs-number">6</span>: ldc           #<span class="hljs-number">4</span>                  <span class="hljs-comment">// String ab</span><br>        <span class="hljs-number">8</span>: astore_3<br>        <br>  --------------------------------------之前分析过--------------------------------------------------------------      <br>        <br>        <span class="hljs-number">9</span>: <span class="hljs-keyword">new</span>           #<span class="hljs-number">5</span>                  <span class="hljs-comment">// class java/lang/StringBuilder  为创建StringBuilder对象 开辟一块内存空间</span><br>       <span class="hljs-number">12</span>: dup<br>       <span class="hljs-number">13</span>: invokespecial #<span class="hljs-number">6</span>                  <span class="hljs-comment">// Method java/lang/StringBuilder.&quot;&lt;init&gt;&quot;:()V  调用StringBuilder的无参构造初始化变量</span><br>       <span class="hljs-number">16</span>: aload_1                                                                           拿到局部变量表中<span class="hljs-number">1</span>号位置的变量<br>       <span class="hljs-number">17</span>: invokevirtual #<span class="hljs-number">7</span>                  <span class="hljs-comment">// Method java/lang/StringBuilder.append:f(Ljava/lang/String;)Ljava/lang/StringBuilder; 调用StringBuilder的append方法入参为上一步变量 </span><br>       <br>       <span class="hljs-number">20</span>: aload_2<br>       <span class="hljs-number">21</span>: invokevirtual #<span class="hljs-number">7</span>                  <span class="hljs-comment">// Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</span><br>       <span class="hljs-number">24</span>: invokevirtual #<span class="hljs-number">8</span>  <span class="hljs-comment">//Method java/lang/StringBuilder.toString:()Ljava/lang/String; 拿串池中的“ab”对象，去堆中新建字符串对象</span><br>       <span class="hljs-number">27</span>: astore        <span class="hljs-number">4</span><br>       <span class="hljs-number">29</span>: ldc           #<span class="hljs-number">4</span>                  <span class="hljs-comment">// String ab</span><br>       <span class="hljs-number">31</span>: astore        <span class="hljs-number">5</span><br>       <span class="hljs-number">33</span>: getstatic     #<span class="hljs-number">9</span>                  <span class="hljs-comment">// Field java/lang/System.out:Ljava/io/PrintStream;</span><br>       <span class="hljs-number">36</span>: aload_3<br>       <span class="hljs-number">37</span>: aload         <span class="hljs-number">5</span><br>       <span class="hljs-number">39</span>: if_acmpne     <span class="hljs-number">46</span><br>       <span class="hljs-number">42</span>: iconst_1<br>       <span class="hljs-number">43</span>: goto          <span class="hljs-number">47</span><br>       <span class="hljs-number">46</span>: iconst_0<br>       <span class="hljs-number">47</span>: invokevirtual #<span class="hljs-number">10</span>                 <span class="hljs-comment">// Method java/io/PrintStream.println:(Z)V</span><br>       <span class="hljs-number">50</span>: <span class="hljs-keyword">return</span><br>     LineNumberTable:<br>       line <span class="hljs-number">11</span>: <span class="hljs-number">0</span><br>       line <span class="hljs-number">12</span>: <span class="hljs-number">3</span><br>       line <span class="hljs-number">13</span>: <span class="hljs-number">6</span><br>       line <span class="hljs-number">14</span>: <span class="hljs-number">9</span><br>       line <span class="hljs-number">15</span>: <span class="hljs-number">29</span><br>       line <span class="hljs-number">17</span>: <span class="hljs-number">33</span><br>       line <span class="hljs-number">21</span>: <span class="hljs-number">50</span><br>     LocalVariableTable:<br>       Start  Length  Slot  Name   Signature<br>           <span class="hljs-number">0</span>      <span class="hljs-number">51</span>     <span class="hljs-number">0</span>  args   [Ljava<span class="hljs-regexp">/lang/</span>String;<br>           <span class="hljs-number">3</span>      <span class="hljs-number">48</span>     <span class="hljs-number">1</span>    s1   Ljava<span class="hljs-regexp">/lang/</span>String;<br>           <span class="hljs-number">6</span>      <span class="hljs-number">45</span>     <span class="hljs-number">2</span>    s2   Ljava<span class="hljs-regexp">/lang/</span>String;<br>           <span class="hljs-number">9</span>      <span class="hljs-number">42</span>     <span class="hljs-number">3</span>    s3   Ljava<span class="hljs-regexp">/lang/</span>String;<br>          <span class="hljs-number">29</span>      <span class="hljs-number">22</span>     <span class="hljs-number">4</span>    s4   Ljava<span class="hljs-regexp">/lang/</span>String;<br>          <span class="hljs-number">33</span>      <span class="hljs-number">18</span>     <span class="hljs-number">5</span>    s5   Ljava<span class="hljs-regexp">/lang/</span>String;<br>     StackMapTable: number_of_entries = <span class="hljs-number">2</span><br>       frame_type = <span class="hljs-number">255</span> <span class="hljs-comment">/* full_frame */</span><br>         offset_delta = <span class="hljs-number">46</span><br>         locals = [ <span class="hljs-keyword">class</span> <span class="hljs-string">&quot;[Ljava/lang/String;&quot;</span>, <span class="hljs-keyword">class</span> java<span class="hljs-regexp">/lang/</span>String, <span class="hljs-keyword">class</span> java<span class="hljs-regexp">/lang/</span>String, <span class="hljs-keyword">class</span> java<span class="hljs-regexp">/lang/</span>String, <span class="hljs-keyword">class</span> java<span class="hljs-regexp">/lang/</span>String, <span class="hljs-keyword">class</span> java<span class="hljs-regexp">/lang/</span>String ]<br>         stack = [ <span class="hljs-keyword">class</span> java<span class="hljs-regexp">/io/</span>PrintStream ]<br>       frame_type = <span class="hljs-number">255</span> <span class="hljs-comment">/* full_frame */</span><br>         offset_delta = <span class="hljs-number">0</span><br>         locals = [ <span class="hljs-keyword">class</span> <span class="hljs-string">&quot;[Ljava/lang/String;&quot;</span>, <span class="hljs-keyword">class</span> java<span class="hljs-regexp">/lang/</span>String, <span class="hljs-keyword">class</span> java<span class="hljs-regexp">/lang/</span>String, <span class="hljs-keyword">class</span> java<span class="hljs-regexp">/lang/</span>String, <span class="hljs-keyword">class</span> java<span class="hljs-regexp">/lang/</span>String, <span class="hljs-keyword">class</span> java<span class="hljs-regexp">/lang/</span>String ]<br>         stack = [ <span class="hljs-keyword">class</span> java<span class="hljs-regexp">/io/</span>PrintStream, <span class="hljs-keyword">int</span> ]<br><br></code></pre></td></tr></table></figure>



<p>串池：</p>
<figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs delphi">Constant pool:<br>   <span class="hljs-string">#1</span> = Methodref          <span class="hljs-string">#12</span>.<span class="hljs-string">#36</span>        <span class="hljs-comment">// java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br>   <span class="hljs-string">#2</span> = <span class="hljs-keyword">String</span>             <span class="hljs-string">#37</span>            <span class="hljs-comment">// a</span><br>   <span class="hljs-string">#3</span> = <span class="hljs-keyword">String</span>             <span class="hljs-string">#38</span>            <span class="hljs-comment">// b</span><br>   <span class="hljs-string">#4</span> = <span class="hljs-keyword">String</span>             <span class="hljs-string">#39</span>            <span class="hljs-comment">// ab</span><br>   <span class="hljs-string">#5</span> = <span class="hljs-keyword">Class</span>              <span class="hljs-string">#40</span>            <span class="hljs-comment">// java/lang/StringBuilder</span><br>   <span class="hljs-string">#6</span> = Methodref          <span class="hljs-string">#5</span>.<span class="hljs-string">#36</span>         <span class="hljs-comment">// java/lang/StringBuilder.&quot;&lt;init&gt;&quot;:()V</span><br>   <span class="hljs-string">#7</span> = Methodref          <span class="hljs-string">#5</span>.<span class="hljs-string">#41</span>         <span class="hljs-comment">// java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</span><br>   <span class="hljs-string">#8</span> = Methodref          <span class="hljs-string">#5</span>.<span class="hljs-string">#42</span>         <span class="hljs-comment">// java/lang/StringBuilder.toString:()Ljava/lang/String;</span><br>   <span class="hljs-string">#9</span> = Fieldref           <span class="hljs-string">#43</span>.<span class="hljs-string">#44</span>        <span class="hljs-comment">// java/lang/System.out:Ljava/io/PrintStream;</span><br>  <span class="hljs-string">#10</span> = Methodref          <span class="hljs-string">#45</span>.<span class="hljs-string">#46</span>        <span class="hljs-comment">// java/io/PrintStream.println:(Z)V</span><br>  <span class="hljs-string">#11</span> = <span class="hljs-keyword">Class</span>              <span class="hljs-string">#47</span>            <span class="hljs-comment">// cn/itcast/jvm/t1/stringtable/Demo1_22</span><br>  <span class="hljs-string">#12</span> = <span class="hljs-keyword">Class</span>              <span class="hljs-string">#48</span>            <span class="hljs-comment">// java/lang/Object</span><br>  <span class="hljs-string">#13</span> = Utf8               &lt;init&gt;<br>  <span class="hljs-string">#14</span> = Utf8               ()V<br>  <span class="hljs-string">#15</span> = Utf8               Code<br>  <span class="hljs-string">#16</span> = Utf8               LineNumberTable<br>  <span class="hljs-string">#17</span> = Utf8               LocalVariableTable<br>  <span class="hljs-string">#18</span> = Utf8               this<br>  <span class="hljs-string">#19</span> = Utf8               Lcn/itcast/jvm/t1/stringtable/Demo1_22;<br>  <span class="hljs-string">#20</span> = Utf8               main<br>  <span class="hljs-string">#21</span> = Utf8               ([Ljava/lang/<span class="hljs-keyword">String</span>;)V<br>  <span class="hljs-string">#22</span> = Utf8               args<br>  <span class="hljs-string">#23</span> = Utf8               [Ljava/lang/<span class="hljs-keyword">String</span>;<br>  <span class="hljs-string">#24</span> = Utf8               s1<br>  <span class="hljs-string">#25</span> = Utf8               Ljava/lang/<span class="hljs-keyword">String</span>;<br>  <span class="hljs-string">#26</span> = Utf8               s2<br>  <span class="hljs-string">#27</span> = Utf8               s3<br>  <span class="hljs-string">#28</span> = Utf8               s4<br>  <span class="hljs-string">#29</span> = Utf8               s5<br>  <span class="hljs-string">#30</span> = Utf8               StackMapTable<br>  <span class="hljs-string">#31</span> = <span class="hljs-keyword">Class</span>              <span class="hljs-string">#23</span>            <span class="hljs-comment">// &quot;[Ljava/lang/String;&quot;</span><br>  <span class="hljs-string">#32</span> = <span class="hljs-keyword">Class</span>              <span class="hljs-string">#49</span>            <span class="hljs-comment">// java/lang/String</span><br>  <span class="hljs-string">#33</span> = <span class="hljs-keyword">Class</span>              <span class="hljs-string">#50</span>            <span class="hljs-comment">// java/io/PrintStream</span><br>  <span class="hljs-string">#34</span> = Utf8               SourceFile<br>  <span class="hljs-string">#35</span> = Utf8               Demo1_22.java<br>  <span class="hljs-string">#36</span> = NameAndType        <span class="hljs-string">#13</span>:<span class="hljs-string">#14</span>        <span class="hljs-comment">// &quot;&lt;init&gt;&quot;:()V</span><br>  <span class="hljs-string">#37</span> = Utf8               a<br>  <span class="hljs-string">#38</span> = Utf8               b<br>  <span class="hljs-string">#39</span> = Utf8               ab<br>  <span class="hljs-string">#40</span> = Utf8               java/lang/StringBuilder<br>  <span class="hljs-string">#41</span> = NameAndType        <span class="hljs-string">#51</span>:<span class="hljs-string">#52</span>        <span class="hljs-comment">// append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</span><br>  <span class="hljs-string">#42</span> = NameAndType        <span class="hljs-string">#53</span>:<span class="hljs-string">#54</span>        <span class="hljs-comment">// toString:()Ljava/lang/String;</span><br>  <span class="hljs-string">#43</span> = <span class="hljs-keyword">Class</span>              <span class="hljs-string">#55</span>            <span class="hljs-comment">// java/lang/System</span><br>  <span class="hljs-string">#44</span> = NameAndType        <span class="hljs-string">#56</span>:<span class="hljs-string">#57</span>        <span class="hljs-comment">// out:Ljava/io/PrintStream;</span><br>  <span class="hljs-string">#45</span> = <span class="hljs-keyword">Class</span>              <span class="hljs-string">#50</span>            <span class="hljs-comment">// java/io/PrintStream</span><br>  <span class="hljs-string">#46</span> = NameAndType        <span class="hljs-string">#58</span>:<span class="hljs-string">#59</span>        <span class="hljs-comment">// println:(Z)V</span><br>  <span class="hljs-string">#47</span> = Utf8               cn/itcast/jvm/t1/stringtable/Demo1_22<br>  <span class="hljs-string">#48</span> = Utf8               java/lang/<span class="hljs-keyword">Object</span><br>  <span class="hljs-string">#49</span> = Utf8               java/lang/<span class="hljs-keyword">String</span><br>  <span class="hljs-string">#50</span> = Utf8               java/io/PrintStream<br>  <span class="hljs-string">#51</span> = Utf8               append<br>  <span class="hljs-string">#52</span> = Utf8               (Ljava/lang/<span class="hljs-keyword">String</span>;)Ljava/lang/StringBuilder;<br>  <span class="hljs-string">#53</span> = Utf8               toString<br>  <span class="hljs-string">#54</span> = Utf8               ()Ljava/lang/<span class="hljs-keyword">String</span>;<br>  <span class="hljs-string">#55</span> = Utf8               java/lang/System<br>  <span class="hljs-string">#56</span> = Utf8               <span class="hljs-keyword">out</span><br>  <span class="hljs-string">#57</span> = Utf8               Ljava/io/PrintStream;<br>  <span class="hljs-string">#58</span> = Utf8               println<br>  <span class="hljs-string">#59</span> = Utf8               (Z)V<br></code></pre></td></tr></table></figure>



<p>证明字符串延迟实例化：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t1.stringtable;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 演示字符串字面量也是【延迟】成为对象的</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestString</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> args.length;<br>        System.out.println(); <span class="hljs-comment">// 字符串个数 2149 </span><br><br>        System.out.print(<span class="hljs-string">&quot;1&quot;</span>);<br>        System.out.print(<span class="hljs-string">&quot;2&quot;</span>);<br>        System.out.print(<span class="hljs-string">&quot;3&quot;</span>);<br>        System.out.print(<span class="hljs-string">&quot;4&quot;</span>);<br>        System.out.print(<span class="hljs-string">&quot;5&quot;</span>);<br>        System.out.print(<span class="hljs-string">&quot;6&quot;</span>);<br>        System.out.print(<span class="hljs-string">&quot;7&quot;</span>);<br>        System.out.print(<span class="hljs-string">&quot;8&quot;</span>);<br>        System.out.print(<span class="hljs-string">&quot;9&quot;</span>);<br>        System.out.print(<span class="hljs-string">&quot;0&quot;</span>);<br>        System.out.print(<span class="hljs-string">&quot;1&quot;</span>); <span class="hljs-comment">// 字符串个数 2159</span><br>        System.out.print(<span class="hljs-string">&quot;2&quot;</span>);<br>        System.out.print(<span class="hljs-string">&quot;3&quot;</span>);<br>        System.out.print(<span class="hljs-string">&quot;4&quot;</span>);<br>        System.out.print(<span class="hljs-string">&quot;5&quot;</span>);<br>        System.out.print(<span class="hljs-string">&quot;6&quot;</span>);<br>        System.out.print(<span class="hljs-string">&quot;7&quot;</span>);<br>        System.out.print(<span class="hljs-string">&quot;8&quot;</span>);<br>        System.out.print(<span class="hljs-string">&quot;9&quot;</span>);<br>        System.out.print(<span class="hljs-string">&quot;0&quot;</span>);<br>        System.out.print(x); <span class="hljs-comment">// 字符串个数</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807232224773.png" srcset="/img/loading.gif" lazyload alt="image-20220807232224773"></p>
<hr>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807232254313.png" srcset="/img/loading.gif" lazyload alt="image-20220807232254313"></p>
<hr>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807232318905.png" srcset="/img/loading.gif" lazyload alt="image-20220807232318905"></p>
<hr>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807232501850.png" srcset="/img/loading.gif" lazyload alt="image-20220807232501850"></p>
<hr>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807232518441.png" srcset="/img/loading.gif" lazyload alt="image-20220807232518441"></p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807232540846.png" srcset="/img/loading.gif" lazyload alt="image-20220807232540846"></p>
<hr>
<h3 id="5-6-StringTable-特性"><a href="#5-6-StringTable-特性" class="headerlink" title="5.6 StringTable 特性"></a>5.6 StringTable 特性</h3><p>常量池中的字符串仅是符号，第一次用到时才变为对象 利用串池的机制，来避免重复创建字符串对象 </p>
<p>字符串变量拼接的原理是 StringBuilder （1.8） </p>
<p>字符串常量拼接的原理是编译期优化 </p>
<p>可以使用 intern 方法，主动将串池中还没有的字符串对象放入串池 </p>
<p>​	1.7、1.8 以后的 ：将这个字符串对象尝试放入串池，如果  有  则<strong>并不会放入</strong>，如果没有则放入串池， 会把串 池中的对象返回 </p>
<p>​	1.6 将这个字符串对象尝试放入串池，如果  有  则<strong>并不会放入</strong>，如果没有会把此对象<strong>复制一份</strong>， 放入串池， 会把串池中的对象返回</p>
<p>举例1（1.8）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo1_23</span> &#123;<br><br>    <span class="hljs-comment">//  [ &quot;a&quot;, &quot;b&quot;,&quot;ab&quot;]</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><br>        <span class="hljs-comment">//字符串变量拼接，底层调用StringBuilder方法，最后调用toString方法转为String对象 本质是在堆中创建一个String对象</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-string">&quot;a&quot;</span>) + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-string">&quot;b&quot;</span>);<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">s2</span> <span class="hljs-operator">=</span> s.intern(); <span class="hljs-comment">// 将这个字符串对象尝试放入串池，如果有则并不会放入，如果没有则放入串池， 会把串池中的对象返回</span><br><br>        System.out.println( s2 == <span class="hljs-string">&quot;ab&quot;</span>);<br>        System.out.println( s == <span class="hljs-string">&quot;ab&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs actionscript"><span class="hljs-literal">true</span><br><span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>



<p>举例2（1.8）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo1_23</span> &#123;<br>    <br>        <span class="hljs-comment">//  [&quot;ab&quot;, &quot;a&quot;, &quot;b&quot;]</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <br>            <span class="hljs-type">String</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ab&quot;</span>;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-string">&quot;a&quot;</span>) + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-string">&quot;b&quot;</span>);<br>    <br>            <span class="hljs-comment">// 堆  new String(&quot;a&quot;)   new String(&quot;b&quot;) new String(&quot;ab&quot;)</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">s2</span> <span class="hljs-operator">=</span> s.intern(); <span class="hljs-comment">// 将这个字符串对象尝试放入串池，如果有则并不会放入，如果没有则放入串池， 会把串池中的对象返回</span><br>    <br>            System.out.println( s2 == x);<br>            System.out.println( s == x );<br>        &#125;<br>    <br>    &#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs actionscript"><span class="hljs-literal">true</span><br><span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure>





<p>举例3（1.6）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo1_23</span> &#123;<br><br>    <span class="hljs-comment">// [&quot;ab&quot;,&quot;a&quot;, &quot;b&quot;]</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ab&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-string">&quot;a&quot;</span>) + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-string">&quot;b&quot;</span>);<br><br>        <span class="hljs-comment">// 堆  new String(&quot;a&quot;)   new String(&quot;b&quot;)  new String(&quot;ab&quot;)</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">s2</span> <span class="hljs-operator">=</span> s.intern(); <span class="hljs-comment">// 将这个字符串对象尝试放入串池，如果有则并不会放入，如果没有则放入串池， 会把串池中的对象返回</span><br><br>        System.out.println( s2 == x);<br>        System.out.println( s == x );<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs actionscript"><span class="hljs-literal">true</span><br><span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure>



<p>举例4（1.6）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo1_23</span> &#123;<br><br>    <span class="hljs-comment">// [&quot;a&quot;, &quot;b&quot;, &quot;ab&quot;]</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-string">&quot;a&quot;</span>) + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-string">&quot;b&quot;</span>);<br><br>        <span class="hljs-comment">// 堆  new String(&quot;a&quot;)   new String(&quot;b&quot;)  new String(&quot;ab&quot;)</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">s2</span> <span class="hljs-operator">=</span> s.intern(); <span class="hljs-comment">// 将这个字符串对象尝试放入串池，如果有则并不会放入，如果没有则放入串池， 会把串池中的对象返回</span><br>        <span class="hljs-comment">// s 拷贝一份，放入串池</span><br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ab&quot;</span>;<br>        System.out.println( s2 == x);<br>        System.out.println( s == x );<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs actionscript"><span class="hljs-literal">true</span><br><span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure>









<h3 id="5-7-StringTable面试题"><a href="#5-7-StringTable面试题" class="headerlink" title="5.7 StringTable面试题"></a>5.7 StringTable面试题</h3><p>1.8：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">s1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;a&quot;</span>;<br><span class="hljs-type">String</span> <span class="hljs-variable">s2</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;b&quot;</span>;<br><span class="hljs-type">String</span> <span class="hljs-variable">s3</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;a&quot;</span> + <span class="hljs-string">&quot;b&quot;</span>; <span class="hljs-comment">//编译器优化 &quot;ab&quot;</span><br><span class="hljs-type">String</span> <span class="hljs-variable">s4</span> <span class="hljs-operator">=</span> s1 + s2;   <span class="hljs-comment">//new StringBuilder().append(&quot;a&quot;).append(&quot;b&quot;).toString()  toString即new String(&quot;ab&quot;)</span><br><span class="hljs-type">String</span> <span class="hljs-variable">s5</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ab&quot;</span>;<br><span class="hljs-type">String</span> <span class="hljs-variable">s6</span> <span class="hljs-operator">=</span> s4.intern(); <span class="hljs-comment">//s4是堆中的字符串对象ab，尝试加入到串池中，发现已经有了，不加入；返回串池中“ab”d的对象</span><br><br><span class="hljs-comment">// 问</span><br>System.out.println(s3 == s4); <span class="hljs-comment">//堆 跟 字符串常量池</span><br>System.out.println(s3 == s5);<span class="hljs-comment">//字符串常量池 跟 字符串常量池</span><br>System.out.println(s3 == s6);<span class="hljs-comment">//字符串常量池 跟 字符串常量池</span><br><br><span class="hljs-type">String</span> <span class="hljs-variable">x2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-string">&quot;c&quot;</span>) + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-string">&quot;d&quot;</span>);<span class="hljs-comment">//堆中对象ab</span><br><span class="hljs-type">String</span> <span class="hljs-variable">x1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;cd&quot;</span>;<span class="hljs-comment">//串池中对象cd</span><br>x2.intern();<span class="hljs-comment">//尝试加入，但发现已经有了；不加入</span><br><br>System.out.println(x1 == x2);<span class="hljs-comment">////字符串常量池 跟 堆</span><br></code></pre></td></tr></table></figure>

<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs actionscript"><span class="hljs-literal">false</span><br><span class="hljs-literal">true</span><br><span class="hljs-literal">true</span><br><span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t1.stringtable;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 演示字符串相关面试题</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo1_21</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">s1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;a&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">s2</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;b&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">s3</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;a&quot;</span> + <span class="hljs-string">&quot;b&quot;</span>; <span class="hljs-comment">//编译器优化 &quot;ab&quot;</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">s4</span> <span class="hljs-operator">=</span> s1 + s2;   <span class="hljs-comment">//new StringBuilder().append(&quot;a&quot;).append(&quot;b&quot;).toString()  toString即new String(&quot;ab&quot;)</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">s5</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ab&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">s6</span> <span class="hljs-operator">=</span> s4.intern(); <span class="hljs-comment">//s4是堆中的字符串对象ab，尝试加入到串池中，发现已经有了，不加入；返回串池中“ab”d的对象</span><br><br><span class="hljs-comment">// 问</span><br>        System.out.println(s3 == s4); <span class="hljs-comment">//堆 跟 字符串常量池</span><br>        System.out.println(s3 == s5);<span class="hljs-comment">//字符串常量池 跟 字符串常量池</span><br>        System.out.println(s3 == s6);<span class="hljs-comment">//字符串常量池 跟 字符串常量池</span><br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">x2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-string">&quot;c&quot;</span>) + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-string">&quot;d&quot;</span>);<span class="hljs-comment">//堆中对象ab</span><br>        x2.intern();<span class="hljs-comment">//尝试加入，但发现没有，加入</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">x1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;cd&quot;</span>;<span class="hljs-comment">//串池中对象cd</span><br><br>        System.out.println(x1 == x2);<span class="hljs-comment">////字符串常量池 跟 字符串常量池</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs actionscript"><span class="hljs-literal">false</span><br><span class="hljs-literal">true</span><br><span class="hljs-literal">true</span><br><span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>



<p>小结：</p>
<p>所有对象都在堆中，在堆中的常量池（HashTable）只是维护了引用，通过重写equal方法来改变对象的比较方式</p>
<h3 id="5-8-StringTable位置"><a href="#5-8-StringTable位置" class="headerlink" title="5.8 StringTable位置"></a>5.8 StringTable位置</h3><hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220731011028661.png" srcset="/img/loading.gif" lazyload alt="image-20220731011028661"></p>
<hr>
<p>证明：</p>
<p>1.6</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm;<br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 演示 StringTable 位置</span><br><span class="hljs-comment"> * 在jdk8下设置 -Xmx10m -XX:-UseGCOverheadLimit</span><br><span class="hljs-comment"> * 在jdk6下设置 -XX:MaxPermSize=10m</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo1_6</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        List&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">260000</span>; j++) &#123;<br>                list.add(String.valueOf(j).intern());<span class="hljs-comment">//将堆中的对象加入到串池中，堆中的字符串对象有被ArrayList引用，且ArrayList对象长时间存活</span><br>                i++;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            System.out.println(i);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807232615442.png" srcset="/img/loading.gif" lazyload alt="image-20220807232615442"></p>
<hr>
<p>1.8不是很严谨就不详细写了；对象存在于堆中，串池也存在于堆中，无法证明是不是因为串池中对象过多导致的OOM</p>
<h3 id="5-9-StringTable-垃圾回收"><a href="#5-9-StringTable-垃圾回收" class="headerlink" title="5.9 StringTable 垃圾回收"></a>5.9 StringTable 垃圾回收</h3><p><strong>证明</strong></p>
<p>例子1：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t1.stringtable;<br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 演示 StringTable 垃圾回收</span><br><span class="hljs-comment"> * -Xmx10m 最大堆内存</span><br><span class="hljs-comment"> * -XX:+PrintStringTableStatistics 串池的统计信息</span><br><span class="hljs-comment"> * -XX:+PrintGCDetails -verbose:gc 打印垃圾回收的详细信息</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo1_7</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">0</span>; j++) &#123; <span class="hljs-comment">// j=100, j=10000</span><br>                String.valueOf(j).intern();<br>                i++;<br>           &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            System.out.println(i);<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-number">0</span><br>内存占用情况：<br><span class="hljs-variable">Heap</span><br> <span class="hljs-variable">PSYoungGen</span>      <span class="hljs-variable">total</span> <span class="hljs-number">2560</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">used</span> <span class="hljs-number">1918</span><span class="hljs-built_in">K</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ffd00000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x0000000100000000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x0000000100000000</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-variable">eden</span> <span class="hljs-variable">space</span> <span class="hljs-number">2048</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">93</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ffd00000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ffedf868</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff00000</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-variable">from</span> <span class="hljs-variable">space</span> <span class="hljs-number">512</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff80000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff80000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x0000000100000000</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-variable">to</span>   <span class="hljs-variable">space</span> <span class="hljs-number">512</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff00000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff00000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff80000</span><span class="hljs-punctuation">)</span><br> <span class="hljs-variable">ParOldGen</span>       <span class="hljs-variable">total</span> <span class="hljs-number">7168</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">used</span> <span class="hljs-number">0</span><span class="hljs-built_in">K</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ff600000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000000ffd00000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000000ffd00000</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-variable">object</span> <span class="hljs-variable">space</span> <span class="hljs-number">7168</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ff600000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ff600000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ffd00000</span><span class="hljs-punctuation">)</span><br> <span class="hljs-variable">Metaspace</span>       <span class="hljs-variable">used</span> <span class="hljs-number">3245</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">capacity</span> <span class="hljs-number">4496</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">committed</span> <span class="hljs-number">4864</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">reserved</span> <span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><br>  <span class="hljs-variable">class</span> <span class="hljs-variable">space</span>    <span class="hljs-variable">used</span> <span class="hljs-number">352</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">capacity</span> <span class="hljs-number">388</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">committed</span> <span class="hljs-number">512</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">reserved</span> <span class="hljs-number">1048576</span><span class="hljs-built_in">K</span><br>  <br>  <br>符号表的统计信息：<br><span class="hljs-variable">SymbolTable</span> <span class="hljs-variable">statistics</span><span class="hljs-operator">:</span><br><span class="hljs-built_in">Number</span> <span class="hljs-variable">of</span> <span class="hljs-variable">buckets</span>       <span class="hljs-operator">:</span>     <span class="hljs-number">20011</span> <span class="hljs-operator">=</span>    <span class="hljs-number">160088</span> <span class="hljs-variable">bytes</span><span class="hljs-operator">,</span> <span class="hljs-variable">avg</span>   <span class="hljs-number">8.000</span><br><span class="hljs-built_in">Number</span> <span class="hljs-variable">of</span> <span class="hljs-variable">entries</span>       <span class="hljs-operator">:</span>     <span class="hljs-number">13247</span> <span class="hljs-operator">=</span>    <span class="hljs-number">317928</span> <span class="hljs-variable">bytes</span><span class="hljs-operator">,</span> <span class="hljs-variable">avg</span>  <span class="hljs-number">24.000</span><br><span class="hljs-built_in">Number</span> <span class="hljs-variable">of</span> <span class="hljs-variable">literals</span>      <span class="hljs-operator">:</span>     <span class="hljs-number">13247</span> <span class="hljs-operator">=</span>    <span class="hljs-number">589032</span> <span class="hljs-variable">bytes</span><span class="hljs-operator">,</span> <span class="hljs-variable">avg</span>  <span class="hljs-number">44.465</span><br><span class="hljs-built_in">Total</span> <span class="hljs-variable">footprint</span>         <span class="hljs-operator">:</span>           <span class="hljs-operator">=</span>   <span class="hljs-number">1067048</span> <span class="hljs-variable">bytes</span><br><span class="hljs-variable">Average</span> <span class="hljs-variable">bucket</span> <span class="hljs-variable">size</span>     <span class="hljs-operator">:</span>     <span class="hljs-number">0.662</span><br><span class="hljs-built_in">Variance</span> <span class="hljs-variable">of</span> <span class="hljs-variable">bucket</span> <span class="hljs-variable">size</span> <span class="hljs-operator">:</span>     <span class="hljs-number">0.663</span><br><span class="hljs-variable">Std</span><span class="hljs-operator">.</span> <span class="hljs-variable">dev</span><span class="hljs-operator">.</span> <span class="hljs-variable">of</span> <span class="hljs-variable">bucket</span> <span class="hljs-variable">size</span><span class="hljs-operator">:</span>     <span class="hljs-number">0.814</span><br><span class="hljs-variable">Maximum</span> <span class="hljs-variable">bucket</span> <span class="hljs-variable">size</span>     <span class="hljs-operator">:</span>         <span class="hljs-number">6</span><br><br>字符串常量池的统计信息：<br><span class="hljs-variable">StringTable</span> <span class="hljs-variable">statistics</span><span class="hljs-operator">:</span><br><span class="hljs-built_in">Number</span> <span class="hljs-variable">of</span> <span class="hljs-variable">buckets</span>       <span class="hljs-operator">:</span>     <span class="hljs-number">60013</span> <span class="hljs-operator">=</span>    <span class="hljs-number">480104</span> <span class="hljs-variable">bytes</span><span class="hljs-operator">,</span> <span class="hljs-variable">avg</span>   <span class="hljs-number">8.000</span> <span class="hljs-operator">//</span><span class="hljs-variable">hash</span>表中数组元素个数<br><span class="hljs-built_in">Number</span> <span class="hljs-variable">of</span> <span class="hljs-variable">entries</span>       <span class="hljs-operator">:</span>      <span class="hljs-number">1761</span> <span class="hljs-operator">=</span>     <span class="hljs-number">42264</span> <span class="hljs-variable">bytes</span><span class="hljs-operator">,</span> <span class="hljs-variable">avg</span>  <span class="hljs-number">24.000</span> <span class="hljs-operator">//</span>键值对个数<br><span class="hljs-built_in">Number</span> <span class="hljs-variable">of</span> <span class="hljs-variable">literals</span>      <span class="hljs-operator">:</span>      <span class="hljs-number">1761</span> <span class="hljs-operator">=</span>    <span class="hljs-number">178736</span> <span class="hljs-variable">bytes</span><span class="hljs-operator">,</span> <span class="hljs-variable">avg</span> <span class="hljs-number">101.497</span> <span class="hljs-operator">//</span>字符串个数<br><span class="hljs-built_in">Total</span> <span class="hljs-variable">footprint</span>         <span class="hljs-operator">:</span>           <span class="hljs-operator">=</span>    <span class="hljs-number">701104</span> <span class="hljs-variable">bytes</span><br><span class="hljs-variable">Average</span> <span class="hljs-variable">bucket</span> <span class="hljs-variable">size</span>     <span class="hljs-operator">:</span>     <span class="hljs-number">0.029</span><br><span class="hljs-built_in">Variance</span> <span class="hljs-variable">of</span> <span class="hljs-variable">bucket</span> <span class="hljs-variable">size</span> <span class="hljs-operator">:</span>     <span class="hljs-number">0.029</span><br><span class="hljs-variable">Std</span><span class="hljs-operator">.</span> <span class="hljs-variable">dev</span><span class="hljs-operator">.</span> <span class="hljs-variable">of</span> <span class="hljs-variable">bucket</span> <span class="hljs-variable">size</span><span class="hljs-operator">:</span>     <span class="hljs-number">0.172</span><br><span class="hljs-variable">Maximum</span> <span class="hljs-variable">bucket</span> <span class="hljs-variable">size</span>     <span class="hljs-operator">:</span>         <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure>



<p>改变后，例子2：</p>
<p>没有进行垃圾回收</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t1.stringtable;<br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 演示 StringTable 垃圾回收</span><br><span class="hljs-comment"> * -Xmx10m 最大堆内存</span><br><span class="hljs-comment"> * -XX:+PrintStringTableStatistics 串池的统计信息</span><br><span class="hljs-comment"> * -XX:+PrintGCDetails -verbose:gc 打印垃圾回收的详细信息</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo1_7</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">100</span>; j++) &#123; <span class="hljs-comment">// j=100, j=10000</span><br>                String.valueOf(j).intern();<br>                i++;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            System.out.println(i);<br>        &#125;<br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-number">100</span><br><span class="hljs-variable">Heap</span><br> <span class="hljs-variable">PSYoungGen</span>      <span class="hljs-variable">total</span> <span class="hljs-number">2560</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">used</span> <span class="hljs-number">1834</span><span class="hljs-built_in">K</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ffd00000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x0000000100000000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x0000000100000000</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-variable">eden</span> <span class="hljs-variable">space</span> <span class="hljs-number">2048</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">89</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ffd00000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ffeca9b8</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff00000</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-variable">from</span> <span class="hljs-variable">space</span> <span class="hljs-number">512</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff80000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff80000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x0000000100000000</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-variable">to</span>   <span class="hljs-variable">space</span> <span class="hljs-number">512</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff00000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff00000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff80000</span><span class="hljs-punctuation">)</span><br> <span class="hljs-variable">ParOldGen</span>       <span class="hljs-variable">total</span> <span class="hljs-number">7168</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">used</span> <span class="hljs-number">0</span><span class="hljs-built_in">K</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ff600000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000000ffd00000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000000ffd00000</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-variable">object</span> <span class="hljs-variable">space</span> <span class="hljs-number">7168</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ff600000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ff600000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ffd00000</span><span class="hljs-punctuation">)</span><br> <span class="hljs-variable">Metaspace</span>       <span class="hljs-variable">used</span> <span class="hljs-number">3157</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">capacity</span> <span class="hljs-number">4496</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">committed</span> <span class="hljs-number">4864</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">reserved</span> <span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><br>  <span class="hljs-variable">class</span> <span class="hljs-variable">space</span>    <span class="hljs-variable">used</span> <span class="hljs-number">344</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">capacity</span> <span class="hljs-number">388</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">committed</span> <span class="hljs-number">512</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">reserved</span> <span class="hljs-number">1048576</span><span class="hljs-built_in">K</span><br><span class="hljs-variable">SymbolTable</span> <span class="hljs-variable">statistics</span><span class="hljs-operator">:</span><br><span class="hljs-built_in">Number</span> <span class="hljs-variable">of</span> <span class="hljs-variable">buckets</span>       <span class="hljs-operator">:</span>     <span class="hljs-number">20011</span> <span class="hljs-operator">=</span>    <span class="hljs-number">160088</span> <span class="hljs-variable">bytes</span><span class="hljs-operator">,</span> <span class="hljs-variable">avg</span>   <span class="hljs-number">8.000</span><br><span class="hljs-built_in">Number</span> <span class="hljs-variable">of</span> <span class="hljs-variable">entries</span>       <span class="hljs-operator">:</span>     <span class="hljs-number">13060</span> <span class="hljs-operator">=</span>    <span class="hljs-number">313440</span> <span class="hljs-variable">bytes</span><span class="hljs-operator">,</span> <span class="hljs-variable">avg</span>  <span class="hljs-number">24.000</span><br><span class="hljs-built_in">Number</span> <span class="hljs-variable">of</span> <span class="hljs-variable">literals</span>      <span class="hljs-operator">:</span>     <span class="hljs-number">13060</span> <span class="hljs-operator">=</span>    <span class="hljs-number">583496</span> <span class="hljs-variable">bytes</span><span class="hljs-operator">,</span> <span class="hljs-variable">avg</span>  <span class="hljs-number">44.678</span><br><span class="hljs-built_in">Total</span> <span class="hljs-variable">footprint</span>         <span class="hljs-operator">:</span>           <span class="hljs-operator">=</span>   <span class="hljs-number">1057024</span> <span class="hljs-variable">bytes</span><br><span class="hljs-variable">Average</span> <span class="hljs-variable">bucket</span> <span class="hljs-variable">size</span>     <span class="hljs-operator">:</span>     <span class="hljs-number">0.653</span><br><span class="hljs-built_in">Variance</span> <span class="hljs-variable">of</span> <span class="hljs-variable">bucket</span> <span class="hljs-variable">size</span> <span class="hljs-operator">:</span>     <span class="hljs-number">0.653</span><br><span class="hljs-variable">Std</span><span class="hljs-operator">.</span> <span class="hljs-variable">dev</span><span class="hljs-operator">.</span> <span class="hljs-variable">of</span> <span class="hljs-variable">bucket</span> <span class="hljs-variable">size</span><span class="hljs-operator">:</span>     <span class="hljs-number">0.808</span><br><span class="hljs-variable">Maximum</span> <span class="hljs-variable">bucket</span> <span class="hljs-variable">size</span>     <span class="hljs-operator">:</span>         <span class="hljs-number">6</span><br><span class="hljs-variable">StringTable</span> <span class="hljs-variable">statistics</span><span class="hljs-operator">:</span><br><span class="hljs-built_in">Number</span> <span class="hljs-variable">of</span> <span class="hljs-variable">buckets</span>       <span class="hljs-operator">:</span>     <span class="hljs-number">60013</span> <span class="hljs-operator">=</span>    <span class="hljs-number">480104</span> <span class="hljs-variable">bytes</span><span class="hljs-operator">,</span> <span class="hljs-variable">avg</span>   <span class="hljs-number">8.000</span><br><span class="hljs-built_in">Number</span> <span class="hljs-variable">of</span> <span class="hljs-variable">entries</span>       <span class="hljs-operator">:</span>      <span class="hljs-number">1842</span> <span class="hljs-operator">=</span>     <span class="hljs-number">44208</span> <span class="hljs-variable">bytes</span><span class="hljs-operator">,</span> <span class="hljs-variable">avg</span>  <span class="hljs-number">24.000</span><br><span class="hljs-built_in">Number</span> <span class="hljs-variable">of</span> <span class="hljs-variable">literals</span>      <span class="hljs-operator">:</span>      <span class="hljs-number">1842</span> <span class="hljs-operator">=</span>    <span class="hljs-number">182384</span> <span class="hljs-variable">bytes</span><span class="hljs-operator">,</span> <span class="hljs-variable">avg</span>  <span class="hljs-number">99.014</span><br><span class="hljs-built_in">Total</span> <span class="hljs-variable">footprint</span>         <span class="hljs-operator">:</span>           <span class="hljs-operator">=</span>    <span class="hljs-number">706696</span> <span class="hljs-variable">bytes</span><br><span class="hljs-variable">Average</span> <span class="hljs-variable">bucket</span> <span class="hljs-variable">size</span>     <span class="hljs-operator">:</span>     <span class="hljs-number">0.031</span><br><span class="hljs-built_in">Variance</span> <span class="hljs-variable">of</span> <span class="hljs-variable">bucket</span> <span class="hljs-variable">size</span> <span class="hljs-operator">:</span>     <span class="hljs-number">0.031</span><br><span class="hljs-variable">Std</span><span class="hljs-operator">.</span> <span class="hljs-variable">dev</span><span class="hljs-operator">.</span> <span class="hljs-variable">of</span> <span class="hljs-variable">bucket</span> <span class="hljs-variable">size</span><span class="hljs-operator">:</span>     <span class="hljs-number">0.175</span><br><span class="hljs-variable">Maximum</span> <span class="hljs-variable">bucket</span> <span class="hljs-variable">size</span>     <span class="hljs-operator">:</span>         <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure>





<p>改变后，例子3：</p>
<p>有发生垃圾回收；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t1.stringtable;<br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 演示 StringTable 垃圾回收</span><br><span class="hljs-comment"> * -Xmx10m 最大堆内存</span><br><span class="hljs-comment"> * -XX:+PrintStringTableStatistics 串池的统计信息</span><br><span class="hljs-comment"> * -XX:+PrintGCDetails -verbose:gc 打印垃圾回收的详细信息</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo1_7</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">10000</span>; j++) &#123; <span class="hljs-comment">// j=100, j=10000</span><br>                String.valueOf(j).intern();<br>                i++;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            System.out.println(i);<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">2048</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">488</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">2560</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">2048</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">763</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">9728</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0005872</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span>  <span class="hljs-operator">//</span>发生了一次新生代的垃圾回收<br><span class="hljs-number">10000</span><br><span class="hljs-variable">Heap</span><br> <span class="hljs-variable">PSYoungGen</span>      <span class="hljs-variable">total</span> <span class="hljs-number">2560</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">used</span> <span class="hljs-number">775</span><span class="hljs-built_in">K</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ffd00000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x0000000100000000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x0000000100000000</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-variable">eden</span> <span class="hljs-variable">space</span> <span class="hljs-number">2048</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">14</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ffd00000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ffd47d70</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff00000</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-variable">from</span> <span class="hljs-variable">space</span> <span class="hljs-number">512</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">95</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff00000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff7a020</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff80000</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-variable">to</span>   <span class="hljs-variable">space</span> <span class="hljs-number">512</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff80000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff80000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x0000000100000000</span><span class="hljs-punctuation">)</span><br> <span class="hljs-variable">ParOldGen</span>       <span class="hljs-variable">total</span> <span class="hljs-number">7168</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">used</span> <span class="hljs-number">275</span><span class="hljs-built_in">K</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ff600000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000000ffd00000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000000ffd00000</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-variable">object</span> <span class="hljs-variable">space</span> <span class="hljs-number">7168</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">3</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ff600000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ff644c70</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ffd00000</span><span class="hljs-punctuation">)</span><br> <span class="hljs-variable">Metaspace</span>       <span class="hljs-variable">used</span> <span class="hljs-number">3247</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">capacity</span> <span class="hljs-number">4496</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">committed</span> <span class="hljs-number">4864</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">reserved</span> <span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><br>  <span class="hljs-variable">class</span> <span class="hljs-variable">space</span>    <span class="hljs-variable">used</span> <span class="hljs-number">352</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">capacity</span> <span class="hljs-number">388</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">committed</span> <span class="hljs-number">512</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">reserved</span> <span class="hljs-number">1048576</span><span class="hljs-built_in">K</span><br><span class="hljs-variable">SymbolTable</span> <span class="hljs-variable">statistics</span><span class="hljs-operator">:</span><br><span class="hljs-built_in">Number</span> <span class="hljs-variable">of</span> <span class="hljs-variable">buckets</span>       <span class="hljs-operator">:</span>     <span class="hljs-number">20011</span> <span class="hljs-operator">=</span>    <span class="hljs-number">160088</span> <span class="hljs-variable">bytes</span><span class="hljs-operator">,</span> <span class="hljs-variable">avg</span>   <span class="hljs-number">8.000</span><br><span class="hljs-built_in">Number</span> <span class="hljs-variable">of</span> <span class="hljs-variable">entries</span>       <span class="hljs-operator">:</span>     <span class="hljs-number">13247</span> <span class="hljs-operator">=</span>    <span class="hljs-number">317928</span> <span class="hljs-variable">bytes</span><span class="hljs-operator">,</span> <span class="hljs-variable">avg</span>  <span class="hljs-number">24.000</span><br><span class="hljs-built_in">Number</span> <span class="hljs-variable">of</span> <span class="hljs-variable">literals</span>      <span class="hljs-operator">:</span>     <span class="hljs-number">13247</span> <span class="hljs-operator">=</span>    <span class="hljs-number">589032</span> <span class="hljs-variable">bytes</span><span class="hljs-operator">,</span> <span class="hljs-variable">avg</span>  <span class="hljs-number">44.465</span><br><span class="hljs-built_in">Total</span> <span class="hljs-variable">footprint</span>         <span class="hljs-operator">:</span>           <span class="hljs-operator">=</span>   <span class="hljs-number">1067048</span> <span class="hljs-variable">bytes</span><br><span class="hljs-variable">Average</span> <span class="hljs-variable">bucket</span> <span class="hljs-variable">size</span>     <span class="hljs-operator">:</span>     <span class="hljs-number">0.662</span><br><span class="hljs-built_in">Variance</span> <span class="hljs-variable">of</span> <span class="hljs-variable">bucket</span> <span class="hljs-variable">size</span> <span class="hljs-operator">:</span>     <span class="hljs-number">0.663</span><br><span class="hljs-variable">Std</span><span class="hljs-operator">.</span> <span class="hljs-variable">dev</span><span class="hljs-operator">.</span> <span class="hljs-variable">of</span> <span class="hljs-variable">bucket</span> <span class="hljs-variable">size</span><span class="hljs-operator">:</span>     <span class="hljs-number">0.814</span><br><span class="hljs-variable">Maximum</span> <span class="hljs-variable">bucket</span> <span class="hljs-variable">size</span>     <span class="hljs-operator">:</span>         <span class="hljs-number">6</span><br><span class="hljs-variable">StringTable</span> <span class="hljs-variable">statistics</span><span class="hljs-operator">:</span><br><span class="hljs-built_in">Number</span> <span class="hljs-variable">of</span> <span class="hljs-variable">buckets</span>       <span class="hljs-operator">:</span>     <span class="hljs-number">60013</span> <span class="hljs-operator">=</span>    <span class="hljs-number">480104</span> <span class="hljs-variable">bytes</span><span class="hljs-operator">,</span> <span class="hljs-variable">avg</span>   <span class="hljs-number">8.000</span><br><span class="hljs-built_in">Number</span> <span class="hljs-variable">of</span> <span class="hljs-variable">entries</span>       <span class="hljs-operator">:</span>      <span class="hljs-number">7074</span> <span class="hljs-operator">=</span>    <span class="hljs-number">169776</span> <span class="hljs-variable">bytes</span><span class="hljs-operator">,</span> <span class="hljs-variable">avg</span>  <span class="hljs-number">24.000</span><br><span class="hljs-built_in">Number</span> <span class="hljs-variable">of</span> <span class="hljs-variable">literals</span>      <span class="hljs-operator">:</span>      <span class="hljs-number">7074</span> <span class="hljs-operator">=</span>    <span class="hljs-number">433712</span> <span class="hljs-variable">bytes</span><span class="hljs-operator">,</span> <span class="hljs-variable">avg</span>  <span class="hljs-number">61.311</span><br><span class="hljs-built_in">Total</span> <span class="hljs-variable">footprint</span>         <span class="hljs-operator">:</span>           <span class="hljs-operator">=</span>   <span class="hljs-number">1083592</span> <span class="hljs-variable">bytes</span><br><span class="hljs-variable">Average</span> <span class="hljs-variable">bucket</span> <span class="hljs-variable">size</span>     <span class="hljs-operator">:</span>     <span class="hljs-number">0.118</span><br><span class="hljs-built_in">Variance</span> <span class="hljs-variable">of</span> <span class="hljs-variable">bucket</span> <span class="hljs-variable">size</span> <span class="hljs-operator">:</span>     <span class="hljs-number">0.121</span><br><span class="hljs-variable">Std</span><span class="hljs-operator">.</span> <span class="hljs-variable">dev</span><span class="hljs-operator">.</span> <span class="hljs-variable">of</span> <span class="hljs-variable">bucket</span> <span class="hljs-variable">size</span><span class="hljs-operator">:</span>     <span class="hljs-number">0.347</span><br><span class="hljs-variable">Maximum</span> <span class="hljs-variable">bucket</span> <span class="hljs-variable">size</span>     <span class="hljs-operator">:</span>         <span class="hljs-number">3</span><br></code></pre></td></tr></table></figure>







<h3 id="5-10-StringTable-性能调优"><a href="#5-10-StringTable-性能调优" class="headerlink" title="5.10 StringTable 性能调优"></a>5.10 StringTable 性能调优</h3><ul>
<li><strong>调整 -XX:StringTableSize&#x3D;桶个数</strong></li>
</ul>
<p>例子1：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t1.stringtable;<br><br><span class="hljs-keyword">import</span> java.io.BufferedReader;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InputStreamReader;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 演示串池大小对性能的影响</span><br><span class="hljs-comment"> * -Xms500m 堆的最小容量</span><br><span class="hljs-comment"> * -Xmx500m 堆的最大容量</span><br><span class="hljs-comment"> * -XX:+PrintStringTableStatistics</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo1_24</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">BufferedReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;linux.words&quot;</span>), <span class="hljs-string">&quot;utf-8&quot;</span>))) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">line</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.nanoTime();<br>            <span class="hljs-comment">//1秒等于1000毫秒、1毫秒等于1000微秒、1微秒等于1000纳秒、1纳秒等于1000皮秒</span><br>            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>                line = reader.readLine();<br>                <span class="hljs-keyword">if</span> (line == <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>                line.intern();<br>            &#125;<br>            System.out.println(<span class="hljs-string">&quot;cost:&quot;</span> + (System.nanoTime() - start) / <span class="hljs-number">1000000</span>);<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<p>linux.words</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807232632245.png" srcset="/img/loading.gif" lazyload alt="image-20220807232632245"></p>
<hr>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">cost</span>:<span class="hljs-number">248</span>   //<span class="hljs-number">0</span>.<span class="hljs-number">2</span>秒<br><span class="hljs-attribute">SymbolTable</span> statistics:<br><span class="hljs-attribute">Number</span> of buckets       :     <span class="hljs-number">20011</span> =    <span class="hljs-number">160088</span> bytes, avg   <span class="hljs-number">8</span>.<span class="hljs-number">000</span><br><span class="hljs-attribute">Number</span> of entries       :     <span class="hljs-number">13250</span> =    <span class="hljs-number">318000</span> bytes, avg  <span class="hljs-number">24</span>.<span class="hljs-number">000</span><br><span class="hljs-attribute">Number</span> of literals      :     <span class="hljs-number">13250</span> =    <span class="hljs-number">589096</span> bytes, avg  <span class="hljs-number">44</span>.<span class="hljs-number">460</span><br><span class="hljs-attribute">Total</span> footprint         :           =   <span class="hljs-number">1067184</span> bytes<br><span class="hljs-attribute">Average</span> bucket size     :     <span class="hljs-number">0</span>.<span class="hljs-number">662</span><br><span class="hljs-attribute">Variance</span> of bucket size :     <span class="hljs-number">0</span>.<span class="hljs-number">663</span><br><span class="hljs-attribute">Std</span>. dev. of bucket size:     <span class="hljs-number">0</span>.<span class="hljs-number">814</span><br><span class="hljs-attribute">Maximum</span> bucket size     :         <span class="hljs-number">6</span><br><span class="hljs-attribute">StringTable</span> statistics:<br><span class="hljs-attribute">Number</span> of buckets       :     <span class="hljs-number">60013</span> =    <span class="hljs-number">480104</span> bytes, avg   <span class="hljs-number">8</span>.<span class="hljs-number">000</span> //默认六万个桶，即数组容量为<span class="hljs-number">60013</span>个<br><span class="hljs-attribute">Number</span> of entries       :    <span class="hljs-number">481502</span> =  <span class="hljs-number">11556048</span> bytes, avg  <span class="hljs-number">24</span>.<span class="hljs-number">000</span><br><span class="hljs-attribute">Number</span> of literals      :    <span class="hljs-number">481502</span> =  <span class="hljs-number">29751672</span> bytes, avg  <span class="hljs-number">61</span>.<span class="hljs-number">789</span><br><span class="hljs-attribute">Total</span> footprint         :           =  <span class="hljs-number">41787824</span> bytes<br><span class="hljs-attribute">Average</span> bucket size     :     <span class="hljs-number">8</span>.<span class="hljs-number">023</span><br><span class="hljs-attribute">Variance</span> of bucket size :     <span class="hljs-number">8</span>.<span class="hljs-number">085</span><br><span class="hljs-attribute">Std</span>. dev. of bucket size:     <span class="hljs-number">2</span>.<span class="hljs-number">843</span><br><span class="hljs-attribute">Maximum</span> bucket size     :        <span class="hljs-number">23</span><br></code></pre></td></tr></table></figure>



<p>例子2：</p>
<p>设置JVM参数：</p>
<blockquote>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">-XX:<span class="hljs-attribute">StringTableSize</span>=1009<br></code></pre></td></tr></table></figure>
</blockquote>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807232646414.png" srcset="/img/loading.gif" lazyload alt="image-20220807232646414"></p>
<hr>
<p>例子3：</p>
<p>设置JVM参数</p>
<blockquote>
<p>-XX:StringTableSize&#x3D;20 0000</p>
</blockquote>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807232658253.png" srcset="/img/loading.gif" lazyload alt="image-20220807232658253"></p>
<hr>
<p>小结：</p>
<p>通过设置JVM参数，使得串池桶的个数变大，这样可以减少hash碰撞概率，提升效率</p>
<ul>
<li><strong>考虑将字符串对象是否入池</strong></li>
</ul>
<p>不入</p>
<p>1、运行程序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo1_25</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br><br>        List&lt;String&gt; address = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        System.in.read();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>            <span class="hljs-keyword">try</span> (<span class="hljs-type">BufferedReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;linux.words&quot;</span>), <span class="hljs-string">&quot;utf-8&quot;</span>))) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">line</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>                <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.nanoTime();<br>                <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>                    line = reader.readLine();<br>                    <span class="hljs-keyword">if</span>(line == <span class="hljs-literal">null</span>) &#123;<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125;<br>                    address.add(line);<br>                &#125;<br>                System.out.println(<span class="hljs-string">&quot;cost:&quot;</span> +(System.nanoTime()-start)/<span class="hljs-number">1000000</span>);<br>            &#125;<br>        &#125;<br>        System.in.read();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>2、打开jvisualvm</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807232711018.png" srcset="/img/loading.gif" lazyload alt="image-20220807232711018"></p>
<hr>
<p>3、一次回车（读取十次文件）</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220731142800069.png" srcset="/img/loading.gif" lazyload alt="image-20220731142800069"></p>
<hr>
<p>进入串池</p>
<p>1、运行代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo1_25</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br><br>        List&lt;String&gt; address = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        System.in.read();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>            <span class="hljs-keyword">try</span> (<span class="hljs-type">BufferedReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;linux.words&quot;</span>), <span class="hljs-string">&quot;utf-8&quot;</span>))) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">line</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>                <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.nanoTime();<br>                <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>                    line = reader.readLine();<br>                    <span class="hljs-keyword">if</span>(line == <span class="hljs-literal">null</span>) &#123;<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125;<br>                    address.add(line.intern());<br>                &#125;<br>                System.out.println(<span class="hljs-string">&quot;cost:&quot;</span> +(System.nanoTime()-start)/<span class="hljs-number">1000000</span>);<br>            &#125;<br>        &#125;<br>        System.in.read();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>2、打开jvisualvm</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220731143040775.png" srcset="/img/loading.gif" lazyload alt="image-20220731143040775"></p>
<hr>
<p>3、一次回车（读取十次文件）</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220731143254742.png" srcset="/img/loading.gif" lazyload alt="image-20220731143254742"></p>
<hr>
<h2 id="6-0-直接内存"><a href="#6-0-直接内存" class="headerlink" title="6.0 直接内存"></a>6.0 直接内存</h2><h3 id="6-1-定义"><a href="#6-1-定义" class="headerlink" title="6.1 定义"></a>6.1 定义</h3><p>Direct Memory 常见于 NIO 操作时，用于数据缓冲区 </p>
<p>这个直接内存，是属于操作系统的内存，java想要分配和释放都比较缓慢</p>
<p>分配回收成本较高，但读写性能高 </p>
<p>传统阻塞IO与NIO的比较</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t1.direct;<br><br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.nio.ByteBuffer;<br><span class="hljs-keyword">import</span> java.nio.channels.FileChannel;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 演示 ByteBuffer 作用</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo1_9</span> &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">FROM</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;D:\\BaiduNetdiskDownload\\146.消息中间件-RocketMQ06.mp4&quot;</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TO</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;D:\\146.消息中间件-RocketMQ06.mp4&quot;</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_1Mb</span> <span class="hljs-operator">=</span> <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        io(); <span class="hljs-comment">// io 用时：1535.586957 1766.963399 1359.240226</span><br>        directBuffer(); <span class="hljs-comment">// directBuffer 用时：479.295165 702.291454 562.56592</span><br>    &#125;<br><br><br>    <span class="hljs-comment">//使用直接内存的NIO</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">directBuffer</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.nanoTime();<br>        <span class="hljs-keyword">try</span> (<br>             <span class="hljs-type">FileChannel</span> <span class="hljs-variable">from</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(FROM).getChannel();<br>             <span class="hljs-type">FileChannel</span> <span class="hljs-variable">to</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(TO).getChannel();<br>        ) &#123;<br>            <span class="hljs-comment">//由操作系统分配一块直接内存 （该内存操作系统和java代码可以直接访问 ）</span><br>            <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">bb</span> <span class="hljs-operator">=</span> ByteBuffer.allocateDirect(_1Mb);<br>            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> from.read(bb);<br>                <span class="hljs-keyword">if</span> (len == -<span class="hljs-number">1</span>) &#123;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>                bb.flip();<br>                to.write(bb);<br>                bb.clear();<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> System.nanoTime();<br>        System.out.println(<span class="hljs-string">&quot;directBuffer 用时：&quot;</span> + (end - start) / <span class="hljs-number">1000_000.0</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//使用传统的IO</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">io</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.nanoTime();<br>        <span class="hljs-keyword">try</span> (<br>             <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">from</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(FROM);<br>             <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">to</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(TO);<br>        ) &#123;<br>            <span class="hljs-type">byte</span>[] buf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[_1Mb];<br>            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> from.read(buf);<br>                <span class="hljs-keyword">if</span> (len == -<span class="hljs-number">1</span>) &#123;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>                to.write(buf, <span class="hljs-number">0</span>, len);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> System.nanoTime();<br>        System.out.println(<span class="hljs-string">&quot;io 用时：&quot;</span> + (end - start) / <span class="hljs-number">1000_000.0</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">io</span> 用时：<span class="hljs-number">936</span>.<span class="hljs-number">9851</span>   //<span class="hljs-number">0</span>.<span class="hljs-number">9</span>s<br><span class="hljs-attribute">directBuffer</span> 用时：<span class="hljs-number">504</span>.<span class="hljs-number">2338</span>  //<span class="hljs-number">0</span>.<span class="hljs-number">5</span>s<br></code></pre></td></tr></table></figure>

<p>解释读取大文件时，直接内存会更快</p>
<p><strong>使用传统IO</strong></p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220731151152900.png" srcset="/img/loading.gif" lazyload alt="image-20220731151152900"></p>
<hr>
<p>java代码无法直接操作底层 文件IO，只能通过调用本地方法间接实现；</p>
<p>CPU分为两种状态：用户态，和内核态</p>
<p>内存也分为两种：JVM中的堆内存和系统内存</p>
<p>java无法直接获取到系统内存中的数据，只能先将系统内存中的数据复制一份到堆内存中，再操作堆内存中的数据</p>
<p>此时，读取一份文件需要复制两次</p>
<p><strong>使用了DirectBuffer</strong></p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220731151853223.png" srcset="/img/loading.gif" lazyload alt="image-20220731151853223"></p>
<hr>
<p>由操作系统分配一块直接内存 （该内存操作系统和java代码可以直接访问 ）</p>
<p>比传统IO少了一次复制操作，效率更高；</p>
<p><strong>不受 JVM 内存回收管理</strong></p>
<p>例子1：（演示直接内存溢出）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t1.direct;<br><br><span class="hljs-keyword">import</span> java.nio.ByteBuffer;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 演示直接内存溢出</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo1_10</span> &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">_100Mb</span> <span class="hljs-operator">=</span> <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">100</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        List&lt;ByteBuffer&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>                <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">byteBuffer</span> <span class="hljs-operator">=</span> ByteBuffer.allocateDirect(_100Mb);<br>                list.add(byteBuffer);<br>                i++;<br>            &#125;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            System.out.println(i);<br>        &#125;<br>        <span class="hljs-comment">// 方法区是jvm规范， jdk6 中对方法区的实现称为永久代</span><br>        <span class="hljs-comment">//                  jdk8 对方法区的实现称为元空间</span><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220731160632622.png" srcset="/img/loading.gif" lazyload alt="image-20220731160632622"></p>
<hr>
<p>演示垃圾回收ByteBuffer对象</p>
<p>1、还没运行程序</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220731161433975.png" srcset="/img/loading.gif" lazyload alt="image-20220731161433975"></p>
<hr>
<p>2、运行程序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t1.direct;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.nio.ByteBuffer;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo1_26</span> &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">_1Gb</span> <span class="hljs-operator">=</span> <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">byteBuffer</span> <span class="hljs-operator">=</span> ByteBuffer.allocateDirect(_1Gb);<br>        System.out.println(<span class="hljs-string">&quot;分配完毕...&quot;</span>);<br>        System.in.read();<br>        System.out.println(<span class="hljs-string">&quot;开始释放...&quot;</span>);<br>        byteBuffer = <span class="hljs-literal">null</span>;<br>        System.gc(); <span class="hljs-comment">// 显式的垃圾回收，Full GC</span><br>        System.in.read();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<p><img src="http://fgcy-pic.zhamao.ml/image-20220731161525406.png" srcset="/img/loading.gif" lazyload alt="image-20220731161525406"></p>
<hr>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220731161757573.png" srcset="/img/loading.gif" lazyload alt="image-20220731161757573"></p>
<hr>
<p>3、控制台敲回车</p>
<hr>
<p><img src="http://fgcy-pic.zhamao.ml/image-20220731161837777.png" srcset="/img/loading.gif" lazyload alt="image-20220731161837777"></p>
<hr>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220731161938357.png" srcset="/img/loading.gif" lazyload alt="image-20220731161938357"></p>
<hr>
<p><strong>不是说不受JVM内存回收管理嘛？</strong></p>
<p>解释如下：</p>
<h3 id="6-2-分配和回收原理"><a href="#6-2-分配和回收原理" class="headerlink" title="6.2 分配和回收原理"></a>6.2 分配和回收原理</h3><p>使用了 Unsafe 对象完成直接内存的分配回收，并且回收需要主动调用 freeMemory 方法 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t1.direct;<br><br><span class="hljs-keyword">import</span> sun.misc.Unsafe;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 直接内存分配的底层原理：Unsafe</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo1_27</span> &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">_1Gb</span> <span class="hljs-operator">=</span> <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">Unsafe</span> <span class="hljs-variable">unsafe</span> <span class="hljs-operator">=</span> getUnsafe();<br>        <span class="hljs-comment">// 分配内存</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">base</span> <span class="hljs-operator">=</span> unsafe.allocateMemory(_1Gb);<br>        unsafe.setMemory(base, _1Gb, (<span class="hljs-type">byte</span>) <span class="hljs-number">0</span>);<br>        System.in.read();<br><br>        <span class="hljs-comment">// 释放内存</span><br>        unsafe.freeMemory(base);<br>        System.in.read();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Unsafe <span class="hljs-title function_">getUnsafe</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> Unsafe.class.getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>            f.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-type">Unsafe</span> <span class="hljs-variable">unsafe</span> <span class="hljs-operator">=</span> (Unsafe) f.get(<span class="hljs-literal">null</span>);<br>            <span class="hljs-keyword">return</span> unsafe;<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<p>一开始</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220731163440228.png" srcset="/img/loading.gif" lazyload alt="image-20220731163440228"></p>
<hr>
<p>运行程序</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220731163541095.png" srcset="/img/loading.gif" lazyload alt="image-20220731163541095"></p>
<hr>
<p>敲回车，释放内存</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220731163641246.png" srcset="/img/loading.gif" lazyload alt="image-20220731163641246"></p>
<hr>
<p>ByteBuffer源码分析</p>
<p>通过ByteBuffer类的静态allocateDirect方法，分配1个G的直接内存</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">byteBuffer</span> <span class="hljs-operator">=</span> ByteBuffer.allocateDirect(_1Gb);<br></code></pre></td></tr></table></figure>



<p>查看<code>allocateDirect方法</code>，该方法调用了DirectByteBuffer类的构造方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ByteBuffer <span class="hljs-title function_">allocateDirect</span><span class="hljs-params">(<span class="hljs-type">int</span> capacity)</span> &#123;<br>     <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DirectByteBuffer</span>(capacity);<br> &#125;<br></code></pre></td></tr></table></figure>



<p>查看DirectByteBuffer的构造方法，该构造方法中通过unsafe对象创建了直接内存</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Primary constructor</span><br><span class="hljs-comment">//</span><br>DirectByteBuffer(<span class="hljs-type">int</span> cap) &#123;                   <span class="hljs-comment">// package-private</span><br><br>    <span class="hljs-built_in">super</span>(-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, cap, cap);<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">pa</span> <span class="hljs-operator">=</span> VM.isDirectMemoryPageAligned();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">ps</span> <span class="hljs-operator">=</span> Bits.pageSize();<br>    <span class="hljs-type">long</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> Math.max(<span class="hljs-number">1L</span>, (<span class="hljs-type">long</span>)cap + (pa ? ps : <span class="hljs-number">0</span>));<br>    Bits.reserveMemory(size, cap);<br><br>    <span class="hljs-type">long</span> <span class="hljs-variable">base</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        base = unsafe.allocateMemory(size);   <span class="hljs-comment">//使用unsafe对象实现直接内存的创建1</span><br>    &#125; <span class="hljs-keyword">catch</span> (OutOfMemoryError x) &#123;<br>        Bits.unreserveMemory(size, cap);<br>        <span class="hljs-keyword">throw</span> x;<br>    &#125;<br>    unsafe.setMemory(base, size, (<span class="hljs-type">byte</span>) <span class="hljs-number">0</span>);   <span class="hljs-comment">//使用unsafe对象实现直接内存的创建2</span><br>    <span class="hljs-keyword">if</span> (pa &amp;&amp; (base % ps != <span class="hljs-number">0</span>)) &#123;<br>        <span class="hljs-comment">// Round up to page boundary</span><br>        address = base + ps - (base &amp; (ps - <span class="hljs-number">1</span>));<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        address = base;<br>    &#125;<br>    cleaner = Cleaner.create(<span class="hljs-built_in">this</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Deallocator</span>(base, size, cap)); <span class="hljs-comment">//第二个参数是一个回调任务对象</span><br>    att = <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>但是，前面说了：释放直接内存，必须调用unsafe对象的  <code>freeMemory(直接内存的地址)</code>方法</p>
<p>此时我们查看一下这行代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">cleaner = Cleaner.create(<span class="hljs-built_in">this</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Deallocator</span>(base, size, cap)); <span class="hljs-comment">//第二个参数是一个回调任务对象</span><br></code></pre></td></tr></table></figure>



<p>查看一下Deallocator类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Deallocator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span><span class="hljs-comment">//该类是一个任务类</span><br></code></pre></td></tr></table></figure>



<p>在该类的run方法中，使用的freeMemory方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">if</span> (address == <span class="hljs-number">0</span>) &#123;<br>          <span class="hljs-comment">// Paranoia</span><br>          <span class="hljs-keyword">return</span>;<br>      &#125;<br>      unsafe.freeMemory(address);<br>      address = <span class="hljs-number">0</span>;<br>      Bits.unreserveMemory(size, capacity);<br>  &#125;<br></code></pre></td></tr></table></figure>



<p>Cleaner类是一种特殊的类型，虚引用类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Cleaner</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">PhantomReference</span>&lt;Object&gt;<br></code></pre></td></tr></table></figure>

<p>当虚引用对象所关联的实际对象被回收掉时，就会调用虚引用对象的clean方法 </p>
<p>clean方法 如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clean</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (remove(<span class="hljs-built_in">this</span>)) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-built_in">this</span>.thunk.run();<span class="hljs-comment">//该clean方法又会调用回调任务对象的run方法</span><br>            <span class="hljs-comment">//那个任务对象的run方法中由unsafe.freeMemory(java.Lang.Long)方法</span><br>        &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-keyword">final</span> Throwable var2) &#123;<br>            AccessController.doPrivileged(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PrivilegedAction</span>&lt;Void&gt;() &#123;<br>                <span class="hljs-keyword">public</span> Void <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                    <span class="hljs-keyword">if</span> (System.err != <span class="hljs-literal">null</span>) &#123;<br>                        (<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Cleaner terminated abnormally&quot;</span>, var2)).printStackTrace();<br>                    &#125;<br><br>                    System.exit(<span class="hljs-number">1</span>);<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>                &#125;<br>            &#125;);<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>小结：</p>
<p>ByteBuffer 的实现类内部，使用了 Cleaner （虚引用）来监测 ByteBuffer 对象，一旦 ByteBuffer 对象被垃圾回收</p>
<p>那么就会由 <code>ReferenceHandler 线程</code> (守护线程) 调用Cleaner（虚引用类型） 的 clean 方法 （当虚引用对象所关联的实际对象被垃圾回收时，会被RefferenceHandler线程 调用clean方法）</p>
<p>clean方法又会调用回调任务对象的run方法 该方法中会 调 用 freeMemory 来释放直接内存</p>
<p>注意：</p>
<blockquote>
<p>System.gc();  &#x2F;&#x2F;该方法触发的是一次FullGC，这种方式触发GC，也称为显式垃圾回收</p>
</blockquote>
<p>当使用JVM参数  <code>-XX:+DisableExplicitGC</code> 禁用显式回收对直接内存的影响</p>
<p>也即是说，System.gc();失效</p>
<p>例子：（禁用显式回收对直接内存的影响）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t1.direct;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.nio.ByteBuffer;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 禁用显式回收对直接内存的影响</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo1_26</span> &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">_1Gb</span> <span class="hljs-operator">=</span> <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * -XX:+DisableExplicitGC 显式的</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">byteBuffer</span> <span class="hljs-operator">=</span> ByteBuffer.allocateDirect(_1Gb);<br>        System.out.println(<span class="hljs-string">&quot;分配完毕...&quot;</span>);<br>        System.in.read();<br>        System.out.println(<span class="hljs-string">&quot;开始释放...&quot;</span>);<br>        byteBuffer = <span class="hljs-literal">null</span>;<br>        System.gc(); <span class="hljs-comment">// 显式的垃圾回收，Full GC</span><br>        System.in.read();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220731172951500.png" srcset="/img/loading.gif" lazyload alt="image-20220731172951500"></p>
<hr>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220731172924325.png" srcset="/img/loading.gif" lazyload alt="image-20220731172924325"></p>
<hr>
<p>小结：</p>
<p>当发生这种禁用显式垃圾回收时，可以使用unsafe对象的freeMomory方法，手动释放直接内存</p>
<h1 id="五、垃圾回收"><a href="#五、垃圾回收" class="headerlink" title="五、垃圾回收"></a>五、垃圾回收</h1><h2 id="1-0-如何判断对象可以回收"><a href="#1-0-如何判断对象可以回收" class="headerlink" title="1.0 如何判断对象可以回收"></a>1.0 如何判断对象可以回收</h2><h3 id="1-1-引用计数法"><a href="#1-1-引用计数法" class="headerlink" title="1.1 引用计数法"></a>1.1 引用计数法</h3><p>当一个对象有被引用时，计数器加1</p>
<p>当一个对象被断开引用时，计数器减1</p>
<p>问题：循环引用</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220731174331705.png" srcset="/img/loading.gif" lazyload alt="image-20220731174331705"></p>
<hr>
<p>A对象中引用了B对象；B对象中引用了A对象；即使A、B对象没有被其他对象所引用时，也不会触发垃圾回收</p>
<h3 id="1-2-可达性分析算法（jvm采用的算法）"><a href="#1-2-可达性分析算法（jvm采用的算法）" class="headerlink" title="1.2 可达性分析算法（jvm采用的算法）"></a>1.2 可达性分析算法（jvm采用的算法）</h3><p>根对象：可以先理解为，肯定不能被垃圾回收的对象</p>
<p>在进行垃圾回收之前，会对堆中的所有对象进行一遍扫描，查看每一个对象是否被  <code>根对象</code>   <strong>直接或间接引用</strong>的对象，如是，则不能被回收掉</p>
<p><code>Java虚拟机中的垃圾回收器</code>  采用  <code>可达性分析</code> 来  <code>探索所有存活的对象</code></p>
<p>扫描堆中的对象,看是否能够沿着 <code>GC Root对象</code> 为  <strong>起点</strong>  的  引用链<code>找到该对象</code>,找不到,表示可以回收</p>
<p>哪些对象可以作为GC Root?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t2;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 演示GC Roots</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo2_2</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException, IOException &#123;<br>        List&lt;Object&gt; list1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        list1.add(<span class="hljs-string">&quot;a&quot;</span>);<br>        list1.add(<span class="hljs-string">&quot;b&quot;</span>);<br>        System.out.println(<span class="hljs-number">1</span>);<br>        System.in.read();<br><br>        list1 = <span class="hljs-literal">null</span>;<br>        System.out.println(<span class="hljs-number">2</span>);<br>        System.in.read();<br>        System.out.println(<span class="hljs-string">&quot;end...&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>命令行窗口运行：</p>
<blockquote>
<p>jmap -dump:format&#x3D;b,live,file&#x3D;1.bin 21384</p>
</blockquote>
<p><code>-dump: </code>当前堆中运行时的一些状态，转储为一个文件；</p>
<p><code>b</code>: 二进制的形式</p>
<p><code>live</code>: 先进行一次垃圾回收，然后获取哪些还存活的对象</p>
<p><code>file=</code> :文件名字以及存放位置</p>
<blockquote>
<p>下载一个   可视化的堆分析工具 </p>
<p><a target="_blank" rel="noopener" href="https://www.eclipse.org/downloads/download.php?file=/mat/1.13.0/rcp/MemoryAnalyzer-1.13.0.20220615-win32.win32.x86_64.zip">https://www.eclipse.org/downloads/download.php?file=/mat/1.13.0/rcp/MemoryAnalyzer-1.13.0.20220615-win32.win32.x86_64.zip</a></p>
</blockquote>
<p>注意：</p>
<p>该MAT工具，仅支持jdk11及以上</p>
<p>使用：</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220731224705621.png" srcset="/img/loading.gif" lazyload alt="image-20220731224705621"></p>
<hr>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220731224813682.png" srcset="/img/loading.gif" lazyload alt="image-20220731224813682"></p>
<hr>
<p>GC Root有哪些</p>
<p>1 虚拟机运行过程中一些核心的类：</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220731224952505.png" srcset="/img/loading.gif" lazyload alt="image-20220731224952505"></p>
<hr>
<p>2 运行本地方法时，所引用的一些java对象</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220731225233890.png" srcset="/img/loading.gif" lazyload alt="image-20220731225233890"></p>
<hr>
<p>3 活动线程中，局部变量所引用的对象</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220731230238168.png" srcset="/img/loading.gif" lazyload alt="image-20220731230238168"></p>
<hr>
<p><img src="http://fgcy-pic.zhamao.ml/image-20220731230324179.png" srcset="/img/loading.gif" lazyload alt="image-20220731230324179"></p>
<hr>
<p>4 被加了锁的对象</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220731225509137.png" srcset="/img/loading.gif" lazyload alt="image-20220731225509137"></p>
<hr>
<h3 id="1-3-四种引用"><a href="#1-3-四种引用" class="headerlink" title="1.3 四种引用"></a>1.3 四种引用</h3><ol>
<li><p>强引用 只有所有 GC Roots 对象都不通过【强引用】引用该对象，该对象才能被垃圾回收</p>
</li>
<li><p>软引用（SoftReference） 仅有软引用  引用  该对象时，<strong>在垃圾回收后</strong>，<code>内存仍不足时</code>会再次出发垃圾回收，回收软引用 对象   <strong>可以</strong>   配合引用队列来释放软引用自身 </p>
</li>
<li><p>弱引用（WeakReference） 仅有弱引用引用该对象时，<strong>在垃圾回收时</strong>，无论内存<code>是否充足</code>，<strong>都会回收弱引用对象</strong>    <strong>可以</strong>   配合引用队列来释放弱引用自身 </p>
</li>
<li><p>虚引用（PhantomReference） <strong>必须</strong>配合引用队列使用，主要配合 ByteBuffer 使用，被引用对象回收时，会将虚引用入队， 由 Reference Handler 线程调用虚引用相关方法释放直接内存 </p>
</li>
<li><p>终结器引用（FinalReference） 无需手动编码，但其内部配合引用队列使用，在垃圾回收时，终结器引用入队<strong>（被引用对象 暂时没有被回收）</strong>，再由 Finalizer 线程 (优先级很低，被执行的概率低)  通过   终结器引用   找到   被引用对象  并   调用它的 finalize 方法  ，<strong>第二次 GC 时</strong>才能回收被引用对象</p>
<p>所以不推荐使用Object的finalize()方法，回收对象</p>
</li>
</ol>
<hr>
<p><img src="http://fgcy-pic.zhamao.ml/image-20220731230625601.png" srcset="/img/loading.gif" lazyload alt="image-20220731230625601"></p>
<hr>
<p>演示  强  弱比较</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t2;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.ref.SoftReference;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 演示强引用</span><br><span class="hljs-comment"> * -Xmx20m -XX:+PrintGCDetails -verbose:gc</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo2_3</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_4MB</span> <span class="hljs-operator">=</span> <span class="hljs-number">4</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        hard();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hard</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        List&lt;<span class="hljs-type">byte</span>[]&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;<br>            list.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[_4MB]);<br>        &#125;<br><br>        System.in.read();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus">Exception <span class="hljs-keyword">in</span> thread <span class="hljs-string">&quot;main&quot;</span> java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.OutOfMemoryError</span>: Java heap space<br>	at cn<span class="hljs-selector-class">.itcast</span><span class="hljs-selector-class">.jvm</span><span class="hljs-selector-class">.t2</span><span class="hljs-selector-class">.Demo2_3</span><span class="hljs-selector-class">.hard</span>(Demo2_3<span class="hljs-selector-class">.java</span>:<span class="hljs-number">28</span>)<br>	at cn<span class="hljs-selector-class">.itcast</span><span class="hljs-selector-class">.jvm</span><span class="hljs-selector-class">.t2</span><span class="hljs-selector-class">.Demo2_3</span><span class="hljs-selector-class">.main</span>(Demo2_3<span class="hljs-selector-class">.java</span>:<span class="hljs-number">19</span>)<br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t2;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.ref.SoftReference;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 演示软引用</span><br><span class="hljs-comment"> * -Xmx20m -XX:+PrintGCDetails -verbose:gc</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo2_3</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_4MB</span> <span class="hljs-operator">=</span> <span class="hljs-number">4</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        soft();<br>    &#125;<br><br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">soft</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// list --&gt; SoftReference --&gt; byte[]</span><br><br>        List&lt;SoftReference&lt;<span class="hljs-type">byte</span>[]&gt;&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;<br>            SoftReference&lt;<span class="hljs-type">byte</span>[]&gt; ref = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SoftReference</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[_4MB]);<br>            System.out.println(ref.get());<br>            list.add(ref);<br>            System.out.println(list.size());<br><br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;循环结束：&quot;</span> + list.size());<br>        <span class="hljs-keyword">for</span> (SoftReference&lt;<span class="hljs-type">byte</span>[]&gt; ref : list) &#123;<br>            System.out.println(ref.get());<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">7</span><span class="hljs-variable">f31245a</span><br><span class="hljs-number">1</span><br><span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">6</span><span class="hljs-variable">d6f6e28</span><br><span class="hljs-number">2</span><br><span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">135</span><span class="hljs-variable">fbaa4</span><br><span class="hljs-number">3</span><br><span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">2138</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">512</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">6144</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">14426</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">13063</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">19968</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0006212</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">45</span><span class="hljs-variable">ee12a7</span><br><span class="hljs-number">4</span><br><span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">--</span><span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">4720</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">4720</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">6144</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">17271</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">17335</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">19968</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0004683</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Ergonomics</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">4720</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">4533</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">6144</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">12615</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">12542</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">13824</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">17335</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">17075</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">19968</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">3242</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">3242</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0034264</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">--</span><span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">4533</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">4533</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">6144</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">17075</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">17130</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">19968</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0003634</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">4533</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">0</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">6144</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">12597</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">673</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">8704</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">17130</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">673</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">14848</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">3242</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">3242</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0034938</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">330</span><span class="hljs-variable">bedb4</span><br><span class="hljs-number">5</span><br>循环结束：<span class="hljs-number">5</span><br><span class="hljs-variable">null</span>   <span class="hljs-operator">//</span>空的软引用对象<br><span class="hljs-variable">null</span><br><span class="hljs-variable">null</span><br><span class="hljs-variable">null</span><br><span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">330</span><span class="hljs-variable">bedb4</span><br><span class="hljs-variable">Heap</span><br> <span class="hljs-variable">PSYoungGen</span>      <span class="hljs-variable">total</span> <span class="hljs-number">6144</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">used</span> <span class="hljs-number">4264</span><span class="hljs-built_in">K</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ff980000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x0000000100000000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x0000000100000000</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-variable">eden</span> <span class="hljs-variable">space</span> <span class="hljs-number">5632</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">75</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ff980000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ffdaa2b8</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff00000</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-variable">from</span> <span class="hljs-variable">space</span> <span class="hljs-number">512</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff00000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff00000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff80000</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-variable">to</span>   <span class="hljs-variable">space</span> <span class="hljs-number">512</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff80000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff80000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x0000000100000000</span><span class="hljs-punctuation">)</span><br> <span class="hljs-variable">ParOldGen</span>       <span class="hljs-variable">total</span> <span class="hljs-number">8704</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">used</span> <span class="hljs-number">673</span><span class="hljs-built_in">K</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fec00000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000000ff480000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000000ff980000</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-variable">object</span> <span class="hljs-variable">space</span> <span class="hljs-number">8704</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">7</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fec00000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000feca8500</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ff480000</span><span class="hljs-punctuation">)</span><br> <span class="hljs-variable">Metaspace</span>       <span class="hljs-variable">used</span> <span class="hljs-number">3250</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">capacity</span> <span class="hljs-number">4500</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">committed</span> <span class="hljs-number">4864</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">reserved</span> <span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><br>  <span class="hljs-variable">class</span> <span class="hljs-variable">space</span>    <span class="hljs-variable">used</span> <span class="hljs-number">352</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">capacity</span> <span class="hljs-number">388</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">committed</span> <span class="hljs-number">512</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">reserved</span> <span class="hljs-number">1048576</span><span class="hljs-built_in">K</span><br></code></pre></td></tr></table></figure>





<p>配合引用队列完成为空的软引用的清理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t2;<br><br><span class="hljs-keyword">import</span> java.lang.ref.Reference;<br><span class="hljs-keyword">import</span> java.lang.ref.ReferenceQueue;<br><span class="hljs-keyword">import</span> java.lang.ref.SoftReference;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 演示软引用, 配合引用队列</span><br><span class="hljs-comment"> * -Xmx20m -XX:+PrintGCDetails -verbose:gc</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo2_4</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_4MB</span> <span class="hljs-operator">=</span> <span class="hljs-number">4</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        List&lt;SoftReference&lt;<span class="hljs-type">byte</span>[]&gt;&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>        <span class="hljs-comment">// 引用队列</span><br>        ReferenceQueue&lt;<span class="hljs-type">byte</span>[]&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceQueue</span>&lt;&gt;();<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;<br>            <span class="hljs-comment">// 关联了引用队列， 当软引用所关联的 byte[]被回收时，软引用自己会加入到 queue 中去</span><br>            SoftReference&lt;<span class="hljs-type">byte</span>[]&gt; ref = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SoftReference</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[_4MB], queue);<br>            System.out.println(ref.get());<br>            list.add(ref);<br>            System.out.println(list.size());<br>        &#125;<br><br>        <span class="hljs-comment">// 从队列中获取无用的 软引用对象，并移除</span><br>        Reference&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">byte</span>[]&gt; poll = queue.poll();<br>        <span class="hljs-keyword">while</span> (poll != <span class="hljs-literal">null</span>) &#123;<br>            list.remove(poll);<br>            poll = queue.poll();<br>        &#125;<br><br>        System.out.println(<span class="hljs-string">&quot;===========================&quot;</span>);<br>        <span class="hljs-keyword">for</span> (SoftReference&lt;<span class="hljs-type">byte</span>[]&gt; reference : list) &#123;<br>            System.out.println(reference.get());<br>        &#125;<br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">7</span><span class="hljs-variable">f31245a</span><br><span class="hljs-number">1</span><br><span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">6</span><span class="hljs-variable">d6f6e28</span><br><span class="hljs-number">2</span><br><span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">135</span><span class="hljs-variable">fbaa4</span><br><span class="hljs-number">3</span><br><span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">2138</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">504</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">6144</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">14426</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">13055</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">19968</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0010074</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.05</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.02</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">45</span><span class="hljs-variable">ee12a7</span><br><span class="hljs-number">4</span><br><span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">--</span><span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">4712</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">4712</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">6144</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">17263</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">17370</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">19968</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0011186</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Ergonomics</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">4712</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">4519</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">6144</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">12658</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">12554</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">13824</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">17370</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">17074</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">19968</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">3241</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">3241</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0038776</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">--</span><span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">4519</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">4519</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">6144</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">17074</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">17170</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">19968</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0005025</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">4519</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">0</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">6144</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">12650</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">671</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">8704</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">17170</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">671</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">14848</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">3241</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">3241</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0056360</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">330</span><span class="hljs-variable">bedb4</span><br><span class="hljs-number">5</span><br><span class="hljs-operator">===========================</span><br><span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">330</span><span class="hljs-variable">bedb4</span><br><span class="hljs-variable">Heap</span><br> <span class="hljs-variable">PSYoungGen</span>      <span class="hljs-variable">total</span> <span class="hljs-number">6144</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">used</span> <span class="hljs-number">4377</span><span class="hljs-built_in">K</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ff980000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x0000000100000000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x0000000100000000</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-variable">eden</span> <span class="hljs-variable">space</span> <span class="hljs-number">5632</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">77</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ff980000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ffdc6548</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff00000</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-variable">from</span> <span class="hljs-variable">space</span> <span class="hljs-number">512</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff00000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff00000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff80000</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-variable">to</span>   <span class="hljs-variable">space</span> <span class="hljs-number">512</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff80000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff80000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x0000000100000000</span><span class="hljs-punctuation">)</span><br> <span class="hljs-variable">ParOldGen</span>       <span class="hljs-variable">total</span> <span class="hljs-number">8704</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">used</span> <span class="hljs-number">671</span><span class="hljs-built_in">K</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fec00000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000000ff480000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000000ff980000</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-variable">object</span> <span class="hljs-variable">space</span> <span class="hljs-number">8704</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">7</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fec00000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000feca7f98</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ff480000</span><span class="hljs-punctuation">)</span><br> <span class="hljs-variable">Metaspace</span>       <span class="hljs-variable">used</span> <span class="hljs-number">3248</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">capacity</span> <span class="hljs-number">4500</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">committed</span> <span class="hljs-number">4864</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">reserved</span> <span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><br>  <span class="hljs-variable">class</span> <span class="hljs-variable">space</span>    <span class="hljs-variable">used</span> <span class="hljs-number">352</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">capacity</span> <span class="hljs-number">388</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">committed</span> <span class="hljs-number">512</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">reserved</span> <span class="hljs-number">1048576</span><span class="hljs-built_in">K</span><br></code></pre></td></tr></table></figure>







<p>弱引用示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t2;<br><br><span class="hljs-keyword">import</span> java.lang.ref.Reference;<br><span class="hljs-keyword">import</span> java.lang.ref.ReferenceQueue;<br><span class="hljs-keyword">import</span> java.lang.ref.SoftReference;<br><span class="hljs-keyword">import</span> java.lang.ref.WeakReference;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 演示弱引用</span><br><span class="hljs-comment"> * -Xmx20m -XX:+PrintGCDetails -verbose:gc</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo2_5</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_4MB</span> <span class="hljs-operator">=</span> <span class="hljs-number">4</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//  list --&gt; WeakReference --&gt; byte[]</span><br>        List&lt;WeakReference&lt;<span class="hljs-type">byte</span>[]&gt;&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>            WeakReference&lt;<span class="hljs-type">byte</span>[]&gt; ref = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakReference</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[_4MB]);<br>            list.add(ref);<br>            <span class="hljs-keyword">for</span> (WeakReference&lt;<span class="hljs-type">byte</span>[]&gt; w : list) &#123;<br>                System.out.print(w.get()+<span class="hljs-string">&quot; &quot;</span>);<br>            &#125;<br>            System.out.println();<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;循环结束：&quot;</span> + list.size());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">7</span><span class="hljs-variable">f31245a</span> <br><span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">7</span><span class="hljs-variable">f31245a</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">6</span><span class="hljs-variable">d6f6e28</span> <br><span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">7</span><span class="hljs-variable">f31245a</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">6</span><span class="hljs-variable">d6f6e28</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">135</span><span class="hljs-variable">fbaa4</span> <br><span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">2138</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">488</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">6144</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">14426</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">13082</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">19968</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0008480</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">7</span><span class="hljs-variable">f31245a</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">6</span><span class="hljs-variable">d6f6e28</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">135</span><span class="hljs-variable">fbaa4</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">45</span><span class="hljs-variable">ee12a7</span> <br><span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">4696</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">488</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">6144</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">17290</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">13202</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">19968</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0004814</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">7</span><span class="hljs-variable">f31245a</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">6</span><span class="hljs-variable">d6f6e28</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">135</span><span class="hljs-variable">fbaa4</span> <span class="hljs-variable">null</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">330</span><span class="hljs-variable">bedb4</span> <br><span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">4696</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">504</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">6144</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">17410</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">13282</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">19968</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0004436</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.02</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">7</span><span class="hljs-variable">f31245a</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">6</span><span class="hljs-variable">d6f6e28</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">135</span><span class="hljs-variable">fbaa4</span> <span class="hljs-variable">null</span> <span class="hljs-variable">null</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">2503</span><span class="hljs-variable">dbd3</span> <br><span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">4711</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">504</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">6144</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">17489</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">13330</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">19968</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0003351</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">7</span><span class="hljs-variable">f31245a</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">6</span><span class="hljs-variable">d6f6e28</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">135</span><span class="hljs-variable">fbaa4</span> <span class="hljs-variable">null</span> <span class="hljs-variable">null</span> <span class="hljs-variable">null</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">4</span><span class="hljs-variable">b67cf4d</span> <br><span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">4710</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">504</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">6144</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">17537</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">13370</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">19968</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0002823</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">7</span><span class="hljs-variable">f31245a</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">6</span><span class="hljs-variable">d6f6e28</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">135</span><span class="hljs-variable">fbaa4</span> <span class="hljs-variable">null</span> <span class="hljs-variable">null</span> <span class="hljs-variable">null</span> <span class="hljs-variable">null</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">7</span><span class="hljs-variable">ea987ac</span> <br><span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">4710</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">504</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">5120</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">17576</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">13406</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">18944</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0002916</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">7</span><span class="hljs-variable">f31245a</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">6</span><span class="hljs-variable">d6f6e28</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">135</span><span class="hljs-variable">fbaa4</span> <span class="hljs-variable">null</span> <span class="hljs-variable">null</span> <span class="hljs-variable">null</span> <span class="hljs-variable">null</span> <span class="hljs-variable">null</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">12</span><span class="hljs-variable">a3a380</span> <br><span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">4690</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">64</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">5632</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">17592</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">13398</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">19456</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0003781</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Ergonomics</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">64</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">0</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">5632</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">13334</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">681</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">8704</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">13398</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">681</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">14336</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">3242</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">3242</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0051074</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-variable">null</span> <span class="hljs-variable">null</span> <span class="hljs-variable">null</span> <span class="hljs-variable">null</span> <span class="hljs-variable">null</span> <span class="hljs-variable">null</span> <span class="hljs-variable">null</span> <span class="hljs-variable">null</span> <span class="hljs-variable">null</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">B</span><span class="hljs-operator">@</span><span class="hljs-number">29453</span><span class="hljs-variable">f44</span> <br>循环结束：<span class="hljs-number">10</span><br><span class="hljs-variable">Heap</span><br> <span class="hljs-variable">PSYoungGen</span>      <span class="hljs-variable">total</span> <span class="hljs-number">5632</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">used</span> <span class="hljs-number">4370</span><span class="hljs-built_in">K</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ff980000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x0000000100000000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x0000000100000000</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-variable">eden</span> <span class="hljs-variable">space</span> <span class="hljs-number">4608</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">94</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ff980000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ffdc4ba0</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ffe00000</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-variable">from</span> <span class="hljs-variable">space</span> <span class="hljs-number">1024</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ffe00000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ffe00000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff00000</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-variable">to</span>   <span class="hljs-variable">space</span> <span class="hljs-number">1024</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff00000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fff00000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x0000000100000000</span><span class="hljs-punctuation">)</span><br> <span class="hljs-variable">ParOldGen</span>       <span class="hljs-variable">total</span> <span class="hljs-number">8704</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">used</span> <span class="hljs-number">681</span><span class="hljs-built_in">K</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fec00000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000000ff480000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000000ff980000</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-variable">object</span> <span class="hljs-variable">space</span> <span class="hljs-number">8704</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">7</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fec00000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fecaa4a8</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ff480000</span><span class="hljs-punctuation">)</span><br> <span class="hljs-variable">Metaspace</span>       <span class="hljs-variable">used</span> <span class="hljs-number">3249</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">capacity</span> <span class="hljs-number">4500</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">committed</span> <span class="hljs-number">4864</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">reserved</span> <span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><br>  <span class="hljs-variable">class</span> <span class="hljs-variable">space</span>    <span class="hljs-variable">used</span> <span class="hljs-number">352</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">capacity</span> <span class="hljs-number">388</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">committed</span> <span class="hljs-number">512</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">reserved</span> <span class="hljs-number">1048576</span><span class="hljs-built_in">K</span><br></code></pre></td></tr></table></figure>

<p>没有回收掉的原因是因为，对象进入了老年代；minorGC触发的是新生代的的回收；</p>
<p>所以与之前说的只要触发GC，弱引用所关联的对象就会被回收掉不冲突；</p>
<p>进行垃圾回收时虽然会将软引用，弱引用所关联的对象释放掉（软引用是发生gc且内存还是不够才干掉关联对象），但想要干掉软引用、弱引用则需要配合队列使用；</p>
<h2 id="2-0-垃圾回收算法"><a href="#2-0-垃圾回收算法" class="headerlink" title="2.0 垃圾回收算法"></a>2.0 垃圾回收算法</h2><h3 id="2-1-标记清除"><a href="#2-1-标记清除" class="headerlink" title="2.1 标记清除"></a>2.1 标记清除</h3><p>定义： Mark Sweep </p>
<p>特点：</p>
<p>速度较快 会造成内存碎片</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220801232427927.png" srcset="/img/loading.gif" lazyload alt="image-20220801232427927"></p>
<hr>
<p>分两步，标记和清除</p>
<p>标记是将没有被根对象做出标记</p>
<p>清除是将被标记的对象所占用的内存的起始地址记录到空闲区，而不是将该内存空间置零（这是一个误区）</p>
<p>缺点就是：会造成内存碎片</p>
<h3 id="2-2-标记整理"><a href="#2-2-标记整理" class="headerlink" title="2.2 标记整理"></a>2.2 标记整理</h3><p>定义：Mark Compact</p>
<p>速度慢 没有内存碎片</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220801233836932.png" srcset="/img/loading.gif" lazyload alt="image-20220801233836932"></p>
<hr>
<p>速度慢的原因：涉及内存区块的拷贝与移动  以及  所有关联此地址的引用的改变</p>
<h3 id="2-3-复制"><a href="#2-3-复制" class="headerlink" title="2.3 复制"></a>2.3 复制</h3><p>定义：Copy </p>
<p>不会有内存碎片 需要占用双倍内存空间</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220801233458168.png" srcset="/img/loading.gif" lazyload alt="image-20220801233458168"></p>
<hr>
<p>进行垃圾回收，找到有GCroot直接或间接引用的对象，将其从FROM区迁移到TO区；最后逻辑交换FROM区和TO区</p>
<h2 id="3-0-分代垃圾回收"><a href="#3-0-分代垃圾回收" class="headerlink" title="3.0 分代垃圾回收"></a>3.0 分代垃圾回收</h2><hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220801235201849.png" srcset="/img/loading.gif" lazyload alt="image-20220801235201849"></p>
<hr>
<p>1、对象首先分配在伊甸园区域 </p>
<p>2、新生代空间不足时，触发 minor gc，伊甸园和 from 存活的对象使用 copy 复制到 to 中，存活的 对象年龄加 1并且交换 from to</p>
<p>3、minor gc 会引发 stop the world，暂停其它用户的线程，等垃圾回收结束（原因：需要将幸存区FROM中的对象 复制到 幸存区TO中，多线程运行时用以出现问题）用户线程才恢复运行 当对象寿命超过阈值时，会晋升至老年代，最大寿命是15（4bit），当空间不足时，即使幸存区中的对象没有超过15，也有可能晋升到老年代</p>
<p>4、当老年代空间不足，会先尝试触发 minor gc，如果之后空间仍不足，那么触发 full gc，STW的时 间更长（老年代一般使用标记清除或者是标记整理）</p>
<p>当发现触发了一次FullGC后还是空间不足，报错：OutOfMemory</p>
<h3 id="3-1-相关VM参数"><a href="#3-1-相关VM参数" class="headerlink" title="3.1 相关VM参数"></a>3.1 相关VM参数</h3><hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807233333410.png" srcset="/img/loading.gif" lazyload alt="image-20220807233333410"></p>
<hr>
<h3 id="3-2-使用参数"><a href="#3-2-使用参数" class="headerlink" title="3.2 使用参数"></a>3.2 使用参数</h3><p>例子一：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t2;<br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *  演示内存的分配策略</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo2_1</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_512KB</span> <span class="hljs-operator">=</span> <span class="hljs-number">512</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_1MB</span> <span class="hljs-operator">=</span> <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_6MB</span> <span class="hljs-operator">=</span> <span class="hljs-number">6</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_7MB</span> <span class="hljs-operator">=</span> <span class="hljs-number">7</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_8MB</span> <span class="hljs-operator">=</span> <span class="hljs-number">8</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br><br>    <span class="hljs-comment">// -Xms20M -Xmx20M -Xmn10M -XX:+UseSerialGC -XX:+PrintGCDetails -verbose:gc -XX:-ScavengeBeforeFullGC</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-variable">Heap</span>【堆内存】<br> <span class="hljs-variable">def</span> <span class="hljs-variable">new</span> <span class="hljs-variable">generation</span>   <span class="hljs-variable">total</span> <span class="hljs-number">9216</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">used</span> <span class="hljs-number">2322</span><span class="hljs-built_in">K</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fec00000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000000ff600000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000000ff600000</span><span class="hljs-punctuation">)</span>   【新生代】<br>  <span class="hljs-variable">eden</span> <span class="hljs-variable">space</span> <span class="hljs-number">8192</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span>  <span class="hljs-number">28</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000fec00000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000000fee44af0</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000000ff400000</span><span class="hljs-punctuation">)</span>   【伊甸园】<br>  <span class="hljs-variable">from</span> <span class="hljs-variable">space</span> <span class="hljs-number">1024</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span>   <span class="hljs-number">0</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ff400000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000000ff400000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000000ff500000</span><span class="hljs-punctuation">)</span> 	  【<span class="hljs-variable">from</span>区】<br>  <span class="hljs-variable">to</span>   <span class="hljs-variable">space</span> <span class="hljs-number">1024</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span>   <span class="hljs-number">0</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ff500000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000000ff500000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000000ff600000</span><span class="hljs-punctuation">)</span>		【<span class="hljs-variable">to</span>区】<br><span class="hljs-variable">tenured</span> <span class="hljs-variable">generation</span>   <span class="hljs-variable">total</span> <span class="hljs-number">10240</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">used</span> <span class="hljs-number">0</span><span class="hljs-built_in">K</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ff600000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x0000000100000000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x0000000100000000</span><span class="hljs-punctuation">)</span>  【老年代】<br><span class="hljs-variable">the</span> <span class="hljs-variable">space</span> <span class="hljs-number">10240</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span>   <span class="hljs-number">0</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000000ff600000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000000ff600000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000000ff600200</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x0000000100000000</span><span class="hljs-punctuation">)</span> <br><span class="hljs-variable">Metaspace</span>       <span class="hljs-variable">used</span> <span class="hljs-number">3244</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">capacity</span> <span class="hljs-number">4496</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">committed</span> <span class="hljs-number">4864</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">reserved</span> <span class="hljs-number">1056768</span><span class="hljs-built_in">K</span> 【元空间，这货不属于堆内存，只是为了方便查看信息】<br>  <span class="hljs-variable">class</span> <span class="hljs-variable">space</span>    <span class="hljs-variable">used</span> <span class="hljs-number">352</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">capacity</span> <span class="hljs-number">388</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">committed</span> <span class="hljs-number">512</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">reserved</span> <span class="hljs-number">1048576</span><span class="hljs-built_in">K</span><br></code></pre></td></tr></table></figure>

<p><code>新生代的最大值与最小值设置为10M</code>，所以  伊甸园 + form区 + to区&#x3D;10M</p>
<p>新生代total（总共9M），原因：幸存区to必须为空，所以空出1M的内存</p>
<p>例子二：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t2;<br><br><span class="hljs-keyword">import</span> java.sql.Array;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 演示内存的分配策略</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo2_1</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_512KB</span> <span class="hljs-operator">=</span> <span class="hljs-number">512</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_1MB</span> <span class="hljs-operator">=</span> <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_6MB</span> <span class="hljs-operator">=</span> <span class="hljs-number">6</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_7MB</span> <span class="hljs-operator">=</span> <span class="hljs-number">7</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_8MB</span> <span class="hljs-operator">=</span> <span class="hljs-number">8</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br><br>    <span class="hljs-comment">// -Xms20M -Xmx20M -Xmn10M -XX:+UseSerialGC -XX:+PrintGCDetails -verbose:gc -XX:-ScavengeBeforeFullGC</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        ArrayList&lt;Object&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        list.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[_7MB]);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807233410647.png" srcset="/img/loading.gif" lazyload alt="image-20220807233410647"></p>
<hr>
<p>发生一次MinorGC将伊甸园中的没用的对象回收掉，将伊甸园中一些还有GCRoot引用的对象放到from区中；为伊甸园区腾出空间；</p>
<p>例子三：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t2;<br><br><span class="hljs-keyword">import</span> java.sql.Array;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 演示内存的分配策略</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo2_1</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_512KB</span> <span class="hljs-operator">=</span> <span class="hljs-number">512</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_1MB</span> <span class="hljs-operator">=</span> <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_6MB</span> <span class="hljs-operator">=</span> <span class="hljs-number">6</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_7MB</span> <span class="hljs-operator">=</span> <span class="hljs-number">7</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_8MB</span> <span class="hljs-operator">=</span> <span class="hljs-number">8</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br><br>    <span class="hljs-comment">// -Xms20M -Xmx20M -Xmn10M -XX:+UseSerialGC -XX:+PrintGCDetails -verbose:gc -XX:-ScavengeBeforeFullGC</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        ArrayList&lt;Object&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        list.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[_7MB]);<span class="hljs-comment">//还剩：8192k *0.1 =819.2k</span><br>        list.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[_512KB]);<span class="hljs-comment">//几乎占满伊甸园区 （也只是触发一次GC）</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<p>[<img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807233446770.png" srcset="/img/loading.gif" lazyload alt="image-20220807233446770"></p>
<hr>
<p>此时伊甸园区还有：8192*0.04&#x3D;327K，会发生垃圾回收；</p>
<p>例子四：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t2;<br><br><span class="hljs-keyword">import</span> java.sql.Array;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 演示内存的分配策略</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo2_1</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_512KB</span> <span class="hljs-operator">=</span> <span class="hljs-number">512</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_1MB</span> <span class="hljs-operator">=</span> <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_6MB</span> <span class="hljs-operator">=</span> <span class="hljs-number">6</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_7MB</span> <span class="hljs-operator">=</span> <span class="hljs-number">7</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_8MB</span> <span class="hljs-operator">=</span> <span class="hljs-number">8</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br><br>    <span class="hljs-comment">// -Xms20M -Xmx20M -Xmn10M -XX:+UseSerialGC -XX:+PrintGCDetails -verbose:gc -XX:-ScavengeBeforeFullGC</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        ArrayList&lt;Object&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        list.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[_7MB]);<span class="hljs-comment">//还剩：8192k *0.1 =819.2k</span><br>        list.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[_512KB]);<span class="hljs-comment">//8192*0.04=327K</span><br>        list.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[_512KB]);<span class="hljs-comment">//尝试添加这个对象，失败 因为伊甸园内存不足，触发一次gc</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807233508410.png" srcset="/img/loading.gif" lazyload alt="image-20220807233508410"></p>
<hr>
<p>例子五：</p>
<p>大对象，在新生代内存不足以容纳，而老年代可以容纳时，直接晋升到老年代（不经过GC）</p>
<p>伊甸园总共就8M左右，还占用了28%，肯定放不下一个8M的对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t2;<br><br><span class="hljs-keyword">import</span> java.sql.Array;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 演示内存的分配策略</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo2_1</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_512KB</span> <span class="hljs-operator">=</span> <span class="hljs-number">512</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_1MB</span> <span class="hljs-operator">=</span> <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_6MB</span> <span class="hljs-operator">=</span> <span class="hljs-number">6</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_7MB</span> <span class="hljs-operator">=</span> <span class="hljs-number">7</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_8MB</span> <span class="hljs-operator">=</span> <span class="hljs-number">8</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br><br>    <span class="hljs-comment">// -Xms20M -Xmx20M -Xmn10M -XX:+UseSerialGC -XX:+PrintGCDetails -verbose:gc -XX:-ScavengeBeforeFullGC</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        ArrayList&lt;Object&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        list.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[_8MB]);<span class="hljs-comment">//还剩：8192k *0.1 =819.2k</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807233532177.png" srcset="/img/loading.gif" lazyload alt="image-20220807233532177"></p>
<hr>
<p>例子六：当新生代和老年代的空间不足时，报错OutOfMemory</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t2;<br><br><span class="hljs-keyword">import</span> java.sql.Array;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 演示内存的分配策略</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo2_1</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_512KB</span> <span class="hljs-operator">=</span> <span class="hljs-number">512</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_1MB</span> <span class="hljs-operator">=</span> <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_6MB</span> <span class="hljs-operator">=</span> <span class="hljs-number">6</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_7MB</span> <span class="hljs-operator">=</span> <span class="hljs-number">7</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_8MB</span> <span class="hljs-operator">=</span> <span class="hljs-number">8</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br><br>    <span class="hljs-comment">// -Xms20M -Xmx20M -Xmn10M -XX:+UseSerialGC -XX:+PrintGCDetails -verbose:gc -XX:-ScavengeBeforeFullGC</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        ArrayList&lt;Object&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        list.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[_8MB]);<span class="hljs-comment">//还剩：8192k *0.1 =819.2k</span><br>        list.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[_8MB]);<span class="hljs-comment">//新生代和老年代都容纳不了</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807233557478.png" srcset="/img/loading.gif" lazyload alt="image-20220807233557478"></p>
<hr>
<p>做了两次GC自救，还是没能救活；外抛异常；</p>
<p>例子七：</p>
<p>因为线程导致的OOM，不会使得整个进程结束；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t2;<br><br><span class="hljs-keyword">import</span> java.sql.Array;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 演示内存的分配策略</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo2_1</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_512KB</span> <span class="hljs-operator">=</span> <span class="hljs-number">512</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_1MB</span> <span class="hljs-operator">=</span> <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_6MB</span> <span class="hljs-operator">=</span> <span class="hljs-number">6</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_7MB</span> <span class="hljs-operator">=</span> <span class="hljs-number">7</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">_8MB</span> <span class="hljs-operator">=</span> <span class="hljs-number">8</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br><br>    <span class="hljs-comment">// -Xms20M -Xmx20M -Xmn10M -XX:+UseSerialGC -XX:+PrintGCDetails -verbose:gc -XX:-ScavengeBeforeFullGC</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    <span class="hljs-comment">//开一个子线程 进行oom</span><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            ArrayList&lt;<span class="hljs-type">byte</span>[]&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>            list.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[_8MB]);<br>            list.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[_8MB]);<br>        &#125;).start();<br><br><br>        <span class="hljs-comment">//看是否会使得整个JVM挂掉</span><br>        System.out.println(<span class="hljs-string">&quot;sleep....&quot;</span>);<br>        Thread.sleep(<span class="hljs-number">1800L</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807142117396.png" srcset="/img/loading.gif" lazyload alt="image-20220807142117396"></p>
<hr>
<p>主线程还能正常结束</p>
<h2 id="4-0-垃圾回收器"><a href="#4-0-垃圾回收器" class="headerlink" title="4.0 垃圾回收器"></a>4.0 垃圾回收器</h2><p>1、<code>串行 </code>    <strong>单线程</strong>    <strong>堆内存较小</strong>，适合个人电脑</p>
<p>2、<code>吞吐量优先</code> 多线程 堆内存较大，多核 cpu 让<strong>单位时间内</strong>，<strong>STW 的时间最短</strong>  每次垃圾回收的时间不一定是最短的，但单位时间内，STW的时间一定是最短的；	   这样就称吞吐量高 </p>
<p>3、<code> 响应时间优先</code> 多线程 堆内存较大，多核 cpu 尽可能让 <code>单次</code> STW 的时间最短 </p>
<h3 id="4-1-串行"><a href="#4-1-串行" class="headerlink" title="4.1 串行"></a>4.1 串行</h3><p><code>-XX:+UseSerialGC = Serial + SerialOld</code></p>
<p><code>Serial</code> 是工作在新生代  【使用复制算法】</p>
<p><code>SerialOld</code> 是工作在老年代 【使用标记整理算法】</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807141612251.png" srcset="/img/loading.gif" lazyload alt="image-20220807141612251"></p>
<hr>
<p>多个线程在安全点停下，因为发生GC是有可能会改变对象地址；这样会出现问题； 	</p>
<p>这个串行的垃圾回收器是单线程执行的；等这个垃圾回收线程完成后，才开始其他用户线程的执行；</p>
<h3 id="4-2-吞吐量优先"><a href="#4-2-吞吐量优先" class="headerlink" title="4.2 吞吐量优先"></a>4.2 吞吐量优先</h3><p><code>-XX:+UseParallelGC</code> ~ <code>-XX:+UseParallelOldGC </code>  <strong>jdk1.8默认开启这两个参数</strong></p>
<p><code>-XX:+UseParallelGC:</code> <strong>并行的</strong>  垃圾回收器，工作在新生代，采用复制算法</p>
<p><code>-XX:+UseParallelOldGC:</code>  <strong>并行的</strong>  垃圾回收器，工作在老年代，采用标记整理算法</p>
<p>上面两个参数只要有其中一个开启，另一个也会开启；</p>
<p><code> -XX:ParallelGCThreads=n</code> :用于控制parallelGC的线程数量 【默认开启的线程数量与CPU的核数相同】</p>
<p><code>-XX:+UseAdaptiveSizePolicy</code>   : 开启自适应的大小调整策略 【调整伊甸园和幸存区的比例，调整堆得大小，调整晋升阈值】</p>
<p><code>-XX:GCTimeRatio=ratio</code> : 用于设置吞吐率目标 1 &#x2F; (1+radio)，当达不到这个目标，就会开始调整值，一般是增大堆的大小；【一般radio&#x3D;19 】</p>
<p><code> -XX:MaxGCPauseMillis=ms</code> : 最大暂停毫秒数，默认200毫秒 </p>
<p>堆空间变大了，单位时间内进行GC的次数会少；吞吐率就可以上去</p>
<p>堆空间变大了，单次GC的时间就会变小</p>
<p>上面两个目标是冲突的，我们要注意平衡；</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807141512078.png" srcset="/img/loading.gif" lazyload alt="image-20220807141512078"></p>
<hr>
<h3 id="4-3-响应时间优先"><a href="#4-3-响应时间优先" class="headerlink" title="4.3 响应时间优先"></a>4.3 响应时间优先</h3><p><code>-XX : +UseConcMarkSweepGC</code> ~ <code>-XX : +UseParNewGC</code> ~      <code>Se ri al Ol d</code></p>
<p><code>-XX : +UseConcMarkSweepGC</code>  【CMS】 这个是老年代的垃圾回收器，与之配合的是  <code>-XX : +UseParNewGC</code> 工作在新生代的垃圾回收器，但是当发生并发失败时，CMS老年代的垃圾回收器就会退化为串行的垃圾回收器</p>
<p>并发的垃圾回收器：在垃圾回收期间，用户线程还可以工作，双方抢占CPU资源；【只有某些时刻可以并发执行，大部分不行，但还是可以减少Stop The World的时间】</p>
<p>上一个介绍的，并行的垃圾回收器：在垃圾回收期间，不允许任何用户线程运行，但有多个线程同时执行垃圾回收</p>
<p>注意：</p>
<p>并发是一个CPU某个时刻只干一件事；并行是多个CPU某一个时刻同时在干一件事；</p>
<p><code>-XX : Paral l el GCTh reads=n  </code> ~  <code>-XX : ConcGCTh reads=th reads</code></p>
<p><code>-XX : Paral l el GCTh reads=n </code> : 并行的垃圾回收线程数【一般与CPU的核数相同】 </p>
<p><code>-XX : ConcGCTh reads=th reads </code>: 并发的垃圾回收线程数【一般设置为CPU核数的四分之一】</p>
<p><code>-XX : CMSIni ti ati ngOccupancyFracti on=pe rcent </code> 执行CMS垃圾回收的内存占比</p>
<p>​	因为CMS回收器，有浮动垃圾；如果像其他的垃圾回收器一样等到放不下新的对象时才去清理，就会浪费空间</p>
<p><code>-XX : +CMSScavengeBefo reRemark</code>  该参数的作用是，在重新标记的时候，先清理一次新生代</p>
<p>CMS垃圾回收器的工作示意图：</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-08-06_22-55-06.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<p>1、等待多个线程进入安全点，STW开启垃圾回收线程，进行初始标记【这个过程很快，因为只是标记】</p>
<p>2、初始标记完成后，用户线程就可以恢复运行，同时垃圾回收线程可以并发运行【并发标记】；</p>
<p>3、并发标记后，开始STW，进行重新标记；因为用户线程运行期间，可能产生一些新的对象，会对标记结果产生结果；</p>
<p>4、重新标记后，用户线程又可以继续运行，此时垃圾回收线程可以并发清理； </p>
<p>​		只有在初始标记和重新标记时STW，响应时间较短</p>
<p>给出一个概念：浮动垃圾,在并发清理时，由用户线程产生的垃圾；这些垃圾只能等待下一次垃圾回收时清理</p>
<p>注意：</p>
<p>CMS垃圾回收器，采用标记清除算法；会产生大量内存碎片；因为内存碎片过多导致无法为用户线程分配内存，造成并发失败；此时回退化为SerialOld垃圾回收器；此时，机会耗费很多时间</p>
<h3 id="4-4-G1"><a href="#4-4-G1" class="headerlink" title="4.4 G1"></a>4.4 G1</h3><p>定义：Garbage First </p>
<p>2004 论文发布 </p>
<p>2009 JDK 6u14 体验 </p>
<p>2012 JDK 7u4 官方支持 </p>
<p>2017 JDK 9 默认 【废除CMS垃圾回收器】（本身是一款并发的垃圾回收器）</p>
<p>适用场景 ：</p>
<p>同时注重吞吐量（Throughput）和低延迟（Low latency），默认的暂停目标是 200 ms </p>
<p>超大堆内存，会将堆划分为多个<strong>大小相等</strong>的<code>Region</code></p>
<p>整体上是 标记+整理 算法，两个区域之间是 复制 算法 </p>
<p>相关 JVM 参数</p>
<p> -XX:+UseG1GC </p>
<p>-XX:G1HeapRegionSize&#x3D;size </p>
<p>-XX:MaxGCPauseMillis&#x3D;time</p>
<p><strong>（1）垃圾回收阶段</strong></p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807112008878.png" srcset="/img/loading.gif" lazyload alt="image-20220807112008878"></p>
<hr>
<p><strong>（2) Young Collection</strong> </p>
<p>​	</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807112216078.png" srcset="/img/loading.gif" lazyload alt="image-20220807112216078"></p>
<hr>
<p>G1会将都内存划分为多个大小相等的区域，其中一些区域为伊甸园区【E】，有大小限制</p>
<p>当伊甸园区的内存被占满时，会触发一次垃圾回收；</p>
<p>进行新生代的垃圾回收时会STW</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807112849366.png" srcset="/img/loading.gif" lazyload alt="image-20220807112849366"></p>
<hr>
<p>将新生代幸存下来的对象，通过复制算法，放到幸存区；</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807113203408.png" srcset="/img/loading.gif" lazyload alt="image-20220807113203408"></p>
<hr>
<p>再次触发一次垃圾回收，将幸存区中符合晋升条件的对象，复制到老年代</p>
<p>将幸存区中不满足晋升条件的对象，复制到 另一个幸存区中；</p>
<p>将伊甸园中，有GCRoot对象引用的对象复制到幸存区中；</p>
<p><strong>（3) Young Collection + CM  【新生代的垃圾回收 + 并发标记】</strong></p>
<p>​		在<code>Young GC</code>时会进行 GC Root 的初始标记 【上一步，新生代的垃圾回收，STW时进行，并不会占用并发标记的时间】</p>
<p>​		<strong>老年代占 用</strong>  堆空间比例达到阈值时，进行并发标记（不会 STW），由下面的 JVM 参数决定</p>
<p>​		<code>-XX:InitiatingHeapOccupancyPercent=percent</code>（默认45%）</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807114608726.png" srcset="/img/loading.gif" lazyload alt="image-20220807114608726"></p>
<hr>
<p>当老年代【O】占用达到整个堆空间的45%时，就会进行并发标记</p>
<p><strong>（4) Mixed Collection</strong> </p>
<p>​	会对 E、S、O 进行全面垃圾回收 </p>
<p>​	最终标记（Remark）会 STW ，原因：并发标记时，用户线程也在工作，此时可能会产生新的垃圾【没有GCRoot对象应用的对象】</p>
<p>​	拷贝存活（Evacuation）会 STW </p>
<p><code>-XX:MaxGCPauseMillis=ms</code>  之前提过的设置G1垃圾回收器最大暂停时间，决定响应时间的参数，与吞吐量互斥</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807115458981.png" srcset="/img/loading.gif" lazyload alt="image-20220807115458981"></p>
<hr>
<p>对 E、S、O 进行全面垃圾回收 ，将伊甸园的幸存对象复制到幸存区，将幸存区的未能晋升的对象复制到幸存区【非自己】；</p>
<p>老年代的垃圾回收有点特别：因为要兼顾最大暂停时间，所以G1不会对所有的老年代区域进行垃圾回收；仅会挑选一些回收价值较高的区域进行垃圾回收；</p>
<p>将有GCRoot对象引用的对象复制到老年代【非自己】</p>
<p>G1：被称为Garbage first，原因：在混合收集阶段，对老年代的垃圾回收，会首先挑选回收价值最高的区域进行垃圾回收；</p>
<p>注意：在老年代的区域还不是特别多时，就算对全部的老年代进行垃圾回收，也不会影响最大暂停时间时，会对所有的老年代区域进行垃圾回收；</p>
<p>（5) Full GC </p>
<p>SerialGC </p>
<p>新生代内存不足发生的垃圾收集 - minor gc</p>
<p> 老年代内存不足发生的垃圾收集 - full gc </p>
<p>ParallelGC </p>
<p>新生代内存不足发生的垃圾收集 - minor gc </p>
<p>老年代内存不足发生的垃圾收集 - full gc </p>
<p>CMS </p>
<p>新生代内存不足发生的垃圾收集 - minor gc </p>
<p>老年代内存不足</p>
<p>​	并发收集失败后，会退化为串行收集，此时为FullGC</p>
<p>G1 </p>
<p>新生代内存不足发生的垃圾收集 - minor gc </p>
<p>老年代内存不足</p>
<p>​	当老年代的内存使用占整个堆内存的45%以上时，就会进行并发标记，然后进行混合收集；此时当垃圾收集速度 大于 并发时垃圾产生的速度</p>
<p>  【这样不会发生 FullGC】,当垃圾收集速度 小于 并发时垃圾产生的速度，此时并发收集失败，会退化为FullGC，STW地时间会特别长</p>
<p><strong>（6) Young Collection 跨代引用</strong> </p>
<p>​		新生代回收的跨代引用（老年代引用新生代）问题</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807133853983.png" srcset="/img/loading.gif" lazyload alt="image-20220807133853983"></p>
<hr>
<p>回顾垃圾回收过程：</p>
<p>首先是寻找根对象，然后使用可达性分析算法找到存活对象；然后使用三种算法之中的一种或多种进行垃圾回收；</p>
<p>问题：对新生代进行可达性分析时，要先找根对象；而老年代中有大量的根对象，那么是否是遍历老年代；</p>
<p>​		G1中是不需要的；它提出了一个叫卡表的概念（将作为老年代的region进行细分，分为一个个的卡，一个512K），在新生代中有一个<code> Remembered Set</code>的概		念，它用于记录有哪些脏卡；</p>
<p>​		G1使用 <code>post-write barrier</code>（写屏障） ,来更新脏卡；当老年代中的某个卡中的对象，引用了新生代中的对象时，写屏障会将该卡标记为脏卡；并记录到<code> Remembered Set</code> 中</p>
<p>​		</p>
<p>卡表 与 Remembered Set </p>
<p>更新脏卡的过程是一个异步的过程：</p>
<pre><code class="hljs"> 在引用变更时通过  ` post-write barrier`（写屏障） + `dirty card queue` （脏卡队列）
 
 `  concurrent refinement threads` 更新 `Remembered Set`
</code></pre>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807133918471.png" srcset="/img/loading.gif" lazyload alt="image-20220807133918471"></p>
<hr>
<p><strong>（7) Remark</strong> </p>
<p>​		<code>pre-write barrier</code> +<code> satb_mark_queue</code></p>
<p><code>pre-write barrier</code> : 写屏障，当对象引用发生变化时，会将该对象，放入一个队列（<strong>satb_mark_queue</strong>），并标记为灰色，等待以后进行重新标记</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807140534030.png" srcset="/img/loading.gif" lazyload alt="image-20220807140534030"></p>
<hr>
<p>黑色代表：已经处理完成</p>
<p>灰色代表：正在处理</p>
<p>白色代表：尚未处理</p>
<p>（8) JDK 8u20 字符串去重 </p>
<p>​	优点：节省大量内存 </p>
<p>​	缺点：略微多占用了 cpu 时间，新生代回收时间略微增加</p>
<p>开启参数： <code> -XX:+UseStringDeduplication</code></p>
<p>​	JDK1.8中，字符串的底层其实是char数组</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">s1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-string">&quot;hello&quot;</span>); <span class="hljs-comment">// char[]&#123;&#x27;h&#x27;,&#x27;e&#x27;,&#x27;l&#x27;,&#x27;l&#x27;,&#x27;o&#x27;&#125;</span><br><span class="hljs-type">String</span> <span class="hljs-variable">s2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-string">&quot;hello&quot;</span>); <span class="hljs-comment">// char[]&#123;&#x27;h&#x27;,&#x27;e&#x27;,&#x27;l&#x27;,&#x27;l&#x27;,&#x27;o&#x27;&#125;</span><br></code></pre></td></tr></table></figure>

<p>将所有新分配的字符串放入一个队列 </p>
<p>当新生代回收时，G1并发检查是否有字符串重复 </p>
<p>如果它们值一样，让它们  <strong>引用同一个 char[]</strong> </p>
<p>注意，与 String.intern() 不一样</p>
<p>​	String.intern() 关注的是字符串对象</p>
<p>​	而字符串去重关注的是 char[] </p>
<p>​	在 JVM 内部，使用了不同的字符串表</p>
<p><strong>（9) JDK 8u40 并发标记类卸载</strong> </p>
<p>​	所有对象都经过并发标记后，就能知道哪些类不再被使用</p>
<p>​	当 一个类加载器 的 <strong>所有类都不再使用</strong>，则 <strong>卸 载它所加载的所有类</strong> </p>
<p>​	注意：</p>
<p>​		JDK的三个类加载器，是不会进行类卸载的；只有自定义的类加载器才会进行类卸载；</p>
<p><code>	XX:+ClassUnloadingWithConcurrentMark</code> 默认启用</p>
<p>（10) JDK 8u60 回收巨型对象 </p>
<p>​		一个对象大于 region 的一半时，称之为<code>巨型对象 </code></p>
<p>​		G1 不会对巨型对象进行拷贝 </p>
<p>​		回收时被优先考虑 </p>
<p>​		G1 会跟踪老年代所有 incoming 引用，这样老年代 incoming 引用为0 的巨型对象就可以在新生 代垃圾回收时处理掉【即：当老年代中的所有卡不再对某个		新生代中的巨型对象进行引用时，就可以回收掉】</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807151352836.png" srcset="/img/loading.gif" lazyload alt="image-20220807151352836"></p>
<hr>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807151250734.png" srcset="/img/loading.gif" lazyload alt="image-20220807151250734"></p>
<hr>
<p><strong>（11) JDK 9 并发标记起始时间的调整</strong> </p>
<p>​		并发标记必须在堆空间占满前完成，否则退化为 FullGC 【不是串行】</p>
<p>​		JDK 9 之前需要使用	<code>-XX:InitiatingHeapOccupancyPercent</code>  45%</p>
<p>​		JDK 9 可以动态调整 </p>
<p>​		<code>	-XX:InitiatingHeapOccupancyPercent </code>用来设置初始值 </p>
<p>​			进行数据采样并动态调整 </p>
<p>​			总会添加一个安全的空档空间</p>
<h2 id="5-0-垃圾回收调优"><a href="#5-0-垃圾回收调优" class="headerlink" title="5.0 垃圾回收调优"></a>5.0 垃圾回收调优</h2><p>预备知识 </p>
<p>掌握 GC 相关的 VM 参数，会基本的空间调整 掌握相关工具 </p>
<p>明白一点：调优跟应用、环境有关，没有放之四海而皆准的法则</p>
<p>​	参考Oracle的JVM调优指南：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/12/gctuning/">Java Platform, Standard Edition HotSpot Virtual Machine Garbage Collection Tuning Guide, Release 12 (oracle.com)</a></p>
</blockquote>
<p>查看虚拟机运行参数：</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c"><span class="hljs-string">&quot;D:\sofeware\Idea\JDK1.8\bin\java&quot;</span> -XX:+PrintFlagsFinal -version <span class="hljs-string">| findstr &quot;</span>GC<span class="hljs-string">&quot;</span><br></code></pre></td></tr></table></figure>



<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">  <span class="hljs-built_in">uint</span>x AdaptiveSizeMajorGCDecayTimeScale         = <span class="hljs-number">10</span>                                  &#123;product&#125;<br>    <span class="hljs-built_in">uint</span>x AutoGCSelectPauseMillis                   = <span class="hljs-number">5000</span>                                &#123;product&#125;<br>     <span class="hljs-built_in">bool</span> BindGCTaskThreadsToCPUs                   = <span class="hljs-literal">false</span>                               &#123;product&#125;<br>    <span class="hljs-built_in">uint</span>x CMSFullGCsBeforeCompaction                = <span class="hljs-number">0</span>                                   &#123;product&#125;<br>    <span class="hljs-built_in">uint</span>x ConcGCThreads                             = <span class="hljs-number">0</span>                                   &#123;product&#125;<br>     <span class="hljs-built_in">bool</span> DisableExplicitGC                         = <span class="hljs-literal">false</span>                               &#123;product&#125;<br>     <span class="hljs-built_in">bool</span> ExplicitGCInvokesConcurrent               = <span class="hljs-literal">false</span>                               &#123;product&#125;<br>     <span class="hljs-built_in">bool</span> ExplicitGCInvokesConcurrentAndUnloadsClasses  = <span class="hljs-literal">false</span>                               &#123;product&#125;<br>    <span class="hljs-built_in">uint</span>x G1MixedGCCountTarget                      = <span class="hljs-number">8</span>                                   &#123;product&#125;<br>    <span class="hljs-built_in">uint</span>x GCDrainStackTargetSize                    = <span class="hljs-number">64</span>                                  &#123;product&#125;<br>    <span class="hljs-built_in">uint</span>x GCHeapFreeLimit                           = <span class="hljs-number">2</span>                                   &#123;product&#125;<br>    <span class="hljs-built_in">uint</span>x GCLockerEdenExpansionPercent              = <span class="hljs-number">5</span>                                   &#123;product&#125;<br>     <span class="hljs-built_in">bool</span> GCLockerInvokesConcurrent                 = <span class="hljs-literal">false</span>                               &#123;product&#125;<br>    <span class="hljs-built_in">uint</span>x GCLogFileSize                             = <span class="hljs-number">8192</span>                                &#123;product&#125;<br>    <span class="hljs-built_in">uint</span>x GCPauseIntervalMillis                     = <span class="hljs-number">0</span>                                   &#123;product&#125;<br>    <span class="hljs-built_in">uint</span>x GCTaskTimeStampEntries                    = <span class="hljs-number">200</span>                                 &#123;product&#125;<br>    <span class="hljs-built_in">uint</span>x GCTimeLimit                               = <span class="hljs-number">98</span>                                  &#123;product&#125;<br>    <span class="hljs-built_in">uint</span>x GCTimeRatio                               = <span class="hljs-number">99</span>                                  &#123;product&#125;<br>     <span class="hljs-built_in">bool</span> HeapDumpAfterFullGC                       = <span class="hljs-literal">false</span>                               &#123;manageable&#125;<br>     <span class="hljs-built_in">bool</span> HeapDumpBeforeFullGC                      = <span class="hljs-literal">false</span>                               &#123;manageable&#125;<br>    <span class="hljs-built_in">uint</span>x HeapSizePerGCThread                       = <span class="hljs-number">87241520</span>                            &#123;product&#125;<br>    <span class="hljs-built_in">uint</span>x MaxGCMinorPauseMillis                     = <span class="hljs-number">4294967295</span>                          &#123;product&#125;<br>    <span class="hljs-built_in">uint</span>x MaxGCPauseMillis                          = <span class="hljs-number">4294967295</span>                          &#123;product&#125;<br>    <span class="hljs-built_in">uint</span>x NumberOfGCLogFiles                        = <span class="hljs-number">0</span>                                   &#123;product&#125;<br>     <span class="hljs-built_in">int</span>x ParGCArrayScanChunk                       = <span class="hljs-number">50</span>                                  &#123;product&#125;<br>    <span class="hljs-built_in">uint</span>x ParGCDesiredObjsFromOverflowList          = <span class="hljs-number">20</span>                                  &#123;product&#125;<br>     <span class="hljs-built_in">bool</span> ParGCTrimOverflow                         = <span class="hljs-literal">true</span>                                &#123;product&#125;<br>     <span class="hljs-built_in">bool</span> ParGCUseLocalOverflow                     = <span class="hljs-literal">false</span>                               &#123;product&#125;<br>    <span class="hljs-built_in">uint</span>x ParallelGCBufferWastePct                  = <span class="hljs-number">10</span>                                  &#123;product&#125;<br>    <span class="hljs-built_in">uint</span>x ParallelGCThreads                         = <span class="hljs-number">13</span>                                  &#123;product&#125;<br>     <span class="hljs-built_in">bool</span> ParallelGCVerbose                         = <span class="hljs-literal">false</span>                               &#123;product&#125;<br>     <span class="hljs-built_in">bool</span> PrintClassHistogramAfterFullGC            = <span class="hljs-literal">false</span>                               &#123;manageable&#125;<br>     <span class="hljs-built_in">bool</span> PrintClassHistogramBeforeFullGC           = <span class="hljs-literal">false</span>                               &#123;manageable&#125;<br>     <span class="hljs-built_in">bool</span> PrintGC                                   = <span class="hljs-literal">false</span>                               &#123;manageable&#125;<br>     <span class="hljs-built_in">bool</span> PrintGCApplicationConcurrentTime          = <span class="hljs-literal">false</span>                               &#123;product&#125;<br>     <span class="hljs-built_in">bool</span> PrintGCApplicationStoppedTime             = <span class="hljs-literal">false</span>                               &#123;product&#125;<br>     <span class="hljs-built_in">bool</span> PrintGCCause                              = <span class="hljs-literal">true</span>                                &#123;product&#125;<br>     <span class="hljs-built_in">bool</span> PrintGCDateStamps                         = <span class="hljs-literal">false</span>                               &#123;manageable&#125;<br>     <span class="hljs-built_in">bool</span> PrintGCDetails                            = <span class="hljs-literal">false</span>                               &#123;manageable&#125;<br>     <span class="hljs-built_in">bool</span> PrintGCID                                 = <span class="hljs-literal">false</span>                               &#123;manageable&#125;<br>     <span class="hljs-built_in">bool</span> PrintGCTaskTimeStamps                     = <span class="hljs-literal">false</span>                               &#123;product&#125;<br>     <span class="hljs-built_in">bool</span> PrintGCTimeStamps                         = <span class="hljs-literal">false</span>                               &#123;manageable&#125;<br>     <span class="hljs-built_in">bool</span> PrintHeapAtGC                             = <span class="hljs-literal">false</span>                               &#123;product rw&#125;<br>     <span class="hljs-built_in">bool</span> PrintHeapAtGCExtended                     = <span class="hljs-literal">false</span>                               &#123;product rw&#125;<br>     <span class="hljs-built_in">bool</span> PrintJNIGCStalls                          = <span class="hljs-literal">false</span>                               &#123;product&#125;<br>     <span class="hljs-built_in">bool</span> PrintParallelOldGCPhaseTimes              = <span class="hljs-literal">false</span>                               &#123;product&#125;<br>     <span class="hljs-built_in">bool</span> PrintReferenceGC                          = <span class="hljs-literal">false</span>                               &#123;product&#125;<br>     <span class="hljs-built_in">bool</span> ScavengeBeforeFullGC                      = <span class="hljs-literal">true</span>                                &#123;product&#125;<br>     <span class="hljs-built_in">bool</span> TraceDynamicGCThreads                     = <span class="hljs-literal">false</span>                               &#123;product&#125;<br>     <span class="hljs-built_in">bool</span> TraceParallelOldGCTasks                   = <span class="hljs-literal">false</span>                               &#123;product&#125;<br>     <span class="hljs-built_in">bool</span> UseAdaptiveGCBoundary                     = <span class="hljs-literal">false</span>                               &#123;product&#125;<br>     <span class="hljs-built_in">bool</span> UseAdaptiveSizeDecayMajorGCCost           = <span class="hljs-literal">true</span>                                &#123;product&#125;<br>     <span class="hljs-built_in">bool</span> UseAdaptiveSizePolicyWithSystemGC         = <span class="hljs-literal">false</span>                               &#123;product&#125;<br>     <span class="hljs-built_in">bool</span> UseAutoGCSelectPolicy                     = <span class="hljs-literal">false</span>                               &#123;product&#125;<br>     <span class="hljs-built_in">bool</span> UseConcMarkSweepGC                        = <span class="hljs-literal">false</span>                               &#123;product&#125;<br>     <span class="hljs-built_in">bool</span> UseDynamicNumberOfGCThreads               = <span class="hljs-literal">false</span>                               &#123;product&#125;<br>     <span class="hljs-built_in">bool</span> UseG1GC                                   = <span class="hljs-literal">false</span>                               &#123;product&#125;<br>     <span class="hljs-built_in">bool</span> UseGCLogFileRotation                      = <span class="hljs-literal">false</span>                               &#123;product&#125;<br>     <span class="hljs-built_in">bool</span> UseGCOverheadLimit                        = <span class="hljs-literal">true</span>                                &#123;product&#125;<br>     <span class="hljs-built_in">bool</span> UseGCTaskAffinity                         = <span class="hljs-literal">false</span>                               &#123;product&#125;<br>     <span class="hljs-built_in">bool</span> UseMaximumCompactionOnSystemGC            = <span class="hljs-literal">true</span>                                &#123;product&#125;<br>     <span class="hljs-built_in">bool</span> UseParNewGC                               = <span class="hljs-literal">false</span>                               &#123;product&#125;<br>     <span class="hljs-built_in">bool</span> UseParallelGC                            := <span class="hljs-literal">true</span>                                &#123;product&#125;<br>     <span class="hljs-built_in">bool</span> UseParallelOldGC                          = <span class="hljs-literal">true</span>                                &#123;product&#125;<br>     <span class="hljs-built_in">bool</span> UseSerialGC                               = <span class="hljs-literal">false</span>                               &#123;product&#125;<br>java version <span class="hljs-string">&quot;1.8.0_201&quot;</span><br>Java(TM) SE Runtime Environment (build <span class="hljs-number">1.8</span><span class="hljs-number">.0</span>_201-b09)<br>Java HotSpot(TM) <span class="hljs-number">64</span>-Bit Server VM (build <span class="hljs-number">25.201</span>-b09, mixed mode)<br></code></pre></td></tr></table></figure>





<h2 id="5-1-调优领域"><a href="#5-1-调优领域" class="headerlink" title="5.1 调优领域"></a>5.1 调优领域</h2><p>内存 </p>
<p>锁竞争 </p>
<p>cpu 占用 </p>
<p>io</p>
<h2 id="5-2-确定目标"><a href="#5-2-确定目标" class="headerlink" title="5.2 确定目标"></a>5.2 确定目标</h2><p>【低延迟】还是【高吞吐量】，选择合适的回收器 </p>
<p>CMS，G1，ZGC </p>
<p>ParallelGC</p>
<p>以上是HotSpot虚拟机的垃圾回收器</p>
<p>Zing 是一个虚拟机，它的垃圾回收器也是兼顾高吞吐量和高响应</p>
<h2 id="5-3-最快的-GC"><a href="#5-3-最快的-GC" class="headerlink" title="5.3 最快的 GC"></a>5.3 最快的 GC</h2><p>答案是不发生</p>
<p>GC 查看 FullGC 前后的内存占用，考虑下面几个问题 ：</p>
<p>数据是不是太多？</p>
<p>​	resultSet &#x3D; statement.executeQuery(“select * from table”) </p>
<p>数据表示是否太臃肿？</p>
<p>​	对象图</p>
<p>​	对象大小 1最小的对象是16B； Integer一个对象头16B，int类型的数据要占用4B，再加上对齐就是24B </p>
<p>是否存在内存泄漏？ </p>
<p>​	static Map map &#x3D; new HashMap&lt;&gt;();定义了一个静态的Map集合，不断地往里面放数据</p>
<p>​	软【发生一次GC，发现堆内存还是不足，将软引用关联的对象所占用的内存释放掉】</p>
<p>​    弱 【只要发生GC，就将堆内存中弱引用所关联的对象所占用的内存释放掉】</p>
<p>​	第三方缓存实现</p>
<h2 id="5-4-新生代调优"><a href="#5-4-新生代调优" class="headerlink" title="5.4 新生代调优"></a>5.4 新生代调优</h2><p>1、新生代的特点 所有的 new 操作的内存分配非常廉价 </p>
<p>​	这里提出一个： <code>thread-local allocation buffer</code>(TLAB) 本地线程缓冲区的概念；为了避免不同线程，想要使用同一块线程而提出的；</p>
<p>​	为不同线程在伊甸园区分配一块区域，它们会在各自的缓冲区中创建对象；避免并发问题</p>
<p>2、死亡对象的回收代价是零 </p>
<p>​	伊甸园和from区中的幸存对象，会被复制到to区中；然后直接将伊甸园区和之前的from区的内存地址标记为空闲；</p>
<p>3、大部分对象用过即死 </p>
<p>4、Minor GC 的时间远远低于 Full GC</p>
<p>​	原因：新生代中存活的对象本来就少，且使用的是复制算法，STW的时间很短；</p>
<p>新生代的调优一般可采用 调大堆内存空间；</p>
<p>越大越好吗？</p>
<p>GC is performed in this region more often than in other regions. If the size for the young generation is too small, then a lot of minor garbage collections are performed. If the size is too large, then only full garbage collections are performed, which can take a long time to complete. Oracle recommends that you keep the size for the young generation greater than 25% and less than 50% of the overall heap size.</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs gcode">GC在这个区域比在其他区域执行得更频繁。如果新生代的大小太小，那么就会执行许多小的垃圾收集<br>如果太大，则只执行完整的垃圾收集（FullGC）【因为新生代大了，所以老年代就会变小】，这可能需要很长时间才能完成<br>Oracle建议您将新生代的大小保持在总堆大小的<span class="hljs-number">25</span><span class="hljs-meta">%</span>以上、<span class="hljs-number">50</span><span class="hljs-meta">%</span>以下<br></code></pre></td></tr></table></figure>

<p>但是，总的来说还是希望 新生代的内存尽可能大</p>
<p>JVM参数：<code>-Xmn </code> 为新生代代设置堆的初始和最大大小(以字节为单位)</p>
<p><strong>新生代配置原则：</strong></p>
<p>1、新生代能容纳所有【并发量 * (请求与响应所创建的对象所需的内存)】为合适；因为这样可以不触发，或者是较少第触发垃圾回收；</p>
<p>2、幸存区大到能保留【当前活跃对象+需要晋升对象】 </p>
<p>​		当前活跃对象：当前不能回收，但发生GC后一定会回收</p>
<p>​		需要晋升对象：当前不能回收，发生GC后也不能回收，只是没达到晋升阈值；</p>
<p>​		当幸存区较小，JVM会动态调整幸存区的晋升阈值；使得一些对象会提前晋升到老年代中；这样会使得当老年代的内存不足触发FullGC时，该对象才会被释放		掉，这样就会大大延长了垃圾的生存时间；</p>
<p>3、晋升阈值配置得当，让长时间存活对象尽快晋升</p>
<p><code> -XX:MaxTenuringThreshold=threshold</code> 设置最大晋升阈值</p>
<p><code> -XX:+PrintTenuringDistribution</code> 打印晋升的详细信息</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs tap">Desired survivor size<span class="hljs-number"> 48286924 </span>bytes, new threshold<span class="hljs-number"> 10 </span>(max 10)<br>- age 1:<span class="hljs-number"> 28992024 </span>bytes,<span class="hljs-number"> 28992024 </span>total   【年龄为一的：刚逃过一次MinorGC】<br>- age 2:<span class="hljs-number"> 1366864 </span>bytes,<span class="hljs-number"> 30358888 </span>total<br>- age 3:<span class="hljs-number"> 1425912 </span>bytes,<span class="hljs-number"> 31784800 </span>total<br>...<br><br></code></pre></td></tr></table></figure>





<h2 id="5-5-老年代调优"><a href="#5-5-老年代调优" class="headerlink" title="5.5 老年代调优"></a>5.5 老年代调优</h2><p><strong>以 CMS 为例</strong> </p>
<p>1、CMS 的老年代内存越大越好 </p>
<p>​		CMS是一个工作于老年代的垃圾回收器，是可以并发执行的，响应时间较短的垃圾回收器；用户线程与垃圾回收线程并发运行，由用户线程在次期间产生的垃		圾【浮动垃圾】，如果不能即时清理，就会并发失败；CMS会退化为 Se ri al Ol d（串行的垃圾回收器）；所以，老年代的空间越大越好，为浮动垃圾提供额		外的内存，避免并发失败；而发生FullGC</p>
<p>先尝试不做调优，如果没有 Full GC 那么已经…，否则先尝试调优新生代 </p>
<p>观察发生 Full GC 时老年代内存占用，将老年代内存预设调大 1&#x2F;4 ~ 1&#x2F;3 </p>
<p>​	<code>-XX:CMSInitiatingOccupancyFraction=percent</code> 空间占用达到老年代百分之多少时，使用CMS进行垃圾回收【一般预留20%的空间给浮动垃圾就可以了】</p>
<h2 id="5-6-案例"><a href="#5-6-案例" class="headerlink" title="5.6 案例"></a>5.6 案例</h2><p>案例1 Full GC 和 Minor GC频繁 </p>
<p>​	做法：调大新生代的大小，新生代的变大使得幸存区也跟着变大，晋升阈值提升；把存活时间较短的对象留在新生代；将存活时间较长的对象放到老年代</p>
<p>案例2 请求高峰期发生 Full GC，单次暂停时间特别长 （CMS） </p>
<p>​	做法：因为CMS最耗时间的是在重新标记阶段；所以选择在进行重新标记前先进行一次MinorGC，以减少新生代的对象；减少重新标记时，对新生代对象的处	理；</p>
<p>​	<code>-XX : +CMSScavengeBeforeRemark</code></p>
<p>案例3 老年代充裕情况下，发生 Full GC （CMS jdk1.7）</p>
<p>​		老年代充裕情况下:说明没有因为内存不足【碎片】导致并发失败，考虑是不是是JDK1.7版本；</p>
<p>​		因为JDK1.7的永久代放在堆内存中，永久代的空间不足也会导致FullGC</p>
<h1 id="六、类加载与字节码技术"><a href="#六、类加载与字节码技术" class="headerlink" title="六、类加载与字节码技术"></a>六、类加载与字节码技术</h1><hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807175240103.png" srcset="/img/loading.gif" lazyload alt="image-20220807175240103"></p>
<hr>
<h2 id="1-类文件结构"><a href="#1-类文件结构" class="headerlink" title="1. 类文件结构"></a>1. 类文件结构</h2><p>一个简单的 HelloWorld.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t5;<br><span class="hljs-comment">// HelloWorld 示例</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloWorld</span> &#123;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>System.out.println(<span class="hljs-string">&quot;hello world&quot;</span>);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>编译：执行 <code>javac -parameters -d . HellowWorld.java</code></p>
<p>编译为 HelloWorld.class 后是这个样子的：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">0000000</span> ca fe ba be <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">34</span> <span class="hljs-number">00</span> <span class="hljs-number">23</span> <span class="hljs-number">0</span>a <span class="hljs-number">00</span> <span class="hljs-number">06</span> <span class="hljs-number">00</span> <span class="hljs-number">15</span> <span class="hljs-number">09</span><br><span class="hljs-attribute">0000020</span> <span class="hljs-number">00</span> <span class="hljs-number">16</span> <span class="hljs-number">00</span> <span class="hljs-number">17</span> <span class="hljs-number">08</span> <span class="hljs-number">00</span> <span class="hljs-number">18</span> <span class="hljs-number">0</span>a <span class="hljs-number">00</span> <span class="hljs-number">19</span> <span class="hljs-number">00</span> <span class="hljs-number">1</span>a <span class="hljs-number">07</span> <span class="hljs-number">00</span> <span class="hljs-number">1</span>b <span class="hljs-number">07</span><br><span class="hljs-attribute">0000040</span> <span class="hljs-number">00</span> <span class="hljs-number">1</span>c <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">06</span> <span class="hljs-number">3</span>c <span class="hljs-number">69</span> <span class="hljs-number">6</span>e <span class="hljs-number">69</span> <span class="hljs-number">74</span> <span class="hljs-number">3</span>e <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">03</span> <span class="hljs-number">28</span> <span class="hljs-number">29</span><br><span class="hljs-attribute">0000060</span> <span class="hljs-number">56</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">04</span> <span class="hljs-number">43</span> <span class="hljs-number">6</span>f <span class="hljs-number">64</span> <span class="hljs-number">65</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">0</span>f <span class="hljs-number">4</span>c <span class="hljs-number">69</span> <span class="hljs-number">6</span>e <span class="hljs-number">65</span> <span class="hljs-number">4</span>e<br><span class="hljs-attribute">0000100</span> <span class="hljs-number">75</span> <span class="hljs-number">6</span>d <span class="hljs-number">62</span> <span class="hljs-number">65</span> <span class="hljs-number">72</span> <span class="hljs-number">54</span> <span class="hljs-number">61</span> <span class="hljs-number">62</span> <span class="hljs-number">6</span>c <span class="hljs-number">65</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">12</span> <span class="hljs-number">4</span>c <span class="hljs-number">6</span>f <span class="hljs-number">63</span><br><span class="hljs-attribute">0000120</span> <span class="hljs-number">61</span> <span class="hljs-number">6</span>c <span class="hljs-number">56</span> <span class="hljs-number">61</span> <span class="hljs-number">72</span> <span class="hljs-number">69</span> <span class="hljs-number">61</span> <span class="hljs-number">62</span> <span class="hljs-number">6</span>c <span class="hljs-number">65</span> <span class="hljs-number">54</span> <span class="hljs-number">61</span> <span class="hljs-number">62</span> <span class="hljs-number">6</span>c <span class="hljs-number">65</span> <span class="hljs-number">01</span><br><span class="hljs-attribute">0000140</span> <span class="hljs-number">00</span> <span class="hljs-number">04</span> <span class="hljs-number">74</span> <span class="hljs-number">68</span> <span class="hljs-number">69</span> <span class="hljs-number">73</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">1</span>d <span class="hljs-number">4</span>c <span class="hljs-number">63</span> <span class="hljs-number">6</span>e <span class="hljs-number">2</span>f <span class="hljs-number">69</span> <span class="hljs-number">74</span> <span class="hljs-number">63</span><br><span class="hljs-attribute">0000160</span> <span class="hljs-number">61</span> <span class="hljs-number">73</span> <span class="hljs-number">74</span> <span class="hljs-number">2</span>f <span class="hljs-number">6</span>a <span class="hljs-number">76</span> <span class="hljs-number">6</span>d <span class="hljs-number">2</span>f <span class="hljs-number">74</span> <span class="hljs-number">35</span> <span class="hljs-number">2</span>f <span class="hljs-number">48</span> <span class="hljs-number">65</span> <span class="hljs-number">6</span>c <span class="hljs-number">6</span>c <span class="hljs-number">6</span>f<br><span class="hljs-attribute">0000200</span> <span class="hljs-number">57</span> <span class="hljs-number">6</span>f <span class="hljs-number">72</span> <span class="hljs-number">6</span>c <span class="hljs-number">64</span> <span class="hljs-number">3</span>b <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">04</span> <span class="hljs-number">6</span>d <span class="hljs-number">61</span> <span class="hljs-number">69</span> <span class="hljs-number">6</span>e <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">16</span><br><span class="hljs-attribute">0000220</span> <span class="hljs-number">28</span> <span class="hljs-number">5</span>b <span class="hljs-number">4</span>c <span class="hljs-number">6</span>a <span class="hljs-number">61</span> <span class="hljs-number">76</span> <span class="hljs-number">61</span> <span class="hljs-number">2</span>f <span class="hljs-number">6</span>c <span class="hljs-number">61</span> <span class="hljs-number">6</span>e <span class="hljs-number">67</span> <span class="hljs-number">2</span>f <span class="hljs-number">53</span> <span class="hljs-number">74</span> <span class="hljs-number">72</span><br><span class="hljs-attribute">0000240</span> <span class="hljs-number">69</span> <span class="hljs-number">6</span>e <span class="hljs-number">67</span> <span class="hljs-number">3</span>b <span class="hljs-number">29</span> <span class="hljs-number">56</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">04</span> <span class="hljs-number">61</span> <span class="hljs-number">72</span> <span class="hljs-number">67</span> <span class="hljs-number">73</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">13</span><br><span class="hljs-attribute">0000260</span> <span class="hljs-number">5</span>b <span class="hljs-number">4</span>c <span class="hljs-number">6</span>a <span class="hljs-number">61</span> <span class="hljs-number">76</span> <span class="hljs-number">61</span> <span class="hljs-number">2</span>f <span class="hljs-number">6</span>c <span class="hljs-number">61</span> <span class="hljs-number">6</span>e <span class="hljs-number">67</span> <span class="hljs-number">2</span>f <span class="hljs-number">53</span> <span class="hljs-number">74</span> <span class="hljs-number">72</span> <span class="hljs-number">69</span><br><span class="hljs-attribute">0000300</span> <span class="hljs-number">6</span>e <span class="hljs-number">67</span> <span class="hljs-number">3</span>b <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">10</span> <span class="hljs-number">4</span>d <span class="hljs-number">65</span> <span class="hljs-number">74</span> <span class="hljs-number">68</span> <span class="hljs-number">6</span>f <span class="hljs-number">64</span> <span class="hljs-number">50</span> <span class="hljs-number">61</span> <span class="hljs-number">72</span> <span class="hljs-number">61</span><br><span class="hljs-attribute">0000320</span> <span class="hljs-number">6</span>d <span class="hljs-number">65</span> <span class="hljs-number">74</span> <span class="hljs-number">65</span> <span class="hljs-number">72</span> <span class="hljs-number">73</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">0</span>a <span class="hljs-number">53</span> <span class="hljs-number">6</span>f <span class="hljs-number">75</span> <span class="hljs-number">72</span> <span class="hljs-number">63</span> <span class="hljs-number">65</span> <span class="hljs-number">46</span><br><span class="hljs-attribute">0000340</span> <span class="hljs-number">69</span> <span class="hljs-number">6</span>c <span class="hljs-number">65</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">0</span>f <span class="hljs-number">48</span> <span class="hljs-number">65</span> <span class="hljs-number">6</span>c <span class="hljs-number">6</span>c <span class="hljs-number">6</span>f <span class="hljs-number">57</span> <span class="hljs-number">6</span>f <span class="hljs-number">72</span> <span class="hljs-number">6</span>c <span class="hljs-number">64</span><br><span class="hljs-attribute">0000360</span> <span class="hljs-number">2</span>e <span class="hljs-number">6</span>a <span class="hljs-number">61</span> <span class="hljs-number">76</span> <span class="hljs-number">61</span> <span class="hljs-number">0</span>c <span class="hljs-number">00</span> <span class="hljs-number">07</span> <span class="hljs-number">00</span> <span class="hljs-number">08</span> <span class="hljs-number">07</span> <span class="hljs-number">00</span> <span class="hljs-number">1</span>d <span class="hljs-number">0</span>c <span class="hljs-number">00</span> <span class="hljs-number">1</span>e<br><span class="hljs-attribute">0000400</span> <span class="hljs-number">00</span> <span class="hljs-number">1</span>f <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">0</span>b <span class="hljs-number">68</span> <span class="hljs-number">65</span> <span class="hljs-number">6</span>c <span class="hljs-number">6</span>c <span class="hljs-number">6</span>f <span class="hljs-number">20</span> <span class="hljs-number">77</span> <span class="hljs-number">6</span>f <span class="hljs-number">72</span> <span class="hljs-number">6</span>c <span class="hljs-number">64</span><br><span class="hljs-attribute">0000420</span> <span class="hljs-number">07</span> <span class="hljs-number">00</span> <span class="hljs-number">20</span> <span class="hljs-number">0</span>c <span class="hljs-number">00</span> <span class="hljs-number">21</span> <span class="hljs-number">00</span> <span class="hljs-number">22</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">1</span>b <span class="hljs-number">63</span> <span class="hljs-number">6</span>e <span class="hljs-number">2</span>f <span class="hljs-number">69</span> <span class="hljs-number">74</span><br><span class="hljs-attribute">0000440</span> <span class="hljs-number">63</span> <span class="hljs-number">61</span> <span class="hljs-number">73</span> <span class="hljs-number">74</span> <span class="hljs-number">2</span>f <span class="hljs-number">6</span>a <span class="hljs-number">76</span> <span class="hljs-number">6</span>d <span class="hljs-number">2</span>f <span class="hljs-number">74</span> <span class="hljs-number">35</span> <span class="hljs-number">2</span>f <span class="hljs-number">48</span> <span class="hljs-number">65</span> <span class="hljs-number">6</span>c <span class="hljs-number">6</span>c<br><span class="hljs-attribute">0000460</span> <span class="hljs-number">6</span>f <span class="hljs-number">57</span> <span class="hljs-number">6</span>f <span class="hljs-number">72</span> <span class="hljs-number">6</span>c <span class="hljs-number">64</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">10</span> <span class="hljs-number">6</span>a <span class="hljs-number">61</span> <span class="hljs-number">76</span> <span class="hljs-number">61</span> <span class="hljs-number">2</span>f <span class="hljs-number">6</span>c <span class="hljs-number">61</span><br><span class="hljs-attribute">0000500</span> <span class="hljs-number">6</span>e <span class="hljs-number">67</span> <span class="hljs-number">2</span>f <span class="hljs-number">4</span>f <span class="hljs-number">62</span> <span class="hljs-number">6</span>a <span class="hljs-number">65</span> <span class="hljs-number">63</span> <span class="hljs-number">74</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">10</span> <span class="hljs-number">6</span>a <span class="hljs-number">61</span> <span class="hljs-number">76</span> <span class="hljs-number">61</span><br><span class="hljs-attribute">0000520</span> <span class="hljs-number">2</span>f <span class="hljs-number">6</span>c <span class="hljs-number">61</span> <span class="hljs-number">6</span>e <span class="hljs-number">67</span> <span class="hljs-number">2</span>f <span class="hljs-number">53</span> <span class="hljs-number">79</span> <span class="hljs-number">73</span> <span class="hljs-number">74</span> <span class="hljs-number">65</span> <span class="hljs-number">6</span>d <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">03</span> <span class="hljs-number">6</span>f<br><span class="hljs-attribute">0000540</span> <span class="hljs-number">75</span> <span class="hljs-number">74</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">15</span> <span class="hljs-number">4</span>c <span class="hljs-number">6</span>a <span class="hljs-number">61</span> <span class="hljs-number">76</span> <span class="hljs-number">61</span> <span class="hljs-number">2</span>f <span class="hljs-number">69</span> <span class="hljs-number">6</span>f <span class="hljs-number">2</span>f <span class="hljs-number">50</span> <span class="hljs-number">72</span><br><span class="hljs-attribute">0000560</span> <span class="hljs-number">69</span> <span class="hljs-number">6</span>e <span class="hljs-number">74</span> <span class="hljs-number">53</span> <span class="hljs-number">74</span> <span class="hljs-number">72</span> <span class="hljs-number">65</span> <span class="hljs-number">61</span> <span class="hljs-number">6</span>d <span class="hljs-number">3</span>b <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">13</span> <span class="hljs-number">6</span>a <span class="hljs-number">61</span> <span class="hljs-number">76</span><br><span class="hljs-attribute">0000600</span> <span class="hljs-number">61</span> <span class="hljs-number">2</span>f <span class="hljs-number">69</span> <span class="hljs-number">6</span>f <span class="hljs-number">2</span>f <span class="hljs-number">50</span> <span class="hljs-number">72</span> <span class="hljs-number">69</span> <span class="hljs-number">6</span>e <span class="hljs-number">74</span> <span class="hljs-number">53</span> <span class="hljs-number">74</span> <span class="hljs-number">72</span> <span class="hljs-number">65</span> <span class="hljs-number">61</span> <span class="hljs-number">6</span>d<br><span class="hljs-attribute">0000620</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">07</span> <span class="hljs-number">70</span> <span class="hljs-number">72</span> <span class="hljs-number">69</span> <span class="hljs-number">6</span>e <span class="hljs-number">74</span> <span class="hljs-number">6</span>c <span class="hljs-number">6</span>e <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">15</span> <span class="hljs-number">28</span> <span class="hljs-number">4</span>c <span class="hljs-number">6</span>a<br><span class="hljs-attribute">0000640</span> <span class="hljs-number">61</span> <span class="hljs-number">76</span> <span class="hljs-number">61</span> <span class="hljs-number">2</span>f <span class="hljs-number">6</span>c <span class="hljs-number">61</span> <span class="hljs-number">6</span>e <span class="hljs-number">67</span> <span class="hljs-number">2</span>f <span class="hljs-number">53</span> <span class="hljs-number">74</span> <span class="hljs-number">72</span> <span class="hljs-number">69</span> <span class="hljs-number">6</span>e <span class="hljs-number">67</span> <span class="hljs-number">3</span>b<br><span class="hljs-attribute">0000660</span> <span class="hljs-number">29</span> <span class="hljs-number">56</span> <span class="hljs-number">00</span> <span class="hljs-number">21</span> <span class="hljs-number">00</span> <span class="hljs-number">05</span> <span class="hljs-number">00</span> <span class="hljs-number">06</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">00</span> <span class="hljs-number">01</span><br><span class="hljs-attribute">0000700</span> <span class="hljs-number">00</span> <span class="hljs-number">07</span> <span class="hljs-number">00</span> <span class="hljs-number">08</span> <span class="hljs-number">00</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">09</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">2</span>f <span class="hljs-number">00</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">01</span><br><span class="hljs-attribute">0000720</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">05</span> <span class="hljs-number">2</span>a b7 <span class="hljs-number">00</span> <span class="hljs-number">01</span> b1 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">00</span> <span class="hljs-number">0</span>a <span class="hljs-number">00</span><br><span class="hljs-attribute">0000740</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">06</span> <span class="hljs-number">00</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">04</span> <span class="hljs-number">00</span> <span class="hljs-number">0</span>b <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">0</span>c <span class="hljs-number">00</span><br><span class="hljs-attribute">0000760</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">05</span> <span class="hljs-number">00</span> <span class="hljs-number">0</span>c <span class="hljs-number">00</span> <span class="hljs-number">0</span>d <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">09</span> <span class="hljs-number">00</span> <span class="hljs-number">0</span>e <span class="hljs-number">00</span><br><span class="hljs-attribute">0001000</span> <span class="hljs-number">0</span>f <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">00</span> <span class="hljs-number">09</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">37</span> <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">00</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br><span class="hljs-attribute">0001020</span> <span class="hljs-number">09</span> b2 <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">12</span> <span class="hljs-number">03</span> b6 <span class="hljs-number">00</span> <span class="hljs-number">04</span> b1 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">00</span> <span class="hljs-number">0</span>a<br><span class="hljs-attribute">0001040</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">0</span>a <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">06</span> <span class="hljs-number">00</span> <span class="hljs-number">08</span> <span class="hljs-number">00</span> <span class="hljs-number">07</span> <span class="hljs-number">00</span> <span class="hljs-number">0</span>b<br><span class="hljs-attribute">0001060</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">0</span>c <span class="hljs-number">00</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">09</span> <span class="hljs-number">00</span> <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-number">11</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br><span class="hljs-attribute">0001100</span> <span class="hljs-number">00</span> <span class="hljs-number">12</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">05</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">13</span> <span class="hljs-number">00</span><br><span class="hljs-attribute">0001120</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">00</span> <span class="hljs-number">14</span><br></code></pre></td></tr></table></figure>



<p>根据 JVM 规范，类文件结构如下:</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs llvm">ClassFile &#123;<br>        u<span class="hljs-number">4</span> magic<span class="hljs-comment">;         【u4代表的是字节数，此处是前四个字节 魔数】</span><br>        u<span class="hljs-number">2</span> minor_version<span class="hljs-comment">;	【小版本号】</span><br>        u<span class="hljs-number">2</span> major_version<span class="hljs-comment">;	【主版本号】</span><br>        u<span class="hljs-number">2</span> constant_pool_count<span class="hljs-comment">; 	【常量池相关】</span><br>        cp_info constant_pool[constant_pool_count<span class="hljs-number">-1</span>]<span class="hljs-comment">;	【常量池相关】</span><br>        u<span class="hljs-number">2</span> access_flags<span class="hljs-comment">;	【访问修饰】</span><br>        u<span class="hljs-number">2</span> this_class<span class="hljs-comment">;		【自己的包名类名信息】</span><br>        u<span class="hljs-number">2</span> super_class<span class="hljs-comment">;		【父类信息】</span><br>        u<span class="hljs-number">2</span> interfaces_count<span class="hljs-comment">;【接口信息】</span><br>        u<span class="hljs-number">2</span> interfaces[interfaces_count]<span class="hljs-comment">;  【接口信息】</span><br>        u<span class="hljs-number">2</span> fields_count<span class="hljs-comment">;	【成员变量信息】</span><br>        field_info fields[fields_count]<span class="hljs-comment">; 【成员变量信息】</span><br>        u<span class="hljs-number">2</span> methods_count<span class="hljs-comment">;   【方法信息】</span><br>        method_info methods[methods_count]<span class="hljs-comment">; 【方法信息】</span><br>        u<span class="hljs-number">2</span> attributes_count<span class="hljs-comment">;  【类的附加属性信息】</span><br>        attribute_info <span class="hljs-keyword">attributes</span>[attributes_count]<span class="hljs-comment">; 【类的附加属性信息】</span><br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="1-1-魔数"><a href="#1-1-魔数" class="headerlink" title="1.1 魔数"></a>1.1 魔数</h3><p>0~3 字节【0 1 2 3】，用这四个字节表示它是一个 class 	类型的文件 </p>
<p>不同类型的文件由不同的魔数信息</p>
<p>前四个字节 咖啡卑鄙 标识该文件是一个class类型的文件</p>
<p>0000000 <u><strong>ca fe ba be</strong></u> 00 00 00 34 00 23 0a 00 06 00 15 09</p>
<h3 id="1-2-版本"><a href="#1-2-版本" class="headerlink" title="1.2 版本"></a>1.2 版本</h3><p>第4~7 字节，表示类的版本 00 34（52） 表示是 Java 8 【内部有对应关系】</p>
<p>0000000 ca fe ba be <strong>00 00 00 34</strong> 00 23 0a 00 06 00 15 09</p>
<h3 id="1-3-常量池"><a href="#1-3-常量池" class="headerlink" title="1.3 常量池"></a>1.3 常量池</h3><hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807210200551.png" srcset="/img/loading.gif" lazyload alt="image-20220807210200551"></p>
<hr>
<p>8<del>9 字节两个字节，表示常量池长度，00 23 （35） 表示常量池有 #1</del>#34项，注意 #0 项不计入，也没有值 </p>
<p>0000000 ca fe ba be 00 00 00 34 <strong>00 23</strong> 0a 00 06 00 15 09 </p>
<p>第#1项 0a （十进制：10）表示一个 Method 信息【方法引用信息】，00 06（十进制：6） 和 00 15（十进制：21） 表示它引用了常量池中 #6 和 #21 项来获得 这个方法的【所属类】和【方法名】 </p>
<p>0000000 ca fe ba be 00 00 00 34 00 23 <strong>0a 00 06 00 15</strong> 09</p>
<figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs delphi">找<span class="hljs-string">#6</span> 找<span class="hljs-string">#28</span> java/lang/<span class="hljs-keyword">Object</span><br><br>找<span class="hljs-string">#21</span> 找<span class="hljs-string">#7</span>和<span class="hljs-string">#8</span> &lt;init&gt;()V<br></code></pre></td></tr></table></figure>



<p>第#2项 09 表示一个 Field 信息，00 16（22）和 00 17（23） 表示它引用了常量池中 #22 和 # 23 项 来获得这个成员变量的【所属类】和【成员变量名】 0000000 ca fe ba be 00 00 00 34 00 23 0a 00 06 00 15 <strong>09</strong> </p>
<p>0000020 <strong>00 16 00 17</strong> 08 00 18 0a 00 19 00 1a 07 00 1b 07 </p>
<p>第#3项 08 表示一个字符串常量名称，00 18（24）表示它引用了常量池中 #24 项 </p>
<p>0000020 00 16 00 17 <strong>08 00 18</strong> 0a 00 19 00 1a 07 00 1b 07 </p>
<p>第#4项 0a 表示一个 Method 信息，00 19（25） 和 00 1a（26） 表示它引用了常量池中 #25 和 #26 项来获得这个方法的【所属类】和【方法名】 </p>
<p>0000020 00 16 00 17 08 00 18 <strong>0a 00 19 00 1a</strong> 07 00 1b 07 </p>
<p>第#5项 07 表示一个 Class 信息</p>
<p>00 1b（27） 表示它引用了常量池中 #27 项 0000020 00 16 00 17 08 00 18 0a 00 19 00 1a <strong>07 00 1b</strong> 07 </p>
<p>第#6项 07 表示一个 Class 信息，00 1c（28） 表示它引用了常量池中 #28 项 </p>
<p>0000020 00 16 00 17 08 00 18 0a 00 19 00 1a 07 00 1b <strong>07</strong> </p>
<p>0000040 <strong>00 1c</strong> 01 00 06 3c 69 6e 69 74 3e 01 00 03 28 29 </p>
<p>第#7项 01 表示一个 utf8 串，00 06 表示长度，3c 69 6e 69 74 3e 是【  &lt;init&gt;】 </p>
<p>0000040 00 1c <strong>01 00 06 3c 69 6e 69 74 3e</strong> 01 00 03 28 29</p>
<p>第#8项 01 表示一个 utf8 串，00 03 表示长度，28 29 56 是【()V】其实就是表示无参、无返回值 </p>
<p>0000040 00 1c 01 00 06 3c 69 6e 69 74 3e <strong>01 00 03 28 29</strong> </p>
<p>0000060 <strong>56</strong> 01 00 04 43 6f 64 65 01 00 0f 4c 69 6e 65 4e </p>
<p>第#9项 01 表示一个 utf8 串，00 04 表示长度，43 6f 64 65 是【Code】 </p>
<p>0000060 56 <strong>01 00 04 43 6f 64 65</strong> 01 00 0f 4c 69 6e 65 4e </p>
<p>第#10项 01 表示一个 utf8 串，00 0f（15） 表示长度，4c 69 6e 65 4e 75 6d 62 65 72 54 61 62 6c 65 是【LineNumberTable】 </p>
<p>0000060 56 01 00 04 43 6f 64 65 <strong>01 00 0f 4c 69 6e 65 4e</strong> </p>
<p>0000100 <strong>75 6d 62 65 72 54 61 62 6c 65</strong> 01 00 12 4c 6f 63 </p>
<p>第#11项 01 表示一个 utf8 串，00 12（18） 表示长度，4c 6f 63 61 6c 56 61 72 69 61 62 6c 65 54 61 62 6c 65是【LocalVariableTable】 </p>
<p>0000100 75 6d 62 65 72 54 61 62 6c 65 <strong>01 00 12 4c 6f 63</strong> </p>
<p>0000120 <strong>61 6c 56 61 72 69 61 62 6c 65 54 61 62 6c 65</strong> 01</p>
<p> 第#12项 01 表示一个 utf8 串，00 04 表示长度，74 68 69 73 是【this】 </p>
<p>0000120 61 6c 56 61 72 69 61 62 6c 65 54 61 62 6c 65 <strong>01</strong> </p>
<p>0000140 00 <strong>04 74 68 69 73</strong> 01 00 1d 4c 63 6e 2f 69 74 63 </p>
<p>第#13项 01 表示一个 utf8 串，00 1d（29） 表示长度，是【Lcn&#x2F;itcast&#x2F;jvm&#x2F;t5&#x2F;HelloWorld;】 </p>
<p>0000140 00 04 74 68 69 73 <strong>01 00 1d 4c 63 6e 2f 69 74 63</strong> </p>
<p>0000160 <strong>61 73 74 2f 6a 76 6d 2f 74 35 2f 48 65 6c 6c 6f</strong> </p>
<p>0000200 <strong>57 6f 72 6c 64 3b</strong> 01 00 04 6d 61 69 6e 01 00 16 </p>
<p>第#14项 01 表示一个 utf8 串，00 04 表示长度，74 68 69 73 是【main】 </p>
<p>0000200 57 6f 72 6c 64 3b <strong>01 00 04 6d 61 69 6e</strong> 01 00 16 </p>
<p>第#15项 01 表示一个 utf8 串，00 16（22） 表示长度，是【([Ljava&#x2F;lang&#x2F;String;)V】其实就是参数为 字符串数组，无返回值 </p>
<p>0000200 57 6f 72 6c 64 3b 01 00 04 6d 61 69 6e <strong>01 00 16</strong> </p>
<p>0000220 <strong>28 5b 4c 6a 61 76 61 2f 6c 61 6e 67 2f 53 74 72</strong> </p>
<p>0000240 <strong>69 6e 67 3b 29 56</strong> 01 00 04 61 72 67 73 01 00 13 </p>
<p>第#16项 01 表示一个 utf8 串，00 04 表示长度，是【args】 </p>
<p>0000240 69 6e 67 3b 29 56 <strong>01 00 04 61 72 67 73</strong> 01 00 13 </p>
<p>第#17项 01 表示一个 utf8 串，00 13（19） 表示长度，是【[Ljava&#x2F;lang&#x2F;String;】 </p>
<p>0000240 69 6e 67 3b 29 56 01 00 04 61 72 67 73 <strong>01 00 13</strong> </p>
<p>0000260 <strong>5b 4c 6a 61 76 61 2f 6c 61 6e 67 2f 53 74 72 69</strong> </p>
<p>0000300 <strong>6e 67 3b</strong> 01 00 10 4d 65 74 68 6f 64 50 61 72 61</p>
<p>第#18项 01 表示一个 utf8 串，00 10（16） 表示长度，是【MethodParameters】 </p>
<p>0000300 6e 67 3b <strong>01 00 10 4d 65 74 68 6f 64 50 61 72 61</strong> </p>
<p>0000320 <strong>6d 65 74 65 72 73</strong> 01 00 0a 53 6f 75 72 63 65 46 </p>
<p>第#19项 01 表示一个 utf8 串，00 0a（10） 表示长度，是【SourceFile】 </p>
<p>0000320 6d 65 74 65 72 73 <strong>01 00 0a 53 6f 75 72 63 65 46</strong> </p>
<p>0000340 <strong>69 6c 65</strong> 01 00 0f 48 65 6c 6c 6f 57 6f 72 6c 64 </p>
<p>第#20项 01 表示一个 utf8 串，00 0f（15） 表示长度，是【HelloWorld.java】 </p>
<p>0000340 69 6c 65 <strong>01 00 0f 48 65 6c 6c 6f 57 6f 72 6c 64</strong> </p>
<p>0000360 <strong>2e 6a 61 76 61</strong> 0c 00 07 00 08 07 00 1d 0c 00 1e</p>
<p>第#21项 0c 表示一个 【名+类型】，00 07 00 08 引用了常量池中 #7 #8 两项 </p>
<p>0000360 2e 6a 61 76 61 <strong>0c 00 07 00 08</strong> 07 00 1d 0c 00 1e </p>
<p>第#22项 07 表示一个 Class 信息，00 1d（29） 引用了常量池中 #29 项 </p>
<p>0000360 2e 6a 61 76 61 0c 00 07 00 08 <strong>07 00 1d</strong> 0c 00 1e</p>
<p> 第#23项 0c 表示一个 【名+类型】，00 1e（30） 00 1f （31）引用了常量池中 #30 #31 两项 </p>
<p>0000360 2e 6a 61 76 61 0c 00 07 00 08 07 00 1d <strong>0c 00 1e</strong> </p>
<p>0000400 <strong>00 1f</strong> 01 00 0b 68 65 6c 6c 6f 20 77 6f 72 6c 64</p>
<p>第#24项 01 表示一个 utf8 串，00 0f（12） 表示长度，是【hello world】 </p>
<p>0000400 00 1f <strong>01 00 0b 68 65 6c 6c 6f 20 77 6f 72 6c 64</strong> </p>
<p>第#25项 07 表示一个 Class 信息，00 20（32） 引用了常量池中 #32 项 </p>
<p>0000420 <strong>07 00 20</strong> 0c 00 21 00 22 01 00 1b 63 6e 2f 69 74 </p>
<p>第#26项 0c 表示一个 【名+类型】，00 21（33） 00 22（34）引用了常量池中 #33 #34 两项 </p>
<p>0000420 07 00 20 <strong>0c 00 21 00 22</strong> 01 00 1b 63 6e 2f 69 74 </p>
<p>第#27项 01 表示一个 utf8 串，00 1b（27） 表示长度，是【cn&#x2F;itcast&#x2F;jvm&#x2F;t5&#x2F;HelloWorld】 </p>
<p>0000420 07 00 20 0c 00 21 00 22 <strong>01 00 1b 63 6e 2f 69 74</strong> </p>
<p>0000440 <strong>63 61 73 74 2f 6a 76 6d 2f 74 35 2f 48 65 6c 6c</strong> </p>
<p>0000460 <strong>6f 57 6f 72 6c 64</strong> 01 00 10 6a 61 76 61 2f 6c 61 </p>
<p>第#28项 01 表示一个 utf8 串，00 10（16） 表示长度，是【java&#x2F;lang&#x2F;Object】 </p>
<p>0000460 6f 57 6f 72 6c 64 <strong>01 00 10 6a 61 76 61 2f 6c 61</strong></p>
<p>0000500 <strong>6e 67 2f 4f 62 6a 65 63 74</strong> 01 00 10 6a 61 76 61 </p>
<p>第#29项 01 表示一个 utf8 串，00 10（16） 表示长度，是【java&#x2F;lang&#x2F;System】 </p>
<p>0000500 6e 67 2f 4f 62 6a 65 63 74 <strong>01 00 10 6a 61 76 61</strong> </p>
<p>0000520 <strong>2f 6c 61 6e 67 2f 53 79 73 74 65 6d</strong> 01 00 03 6f </p>
<p>第#30项 01 表示一个 utf8 串，00 03 表示长度，是【out】 </p>
<p>0000520 2f 6c 61 6e 67 2f 53 79 73 74 65 6d <strong>01 00 03 6f</strong> </p>
<p>0000540 <strong>75 74</strong> 01 00 15 4c 6a 61 76 61 2f 69 6f 2f 50 72 </p>
<p>第#31项 01 表示一个 utf8 串，00 15（21） 表示长度，是【Ljava&#x2F;io&#x2F;PrintStream;】 </p>
<p>0000540 75 74 <strong>01 00 15 4c 6a 61 76 61 2f 69 6f 2f 50 72</strong> </p>
<p>0000560 <strong>69 6e 74 53 74 72 65 61 6d 3b</strong> 01 00 13 6a 61 76 </p>
<p>第#32项 01 表示一个 utf8 串，00 13（19） 表示长度，是【java&#x2F;io&#x2F;PrintStream】 </p>
<p>0000560 69 6e 74 53 74 72 65 61 6d 3b <strong>01 00 13 6a 61 76</strong> </p>
<p>0000600 <strong>61 2f 69 6f 2f 50 72 69 6e 74 53 74 72 65 61 6d</strong> </p>
<p>第#33项 01 表示一个 utf8 串，00 07 表示长度，是【println】 </p>
<p>0000620 <strong>01 00 07 70 72 69 6e 74 6c 6e</strong> 01 00 15 28 4c 6a </p>
<p>第#34项 01 表示一个 utf8 串，00 15（21） 表示长度，是【(Ljava&#x2F;lang&#x2F;String;)V】</p>
<p> 0000620 01 00 07 70 72 69 6e 74 6c 6e <strong>01 00 15 28 4c 6a</strong> </p>
<p>0000640 <strong>61 76 61 2f 6c 61 6e 67 2f 53 74 72 69 6e 67 3b</strong> </p>
<p>0000660 <strong>29 56</strong> 00 21 00 05 00 06 00 00 00 00 00 02 00 01</p>
<h3 id="1-4-访问标识与继承信息"><a href="#1-4-访问标识与继承信息" class="headerlink" title="1.4 访问标识与继承信息"></a>1.4 访问标识与继承信息</h3><p>21 表示该 class 是一个类，公共的 </p>
<p>0000660 29 56 <strong>00 21</strong> 00 05 00 06 00 00 00 00 00 02 00 01</p>
<p>05 表示根据常量池中 #5 找到本类全限定名 </p>
<p>0000660 29 56 00 21 <strong>00 05</strong> 00 06 00 00 00 00 00 02 00 01 </p>
<p>06 表示根据常量池中 #6 找到父类全限定名 </p>
<p>0000660 29 56 00 21 00 05 <strong>00 06</strong> 00 00 00 00 00 02 00 01 </p>
<p>表示接口的数量，本类为 0 0000660 29 56 00 21 00 05 00 06 <strong>00 00</strong> 00 00 00 02 00 01</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807220952550.png" srcset="/img/loading.gif" lazyload alt="image-20220807220952550"></p>
<hr>
<h3 id="1-5-Field-信息"><a href="#1-5-Field-信息" class="headerlink" title="1.5 Field 信息"></a>1.5 Field 信息</h3><p>表示成员变量数量，本类为 0 </p>
<p>0000660 29 56 00 21 00 05 00 06 00 00 <strong>00 00</strong> 00 02 00 01</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220807221351274.png" srcset="/img/loading.gif" lazyload alt="image-20220807221351274"></p>
<hr>
<p>L：是引用类型</p>
<p>[：是一维数组</p>
<h3 id="1-6-Method-信息"><a href="#1-6-Method-信息" class="headerlink" title="1.6 Method 信息"></a>1.6 Method 信息</h3><p>表示方法数量，本类为 2 </p>
<p>0000660 29 56 00 21 00 05 00 06 00 00 00 00 <strong>00 02</strong> 00 01</p>
<p>一个<code>方法</code>由 <code>访问修饰符</code>，<code>名称</code>，<code>参数描述</code>，<code>方法属性数量</code>，<code>方法属性</code>组成 </p>
<p>红色代表访问修饰符（本类中是 public）</p>
<p>蓝色代表引用了常量池 #07 项作为方法名称 </p>
<p>绿色代表引用了常量池 #08 项作为方法参数描述</p>
<p>黄色代表方法属性数量，本方法是 1 </p>
<p>红色代表方法属性</p>
<p>00 09 表示引用了常量池 #09 项，发现是【Code】属性 </p>
<p>00 00 00 2f 表示此属性的长度是 47 </p>
<p>00 01 表示【操作数栈】最大深度 </p>
<p>00 01 表示【局部变量表】最大槽（slot）数</p>
<p>00 00 00 05 表示字节码长度，本例是 5 </p>
<p>2a b7 00 01 b1 是字节码指令 </p>
<p>00 00 00 02 表示方法细节属性数量，本例是 2 </p>
<p>00 0a 表示引用了常量池 #10 项，发现是【LineNumberTable】属性</p>
<p>00 00 00 06 表示此属性的总长度，本例是 6 </p>
<p>00 01 表示【LineNumberTable】长度 </p>
<p>00 00 表示【字节码】行号 00 04 表示【java 源码】行号 </p>
<p>00 0b 表示引用了常量池 #11 项，发现是【LocalVariableTable】属性</p>
<p>00 00 00 0c 表示此属性的总长度，本例是 12 00 01 表示【LocalVariableTable】长度 </p>
<p>00 00 表示局部变量生命周期开始，相对于字节码的偏移量 </p>
<p>00 05 表示局部变量覆盖的范围长度 </p>
<p>00 0c 表示局部变量名称，本例引用了常量池 #12 项，是【this】 </p>
<p>00 0d 表示局部变量的类型，本例引用了常量池 #13 项，是 【Lcn&#x2F;itcast&#x2F;jvm&#x2F;t5&#x2F;HelloWorld;】 </p>
<p>00 00 表示局部变量占有的槽位（slot）编号，本例是 0</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220808221303085.png" srcset="/img/loading.gif" lazyload alt="image-20220808221303085"></p>
<hr>
<p>红色代表访问修饰符（本类中是 public static） </p>
<p>蓝色代表引用了常量池 #14 项作为方法名称 </p>
<p>绿色代表引用了常量池 #15 项作为方法参数描述 </p>
<p>黄色代表方法属性数量，本方法是 2 红色代表方法属性（属性1）</p>
<p>00 09 表示引用了常量池 #09 项，发现是【Code】属性</p>
<p>00 00 00 37 表示此属性的长度是 55 00 02 表示【操作数栈】最大深度 </p>
<p>00 01 表示【局部变量表】最大槽（slot）数 </p>
<p>00 00 00 05 表示字节码长度，本例是 9 b2 00 02 12 03 b6 00 04 b1 是字节码指令 </p>
<p>00 00 00 02 表示方法细节属性数量，本例是 2 </p>
<p>00 0a 表示引用了常量池 #10 项，发现是【LineNumberTable】属性</p>
<p>00 00 00 0c 表示此属性的总长度，本例是 12 </p>
<p>00 01 表示【LocalVariableTable】长度 </p>
<p>00 00 表示局部变量生命周期开始，相对于字节码的偏移量 </p>
<p>00 09 表示局部变量覆盖的范围长度</p>
<p>00 10 表示局部变量名称，本例引用了常量池 #16 项，是【args】 </p>
<p>00 11 表示局部变量的类型，本例引用了常量池 #17 项，是【[Ljava&#x2F;lang&#x2F;String;】 </p>
<p>00 00 表示局部变量占有的槽位（slot）编号，本例是 0</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220808222238237.png" srcset="/img/loading.gif" lazyload alt="image-20220808222238237"></p>
<hr>
<p>红色代表方法属性（属性2） </p>
<p>00 12 表示引用了常量池 #18 项，发现是【MethodParameters】属性 </p>
<p>00 00 00 05 表示此属性的总长度，本例是 5 01 参数数量 </p>
<p>00 10 表示引用了常量池 #16 项，是【args】 00 00 访问修饰符</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220808222321341.png" srcset="/img/loading.gif" lazyload alt="image-20220808222321341"></p>
<hr>
<h3 id="1-7-附加属性"><a href="#1-7-附加属性" class="headerlink" title="1.7 附加属性"></a>1.7 附加属性</h3><p>00 01 表示附加属性数量 </p>
<p>00 13 表示引用了常量池 #19 项，即【SourceFile】</p>
<p> 00 00 00 02 表示此属性的长度 </p>
<p>00 14 表示引用了常量池 #20 项，即【HelloWorld.java】 </p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220808222406790.png" srcset="/img/loading.gif" lazyload alt="image-20220808222406790"></p>
<hr>
<p>类的格式</p>
<p>参考文献 ： <a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html">https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html</a></p>
<h2 id="2-字节码指令"><a href="#2-字节码指令" class="headerlink" title="2. 字节码指令"></a>2. 字节码指令</h2><h3 id="2-1-入门"><a href="#2-1-入门" class="headerlink" title="2.1 入门"></a>2.1 入门</h3><p> 接着上一节，研究一下两组字节码指令，一个是 </p>
<p><code>public cn.itcast.jvm.t5.HelloWorld();</code> 构造方法的字节码指令</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">2a</span> b7 <span class="hljs-number">00</span> <span class="hljs-number">01</span> b1<br></code></pre></td></tr></table></figure>

<p>1、2a &#x3D;&gt; aload_0 加载 slot 0 的局部变量，即 this，做为下面的 invokespecial 构造方法调用的参数 </p>
<p>2、b7 &#x3D;&gt; invokespecial 预备调用构造方法，哪个方法呢？ </p>
<p>3、00 01 引用常量池中 #1 项，即【 Method java&#x2F;lang&#x2F;Object.””:()V 】 </p>
<p>4、 b1 表示返回</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">this</span> .  <span class="hljs-keyword">init</span>()v  <span class="hljs-keyword">return</span><br></code></pre></td></tr></table></figure>





<p>另一个是 <code>public static void main(java.lang.String[]); </code>主方法的字节码指令</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">b2</span> <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">12</span> <span class="hljs-number">03</span> b6 <span class="hljs-number">00</span> <span class="hljs-number">04</span> b1<br></code></pre></td></tr></table></figure>

<p>1、b2 &#x3D;&gt; getstatic 用来加载静态变量，哪个静态变量呢？ </p>
<p>2、00 02 引用常量池中 #2 项，即【Field java&#x2F;lang&#x2F;System.out:Ljava&#x2F;io&#x2F;PrintStream;】 </p>
<p>3、12 &#x3D;&gt; ldc 加载参数，哪个参数呢？ </p>
<p>4、03 引用常量池中 #3 项，即 【String hello world】 </p>
<p>5、b6 &#x3D;&gt; invokevirtual 预备调用成员方法，哪个方法呢？ </p>
<p>6、00 04 引用常量池中 #4 项，即【Method java&#x2F;io&#x2F;PrintStream.println:(Ljava&#x2F;lang&#x2F;String;)V】 </p>
<p>7、b1 表示返回</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">System.<span class="hljs-keyword">out</span>   <span class="hljs-string">&quot;hello world&quot;</span>  .  println(String)v  <span class="hljs-keyword">return</span><br></code></pre></td></tr></table></figure>



<p>请参考:</p>
<p> <a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-6.html#jvms-6.5">https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-6.html#jvms-6.5</a></p>
<h3 id="2-2-javap-工具"><a href="#2-2-javap-工具" class="headerlink" title="2.2 javap 工具"></a>2.2 javap 工具</h3><p>自己分析类文件结构太麻烦了，Oracle 提供了 javap 工具来反编译 class 文件</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs lasso">javap <span class="hljs-params">-v</span> HelloWorld.class<br>Classfile /root/HelloWorld.class<br>Last modified Jul <span class="hljs-number">7</span>, <span class="hljs-number">2019</span>; size <span class="hljs-number">597</span> <span class="hljs-built_in">bytes</span>	   【大小】<br>MD5 checksum <span class="hljs-number">361</span>dca1c3f4ae38644a9cd5060ac6dbc 【MD5的校验签名】<br>Compiled from <span class="hljs-string">&quot;HelloWorld.java&quot;</span><br><span class="hljs-keyword">public</span> class <span class="hljs-literal">cn</span>.itcast.jvm.t5.HelloWorld<br>minor version: <span class="hljs-number">0</span><br>major version: <span class="hljs-number">52</span>	【对应JDK8】<br>flags: ACC_PUBLIC, ACC_SUPER	【<span class="hljs-keyword">public</span>修饰权限】<br>Constant pool:<br>#1 = Methodref #6.#21 <span class="hljs-comment">// java/lang/Object.&quot;&lt;init&gt;&quot;:()V 【 方法引用  Object的无参构造】</span><br>#2 = Fieldref #22.#23 <span class="hljs-comment">//</span><br>java/lang/System.out:Ljava/io/PrintStream;<br>#3 = <span class="hljs-built_in">String</span> #24 <span class="hljs-comment">// hello world</span><br>#4 = Methodref #25.#26 <span class="hljs-comment">// java/io/PrintStream.println:</span><br>(Ljava/lang/<span class="hljs-built_in">String</span>;)V<br>#5 = Class #27 <span class="hljs-comment">// cn/itcast/jvm/t5/HelloWorld</span><br>#6 = Class #28 <span class="hljs-comment">// java/lang/Object</span><br>#7 = Utf8 &lt;init&gt;<br>#8 = Utf8 ()V<br>#9 = Utf8 Code<br>#10 = Utf8 LineNumberTable<br>#11 = Utf8 LocalVariableTable<br>#12 = Utf8 this<br>#13 = Utf8 Lcn/itcast/jvm/t5/HelloWorld;<br>#14 = Utf8 main<br>#15 = Utf8 (<span class="hljs-meta">[</span>Ljava/lang/<span class="hljs-built_in">String</span>;)V<br>#16 = Utf8 args<br>#17 = Utf8 <span class="hljs-meta">[</span>Ljava/lang/<span class="hljs-built_in">String</span>;<br>#18 = Utf8 MethodParameters<br>#19 = Utf8 SourceFile<br>#20 = Utf8 HelloWorld.java<br>#21 = NameAndType #7:#8 <span class="hljs-comment">// &quot;&lt;init&gt;&quot;:()V</span><br>#22 = Class #29 <span class="hljs-comment">// java/lang/System</span><br>#23 = NameAndType #30:#31 <span class="hljs-comment">// out:Ljava/io/PrintStream;</span><br>#24 = Utf8 hello world<br>#25 = Class #32 <span class="hljs-comment">// java/io/PrintStream</span><br>#26 = NameAndType #33:#34 <span class="hljs-comment">// println:(Ljava/lang/String;)V</span><br>#27 = Utf8 <span class="hljs-literal">cn</span>/itcast/jvm/t5/HelloWorld<br>#28 = Utf8 java/lang/Object<br>#29 = Utf8 java/lang/System<br>#30 = Utf8 out<br>#31 = Utf8 Ljava/io/PrintStream;<br>#32 = Utf8 java/io/PrintStream<br>#33 = Utf8 println<br>#34 = Utf8 (Ljava/lang/<span class="hljs-built_in">String</span>;)V<br>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-literal">cn</span>.itcast.jvm.t5.HelloWorld();<br>        descriptor: ()V<br>        flags: ACC_PUBLIC<br>        Code:<br>        <span class="hljs-built_in">stack</span>=<span class="hljs-number">1</span>, locals=<span class="hljs-number">1</span>, args_size=<span class="hljs-number">1</span><br>        <span class="hljs-number">0</span>: aload_0<br>        <span class="hljs-number">1</span>: invokespecial #1 <span class="hljs-comment">// Method java/lang/Object.&quot;</span><br>        &lt;init&gt;<span class="hljs-string">&quot;:()V</span><br><span class="hljs-string">        4: return</span><br><span class="hljs-string">        LineNumberTable:</span><br><span class="hljs-string">        line 4: 0</span><br><span class="hljs-string">        LocalVariableTable:</span><br><span class="hljs-string">        Start Length Slot Name Signature</span><br><span class="hljs-string">        0 5 0 this Lcn/itcast/jvm/t5/HelloWorld;</span><br><span class="hljs-string">        public static void main(java.lang.String[]);</span><br><span class="hljs-string">        descriptor: ([Ljava/lang/String;)V</span><br><span class="hljs-string">        flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="hljs-string">        Code:</span><br><span class="hljs-string">        stack=2, locals=1, args_size=1</span><br><span class="hljs-string">        0: getstatic #2 // Field</span><br><span class="hljs-string">        java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="hljs-string">        3: ldc #3 // String hello world</span><br><span class="hljs-string">        5: invokevirtual #4 // Method</span><br><span class="hljs-string">        java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="hljs-string">        8: return</span><br><span class="hljs-string">        LineNumberTable:</span><br><span class="hljs-string">        line 6: 0</span><br><span class="hljs-string">        line 7: 8</span><br><span class="hljs-string">        LocalVariableTable:</span><br><span class="hljs-string">        Start Length Slot Name Signature</span><br><span class="hljs-string">        0 9 0 args [Ljava/lang/String;</span><br><span class="hljs-string">        MethodParameters:</span><br><span class="hljs-string">        Name Flags</span><br><span class="hljs-string">        args</span><br><span class="hljs-string">&#125;</span><br></code></pre></td></tr></table></figure>



<h3 id="2-3-图解方法执行流程"><a href="#2-3-图解方法执行流程" class="headerlink" title="2.3 图解方法执行流程"></a>2.3 图解方法执行流程</h3><p>1）原始 java 代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t3.bytecode;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 演示 字节码指令 和 操作数栈、常量池的关系</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3_1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> Short.MAX_VALUE + <span class="hljs-number">1</span>;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> a + b;<br>    System.out.println(c);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>2）编译后的字节码文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">javap</span> <span class="hljs-string">-v</span> <span class="hljs-string">Demo3_1.class</span><br><span class="hljs-string">Classfile</span> <span class="hljs-string">/root/Demo3_1.class</span><br><span class="hljs-string">Last</span> <span class="hljs-string">modified</span> <span class="hljs-string">Jul</span> <span class="hljs-number">7</span><span class="hljs-string">,</span> <span class="hljs-number">2019</span><span class="hljs-string">;</span> <span class="hljs-string">size</span> <span class="hljs-number">665</span> <span class="hljs-string">bytes</span><br><span class="hljs-string">MD5</span> <span class="hljs-string">checksum</span> <span class="hljs-string">a2c29a22421e218d4924d31e6990cfc5</span><br><span class="hljs-string">Compiled</span> <span class="hljs-string">from</span> <span class="hljs-string">&quot;Demo3_1.java&quot;</span><br><span class="hljs-string">public</span> <span class="hljs-string">class</span> <span class="hljs-string">cn.itcast.jvm.t3.bytecode.Demo3_1</span><br><span class="hljs-attr">minor version:</span> <span class="hljs-number">0</span><br><span class="hljs-attr">major version:</span> <span class="hljs-number">52</span><br><span class="hljs-attr">flags:</span> <span class="hljs-string">ACC_PUBLIC,</span> <span class="hljs-string">ACC_SUPER</span><br><span class="hljs-attr">Constant pool:</span><br><span class="hljs-comment">#1 = Methodref #7.#26 // java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="hljs-comment">#2 = Class #27 // java/lang/Short</span><br><span class="hljs-comment">#3 = Integer 32768</span><br><span class="hljs-comment">#4 = Fieldref #28.#29 //</span><br><span class="hljs-string">java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="hljs-comment">#5 = Methodref #30.#31 // java/io/PrintStream.println:(I)V</span><br><span class="hljs-comment">#6 = Class #32 // cn/itcast/jvm/t3/bytecode/Demo3_1</span><br><span class="hljs-comment">#7 = Class #33 // java/lang/Object</span><br><span class="hljs-comment">#8 = Utf8 &lt;init&gt;</span><br><span class="hljs-comment">#9 = Utf8 ()V</span><br><span class="hljs-comment">#10 = Utf8 Code</span><br><span class="hljs-comment">#11 = Utf8 LineNumberTable</span><br><span class="hljs-comment">#12 = Utf8 LocalVariableTable</span><br><span class="hljs-comment">#13 = Utf8 this#20 = Utf8 I</span><br><span class="hljs-comment">#21 = Utf8 b</span><br><span class="hljs-comment">#22 = Utf8 c</span><br><span class="hljs-comment">#23 = Utf8 MethodParameters</span><br><span class="hljs-comment">#24 = Utf8 SourceFile</span><br><span class="hljs-comment">#25 = Utf8 Demo3_1.java</span><br><span class="hljs-comment">#26 = NameAndType #8:#9 // &quot;&lt;init&gt;&quot;:()V</span><br><span class="hljs-comment">#27 = Utf8 java/lang/Short</span><br><span class="hljs-comment">#28 = Class #34 // java/lang/System</span><br><span class="hljs-comment">#29 = NameAndType #35:#36 // out:Ljava/io/PrintStream;</span><br><span class="hljs-comment">#30 = Class #37 // java/io/PrintStream</span><br><span class="hljs-comment">#31 = NameAndType #38:#39 // println:(I)V</span><br><span class="hljs-comment">#32 = Utf8 cn/itcast/jvm/t3/bytecode/Demo3_1</span><br><span class="hljs-comment">#33 = Utf8 java/lang/Object</span><br><span class="hljs-comment">#34 = Utf8 java/lang/System</span><br><span class="hljs-comment">#35 = Utf8 out</span><br><span class="hljs-comment">#36 = Utf8 Ljava/io/PrintStream;</span><br><span class="hljs-comment">#37 = Utf8 java/io/PrintStream</span><br><span class="hljs-comment">#38 = Utf8 println</span><br><span class="hljs-comment">#39 = Utf8 (I)V</span><br>&#123;<br><span class="hljs-string">public</span> <span class="hljs-string">cn.itcast.jvm.t3.bytecode.Demo3_1();</span><br><span class="hljs-attr">descriptor:</span> <span class="hljs-string">()V</span><br><span class="hljs-attr">flags:</span> <span class="hljs-string">ACC_PUBLIC</span><br><span class="hljs-attr">Code:</span><br><span class="hljs-string">stack=1</span>, <span class="hljs-string">locals=1</span>, <span class="hljs-string">args_size=1</span><br><span class="hljs-attr">0:</span> <span class="hljs-string">aload_0</span><br><span class="hljs-attr">1:</span> <span class="hljs-string">invokespecial</span> <span class="hljs-comment">#1 // Method java/lang/Object.&quot;</span><br><span class="hljs-string">&lt;init&gt;&quot;:()V</span><br><span class="hljs-attr">4:</span> <span class="hljs-string">return</span><br><span class="hljs-attr">LineNumberTable:</span><br><span class="hljs-attr">line 6:</span> <span class="hljs-number">0</span><br><span class="hljs-attr">LocalVariableTable:</span><br><span class="hljs-string">Start</span> <span class="hljs-string">Length</span> <span class="hljs-string">Slot</span> <span class="hljs-string">Name</span> <span class="hljs-string">Signature</span><br><span class="hljs-number">0</span> <span class="hljs-number">5</span> <span class="hljs-number">0</span> <span class="hljs-string">this</span> <span class="hljs-string">Lcn/itcast/jvm/t3/bytecode/Demo3_1;</span><br><span class="hljs-string">public</span> <span class="hljs-string">static</span> <span class="hljs-string">void</span> <span class="hljs-string">main(java.lang.String</span>[]<span class="hljs-string">);</span><br><span class="hljs-attr">descriptor:</span> <span class="hljs-string">(</span>[<span class="hljs-string">Ljava/lang/String;)V</span><br><span class="hljs-attr">flags:</span> <span class="hljs-string">ACC_PUBLIC</span>, <span class="hljs-string">ACC_STATIC</span><br><span class="hljs-attr">Code:</span><br><span class="hljs-string">stack=2</span>, <span class="hljs-string">locals=4</span>, <span class="hljs-string">args_size=1</span><br><span class="hljs-attr">0:</span> <span class="hljs-string">bipush</span> <span class="hljs-number">10</span><br><span class="hljs-attr">2:</span> <span class="hljs-string">istore_1</span><br><span class="hljs-attr">3:</span> <span class="hljs-string">ldc</span> <span class="hljs-comment">#3 // int 32768</span><br><span class="hljs-attr">5:</span> <span class="hljs-string">istore_2</span><br><span class="hljs-attr">6:</span> <span class="hljs-string">iload_1</span><br><span class="hljs-attr">7:</span> <span class="hljs-string">iload_2</span><br><span class="hljs-attr">8:</span> <span class="hljs-string">iadd</span><br><span class="hljs-attr">9:</span> <span class="hljs-string">istore_3</span><br><span class="hljs-attr">10:</span> <span class="hljs-string">getstatic</span> <span class="hljs-comment">#4 // Field</span><br><span class="hljs-string">java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="hljs-attr">13:</span> <span class="hljs-string">iload_3</span><br><span class="hljs-attr">14:</span> <span class="hljs-string">invokevirtual</span> <span class="hljs-comment">#5 // Method</span><br><span class="hljs-string">java/io/PrintStream.println:(I)V</span><br><span class="hljs-attr">17:</span> <span class="hljs-string">return</span><br><span class="hljs-attr">LineNumberTable:</span><br><span class="hljs-attr">line 8:</span> <span class="hljs-number">0</span><br><span class="hljs-attr">line 9:</span> <span class="hljs-number">3</span><br><span class="hljs-attr">line 10:</span> <span class="hljs-number">6</span><br><span class="hljs-attr">line 11:</span> <span class="hljs-number">10</span><br><span class="hljs-attr">line 12:</span> <span class="hljs-number">17</span><br><span class="hljs-attr">LocalVariableTable:</span><br><span class="hljs-string">Start</span> <span class="hljs-string">Length</span> <span class="hljs-string">Slot</span> <span class="hljs-string">Name</span> <span class="hljs-string">Signature</span><br><span class="hljs-number">0</span> <span class="hljs-number">18</span> <span class="hljs-number">0</span> <span class="hljs-string">args</span> [<span class="hljs-string">Ljava/lang/String;</span><br><span class="hljs-number">3</span> <span class="hljs-number">15</span> <span class="hljs-number">1</span> <span class="hljs-string">a</span> <span class="hljs-string">I</span><br><span class="hljs-number">6</span> <span class="hljs-number">12</span> <span class="hljs-number">2</span> <span class="hljs-string">b</span> <span class="hljs-string">I</span><br><span class="hljs-number">10</span> <span class="hljs-number">8</span> <span class="hljs-number">3</span> <span class="hljs-string">c</span> <span class="hljs-string">I</span><br><span class="hljs-attr">MethodParameters:</span><br><span class="hljs-string">Name</span> <span class="hljs-string">Flags</span><br><span class="hljs-string">args</span><br>&#125;<br><br><span class="hljs-comment">#14 = Utf8 Lcn/itcast/jvm/t3/bytecode/Demo3_1;</span><br><span class="hljs-comment">#15 = Utf8 main</span><br><span class="hljs-comment">#16 = Utf8 ([Ljava/lang/String;)V</span><br><span class="hljs-comment">#17 = Utf8 args</span><br><span class="hljs-comment">#18 = Utf8 [Ljava/lang/String;</span><br><span class="hljs-comment">#19 = Utf8 a</span><br><span class="hljs-comment">#20 = Utf8 I</span><br><span class="hljs-comment">#21 = Utf8 b</span><br><span class="hljs-comment">#22 = Utf8 c</span><br><span class="hljs-comment">#23 = Utf8 MethodParameters</span><br><span class="hljs-comment">#24 = Utf8 SourceFile</span><br><span class="hljs-comment">#25 = Utf8 Demo3_1.java</span><br><span class="hljs-comment">#26 = NameAndType #8:#9 // &quot;&lt;init&gt;&quot;:()V</span><br><span class="hljs-comment">#27 = Utf8 java/lang/Short</span><br><span class="hljs-comment">#28 = Class #34 // java/lang/System</span><br><span class="hljs-comment">#29 = NameAndType #35:#36 // out:Ljava/io/PrintStream;</span><br><span class="hljs-comment">#30 = Class #37 // java/io/PrintStream</span><br><span class="hljs-comment">#31 = NameAndType #38:#39 // println:(I)V</span><br><span class="hljs-comment">#32 = Utf8 cn/itcast/jvm/t3/bytecode/Demo3_1</span><br><span class="hljs-comment">#33 = Utf8 java/lang/Object</span><br><span class="hljs-comment">#34 = Utf8 java/lang/System</span><br><span class="hljs-comment">#35 = Utf8 out</span><br><span class="hljs-comment">#36 = Utf8 Ljava/io/PrintStream;</span><br><span class="hljs-comment">#37 = Utf8 java/io/PrintStream</span><br><span class="hljs-comment">#38 = Utf8 println</span><br><span class="hljs-comment">#39 = Utf8 (I)V</span><br>&#123;<br><span class="hljs-string">public</span> <span class="hljs-string">cn.itcast.jvm.t3.bytecode.Demo3_1();</span><br><span class="hljs-attr">descriptor:</span> <span class="hljs-string">()V</span><br><span class="hljs-attr">flags:</span> <span class="hljs-string">ACC_PUBLIC</span><br><span class="hljs-attr">Code:</span><br><span class="hljs-string">stack=1</span>, <span class="hljs-string">locals=1</span>, <span class="hljs-string">args_size=1</span><br><span class="hljs-attr">0:</span> <span class="hljs-string">aload_0</span><br><span class="hljs-attr">1:</span> <span class="hljs-string">invokespecial</span> <span class="hljs-comment">#1 // Method java/lang/Object.&quot;</span><br><span class="hljs-string">&lt;init&gt;&quot;:()V</span><br><span class="hljs-attr">4:</span> <span class="hljs-string">return</span><br><span class="hljs-attr">LineNumberTable:</span><br><span class="hljs-attr">line 6:</span> <span class="hljs-number">0</span><br><span class="hljs-attr">LocalVariableTable:</span><br><span class="hljs-string">Start</span> <span class="hljs-string">Length</span> <span class="hljs-string">Slot</span> <span class="hljs-string">Name</span> <span class="hljs-string">Signature</span><br><span class="hljs-number">0</span> <span class="hljs-number">5</span> <span class="hljs-number">0</span> <span class="hljs-string">this</span> <span class="hljs-string">Lcn/itcast/jvm/t3/bytecode/Demo3_1;</span><br><span class="hljs-string">public</span> <span class="hljs-string">static</span> <span class="hljs-string">void</span> <span class="hljs-string">main(java.lang.String</span>[]<span class="hljs-string">);</span><br><span class="hljs-attr">descriptor:</span> <span class="hljs-string">(</span>[<span class="hljs-string">Ljava/lang/String;)V</span><br><span class="hljs-attr">flags:</span> <span class="hljs-string">ACC_PUBLIC</span>, <span class="hljs-string">ACC_STATIC</span><br><span class="hljs-attr">Code:</span><br><span class="hljs-string">stack=2</span>, <span class="hljs-string">locals=4</span>, <span class="hljs-string">args_size=1</span><br><span class="hljs-attr">0:</span> <span class="hljs-string">bipush</span> <span class="hljs-number">10</span><br><span class="hljs-attr">2:</span> <span class="hljs-string">istore_1</span><br><span class="hljs-attr">3:</span> <span class="hljs-string">ldc</span> <span class="hljs-comment">#3 // int 32768</span><br><span class="hljs-attr">5:</span> <span class="hljs-string">istore_2</span><br><span class="hljs-attr">6:</span> <span class="hljs-string">iload_1</span><br><span class="hljs-attr">7:</span> <span class="hljs-string">iload_2</span><br><span class="hljs-attr">8:</span> <span class="hljs-string">iadd</span><br><span class="hljs-attr">9:</span> <span class="hljs-string">istore_3</span><br><span class="hljs-attr">10:</span> <span class="hljs-string">getstatic</span> <span class="hljs-comment">#4 // Field</span><br><span class="hljs-string">java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="hljs-attr">13:</span> <span class="hljs-string">iload_3</span><br><span class="hljs-attr">14:</span> <span class="hljs-string">invokevirtual</span> <span class="hljs-comment">#5 // Method</span><br><span class="hljs-string">java/io/PrintStream.println:(I)V</span><br><span class="hljs-attr">17:</span> <span class="hljs-string">return</span><br><span class="hljs-attr">LineNumberTable:</span><br><span class="hljs-attr">line 8:</span> <span class="hljs-number">0</span><br><span class="hljs-attr">line 9:</span> <span class="hljs-number">3</span><br><span class="hljs-attr">line 10:</span> <span class="hljs-number">6</span><br><span class="hljs-attr">line 11:</span> <span class="hljs-number">10</span><br><span class="hljs-attr">line 12:</span> <span class="hljs-number">17</span><br><span class="hljs-attr">LocalVariableTable:</span><br><span class="hljs-string">Start</span> <span class="hljs-string">Length</span> <span class="hljs-string">Slot</span> <span class="hljs-string">Name</span> <span class="hljs-string">Signature</span><br><span class="hljs-number">0</span> <span class="hljs-number">18</span> <span class="hljs-number">0</span> <span class="hljs-string">args</span> [<span class="hljs-string">Ljava/lang/String;</span><br><span class="hljs-number">3</span> <span class="hljs-number">15</span> <span class="hljs-number">1</span> <span class="hljs-string">a</span> <span class="hljs-string">I</span><br><span class="hljs-number">6</span> <span class="hljs-number">12</span> <span class="hljs-number">2</span> <span class="hljs-string">b</span> <span class="hljs-string">I</span><br><span class="hljs-number">10</span> <span class="hljs-number">8</span> <span class="hljs-number">3</span> <span class="hljs-string">c</span> <span class="hljs-string">I</span><br><span class="hljs-attr">MethodParameters:</span><br><span class="hljs-string">Name</span> <span class="hljs-string">Flags</span><br><span class="hljs-string">args</span><br>&#125;<br><br></code></pre></td></tr></table></figure>





<p>3）常量池载入运行时常量池</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220808225817493.png" srcset="/img/loading.gif" lazyload alt="image-20220808225817493"></p>
<hr>
<p>4）方法字节码载入方法区</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220808225845252.png" srcset="/img/loading.gif" lazyload alt="image-20220808225845252"></p>
<hr>
<p>5）main 线程开始运行，分配栈帧内存</p>
<p>（stack&#x3D;2，locals&#x3D;4）</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220808230231526.png" srcset="/img/loading.gif" lazyload alt="image-20220808230231526"></p>
<hr>
<p>操作数栈的宽度是四个字节</p>
<p>6）执行引擎开始执行字节码</p>
<p>bipush 10 </p>
<p>将一个 byte 压入操作数栈（其长度会补齐 4 个字节），类似的指令还有 </p>
<p>sipush 将一个 short 压入操作数栈（其长度会补齐 4 个字节） </p>
<p>ldc 将一个 int 压入操作数栈 </p>
<p>ldc2_w 将一个 long 压入操作数栈（分两次压入，因为 long 是 8 个字节） </p>
<p>这里小的数字都是和字节码指令存在一起，超过 short 范围的数字存入了常量池</p>
<p>istore_1</p>
<p>将操作数栈顶数据弹出，存入局部变量表的 slot 1</p>
<hr>
<p><img src="http://fgcy-pic.zhamao.ml/image-20220808231259983.png" srcset="/img/loading.gif" lazyload alt="image-20220808231259983"></p>
<hr>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220808231322044.png" srcset="/img/loading.gif" lazyload alt="image-20220808231322044"></p>
<hr>
<p>ldc #3</p>
<p>从常量池加载 #3 数据到操作数栈 </p>
<p>注意 Short.MAX_VALUE 是 32767，所以 32768 &#x3D; Short.MAX_VALUE + 1 实际是在编译期间计算 好的【算是一种编译器的优化】</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220808231612428.png" srcset="/img/loading.gif" lazyload alt="image-20220808231612428"></p>
<hr>
<p>istore_2</p>
<hr>
<p><img src="http://fgcy-pic.zhamao.ml/image-20220808231816628.png" srcset="/img/loading.gif" lazyload alt="image-20220808231816628"></p>
<hr>
<hr>
<p><img src="http://fgcy-pic.zhamao.ml/image-20220808231845387.png" srcset="/img/loading.gif" lazyload alt="image-20220808231845387"></p>
<hr>
<p>iload_1</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220808232202160.png" srcset="/img/loading.gif" lazyload alt="image-20220808232202160"></p>
<hr>
<p>iload_2</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220808232233002.png" srcset="/img/loading.gif" lazyload alt="image-20220808232233002"></p>
<hr>
<p>iadd</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220808232304007.png" srcset="/img/loading.gif" lazyload alt="image-20220808232304007"></p>
<hr>
<hr>
<p><img src="http://fgcy-pic.zhamao.ml/image-20220808232323679.png" srcset="/img/loading.gif" lazyload alt="image-20220808232323679"></p>
<hr>
<p>istore_3</p>
<hr>
<p><img src="http://fgcy-pic.zhamao.ml/image-20220808232359932.png" srcset="/img/loading.gif" lazyload alt="image-20220808232359932"></p>
<hr>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220808232419598.png" srcset="/img/loading.gif" lazyload alt="image-20220808232419598"></p>
<hr>
<p>getstatic #4</p>
<hr>
<p><img src="http://fgcy-pic.zhamao.ml/image-20220809194216749.png" srcset="/img/loading.gif" lazyload alt="image-20220809194216749"></p>
<hr>
<hr>
<p><img src="http://fgcy-pic.zhamao.ml/image-20220809194232084.png" srcset="/img/loading.gif" lazyload alt="image-20220809194232084"></p>
<hr>
<p>iload_3</p>
<hr>
<p><img src="http://fgcy-pic.zhamao.ml/image-20220809194258685.png" srcset="/img/loading.gif" lazyload alt="image-20220809194258685"></p>
<hr>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220809194312978.png" srcset="/img/loading.gif" lazyload alt="image-20220809194312978"></p>
<hr>
<p>invokevirtual #5 </p>
<p>找到常量池 #5 项 定位到方法区 java&#x2F;io&#x2F;PrintStream.println:(I)V 方法 </p>
<p>生成新的栈帧（分配 locals、stack等） </p>
<p>传递参数，执行新栈帧中的字节码</p>
<hr>
<p><img src="http://fgcy-pic.zhamao.ml/image-20220809194453876.png" srcset="/img/loading.gif" lazyload alt="image-20220809194453876"></p>
<hr>
<p>执行完毕，弹出栈帧 </p>
<p>清除 main 操作数栈内容</p>
<hr>
<p><img src="http://fgcy-pic.zhamao.ml/image-20220809194520533.png" srcset="/img/loading.gif" lazyload alt="image-20220809194520533"></p>
<hr>
<p>return </p>
<p>完成 main 方法调用，弹出 main 栈帧 </p>
<p>程序结束</p>
<h3 id="2-4-练习-分析-i"><a href="#2-4-练习-分析-i" class="headerlink" title="2.4 练习 - 分析 i++"></a>2.4 练习 - 分析 i++</h3><p>目的：从字节码角度分析 a++ 相关题目 </p>
<p>源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t3.bytecode;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 从字节码角度分析 a++ 相关题目</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3_2</span> &#123;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> a++ + ++a + a--;<br>    System.out.println(a);<br>    System.out.println(b);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>字节码：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">public</span> <span class="hljs-string">static</span> <span class="hljs-string">void</span> <span class="hljs-string">main(java.lang.String[]);</span><br><span class="hljs-attr">descriptor:</span> <span class="hljs-string">([Ljava/lang/String;)V</span><br><span class="hljs-attr">flags:</span> <span class="hljs-string">(0x0009)</span> <span class="hljs-string">ACC_PUBLIC,</span> <span class="hljs-string">ACC_STATIC</span><br> <span class="hljs-attr">Code:</span><br>  <span class="hljs-string">stack=2,</span> <span class="hljs-string">locals=3,</span> <span class="hljs-string">args_size=1</span><br>    <span class="hljs-attr">0:</span> <span class="hljs-string">bipush</span> <span class="hljs-number">10</span><br>    <span class="hljs-attr">2:</span> <span class="hljs-string">istore_1</span><br>    <span class="hljs-attr">3:</span> <span class="hljs-string">iload_1</span><br>    <span class="hljs-attr">4:</span> <span class="hljs-string">iinc</span> <span class="hljs-number">1</span><span class="hljs-string">,</span> <span class="hljs-number">1</span><br>    <span class="hljs-attr">7:</span> <span class="hljs-string">iinc</span> <span class="hljs-number">1</span><span class="hljs-string">,</span> <span class="hljs-number">1</span><br>    <span class="hljs-attr">10:</span> <span class="hljs-string">iload_1</span><br>    <span class="hljs-attr">11:</span> <span class="hljs-string">iadd</span><br>    <span class="hljs-attr">12:</span> <span class="hljs-string">iload_1</span><br>    <span class="hljs-attr">13:</span> <span class="hljs-string">iinc</span> <span class="hljs-number">1</span><span class="hljs-string">,</span> <span class="hljs-number">-1</span><br>    <span class="hljs-attr">16:</span> <span class="hljs-string">iadd</span><br>    <span class="hljs-attr">17:</span> <span class="hljs-string">istore_2</span><br>    <span class="hljs-attr">18:</span> <span class="hljs-string">getstatic</span> <span class="hljs-comment">#2 // Field</span><br>    <span class="hljs-string">java/lang/System.out:Ljava/io/PrintStream;</span><br>    <span class="hljs-attr">21:</span> <span class="hljs-string">iload_1</span><br>    <span class="hljs-attr">22:</span> <span class="hljs-string">invokevirtual</span> <span class="hljs-comment">#3 // Method</span><br>    <span class="hljs-string">java/io/PrintStream.println:(I)V</span><br>    <span class="hljs-attr">25:</span> <span class="hljs-string">getstatic</span> <span class="hljs-comment">#2 // Field</span><br>    <span class="hljs-string">java/lang/System.out:Ljava/io/PrintStream;</span><br>    <span class="hljs-attr">28:</span> <span class="hljs-string">iload_2</span><br>    <span class="hljs-attr">29:</span> <span class="hljs-string">invokevirtual</span> <span class="hljs-comment">#3 // Method</span><br>    <span class="hljs-string">java/io/PrintStream.println:(I)V</span><br>    <span class="hljs-attr">32:</span> <span class="hljs-string">return</span><br>    <br><span class="hljs-attr">LineNumberTable:</span><br>    <span class="hljs-attr">line 8:</span> <span class="hljs-number">0</span><br>    <span class="hljs-attr">line 9:</span> <span class="hljs-number">3</span><br>    <span class="hljs-attr">line 10:</span> <span class="hljs-number">18</span><br>    <span class="hljs-attr">line 11:</span> <span class="hljs-number">25</span><br>    <span class="hljs-attr">line 12:</span> <span class="hljs-number">32</span><br>    <span class="hljs-attr">LocalVariableTable:</span><br>    <span class="hljs-string">Start</span> <span class="hljs-string">Length</span> <span class="hljs-string">Slot</span> <span class="hljs-string">Name</span> <span class="hljs-string">Signature</span><br>    <span class="hljs-number">0</span> <span class="hljs-number">33</span> <span class="hljs-number">0</span> <span class="hljs-string">args</span> [<span class="hljs-string">Ljava/lang/String;</span><br>    <span class="hljs-number">3</span> <span class="hljs-number">30</span> <span class="hljs-number">1</span> <span class="hljs-string">a</span> <span class="hljs-string">I</span><br>    <span class="hljs-number">18</span> <span class="hljs-number">15</span> <span class="hljs-number">2</span> <span class="hljs-string">b</span> <span class="hljs-string">I</span><br></code></pre></td></tr></table></figure>

<p>分析：</p>
<p>注意<code> iinc 指令</code>是直接在  **局部变量 <code>slot </code>**上进行运算 </p>
<p>a++ 和 ++a 的区别是先执行<code> iload</code> 还是 先执行 <code>iinc</code></p>
<hr>
<p><img src="http://fgcy-pic.zhamao.ml/image-20220809203918195.png" srcset="/img/loading.gif" lazyload alt="image-20220809203918195"></p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220809203945867.png" srcset="/img/loading.gif" lazyload alt="image-20220809203945867"></p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220809204002762.png" srcset="/img/loading.gif" lazyload alt="image-20220809204002762"></p>
<hr>
<hr>
<p><img src="http://fgcy-pic.zhamao.ml/image-20220809204024144.png" srcset="/img/loading.gif" lazyload alt="image-20220809204024144"></p>
<hr>
<hr>
<p><img src="http://fgcy-pic.zhamao.ml/image-20220809204041830.png" srcset="/img/loading.gif" lazyload alt="image-20220809204041830"></p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220809204056743.png" srcset="/img/loading.gif" lazyload alt="image-20220809204056743"></p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220809204109092.png" srcset="/img/loading.gif" lazyload alt="image-20220809204109092"></p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220809204120623.png" srcset="/img/loading.gif" lazyload alt="image-20220809204120623"></p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220809204135324.png" srcset="/img/loading.gif" lazyload alt="image-20220809204135324"></p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220809204221238.png" srcset="/img/loading.gif" lazyload alt="image-20220809204221238"></p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220809204232916.png" srcset="/img/loading.gif" lazyload alt="image-20220809204232916"></p>
<hr>
<h3 id="2-5-条件判断指令"><a href="#2-5-条件判断指令" class="headerlink" title="2.5 条件判断指令"></a>2.5 条件判断指令</h3><hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220809205201784.png" srcset="/img/loading.gif" lazyload alt="image-20220809205201784"></p>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220809205229204.png" srcset="/img/loading.gif" lazyload alt="image-20220809205229204"></p>
<hr>
<p>几点说明： </p>
<p>byte，short，char 都会按 int 比较，因为操作数栈都是 4 字节 </p>
<p>goto 用来进行跳转到指定行号的字节码</p>
<p>例子：</p>
<p>源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3_3</span> &#123;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span>(a == <span class="hljs-number">0</span>) &#123;<br>        	a = <span class="hljs-number">10</span>;<br>     	&#125; <span class="hljs-keyword">else</span> &#123;<br>        	a = <span class="hljs-number">20</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>





<p>字节码：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">0</span>: iconst_0   【注意：-<span class="hljs-number">1</span>到<span class="hljs-number">5</span>之间的数 用iconst表示】这里表示将一个常量<span class="hljs-number">0</span>放到操作数栈中<br><span class="hljs-attribute">1</span>: istore_1		将操作数栈中的数放到局部变量表一号槽位中<br><span class="hljs-attribute">2</span>: iload_1		将局部变量表一号槽位中的数加载到操作数栈中<br><span class="hljs-attribute">3</span>: ifne <span class="hljs-number">12</span>		判断该数是否等于零 不等于零跳到<span class="hljs-number">12</span>行，等于执行下一跳指令<br><span class="hljs-attribute">6</span>: bipush <span class="hljs-number">10</span>    将<span class="hljs-number">10</span>放到操作数栈中<br><span class="hljs-attribute">8</span>: istore_1		将操作数栈中的数放到局部变量表一号槽位中<br><span class="hljs-attribute">9</span>: goto <span class="hljs-number">15</span>		跳转到<span class="hljs-number">15</span>行<br><span class="hljs-attribute">12</span>: bipush <span class="hljs-number">20</span>	将<span class="hljs-number">20</span>放到操作数栈中<br><span class="hljs-attribute">14</span>: istore_1	将操作数栈中的数放到局部变量表一号槽位中<br><span class="hljs-attribute">15</span>: return		结束方法<br></code></pre></td></tr></table></figure>





<p>以上比较指令中没有 long，float，double 的比较，那么它们要比较怎 么办？ </p>
<p>参考 <a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se7/html/jvms-6.html#jvms-6.5.lcmp">https://docs.oracle.com/javase/specs/jvms/se7/html/jvms-6.html#jvms-6.5.lcmp</a></p>
<h3 id="2-6-循环控制指令"><a href="#2-6-循环控制指令" class="headerlink" title="2.6 循环控制指令"></a>2.6 循环控制指令</h3><p>其实循环控制还是前面介绍的那些指令，</p>
<p>例如 while 循环：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3_4</span> &#123;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">while</span> (a &lt; <span class="hljs-number">10</span>) &#123;<br>            a++;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<p>字节码是：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">0</span>: iconst_0   【注意：-<span class="hljs-number">1</span>到<span class="hljs-number">5</span>之间的数 用iconst表示】这里表示将一个常量<span class="hljs-number">0</span>放到操作数栈中<br><span class="hljs-attribute">1</span>: istore_1		将操作数栈中的数放到一号槽位中<br><span class="hljs-attribute">2</span>: iload_1		把一号槽位中的数放到操作数栈中<br><span class="hljs-attribute">3</span>: bipush <span class="hljs-number">10</span>	将<span class="hljs-number">10</span>放到操作数栈中<br><span class="hljs-attribute">5</span>: if_icmpge <span class="hljs-number">14</span>	 零是否大于等于十 大于等于跳到<span class="hljs-number">14</span> 小于继续下一条<br><span class="hljs-attribute">8</span>: iinc <span class="hljs-number">1</span>, <span class="hljs-number">1</span>	槽位为一的数自增一<br><span class="hljs-attribute">11</span>: goto <span class="hljs-number">2</span>		跳转到<span class="hljs-number">2</span><br><span class="hljs-attribute">14</span>: return		结束方法<br></code></pre></td></tr></table></figure>



<p>再比如 do while 循环：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3_5</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">do</span> &#123;<br>       	  a++;<br>        &#125; <span class="hljs-keyword">while</span> (a &lt; <span class="hljs-number">10</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs ldif"><span class="hljs-attribute">0</span>: iconst_0<br><span class="hljs-attribute">1</span>: istore_1<br><span class="hljs-attribute">2</span>: iinc 1, 1<br><span class="hljs-attribute">5</span>: iload_1<br><span class="hljs-attribute">6</span>: bipush 10<br><span class="hljs-attribute">8</span>: if_icmplt 2<br><span class="hljs-attribute">11</span>: return<br></code></pre></td></tr></table></figure>



<p>最后再看看 for 循环：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3_6</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>            <br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>字节码是：</p>
<figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs ldif"><span class="hljs-attribute">0</span>: iconst_0<br><span class="hljs-attribute">1</span>: istore_1<br><span class="hljs-attribute">2</span>: iload_1<br><span class="hljs-attribute">3</span>: bipush 10<br><span class="hljs-attribute">5</span>: if_icmpge 14<br><span class="hljs-attribute">8</span>: iinc 1, 1<br><span class="hljs-attribute">11</span>: goto 2<br><span class="hljs-attribute">14</span>: return<br></code></pre></td></tr></table></figure>

<p>注意 比较 while 和 for 的字节码，你发现它们是一模一样的，殊途也能同归</p>
<h3 id="2-7-练习-判断结果"><a href="#2-7-练习-判断结果" class="headerlink" title="2.7 练习 - 判断结果"></a>2.7 练习 - 判断结果</h3><p>请从字节码角度分析，下列代码运行的结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3_6_1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">while</span> (i &lt; <span class="hljs-number">10</span>) &#123;<br>            x = x++;<br>            i++;<br>        &#125;<br>        System.out.println(x); <span class="hljs-comment">// 结果是 0</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>分析 <code>x=x++</code></p>
<p>我们知到 x++对应两条指令，1：从局部变量表中获取数据到操作数栈中，2:将局部变量表中的槽位中的数据自增一</p>
<p>分析赋值运算符<code>=</code> 将操作数中的数字再赋值给局部变量表中的槽位中的数</p>
<h3 id="2-8-构造方法"><a href="#2-8-构造方法" class="headerlink" title="2.8 构造方法"></a>2.8 构造方法</h3><p>cinit()V</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3_8_1</span> &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br>    <span class="hljs-keyword">static</span> &#123;<br>        i = <span class="hljs-number">20</span>;<br>    &#125;<br>    <span class="hljs-keyword">static</span> &#123;<br>        i = <span class="hljs-number">30</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>编译器会按从上至下的顺序，收集所有 static 静态代码块和静态成员赋值的代码，合并为一个特殊的方 法 &lt;cinit&gt;()V ：</p>
<p>字节码如下：</p>
<figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs ldif"><span class="hljs-attribute">0</span>: bipush 10   					将数字10放到操作数栈中<br><span class="hljs-attribute">2</span>: putstatic <span class="hljs-comment">#2 // Field i:I	将操作数中的数字放到常量池中的一个名为I的变量中</span><br><span class="hljs-attribute">5</span>: bipush 20					将数字20放到操作数栈中<br><span class="hljs-attribute">7</span>: putstatic <span class="hljs-comment">#2 // Field i:I	将操作数中的数字放到常量池中的一个名为I的变量中</span><br><span class="hljs-attribute">10</span>: bipush 30					将数字30放到操作数栈中<br><span class="hljs-attribute">12</span>: putstatic <span class="hljs-comment">#2 // Field i:I	将操作数中的数字放到常量池中的一个名为I的变量中</span><br><span class="hljs-attribute">15</span>: return						结束方法<br></code></pre></td></tr></table></figure>

<p><code>&lt;cinit&gt;()V 方法</code>会在类加载的初始化阶段被调用  【类的构造方法】</p>
<p>&lt;init&gt;()V</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3_8_2</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;s1&quot;</span>;<br>     &#123;<br>        b = <span class="hljs-number">20</span>;<br>    &#125;<br>        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br>     &#123;<br>        a = <span class="hljs-string">&quot;s2&quot;</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Demo3_8_2</span><span class="hljs-params">(String a, <span class="hljs-type">int</span> b)</span> &#123;<br>        <span class="hljs-built_in">this</span>.a = a;<br>        <span class="hljs-built_in">this</span>.b = b;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Demo3_8_2</span> <span class="hljs-variable">d</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Demo3_8_2</span>(<span class="hljs-string">&quot;s3&quot;</span>, <span class="hljs-number">30</span>);<br>        System.out.println(d.a);<br>        System.out.println(d.b);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>编译器会按从上至下的顺序，收集所有 {} 代码块和成员变量赋值的代码，形成新的构造方法</p>
<p><strong>但原始构 造方法内的代码总是在最后</strong></p>
<p>字节码：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs dts">public cn.itcast.jvm.t3.bytecode.Demo3_8_2(java.lang.String, int)<span class="hljs-punctuation">;</span><br><span class="hljs-symbol">descriptor:</span> (Ljava<span class="hljs-keyword">/lang/</span>S<span class="hljs-attr">tring</span><span class="hljs-punctuation">;</span>I)V<br><span class="hljs-symbol">flags:</span> ACC_PUBLIC<br><span class="hljs-symbol">    Code:</span><br>    <span class="hljs-attr">stack</span><span class="hljs-operator">=</span><span class="hljs-number">2</span>, <span class="hljs-attr">locals</span><span class="hljs-operator">=</span><span class="hljs-number">3</span>, args_<span class="hljs-attr">size</span><span class="hljs-operator">=</span><span class="hljs-number">3</span><br>        <span class="hljs-number">0</span>: aload_0        【加载this】<br>        <span class="hljs-number">1</span>: invokespecial <span class="hljs-meta">#1 <span class="hljs-comment">// super.&lt;init&gt;()V   调用Object的init方法 </span></span><br>        <span class="hljs-number">4</span>: aload_0			加载this<br>        <span class="hljs-number">5</span>: ldc <span class="hljs-meta">#2 <span class="hljs-comment">// &lt;- &quot;s1&quot;	将常量池中的“s1”加载到操作数栈</span></span><br>        <span class="hljs-number">7</span>: putfield <span class="hljs-meta">#3 <span class="hljs-comment">// -&gt; this.a		将&quot;s1&quot;赋值给this的a变量</span></span><br>        <span class="hljs-number">10</span>: aload_0<br>        <span class="hljs-number">11</span>: bipush <span class="hljs-number">20</span> <span class="hljs-comment">// &lt;- 20</span><br>        <span class="hljs-number">13</span>: putfield <span class="hljs-meta">#4 <span class="hljs-comment">// -&gt; this.b</span></span><br>        <span class="hljs-number">16</span>: aload_0<br>        <span class="hljs-number">17</span>: bipush <span class="hljs-number">10</span> <span class="hljs-comment">// &lt;- 10</span><br>        <span class="hljs-number">19</span>: putfield <span class="hljs-meta">#4 <span class="hljs-comment">// -&gt; this.b</span></span><br>        <span class="hljs-number">22</span>: aload_0<br>        <span class="hljs-number">23</span>: ldc <span class="hljs-meta">#5 <span class="hljs-comment">// &lt;- &quot;s2&quot;</span></span><br>        <span class="hljs-number">25</span>: putfield <span class="hljs-meta">#3 <span class="hljs-comment">// -&gt; this.a</span></span><br>        <span class="hljs-number">28</span>: aload_0 <span class="hljs-comment">// ------------------------------</span><br>        <span class="hljs-number">29</span>: aload_1 <span class="hljs-comment">// &lt;- slot 1(a) &quot;s3&quot; |</span><br>        <span class="hljs-number">30</span>: putfield <span class="hljs-meta">#3 <span class="hljs-comment">// -&gt; this.a |</span></span><br>        <span class="hljs-number">33</span>: aload_0 |<br>        <span class="hljs-number">34</span>: iload_2 <span class="hljs-comment">// &lt;- slot 2(b) 30 |</span><br>        <span class="hljs-number">35</span>: putfield <span class="hljs-meta">#4 <span class="hljs-comment">// -&gt; this.b --------------------</span></span><br>        <span class="hljs-number">38</span>: return<br><span class="hljs-symbol">    LineNumberTable:</span> ...<br><span class="hljs-symbol">    LocalVariableTable:</span><br>        Start Length Slot Name Signature<br>        <span class="hljs-number">0</span> <span class="hljs-number">39</span> <span class="hljs-number">0</span> this Lcn<span class="hljs-keyword">/itcast/</span>jvm<span class="hljs-keyword">/t3/</span>bytecode/Demo3_8_2<span class="hljs-punctuation">;</span><br>        <span class="hljs-number">0</span> <span class="hljs-number">39</span> <span class="hljs-number">1</span> a Ljava<span class="hljs-keyword">/lang/</span>S<span class="hljs-attr">tring</span><span class="hljs-punctuation">;</span><br>        <span class="hljs-number">0</span> <span class="hljs-number">39</span> <span class="hljs-number">2</span> b I<br><span class="hljs-symbol">MethodParameters:</span> ...<br><br></code></pre></td></tr></table></figure>





<h3 id="2-9-方法调用"><a href="#2-9-方法调用" class="headerlink" title="2.9 方法调用"></a>2.9 方法调用</h3><p>看一下几种不同的方法调用对应的字节码指令：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3_9</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Demo3_9</span><span class="hljs-params">()</span> &#123; &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test1</span><span class="hljs-params">()</span> &#123; &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test2</span><span class="hljs-params">()</span> &#123; &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test3</span><span class="hljs-params">()</span> &#123; &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test4</span><span class="hljs-params">()</span> &#123; &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Demo3_9</span> <span class="hljs-variable">d</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Demo3_9</span>();<br>        d.test1();<br>        d.test2();<br>        d.test3();<br>        d.test4();<br>        Demo3_9.test4();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs ldif"><span class="hljs-attribute">0</span>: new <span class="hljs-comment">#2 // class cn/itcast/jvm/t3/bytecode/Demo3_9   【分配该对象在堆中所需要的内存，将对象的引用放到操作数栈中】</span><br><span class="hljs-attribute">3</span>: dup   【将栈顶的对象引用进行一次复制，放在栈顶； 	】<br><span class="hljs-attribute">4</span>: invokespecial <span class="hljs-comment">#3 // Method &quot;&lt;init&gt;&quot;:()V   【根据栈顶的引用调用对象的构造方法】 调用结束后，将栈顶元素出栈</span><br><span class="hljs-attribute">7</span>: astore_1									【将操作数栈中的对象地址放到局部变量表的一号槽位中】<br><span class="hljs-attribute">8</span>: aload_1<br><span class="hljs-attribute">9</span>: invokespecial <span class="hljs-comment">#4 // Method test1:()V</span><br><span class="hljs-attribute">12</span>: aload_1<br><span class="hljs-attribute">13</span>: invokespecial <span class="hljs-comment">#5 // Method test2:()V</span><br><span class="hljs-attribute">16</span>: aload_1<br><span class="hljs-attribute">17</span>: invokevirtual <span class="hljs-comment">#6 // Method test3:()V</span><br><span class="hljs-attribute">20</span>: aload_1   【加载对象的地址到操作数栈】<br><span class="hljs-attribute">21</span>: pop		【发现是静态方法的调用，将对象丢弃出操作数栈】<br><span class="hljs-attribute">22</span>: invokestatic <span class="hljs-comment">#7 // Method test4:()V	【调用静态方法】</span><br><span class="hljs-attribute">25</span>: invokestatic <span class="hljs-comment">#7 // Method test4:()V</span><br><span class="hljs-attribute">28</span>: return<br></code></pre></td></tr></table></figure>

<p><code>invokespecial   </code> ：私有方法、构造方法</p>
<p><code>invokestatic</code> ： 静态方法</p>
<p>上面两个方法属于静态绑定，在字节码生成后（编译期），就可以确定是哪个类的哪个方法；【因为静态的方法，和私有的方法不可以重写】</p>
<p><code>invokevisual</code> :普通public的方法 【可以重写，即可以多态，编译期间不可以确认调用哪个类的哪个方法】 动态绑定 	 </p>
<p>字节码指令分析</p>
<p>1、new 是创建【对象】，给对象分配堆内存，执行成功会将【对象引用】压入操作数栈</p>
<p>2、dup 是复制操作数栈栈顶的内容，本例即为【对象引用】，为什么需要两份引用呢</p>
<p>​	一个是要配合 invokespecial 调用该对象的构造方法 “&lt;init&gt;”:()V （会消耗掉栈顶一个引用），另一个要配合 astore_1 赋值给局部变量</p>
<p>3、最终方法（final），私有方法（private），构造方法都是由 invokespecial 指令来调用，属于静态绑定</p>
<p>4、普通成员方法是由 invokevirtual 调用，属于动态绑定，即支持多态</p>
<p>5、成员方法与静态方法调用的另一个区别是，执行方法前是否需要【对象引用】</p>
<p>6、比较有意思的是 d.test4(); 是通过【对象引用】调用一个静态方法，可以看到在调用</p>
<p>7、invokestatic 之前执行了 pop 指令，把【对象引用】从操作数栈弹掉了😂</p>
<p>8、还有一个执行 invokespecial 的情况是通过 super 调用父类方法</p>
<h3 id="2-10-多态的原理"><a href="#2-10-多态的原理" class="headerlink" title="2.10 多态的原理"></a>2.10 多态的原理</h3><p>源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t3.bytecode;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 演示多态原理，注意加上下面的 JVM 参数，禁用指针压缩</span><br><span class="hljs-comment"> * -XX:-UseCompressedOops -XX:-UseCompressedClassPointers</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3_10</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">(Animal animal)</span> &#123;<br>        animal.eat();<br>        System.out.println(animal.toString());<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        test(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Cat</span>());<br>        test(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>());<br>        System.in.read();<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">eat</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;我是&quot;</span> + <span class="hljs-built_in">this</span>.getClass().getSimpleName();<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Animal</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">eat</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;啃骨头&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Animal</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">eat</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;吃鱼&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>1）运行代码 </p>
<p>停在 System.in.read() 方法上，这时运行 jps 获取进程 id</p>
<p>2）运行 HSDB 工具 进入 JDK 安装目录，执行</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">java -cp ./lib/sa-jdi<span class="hljs-selector-class">.jar</span> sun<span class="hljs-selector-class">.jvm</span><span class="hljs-selector-class">.hotspot</span>.HSDB<br></code></pre></td></tr></table></figure>

<p>进入图形界面</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220809233300483.png" srcset="/img/loading.gif" lazyload alt="image-20220809233300483"></p>
<hr>
<p>3）查找某个对象</p>
<p>打开 <code>Tools -&gt; Find Object By Query </code></p>
<p>输入<code>select d from cn.itcast.jvm.t3.bytecode.Dog d</code>点击 Execute 执行</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220809235241134.png" srcset="/img/loading.gif" lazyload alt="image-20220809235241134"></p>
<hr>
<p>4）查看对象内存结构 </p>
<p>点击超链接可以看到对象的内存结构，此对象没有任何属性，因此只有对象头的 16 字节，前 8 字节是 MarkWord，后 8 字节就是对象的 Class 指针 </p>
<p>但目前看不到它的实际地址</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220809235352985.png" srcset="/img/loading.gif" lazyload alt="image-20220809235352985"></p>
<hr>
<p>5）查看对象 Class 的内存地址 </p>
<p>可以通过 Windows -&gt; Console 进入命令行模式，执行</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">mem</span> <span class="hljs-number">0</span>x00000001299b4978 <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure>

<p>mem 有两个参数，参数 1 是对象地址，参数 2 是查看 2 行（即 16 字节） </p>
<p>结果中第二行 0x000000001b7d4028 即为 Class 的内存地址</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220810195514780.png" srcset="/img/loading.gif" lazyload alt="image-20220810195514780"></p>
<hr>
<p>6）查看类的 vtable</p>
<p>方法1：Alt+R 进入 Inspector 工具，输入刚才的 Class 内存地址，看到如下界面</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220813004142929.png" srcset="/img/loading.gif" lazyload alt="image-20220813004142929"></p>
<hr>
<p>方法2：或者 Tools -&gt; Class Browser 输入 Dog 查找，可以得到相同的结果</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220810200332444.png" srcset="/img/loading.gif" lazyload alt="image-20220810200332444"></p>
<hr>
<p>无论通过哪种方法，都可以找到 Dog<code> Class 的 vtable 长度</code>为 6，意思就是 Dog 类有 6 个虚方法【多态 相关的】（final，static 不会列入）</p>
<p> 那么这 6 个方法都是谁呢？</p>
<p>从 <strong>Class 的起始地址开始算</strong>，<strong>偏移 0x1b8 就是 vtable 的起始地址</strong>，进行计 算得到：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">0x000000001b7d4028<br><span class="hljs-section">               1b8 +</span><br><span class="hljs-section">---------------------</span><br>0x000000001b7d41e0<br></code></pre></td></tr></table></figure>



<p>通过 Windows -&gt; Console 进入命令行模式，执行</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">mem</span> <span class="hljs-number">0</span>x000000001b7d41e0 <span class="hljs-number">6</span><br></code></pre></td></tr></table></figure>

<p>类地址 + 偏移量地址 &#x3D; vtable地址</p>
<p>在Inspector中找到Vtable的的长度为6</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-number">0x000000001b7d41e0</span>: <span class="hljs-number">0x000000001b3d1b10</span><br><span class="hljs-number">0x000000001b7d41e8</span>: <span class="hljs-number">0x000000001b3d15e8</span><br><span class="hljs-number">0x000000001b7d41f0</span>: <span class="hljs-number">0x000000001b7d35e8</span><br><span class="hljs-number">0x000000001b7d41f8</span>: <span class="hljs-number">0x000000001b3d1540</span><br><span class="hljs-number">0x000000001b7d4200</span>: <span class="hljs-number">0x000000001b3d1678</span><br><span class="hljs-number">0x000000001b7d4208</span>: <span class="hljs-number">0x000000001b7d3fa8</span><br></code></pre></td></tr></table></figure>

<p>就得到了 6 个虚方法的入口地址</p>
<p>通过对象找到类对象，找到虚方法表，通过虚方法表找到方法的入口地址【连接阶段就生成虚方法表】</p>
<p>7）验证方法地址</p>
<p>通过 Tools -&gt; Class Browser 查看每个类的方法定义，比较可知</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220813004223713.png" srcset="/img/loading.gif" lazyload alt="image-20220813004223713"></p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220813004257145.png" srcset="/img/loading.gif" lazyload alt="image-20220813004257145"></p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220813004327252.png" srcset="/img/loading.gif" lazyload alt="image-20220813004327252"></p>
<hr>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs csharp">Dog - <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">eat</span>() @0x000000001b7d3fa8</span><br><span class="hljs-function">Animal - <span class="hljs-keyword">public</span> java.lang.String <span class="hljs-title">toString</span>() @0x000000001b7d35e8</span>;<br>Object - <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">finalize</span>() @0x000000001b3d1b10</span>;<br>Object - <span class="hljs-function"><span class="hljs-keyword">public</span> boolean <span class="hljs-title">equals</span>(<span class="hljs-params">java.lang.Object</span>) @0x000000001b3d15e8</span>;<br>Object - <span class="hljs-function"><span class="hljs-keyword">public</span> native <span class="hljs-built_in">int</span> <span class="hljs-title">hashCode</span>() @0x000000001b3d1540</span>;<br>Object - <span class="hljs-keyword">protected</span> native java.lang.<span class="hljs-function">Object <span class="hljs-title">clone</span>() @0x000000001b3d1678</span>;<br></code></pre></td></tr></table></figure>

<p>对号入座，发现 </p>
<p>eat() 方法是 Dog 类自己的 </p>
<p>toString() 方法是继承 String 类的</p>
<p>finalize() ，equals()，hashCode()，clone() 都是继承 Object 类的</p>
<p>8）小结</p>
<p>当执行 invokevirtual 指令时： </p>
<ol>
<li>先通过栈帧中的<strong>对象引用</strong>找到对象 </li>
<li>分析<strong>对象头</strong>，找到对象的实际 Class【对象头中包含有8个字节的关于该对象Class对象的地址】</li>
<li>Class 结构中有<code> vtable</code>，它在<strong>类加载的链接阶段</strong>就已经根据方法的重写规则生成好了</li>
<li>查表得到方法的具体地址 </li>
<li>执行方法的字节码</li>
</ol>
<p>注意：</p>
<p>静态方法，私有方法，最终方法不会在虚方法表</p>
<h3 id="2-11-异常处理"><a href="#2-11-异常处理" class="headerlink" title="2.11 异常处理"></a>2.11 异常处理</h3><p>try-catch</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3_11_1</span> &#123;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>         <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            i = <span class="hljs-number">10</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            i = <span class="hljs-number">20</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>注意 为了抓住重点，下面的字节码省略了不重要的部分:\</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(java.lang.String[])</span>;<br>descriptor: ([Ljava/lang/String;)V<br>flags: ACC_PUBLIC, ACC_STATIC<br>    Code:<br>    stack=<span class="hljs-number">1</span>, locals=<span class="hljs-number">3</span>, args_size=<span class="hljs-number">1</span><br>        <span class="hljs-number">0</span>: iconst_0<br>        <span class="hljs-number">1</span>: istore_1     i=<span class="hljs-number">0</span><br>        <span class="hljs-number">2</span>: bipush <span class="hljs-number">10</span><br>        <span class="hljs-number">4</span>: istore_1		i=<span class="hljs-number">10</span><br>        <span class="hljs-number">5</span>: goto <span class="hljs-number">12</span>		转去结束方法<br>        <span class="hljs-number">8</span>: astore_2    将异常对象的引用地址存放到局部变量表中的二号槽位<br>        <span class="hljs-number">9</span>: bipush <span class="hljs-number">20</span><br>        <span class="hljs-number">11</span>: istore_1	将操作数栈中的<span class="hljs-number">20</span> 放到局部变量表中的<span class="hljs-number">1</span>号槽位<br>        <span class="hljs-number">12</span>: <span class="hljs-keyword">return</span>		结束方法<br>    Exception table:   异常表<br>    from to target type<br>    <span class="hljs-number">2</span> <span class="hljs-number">5</span> <span class="hljs-number">8</span> Class java/lang/Exception   包含第二行到第四行的指令【包前不包后】出现异常后，判断是否是表中的异常类型或子类 是就进入第八行指令<br>    LineNumberTable: ...<br>    LocalVariableTable:<br>        Start Length Slot Name Signature<br>        <span class="hljs-number">9</span> <span class="hljs-number">3</span> <span class="hljs-number">2</span> e Ljava/lang/Exception;<br>        <span class="hljs-number">0</span> <span class="hljs-number">13</span> <span class="hljs-number">0</span> args [Ljava/lang/String;<br>        <span class="hljs-number">2</span> <span class="hljs-number">11</span> <span class="hljs-number">1</span> i I<br>StackMapTable: ...<br>MethodParameters: ...<br>&#125;<br></code></pre></td></tr></table></figure>

<p>重点小结：</p>
<p>可以看到多出来一个 Exception table 的结构，[from, to) 是前闭后开的检测范围，一旦这个范围 内的字节码执行出现异常，则通过 type 匹配异常类型，如果一致，进入 target 所指示行号 8 行的字节码指令 astore_2 是将异常对象引用存入局部变量表的 slot 2 位置</p>
<p>多个 single-catch 块的情况</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3_11_2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            i = <span class="hljs-number">10</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (ArithmeticException e) &#123;<br>            i = <span class="hljs-number">30</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (NullPointerException e) &#123;<br>            i = <span class="hljs-number">40</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            i = <span class="hljs-number">50</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">public static void main(java.lang.String[]);</span><br><span class="hljs-attribute">descriptor</span><span class="hljs-punctuation">:</span> <span class="hljs-string">([Ljava/lang/String;)V</span><br><span class="hljs-attribute">flags</span><span class="hljs-punctuation">:</span> <span class="hljs-string">ACC_PUBLIC, ACC_STATIC</span><br>    <span class="hljs-attribute">Code</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">stack=1, locals=3, args_size=1</span><br><span class="hljs-attribute">        0</span><span class="hljs-punctuation">:</span> <span class="hljs-string">iconst_0</span><br>        <span class="hljs-attribute">1</span><span class="hljs-punctuation">:</span> <span class="hljs-string">istore_1</span><br>        <span class="hljs-attribute">2</span><span class="hljs-punctuation">:</span> <span class="hljs-string">bipush 10</span><br>        <span class="hljs-attribute">4</span><span class="hljs-punctuation">:</span> <span class="hljs-string">istore_1</span><br>        <span class="hljs-attribute">5</span><span class="hljs-punctuation">:</span> <span class="hljs-string">goto 26</span><br>        <span class="hljs-attribute">8</span><span class="hljs-punctuation">:</span> <span class="hljs-string">astore_2</span><br>        <span class="hljs-attribute">9</span><span class="hljs-punctuation">:</span> <span class="hljs-string">bipush 30</span><br>        <span class="hljs-attribute">11</span><span class="hljs-punctuation">:</span> <span class="hljs-string">istore_1</span><br>        <span class="hljs-attribute">12</span><span class="hljs-punctuation">:</span> <span class="hljs-string">goto 26</span><br>        <span class="hljs-attribute">15</span><span class="hljs-punctuation">:</span> <span class="hljs-string">astore_2</span><br>        <span class="hljs-attribute">16</span><span class="hljs-punctuation">:</span> <span class="hljs-string">bipush 40</span><br>        <span class="hljs-attribute">18</span><span class="hljs-punctuation">:</span> <span class="hljs-string">istore_1</span><br>        <span class="hljs-attribute">19</span><span class="hljs-punctuation">:</span> <span class="hljs-string">goto 26</span><br>        <span class="hljs-attribute">22</span><span class="hljs-punctuation">:</span> <span class="hljs-string">astore_2</span><br>        <span class="hljs-attribute">23</span><span class="hljs-punctuation">:</span> <span class="hljs-string">bipush 50</span><br>        <span class="hljs-attribute">25</span><span class="hljs-punctuation">:</span> <span class="hljs-string">istore_1</span><br>        <span class="hljs-attribute">26</span><span class="hljs-punctuation">:</span> <span class="hljs-string">return</span><br>    <span class="hljs-attribute">Exception table</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">from to target type</span><br><span class="hljs-attribute">    2 5 8 Class java/lang/ArithmeticException</span><br><span class="hljs-attribute">    2 5 15 Class java/lang/NullPointerException</span><br><span class="hljs-attribute">    2 5 22 Class java/lang/Exception</span><br><span class="hljs-attribute">LineNumberTable</span><span class="hljs-punctuation">:</span> <span class="hljs-string">...</span><br>    <span class="hljs-attribute">LocalVariableTable</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">Start Length Slot Name Signature</span><br><span class="hljs-attribute">    9 3 2 e Ljava/lang/ArithmeticException; 这里三个异常类型的对象都会放到一个槽位中，因为每次只会出现一个异常，所以可以共用</span><br><span class="hljs-attribute">    16 3 2 e Ljava/lang/NullPointerException;</span><br><span class="hljs-attribute">    23 3 2 e Ljava/lang/Exception;</span><br><span class="hljs-attribute">    0 27 0 args [Ljava/lang/String;</span><br><span class="hljs-attribute">    2 25 1 i I</span><br><span class="hljs-attribute">StackMapTable</span><span class="hljs-punctuation">:</span> <span class="hljs-string">...</span><br><span class="hljs-attribute">MethodParameters</span><span class="hljs-punctuation">:</span> <span class="hljs-string">...</span><br></code></pre></td></tr></table></figure>

<p>注意：</p>
<p>因为异常出现时，只能进入 Exception table 中一个分支，所以局部变量表 slot 2 位置被共用</p>
<p>multi-catch 的情况：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3_11_3</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Method</span> <span class="hljs-variable">test</span> <span class="hljs-operator">=</span> Demo3_11_3.class.getMethod(<span class="hljs-string">&quot;test&quot;</span>);<br>            test.invoke(<span class="hljs-literal">null</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException | IllegalAccessException |<br>            InvocationTargetException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;ok&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">public</span> <span class="hljs-string">static</span> <span class="hljs-string">void</span> <span class="hljs-string">main(java.lang.String[]);</span><br><span class="hljs-attr">descriptor:</span> <span class="hljs-string">([Ljava/lang/String;)V</span><br><span class="hljs-attr">flags:</span> <span class="hljs-string">ACC_PUBLIC,</span> <span class="hljs-string">ACC_STATIC</span><br>    <span class="hljs-attr">Code:</span><br>    <span class="hljs-string">stack=3,</span> <span class="hljs-string">locals=2,</span> <span class="hljs-string">args_size=1</span><br>        <span class="hljs-attr">0:</span> <span class="hljs-string">ldc</span> <span class="hljs-comment">#2</span><br>        <span class="hljs-attr">2:</span> <span class="hljs-string">ldc</span> <span class="hljs-comment">#3</span><br>        <span class="hljs-attr">4:</span> <span class="hljs-string">iconst_0</span><br>        <span class="hljs-attr">5:</span> <span class="hljs-string">anewarray</span> <span class="hljs-comment">#4</span><br>        <span class="hljs-attr">8:</span> <span class="hljs-string">invokevirtual</span> <span class="hljs-comment">#5</span><br>        <span class="hljs-attr">11:</span> <span class="hljs-string">astore_1</span><br>        <span class="hljs-attr">12:</span> <span class="hljs-string">aload_1</span><br>        <span class="hljs-attr">13:</span> <span class="hljs-string">aconst_null</span><br>        <span class="hljs-attr">14:</span> <span class="hljs-string">iconst_0</span><br>        <span class="hljs-attr">15:</span> <span class="hljs-string">anewarray</span> <span class="hljs-comment">#6</span><br>        <span class="hljs-attr">18:</span> <span class="hljs-string">invokevirtual</span> <span class="hljs-comment">#7</span><br>        <span class="hljs-attr">21:</span> <span class="hljs-string">pop</span><br>        <span class="hljs-attr">22:</span> <span class="hljs-string">goto</span> <span class="hljs-number">30</span><br>        <span class="hljs-attr">25:</span> <span class="hljs-string">astore_1</span><br>        <span class="hljs-attr">26:</span> <span class="hljs-string">aload_1</span><br>        <span class="hljs-attr">27:</span> <span class="hljs-string">invokevirtual</span> <span class="hljs-comment">#11 // e.printStackTrace:()V</span><br>        <span class="hljs-attr">30:</span> <span class="hljs-string">return</span><br><span class="hljs-attr">Exception table:</span><br>        <span class="hljs-string">from</span> <span class="hljs-string">to</span> <span class="hljs-string">target</span> <span class="hljs-string">type</span><br>        <span class="hljs-number">0</span> <span class="hljs-number">22</span> <span class="hljs-number">25</span> <span class="hljs-string">Class</span> <span class="hljs-string">java/lang/NoSuchMethodException</span><br>        <span class="hljs-number">0</span> <span class="hljs-number">22</span> <span class="hljs-number">25</span> <span class="hljs-string">Class</span> <span class="hljs-string">java/lang/IllegalAccessException</span><br>        <span class="hljs-number">0</span> <span class="hljs-number">22</span> <span class="hljs-number">25</span> <span class="hljs-string">Class</span> <span class="hljs-string">java/lang/reflect/InvocationTargetException</span>  <span class="hljs-string">无论是哪个异常，都会去执行25行指令</span><br><span class="hljs-attr">LineNumberTable:</span> <span class="hljs-string">...</span><br><span class="hljs-attr">LocalVariableTable:</span><br>        <span class="hljs-string">Start</span> <span class="hljs-string">Length</span> <span class="hljs-string">Slot</span> <span class="hljs-string">Name</span> <span class="hljs-string">Signature</span><br>        <span class="hljs-number">12</span> <span class="hljs-number">10</span> <span class="hljs-number">1</span> <span class="hljs-string">test</span> <span class="hljs-string">Ljava/lang/reflect/Method;</span><br>        <span class="hljs-number">26</span> <span class="hljs-number">4</span> <span class="hljs-number">1</span> <span class="hljs-string">e</span> <span class="hljs-string">Ljava/lang/ReflectiveOperationException;</span><br>        <span class="hljs-number">0</span> <span class="hljs-number">31</span> <span class="hljs-number">0</span> <span class="hljs-string">args</span> [<span class="hljs-string">Ljava/lang/String;</span><br><span class="hljs-attr">StackMapTable:</span> <span class="hljs-string">...</span><br><span class="hljs-attr">MethodParameters:</span> <span class="hljs-string">...</span><br></code></pre></td></tr></table></figure>



<p>finally</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3_11_4</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            i = <span class="hljs-number">10</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            i = <span class="hljs-number">20</span>;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            i = <span class="hljs-number">30</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs awk">public static void main(java.lang.String[]);<br>descriptor: ([Ljava<span class="hljs-regexp">/lang/</span>String;)V<br>flags: ACC_PUBLIC, ACC_STATIC<br>    Code:<br>    stack=<span class="hljs-number">1</span>, locals=<span class="hljs-number">4</span>, args_size=<span class="hljs-number">1</span><br>        <span class="hljs-number">0</span>: iconst_0<br>        <span class="hljs-number">1</span>: istore_1 <span class="hljs-regexp">//</span> <span class="hljs-number">0</span> -&gt; i<br>        <span class="hljs-number">2</span>: bipush <span class="hljs-number">10</span> <span class="hljs-regexp">//</span>           try --------------------------------------<br>        <span class="hljs-number">4</span>: istore_1 <span class="hljs-regexp">//</span> <span class="hljs-number">10</span> -&gt; i    catch-------------------------<br>        <span class="hljs-number">5</span>: bipush <span class="hljs-number">30</span> <span class="hljs-regexp">//</span>           finally 要执行的逻辑<br>        <span class="hljs-number">7</span>: istore_1 <span class="hljs-regexp">//</span> <span class="hljs-number">30</span> -&gt; i<br>        <span class="hljs-number">8</span>: goto <span class="hljs-number">27</span> <span class="hljs-regexp">//</span> 			  跳转到return -----------------------------------<br>        <span class="hljs-number">11</span>: astore_2 <span class="hljs-regexp">//</span> 		  将抓到的异常对象放在二号槽位上<br>        <span class="hljs-number">12</span>: bipush <span class="hljs-number">20</span> <span class="hljs-regexp">//</span> 		  抓到异常后的逻辑<br>        <span class="hljs-number">14</span>: istore_1 <span class="hljs-regexp">//</span> <span class="hljs-number">20</span> -&gt; i <br>        <span class="hljs-number">15</span>: bipush <span class="hljs-number">30</span> <span class="hljs-regexp">//</span> finally   finally 要执行的逻辑<br>        <span class="hljs-number">17</span>: istore_1 <span class="hljs-regexp">//</span> <span class="hljs-number">30</span> -&gt; i <br>        <span class="hljs-number">18</span>: goto <span class="hljs-number">27</span> <span class="hljs-regexp">//</span>			 跳转到return -----------------------------------<br>        <span class="hljs-number">21</span>: astore_3 <span class="hljs-regexp">//</span> 		 捕获任何异常，放到三号槽位中【try块中出现了error、throwable、或不在范围内的异常 以及 catch中出现的任何异常】<br>        <span class="hljs-number">22</span>: bipush <span class="hljs-number">30</span> <span class="hljs-regexp">//</span> finally   finally 要执行的逻辑<br>        <span class="hljs-number">24</span>: istore_1 <span class="hljs-regexp">//</span> <span class="hljs-number">30</span> -&gt; i <br>        <span class="hljs-number">25</span>: aload_3 <span class="hljs-regexp">//</span> &lt;-        取槽位为三的异常对象<br>        <span class="hljs-number">26</span>: athrow <span class="hljs-regexp">//</span>   		抛出<br>        <span class="hljs-number">27</span>: return				结束方法<br>Exception table:<br>        from to target type<br>        <span class="hljs-number">2</span> <span class="hljs-number">5</span> <span class="hljs-number">11</span> Class java<span class="hljs-regexp">/lang/</span>Exception<br>        <span class="hljs-number">2</span> <span class="hljs-number">5</span> <span class="hljs-number">21</span> any <span class="hljs-regexp">//</span> 剩余的异常类型，比如 Error<br>        <span class="hljs-number">11</span> <span class="hljs-number">15</span> <span class="hljs-number">21</span> any <span class="hljs-regexp">//</span> 剩余的异常类型，比如 Error<br>LineNumberTable: ...<br>LocalVariableTable:<br>        Start Length Slot Name Signature<br>        <span class="hljs-number">12</span> <span class="hljs-number">3</span> <span class="hljs-number">2</span> e Ljava<span class="hljs-regexp">/lang/</span>Exception;<br>        <span class="hljs-number">0</span> <span class="hljs-number">28</span> <span class="hljs-number">0</span> args [Ljava<span class="hljs-regexp">/lang/</span>String;<br>        <span class="hljs-number">2</span> <span class="hljs-number">26</span> <span class="hljs-number">1</span> i I<br>StackMapTable: ...<br>MethodParameters: ...<br></code></pre></td></tr></table></figure>

<p>可以看到 finally 中的代码被复制了 3 份，分别放入 <strong>try 流程</strong>，<strong>catch 流程</strong>以及 <strong>catch 剩余的异常类型流 程</strong></p>
<h3 id="2-12-练习-finally-面试题"><a href="#2-12-练习-finally-面试题" class="headerlink" title="2.12 练习 - finally 面试题"></a>2.12 练习 - finally 面试题</h3><p><strong>finally 出现了 return</strong> </p>
<p>先问问自己，下面的题目输出什么？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3_12_2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> test();<br>        System.out.println(result);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">10</span>;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">20</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">public</span> static int test();<br><span class="hljs-attribute">descriptor</span>: ()I<br><span class="hljs-attribute">flags</span>: ACC_PUBLIC, ACC_STATIC<br>    <span class="hljs-attribute">Code</span>:<br>    <span class="hljs-attribute">stack</span>=<span class="hljs-number">1</span>, locals=<span class="hljs-number">2</span>, args_size=<span class="hljs-number">0</span><br>        <span class="hljs-attribute">0</span>: bipush <span class="hljs-number">10</span> // &lt;- <span class="hljs-number">10</span> 放入栈顶<br>        <span class="hljs-attribute">2</span>: istore_0 // <span class="hljs-number">10</span> -&gt; slot <span class="hljs-number">0</span> (从栈顶移除了)<br>        <span class="hljs-attribute">3</span>: bipush <span class="hljs-number">20</span> // &lt;- <span class="hljs-number">20</span> 放入栈顶<br>        <span class="hljs-attribute">5</span>: ireturn // 返回栈顶 int(<span class="hljs-number">20</span>)<br>        <span class="hljs-attribute">6</span>: astore_1 // catch any -&gt; slot <span class="hljs-number">1</span><br>        <span class="hljs-attribute">7</span>: bipush <span class="hljs-number">20</span> // &lt;- <span class="hljs-number">20</span> 放入栈顶<br>        <span class="hljs-attribute">9</span>: ireturn // 返回栈顶 int(<span class="hljs-number">20</span>)<br><span class="hljs-attribute">Exception</span> table:<br>        <span class="hljs-attribute">from</span> to target type<br>        <span class="hljs-attribute">0</span> <span class="hljs-number">3</span> <span class="hljs-number">6</span> any<br><span class="hljs-attribute">LineNumberTable</span>: ...<br><span class="hljs-attribute">StackMapTable</span>: ...<br></code></pre></td></tr></table></figure>

<p>由于 finally 中的 ireturn 被插入了所有可能的流程，因此返回结果肯定以 finally 的为准 </p>
<p>至于字节码中第 2 行，似乎没啥用，且留个伏笔，看下个例子 </p>
<p>跟上例中的 finally 相比，发现<strong>没有 athrow</strong> 了，</p>
<p>这告诉我们：<strong>如果在 finally 中出现了 return，会 吞掉  异常</strong>😱😱😱，</p>
<p>可以试一下下面的代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3_12_1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> test();<br>        System.out.println(result);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>/<span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">10</span>;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">20</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>注意：</p>
<p>这样是不会发生异常的，结果是20</p>
<p>finally 对返回值影响 </p>
<p>同样问问自己，下面的题目输出什么？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3_12_2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> test();<br>        System.out.println(result);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> i;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            i = <span class="hljs-number">20</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">public</span> static int test();<br><span class="hljs-attribute">descriptor</span>: ()I<br><span class="hljs-attribute">flags</span>: ACC_PUBLIC, ACC_STATIC<br>    <span class="hljs-attribute">Code</span>:<br>    <span class="hljs-attribute">stack</span>=<span class="hljs-number">1</span>, locals=<span class="hljs-number">3</span>, args_size=<span class="hljs-number">0</span><br>        <span class="hljs-attribute">0</span>: bipush <span class="hljs-number">10</span> // &lt;- <span class="hljs-number">10</span> 放入栈顶<br>        <span class="hljs-attribute">2</span>: istore_0 // <span class="hljs-number">10</span> -&gt; i<br>        <span class="hljs-attribute">3</span>: iload_0 // &lt;- i(<span class="hljs-number">10</span>)<br>        <span class="hljs-attribute">4</span>: istore_1 // <span class="hljs-number">10</span> -&gt; slot <span class="hljs-number">1</span>，    【本来想直接返回的，发现有finally】暂存至 slot <span class="hljs-number">1</span>，目的是为了固定返回值<br>        <span class="hljs-attribute">5</span>: bipush <span class="hljs-number">20</span> // &lt;- <span class="hljs-number">20</span> 放入栈顶<br>        <span class="hljs-attribute">7</span>: istore_0 // <span class="hljs-number">20</span> -&gt; i<br>        <span class="hljs-attribute">8</span>: iload_1 // &lt;- slot <span class="hljs-number">1</span>(<span class="hljs-number">10</span>) 载入 slot <span class="hljs-number">1</span> 暂存的值<br>        <span class="hljs-attribute">9</span>: ireturn // 返回栈顶的 int(<span class="hljs-number">10</span>)<br>        <span class="hljs-attribute">10</span>: astore_2<br>        <span class="hljs-attribute">11</span>: bipush <span class="hljs-number">20</span><br>        <span class="hljs-attribute">13</span>: istore_0<br>        <span class="hljs-attribute">14</span>: aload_2<br>        <span class="hljs-attribute">15</span>: athrow<br><span class="hljs-attribute">Exception</span> table:<br>        <span class="hljs-attribute">from</span> to target type<br>        <span class="hljs-attribute">3</span>     <span class="hljs-number">5</span>   <span class="hljs-number">10</span>    any<br><span class="hljs-attribute">LineNumberTable</span>: ...<br><span class="hljs-attribute">LocalVariableTable</span>:<br>        <span class="hljs-attribute">Start</span> Length Slot Name Signature<br>         <span class="hljs-attribute">3</span>       <span class="hljs-number">13</span>     <span class="hljs-number">0</span>    i      I<br><span class="hljs-attribute">StackMapTable</span>: ...<br></code></pre></td></tr></table></figure>



<h3 id="2-13-synchronized"><a href="#2-13-synchronized" class="headerlink" title="2.13 synchronized"></a>2.13 synchronized</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3_13</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br>            <span class="hljs-keyword">synchronized</span> (lock) &#123;<br>            System.out.println(<span class="hljs-string">&quot;ok&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs lasso"><span class="hljs-keyword">public</span> static <span class="hljs-literal">void</span> main(java.lang.<span class="hljs-built_in">String</span><span class="hljs-meta">[</span><span class="hljs-meta">]</span>);<br>descriptor: (<span class="hljs-meta">[</span>Ljava/lang/<span class="hljs-built_in">String</span>;)V<br>flags: ACC_PUBLIC, ACC_STATIC<br>    Code:<br>    <span class="hljs-built_in">stack</span>=<span class="hljs-number">2</span>, locals=<span class="hljs-number">4</span>, args_size=<span class="hljs-number">1</span><br>        <span class="hljs-number">0</span>: <span class="hljs-literal">new</span> #2 <span class="hljs-comment">// new Object  创建一块内存空间用于存放对象【放到操作数栈中】</span><br>        <span class="hljs-number">3</span>: dup						复制操作数栈中的引用，放到栈顶中<br>        <span class="hljs-number">4</span>: invokespecial #1 <span class="hljs-comment">// invokespecial &lt;init&gt;:()V	通过栈顶的对象引用调用构造器 用完弹栈</span><br>        <span class="hljs-number">7</span>: astore_1 <span class="hljs-comment">// lock引用 -&gt; lock					将目前栈顶的对象引用放到1号槽位</span><br>        <span class="hljs-number">8</span>: aload_1 <span class="hljs-comment">// &lt;- lock （synchronized开始）         从一号槽位中，取出lock对象</span><br>        <span class="hljs-number">9</span>: dup											 将lock对象赋值一份放到栈顶<br>        <span class="hljs-number">10</span>: astore_2 <span class="hljs-comment">// lock引用 -&gt; slot 2				将栈顶中的对象放到2号槽位</span><br>        <span class="hljs-number">11</span>: monitorenter <span class="hljs-comment">// monitorenter(lock引用)		将目前栈顶的对象加锁</span><br>        <span class="hljs-number">12</span>: getstatic #3 <span class="hljs-comment">// &lt;- System.out				 加载静态变量到操作数栈中</span><br>        <span class="hljs-number">15</span>: ldc #4 <span class="hljs-comment">// &lt;- &quot;ok&quot;							 加载字符串常量到操作数栈中</span><br>        <span class="hljs-number">17</span>: invokevirtual #5 <span class="hljs-comment">// invokevirtual println:  调用静态对象的println方法</span><br>        (Ljava/lang/<span class="hljs-built_in">String</span>;)V<br>        <span class="hljs-number">20</span>: aload_2 <span class="hljs-comment">// &lt;- slot 2(lock引用)				将2号槽位的lock对象，加载到栈中</span><br>        <span class="hljs-number">21</span>: monitorexit <span class="hljs-comment">// monitorexit(lock引用)			根据对象解锁</span><br>        <span class="hljs-number">22</span>: goto <span class="hljs-number">30</span>										准备结束<br>        <span class="hljs-number">25</span>: astore_3 <span class="hljs-comment">// any -&gt; slot 3                   将异常对象放到三号槽位中</span><br>        <span class="hljs-number">26</span>: aload_2 <span class="hljs-comment">// &lt;- slot 2(lock引用)				加载lock对象的引用到二号槽位</span><br>        <span class="hljs-number">27</span>: monitorexit <span class="hljs-comment">// monitorexit(lock引用)			解锁</span><br>        <span class="hljs-number">28</span>: aload_3										 加载异常对象到操作数栈中<br>        <span class="hljs-number">29</span>: athrow										外抛异常<br>        <span class="hljs-number">30</span>: <span class="hljs-keyword">return</span>										结束<br>Exception table:<br>        from    <span class="hljs-keyword">to</span>    target    <span class="hljs-keyword">type</span><br>        <span class="hljs-number">12</span>      <span class="hljs-number">22</span>       <span class="hljs-number">25</span>     any<br>        <span class="hljs-number">25</span>      <span class="hljs-number">28</span>       <span class="hljs-number">25</span>     any<br>LineNumberTable: <span class="hljs-params">...</span><br>LocalVariableTable:<br>        Start Length Slot  Name    Signature<br>        <span class="hljs-number">0</span>       <span class="hljs-number">31</span>     <span class="hljs-number">0</span>   args    <span class="hljs-meta">[</span>Ljava/lang/<span class="hljs-built_in">String</span>;<br>        <span class="hljs-number">8</span>       <span class="hljs-number">23</span>     <span class="hljs-number">1</span>   lock    Ljava/lang/Object;<br>StackMapTable: <span class="hljs-params">...</span><br>MethodParameters: <span class="hljs-params">...</span><br></code></pre></td></tr></table></figure>

<p>注意：</p>
<p>方法级别的 <code>synchronized </code>不会在字节码指令中有所体现</p>
<h2 id="3-编译期处理"><a href="#3-编译期处理" class="headerlink" title="3. 编译期处理"></a>3. 编译期处理</h2><p>所谓的 语法糖 ，其实就是指 java 编译器把 *.java 源码编译为 *.class 字节码的过程中，自动生成 和转换的一些代码</p>
<p>主要是为了减轻程序员的负担，算是 java 编译器给我们的一个额外福利（给糖吃 嘛） </p>
<p>注意，以下代码的分析，借助了 javap 工具，idea 的反编译功能，idea 插件 jclasslib 等工具</p>
<p>另外， <strong>编译器转换的结果直接</strong>就是 <strong>class 字节码</strong>，只是为了便于阅读，给出了 <strong>几乎等价 的 java 源码方式</strong>，并 <strong>不是编译器还会转换出中间的 java 源码</strong>，<strong>切记</strong>。</p>
<h3 id="3-1-默认构造器"><a href="#3-1-默认构造器" class="headerlink" title="3.1 默认构造器"></a>3.1 默认构造器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Candy1</span> &#123;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>编译成class后的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Candy1</span> &#123;<br>    <span class="hljs-comment">// 这个无参构造是编译器帮助我们加上的</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Candy1</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>(); <span class="hljs-comment">// 即调用父类 Object 的无参构造方法，即调用 java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="3-2-自动拆装箱"><a href="#3-2-自动拆装箱" class="headerlink" title="3.2 自动拆装箱"></a>3.2 自动拆装箱</h3><p>这个特性是 JDK 5 开始加入的， 代码片段1 ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Candy2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;  <br>        <span class="hljs-type">int</span> <span class="hljs-variable">y</span> <span class="hljs-operator">=</span> x;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这段代码在 JDK 5 之前是无法编译通过的，必须改写为 代码片段2 :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Candy2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> Integer.valueOf(<span class="hljs-number">1</span>);  <span class="hljs-comment">//在-128~127之间会直接有一个Integer对象，超过这个范围就会new Integer对象【装箱】</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">y</span> <span class="hljs-operator">=</span> x.intValue();   <span class="hljs-comment">//拆箱	</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>显然之前版本的代码太麻烦了，需要在基本类型和包装类型之间来回转换（尤其是集合类中操作的都是 包装类型）</p>
<p>因此这些转换的事情在 <strong>JDK 5 以后</strong>都由 编译器 在 <strong>编译阶段完成</strong></p>
<p>即 代码片段1 都会在**编 译阶段 **被 转换为 代码片段2;</p>
<h3 id="3-3-泛型集合取值"><a href="#3-3-泛型集合取值" class="headerlink" title="3.3 泛型集合取值"></a>3.3 泛型集合取值</h3><p>泛型也是在<code>JDK 5</code>开始加入的特性，但 java 在编译泛型代码后会执行 <code>泛型擦除 </code>的动作，即<code>泛型信息 在编译为字节码之后</code>就 <strong>丢失了</strong></p>
<p>实际的类型都当做了 Object 类型来处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Candy3</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        List&lt;Integer&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        list.add(<span class="hljs-number">10</span>); <span class="hljs-comment">// 实际调用的是 List.add(Object e)</span><br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> list.get(<span class="hljs-number">0</span>); <span class="hljs-comment">// 实际调用的是 Object obj = List.get(int index);</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>所以在取值时，编译器真正生成的字节码中，还要额外做一个类型转换的操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 需要将 Object 转为 Integer</span><br><span class="hljs-type">Integer</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> (Integer)list.get(<span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure>



<p>如果前面的 x 变量类型修改为 int 基本类型那么最终生成的字节码是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 需要将 Object 转为 Integer, 并执行拆箱操作</span><br><span class="hljs-type">int</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> ((Integer)list.get(<span class="hljs-number">0</span>)).intValue();<br></code></pre></td></tr></table></figure>

<p>还好这些麻烦事都不用自己做。</p>
<p>擦除的是字节码上的泛型信息，可以看到 LocalVariableTypeTable 仍然保留了方法参数泛型的信息</p>
<p>字节码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> cn.itcast.jvm.t3.candy.Candy3();<br>descriptor: ()V<br>flags: ACC_PUBLIC<br>    Code:<br>    stack=<span class="hljs-number">1</span>, locals=<span class="hljs-number">1</span>, args_size=<span class="hljs-number">1</span><br>        <span class="hljs-number">0</span>: aload_0<br>        <span class="hljs-number">1</span>: invokespecial #<span class="hljs-number">1</span> <span class="hljs-comment">// Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br>        <span class="hljs-number">4</span>: <span class="hljs-keyword">return</span><br>LineNumberTable:<br>line <span class="hljs-number">6</span>: <span class="hljs-number">0</span><br>LocalVariableTable:<br>        Start Length Slot Name    Signature<br>        <span class="hljs-number">0</span>        <span class="hljs-number">5</span>    <span class="hljs-number">0</span>    <span class="hljs-built_in">this</span>     Lcn/itcast/jvm/t3/candy/Candy3;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(java.lang.String[])</span>;<br>descriptor: ([Ljava/lang/String;)V<br>flags: ACC_PUBLIC, ACC_STATIC<br>    Code:<br>    stack=<span class="hljs-number">2</span>, locals=<span class="hljs-number">3</span>, args_size=<span class="hljs-number">1</span><br>        <span class="hljs-number">0</span>: <span class="hljs-keyword">new</span> #<span class="hljs-number">2</span> <span class="hljs-comment">// class java/util/ArrayList    创建空间 将对象引用放到栈中</span><br>        <span class="hljs-number">3</span>: dup									   <span class="hljs-comment">//复制引用 放到栈顶</span><br>        <span class="hljs-number">4</span>: invokespecial #<span class="hljs-number">3</span> <span class="hljs-comment">// Method java/util/ArrayList.&quot; &lt;init&gt;&quot;:()V  调用ArrayList的构造方法</span><br>        <span class="hljs-number">7</span>: astore_1       <span class="hljs-comment">// 将对象引用放到栈中</span><br>        <span class="hljs-number">8</span>: aload_1			<span class="hljs-comment">//将对象放到一号槽位中</span><br>        <span class="hljs-number">9</span>: bipush <span class="hljs-number">10</span>			<span class="hljs-comment">//将10放到栈中</span><br>        <span class="hljs-number">11</span>: invokestatic #<span class="hljs-number">4</span> <span class="hljs-comment">// Method java/lang/Integer.valueOf:(I)Ljava/lang/Integer;  调用静态方法，转为包装Integer</span><br>        <span class="hljs-number">14</span>: invokeinterface #<span class="hljs-number">5</span>, <span class="hljs-number">2</span> <span class="hljs-comment">// InterfaceMethod java/util/List.add:(Ljava/lang/Object;)Z  调用接口方法 返回布尔</span><br>        <span class="hljs-comment">//上面一行是泛型擦除原理，调用的方法不区分类型      </span><br>        <span class="hljs-number">19</span>: pop<br>              <br>        <span class="hljs-number">20</span>: aload_1   <span class="hljs-comment">//从槽位一中获取list引用 到栈中</span><br>        <span class="hljs-number">21</span>: iconst_0   <span class="hljs-comment">//将0放到栈中</span><br>        <span class="hljs-number">22</span>: invokeinterface #<span class="hljs-number">6</span>, <span class="hljs-number">2</span> <span class="hljs-comment">// InterfaceMethod java/util/List.get:(I)Ljava/lang/Object; 调用接口方法，返回值类型Object</span><br>          <span class="hljs-comment">//泛型擦除本质，返回的对象是Object类型    </span><br>        <span class="hljs-number">27</span>: checkcast #<span class="hljs-number">7</span> <span class="hljs-comment">// class java/lang/Integer   强制类型转换为Integer</span><br>        <span class="hljs-number">30</span>: astore_2		<span class="hljs-comment">//转换后的对象，放到2号槽位</span><br>        <span class="hljs-number">31</span>: <span class="hljs-keyword">return</span>   		<span class="hljs-comment">//结束方法</span><br>LineNumberTable:<br>        line <span class="hljs-number">8</span>: <span class="hljs-number">0</span><br>        line <span class="hljs-number">9</span>: <span class="hljs-number">8</span><br>        line <span class="hljs-number">10</span>: <span class="hljs-number">20</span><br>        line <span class="hljs-number">11</span>: <span class="hljs-number">31</span><br>LocalVariableTable: 【局部变量表】<br>        Start    Length   Slot    Name    Signature<br>        <span class="hljs-number">0</span>          <span class="hljs-number">32</span>      <span class="hljs-number">0</span>      args      [Ljava/lang/String;<br>        <span class="hljs-number">8</span>          <span class="hljs-number">24</span>      <span class="hljs-number">1</span>      list       Ljava/util/List;<br>LocalVariableTypeTable: 【局部变量类型表】记录泛型信息<br>        Start    Length     Slot      Name     Signature<br>        <span class="hljs-number">8</span>          <span class="hljs-number">24</span>         <span class="hljs-number">1</span>       list      Ljava/util/List&lt;Ljava/lang/Integer;&gt;;<br></code></pre></td></tr></table></figure>





<p>使用反射，仍然能够获得这些信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Set&lt;Integer&gt; <span class="hljs-title function_">test</span><span class="hljs-params">(List&lt;String&gt; list, Map&lt;Integer, Object&gt; map)</span> &#123;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>注意：有局限性&#x3D;&#x3D;&#x3D;》只能获取方法入参和返回值的泛型类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Method</span> <span class="hljs-variable">test</span> <span class="hljs-operator">=</span> Candy3.class.getMethod(<span class="hljs-string">&quot;test&quot;</span>, List.class, Map.class);<br>Type[] types = test.getGenericParameterTypes();<br><br><span class="hljs-keyword">for</span> (Type type : types) &#123;<br>    <span class="hljs-keyword">if</span> (type <span class="hljs-keyword">instanceof</span> ParameterizedType) &#123;<br>        <span class="hljs-type">ParameterizedType</span> <span class="hljs-variable">parameterizedType</span> <span class="hljs-operator">=</span> (ParameterizedType) type;<br>        System.out.println(<span class="hljs-string">&quot;原始类型 - &quot;</span> + parameterizedType.getRawType());<br>        Type[] arguments = parameterizedType.getActualTypeArguments();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; arguments.length; i++) &#123;<br>            System.out.printf(<span class="hljs-string">&quot;泛型参数[%d] - %s\n&quot;</span>, i, arguments[i]);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus">原始类型 - interface java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.List</span><br>泛型参数<span class="hljs-selector-attr">[0]</span> - class java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.String</span><br>原始类型 - interface java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.Map</span><br>泛型参数<span class="hljs-selector-attr">[0]</span> - class java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.Integer</span><br>泛型参数<span class="hljs-selector-attr">[1]</span> - class java<span class="hljs-selector-class">.lang</span>.Object<br></code></pre></td></tr></table></figure>



<h3 id="3-4-可变参数"><a href="#3-4-可变参数" class="headerlink" title="3.4 可变参数"></a>3.4 可变参数</h3><p>可变参数也是 JDK 5 开始加入的新特性： </p>
<p>例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Candy4</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">foo</span><span class="hljs-params">(String... args)</span> &#123;<br>        String[] array = args; <span class="hljs-comment">// 直接赋值</span><br>        System.out.println(array);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        foo(<span class="hljs-string">&quot;hello&quot;</span>, <span class="hljs-string">&quot;world&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可变参数 String… args 其实是一个 String[] args ，从代码中的赋值语句中就可以看出来</p>
<p>同样 java 编译器会在编译期间将上述代码变换为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Candy4</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">foo</span><span class="hljs-params">(String[] args)</span> &#123;<br>        String[] array = args; <span class="hljs-comment">// 直接赋值</span><br>        System.out.println(array);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        foo(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;hello&quot;</span>, <span class="hljs-string">&quot;world&quot;</span>&#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>注意 如果调用了 <strong>foo()</strong> 则等价代码为 <strong>foo(new String[]{})</strong> ，创建了一个  <strong>空的数组</strong>  ，而  <strong>不会传递 null</strong> 进去</p>
<h3 id="3-5-foreach-循环"><a href="#3-5-foreach-循环" class="headerlink" title="3.5 foreach 循环"></a>3.5 foreach 循环</h3><p>仍是 JDK 5 开始引入的语法糖，数组的循环：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Candy5_1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">int</span>[] array = &#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>&#125;; <span class="hljs-comment">// 数组赋初值的简化写法也是语法糖哦</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> e : array) &#123;<br>            System.out.println(e);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>会被编译器转换为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Candy5_1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Candy5_1</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">int</span>[] array = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>&#125;;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; array.length; ++i) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> array[i];<br>            System.out.println(e);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>







<p>而集合的循环：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Candy5_2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        List&lt;Integer&gt; list = Arrays.asList(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>);<br>        <span class="hljs-keyword">for</span> (Integer i : list) &#123;<br>            System.out.println(i);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>实际被编译器转换为对迭代器的调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Candy5_2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Candy5_2</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        List&lt;Integer&gt; list = Arrays.asList(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>);<br>        <span class="hljs-type">Iterator</span> <span class="hljs-variable">iter</span> <span class="hljs-operator">=</span> list.iterator();<br>        <span class="hljs-keyword">while</span>(iter.hasNext()) &#123;<br>            <span class="hljs-type">Integer</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> (Integer)iter.next();<br>            System.out.println(e);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>注意 foreach 循环写法，能够配合数组，以及所有实现了 Iterable 接口的集合类一起使用，其中 Iterable 用来获取集合的迭代器（ Iterator ）</p>
<h3 id="3-6-switch-字符串"><a href="#3-6-switch-字符串" class="headerlink" title="3.6 switch 字符串"></a>3.6 switch 字符串</h3><p><code>从 JDK 7 开始</code>，switch 可以作用于<strong>字符串和枚举类</strong></p>
<p>这个功能其实也是语法糖【因为原生的字节码指令是不支持switch中使用字符串和枚举类】是通过一些转换实现的</p>
<p>例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Candy6_1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">choose</span><span class="hljs-params">(String str)</span> &#123;<br>        <span class="hljs-keyword">switch</span> (str) &#123;<br>             <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;hello&quot;</span>: &#123;<br>                System.out.println(<span class="hljs-string">&quot;h&quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;world&quot;</span>: &#123;<br>                System.out.println(<span class="hljs-string">&quot;w&quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>注意 switch 配合 String 和枚举使用时，变量不能为null，原因分析完语法糖转换后的代码应当自然清 楚</p>
<p>会被编译器转换为：【拆成两个switch】</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Candy6_1</span> &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">Candy6_1</span><span class="hljs-params">()</span> &#123;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">choose</span><span class="hljs-params">(String str)</span> &#123;<br>            <span class="hljs-type">byte</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">switch</span> (str.hashCode()) &#123;<br>                <span class="hljs-keyword">case</span> <span class="hljs-number">99162322</span>: <span class="hljs-comment">// hello 的 hashCode</span><br>                    <span class="hljs-keyword">if</span> (str.equals(<span class="hljs-string">&quot;hello&quot;</span>)) &#123;<br>                        x = <span class="hljs-number">0</span>;<br>                    &#125;<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> <span class="hljs-number">113318802</span>: <span class="hljs-comment">// world 的 hashCode</span><br>                    <span class="hljs-keyword">if</span> (str.equals(<span class="hljs-string">&quot;world&quot;</span>)) &#123;<br>                        x = <span class="hljs-number">1</span>;<br>                    &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">switch</span> (x) &#123;<br>                <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>                    System.out.println(<span class="hljs-string">&quot;h&quot;</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>                    System.out.println(<span class="hljs-string">&quot;w&quot;</span>);<br>            &#125;<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到，执行了两遍 switch，第一遍是根据字符串的 hashCode 和 equals 将字符串的转换为相应 byte 类型，第二遍才是利用 byte 执行进行比较</p>
<p>为什么第一遍时必须既比较 hashCode，又利用 equals 比较呢？</p>
<p>hashCode 是为了提高效率，减少可 能的比较；</p>
<p>而 equals 是为了防止 hashCode 冲突，</p>
<p>String重写Object类的hashCode方法 源码如下：【内容相同，hashcode必相同】</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> &#123;<br>   <span class="hljs-type">int</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> hash;<br>   <span class="hljs-comment">//首先判断本对象是否已经计算过hash值并且字符串的长度大于0</span><br>    <span class="hljs-comment">//还没</span><br>   <span class="hljs-keyword">if</span> (h == <span class="hljs-number">0</span> &amp;&amp; value.length &gt; <span class="hljs-number">0</span>) &#123;<br>     <span class="hljs-type">char</span> val[] = value;<br>     <span class="hljs-comment">//循环字符串中的字符，用以计算hash值</span><br>     <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; value.length; i++) &#123;<br>       h = <span class="hljs-number">31</span> * h + val[i];<br>     &#125;<br>     hash = h;<br>   &#125;<br>   <span class="hljs-keyword">return</span> h;<br> &#125;<br></code></pre></td></tr></table></figure>



<p>String重写Object类的equal方法 源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">equals</span><span class="hljs-params">(Object anObject)</span> &#123;<br>    <span class="hljs-comment">//判断两个对象的引用地址是否一致</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span> == anObject) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>    <span class="hljs-comment">//判断传入的对象是否是String类型</span><br>    <span class="hljs-keyword">if</span> (anObject <span class="hljs-keyword">instanceof</span> String) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">anotherString</span> <span class="hljs-operator">=</span> (String)anObject;<br>      <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> value.length;<br>      <span class="hljs-comment">//判断两个字符串是否长度相等</span><br>      <span class="hljs-keyword">if</span> (n == anotherString.value.length) &#123;<br>        <span class="hljs-type">char</span> v1[] = value;<br>        <span class="hljs-type">char</span> v2[] = anotherString.value;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-comment">//逐个比较两个字符串中的字符</span><br>        <span class="hljs-keyword">while</span> (n-- != <span class="hljs-number">0</span>) &#123;<br>          <span class="hljs-keyword">if</span> (v1[i] != v2[i])<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>          i++;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br></code></pre></td></tr></table></figure>



<p><strong>hashCode()的返回值大多数情况是将对象的内部地址转换成整数并返回，少数情况不是这样，也就代表着HashCode不是内存地址</strong></p>
<p>例如 BM 和 C. 这两个字符串的hashCode值都是 2123 ，如果有如下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Candy6_2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">choose</span><span class="hljs-params">(String str)</span> &#123;<br>        <span class="hljs-keyword">switch</span> (str) &#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;BM&quot;</span>: &#123;<br>                System.out.println(<span class="hljs-string">&quot;h&quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;C.&quot;</span>: &#123;<br>                System.out.println(<span class="hljs-string">&quot;w&quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>会被编译器转换为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Candy6_2</span> &#123;<br><span class="hljs-keyword">public</span> <span class="hljs-title function_">Candy6_2</span><span class="hljs-params">()</span> &#123;<br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">choose</span><span class="hljs-params">(String str)</span> &#123;<br>    <span class="hljs-type">byte</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">switch</span>(str.hashCode()) &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">2123</span>: <span class="hljs-comment">// hashCode 值可能相同，需要进一步用 equals 比较</span><br>            <span class="hljs-keyword">if</span> (str.equals(<span class="hljs-string">&quot;C.&quot;</span>)) &#123;<br>                x = <span class="hljs-number">1</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (str.equals(<span class="hljs-string">&quot;BM&quot;</span>)) &#123;<br>                x = <span class="hljs-number">0</span>;<br>            &#125;<br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-keyword">switch</span>(x) &#123;<br>                <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>                    System.out.println(<span class="hljs-string">&quot;h&quot;</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>                    System.out.println(<span class="hljs-string">&quot;w&quot;</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<h3 id="3-7-switch-枚举"><a href="#3-7-switch-枚举" class="headerlink" title="3.7 switch 枚举"></a>3.7 switch 枚举</h3><p> switch 枚举的例子，原始代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Sex</span> &#123;<br>    MALE, FEMALE<br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Candy7</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">foo</span><span class="hljs-params">(Sex sex)</span> &#123;<br>        <span class="hljs-keyword">switch</span> (sex) &#123;<br>        <span class="hljs-keyword">case</span> MALE:<br>            System.out.println(<span class="hljs-string">&quot;男&quot;</span>); <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> FEMALE:<br>            System.out.println(<span class="hljs-string">&quot;女&quot;</span>); <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<p>转换后代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Candy7</span> &#123;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 定义一个合成类（仅 jvm 使用，对我们不可见）</span><br><span class="hljs-comment">* 用来映射枚举的 ordinal 与数组元素的关系</span><br><span class="hljs-comment">* 枚举的 ordinal 表示枚举对象的序号，从 0 开始</span><br><span class="hljs-comment">* 即 MALE 的 ordinal()=0，FEMALE 的 ordinal()=1</span><br><span class="hljs-comment">*/</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">$MAP</span> &#123;<br>    <span class="hljs-comment">// 数组大小即为枚举元素个数，里面存储case用来对比的数字</span><br>        <span class="hljs-keyword">static</span> <span class="hljs-type">int</span>[] map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">2</span>];<br>        <span class="hljs-keyword">static</span> &#123;<br>            map[Sex.MALE.ordinal()] = <span class="hljs-number">1</span>;<span class="hljs-comment">//数组第一个元素，值为1</span><br>            map[Sex.FEMALE.ordinal()] = <span class="hljs-number">2</span>;<span class="hljs-comment">//数组第二个元素，值为2</span><br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">foo</span><span class="hljs-params">(Sex sex)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> $MAP.map[sex.ordinal()];<br>        <span class="hljs-keyword">switch</span> (x) &#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>                System.out.println(<span class="hljs-string">&quot;男&quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>                System.out.println(<span class="hljs-string">&quot;女&quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="3-8-枚举类"><a href="#3-8-枚举类" class="headerlink" title="3.8 枚举类"></a>3.8 枚举类</h3><p>JDK 7 新增了枚举类，以前面的性别枚举为例：【枚举类 也称为多例，可以用于实现单例】</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Sex</span> &#123;<br>    MALE , FEMALE<br>&#125;<br></code></pre></td></tr></table></figure>



<p>转换后代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sex</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Enum</span>&lt;Sex&gt; &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Sex MALE;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Sex FEMALE;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Sex[] $VALUES;<br>    <br>    <span class="hljs-keyword">static</span> &#123;<br>        MALE = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sex</span>(<span class="hljs-string">&quot;MALE&quot;</span>, <span class="hljs-number">0</span>);<br>        FEMALE = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sex</span>(<span class="hljs-string">&quot;FEMALE&quot;</span>, <span class="hljs-number">1</span>);<br>        $VALUES = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sex</span>[]&#123;MALE, FEMALE&#125;;<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * Sole constructor. Programmers cannot invoke this constructor.</span><br><span class="hljs-comment">    * It is for use by code emitted by the compiler in response to</span><br><span class="hljs-comment">    * enum type declarations.</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> name - The name of this enum constant, which is the identifier</span><br><span class="hljs-comment">    * used to declare it.</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> ordinal - The ordinal of this enumeration constant (its position</span><br><span class="hljs-comment">    * in the enum declaration, where the initial constant is</span><br><span class="hljs-comment">    	assigned</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-comment">//调用枚举类的父类构造，入参两个名称和标识号</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Sex</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> ordinal)</span> &#123;<br>        <span class="hljs-built_in">super</span>(name, ordinal);<br>    &#125;<br>    <br>    <span class="hljs-comment">//返回一个克隆的数组，里面放着Sex的两个实例</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Sex[] values() &#123;<br>        <span class="hljs-keyword">return</span> $VALUES.clone();<br>    &#125;<br>    <br>    <span class="hljs-comment">//类似于Map集合，通过key 找value</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Sex <span class="hljs-title function_">valueOf</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-keyword">return</span> Enum.valueOf(Sex.class, name);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<h3 id="3-9-try-with-resources"><a href="#3-9-try-with-resources" class="headerlink" title="3.9 try-with-resources"></a>3.9 try-with-resources</h3><p>​	JDK 7 开始新增了对需要关闭的资源处理的特殊语法<code> try-with-resources</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span>(资源变量 = 创建资源对象)&#123;<br><br>&#125; <span class="hljs-keyword">catch</span>( ) &#123;<br>    <br>&#125;<br></code></pre></td></tr></table></figure>

<p>其中资源对象需要实现 AutoCloseable 接口，</p>
<p>例如 <code>InputStream </code>、 <code>OutputStream </code>、 <code>Connection </code>、 <code>Statement </code>、 <code>ResultSet </code>等接口都实现了 **<code>AutoCloseable </code>**，</p>
<p>使用 try-withresources 可以不用写 finally 语句块，编译器会帮助生成关闭资源代码，</p>
<p>例如：</p>
<p>源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Candy9</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">try</span>(<span class="hljs-type">InputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;d:\\1.txt&quot;</span>)) &#123;<br>            System.out.println(is);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>会被转换为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Candy9</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Candy9</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">InputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;d:\\1.txt&quot;</span>);<br>            <span class="hljs-type">Throwable</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">try</span> &#123;<br>                System.out.println(is);<br>            &#125; <span class="hljs-keyword">catch</span> (Throwable e1) &#123;<br>                <span class="hljs-comment">// t 是我们代码出现的异常</span><br>                t = e1;<br>                <span class="hljs-keyword">throw</span> e1;<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                <span class="hljs-comment">// 判断了资源不为空</span><br>                <span class="hljs-keyword">if</span> (is != <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-comment">// 如果我们代码有异常</span><br>                    <span class="hljs-keyword">if</span> (t != <span class="hljs-literal">null</span>) &#123;<br>                        <span class="hljs-keyword">try</span> &#123;<br>                            is.close();<br>                        &#125; <span class="hljs-keyword">catch</span> (Throwable e2) &#123;<br>                            <span class="hljs-comment">// 如果 close 出现异常，</span><br>                            <span class="hljs-comment">//try代码中有问题，关闭资源时也出现问题 此时关闭异常作为被压制异常添加</span><br>                            <span class="hljs-comment">//【也就是说此处会有两个异常被抛出】</span><br>                            t.addSuppressed(e2);<br>                        &#125;<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-comment">// 我们try块中没有异常</span><br>                        <span class="hljs-comment">//如果出现异常 就是关闭资源时出异常</span><br>                        is.close();<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>为什么要设计一个<code>addSuppressed(Throwable e)</code>（添加被压制异常）的方法呢？</p>
<p>是为了防止异常信 息的丢失</p>
<p> try-with-resources 生成的 fianlly 中如果抛出了异常：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test6</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">MyResource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyResource</span>()) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>/<span class="hljs-number">0</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyResource</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AutoCloseable</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(<span class="hljs-string">&quot;close 异常&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus">java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.ArithmeticException</span>: / by zero<br>    at test<span class="hljs-selector-class">.Test6</span><span class="hljs-selector-class">.main</span>(Test6<span class="hljs-selector-class">.java</span>:<span class="hljs-number">7</span>)<br>    Suppressed: java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.Exception</span>: close 异常<br>        at test<span class="hljs-selector-class">.MyResource</span><span class="hljs-selector-class">.close</span>(Test6<span class="hljs-selector-class">.java</span>:<span class="hljs-number">18</span>)<br>        at test<span class="hljs-selector-class">.Test6</span><span class="hljs-selector-class">.main</span>(Test6<span class="hljs-selector-class">.java</span>:<span class="hljs-number">6</span>)<br></code></pre></td></tr></table></figure>

<p>如以上代码所示，两个异常信息都不会丢</p>
<h3 id="3-10-方法重写时的桥接方法"><a href="#3-10-方法重写时的桥接方法" class="headerlink" title="3.10 方法重写时的桥接方法"></a>3.10 方法重写时的桥接方法</h3><p>我们都知道，方法重写时对返回值分两种情况： </p>
<p>父子类的返回值完全一致 </p>
<p>子类返回值可以是父类返回值的子类（比较绕口，见下面的例子）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> &#123;<br>    <span class="hljs-keyword">public</span> Number <span class="hljs-title function_">m</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br>&#125;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">A</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-comment">// 子类 m 方法的返回值是 Integer 是父类 m 方法返回值 Number 的子类</span><br>    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">m</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>注意：</p>
<p>Number 是一个抽象类，也是一个超类（即父类）</p>
<p>Number 类属于 java.lang 包，所有的包装类（如 <code>Double、Float、Byte、Short、Integer 以及 Long</code>）都是抽象类 Number 的子类</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220813002021693.png" srcset="/img/loading.gif" lazyload alt="image-20220813002021693"></p>
<hr>
<p>对于子类，java 编译器会做如下处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">A</span> &#123;<br>    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">m</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;<br>    &#125;<br>    <span class="hljs-comment">// 此方法才是真正重写了父类 public Number m() 方法</span><br>    <span class="hljs-keyword">public</span> synthetic bridge Number <span class="hljs-title function_">m</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 调用 public Integer m()</span><br>        <span class="hljs-keyword">return</span> m();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>其中桥接方法比较特殊，仅对 java 虚拟机可见，并且与原来的 public Integer m() 没有命名冲突，可以 用下面<strong>反射代码</strong>来验证：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">for</span> (Method m : B.class.getDeclaredMethods()) &#123;<br>    System.out.println(m);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>会输出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> java.lang.Integer test.candy.B.m()<br><span class="hljs-keyword">public</span> java.lang.Number test.candy.B.m()<br></code></pre></td></tr></table></figure>



<h3 id="3-11-匿名内部类"><a href="#3-11-匿名内部类" class="headerlink" title="3.11 匿名内部类"></a>3.11 匿名内部类</h3><p>源代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Candy11</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>            <span class="hljs-type">Runnable</span> <span class="hljs-variable">runnable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                System.out.println(<span class="hljs-string">&quot;ok&quot;</span>);<br>            &#125;<br>        &#125;;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>转换后代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 额外生成的类</span><br><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Candy11$1</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> &#123;<br>    Candy11$<span class="hljs-number">1</span>() &#123;<br>        <br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>    System.out.println(<span class="hljs-string">&quot;ok&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Candy11</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Runnable</span> <span class="hljs-variable">runnable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Candy11$1</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<p><strong>引用局部变量</strong>的匿名内部类，源代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Candy11</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-type">int</span> x)</span> &#123;<br>        <span class="hljs-type">Runnable</span> <span class="hljs-variable">runnable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>            System.out.println(<span class="hljs-string">&quot;ok:&quot;</span> + x);<br>            &#125;<br>        &#125;;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>转换后代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 额外生成的类</span><br><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Candy11$1</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> &#123;<br>    <span class="hljs-type">int</span> val$x;<span class="hljs-comment">//成员变量</span><br>    Candy11$<span class="hljs-number">1</span>(<span class="hljs-type">int</span> x) &#123;<br>        <span class="hljs-built_in">this</span>.val$x = x;<span class="hljs-comment">//构造赋初值【只执行一次，所以要求变量是用final修饰的】</span><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;ok:&quot;</span> + <span class="hljs-built_in">this</span>.val$x);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Candy11</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-type">int</span> x)</span> &#123;<br>        <span class="hljs-type">Runnable</span> <span class="hljs-variable">runnable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Candy11$1</span>(x);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>注意 </p>
<p>这同时解释了为什么匿名内部类引用局部变量时，局部变量必须是 final 的：</p>
<p>因为在创建 <code>Candy11$1 </code>对象时，将 x 的值赋值给了<code> Candy11$1</code> 对象的&#96;&#96;，所以 x 不应该再发生变 化了，如果变化，那么 val$x 属性没有机会再跟着一起变化</p>
<h2 id="4-类加载阶段"><a href="#4-类加载阶段" class="headerlink" title="4. 类加载阶段"></a>4. 类加载阶段</h2><h3 id="4-1-加载"><a href="#4-1-加载" class="headerlink" title="4.1 加载"></a>4.1 加载</h3><p>将类的字节码载入方法区中，内部采用 C++ 的 <code>instanceKlass </code> 【C++的一种数据结构】描述 java 类，它的重要 field 有： </p>
<p><code>_java_mirror </code>即 java 的类镜像，例如对 String 来说，就是 String.class，作用是把 klass 暴 露给 java 使用 【java对象不能直接访问klass的信息，需要通过这个						<code>_java_mirrot</code>类对象 间接访问  这个_java_mirror 相当于C++数据结构与java对象的桥梁】</p>
<p><code>_super</code> 即父类 _fields 即成员变量</p>
<p> <code>_methods </code>即方法 </p>
<p><code>_constants </code>即常量池</p>
<p> <code>_class_loader </code>即类加载器 【加载这个类的类加载器】</p>
<p><code>_vtable </code>虚方法表 【实现多态的本质】</p>
<p><code>_itable </code>接口方法表 </p>
<p>如果这个类还有父类没有加载，先加载父类 </p>
<p>加载  和  链接  <strong>可能是交替运行</strong>的 </p>
<p>注意 </p>
<p>instanceKlass 这样的<strong>【元数据】</strong>是<strong>存储在方法区</strong>（1.8 后的实现叫元空间内），但<code> _java_mirror</code> 是存储在堆中 </p>
<p>可以通过前面介绍的 HSDB 工具查看</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220813205905808.png" srcset="/img/loading.gif" lazyload alt="image-20220813205905808"></p>
<hr>
<p>通过类加载器将字节码加载进方法区中（jdk1.8叫元空间），对应instanceKlass的数据结构中的数据</p>
<p>同时，会在堆内存中，生成一个<code>_java_mirror</code>镜像 (类对象)，类对象持有instanceKlass的地址引用，数据结构 <code>instanceKlass</code>中的</p>
<p><code>_java_mirror</code>属性会持有与之相对应的类对象的地址引用</p>
<p>此处，静态变量紧跟类对象地址的后边【在jdk1.6及以前，静态变量跟在instanceKlass地址后面 也就是方法区中】</p>
<p>每个对象都有自己的对象头：16个字节；其中8字节对应该对象的类对象地址引用</p>
<p>如果想用通过一个对象获取它的class信息，就需要找到对象头，通过对象头中<strong>8个字节的类对象地址</strong>，找到该对象的类对象；再通过类对象获取</p>
<p><strong>instanceKlass</strong>数据结构的内存地址（在方法区中），<strong>instanceKlass</strong>中有该类的所有信息</p>
<p>可以通过反射getMethods、getField、getConstructor</p>
<p>从<strong>instanceKlass</strong>获取信息</p>
<h3 id="4-2-链接"><a href="#4-2-链接" class="headerlink" title="4.2 链接"></a>4.2 链接</h3><ul>
<li><strong>验证</strong></li>
</ul>
<p>​		验证类（字节码）是否符合 <strong>JVM规范</strong>，安全性检查</p>
<p>HelloWorld源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t5;<br><br><span class="hljs-comment">// 二进制字节码（类基本信息，常量池，类方法定义，包含了虚拟机指令）</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloWorld</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;hello world&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p> 用 <code>UltraEdit</code> 等支持二进制的编辑器修改 <code>HelloWorld.class</code> 的魔数</p>
<p>本来是<code>CAFEBABE</code> 详见类结构文件之魔数</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220814094821671.png" srcset="/img/loading.gif" lazyload alt="image-20220814094821671"></p>
<hr>
<p>在命令行运行：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java">D:\learn\黑马程序员\资料-解密JVM\代码\jvm\out\production\jvm\cn\itcast\jvm\t5&gt; java HelloWorld<br>Error: A JNI error has occurred, please check your installation and <span class="hljs-keyword">try</span> again<br>Exception in thread <span class="hljs-string">&quot;main&quot;</span> java.lang.ClassFormatError: Incompatible magic value <span class="hljs-number">3405691578</span> in <span class="hljs-keyword">class</span> <span class="hljs-title class_">file</span> HelloWorld<br>        at java.lang.ClassLoader.defineClass1(Native Method)<br>        at java.lang.ClassLoader.defineClass(Unknown Source)<br>        at java.security.SecureClassLoader.defineClass(Unknown Source)<br>        at java.net.URLClassLoader.defineClass(Unknown Source)<br>        at java.net.URLClassLoader.access$<span class="hljs-number">100</span>(Unknown Source)<br>        at java.net.URLClassLoader$<span class="hljs-number">1.</span>run(Unknown Source)<br>        at java.net.URLClassLoader$<span class="hljs-number">1.</span>run(Unknown Source)<br>        at java.security.AccessController.doPrivileged(Native Method)<br>        at java.net.URLClassLoader.findClass(Unknown Source)<br>        at java.lang.ClassLoader.loadClass(Unknown Source)<br>        at sun.misc.Launcher$AppClassLoader.loadClass(Unknown Source)<br>        at java.lang.ClassLoader.loadClass(Unknown Source)<br>        at sun.launcher.LauncherHelper.checkAndLoadMain(Unknown Source)<br></code></pre></td></tr></table></figure>



<p><strong>准备</strong></p>
<p>为 <strong>static 变量</strong>分配空间，设置默认值 【如果是int类型的，就分配4个字节的空间，默认值为0】</p>
<p>static 变量在 JDK 7 之前存储于 <code>instanceKlass 末尾</code>，从 JDK 7 开始，存储于<code>_java_mirror 末尾</code></p>
<p>static 变量  分配空间  和  赋值  是<strong>两个步骤</strong>，<strong>分配空间</strong> 在  <code>准备阶段完成</code>，<strong>赋值</strong> 在 <strong>初始化阶段完成</strong> </p>
<p>例子：</p>
<p>源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t3.load;<br><br><span class="hljs-comment">// 演示 final 对静态变量的影响</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Load8</span> &#123;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> a;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<span class="hljs-comment">//在初始化阶段赋值 cinit 静态代码块</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-number">20</span>;<span class="hljs-comment">//在编译阶段就可以确定 不是在初始化阶段赋值的</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">d</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hello&quot;</span>;<span class="hljs-comment">//在编译阶段就可以确定 不是在初始化阶段赋值的</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<span class="hljs-comment">//在初始化阶段赋值的</span><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs lasso">  Last modified <span class="hljs-number">2022</span><span class="hljs-number">-8</span><span class="hljs-number">-14</span>; size <span class="hljs-number">449</span> <span class="hljs-built_in">bytes</span><br>  MD5 checksum <span class="hljs-number">4</span>bb749e3f4b79189b537767004912b40<br>  Compiled from <span class="hljs-string">&quot;Load8.java&quot;</span><br><span class="hljs-keyword">public</span> class <span class="hljs-literal">cn</span>.itcast.jvm.t3.load.Load8<br>  minor version: <span class="hljs-number">0</span><br>  major version: <span class="hljs-number">52</span><br>  flags: ACC_PUBLIC, ACC_SUPER<br>Constant pool:<br>   #1 = Methodref          #3.#24         <span class="hljs-comment">// java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br>   #2 = Fieldref           #5.#25         <span class="hljs-comment">// cn/itcast/jvm/t3/load/Load8.b:I</span><br>   #3 = Class              #26            <span class="hljs-comment">// java/lang/Object</span><br>   #4 = Fieldref           #5.#27         <span class="hljs-comment">// cn/itcast/jvm/t3/load/Load8.e:Ljava/lang/Object;</span><br>   #5 = Class              #28            <span class="hljs-comment">// cn/itcast/jvm/t3/load/Load8</span><br>   #6 = Utf8               a<br>   #7 = Utf8               I<br>   #8 = Utf8               b<br>   #9 = Utf8               c<br>  #10 = Utf8               ConstantValue<br>  #11 = <span class="hljs-built_in">Integer</span>            <span class="hljs-number">20</span><br>  #12 = Utf8               d<br>  #13 = Utf8               Ljava/lang/<span class="hljs-built_in">String</span>;<br>  #14 = <span class="hljs-built_in">String</span>             #29            <span class="hljs-comment">// hello</span><br>  #15 = Utf8               e<br>  #16 = Utf8               Ljava/lang/Object;<br>  #17 = Utf8               &lt;init&gt;<br>  #18 = Utf8               ()V<br>  #19 = Utf8               Code<br>  #20 = Utf8               LineNumberTable<br>  #21 = Utf8               &lt;clinit&gt;<br>  #22 = Utf8               SourceFile<br>  #23 = Utf8               Load8.java<br>  #24 = NameAndType        #17:#18        <span class="hljs-comment">// &quot;&lt;init&gt;&quot;:()V</span><br>  #25 = NameAndType        #8:#7          <span class="hljs-comment">// b:I</span><br>  #26 = Utf8               java/lang/Object<br>  #27 = NameAndType        #15:#16        <span class="hljs-comment">// e:Ljava/lang/Object;</span><br>  #28 = Utf8               <span class="hljs-literal">cn</span>/itcast/jvm/t3/load/Load8<br>  #29 = Utf8               hello<br>&#123;<br>  static int a; 【只分配空间】<br>    descriptor: I<br>    flags: ACC_STATIC<br><br>  static int b; 【只分配空间】<br>    descriptor: I<br>    flags: ACC_STATIC<br><br>  static final int c; 【分配空间 并赋值】<br>    descriptor: I<br>    flags: ACC_STATIC, ACC_FINAL<br>    ConstantValue: int <span class="hljs-number">20</span><br><br>  static final java.lang.<span class="hljs-built_in">String</span> d; 【分配空间 并赋值】<br>    descriptor: Ljava/lang/<span class="hljs-built_in">String</span>;<br>    flags: ACC_STATIC, ACC_FINAL<br>    ConstantValue: <span class="hljs-built_in">String</span> hello<br><br>  static final java.lang.Object e; 【只分配空间】<br>    descriptor: Ljava/lang/Object;<br>    flags: ACC_STATIC, ACC_FINAL<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-literal">cn</span>.itcast.jvm.t3.load.Load8();<br>    descriptor: ()V<br>    flags: ACC_PUBLIC<br>    Code:<br>      <span class="hljs-built_in">stack</span>=<span class="hljs-number">1</span>, locals=<span class="hljs-number">1</span>, args_size=<span class="hljs-number">1</span><br>         <span class="hljs-number">0</span>: aload_0<br>         <span class="hljs-number">1</span>: invokespecial #1                  <span class="hljs-comment">// Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br>         <span class="hljs-number">4</span>: <span class="hljs-keyword">return</span><br>      LineNumberTable:<br>        line <span class="hljs-number">4</span>: <span class="hljs-number">0</span><br><br>  static &#123;&#125;;         【静态代码块 即是cinit 类初始化器  对应类加载的初始化阶段】<br>    descriptor: ()V<br>    flags: ACC_STATIC<br>    Code:<br>      <span class="hljs-built_in">stack</span>=<span class="hljs-number">2</span>, locals=<span class="hljs-number">0</span>, args_size=<span class="hljs-number">0</span><br>         <span class="hljs-number">0</span>: bipush        <span class="hljs-number">10</span><br>         <span class="hljs-number">2</span>: putstatic     #2                  <span class="hljs-comment">// Field b:I 【将10 赋值给静态变量b】</span><br>         <br>         <span class="hljs-number">5</span>: <span class="hljs-literal">new</span>           #3                  <span class="hljs-comment">// class java/lang/Object</span><br>         <span class="hljs-number">8</span>: dup<br>         <span class="hljs-number">9</span>: invokespecial #1                  <span class="hljs-comment">// Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br>        <span class="hljs-number">12</span>: putstatic     #4                  <span class="hljs-comment">// Field e:Ljava/lang/Object; 【创建一个对象 赋值给静态变量e】</span><br>        <br>        <span class="hljs-number">15</span>: <span class="hljs-keyword">return</span><br>      LineNumberTable:<br>        line <span class="hljs-number">7</span>: <span class="hljs-number">0</span><br>        line <span class="hljs-number">10</span>: <span class="hljs-number">5</span><br>&#125;<br>SourceFile: <span class="hljs-string">&quot;Load8.java&quot;</span><br></code></pre></td></tr></table></figure>



<p>如果 static 变量是 final 的 <strong>基本类型</strong> 以及 <strong>字符串常量</strong>，那么 <strong>编译阶段 值 就确定</strong>了，<strong>赋值</strong> 在<code>类加载的 准备阶 段完成 </code></p>
<p>如果 static 变量是 final 的，但属于引用类型，那么赋值也会在<strong>初始化阶段完成</strong></p>
<p><strong>解析</strong> </p>
<p>将常量池中的符号引用解析为直接引用</p>
<p>例子1【只进行类加载】</p>
<p>源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t3.load;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 解析的含义</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Load2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, IOException &#123;<br>        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">classloader</span> <span class="hljs-operator">=</span> Load2.class.getClassLoader();<br>        Class&lt;?&gt; c = classloader.loadClass(<span class="hljs-string">&quot;cn.itcast.jvm.t3.load.C&quot;</span>);<span class="hljs-comment">//loadClass方法只会进行类的加载，不会进行解析</span><br>        System.in.read();<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">C</span> &#123;<br>    <span class="hljs-type">D</span> <span class="hljs-variable">d</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">D</span>();<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">D</span> &#123;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>注意：</p>
<p>加载  和  链接  <strong>可能是交替运行</strong>的  如一部分字节码文件格式验证动作</p>
<p>加载阶段尚未完成，连接阶段可能已经开始</p>
<p>运行 然后：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">D:\sofeware\Idea\JDK1<span class="hljs-number">.8</span>&gt;jps<br><span class="hljs-number">11952</span> Launcher<br><span class="hljs-number">20176</span> RemoteMavenServer36<br><span class="hljs-number">8000</span><br><span class="hljs-number">19832</span> Load2<br><span class="hljs-number">21692</span> Jps<br><br>D:\sofeware\Idea\JDK1<span class="hljs-number">.8</span>&gt;java -cp ./lib/sa-jdi.jar sun.jvm.hotspot.HSDB<br></code></pre></td></tr></table></figure>

<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220814122949105.png" srcset="/img/loading.gif" lazyload alt="image-20220814122949105"></p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220814123510642.png" srcset="/img/loading.gif" lazyload alt="image-20220814123510642"></p>
<hr>
<p>例子2 【进行加载、连接、初始化】</p>
<p>源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t3.load;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 解析的含义</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Load2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, IOException &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">C</span>();<br>        System.in.read();<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">C</span> &#123;<br>    <span class="hljs-type">D</span> <span class="hljs-variable">d</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">D</span>();<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">D</span> &#123;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220814124137969.png" srcset="/img/loading.gif" lazyload alt="image-20220814124137969"></p>
<hr>
<p>可以看到类D已经被解析了，可以直接得到类D的内存地址了</p>
<p>小结：</p>
<p>将  <code>常量池</code>  中的  <code>符号引用</code>  <strong>解析为</strong>   <code>直接引用</code></p>
<h3 id="4-3-初始化"><a href="#4-3-初始化" class="headerlink" title="4.3 初始化"></a>4.3 初始化</h3><p><strong>cinit()V 方法</strong></p>
<p>初始化即调用cinit()V ，虚拟机会保证这个 <strong>类的『构造方法』</strong>的 <strong>线程安全</strong></p>
<p><strong>发生的时机</strong></p>
<p>概括得说，类初始化是【懒惰的】 </p>
<ul>
<li><p>main 方法所在的类，总会被首先初始化 </p>
</li>
<li><p>首次访问这个类的  静态变量 <strong>(是静态变量不是静态常量)</strong>  或   静态方法  时 </p>
</li>
<li><p>子类初始化，如果父类还没初始化，会引发 </p>
</li>
<li><p>子类访问父类的静态变量，<strong>只会</strong>  触发父类的初始化 </p>
</li>
<li><p>Class.forName </p>
</li>
<li><p>new 会导致初始化</p>
</li>
</ul>
<p>不会导致类初始化的情况 </p>
<ul>
<li><p>访问类的 static final 静态常量（<strong>基本类型和字符串</strong>）不会触发初始化 </p>
</li>
<li><p>类对象.class 不会触发初始化 <strong>【类对象，在加载阶段就会被创建出来】</strong></p>
</li>
<li><p>创建该类的数组不会触发初始化 </p>
</li>
<li><p>类加载器的 loadClass 方法 </p>
</li>
<li><p>Class.forName 的参数 2 为 false 时</p>
</li>
</ul>
<p>例子1：运行main方法，其所在的类的类初始化方法会被调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;a init&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">A</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">5.0</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;b init&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Load3</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;main init&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs csharp">main <span class="hljs-keyword">init</span><br></code></pre></td></tr></table></figure>

<p>输出了 <code>main init</code> 说明了执行main方法，会触发该类的<code> &lt;cinit&gt;</code>方法，也可以叫做类构造器，也可以称为静态代码块；即是触发了类的初始化；</p>
<p>例子2：静态常量不会触发初始化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;a init&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">A</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">5.0</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;b init&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Load3</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;main init&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, IOException &#123;<br>        <span class="hljs-comment">// 1. 静态常量不会触发初始化</span><br>        System.out.println(B.b);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">main</span> init<br><span class="hljs-attribute">5</span>.<span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>

<p>没有触发类B的初始化 没有看到  <code>b init</code></p>
<p>例子3：创建该类的数组不会触发初始化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;a init&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">A</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">5.0</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;b init&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t3.load;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Load3</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;main init&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, IOException &#123;<br>        <span class="hljs-comment">// 3. 创建该类的数组不会触发初始化</span><br>        System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">B</span>[<span class="hljs-number">0</span>]);<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs llvm">main init<br>[Lcn.itcast.jvm.t<span class="hljs-number">3</span>.<span class="hljs-keyword">load</span>.B<span class="hljs-comment">;@7f31245a</span><br></code></pre></td></tr></table></figure>



<p>例子4：类对象的loadClass方法，不会触发解析及其之后的阶段</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;a init&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">A</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">5.0</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;b init&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t3.load;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Load3</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;main init&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, IOException &#123;<br>        <span class="hljs-comment">// 4. 不会初始化类 B，但会加载 B、A </span><br>        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">cl</span> <span class="hljs-operator">=</span> Thread.currentThread().getContextClassLoader();<br>        cl.loadClass(<span class="hljs-string">&quot;cn.itcast.jvm.t3.B&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs csharp">main <span class="hljs-keyword">init</span><br></code></pre></td></tr></table></figure>





<p>例子5：Class类的静态方法，forName(),的第二个参数是false；那么这个类是不会初始化的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;a init&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">A</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">5.0</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;b init&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t3.load;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Load3</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;main init&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, IOException &#123;<br>         <span class="hljs-comment">// 5. 不会初始化类 B，但会加载 B、A</span><br>        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">c2</span> <span class="hljs-operator">=</span> Thread.currentThread().getContextClassLoader();<br>        Class.forName(<span class="hljs-string">&quot;cn.itcast.jvm.t3.load.B&quot;</span>, <span class="hljs-literal">false</span>, c2);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs csharp">main <span class="hljs-keyword">init</span><br></code></pre></td></tr></table></figure>





<p>例子6：首次 访问这个类的静态变量或静态方法时 <strong>会进行类的初始化</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;a init&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">A</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">5.0</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;b init&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t3.load;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Load3</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;main init&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, IOException &#123;<br>        <span class="hljs-comment">// 1. 首次 访问这个类的静态变量或静态方法时</span><br>        System.out.println(A.a);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs csharp">main <span class="hljs-keyword">init</span><br>a <span class="hljs-keyword">init</span><br><span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>







<p>例子7：子类初始化，如果父类还没初始化，会引发</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;a init&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">A</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">5.0</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;b init&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t3.load;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Load3</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;main init&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, IOException &#123;<br>         <span class="hljs-comment">// 2. 子类初始化，如果父类还没初始化，会引发</span><br>        System.out.println(B.c);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs csharp">main <span class="hljs-keyword">init</span><br>a <span class="hljs-keyword">init</span><br>b <span class="hljs-keyword">init</span><br><span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure>

<p>类B是类A的子类；获取类B的静态变量（非静态常量）时，会触发类B的初始化；此时发现类A还未初始化，先进行类A的初始化</p>
<p>例子7： 子类访问父类静态变量，只触发父类初始化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;a init&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">A</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">5.0</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;b init&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t3.load;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Load3</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;main init&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, IOException &#123;<br>        <span class="hljs-comment">// 3. 子类访问父类静态变量，只触发父类初始化</span><br>        System.out.println(B.a);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs csharp">main <span class="hljs-keyword">init</span><br>a <span class="hljs-keyword">init</span><br><span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>

<p>类B是类A的子类，可以通过类B调用类A的静态变量；非继承；</p>
<p>例子8：Class类的forname方法，触发完整的加载，连接【验证、准备、解析】，初始化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;a init&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">A</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">5.0</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;b init&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t3.load;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Load3</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;main init&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, IOException &#123;<br>        <span class="hljs-comment">// 4. 会初始化类 B，并先初始化类 A</span><br>        Class.forName(<span class="hljs-string">&quot;cn.itcast.jvm.t3.load.B&quot;</span>);<span class="hljs-comment">//单个参数的情况，默认 inicialize 为true</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs csharp">main <span class="hljs-keyword">init</span><br>a <span class="hljs-keyword">init</span><br>b <span class="hljs-keyword">init</span><br></code></pre></td></tr></table></figure>

<p>类B是类A的子类；调用Class类的forName方法会，触发类B的初始化；此时发现类A还未初始化，先进行类A的初始化</p>
<h3 id="4-4-练习"><a href="#4-4-练习" class="headerlink" title="4.4 练习"></a>4.4 练习</h3><p>从字节码分析，使用 a，b，c 这三个常量是否会导致 E 初始化</p>
<p>例子1：【静态常量，且是基本数据类型和String类型】</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">E</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hello&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Integer</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-number">20</span>;  <span class="hljs-comment">// Integer.valueOf(20)</span><br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;init E&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t3.load;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Load4</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        System.out.println(E.a);<br>        System.out.println(E.b);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs">10<br>hello<br></code></pre></td></tr></table></figure>





<p> 例子2：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">E</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hello&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Integer</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-number">20</span>;  <span class="hljs-comment">// Integer.valueOf(20)</span><br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;init E&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t3.load;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Load4</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        System.out.println(E.c);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">init</span> E<br><span class="hljs-number">20</span><br></code></pre></td></tr></table></figure>





<p>例子3：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t3.load;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Load4</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        System.out.println(E.a);<br>        System.out.println(E.b);<br>        System.out.println(E.c);<br><br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">E</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hello&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Integer</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-number">20</span>;  <span class="hljs-comment">// Integer.valueOf(20)</span><br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;init E&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><code class="hljs java">E.<span class="hljs-keyword">class</span><br>  <span class="hljs-title class_">Last</span> modified <span class="hljs-number">2022</span>-<span class="hljs-number">8</span>-<span class="hljs-number">14</span>; size <span class="hljs-number">702</span> bytes<br>  MD5 checksum a6474cb9f4ab609d88688d41027f1ad8<br>  Compiled from <span class="hljs-string">&quot;Load4.java&quot;</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">cn</span>.itcast.jvm.t3.load.E<br>  minor version: <span class="hljs-number">0</span><br>  major version: <span class="hljs-number">52</span><br>  flags: ACC_SUPER<br>Constant pool:<br>   #<span class="hljs-number">1</span> = Methodref          #<span class="hljs-number">8.</span>#<span class="hljs-number">28</span>         <span class="hljs-comment">// java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br>   #<span class="hljs-number">2</span> = Methodref          #<span class="hljs-number">29.</span>#<span class="hljs-number">30</span>        <span class="hljs-comment">// java/lang/Integer.valueOf:(I)Ljava/lang/Integer;</span><br>   #<span class="hljs-number">3</span> = Fieldref           #<span class="hljs-number">7.</span>#<span class="hljs-number">31</span>         <span class="hljs-comment">// cn/itcast/jvm/t3/load/E.c:Ljava/lang/Integer;</span><br>   #<span class="hljs-number">4</span> = Fieldref           #<span class="hljs-number">32.</span>#<span class="hljs-number">33</span>        <span class="hljs-comment">// java/lang/System.out:Ljava/io/PrintStream;</span><br>   #<span class="hljs-number">5</span> = String             #<span class="hljs-number">34</span>            <span class="hljs-comment">// init E</span><br>   #<span class="hljs-number">6</span> = Methodref          #<span class="hljs-number">35.</span>#<span class="hljs-number">36</span>        <span class="hljs-comment">// java/io/PrintStream.println:(Ljava/lang/String;)V</span><br>   #<span class="hljs-number">7</span> = Class              #<span class="hljs-number">37</span>            <span class="hljs-comment">// cn/itcast/jvm/t3/load/E</span><br>   #<span class="hljs-number">8</span> = Class              #<span class="hljs-number">38</span>            <span class="hljs-comment">// java/lang/Object</span><br>   #<span class="hljs-number">9</span> = Utf8               a<br>  #<span class="hljs-number">10</span> = Utf8               I<br>  #<span class="hljs-number">11</span> = Utf8               ConstantValue<br>  #<span class="hljs-number">12</span> = Integer            <span class="hljs-number">10</span><br>  #<span class="hljs-number">13</span> = Utf8               b<br>  #<span class="hljs-number">14</span> = Utf8               Ljava/lang/String;<br>  #<span class="hljs-number">15</span> = String             #<span class="hljs-number">39</span>            <span class="hljs-comment">// hello</span><br>  #<span class="hljs-number">16</span> = Utf8               c<br>  #<span class="hljs-number">17</span> = Utf8               Ljava/lang/Integer;<br>  #<span class="hljs-number">18</span> = Utf8               &lt;init&gt;<br>  #<span class="hljs-number">19</span> = Utf8               ()V<br>  #<span class="hljs-number">20</span> = Utf8               Code<br>  #<span class="hljs-number">21</span> = Utf8               LineNumberTable<br>  #<span class="hljs-number">22</span> = Utf8               LocalVariableTable<br>  #<span class="hljs-number">23</span> = Utf8               <span class="hljs-built_in">this</span><br>  #<span class="hljs-number">24</span> = Utf8               Lcn/itcast/jvm/t3/load/E;<br>  #<span class="hljs-number">25</span> = Utf8               &lt;clinit&gt;<br>  #<span class="hljs-number">26</span> = Utf8               SourceFile<br>  #<span class="hljs-number">27</span> = Utf8               Load4.java<br>  #<span class="hljs-number">28</span> = NameAndType        #<span class="hljs-number">18</span>:#<span class="hljs-number">19</span>        <span class="hljs-comment">// &quot;&lt;init&gt;&quot;:()V</span><br>  #<span class="hljs-number">29</span> = Class              #<span class="hljs-number">40</span>            <span class="hljs-comment">// java/lang/Integer</span><br>  #<span class="hljs-number">30</span> = NameAndType        #<span class="hljs-number">41</span>:#<span class="hljs-number">42</span>        <span class="hljs-comment">// valueOf:(I)Ljava/lang/Integer;</span><br>  #<span class="hljs-number">31</span> = NameAndType        #<span class="hljs-number">16</span>:#<span class="hljs-number">17</span>        <span class="hljs-comment">// c:Ljava/lang/Integer;</span><br>  #<span class="hljs-number">32</span> = Class              #<span class="hljs-number">43</span>            <span class="hljs-comment">// java/lang/System</span><br>  #<span class="hljs-number">33</span> = NameAndType        #<span class="hljs-number">44</span>:#<span class="hljs-number">45</span>        <span class="hljs-comment">// out:Ljava/io/PrintStream;</span><br>  #<span class="hljs-number">34</span> = Utf8               init E<br>  #<span class="hljs-number">35</span> = Class              #<span class="hljs-number">46</span>            <span class="hljs-comment">// java/io/PrintStream</span><br>  #<span class="hljs-number">36</span> = NameAndType        #<span class="hljs-number">47</span>:#<span class="hljs-number">48</span>        <span class="hljs-comment">// println:(Ljava/lang/String;)V</span><br>  #<span class="hljs-number">37</span> = Utf8               cn/itcast/jvm/t3/load/E<br>  #<span class="hljs-number">38</span> = Utf8               java/lang/Object<br>  #<span class="hljs-number">39</span> = Utf8               hello<br>  #<span class="hljs-number">40</span> = Utf8               java/lang/Integer<br>  #<span class="hljs-number">41</span> = Utf8               valueOf<br>  #<span class="hljs-number">42</span> = Utf8               (I)Ljava/lang/Integer;<br>  #<span class="hljs-number">43</span> = Utf8               java/lang/System<br>  #<span class="hljs-number">44</span> = Utf8               out<br>  #<span class="hljs-number">45</span> = Utf8               Ljava/io/PrintStream;<br>  #<span class="hljs-number">46</span> = Utf8               java/io/PrintStream<br>  #<span class="hljs-number">47</span> = Utf8               println<br>  #<span class="hljs-number">48</span> = Utf8               (Ljava/lang/String;)V<br>&#123;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> a;<br>    descriptor: I<br>    flags: ACC_PUBLIC, ACC_STATIC, ACC_FINAL<br>    ConstantValue: <span class="hljs-type">int</span> <span class="hljs-number">10</span><br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> java.lang.String b;<br>    descriptor: Ljava/lang/String;<br>    flags: ACC_PUBLIC, ACC_STATIC, ACC_FINAL<br>    ConstantValue: String hello                 <span class="hljs-comment">//【静态常量b的值，在链接的准备阶段就已经准备好了】</span><br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> java.lang.Integer c;     <span class="hljs-comment">// 【静态常量c的值，在链接的准备阶段就已经准备好了】</span><br>    descriptor: Ljava/lang/Integer;<br>    flags: ACC_PUBLIC, ACC_STATIC, ACC_FINAL<br><br>  cn.itcast.jvm.t3.load.E();<br>    descriptor: ()V<br>    flags:<br>    Code:<br>      stack=<span class="hljs-number">1</span>, locals=<span class="hljs-number">1</span>, args_size=<span class="hljs-number">1</span><br>         <span class="hljs-number">0</span>: aload_0<br>         <span class="hljs-number">1</span>: invokespecial #<span class="hljs-number">1</span>                  <span class="hljs-comment">// Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br>         <span class="hljs-number">4</span>: <span class="hljs-keyword">return</span><br>      LineNumberTable:<br>        line <span class="hljs-number">12</span>: <span class="hljs-number">0</span><br>      LocalVariableTable:<br>        Start  Length  Slot  Name   Signature<br>            <span class="hljs-number">0</span>       <span class="hljs-number">5</span>     <span class="hljs-number">0</span>  <span class="hljs-built_in">this</span>   Lcn/itcast/jvm/t3/load/E;<br><br>  <span class="hljs-keyword">static</span> &#123;&#125;;            <span class="hljs-comment">//类初始化方法</span><br>    descriptor: ()V<br>    flags: ACC_STATIC<br>    Code:<br>      stack=<span class="hljs-number">2</span>, locals=<span class="hljs-number">0</span>, args_size=<span class="hljs-number">0</span><br>         <span class="hljs-number">0</span>: bipush        <span class="hljs-number">20</span><br>         <span class="hljs-number">2</span>: invokestatic  #<span class="hljs-number">2</span>                  <span class="hljs-comment">// Method java/lang/Integer.valueOf:(I)Ljava/lang/Integer;</span><br>         <span class="hljs-number">5</span>: putstatic     #<span class="hljs-number">3</span>                  <span class="hljs-comment">// Field c:Ljava/lang/Integer;【将基本数据类型20装箱成Integer，再赋值给静态变量c】</span><br>             <br>         <span class="hljs-number">8</span>: getstatic     #<span class="hljs-number">4</span>                  <span class="hljs-comment">// Field java/lang/System.out:Ljava/io/PrintStream;</span><br>        <span class="hljs-number">11</span>: ldc           #<span class="hljs-number">5</span>                  <span class="hljs-comment">// String init E</span><br>        <span class="hljs-number">13</span>: invokevirtual #<span class="hljs-number">6</span>                  <span class="hljs-comment">// Method java/io/PrintStream.println:(Ljava/lang/String;)V</span><br>        <span class="hljs-number">16</span>: <span class="hljs-keyword">return</span><br>      LineNumberTable:<br>        line <span class="hljs-number">15</span>: <span class="hljs-number">0</span><br>        line <span class="hljs-number">17</span>: <span class="hljs-number">8</span><br>        line <span class="hljs-number">18</span>: <span class="hljs-number">16</span><br>&#125;<br>SourceFile: <span class="hljs-string">&quot;Load4.java&quot;</span><br></code></pre></td></tr></table></figure>





<p>练习2：</p>
<p>内部类实现懒汉式单例：</p>
<p>测试1：调用外部类的静态方法，会触发外部类的类初始化，但不会触发内部类的类初始化；而内部类中通过类初始化方法创建外部类对象【由JVM保证，类初始			  化器中的线程安全问题】</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Singleton cinit..&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;a static method&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Singleton</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LazyHolder</span> &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Singleton</span> <span class="hljs-variable">SINGLETON</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>();<br><br>        <span class="hljs-keyword">static</span> &#123;<br>            System.out.println(<span class="hljs-string">&quot;innerClass cinit...\n mean outerClass instance will be create later&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> LazyHolder.SINGLETON;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t3.load;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Load9</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        Singleton.test();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs oxygene">Singleton cinit..<br>a <span class="hljs-keyword">static</span> <span class="hljs-keyword">method</span><br></code></pre></td></tr></table></figure>



<p>测试2：通过外部类的静态方法，调用内部类中的静态变量，导致内部类的初始化，进而创建外部类对象，实现懒汉式单例；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Singleton cinit..&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;a static method&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Singleton</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LazyHolder</span> &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Singleton</span> <span class="hljs-variable">SINGLETON</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>();<br><br>        <span class="hljs-keyword">static</span> &#123;<br>            System.out.println(<span class="hljs-string">&quot;innerClass cinit...\n mean outerClass instance will be create later&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> LazyHolder.SINGLETON;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Load9</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Singleton</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> Singleton.getInstance();<br>        System.out.println(instance);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs smali">Singleton cinit..<br>innerClass cinit...<br> mean outerClass<span class="hljs-built_in"> instance </span>will be create later<br>cn.itcast.jvm.t3.load.Singleton@7f31245a<br></code></pre></td></tr></table></figure>

<p>main方法所在的类先初始化</p>
<h2 id="5-类加载器"><a href="#5-类加载器" class="headerlink" title="5. 类加载器"></a>5. 类加载器</h2><p>以 JDK 8 为例：</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220814172416207.png" srcset="/img/loading.gif" lazyload alt="image-20220814172416207"></p>
<hr>
<p>Bootstrap ClassLoader：启动类加载器</p>
<p>Extension ClassLoader：扩展类加载器</p>
<p>Application ClassLoader ：应用程序加载器</p>
<p>注意：</p>
<p>扩展类加载器中是不可以直接通过getParent方法获取父级的类加载器；原因：Bootstrap ClassLoader是由C++编写的，java代码无法直接访问	</p>
<p>通过一些虚拟机参数，使得自定义的类可以交由BootstrapClassLoader进行加载</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">F</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;bootstrap F init&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Load5_1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Load5_1</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>        Class&lt;?&gt; aClass = Class.forName(<span class="hljs-string">&quot;F&quot;</span>);<br>        System.out.println(aClass.getClassLoader());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">输入命令 java -Xbootclasspath/a:. Load5_1 <br>【.代表是当前路径，即除了java_home<span class="hljs-regexp">/jre/</span>lib目录下的所有类都由启动类加载器负责加载，还要追加一个路径：当前路径】<br></code></pre></td></tr></table></figure>



 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">bootstrap F init<br><span class="hljs-literal">null</span>   【说明这个是启动类加载器】<br></code></pre></td></tr></table></figure>

<blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/PengZyi/article/details/114846569">https://blog.csdn.net/PengZyi/article/details/114846569</a>  <strong>Java 中带包的类的编译与运行</strong></p>
</blockquote>
<p>-Xbootclasspath 表示设置 bootclasspath </p>
<p>其中 &#x2F;a:. 表示将当前目录追加至 bootclasspath 之后 </p>
<p>可以用这个办法替换核心类 </p>
<p><code>java -Xbootclasspath:</code></p>
<p><code>java -Xbootclasspath/a:&lt;后追加路径&gt; </code></p>
<p><code>java -Xbootclasspath/p:&lt;前追加路径&gt;</code>  用于替换某些由启动类加载器加载的类</p>
<h3 id="5-2-扩展类加载器"><a href="#5-2-扩展类加载器" class="headerlink" title="5.2 扩展类加载器"></a>5.2 扩展类加载器</h3><p>例子1：证明，是由应用类加载器加载自定义类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t3.load;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">G</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;classpath G init&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t3.load;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Load5_2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>        Class&lt;?&gt; aClass = Class.forName(<span class="hljs-string">&quot;cn.itcast.jvm.t3.load.G&quot;</span>);<br>        System.out.println(aClass.getClassLoader());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs autoit">classpath G init<br>sun.misc.Launcher$AppClassLoader<span class="hljs-symbol">@18b4aac2</span><br></code></pre></td></tr></table></figure>





<p>例子2：测试在扩展类加载器的路径中，有同名类时，由哪个类加载器进行加载</p>
<p>同名类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t3.load;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">G</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>       System.out.println(<span class="hljs-string">&quot;ext G init&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>打个 jar 包</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs gradle">D:\learn\黑马程序员\资料-解密JVM\代码\jvm\out\production\jvm&gt;jar -cfv my.jar cn<span class="hljs-regexp">/itcast/</span>jvm<span class="hljs-regexp">/t3/</span>load/G.<span class="hljs-keyword">class</span><br>已添加清单<br>正在添加: cn<span class="hljs-regexp">/itcast/</span>jvm<span class="hljs-regexp">/t3/</span>load/G.<span class="hljs-keyword">class</span>(输入 = <span class="hljs-number">487</span>) (输出 = <span class="hljs-number">327</span>)(压缩了 <span class="hljs-number">32</span>%) <br></code></pre></td></tr></table></figure>



<p>将 jar 包拷贝到 JAVA_HOME&#x2F;jre&#x2F;lib&#x2F;ext </p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220814203028290.png" srcset="/img/loading.gif" lazyload alt="image-20220814203028290"></p>
<hr>
<p>重新执行 Load5_2 </p>
<p>输出</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs autoit">ext G init<br>sun.misc.Launcher$ExtClassLoader<span class="hljs-symbol">@4b67cf4d</span><br></code></pre></td></tr></table></figure>



<h3 id="5-3-双亲委派模式"><a href="#5-3-双亲委派模式" class="headerlink" title="5.3 双亲委派模式"></a>5.3 双亲委派模式</h3><p>所谓的双亲委派，就是指调用类加载器的 loadClass 方法时，<strong>查找类的规则</strong></p>
<p>注意 这里的双亲，翻译为<strong>上级</strong>似乎更为合适，因为它们并没有继承关系</p>
<p>源码解析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="hljs-type">boolean</span> resolve)<br>      <span class="hljs-keyword">throws</span> ClassNotFoundException<br>  &#123;<br>      <span class="hljs-keyword">synchronized</span> (getClassLoadingLock(name)) &#123;<br>          <span class="hljs-comment">// First, check if the class has already been loaded</span><br>          Class&lt;?&gt; c = findLoadedClass(name);<span class="hljs-comment">//在缓存中确认一遍该类是否已经被加载</span><br>          <span class="hljs-keyword">if</span> (c == <span class="hljs-literal">null</span>) &#123;<br>              <span class="hljs-type">long</span> <span class="hljs-variable">t0</span> <span class="hljs-operator">=</span> System.nanoTime();<br>              <span class="hljs-keyword">try</span> &#123;<br>                  <span class="hljs-keyword">if</span> (parent != <span class="hljs-literal">null</span>) &#123;、<br>                      <span class="hljs-comment">//一般这里是应用程序加载器，上一级是扩展类加载器，再上一层是启动类加载器</span><br>                      <span class="hljs-comment">//递归调用当前方法；一般是两层</span><br>                      <span class="hljs-comment">//有上级的话，委派上级 loadClass</span><br>                      c = parent.loadClass(name, <span class="hljs-literal">false</span>);<br>                  &#125; <span class="hljs-keyword">else</span> &#123;<br>                      <span class="hljs-comment">//启动类加载器</span><br>                      <span class="hljs-comment">//调用本地方法，查看java_home/jre/lib目录下是否有某个类，全类名</span><br>                      <span class="hljs-comment">// 3. 如果没有上级了（ExtClassLoader），则委派BootstrapClassLoader</span><br>                      c = findBootstrapClassOrNull(name);<br>                  &#125;<br>              &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>                  <br>                  <span class="hljs-comment">// ClassNotFoundException thrown if class not found</span><br>                  <span class="hljs-comment">// from the non-null parent class loader</span><br>              &#125;<br><br>              <span class="hljs-keyword">if</span> (c == <span class="hljs-literal">null</span>) &#123;<br>                  <span class="hljs-comment">// If still not found, then invoke findClass in order</span><br>                  <span class="hljs-comment">// to find the class.</span><br>                  <span class="hljs-type">long</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> System.nanoTime();<br>                  <span class="hljs-comment">//查找自己的目录下是否有该名字的类</span><br>                  <span class="hljs-comment">//App是当前目录</span><br>                  <span class="hljs-comment">//Ext是java_home/jre/lib/ext</span><br>                  c = findClass(name);<br><br>                  <span class="hljs-comment">// this is the defining class loader; record the stats</span><br>                  sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);<br>                  sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);<br>                  sun.misc.PerfCounter.getFindClasses().increment();<br>              &#125;<br>          &#125;<br>          <span class="hljs-keyword">if</span> (resolve) &#123;<br>              resolveClass(c);<br>          &#125;<br>          <span class="hljs-keyword">return</span> c;<br>      &#125;<br>  &#125;<br></code></pre></td></tr></table></figure>



<p>例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Load5_3</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>        Class&lt;?&gt; aClass = Load5_3.class.getClassLoader().loadClass(<span class="hljs-string">&quot;cn.itcast.jvm.t3.load.H&quot;</span>);<br>        System.out.println(aClass.getClassLoader());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>执行流程为：</p>
<ol>
<li><code>sun.misc.Launcher$AppClassLoader</code> &#x2F;&#x2F;1 处， 开始查看已加载的类，结果没有</li>
<li><code>sun.misc.Launcher$AppClassLoader</code> &#x2F;&#x2F; 2 处，委派上级 <code>sun.misc.Launcher$ExtClassLoader.loadClass()</code> </li>
<li><code>sun.misc.Launcher$ExtClassLoader</code> &#x2F;&#x2F; 1 处，查看已加载的类，结果没有 </li>
<li><code> sun.misc.Launcher$ExtClassLoader</code> &#x2F;&#x2F; 3 处，没有上级了，则委派 BootstrapClassLoader 查找 </li>
<li>BootstrapClassLoader 是在 JAVA_HOME&#x2F;jre&#x2F;lib 下找 H 这个类，显然没有 </li>
<li><code>sun.misc.Launcher$ExtClassLoader</code> &#x2F;&#x2F; 4 处，调用自己的 findClass 方法，是在<code>JAVA_HOME/jre/lib/ext</code>下找 H 这个类，显然没有，回到 <code>sun.misc.Launcher$AppClassLoader</code> 的 &#x2F;&#x2F; 2 处</li>
<li>继续执行到 <code>sun.misc.Launcher$AppClassLoader </code>&#x2F;&#x2F; 4 处，调用它自己的<code> findClass 方法</code>，在 <code>classpath</code> 下查找，找到了</li>
</ol>
<h3 id="5-4-线程上下文类加载器"><a href="#5-4-线程上下文类加载器" class="headerlink" title="5.4 线程上下文类加载器"></a>5.4 线程上下文类加载器</h3><p>我们在使用 JDBC 时，都需要加载 Driver 驱动，不知道你注意到没有，不写<code>Class.forName(&quot;com.mysql.jdbc.Driver&quot;)</code></p>
<p>也是可以让 com.mysql.jdbc.Driver 正确加载的，你知道是怎么做的吗？</p>
<p>让我们追踪一下源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DriverManager</span> &#123;<br>    <span class="hljs-comment">// 注册驱动的集合</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> CopyOnWriteArrayList&lt;DriverInfo&gt; registeredDrivers= <span class="hljs-keyword">new</span> <span class="hljs-title class_">CopyOnWriteArrayList</span>&lt;&gt;();<br>    <br>    <span class="hljs-comment">// 初始化驱动</span><br>    <span class="hljs-keyword">static</span> &#123;<br>        loadInitialDrivers();<br>        println(<span class="hljs-string">&quot;JDBC DriverManager initialized&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里的类DriverManager 所对应的类加载器为BootstractClassloader【再rt.jar包下 】</p>
<p>先不看别的，看看 DriverManager 的类加载器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">System.out.println(DriverManager.class.getClassLoader());<br></code></pre></td></tr></table></figure>

<p>打印 null，表示它的类加载器是 Bootstrap ClassLoader，会到 JAVA_HOME&#x2F;jre&#x2F;lib 下搜索类；【加载与之相关联的类时，都应该使用启动类加载器】</p>
<p>但  JAVA_HOME&#x2F;jre&#x2F;lib 下显然没有 mysql-connector-java-5.1.47.jar 包，这样问题来了，在 DriverManager 的静态代码块中，怎么能正确加载 </p>
<p>com.mysql.jdbc.Driver 呢？</p>
<p>继续看 loadInitialDrivers() 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadInitialDrivers</span><span class="hljs-params">()</span> &#123;<br>       String drivers;<br>       <span class="hljs-keyword">try</span> &#123;<br>           drivers = AccessController.doPrivileged(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PrivilegedAction</span>&lt;String&gt;() &#123;<br>               <span class="hljs-keyword">public</span> String <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                   <span class="hljs-keyword">return</span> System.getProperty(<span class="hljs-string">&quot;jdbc.drivers&quot;</span>);<br>               &#125;<br>           &#125;);<br>       &#125; <span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>           drivers = <span class="hljs-literal">null</span>;<br>       &#125;<br>  <br><br>    	<span class="hljs-comment">// 1）使用 ServiceLoader 机制加载驱动，即 SPI</span><br>       AccessController.doPrivileged(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PrivilegedAction</span>&lt;Void&gt;() &#123;<br>           <span class="hljs-keyword">public</span> Void <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br><br>               ServiceLoader&lt;Driver&gt; loadedDrivers = ServiceLoader.load(Driver.class);<br>               <span class="hljs-comment">//遍历每一个实现类的全类名，通过线程上下文持有的 应用程序类加载器 加载每一个实现类【破坏双亲委派机制】</span><br>               Iterator&lt;Driver&gt; driversIterator = loadedDrivers.iterator();<br><br>    <br>               <span class="hljs-keyword">try</span>&#123;<br>                   <span class="hljs-keyword">while</span>(driversIterator.hasNext()) &#123;<br>                       driversIterator.next();<br>                   &#125;<br>               &#125; <span class="hljs-keyword">catch</span>(Throwable t) &#123;<br>               <span class="hljs-comment">// Do nothing</span><br>               &#125;<br>               <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>           &#125;<br>       &#125;);<br><br>       println(<span class="hljs-string">&quot;DriverManager.initialize: jdbc.drivers = &quot;</span> + drivers);<br><br>    	<span class="hljs-comment">// 2）使用 jdbc.drivers 定义的驱动名加载驱动</span><br>       <span class="hljs-keyword">if</span> (drivers == <span class="hljs-literal">null</span> || drivers.equals(<span class="hljs-string">&quot;&quot;</span>)) &#123;<br>           <span class="hljs-keyword">return</span>;<br>       &#125;<br>       String[] driversList = drivers.split(<span class="hljs-string">&quot;:&quot;</span>);<br>       println(<span class="hljs-string">&quot;number of Drivers:&quot;</span> + driversList.length);<br>       <span class="hljs-keyword">for</span> (String aDriver : driversList) &#123;<br>           <span class="hljs-keyword">try</span> &#123;<br>               println(<span class="hljs-string">&quot;DriverManager.Initialize: loading &quot;</span> + aDriver);<br>               <br>               <span class="hljs-comment">// 这里的 ClassLoader.getSystemClassLoader() 就是应用程序类加载器</span><br>               Class.forName(aDriver, <span class="hljs-literal">true</span>, ClassLoader.getSystemClassLoader());<br>           &#125; <span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>               println(<span class="hljs-string">&quot;DriverManager.Initialize: load failed: &quot;</span> + ex);<br>           &#125;<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure>



<p>先看 2）发现它最后是使用 Class.forName 完成类的加载和初始化，关联的是应用程序类加载器，因此 可以顺利完成类加载 </p>
<p>再看 1）它就是大名鼎鼎的<code> Service Provider Interface</code> （SPI） </p>
<p>​			   约定如下，在 jar 包的 META-INF&#x2F;services 包下，以<strong>接口全限定名</strong> 为文件名，<strong>文件内容</strong> 是实现类的全类名</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220814214332040.png" srcset="/img/loading.gif" lazyload alt="image-20220814214332040"></p>
<hr>
<p>这样就可以使用</p>
<p>接口类型jdk已经实现好了，这里是找到java.sql.Driver文件，读取里面所有的实现类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">ServiceLoader&lt;接口类型&gt; allImpls = ServiceLoader.load(接口类型.class);<br>    Iterator&lt;接口类型&gt; iter = allImpls.iterator();<br>    <span class="hljs-keyword">while</span>(iter.hasNext()) &#123;<br>        iter.next();<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>来得到实现类，体现的是【面向接口编程+解耦】的思想，在下面一些框架中都运用了此思想：</p>
<p> JDBC </p>
<p>Servlet 初始化器 </p>
<p>Spring 容器 </p>
<p>Dubbo（对 SPI 进行了扩展）</p>
<p>接着看 <code>ServiceLoader.load</code> 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;S&gt; ServiceLoader&lt;S&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(Class&lt;S&gt; service)</span> &#123;<br>    <span class="hljs-comment">// 获取线程上下文类加载器</span><br>    <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">cl</span> <span class="hljs-operator">=</span> Thread.currentThread().getContextClassLoader();<br>    <span class="hljs-keyword">return</span> ServiceLoader.load(service, cl);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>线程上下文类加载器是当前线程使用的类加载器，默认就是应用程序类加载器</p>
<p>它内部又是由 Class.forName 调用了线程上下文类加载器完成类加载，具体代码在 ServiceLoader 的内部类 LazyIterator 中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> S <span class="hljs-title function_">nextService</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">if</span> (!hasNextService())<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoSuchElementException</span>();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cn</span> <span class="hljs-operator">=</span> nextName;<br>            nextName = <span class="hljs-literal">null</span>;<br>            Class&lt;?&gt; c = <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">//这里的loader就是 线程上下文加载器所持有的加载器【App】</span><br>                <span class="hljs-comment">//通过应用类加载器，加载所有的实现类 cn是类名</span><br>                c = Class.forName(cn, <span class="hljs-literal">false</span>, loader);<br>            &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException x) &#123;<br>                fail(service,<br>                     <span class="hljs-string">&quot;Provider &quot;</span> + cn + <span class="hljs-string">&quot; not found&quot;</span>);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (!service.isAssignableFrom(c)) &#123;<br>                fail(service,<br>                     <span class="hljs-string">&quot;Provider &quot;</span> + cn  + <span class="hljs-string">&quot; not a subtype&quot;</span>);<br>            &#125;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">S</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> service.cast(c.newInstance());<br>                providers.put(cn, p);<br>                <span class="hljs-keyword">return</span> p;<br>            &#125; <span class="hljs-keyword">catch</span> (Throwable x) &#123;<br>                fail(service,<br>                     <span class="hljs-string">&quot;Provider &quot;</span> + cn + <span class="hljs-string">&quot; could not be instantiated&quot;</span>,<br>                     x);<br>            &#125;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>();          <span class="hljs-comment">// This cannot happen</span><br>        &#125;<br></code></pre></td></tr></table></figure>



<h3 id="5-5-自定义类加载器"><a href="#5-5-自定义类加载器" class="headerlink" title="5.5 自定义类加载器"></a>5.5 自定义类加载器</h3><p>问问自己，什么时候需要自定义类加载器 </p>
<p>1）想加载 非 <code>classpath </code>、非<code>jre/lib </code> 、非 <code>jre/lib/ext</code>  随意路径中的类文件 </p>
<p>2）都是通过接口来使用实现，希望解耦时，常用在框架设计 </p>
<p>3）这些类希望予以隔离，不同应用的同名类都可以加载，不冲突，常见于 tomcat 容器【一个类有 新旧两个版本，但希望其能同时工作】</p>
<p>步骤： </p>
<ol>
<li>继承 ClassLoader 父类</li>
<li>要<strong>遵从双亲委派机制</strong>，<strong>重写 findClass 方法</strong><br> 注意  不是  重写<code> loadClass 方法</code>，否则不会走双亲委派机制</li>
<li>在findClass方法中 读取类文件的字节码，一般是字节数组</li>
<li>调用父类的 defineClass 方法来加载类</li>
<li>使用者调用该类加载器的 loadClass 方法</li>
</ol>
<p>类 HelloWorld</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloWorld</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Hello World init.....&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>自定义类加载器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClassLoader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ClassLoader</span> &#123;<br><br>    <span class="hljs-meta">@Override</span> <span class="hljs-comment">// name 就是类名称</span><br>    <span class="hljs-keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;D:\\Temp\\&quot;</span> + name + <span class="hljs-string">&quot;.class&quot;</span>;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">os</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>            <span class="hljs-comment">//读取字节码文件成为流</span><br>            Files.copy(Paths.get(path), os);<br><br>            <span class="hljs-comment">// 得到字节数组</span><br>            <span class="hljs-type">byte</span>[] bytes = os.toByteArray();<br><br>            <span class="hljs-comment">// byte[] -&gt; *.class</span><br>            <span class="hljs-keyword">return</span> defineClass(name, bytes, <span class="hljs-number">0</span>, bytes.length);<br><br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassNotFoundException</span>(<span class="hljs-string">&quot;类文件未找到&quot;</span>, e);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>调用自定义类加载器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t3.load;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Load7</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">MyClassLoader</span> <span class="hljs-variable">classLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyClassLoader</span>();<br>        Class&lt;?&gt; c1 = classLoader.loadClass(<span class="hljs-string">&quot;HelloWorld&quot;</span>);<span class="hljs-comment">//当一个类被加载过一次后，它就会被缓存到类加载器中</span><br>        Class&lt;?&gt; c2 = classLoader.loadClass(<span class="hljs-string">&quot;HelloWorld&quot;</span>);<span class="hljs-comment">//上面有缓存，所以是同一个对象</span><br>        System.out.println(c1 == c2);<span class="hljs-comment">//true</span><br><br>        <span class="hljs-type">MyClassLoader</span> <span class="hljs-variable">classLoader2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyClassLoader</span>();<span class="hljs-comment">//不同的类加载器对象</span><br>        Class&lt;?&gt; c3 = classLoad er2.loadClass(<span class="hljs-string">&quot;HelloWorld&quot;</span>);<br>        System.out.println(c1 == c3);<span class="hljs-comment">//false 只有当包名类名相同时，且是同一个类加载器对象时，类对象才相同</span><br><br>        c1.newInstance();<span class="hljs-comment">//反射调用无参构造</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-literal">true</span><br><span class="hljs-literal">false</span><br>Hello World <span class="hljs-keyword">init</span>.....<br></code></pre></td></tr></table></figure>



<h2 id="6-运行期优化"><a href="#6-运行期优化" class="headerlink" title="6. 运行期优化"></a>6. 运行期优化</h2><h3 id="6-1-即时编译"><a href="#6-1-即时编译" class="headerlink" title="6.1 即时编译"></a>6.1 即时编译</h3><p>分层编译（TieredCompilation）</p>
<p>先来个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t3.jit;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JIT1</span> &#123;<br><br>    <span class="hljs-comment">// -XX:+PrintCompilation -XX:-DoEscapeAnalysis</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">200</span>; i++) &#123;<br>            <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.nanoTime();<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">1000</span>; j++) &#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br>            &#125;<br>            <span class="hljs-type">long</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> System.nanoTime();<br>            System.out.printf(<span class="hljs-string">&quot;%d\t%d\n&quot;</span>,i,(end - start));<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-number">0	39099</span><br><span class="hljs-number">1	45099</span><br><span class="hljs-number">2	44200</span><br><span class="hljs-number">3	41500</span><br>..........<br><span class="hljs-number">62	43399</span><br><span class="hljs-number">63	42700</span><br><span class="hljs-number">64	13899</span><br><span class="hljs-number">65	10001</span><br><span class="hljs-number">66	11300</span><br><span class="hljs-number">67	10199</span><br><span class="hljs-number">68	10901</span><br><span class="hljs-number">69	16100</span><br><span class="hljs-number">70	10901</span><br><span class="hljs-number">71	24100</span><br><span class="hljs-number">72	10800</span><br><span class="hljs-number">73	10400</span><br><span class="hljs-number">74	10399</span><br><span class="hljs-number">75	11200</span><br><span class="hljs-number">76	10299</span><br><span class="hljs-number">77</span>	<span class="hljs-number">7900</span><br><span class="hljs-number">78</span>	<span class="hljs-number">6700</span><br><span class="hljs-number">79</span>	<span class="hljs-number">6401</span><br><span class="hljs-number">80</span>	<span class="hljs-number">5699</span><br><span class="hljs-number">81</span>	<span class="hljs-number">6400</span><br><span class="hljs-number">82</span>	<span class="hljs-number">6700</span><br><span class="hljs-number">83</span>	<span class="hljs-number">6601</span><br><span class="hljs-number">84</span>	<span class="hljs-number">6000</span><br><span class="hljs-number">85	12200</span><br><span class="hljs-number">86	12400</span><br><span class="hljs-number">87</span>	<span class="hljs-number">9701</span><br>........<br><span class="hljs-number">114	9799</span><br><span class="hljs-number">115	8500</span><br><span class="hljs-number">116	9899</span><br><span class="hljs-number">117	10200</span><br><span class="hljs-number">118	11299</span><br><span class="hljs-number">119	9999</span><br><span class="hljs-number">120	11700</span><br><span class="hljs-number">121	10000</span><br><span class="hljs-number">122	8901</span><br><span class="hljs-number">123	7100</span><br><span class="hljs-number">124	10600</span><br><span class="hljs-number">125	9400</span><br><span class="hljs-number">126	11000</span><br><span class="hljs-number">127	11601</span><br><span class="hljs-number">128	13200</span><br><span class="hljs-number">129	11900</span><br><span class="hljs-number">130	8599</span><br><span class="hljs-number">131	8600</span><br><span class="hljs-number">132	9900</span><br><span class="hljs-number">133	9400</span><br><span class="hljs-number">134	13500</span><br><span class="hljs-number">135	12500</span><br><span class="hljs-number">136	12300</span><br><span class="hljs-number">137	12400</span><br><span class="hljs-number">138	12100</span><br>........<br><span class="hljs-number">173	300</span><br><span class="hljs-number">174	200</span><br><span class="hljs-number">175	200</span><br><span class="hljs-number">176	300</span><br><span class="hljs-number">177	300</span><br><span class="hljs-number">178	300</span><br><span class="hljs-number">179	200</span><br><span class="hljs-number">180	600</span><br><span class="hljs-number">181	600</span><br><span class="hljs-number">182	600</span><br><span class="hljs-number">183	599</span><br><span class="hljs-number">184	600</span><br><span class="hljs-number">185	699</span><br><span class="hljs-number">186	600</span><br><span class="hljs-number">187	500</span><br><span class="hljs-number">188	600</span><br><span class="hljs-number">189	601</span><br><span class="hljs-number">190	599</span><br><span class="hljs-number">191	600</span><br><span class="hljs-number">192	700</span><br><span class="hljs-number">193	600</span><br><span class="hljs-number">194	601</span><br><span class="hljs-number">195	699</span><br><span class="hljs-number">196	600</span><br><span class="hljs-number">197	600</span><br><span class="hljs-number">198	600</span><br><span class="hljs-number">199	700</span><br></code></pre></td></tr></table></figure>



<p>原因是什么呢？ </p>
<p>JVM 将执行状态分成了 5 个层次： </p>
<p>0 层，解释执行（Interpreter） </p>
<p>1 层，使用 C1 即时编译器编译执行（不带 profiling） </p>
<p>2 层，使用 C1 即时编译器编译执行（带基本的 profiling） </p>
<p>3 层，使用 C1 即时编译器编译执行（带完全的 profiling） </p>
<p>4 层，使用 C2 即时编译器编译执行 </p>
<p>注意：profiling 是指在运行过程中收集一些程序执行状态的数据，例如【方法的调用次数】，【循环的 回边次数】等</p>
<p>即时编译器（JIT）与解释器的区别 </p>
<p>解释器是将字节码解释为机器码，下次即使遇到相同的字节码，仍会执行重复的解释 </p>
<p>JIT 是将一些字节码编译为机器码，并存入<code> Code Cache</code>（代码缓存），下次遇到相同的代码，直接执行，无需 再编译 </p>
<p>解释器是将字节码解释为针对所有  <strong>平台都通用的机器码</strong> </p>
<p>JIT 会根据平台类型，生成<strong>平台特定的机器码</strong> </p>
<p>对于占据大部分的不常用的代码，我们无需耗费时间将其编译成机器码，而是采取  <strong>解释执行</strong>  的方式运 行；</p>
<p>另一方面，对于仅占据小部分的热点代码，我们则可以将其编译成机器码，以达到理想的运行速 度</p>
<p> 执行效率上简单比较一下<code> Interpreter &lt; C1(5倍) &lt; C2（10到100倍）</code>，<strong>总的目标是发现热点代码</strong>（hotspot名称的由 来），优化之</p>
<p>刚才的一种优化手段称之为【逃逸分析】</p>
<p>发现新建的对象是否逃逸出多次循环的作用范围（被这个循环外的方法或变量所引用），如果没有直接不进行该对象的创建</p>
<p>可以使用 <code>-XX:- DoEscapeAnalysis </code>关闭逃逸分析，再运行刚才的示例观察结果</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-number">0	34800</span><br><span class="hljs-number">1	31000</span><br><span class="hljs-number">2	30300</span><br><span class="hljs-number">3	29900</span><br>.........<br><span class="hljs-number">60	32300</span><br><span class="hljs-number">61	31700</span><br><span class="hljs-number">62	32100</span><br><span class="hljs-number">63	43001</span><br><span class="hljs-number">64	10700</span><br>........<br><span class="hljs-number">101	49500</span><br><span class="hljs-number">102	10699</span><br><span class="hljs-number">103	8600</span><br><span class="hljs-number">104	9901</span><br><span class="hljs-number">105	10600</span><br><span class="hljs-number">106	10701</span><br><span class="hljs-number">107	31699</span><br><span class="hljs-number">108	11300</span><br><span class="hljs-number">109	11300</span><br><span class="hljs-number">110	11800</span><br><span class="hljs-number">111	8001</span><br><span class="hljs-number">112	10201</span><br><span class="hljs-number">113	7200</span><br><span class="hljs-number">114	6499</span><br><span class="hljs-number">115	5701</span><br><span class="hljs-number">116	6400</span><br><span class="hljs-number">117	6399</span><br><span class="hljs-number">118	11700</span><br><span class="hljs-number">119	10000</span><br><span class="hljs-number">120	6800</span><br><span class="hljs-number">121	6500</span><br><span class="hljs-number">136	5600</span><br><span class="hljs-number">137	5199</span><br><span class="hljs-number">138	6000</span><br>........<br><span class="hljs-number">193	5801</span><br><span class="hljs-number">194	5100</span><br><span class="hljs-number">195	6099</span><br><span class="hljs-number">196	5601</span><br><span class="hljs-number">197	5800</span><br><span class="hljs-number">198	5400</span><br><span class="hljs-number">199	5400</span><br></code></pre></td></tr></table></figure>

<p>最快也是千纳秒级别，关闭逃逸分析前最快可达百纳秒级别</p>
<p>参考资料：</p>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/12/vm/java-hotspot-virtual-machine-performance-enhancements.html#GUID-D2E3DC58-D18B-4A6C-8167-4A1DFB4888E4">Java HotSpot Virtual Machine Performance Enhancements (oracle.com)</a></p>
<p><strong>方法内联 （Inlining）</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">square</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-type">int</span> i)</span> &#123;<br>    <span class="hljs-keyword">return</span> i * i;<br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">System.out.println(square(<span class="hljs-number">9</span>));<br></code></pre></td></tr></table></figure>



<p>如果发现 square 是热点方法，并且长度不太长时，会进行内联，所谓的内联就是把方法内代码拷贝、 粘贴到调用者的位置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">System.out.println(<span class="hljs-number">9</span> * <span class="hljs-number">9</span>);<br></code></pre></td></tr></table></figure>



<p>还能够进行常量折叠（constant folding）的优化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">System.out.println(<span class="hljs-number">81</span>);<span class="hljs-number">3</span><br></code></pre></td></tr></table></figure>







<p>例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t3.jit;<br><br><span class="hljs-keyword">import</span> java.util.Random;<br><span class="hljs-keyword">import</span> java.util.concurrent.ThreadLocalRandom;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JIT2</span> &#123;<br>    <span class="hljs-comment">// -XX:+UnlockDiagnosticVMOptions -XX:+PrintInlining -XX:CompileCommand=dontinline,*JIT2.square</span><br>    <span class="hljs-comment">// -XX:+PrintCompilation</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><br>        <span class="hljs-type">int</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">500</span>; i++) &#123;<br>            <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.nanoTime();<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">1000</span>; j++) &#123;<br>                x = square(<span class="hljs-number">9</span>);<br><br>            &#125;<br>            <span class="hljs-type">long</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> System.nanoTime();<br>            System.out.printf(<span class="hljs-string">&quot;%d\t%d\t%d\n&quot;</span>,i,x,(end - start));<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">square</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-type">int</span> i)</span> &#123;<br>        <span class="hljs-keyword">return</span> i * i;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">0</span>	<span class="hljs-number">81</span>	<span class="hljs-number">22800</span><br><span class="hljs-attribute">1</span>	<span class="hljs-number">81</span>	<span class="hljs-number">28600</span><br><span class="hljs-attribute">56</span>	<span class="hljs-number">81</span>	<span class="hljs-number">27900</span><br><span class="hljs-attribute">57</span>	<span class="hljs-number">81</span>	<span class="hljs-number">28800</span><br><span class="hljs-attribute">58</span>	<span class="hljs-number">81</span>	<span class="hljs-number">29400</span><br><span class="hljs-attribute">59</span>	<span class="hljs-number">81</span>	<span class="hljs-number">26500</span><br><span class="hljs-attribute">60</span>	<span class="hljs-number">81</span>	<span class="hljs-number">32300</span><br><span class="hljs-attribute">61</span>	<span class="hljs-number">81</span>	<span class="hljs-number">22000</span><br><span class="hljs-attribute">62</span>	<span class="hljs-number">81</span>	<span class="hljs-number">24900</span><br><span class="hljs-attribute">63</span>	<span class="hljs-number">81</span>	<span class="hljs-number">29100</span><br><span class="hljs-attribute">64</span>	<span class="hljs-number">81</span>	<span class="hljs-number">22800</span><br><span class="hljs-attribute">65</span>	<span class="hljs-number">81</span>	<span class="hljs-number">8700</span><br><span class="hljs-attribute">101</span>	<span class="hljs-number">81</span>	<span class="hljs-number">8000</span><br><span class="hljs-attribute">102</span>	<span class="hljs-number">81</span>	<span class="hljs-number">3700</span><br><span class="hljs-attribute">103</span>	<span class="hljs-number">81</span>	<span class="hljs-number">3200</span><br><span class="hljs-attribute">104</span>	<span class="hljs-number">81</span>	<span class="hljs-number">1700</span><br><span class="hljs-attribute">105</span>	<span class="hljs-number">81</span>	<span class="hljs-number">1700</span><br><span class="hljs-attribute">106</span>	<span class="hljs-number">81</span>	<span class="hljs-number">1700</span><br><span class="hljs-attribute">107</span>	<span class="hljs-number">81</span>	<span class="hljs-number">2500</span><br><span class="hljs-attribute">108</span>	<span class="hljs-number">81</span>	<span class="hljs-number">3200</span><br><span class="hljs-attribute">109</span>	<span class="hljs-number">81</span>	<span class="hljs-number">1700</span><br><span class="hljs-attribute">110</span>	<span class="hljs-number">81</span>	<span class="hljs-number">2700</span><br><span class="hljs-attribute">111</span>	<span class="hljs-number">81</span>	<span class="hljs-number">1800</span><br><span class="hljs-attribute">112</span>	<span class="hljs-number">81</span>	<span class="hljs-number">1700</span><br><span class="hljs-attribute">113</span>	<span class="hljs-number">81</span>	<span class="hljs-number">1800</span><br><span class="hljs-attribute">114</span>	<span class="hljs-number">81</span>	<span class="hljs-number">1700</span><br><span class="hljs-attribute">115</span>	<span class="hljs-number">81</span>	<span class="hljs-number">4400</span><br><span class="hljs-attribute">116</span>	<span class="hljs-number">81</span>	<span class="hljs-number">3300</span><br><span class="hljs-attribute">117</span>	<span class="hljs-number">81</span>	<span class="hljs-number">3200</span><br><span class="hljs-attribute">118</span>	<span class="hljs-number">81</span>	<span class="hljs-number">4800</span><br><span class="hljs-attribute">119</span>	<span class="hljs-number">81</span>	<span class="hljs-number">2900</span><br><span class="hljs-attribute">120</span>	<span class="hljs-number">81</span>	<span class="hljs-number">3200</span><br><span class="hljs-attribute">121</span>	<span class="hljs-number">81</span>	<span class="hljs-number">3300</span><br><span class="hljs-attribute">122</span>	<span class="hljs-number">81</span>	<span class="hljs-number">1800</span><br><span class="hljs-attribute">123</span>	<span class="hljs-number">81</span>	<span class="hljs-number">1700</span><br><span class="hljs-attribute">150</span>	<span class="hljs-number">81</span>	<span class="hljs-number">4800</span><br><span class="hljs-attribute">151</span>	<span class="hljs-number">81</span>	<span class="hljs-number">2700</span><br><span class="hljs-attribute">152</span>	<span class="hljs-number">81</span>	<span class="hljs-number">1700</span><br><span class="hljs-attribute">153</span>	<span class="hljs-number">81</span>	<span class="hljs-number">1800</span><br><span class="hljs-attribute">154</span>	<span class="hljs-number">81</span>	<span class="hljs-number">1800</span><br><span class="hljs-attribute">155</span>	<span class="hljs-number">81</span>	<span class="hljs-number">1700</span><br><span class="hljs-attribute">156</span>	<span class="hljs-number">81</span>	<span class="hljs-number">1700</span><br><span class="hljs-attribute">157</span>	<span class="hljs-number">81</span>	<span class="hljs-number">1800</span><br><span class="hljs-attribute">158</span>	<span class="hljs-number">81</span>	<span class="hljs-number">3200</span><br><span class="hljs-attribute">159</span>	<span class="hljs-number">81</span>	<span class="hljs-number">4600</span><br><span class="hljs-attribute">160</span>	<span class="hljs-number">81</span>	<span class="hljs-number">3200</span><br><span class="hljs-attribute">161</span>	<span class="hljs-number">81</span>	<span class="hljs-number">3200</span><br><span class="hljs-attribute">162</span>	<span class="hljs-number">81</span>	<span class="hljs-number">3300</span><br><span class="hljs-attribute">163</span>	<span class="hljs-number">81</span>	<span class="hljs-number">3300</span><br><span class="hljs-attribute">164</span>	<span class="hljs-number">81</span>	<span class="hljs-number">3200</span><br><span class="hljs-attribute">165</span>	<span class="hljs-number">81</span>	<span class="hljs-number">3400</span><br><span class="hljs-attribute">166</span>	<span class="hljs-number">81</span>	<span class="hljs-number">3300</span><br><span class="hljs-attribute">167</span>	<span class="hljs-number">81</span>	<span class="hljs-number">50100</span><br><span class="hljs-attribute">168</span>	<span class="hljs-number">81</span>	<span class="hljs-number">15200</span><br><span class="hljs-attribute">169</span>	<span class="hljs-number">81</span>	<span class="hljs-number">0</span><br><span class="hljs-attribute">170</span>	<span class="hljs-number">81</span>	<span class="hljs-number">28400</span><br><span class="hljs-attribute">171</span>	<span class="hljs-number">81</span>	<span class="hljs-number">31600</span><br><span class="hljs-attribute">172</span>	<span class="hljs-number">81</span>	<span class="hljs-number">28900</span><br><span class="hljs-attribute">173</span>	<span class="hljs-number">81</span>	<span class="hljs-number">27900</span><br><span class="hljs-attribute">174</span>	<span class="hljs-number">81</span>	<span class="hljs-number">28300</span><br><span class="hljs-attribute">175</span>	<span class="hljs-number">81</span>	<span class="hljs-number">28600</span><br><span class="hljs-attribute">176</span>	<span class="hljs-number">81</span>	<span class="hljs-number">29000</span><br><span class="hljs-attribute">177</span>	<span class="hljs-number">81</span>	<span class="hljs-number">28300</span><br><span class="hljs-attribute">178</span>	<span class="hljs-number">81</span>	<span class="hljs-number">27300</span><br><span class="hljs-attribute">179</span>	<span class="hljs-number">81</span>	<span class="hljs-number">28800</span><br><span class="hljs-attribute">180</span>	<span class="hljs-number">81</span>	<span class="hljs-number">13100</span><br><span class="hljs-attribute">279</span>	<span class="hljs-number">81</span>	<span class="hljs-number">3400</span><br><span class="hljs-attribute">280</span>	<span class="hljs-number">81</span>	<span class="hljs-number">3400</span><br><span class="hljs-attribute">281</span>	<span class="hljs-number">81</span>	<span class="hljs-number">2900</span><br><span class="hljs-attribute">343</span>	<span class="hljs-number">81</span>	<span class="hljs-number">100</span><br><span class="hljs-attribute">344</span>	<span class="hljs-number">81</span>	<span class="hljs-number">0</span><br><span class="hljs-attribute">345</span>	<span class="hljs-number">81</span>	<span class="hljs-number">100</span><br><span class="hljs-attribute">346</span>	<span class="hljs-number">81</span>	<span class="hljs-number">0</span><br><span class="hljs-attribute">347</span>	<span class="hljs-number">81</span>	<span class="hljs-number">0</span><br><span class="hljs-attribute">348</span>	<span class="hljs-number">81</span>	<span class="hljs-number">100</span><br><span class="hljs-attribute">349</span>	<span class="hljs-number">81</span>	<span class="hljs-number">0</span><br><span class="hljs-attribute">350</span>	<span class="hljs-number">81</span>	<span class="hljs-number">0</span><br><span class="hljs-attribute">351</span>	<span class="hljs-number">81</span>	<span class="hljs-number">100</span><br><span class="hljs-attribute">352</span>	<span class="hljs-number">81</span>	<span class="hljs-number">0</span><br><span class="hljs-attribute">353</span>	<span class="hljs-number">81</span>	<span class="hljs-number">100</span><br><span class="hljs-attribute">354</span>	<span class="hljs-number">81</span>	<span class="hljs-number">0</span><br><span class="hljs-attribute">355</span>	<span class="hljs-number">81</span>	<span class="hljs-number">100</span><br><span class="hljs-attribute">356</span>	<span class="hljs-number">81</span>	<span class="hljs-number">0</span><br><span class="hljs-attribute">357</span>	<span class="hljs-number">81</span>	<span class="hljs-number">0</span><br><span class="hljs-attribute">358</span>	<span class="hljs-number">81</span>	<span class="hljs-number">0</span><br><span class="hljs-attribute">359</span>	<span class="hljs-number">81</span>	<span class="hljs-number">0</span><br><span class="hljs-attribute">392</span>	<span class="hljs-number">81</span>	<span class="hljs-number">0</span><br><span class="hljs-attribute">393</span>	<span class="hljs-number">81</span>	<span class="hljs-number">100</span><br><span class="hljs-attribute">394</span>	<span class="hljs-number">81</span>	<span class="hljs-number">0</span><br><span class="hljs-attribute">458</span>	<span class="hljs-number">81</span>	<span class="hljs-number">0</span><br><span class="hljs-attribute">459</span>	<span class="hljs-number">81</span>	<span class="hljs-number">100</span><br><span class="hljs-attribute">460</span>	<span class="hljs-number">81</span>	<span class="hljs-number">100</span><br><span class="hljs-attribute">461</span>	<span class="hljs-number">81</span>	<span class="hljs-number">0</span><br><span class="hljs-attribute">462</span>	<span class="hljs-number">81</span>	<span class="hljs-number">100</span><br><span class="hljs-attribute">463</span>	<span class="hljs-number">81</span>	<span class="hljs-number">0</span><br><span class="hljs-attribute">498</span>	<span class="hljs-number">81</span>	<span class="hljs-number">100</span><br><span class="hljs-attribute">499</span>	<span class="hljs-number">81</span>	<span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>





<p>添加虚拟机参数：打印所有内联方法的相关信息</p>
<p><code>-XX:+UnlockDiagnosticVMOptions -XX:+PrintInlining</code></p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220816221706017.png" srcset="/img/loading.gif" lazyload alt="image-20220816221706017"></p>
<hr>
<p>禁止某个<code>inlining</code> 内联方法 ：</p>
<p><code>-XX:CompileCommand=dontinline,*JIT2.square</code></p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">0</span>	<span class="hljs-number">81</span>	<span class="hljs-number">27600</span><br><span class="hljs-attribute">1</span>	<span class="hljs-number">81</span>	<span class="hljs-number">27800</span><br><span class="hljs-attribute">2</span>	<span class="hljs-number">81</span>	<span class="hljs-number">23800</span><br><span class="hljs-attribute">3</span>	<span class="hljs-number">81</span>	<span class="hljs-number">22600</span><br><span class="hljs-attribute">4</span>	<span class="hljs-number">81</span>	<span class="hljs-number">22600</span><br><span class="hljs-attribute">5</span>	<span class="hljs-number">81</span>	<span class="hljs-number">22600</span><br><span class="hljs-attribute">23</span>	<span class="hljs-number">81</span>	<span class="hljs-number">22700</span><br><span class="hljs-attribute">43</span>	<span class="hljs-number">81</span>	<span class="hljs-number">20000</span><br><span class="hljs-attribute">62</span>	<span class="hljs-number">81</span>	<span class="hljs-number">23200</span><br><span class="hljs-attribute">63</span>	<span class="hljs-number">81</span>	<span class="hljs-number">22600</span><br><span class="hljs-attribute">64</span>	<span class="hljs-number">81</span>	<span class="hljs-number">24000</span><br><span class="hljs-attribute">65</span>	<span class="hljs-number">81</span>	<span class="hljs-number">28500</span><br><span class="hljs-attribute">66</span>	<span class="hljs-number">81</span>	<span class="hljs-number">8700</span><br><span class="hljs-attribute">67</span>	<span class="hljs-number">81</span>	<span class="hljs-number">2200</span><br><span class="hljs-attribute">68</span>	<span class="hljs-number">81</span>	<span class="hljs-number">2200</span><br><span class="hljs-attribute">69</span>	<span class="hljs-number">81</span>	<span class="hljs-number">3300</span><br><span class="hljs-attribute">70</span>	<span class="hljs-number">81</span>	<span class="hljs-number">4300</span><br><span class="hljs-attribute">71</span>	<span class="hljs-number">81</span>	<span class="hljs-number">4200</span><br><span class="hljs-attribute">72</span>	<span class="hljs-number">81</span>	<span class="hljs-number">4300</span><br><span class="hljs-attribute">73</span>	<span class="hljs-number">81</span>	<span class="hljs-number">4200</span><br><span class="hljs-attribute">74</span>	<span class="hljs-number">81</span>	<span class="hljs-number">2200</span><br><span class="hljs-attribute">75</span>	<span class="hljs-number">81</span>	<span class="hljs-number">2200</span><br><span class="hljs-attribute">76</span>	<span class="hljs-number">81</span>	<span class="hljs-number">2200</span><br><span class="hljs-attribute">77</span>	<span class="hljs-number">81</span>	<span class="hljs-number">6200</span><br><span class="hljs-attribute">78</span>	<span class="hljs-number">81</span>	<span class="hljs-number">4100</span><br><span class="hljs-attribute">79</span>	<span class="hljs-number">81</span>	<span class="hljs-number">2200</span><br><span class="hljs-attribute">80</span>	<span class="hljs-number">81</span>	<span class="hljs-number">2200</span><br><span class="hljs-attribute">81</span>	<span class="hljs-number">81</span>	<span class="hljs-number">2200</span><br><span class="hljs-attribute">82</span>	<span class="hljs-number">81</span>	<span class="hljs-number">4200</span><br><span class="hljs-attribute">83</span>	<span class="hljs-number">81</span>	<span class="hljs-number">2200</span><br><span class="hljs-attribute">84</span>	<span class="hljs-number">81</span>	<span class="hljs-number">2200</span><br><span class="hljs-attribute">85</span>	<span class="hljs-number">81</span>	<span class="hljs-number">3200</span><br><span class="hljs-attribute">86</span>	<span class="hljs-number">81</span>	<span class="hljs-number">2200</span><br><span class="hljs-attribute">319</span>	<span class="hljs-number">81</span>	<span class="hljs-number">2600</span><br><span class="hljs-attribute">320</span>	<span class="hljs-number">81</span>	<span class="hljs-number">2200</span><br><span class="hljs-attribute">321</span>	<span class="hljs-number">81</span>	<span class="hljs-number">2600</span><br><span class="hljs-attribute">322</span>	<span class="hljs-number">81</span>	<span class="hljs-number">2300</span><br><span class="hljs-attribute">323</span>	<span class="hljs-number">81</span>	<span class="hljs-number">2700</span><br><span class="hljs-attribute">324</span>	<span class="hljs-number">81</span>	<span class="hljs-number">1700</span><br><span class="hljs-attribute">370</span>	<span class="hljs-number">81</span>	<span class="hljs-number">2700</span><br><span class="hljs-attribute">371</span>	<span class="hljs-number">81</span>	<span class="hljs-number">2600</span><br><span class="hljs-attribute">372</span>	<span class="hljs-number">81</span>	<span class="hljs-number">2800</span><br><span class="hljs-attribute">373</span>	<span class="hljs-number">81</span>	<span class="hljs-number">2700</span><br><span class="hljs-attribute">374</span>	<span class="hljs-number">81</span>	<span class="hljs-number">2600</span><br><span class="hljs-attribute">375</span>	<span class="hljs-number">81</span>	<span class="hljs-number">2700</span><br><span class="hljs-attribute">376</span>	<span class="hljs-number">81</span>	<span class="hljs-number">2800</span><br><span class="hljs-attribute">377</span>	<span class="hljs-number">81</span>	<span class="hljs-number">2600</span><br><span class="hljs-attribute">378</span>	<span class="hljs-number">81</span>	<span class="hljs-number">2700</span><br><span class="hljs-attribute">416</span>	<span class="hljs-number">81</span>	<span class="hljs-number">1700</span><br><span class="hljs-attribute">417</span>	<span class="hljs-number">81</span>	<span class="hljs-number">1700</span><br><span class="hljs-attribute">418</span>	<span class="hljs-number">81</span>	<span class="hljs-number">1700</span><br><span class="hljs-attribute">419</span>	<span class="hljs-number">81</span>	<span class="hljs-number">1700</span><br><span class="hljs-attribute">420</span>	<span class="hljs-number">81</span>	<span class="hljs-number">1700</span><br><span class="hljs-attribute">421</span>	<span class="hljs-number">81</span>	<span class="hljs-number">1700</span><br><span class="hljs-attribute">422</span>	<span class="hljs-number">81</span>	<span class="hljs-number">1700</span><br><span class="hljs-attribute">423</span>	<span class="hljs-number">81</span>	<span class="hljs-number">1700</span><br><span class="hljs-attribute">424</span>	<span class="hljs-number">81</span>	<span class="hljs-number">1700</span><br><span class="hljs-attribute">425</span>	<span class="hljs-number">81</span>	<span class="hljs-number">1700</span><br><span class="hljs-attribute">426</span>	<span class="hljs-number">81</span>	<span class="hljs-number">1700</span><br><span class="hljs-attribute">427</span>	<span class="hljs-number">81</span>	<span class="hljs-number">1700</span><br><span class="hljs-attribute">428</span>	<span class="hljs-number">81</span>	<span class="hljs-number">1700</span><br><span class="hljs-attribute">468</span>	<span class="hljs-number">81</span>	<span class="hljs-number">1700</span><br><span class="hljs-attribute">495</span>	<span class="hljs-number">81</span>	<span class="hljs-number">1700</span><br><span class="hljs-attribute">496</span>	<span class="hljs-number">81</span>	<span class="hljs-number">1700</span><br><span class="hljs-attribute">497</span>	<span class="hljs-number">81</span>	<span class="hljs-number">1700</span><br><span class="hljs-attribute">498</span>	<span class="hljs-number">81</span>	<span class="hljs-number">1700</span><br><span class="hljs-attribute">499</span>	<span class="hljs-number">81</span>	<span class="hljs-number">1700</span><br></code></pre></td></tr></table></figure>

<p>再快也没有到达 0纳秒 的级别</p>
<p><strong>字段优化</strong></p>
<p>JMH 基准测试请参考：<a target="_blank" rel="noopener" href="http://openjdk.java.net/projects/code-tools/jmh/">http://openjdk.java.net/projects/code-tools/jmh/</a> </p>
<p>创建 maven 工程，添加依赖如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;dependency&gt;<br>    &lt;groupId&gt;org.openjdk.jmh&lt;/groupId&gt;<br>    &lt;artifactId&gt;jmh-core&lt;/artifactId&gt;<br>    &lt;version&gt;$&#123;jmh.version&#125;&lt;/version&gt;<br>&lt;/dependency&gt;<br><br>&lt;dependency&gt;<br>    &lt;groupId&gt;org.openjdk.jmh&lt;/groupId&gt;<br>    &lt;artifactId&gt;jmh-generator-annprocess&lt;/artifactId&gt;<br>    &lt;version&gt;$&#123;jmh.version&#125;&lt;/version&gt;<br>    &lt;scope&gt;provided&lt;/scope&gt;<br>&lt;/dependency&gt;<br></code></pre></td></tr></table></figure>



<p>编写基准测试代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> test;<br><br><span class="hljs-keyword">import</span> org.openjdk.jmh.annotations.*;<br><span class="hljs-keyword">import</span> org.openjdk.jmh.runner.Runner;<br><span class="hljs-keyword">import</span> org.openjdk.jmh.runner.RunnerException;<br><span class="hljs-keyword">import</span> org.openjdk.jmh.runner.options.Options;<br><span class="hljs-keyword">import</span> org.openjdk.jmh.runner.options.OptionsBuilder;<br><br><span class="hljs-keyword">import</span> java.util.Random;<br><span class="hljs-keyword">import</span> java.util.concurrent.ThreadLocalRandom;<br><br><span class="hljs-meta">@Warmup(iterations = 2, time = 1)</span><br><span class="hljs-meta">@Measurement(iterations = 5, time = 1)</span><br><span class="hljs-meta">@State(Scope.Benchmark)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Benchmark1</span> &#123;<br><br>    <span class="hljs-type">int</span>[] elements = randomInts(<span class="hljs-number">1_000</span>);<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span>[] randomInts(<span class="hljs-type">int</span> size) &#123;<br>        <span class="hljs-type">Random</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span> ThreadLocalRandom.current();<br>        <span class="hljs-type">int</span>[] values = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[size];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; size; i++) &#123;<br>            values[i] = random.nextInt();<br>        &#125;<br>        <span class="hljs-keyword">return</span> values;<br>    &#125;<br><br>    <span class="hljs-meta">@Benchmark</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test1</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; elements.length; i++) &#123;<br>            doSum(elements[i]);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Benchmark</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test2</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">int</span>[] local = <span class="hljs-built_in">this</span>.elements;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; local.length; i++) &#123;<br>            doSum(local[i]);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Benchmark</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test3</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> element : elements) &#123;<br>            doSum(element);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-meta">@CompilerControl(CompilerControl.Mode.DONT_INLINE)</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doSum</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span> &#123;<br>        sum += x;<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> RunnerException &#123;<br>        <span class="hljs-type">Options</span> <span class="hljs-variable">opt</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OptionsBuilder</span>()<br>                .include(Benchmark1.class.getSimpleName())<br>                .forks(<span class="hljs-number">1</span>)<br>                .build();<br><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Runner</span>(opt).run();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>首先启用 doSum 的方法内联，测试结果如下（每秒吞吐量，分数越高的更好）：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Benchmark</span> Mode Samples Score Score error Units<br><span class="hljs-attribute">t</span>.Benchmark1.test1 thrpt <span class="hljs-number">5</span> <span class="hljs-number">2420286</span>.<span class="hljs-number">539</span> <span class="hljs-number">390747</span>.<span class="hljs-number">467</span> ops/s<br><span class="hljs-attribute">t</span>.Benchmark1.test2 thrpt <span class="hljs-number">5</span> <span class="hljs-number">2544313</span>.<span class="hljs-number">594</span> <span class="hljs-number">91304</span>.<span class="hljs-number">136</span> ops/s<br><span class="hljs-attribute">t</span>.Benchmark1.test3 thrpt <span class="hljs-number">5</span> <span class="hljs-number">2469176</span>.<span class="hljs-number">697</span> <span class="hljs-number">450570</span>.<span class="hljs-number">647</span> ops/s<br></code></pre></td></tr></table></figure>



<p>接下来禁用 doSum 方法内联:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@CompilerControl(CompilerControl.Mode.DONT_INLINE)</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doSum</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span> &#123;<br>    sum += x;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>测试结果如下：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Benchmark</span> Mode Samples Score Score error Units<br><span class="hljs-attribute">t</span>.Benchmark1.test1 thrpt <span class="hljs-number">5</span> <span class="hljs-number">296141</span>.<span class="hljs-number">478</span> <span class="hljs-number">63649</span>.<span class="hljs-number">220</span> ops/s<br><span class="hljs-attribute">t</span>.Benchmark1.test2 thrpt <span class="hljs-number">5</span> <span class="hljs-number">371262</span>.<span class="hljs-number">351</span> <span class="hljs-number">83890</span>.<span class="hljs-number">984</span> ops/s<br><span class="hljs-attribute">t</span>.Benchmark1.test3 thrpt <span class="hljs-number">5</span> <span class="hljs-number">368960</span>.<span class="hljs-number">847</span> <span class="hljs-number">60163</span>.<span class="hljs-number">391</span> ops/s<br></code></pre></td></tr></table></figure>



<p>分析： 在刚才的示例中，doSum 方法是否内联会影响 elements 成员变量读取的优化： </p>
<p>如果 doSum 方法内联了，刚才的 test1 方法会被优化成下面的样子（伪代码）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Benchmark</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test1</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// elements 首次读取会缓存起来 -&gt; int[] local</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; elements.length; i++) &#123; <span class="hljs-comment">// 假设有一千次， 后面的999 次 会直接从局部变量中获取</span><br>        sum += elements[i]; <span class="hljs-comment">// 1000 次取下标 i 的元素 【local】</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以节省 999 次 Field 读取操作 但如果 doSum 方法没有内联，则不会进行上面的优化</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220816224324061.png" srcset="/img/loading.gif" lazyload alt="image-20220816224324061"></p>
<hr>
<p> 练习：在内联情况下将 elements 添加 volatile 修饰符，观察测试结果</p>
<h3 id="6-2-反射优化"><a href="#6-2-反射优化" class="headerlink" title="6.2 反射优化"></a>6.2 反射优化</h3><p>例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t3.reflect;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Reflect1</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">foo</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;foo...&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchMethodException, InvocationTargetException, IllegalAccessException, IOException &#123;<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">foo</span> <span class="hljs-operator">=</span> Reflect1.class.getMethod(<span class="hljs-string">&quot;foo&quot;</span>);<br>        <span class="hljs-comment">//foo.invoke 前面 0 ~ 15 次调用使用的是 MethodAccessor 的 NativeMethodAccessorImpl 实现</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">16</span>; i++) &#123;<br>            System.out.printf(<span class="hljs-string">&quot;%d\t&quot;</span>, i);<br>            foo.invoke(<span class="hljs-literal">null</span>);<br>        &#125;<br>        System.in.read();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220816225238884.png" srcset="/img/loading.gif" lazyload alt="image-20220816225238884"></p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220816225632323.png" srcset="/img/loading.gif" lazyload alt="image-20220816225632323"></p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220816230124824.png" srcset="/img/loading.gif" lazyload alt="image-20220816230124824"></p>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//</span><br><span class="hljs-comment">// Source code recreated from a .class file by IntelliJ IDEA</span><br><span class="hljs-comment">// (powered by FernFlower decompiler)</span><br><span class="hljs-comment">//</span><br><br><span class="hljs-keyword">package</span> sun.reflect;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> sun.reflect.misc.ReflectUtil;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NativeMethodAccessorImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MethodAccessorImpl</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Method method;<br>    <span class="hljs-keyword">private</span> DelegatingMethodAccessorImpl parent;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> numInvocations;<br><br>    NativeMethodAccessorImpl(Method var1) &#123;<br>        <span class="hljs-built_in">this</span>.method = var1;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object var1, Object[] var2)</span> <span class="hljs-keyword">throws</span> IllegalArgumentException, InvocationTargetException &#123;<br>        <span class="hljs-comment">// inflationThreshold 膨胀阈值，默认 15</span><br><br>        <span class="hljs-keyword">if</span> (++<span class="hljs-built_in">this</span>.numInvocations &gt; ReflectionFactory.inflationThreshold() &amp;&amp; !ReflectUtil.isVMAnonymousClass(<span class="hljs-built_in">this</span>.method.getDeclaringClass())) &#123;<br>            <span class="hljs-comment">// 使用 ASM 动态生成的新实现代替本地实现，速度较本地实现快 20 倍左右</span><br>            <span class="hljs-type">MethodAccessorImpl</span> <span class="hljs-variable">var3</span> <span class="hljs-operator">=</span> (MethodAccessorImpl)(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodAccessorGenerator</span>()).generateMethod(<span class="hljs-built_in">this</span>.method.getDeclaringClass(), <span class="hljs-built_in">this</span>.method.getName(), <span class="hljs-built_in">this</span>.method.getParameterTypes(), <span class="hljs-built_in">this</span>.method.getReturnType(), <span class="hljs-built_in">this</span>.method.getExceptionTypes(), <span class="hljs-built_in">this</span>.method.getModifiers());<br>            <span class="hljs-built_in">this</span>.parent.setDelegate(var3);<br>        &#125;<br>		<span class="hljs-comment">// 调用本地实现</span><br>        <span class="hljs-keyword">return</span> invoke0(<span class="hljs-built_in">this</span>.method, var1, var2);<br>    &#125;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setParent</span><span class="hljs-params">(DelegatingMethodAccessorImpl var1)</span> &#123;<br>        <span class="hljs-built_in">this</span>.parent = var1;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> Object <span class="hljs-title function_">invoke0</span><span class="hljs-params">(Method var0, Object var1, Object[] var2)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>该方法 在运行期间动态 生成 <strong>方法访问器</strong>，一段字节码，没有源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">MethodAccessorImpl</span> <span class="hljs-variable">var3</span> <span class="hljs-operator">=</span> (MethodAccessorImpl)(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodAccessorGenerator</span>()).generateMethod(<span class="hljs-built_in">this</span>.method.getDeclaringClass(), <span class="hljs-built_in">this</span>.method.getName(), <span class="hljs-built_in">this</span>.method.getParameterTypes(), <span class="hljs-built_in">this</span>.method.getReturnType(), <span class="hljs-built_in">this</span>.method.getExceptionTypes(), <span class="hljs-built_in">this</span>.method.getModifiers());<br></code></pre></td></tr></table></figure>





<p>当调用到第 16 次（从0开始算）时，会采用运行时生成的类代替掉最初的实现，可以通过 debug 得到 类名为：<code>sun.reflect.GeneratedMethodAccessor1</code></p>
<hr>
<p><img src="C:/Users/fgcy/AppData/Roaming/Typora/typora-user-images/image-20220816231501589.png" srcset="/img/loading.gif" lazyload alt="image-20220816231501589"></p>
<hr>
<p>可以使用阿里的 arthas 工具：</p>
<p>选择 4回车表示分析该进程</p>
<hr>
<p><img src="C:/Users/fgcy/AppData/Roaming/Typora/typora-user-images/image-20220816232157756.png" srcset="/img/loading.gif" lazyload alt="image-20220816232157756"></p>
<hr>
<p><img src="C:/Users/fgcy/AppData/Roaming/Typora/typora-user-images/image-20220816232228938.png" srcset="/img/loading.gif" lazyload alt="image-20220816232228938"></p>
<hr>
<p>再输入【jad + 类名】来进行反编译</p>
<p><img src="C:/Users/fgcy/AppData/Roaming/Typora/typora-user-images/image-20220816232248723.png" srcset="/img/loading.gif" lazyload alt="image-20220816232248723"></p>
<hr>
<p><img src="C:/Users/fgcy/AppData/Roaming/Typora/typora-user-images/image-20220816232305822.png" srcset="/img/loading.gif" lazyload alt="image-20220816232305822"></p>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java">ClassLoader:<br>+-sun.reflect.DelegatingClassLoader@60e53b93<br>  +-sun.misc.Launcher$AppClassLoader@18b4aac2<br>    +-sun.misc.Launcher$ExtClassLoader@12a3a380<br><br>Location:<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Decompiled with CFR.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Could not load the following classes:</span><br><span class="hljs-comment"> *  cn.itcast.jvm.t3.reflect.Reflect1</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">package</span> sun.reflect;<br><br><span class="hljs-keyword">import</span> cn.itcast.jvm.t3.reflect.Reflect1;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> sun.reflect.MethodAccessorImpl;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GeneratedMethodAccessor1</span><br><span class="hljs-keyword">extends</span> <span class="hljs-title class_">MethodAccessorImpl</span> &#123;<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Loose catch block</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object object, Object[] objectArray)</span> <span class="hljs-keyword">throws</span> InvocationTargetException &#123;<br>        <span class="hljs-comment">// 比较奇葩的做法，如果有参数，那么抛非法参数异常</span><br>        block4: &#123;<br>            <span class="hljs-keyword">if</span> (objectArray == <span class="hljs-literal">null</span> || objectArray.length == <span class="hljs-number">0</span>) <span class="hljs-keyword">break</span> block4;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>();<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 可以看到，已经是直接调用了😱😱😱</span><br>            Reflect1.foo();<br>            <span class="hljs-comment">// 因为没有返回值</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Throwable throwable) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvocationTargetException</span>(throwable);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (ClassCastException | NullPointerException runtimeException) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-built_in">super</span>.toString());<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>注意</p>
<p>通过查看 <code>ReflectionFactory</code> 源码可知 </p>
<p><code>sun.reflect.noInflation </code>可以用来禁用膨胀（直接生成 GeneratedMethodAccessor1，但首 次生成比较耗时，如果仅反射调用一次，不划算） <code>sun.reflect.inflationThreshold</code> 可以修改膨胀阈值</p>
<h1 id="七、内存模型"><a href="#七、内存模型" class="headerlink" title="七、内存模型"></a>七、内存模型</h1><h2 id="1-java-内存模型"><a href="#1-java-内存模型" class="headerlink" title="1. java 内存模型"></a>1. java 内存模型</h2><p>很多人将【<code>java 内存结构</code>】与【<code>java 内存模型</code>】傻傻分不清，【java 内存模型】是 Java Memory Model（JMM）的意思。 </p>
<p>关于它的权威解释，请参考:</p>
<p> <a target="_blank" rel="noopener" href="https://download.oracle.com/otn-pub/jcp/memory_model-1.0-pfdspec-oth-JSpec/memory_model-1_0-pfd-spec.pdf?AuthParam=1562811549_4d4994cbd5b59d964cd2907ea22ca08b">https://download.oracle.com/otn-pub/jcp/memory_model-1.0-pfdspec-oth-JSpec/memory_model-1_0-pfd-spec.pdf?AuthParam=1562811549_4d4994cbd5b59d964cd2907ea22ca08b</a></p>
<p> 简单的说，JMM 定义了一套在   <strong>多线程读写共享数据</strong>   时（<strong>成员变量、数组）</strong>时，对数据的  <strong>可见性、有序 性、和原子性</strong>  的<strong>规则和保障</strong></p>
<h3 id="1-1-原子性"><a href="#1-1-原子性" class="headerlink" title="1.1 原子性"></a>1.1 原子性</h3><p>原子性在学习线程时讲过，下面来个例子简单回顾一下： </p>
<p>问题提出，两个线程对初始值为 0 的静态变量一个做自增，一个做自减，各做 5000 次，结果是 0 吗？</p>
<h3 id="1-2-问题分析"><a href="#1-2-问题分析" class="headerlink" title="1.2 问题分析"></a>1.2 问题分析</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t4.avo;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo4_1</span> &#123;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">50000</span>; j++) &#123;<br>                i++;<br>            &#125;<br>        &#125;);<br><br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">50000</span>; j++) &#123;<br>                i--;<br>            &#125;<br>        &#125;);<br>        t1.start();<br>        t2.start();<br><br>        t1.join();<br>        t2.join();<br>        System.out.println(i);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>以上的结果可能是 <strong>正数、负数、零</strong>。为什么呢？</p>
<p>因为 Java 中对静态变量的自增，自减并<strong>不是原子操 作</strong>。 </p>
<p>例如对于 i++ 而言（i 为静态变量），实际会产生如下的 JVM 字节码指令：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">getstatic i <span class="hljs-comment">// 获取静态变量i的值</span><br>iconst_1 <span class="hljs-comment">// 准备常量1</span><br>iadd <span class="hljs-comment">// 加法  【在操作数栈中执行】                      //局部变量的自增是iinc：在槽位上自增</span><br>putstatic i <span class="hljs-comment">// 将修改后的值存入静态变量i</span><br></code></pre></td></tr></table></figure>



<p>而对应 i– 也是类似：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">getstatic i <span class="hljs-comment">// 获取静态变量i的值</span><br>iconst_1 <span class="hljs-comment">// 准备常量1</span><br>isub <span class="hljs-comment">// 减法</span><br>putstatic i <span class="hljs-comment">// 将修改后的值存入静态变量i</span><br></code></pre></td></tr></table></figure>



<p>而 Java 的内存模型如下，完成静态变量的自增，自减需要在主存和线程内存中进行数据交换：</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220816235230885.png" srcset="/img/loading.gif" lazyload alt="image-20220816235230885"></p>
<hr>
<p>如果是单线程以上 8 行代码是顺序执行（不会交错）没有问题：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 假设i的初始值为0</span><br>getstatic i <span class="hljs-comment">// 线程1-获取静态变量i的值 线程内i=0</span><br>iconst_1 <span class="hljs-comment">// 线程1-准备常量1</span><br>iadd <span class="hljs-comment">// 线程1-自增 线程内i=1</span><br>putstatic i <span class="hljs-comment">// 线程1-将修改后的值存入静态变量i 静态变量i=1</span><br>getstatic i <span class="hljs-comment">// 线程1-获取静态变量i的值 线程内i=1</span><br>iconst_1 <span class="hljs-comment">// 线程1-准备常量1</span><br>isub <span class="hljs-comment">// 线程1-自减 线程内i=0</span><br>putstatic i <span class="hljs-comment">// 线程1-将修改后的值存入静态变量i 静态变量i=0</span><br></code></pre></td></tr></table></figure>



<p>但多线程下这 8 行代码可能交错运行（为什么会交错？思考一下）： </p>
<p>出现负数的情况：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 假设i的初始值为0</span><br>getstatic i <span class="hljs-comment">// 线程1-获取静态变量i的值 线程内i=0</span><br>getstatic i <span class="hljs-comment">// 线程2-获取静态变量i的值 线程内i=0</span><br>iconst_1 <span class="hljs-comment">// 线程1-准备常量1</span><br>iadd <span class="hljs-comment">// 线程1-自增 线程内i=1</span><br>putstatic i <span class="hljs-comment">// 线程1-将修改后的值存入静态变量i 静态变量i=1</span><br>iconst_1 <span class="hljs-comment">// 线程2-准备常量1</span><br>isub <span class="hljs-comment">// 线程2-自减 线程内i=-1</span><br>putstatic i <span class="hljs-comment">// 线程2-将修改后的值存入静态变量i 静态变量i=-1</span><br></code></pre></td></tr></table></figure>



<p>出现正数的情况：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 假设i的初始值为0</span><br>getstatic i <span class="hljs-comment">// 线程1-获取静态变量i的值 线程内i=0</span><br>getstatic i <span class="hljs-comment">// 线程2-获取静态变量i的值 线程内i=0</span><br>iconst_1 <span class="hljs-comment">// 线程1-准备常量1</span><br>iadd <span class="hljs-comment">// 线程1-自增 线程内i=1</span><br>iconst_1 <span class="hljs-comment">// 线程2-准备常量1</span><br>isub <span class="hljs-comment">// 线程2-自减 线程内i=-1</span><br>putstatic i <span class="hljs-comment">// 线程2-将修改后的值存入静态变量i 静态变量i=-1</span><br>putstatic i <span class="hljs-comment">// 线程1-将修改后的值存入静态变量i 静态变量i=1</span><br></code></pre></td></tr></table></figure>

<p>多线程下，由于指令交错产生的错误</p>
<h3 id="1-3-解决方法"><a href="#1-3-解决方法" class="headerlink" title="1.3 解决方法"></a>1.3 解决方法</h3><p><code>synchronized </code>（同步关键字）</p>
<p>语法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">synchronized</span>( 对象 ) &#123;<br>    <span class="hljs-comment">//要作为原子操作代码</span><br>&#125;<br></code></pre></td></tr></table></figure>



<p>用 synchronized 解决并发问题：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t4.avo;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo4_1</span> &#123;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">synchronized</span> (obj) &#123;<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">50000</span>; j++) &#123;<br>                    i++; <span class="hljs-comment">//将那四行jvm指令，变成一个原子操作</span><br>                &#125;<br>            &#125;<br>        &#125;);<br><br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">synchronized</span> (obj) &#123;<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">50000</span>; j++) &#123;<br>                    i--; <span class="hljs-comment">//将那四行jvm指令，变成一个原子操作</span><br>                &#125;<br>            &#125;<br>        &#125;);<br>        t1.start();<br>        t2.start();<br><br>        t1.join();<br>        t2.join();<br>        System.out.println(i);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">0<br></code></pre></td></tr></table></figure>

<p>如何理解呢：</p>
<p>你可以把 <strong>obj 想象成一个房间</strong>，<strong>线程 t1，t2 想象成两个人</strong>。</p>
<p>当线程 t1 执行到 synchronized(obj) 时就好比 t1 进入了这个房间，并反手锁住了门，在门内执行 count++ 代码。 </p>
<p>这时候如果 t2 也运行到了 synchronized(obj) 时，它发现门被锁住了，只能在门外等待。 </p>
<p>当 t1 执行完 synchronized{} 块内的代码，这时候才会解开门上的锁，从 obj 房间出来。t2 线程这时才 可以进入 obj 房间，反锁住门，执行它的 count– 代码。</p>
<p>注意：上例中 t1 和 t2 线程必须用 synchronized 锁住同一个 obj 对象，如果 t1 锁住的是 m1 对 象，t2 锁住的是 m2 对象，就好比两个人分别进入了两个不同的房间，没法起到同步的效果。</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220817214853317.png" srcset="/img/loading.gif" lazyload alt="image-20220817214853317"></p>
<hr>
<p>每一个对象都有一块monitor区域，只有当该对象成为内置锁对象时才会生效；</p>
<p>同一个时刻，只能有一个线程，成为该对象的owner，当该线程成为owner后，就会使用一条jvm指令<code>enterMonitor</code>锁住整个对象的monitor，此时再来一个线程想要获取锁对象，就会进入EntryList阻塞；</p>
<p>当t1线程执行完成后要释放锁，就会执行一个jvm指令<code>monitorexist</code>，让EntryList中的线程去抢锁；</p>
<p>waitSet与wait、notify有关</p>
<h2 id="2-可见性"><a href="#2-可见性" class="headerlink" title="2. 可见性"></a>2. 可见性</h2><h3 id="2-1-退不出的循环"><a href="#2-1-退不出的循环" class="headerlink" title="2.1 退不出的循环"></a>2.1 退不出的循环</h3><p>先来看一个现象，main 线程对 run 变量的修改对于 t 线程不可见，导致了 t 线程无法停止：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t4.avo;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo4_2</span> &#123;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">run</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(()-&gt;&#123;<br>            <span class="hljs-keyword">while</span>(run)&#123;<br>                <span class="hljs-comment">// ....</span><br>            &#125;<br>        &#125;);<br>        t.start();<br><br>        Thread.sleep(<span class="hljs-number">1000</span>);<span class="hljs-comment">//一秒后修改静态变量，试图让其停止</span><br>        run = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 线程t不会如预想的停下来</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>不会停止运行</p>
<p>为什么呢？分析一下： </p>
<ol>
<li>初始状态， t 线程刚开始从主内存读取了 run 的值到工作内存。</li>
</ol>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220817220122422.png" srcset="/img/loading.gif" lazyload alt="image-20220817220122422"></p>
<hr>
<ol start="2">
<li>因为 t 线程要频繁从主内存中读取 run 的值，JIT 编译器会将 run 的值缓存至自己工作内存中的高 速缓存中，减少对主存中 run 的访问，提高效率</li>
</ol>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220817220311646.png" srcset="/img/loading.gif" lazyload alt="image-20220817220311646"></p>
<hr>
<ol start="3">
<li>1 秒之后，main 线程修改了 run 的值，<strong>并同步至主存</strong>，而 t 是从自己工作内存中的高速缓存中读 取这个变量的值，结果永远是旧值</li>
</ol>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220817220341388.png" srcset="/img/loading.gif" lazyload alt="image-20220817220341388"></p>
<hr>
<h3 id="2-2-解决方法"><a href="#2-2-解决方法" class="headerlink" title="2.2 解决方法"></a>2.2 解决方法</h3><p>volatile（易变关键字） 它可以用来修饰 <strong>成员变量</strong> 和  <strong>静态成员变量</strong>  ，他可以避免线程从自己的工作缓存中查找变量的值，必须到 主存中获取它的值，线程操作 <strong>volatile 变量都是直接操作主存</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t4.avo;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo4_2</span> &#123;<br><br>    <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">run</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(()-&gt;&#123;<br>            <span class="hljs-keyword">while</span>(run)&#123;<br>                <span class="hljs-comment">// ....</span><br>            &#125;<br>        &#125;);<br>        t.start();<br><br>        Thread.sleep(<span class="hljs-number">1000</span>);<br>        run = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 线程t不会如预想的停下来</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>一秒后结束</p>
<h3 id="2-3-volatile关键字的作用之一：可见性"><a href="#2-3-volatile关键字的作用之一：可见性" class="headerlink" title="2.3 volatile关键字的作用之一：可见性"></a>2.3 volatile关键字的作用之一：可见性</h3><p>前面例子体现的实际就是可见性，它保证的是在多个线程之间，一个线程对 volatile 变量的修改对另一 个线程可见， 不能保证原子性，仅用在一个写线程，多个读线程的情况： </p>
<p>上例从字节码理解是这样的：</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs autoit">getstatic <span class="hljs-built_in">run</span> // 线程 t 获取 <span class="hljs-built_in">run</span> <span class="hljs-literal">true</span><br>getstatic <span class="hljs-built_in">run</span> // 线程 t 获取 <span class="hljs-built_in">run</span> <span class="hljs-literal">true</span><br>getstatic <span class="hljs-built_in">run</span> // 线程 t 获取 <span class="hljs-built_in">run</span> <span class="hljs-literal">true</span><br>getstatic <span class="hljs-built_in">run</span> // 线程 t 获取 <span class="hljs-built_in">run</span> <span class="hljs-literal">true</span><br>putstatic <span class="hljs-built_in">run</span> // 线程 main 修改 <span class="hljs-built_in">run</span> 为 <span class="hljs-literal">false</span>， 仅此一次<br>getstatic <span class="hljs-built_in">run</span> // 线程 t 获取 <span class="hljs-built_in">run</span> <span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure>

<p>比较一下之前我们将线程安全时举的例子：两个线程一个 i++ 一个 i– ，只能保证看到最新值，不能解 决指令交错</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span> 假设i的初始值为<span class="hljs-number">0</span><br>getstatic i <span class="hljs-regexp">//</span> 线程<span class="hljs-number">1</span>-获取静态变量i的值 线程内i=<span class="hljs-number">0</span><br>getstatic i <span class="hljs-regexp">//</span> 线程<span class="hljs-number">2</span>-获取静态变量i的值 线程内i=<span class="hljs-number">0</span><br>iconst_1 <span class="hljs-regexp">//</span> 线程<span class="hljs-number">1</span>-准备常量<span class="hljs-number">1</span><br>iadd <span class="hljs-regexp">//</span> 线程<span class="hljs-number">1</span>-自增 线程内i=<span class="hljs-number">1</span><br>putstatic i <span class="hljs-regexp">//</span> 线程<span class="hljs-number">1</span>-将修改后的值存入静态变量i 静态变量i=<span class="hljs-number">1</span><br>iconst_1 <span class="hljs-regexp">//</span> 线程<span class="hljs-number">2</span>-准备常量<span class="hljs-number">1</span><br>isub <span class="hljs-regexp">//</span> 线程<span class="hljs-number">2</span>-自减 线程内i=-<span class="hljs-number">1</span><br>putstatic i <span class="hljs-regexp">//</span> 线程<span class="hljs-number">2</span>-将修改后的值存入静态变量i 静态变量i=-<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>



<p>注意 synchronized 语句块既可以保证代码块的原子性，也同时保证代码块内变量的可见性。</p>
<p>但缺点是 synchronized是属于重量级操作，性能相对更低 如果在前面示例的死循环中加入 System.out.println() 会发现即使不加 volatile 修饰符，线程 t 也 能正确看到对 run 变量的修改了，想一想为什么？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t4.avo;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo4_2</span> &#123;<br><br>     <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">run</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(()-&gt;&#123;<br>            <span class="hljs-keyword">while</span>(run)&#123;<br>                <span class="hljs-comment">// ....</span><br>                System.out.println();<br>            &#125;<br>        &#125;);<br>        t.start();<br><br>        Thread.sleep(<span class="hljs-number">1000</span>);<br>        run = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 线程t不会如预想的停下来</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220817221332251.png" srcset="/img/loading.gif" lazyload alt="image-20220817221332251"></p>
<hr>
<p>println方法中有使用<code>synchronized</code>关键字修饰，只要线程中有使用到synchronized关键字，线程中的变量就会有可见性；</p>
<h2 id="3-有序性"><a href="#3-有序性" class="headerlink" title="3. 有序性"></a>3. 有序性</h2><h3 id="3-1-诡异的结果"><a href="#3-1-诡异的结果" class="headerlink" title="3.1 诡异的结果"></a>3.1 诡异的结果</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> test;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConcurrencyTest</span> &#123;<br><br>    <span class="hljs-type">int</span> <span class="hljs-variable">num</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>     <span class="hljs-type">boolean</span> <span class="hljs-variable">ready</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">actor1</span><span class="hljs-params">(I_Result r)</span> &#123;<br>        <span class="hljs-keyword">if</span>(ready) &#123;<br>            r.r1 = num + num;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            r.r1 = <span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">actor2</span><span class="hljs-params">(I_Result r)</span> &#123;<br>        num = <span class="hljs-number">2</span>;<br>        ready = <span class="hljs-literal">true</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>



<p>I_Result 是一个对象，有一个属性 r1 用来保存结果，问，可能的结果有几种？ </p>
<p>有同学这么分析 </p>
<p>情况1：线程1 先执行，这时 ready &#x3D; false，所以进入 else 分支结果为 1 </p>
<p>情况2：线程2 先执行 num &#x3D; 2，但没来得及执行 ready &#x3D; true，线程1 执行，还是进入 else 分支，结 果为1 </p>
<p>情况3：线程2 执行到 ready &#x3D; true，线程1 执行，这回进入 if 分支，结果为 4（因为 num 已经执行过 了） </p>
<p>但我告诉你，结果还有可能是 0 😁😁😁，信不信吧！</p>
<p>这种情况下是：</p>
<p>线程2 执行 ready &#x3D; true，切换到线程1，进入 if 分支，相加为 0，再切回线程2 执行 num &#x3D; 2 </p>
<p>相信很多人已经晕了 😵😵😵 </p>
<p>这种现象叫做指令重排，是 JIT 编译器在运行时的一些优化，这个现象需要通过大量测试才能复现： </p>
<p>借助 java 并发压测工具 </p>
<p><code>jcstress</code> <a target="_blank" rel="noopener" href="https://wiki.openjdk.java.net/display/CodeTools/jcstress">https://wiki.openjdk.java.net/display/CodeTools/jcstress</a></p>
<p>进入项目目录，执行</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cmake">mvn clean <span class="hljs-keyword">install</span><br>java -jar <span class="hljs-keyword">target</span>/jcstress.jar<br></code></pre></td></tr></table></figure>



<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220817231642431.png" srcset="/img/loading.gif" lazyload alt="image-20220817231642431"></p>
<hr>
<p>可以看到，出现结果为 0 的情况有 638 次，虽然次数相对很少，但毕竟是出现了</p>
<h3 id="3-2-解决方法"><a href="#3-2-解决方法" class="headerlink" title="3.2 解决方法"></a>3.2 解决方法</h3><p>volatile 修饰的变量，可以禁用指令重排</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> test;<br><br><span class="hljs-keyword">import</span> org.openjdk.jcstress.annotations.*;<br><span class="hljs-keyword">import</span> org.openjdk.jcstress.infra.results.I_Result;<br><br><span class="hljs-comment">//@JCStressTest</span><br><span class="hljs-meta">@Outcome(id = &#123;&quot;1&quot;, &quot;4&quot;&#125;, expect = Expect.ACCEPTABLE, desc = &quot;ok&quot;)</span><br><span class="hljs-meta">@Outcome(id = &quot;0&quot;, expect = Expect.ACCEPTABLE_INTERESTING, desc = &quot;!!!!&quot;)</span><br><span class="hljs-meta">@State</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConcurrencyTest</span> &#123;<br><br>    <span class="hljs-type">int</span> <span class="hljs-variable">num</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">ready</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-meta">@Actor</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">actor1</span><span class="hljs-params">(I_Result r)</span> &#123;<br>        <span class="hljs-keyword">if</span>(ready) &#123;<br>            r.r1 = num + num;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            r.r1 = <span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Actor</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">actor2</span><span class="hljs-params">(I_Result r)</span> &#123;<br>        num = <span class="hljs-number">2</span>;<br>        ready = <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>结果为：</p>
<figure class="highlight mercury"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mercury">*** INTERESTING tests<br>Some interesting behaviors observed. This <span class="hljs-keyword">is</span> for the plain curiosity.<br><span class="hljs-number">0</span> matching test results.<br></code></pre></td></tr></table></figure>





<h3 id="3-3-有序性理解"><a href="#3-3-有序性理解" class="headerlink" title="3.3 有序性理解"></a>3.3 有序性理解</h3><p>JVM 会在不影响正确性的前提下，可以调整语句的执行顺序，思考下面一段代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-type">int</span> i;<br><span class="hljs-keyword">static</span> <span class="hljs-type">int</span> j;<br><span class="hljs-comment">// 在某个线程内执行如下赋值操作</span><br>i = ...; <span class="hljs-comment">// 较为耗时的操作</span><br>j = ...;<br></code></pre></td></tr></table></figure>



<p>可以看到，至于是先执行 i 还是 先执行 j ，对最终的结果不会产生影响。所以，上面代码真正执行 时，既可以是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">i = ...; <span class="hljs-comment">// 较为耗时的操作</span><br>j = ...;<br></code></pre></td></tr></table></figure>



<p>也可以是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">j = ...;<br>i = ...; <span class="hljs-comment">// 较为耗时的操作</span><br></code></pre></td></tr></table></figure>



<p>这种特性称之为『指令重排』，多线程下『指令重排』会影响正确性，例如著名的 double-checked locking 模式实现单例</p>
<p>双检锁：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton</span> &#123;<br><span class="hljs-keyword">private</span> <span class="hljs-title function_">Singleton</span><span class="hljs-params">()</span> &#123;&#125;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Singleton</span> <span class="hljs-variable">INSTANCE</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 实例没创建，才会进入内部的 synchronized代码块</span><br>        <span class="hljs-keyword">if</span> (INSTANCE == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">synchronized</span> (Singleton.class) &#123;<br>                <span class="hljs-comment">// 也许有其它线程已经创建实例，所以再判断一次</span><br>                <span class="hljs-keyword">if</span> (INSTANCE == <span class="hljs-literal">null</span>) &#123;<br>                    INSTANCE = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>();<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> INSTANCE;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>以上的实现特点是： </p>
<p>懒惰实例化 </p>
<p>首次使用 getInstance() 才使用 synchronized 加锁，后续使用时无需加锁</p>
<p>但在多线程环境下，上面的代码是有问题的， </p>
<p><code>INSTANCE = new Singleton() </code>对应的字节码为：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-number">0</span>: new <span class="hljs-comment">#2 // class cn/itcast/jvm/t4/Singleton</span><br><span class="hljs-number">3</span>: dup<br><span class="hljs-number">4</span>: invokespecial <span class="hljs-comment">#3 // Method &quot;&lt;init&gt;&quot;:()V</span><br><span class="hljs-number">7</span>: putstatic <span class="hljs-comment">#4 // Field</span><br><span class="hljs-variable constant_">INSTANCE</span><span class="hljs-symbol">:Lcn/itcast/jvm/t4/Singleton</span>;<br></code></pre></td></tr></table></figure>

<p>其中 4 7 两步的顺序不是固定的，也许 jvm 会优化为：先将引用地址赋值给 INSTANCE 变量后，再执行 构造方法</p>
<p>如果两个线程 t1，t2 按如下时间序列执行：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">时间<span class="hljs-number">1</span> <span class="hljs-built_in">t1</span> 线程执行到 <span class="hljs-keyword">INSTANCE </span>= new Singleton();<br>时间<span class="hljs-number">2</span> <span class="hljs-built_in">t1</span> 线程分配空间，为Singleton对象生成了引用地址（<span class="hljs-number">0</span> 处）<br>时间<span class="hljs-number">3</span> <span class="hljs-built_in">t1</span> 线程将引用地址赋值给 <span class="hljs-keyword">INSTANCE，这时 </span><span class="hljs-keyword">INSTANCE </span>!= null（<span class="hljs-number">7</span> 处）<br>时间<span class="hljs-number">4</span> <span class="hljs-built_in">t2</span> 线程进入getInstance() 方法，发现 <span class="hljs-keyword">INSTANCE </span>!= null（<span class="hljs-keyword">synchronized块外），直接</span><br><span class="hljs-keyword"></span>返回 <span class="hljs-keyword">INSTANCE</span><br><span class="hljs-keyword"></span>时间<span class="hljs-number">5</span> <span class="hljs-built_in">t1</span> 线程执行Singleton的构造方法（<span class="hljs-number">4</span> 处）<br></code></pre></td></tr></table></figure>

<p>这时 t1 还未完全将构造方法执行完毕，如果在构造方法中要执行很多初始化操作，那么 t2 拿到的是将 是一个未初始化完毕的单例 对 INSTANCE 使用 volatile 修饰即可，可以禁用指令重排，但要注意在 <strong>JDK 5 以上</strong>的版本的<code> volatile 才 会真正有效</code></p>
<h3 id="3-4-happens-before"><a href="#3-4-happens-before" class="headerlink" title="3.4 happens-before"></a>3.4 happens-before</h3><p><code>happens-before </code>规定了  <strong>哪些写操作</strong>  对  其它线程的  <strong>读操作可见</strong>，它是<strong>可见性与有序性</strong>的一套规则总结</p>
<p>抛开以下 <code>happens-before</code> 规则，JMM 并不能保证一个线程对共享变量的写，对于其它线程对该共享变 量的读可见 </p>
<p>1、线程解锁 m 之前对变量的写，对于接下来对 m 加锁的其它线程对该变量的读可见：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-type">int</span> x;<br><span class="hljs-keyword">static</span> <span class="hljs-type">Object</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(()-&gt;&#123;<br>        <span class="hljs-keyword">synchronized</span>(m) &#123;<br>        x = <span class="hljs-number">10</span>;<br>    &#125;<br>&#125;,<span class="hljs-string">&quot;t1&quot;</span>).start();<br><br><span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(()-&gt;&#123;<br>    <span class="hljs-keyword">synchronized</span>(m) &#123;<br>        System.out.println(x);<br>    &#125;<br>&#125;,<span class="hljs-string">&quot;t2&quot;</span>).start();<br></code></pre></td></tr></table></figure>





<p>2、线程对 volatile 变量的写，对接下来其它线程对该变量的读可见</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">volatile</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> x;<br><span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(()-&gt;&#123;<br>    x = <span class="hljs-number">10</span>;<br>&#125;,<span class="hljs-string">&quot;t1&quot;</span>).start();<br><br><span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(()-&gt;&#123;<br>    System.out.println(x);<br>&#125;,<span class="hljs-string">&quot;t2&quot;</span>).start();<br></code></pre></td></tr></table></figure>



<p>3、线程 start 前对变量的写，对该线程开始后对该变量的读可见</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-type">int</span> x;<br>x = <span class="hljs-number">10</span>;<br><span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(()-&gt;&#123;<br>    System.out.println(x);<br>&#125;,<span class="hljs-string">&quot;t2&quot;</span>).start();<br></code></pre></td></tr></table></figure>





<p>4、线程结束前对变量的写，对其它线程得知它结束后的读可见（比如其它线程调用 t1.isAlive() 或 t1.join()等待它结束）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-type">int</span> x;<br><span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(()-&gt;&#123;<br>    x = <span class="hljs-number">10</span>;<br>&#125;,<span class="hljs-string">&quot;t1&quot;</span>);<br><br>t1.start();<br>t1.join();<br>System.out.println(x);<br></code></pre></td></tr></table></figure>



<p>5、线程 t1 打断 t2（interrupt）前对变量的写，对于其他线程得知 t2 被打断后对变量的读可见（通 过t2.interrupted 或 t2.isInterrupted）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-type">int</span> x;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">Thread</span> <span class="hljs-variable">t2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(()-&gt;&#123;<br>        <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-keyword">if</span>(Thread.currentThread().isInterrupted()) &#123;<br>                System.out.println(x);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;,<span class="hljs-string">&quot;t2&quot;</span>);<br>    t2.start();<br>    <br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(()-&gt;&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">1000</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        x = <span class="hljs-number">10</span>;<br>        t2.interrupt();<br>    &#125;,<span class="hljs-string">&quot;t1&quot;</span>).start();<br>    <br>    <span class="hljs-keyword">while</span>(!t2.isInterrupted()) &#123;<br>        Thread.<span class="hljs-keyword">yield</span>();<br>    &#125;<br>    <br>    System.out.println(x);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>对变量默认值（0，false，null）的写，优先于其它线程对该变量的读可见 </p>
<p>具有传递性，如果 x hb-&gt; y 并且 y hb-&gt; z 那么有 x hb-&gt; z </p>
<p>变量都是指成员变量或静态成员变量</p>
<h2 id="4-CAS-与-原子类"><a href="#4-CAS-与-原子类" class="headerlink" title="4. CAS 与 原子类"></a>4. CAS 与 原子类</h2><h3 id="4-1-CAS"><a href="#4-1-CAS" class="headerlink" title="4.1 CAS"></a>4.1 CAS</h3><p>CAS 即 Compare and Swap ，它体现的一种乐观锁的思想，比如多个线程要对一个共享的整型变量执 行 +1 操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java">   <span class="hljs-type">int</span> 共享变量 = 一个数；<br>	<span class="hljs-comment">// 需要不断尝试</span><br>    <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) &#123;<br>    <span class="hljs-type">int</span> 旧值 = 共享变量 ; <span class="hljs-comment">// 比如拿到了当前值 0</span><br>    <br>        <br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    这时候如果别的线程把共享变量改成了 5，本线程的正确结果 1 就作废了，这时候</span><br><span class="hljs-comment">    compareAndSwap 返回 false，重新尝试，直到：</span><br><span class="hljs-comment">    compareAndSwap 返回 true，表示我本线程做修改的同时，别的线程没有干扰</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-keyword">if</span>( compareAndSwap ( 旧值 == 共享变量)) &#123;<br>        <span class="hljs-type">int</span> 结果 = 旧值 + <span class="hljs-number">1</span>; <span class="hljs-comment">// 在旧值 0 的基础上增加 1 ，正确结果是 1</span><br>        <span class="hljs-keyword">return</span>  结果;<br>    <span class="hljs-comment">// 成功，退出循环</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<p>获取共享变量时，为了保证该变量的可见性，需要<strong>使用 volatile 修饰</strong></p>
<p>结合 CAS 和 volatile 可以实现无 锁并发，<strong>适用于竞争不激烈、多核 CPU 的场景下</strong>。</p>
<p>原因：竞争激烈，可以想到重试必然频繁发生，反而效率会受影响 。CAS会不断地重试，直到成功，会一直占用cup资源，如果是单核cpu，当其他线程在运行时，他没办法不断重试，就达不到一种 ”锁“的状态；</p>
<p>CAS是轻量级的锁，因为没有使用 synchronized，所以线程不会陷入阻塞，这是效率提升的因素之一 ；线程阻塞后涉及线程上下文的切换【将当前正在运行的线程状态保存下来，然后恢复另一个线程的状态】</p>
<p>CAS 底层依赖于一个 Unsafe 类来直接调用操作系统底层的 CAS 指令，下面是直接使用 Unsafe 对象进 行线程安全保护的一个例子</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t5;<br><br><span class="hljs-keyword">import</span> sun.misc.Unsafe;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestCAS</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-type">DataContainer</span> <span class="hljs-variable">dc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataContainer</span>();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>;<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; count; i++) &#123;<br>                dc.increase();<br>            &#125;<br>        &#125;);<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; count; i++) &#123;<br>                dc.decrease();<br>            &#125;<br>        &#125;);<br>        t1.start();<br>        t2.start();<br>        System.out.println(dc.getData());<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DataContainer</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> data;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Unsafe unsafe;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> DATA_OFFSET;<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// Unsafe 对象不能直接调用，只能通过反射获得</span><br>            <span class="hljs-type">Field</span> <span class="hljs-variable">theUnsafe</span> <span class="hljs-operator">=</span> Unsafe.class.getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>            theUnsafe.setAccessible(<span class="hljs-literal">true</span>);<br>            unsafe = (Unsafe) theUnsafe.get(<span class="hljs-literal">null</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(e);<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// data 属性在 DataContainer 对象中的偏移量，用于 Unsafe 直接访问该属性</span><br>            DATA_OFFSET =<br>                    unsafe.objectFieldOffset(DataContainer.class.getDeclaredField(<span class="hljs-string">&quot;data&quot;</span>));<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increase</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">int</span> oldValue;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-comment">// 获取共享变量旧值，可以在这一行加入断点，修改 data 调试来加深理解</span><br>            oldValue = data;<br>            <span class="hljs-comment">// cas 尝试修改 data 为 旧值 + 1，如果期间旧值被别的线程改了，返回 false</span><br>            <span class="hljs-keyword">if</span> (unsafe.compareAndSwapInt(<span class="hljs-built_in">this</span>, DATA_OFFSET, oldValue, oldValue +<br>                    <span class="hljs-number">1</span>)) &#123;<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">decrease</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">int</span> oldValue;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            oldValue = data;<br>            <span class="hljs-keyword">if</span> (unsafe.compareAndSwapInt(<span class="hljs-built_in">this</span>, DATA_OFFSET, oldValue, oldValue -<br>                    <span class="hljs-number">1</span>)) &#123;<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getData</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> data;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">0<br></code></pre></td></tr></table></figure>







<h3 id="4-2-乐观锁与悲观锁"><a href="#4-2-乐观锁与悲观锁" class="headerlink" title="4.2 乐观锁与悲观锁"></a>4.2 乐观锁与悲观锁</h3><p><code>CAS</code> 是基于<strong>乐观锁</strong>的思想：最乐观的估计，不怕别的线程来修改共享变量，就算改了也没关系， 我吃亏点再<strong>重试</strong>呗</p>
<p><code>synchronized </code>是基于<strong>悲观锁</strong>的思想：最悲观的估计，得防着其它线程来修改共享变量，我上了锁 你们都别想改，我改完了解开锁，你们才有机会竞争锁。</p>
<h3 id="4-3-原子操作类"><a href="#4-3-原子操作类" class="headerlink" title="4.3 原子操作类"></a>4.3 原子操作类</h3><p><strong>juc</strong>（java.util.concurrent）中提供了原子操作类，可以提供线程安全的操作</p>
<p>例如：<code>AtomicInteger</code>、 <code>AtomicBoolean</code> 等，它们底层就是采用 <strong>CAS 技术 + volatile</strong> 来实现的</p>
<p>可以使用 <code>AtomicInteger </code>改写之前的例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t5;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicInteger;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> fgcy</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2022/8/18</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestCAS2</span> &#123;<br>    <span class="hljs-comment">// 创建原子整数对象</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">5000</span>; j++) &#123;<br>                i.getAndIncrement(); <span class="hljs-comment">// 获取并且自增 i++</span><br>                <span class="hljs-comment">// i.incrementAndGet(); // 自增并且获取 ++i</span><br>            &#125;<br>        &#125;);<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">5000</span>; j++) &#123;<br>                i.getAndDecrement(); <span class="hljs-comment">// 获取并且自减 i--</span><br>            &#125;<br>        &#125;);<br>        t1.start();<br>        t2.start();<br>        t1.join();<span class="hljs-comment">//等待t1执行完毕，继续执行主线程</span><br>        t2.join();<span class="hljs-comment">//等待t2执行完毕，继续执行主线程</span><br>        System.out.println(i);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="5-synchronized-优化"><a href="#5-synchronized-优化" class="headerlink" title="5. synchronized 优化"></a>5. synchronized 优化</h2><p>Java HotSpot 虚拟机中，每个对象都有对象头（包括两个部分：<code> class 指针</code> 和 <code> Mark Word</code>）</p>
<p>Mark Word 平时存 储这个对象的 <strong>哈希码</strong> 、 <strong>分代年龄</strong> (GC时，从from区晋升到老年代时会用到)</p>
<p>当加锁时，这些信息（hash码，分代年龄）就根据情况被<strong>替换为 标记位</strong>(轻量级锁，重量级锁，偏向锁) 、 线程锁记录指 针 、 重量级锁指针 、 线程ID 等内容</p>
<h3 id="5-1-轻量级锁"><a href="#5-1-轻量级锁" class="headerlink" title="5.1 轻量级锁"></a>5.1 轻量级锁</h3><p>如果一个对象虽然有多线程访问，但  <strong>多线程访问</strong>  的  <strong>时间是错开的</strong>（也就是没有竞争），那么可以使用 <strong>轻 量级锁来优化</strong></p>
<p>这就好比： </p>
<p>学生（线程 A）用课本占座，上了半节课，出门了（CPU时间到），回来一看，发现课本没变，说明没 有竞争，继续上他的课。 如果这期间有其它学生（线程 B）来了，会告知（线程A）有并发访问，线程 A 随即升级为重量级锁， 进入重量级锁的流程</p>
<p>而重量级锁就不是那么用课本占座那么简单了，可以想象线程 A 走之前，把座位用一个铁栅栏围起来 、</p>
<p>假设有两个方法同步块，利用同一个对象加锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method1</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">synchronized</span>( obj ) &#123;<br>        <span class="hljs-comment">// 同步块 A</span><br>        method2();<br>    &#125;<br>&#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method2</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">synchronized</span>( obj ) &#123;<br>        <span class="hljs-comment">// 同步块 B</span><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>





<p>每个线程的<strong>栈帧</strong>都会包含 一个<strong>锁记录的结构</strong>，内部可以存储锁定对象的 Mark Word（八个字节），加锁之后，Mark Word的内容会被修改，所以会将原来Mark Word中的内容迁移到栈帧的锁结构中；将来解锁时，将栈帧中的锁结构中原来Mark Word中的信息，恢复到对象头的Mark Word中；</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220818223436589.png" srcset="/img/loading.gif" lazyload alt="image-20220818223436589"></p>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220818223543229.png" srcset="/img/loading.gif" lazyload alt="image-20220818223543229"></p>
<hr>
<p>加锁过程：</p>
<p>查看锁对象的对象头中的某两位，若值为1则表示该锁对象还没有线程占有；此时将该锁对象的Mark Word中的信息，复制到当前栈帧中的锁结构中；</p>
<p>并且通过CAS的方式，将当前锁结构的地址设置给锁对象的Mark Word中；锁对象的Mark Word中有锁结构的地址说明加锁成功；</p>
<p>锁结构的数据结构采用栈，每次想要加锁就会将锁对象的Mark Word中的信息复制到栈中（可存储多个Mark Word的值），解锁就会出栈；</p>
<h3 id="5-2-锁膨胀"><a href="#5-2-锁膨胀" class="headerlink" title="5.2 锁膨胀"></a>5.2 锁膨胀</h3><p>如果在尝试加轻量级锁的过程中，CAS 操作无法成功，这时一种情况就是有其它线程为此对象加上了轻 量级锁（有竞争），这时需要进行锁膨胀，将轻量级锁变为重量级锁。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method1</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">synchronized</span>( obj ) &#123;<br>        <span class="hljs-comment">// 同步块</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220819202104234.png" srcset="/img/loading.gif" lazyload alt="image-20220819202104234"></p>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220819202151365.png" srcset="/img/loading.gif" lazyload alt="image-20220819202151365"></p>
<h3 id="5-3-重量锁"><a href="#5-3-重量锁" class="headerlink" title="5.3 重量锁"></a>5.3 重量锁</h3><p>重量级锁竞争的时候，还可以使用自旋来进行优化，如果当前线程自旋成功（即这时候持锁线程已经退 出了同步块，释放了锁），这时当前线程就可以避免阻塞。 </p>
<p>在 <strong>Java 6 之后</strong>   <code>自旋锁</code>是<strong>自适应的</strong>  **(没有固定的标准值)**，比如对象刚刚的一次自旋操作成功过，那么认为这次自旋成功的可能 性会高，就多自旋几次；反之，就少自旋甚至不自旋，总之，比较智能。</p>
<p>自旋会占用 CPU 时间，单核 CPU 自旋就是浪费，<strong>多核 CPU 自旋才能发挥优势</strong>。 </p>
<p>好比等红灯时汽车是不是熄火，不熄火相当于自旋（等待时间短了划算），熄火了相当于阻塞（等 待时间长了划算）</p>
<p>Java 7 之后不能控制是否开启自旋功能 自旋重试成功的情况</p>
<p>自旋重试成功的情况：</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220819202444437.png" srcset="/img/loading.gif" lazyload alt="image-20220819202444437"></p>
<hr>
<p>目的：（在一定范围内重试）尽可能减少线程上下文切换；</p>
<p>自旋重试失败的情况：</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220819202545653.png" srcset="/img/loading.gif" lazyload alt="image-20220819202545653"></p>
<hr>
<p>一直自旋重试会严重消耗cpu资源，所以在等待时间较长的情况下，应该使用重锁。</p>
<h3 id="5-4-偏向锁"><a href="#5-4-偏向锁" class="headerlink" title="5.4 偏向锁"></a>5.4 偏向锁</h3><p>轻量级锁在没有竞争时（就自己这个线程），每次重入仍然需要执行 CAS 操作。这会损耗性能。</p>
<p>Java 6 中引入了偏向锁 来做进一步优化：只有  第一次   使用 CAS 将 <strong>线程 ID</strong> 设置到  <strong>对象的 Mark Word 头</strong>，之后发现这个线程 ID 是自己的就表示没有竞争，不用重新 CAS.</p>
<ul>
<li>撤销偏【是一个重量级的操作】向需要将持锁线程升级为轻量级锁，这个过程中 <strong>所有线程需要暂停（STW）</strong> </li>
<li>访问对象的 hashCode 也会撤销偏向锁 </li>
<li>如果对象虽然被多个线程访问，但没有竞争，这时偏向了线程 T1 的对象仍有机会重新偏向 T2， <strong>重偏向</strong> 会重置对象的 Thread ID </li>
<li>撤销偏向和重偏向都是批量进行的，以类为单位 如果撤销偏向到达某个阈值，整个类的所有对象都会变为不可偏向的</li>
</ul>
<p>可以主动使用 <code>-XX:-UseBiasedLocking</code> 禁用偏向锁</p>
<p>可以参考这篇论文：<a target="_blank" rel="noopener" href="https://www.oracle.com/technetwork/java/biasedlocking-oopsla2006-wp149958.pdf">https://www.oracle.com/technetwork/java/biasedlocking-oopsla2006-wp149958.pdf</a> </p>
<p>假设有两个方法同步块，利用同一个对象加锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method1</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">synchronized</span>( obj ) &#123;<br>        <span class="hljs-comment">// 同步块 A</span><br>        method2();<br>    &#125;<br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method2</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">synchronized</span>( obj ) &#123;<br>        <span class="hljs-comment">// 同步块 B</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220819212647156.png" srcset="/img/loading.gif" lazyload alt="image-20220819212647156"></p>
<hr>
<h3 id="5-5-其它优化"><a href="#5-5-其它优化" class="headerlink" title="5.5 其它优化"></a>5.5 其它优化</h3><p>1、<strong>减少上锁时间</strong> </p>
<p>​		同步代码块中尽量短 【目的减少竞争的机会】</p>
<p>2、减少锁的粒度 将一个锁拆分为多个锁提高并发度，例如：</p>
<ul>
<li><p>ConcurrentHashMap 【像HashTable会锁住整个，即每一个桶都会被锁住 链表头】concurrentHashMap只会锁主某一个链表头</p>
</li>
<li><p>LongAdder 分为 base 和 cells 两部分。没有并发争用的时候或者是 cells 数组正在初始化的时 候，会使用 CAS 来累加值到 base，有并发争用，会初始化 cells 数组，数组有多少个 cell，就允 许有多少线程并行修改，最后将数组中每个 cell 累加，再加上 base 就是最终的值 </p>
</li>
<li><p>LinkedBlockingQueue 入队和出队使用不同的锁，相对于LinkedBlockingArray只有一个锁效率要 高</p>
</li>
</ul>
<p>3、锁粗化 </p>
<p>​		多次循环进入同步块 不如 同步块内多次循环 </p>
<p>​		另外 JVM 可能会做如下优化，把多次 append 的加锁操作粗化为一次（因为都是对同一个对象加锁， 没必要重入多次）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>().append(<span class="hljs-string">&quot;a&quot;</span>).append(<span class="hljs-string">&quot;b&quot;</span>).append(<span class="hljs-string">&quot;c&quot;</span>)<br></code></pre></td></tr></table></figure>



<p>4、锁消除 </p>
<p>​	JVM 会进行代码的逃逸分析，例如某个加锁对象是方法内局部变量，不会被其它线程所访问到</p>
<p>​	这时候 就会被即时编译器忽略掉所有同步操作。【java的即时编译器负责】</p>
<ol start="5">
<li>读写分离</li>
</ol>
<ul>
<li><p>CopyOnWriteArrayList </p>
</li>
<li><p>ConyOnWriteSet</p>
</li>
</ul>
<p>参考：</p>
<p> <a target="_blank" rel="noopener" href="https://wiki.openjdk.java.net/display/HotSpot/Synchronization">https://wiki.openjdk.java.net/display/HotSpot/Synchronization</a></p>
<p><a target="_blank" rel="noopener" href="http://luojinping.com/2015/07/09/java%E9%94%81%E4%BC%98%E5%8C%96/">http://luojinping.com/2015/07/09/java锁优化/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.infoq.cn/article/java-se-16-synchronized">https://www.infoq.cn/article/java-se-16-synchronized</a> </p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/9932047a89be">https://www.jianshu.com/p/9932047a89be</a> </p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/sheeva/p/6366782.html">https://www.cnblogs.com/sheeva/p/6366782.html</a> </p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/46312817/does-java-ever-rebias-an-individual-lock">https://stackoverflow.com/questions/46312817/does-java-ever-rebias-an-individual-lock</a></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E8%A7%86%E9%A2%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="category-chain-item">视频学习笔记</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/JVM-heima/">#JVM-heima</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Java虚拟机-heima</div>
      <div>http://example.com/2023/03/30/黑马-Java虚拟机/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>John Doe</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>March 30, 2023</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/03/30/MySQL-%E5%AE%8B%E7%BA%A2%E5%BA%B7-%E5%88%9D%E7%BA%A7-%E7%AC%AC17%E7%AB%A0-%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E4%B8%8E%E5%87%BD%E6%95%B0/" title="第17章-存储过程与函数-atguigu-shk">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">第17章-存储过程与函数-atguigu-shk</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/03/30/%E9%BB%91%E9%A9%AC-Dubbo/" title="Dubbo-heima">
                        <span class="hidden-mobile">Dubbo-heima</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>WAITING</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
