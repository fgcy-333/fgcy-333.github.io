

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="java线程状态(六种)">
<meta property="og:type" content="article">
<meta property="og:title" content="并发篇-itcast">
<meta property="og:url" content="http://example.com/2023/03/30/itcast-%E5%B9%B6%E5%8F%91%E7%AF%87/index.html">
<meta property="og:site_name" content="FGCY-BLOG">
<meta property="og:description" content="java线程状态(六种)">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/images/itcast.png">
<meta property="article:published_time" content="2023-03-30T09:57:04.000Z">
<meta property="article:modified_time" content="2023-03-30T13:41:35.046Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="java并发-itcast">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/images/itcast.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>并发篇-itcast - FGCY-BLOG</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":333,"cursorChar":"%","loop":true,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>FGCY-BLOG</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>主页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签列表</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于我</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/playlist/">
                <i class="iconfont icon-music"></i>
                <span>音乐</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="并发篇-itcast"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-03-30 17:57" pubdate>
          March 30, 2023 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    

    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> views
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">并发篇-itcast</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="java线程状态-六种"><a href="#java线程状态-六种" class="headerlink" title="java线程状态(六种)"></a>java线程状态(六种)</h2><span id="more"></span>

<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823210402186.png" srcset="/img/loading.gif" lazyload alt="image-20220823210402186"></p>
<hr>
<ol>
<li><code>NEW状态</code> : new了一个Thread类，还没有调用start方法；只是一个java对象，还没有跟操作系统底层的线程关联起来；</li>
<li><code>RUNNABLE状态</code>: 线程对象调用了sart方法，与真正的线程关联起来，内部的逻辑代码也会由操作系统交给cpu执行；</li>
<li><code>TERMINATED状态 </code>:线程执行完全部的代码，意味着线程的生命周期结束；此时会释放底层真正的线程和相关资源；</li>
<li><code>BLOCKED:状态</code>:当线程获取锁失败时，线程就会进入阻塞状态；当持该锁的线程进入终结状态，就会释放锁，同时唤醒所有被该锁锁住的线程，阻塞状态的线程获得锁后，就会进入	可运行状态，等待cpu执行</li>
<li><code>WAITING状态</code> :当可运行状态，需要某个资源但得不到的时候，就会调用wait方法(不加时间)，先释放调锁，再进入无限等待状态；直到别人释放调该资源，并唤醒(notify、notifyAll)这个无限等待的线程,此时如果获得锁对象(或不用锁对象)就进入可运行状态，否则进入阻塞状态</li>
<li><code>TIMED_WAITING状态</code> :由可运行状态通过调用wait(long)进入有时限等待，当时间到了（或时间没到但有人唤醒了），此时如果获得了锁对象，就直接转为可运行状态；</li>
</ol>
<p>同理也可以调用sleep(long)实现，注意sleep(long)不释放锁，睡醒进入可运行状态。</p>
<ul>
<li>代码实现</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.thread;<br><br><br><span class="hljs-keyword">import</span> org.slf4j.Logger;<br><span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * ClassName: NewRunnableTerminated</span><br><span class="hljs-comment"> * Description: NEW RUNNINABLE TERMINATED</span><br><span class="hljs-comment"> * date:2022/3/20</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> fgcy</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> JDK 1.8</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NewRunnableTerminated</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">LOGGER</span> <span class="hljs-operator">=</span><br>            LoggerFactory.getLogger(<span class="hljs-string">&quot;NewRunnableTerminated.class&quot;</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">LOCK</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        testNewRunnableTerminated();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testNewRunnableTerminated</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            LOGGER.debug(<span class="hljs-string">&quot;running.....&quot;</span>);<span class="hljs-comment">//3断点</span><br>        &#125;, <span class="hljs-string">&quot;t1&quot;</span>);<br>        LOGGER.debug(<span class="hljs-string">&quot;t1-state:&#123;&#125;&quot;</span>, t1.getState());<span class="hljs-comment">//1</span><br>        t1.start();<br>        LOGGER.debug(<span class="hljs-string">&quot;t1-state:&#123;&#125;&quot;</span>, t1.getState());<span class="hljs-comment">//2</span><br><br>        LOGGER.debug(<span class="hljs-string">&quot;t1-state:&#123;&#125;&quot;</span>, t1.getState());<span class="hljs-comment">//4断点</span><br><br>    &#125;<br>&#125;<br>========================================================<br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">20</span> <span class="hljs-number">14</span>:<span class="hljs-number">44</span>:<span class="hljs-number">42.453</span> [DEBUG] NewRunnableTerminated.class [main] : t1-state:NEW<br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">20</span> <span class="hljs-number">14</span>:<span class="hljs-number">44</span>:<span class="hljs-number">42.493</span> [DEBUG] NewRunnableTerminated.class [main] : t1-state:RUNNABLE<br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">20</span> <span class="hljs-number">14</span>:<span class="hljs-number">44</span>:<span class="hljs-number">57.566</span> [DEBUG] NewRunnableTerminated.class [t1] : running.....<br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">20</span> <span class="hljs-number">14</span>:<span class="hljs-number">45</span>:<span class="hljs-number">07.726</span> [DEBUG] NewRunnableTerminated.class [main] : t1-state:TERMINATED<span class="hljs-comment">//控制t1线程跑完，再回到mian线程输出t1状态</span><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs JAVA"><span class="hljs-keyword">package</span> com.itheima.thread;<br><br><br><span class="hljs-keyword">import</span> org.slf4j.Logger;<br><span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * ClassName: NewRunnableTerminated</span><br><span class="hljs-comment"> * Description: NEW RUNNINABLE BLOCKED TERMINATED</span><br><span class="hljs-comment"> * date:2022/3/20</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> fgcy</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> JDK 1.8</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NewRunnableTerminated</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">LOGGER</span> <span class="hljs-operator">=</span><br>            LoggerFactory.getLogger(<span class="hljs-string">&quot;NewRunnableTerminated.class&quot;</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">LOCK</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        testBlocked();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testBlocked</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            LOGGER.debug(<span class="hljs-string">&quot;before sync&quot;</span>);<span class="hljs-comment">//3 输出before sync 此时发现没有锁对象，进入阻塞</span><br>            <span class="hljs-keyword">synchronized</span> (LOCK) &#123;<br>                LOGGER.debug(<span class="hljs-string">&quot;in sync&quot;</span>);<span class="hljs-comment">//6 输出in sync</span><br>            &#125;<br>        &#125;, <span class="hljs-string">&quot;t2&quot;</span>);<br>        LOGGER.debug(<span class="hljs-string">&quot;t2-state:&#123;&#125;&quot;</span>, t2.getState());<span class="hljs-comment">//0 t2-state:NEW</span><br>        t2.start();<br>        LOGGER.debug(<span class="hljs-string">&quot;t2-state:&#123;&#125;&quot;</span>, t2.getState());<span class="hljs-comment">//1 t2-state:RUNNABLE</span><br>        <span class="hljs-keyword">synchronized</span> (LOCK) &#123;<br>            LOGGER.debug(<span class="hljs-string">&quot;t2-state:&#123;&#125;&quot;</span>, t2.getState());<span class="hljs-comment">//2 控制main线程先获取锁对象 4输出t2-state:BLOCKED</span><br>        &#125;<br>        LOGGER.debug(<span class="hljs-string">&quot;t2-state:&#123;&#125;&quot;</span>, t2.getState());<span class="hljs-comment">//5控制main线程释放锁 7输出 : t2-state:RUNNABLE</span><br>        LOGGER.debug(<span class="hljs-string">&quot;t2-state:&#123;&#125;&quot;</span>, t2.getState());<span class="hljs-comment">//8 t2-state:TERMINATED</span><br>    &#125;<br>&#125;<br>=====================================================<br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">20</span> <span class="hljs-number">15</span>:09:<span class="hljs-number">19.828</span> [DEBUG] NewRunnableTerminated.class [main] : t2-state:NEW<br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">20</span> <span class="hljs-number">15</span>:09:<span class="hljs-number">23.466</span> [DEBUG] NewRunnableTerminated.class [main] : t2-state:RUNNABLE<br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">20</span> <span class="hljs-number">15</span>:09:<span class="hljs-number">32.477</span> [DEBUG] NewRunnableTerminated.class [t2] : before sync<br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">20</span> <span class="hljs-number">15</span>:09:<span class="hljs-number">36.481</span> [DEBUG] NewRunnableTerminated.class [main] : t2-state:BLOCKED<br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">20</span> <span class="hljs-number">15</span>:09:<span class="hljs-number">43.454</span> [DEBUG] NewRunnableTerminated.class [t2] : in sync<br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">20</span> <span class="hljs-number">15</span>:09:<span class="hljs-number">51.850</span> [DEBUG] NewRunnableTerminated.class [main] : t2-state:RUNNABLE<br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">20</span> <span class="hljs-number">15</span>:<span class="hljs-number">10</span>:<span class="hljs-number">01.585</span> [DEBUG] NewRunnableTerminated.class [main] : t2-state:TERMINATED<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.thread;<br><br><br><span class="hljs-keyword">import</span> org.slf4j.Logger;<br><span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * ClassName: NewRunnableTerminated</span><br><span class="hljs-comment"> * Description: NEW RUNNINABLE WAITING BLOCKED TERMINATED</span><br><span class="hljs-comment"> * date:2022/3/20</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> fgcy</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> JDK 1.8</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NewRunnableTerminated</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">LOGGER</span> <span class="hljs-operator">=</span><br>            LoggerFactory.getLogger(<span class="hljs-string">&quot;NewRunnableTerminated.class&quot;</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">LOCK</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        testWaiting();<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testWaiting</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-comment">//6 t2线程发现没有锁对象，阻塞</span><br>            <span class="hljs-keyword">synchronized</span> (LOCK) &#123;<br>                LOGGER.debug(<span class="hljs-string">&quot;before waiting.....&quot;</span>);<span class="hljs-comment">//2 before waiting.....</span><br>                <span class="hljs-keyword">try</span> &#123;<br>                    LOCK.wait();  <span class="hljs-comment">//3 释放锁 进入无限等待</span><br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;, <span class="hljs-string">&quot;t2&quot;</span>);<br>        LOGGER.debug(<span class="hljs-string">&quot;t2-state:&#123;&#125;&quot;</span>, t2.getState());<span class="hljs-comment">//t2-state:NEW</span><br>        t2.start();<br>        LOGGER.debug(<span class="hljs-string">&quot;t2-state:&#123;&#125;&quot;</span>, t2.getState());<span class="hljs-comment">//1 t2-state:RUNNABLE</span><br>        <span class="hljs-keyword">synchronized</span> (LOCK) &#123;<br>            LOGGER.debug(<span class="hljs-string">&quot;t2-state:&#123;&#125;&quot;</span>, t2.getState());<span class="hljs-comment">//4 获得锁  t2-state:WAITING</span><br>            LOCK.notify();<span class="hljs-comment">//5 唤醒t2线程</span><br>            LOGGER.debug(<span class="hljs-string">&quot;t2-state:&#123;&#125;&quot;</span>, t2.getState());<span class="hljs-comment">//7 t2-state:BLOCKED</span><br>        &#125;<br>        LOGGER.debug(<span class="hljs-string">&quot;t2-state:&#123;&#125;&quot;</span>, t2.getState());<span class="hljs-comment">//main线程释放锁，t2进入可运行状态 t2-state:RUNNABLE</span><br>        LOGGER.debug(<span class="hljs-string">&quot;t2-state:&#123;&#125;&quot;</span>, t2.getState());<span class="hljs-comment">//t2线程跑完 t2-state:TERMINATED</span><br>    &#125;<br>&#125;<br>=================================================<br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">20</span> <span class="hljs-number">15</span>:<span class="hljs-number">28</span>:<span class="hljs-number">55.319</span> [DEBUG] NewRunnableTerminated.class [main] : t2-state:NEW<br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">20</span> <span class="hljs-number">15</span>:<span class="hljs-number">29</span>:<span class="hljs-number">08.539</span> [DEBUG] NewRunnableTerminated.class [main] : t2-state:RUNNABLE<br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">20</span> <span class="hljs-number">15</span>:<span class="hljs-number">29</span>:<span class="hljs-number">28.980</span> [DEBUG] NewRunnableTerminated.class [t2] : before waiting.....<br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">20</span> <span class="hljs-number">15</span>:<span class="hljs-number">29</span>:<span class="hljs-number">37.246</span> [DEBUG] NewRunnableTerminated.class [main] : t2-state:WAITING<br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">20</span> <span class="hljs-number">15</span>:<span class="hljs-number">29</span>:<span class="hljs-number">54.372</span> [DEBUG] NewRunnableTerminated.class [main] : t2-state:BLOCKED<br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">20</span> <span class="hljs-number">15</span>:<span class="hljs-number">30</span>:<span class="hljs-number">04.711</span> [DEBUG] NewRunnableTerminated.class [main] : t2-state:RUNNABLE<br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">20</span> <span class="hljs-number">15</span>:<span class="hljs-number">30</span>:<span class="hljs-number">13.273</span> [DEBUG] NewRunnableTerminated.class [main] : t2-state:TERMINATED<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.thread;<br><br><br><span class="hljs-keyword">import</span> org.slf4j.Logger;<br><span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * ClassName: NewRunnableTerminated</span><br><span class="hljs-comment"> * Description: NEW RUNNINABLE TIMED-WAITING BLOCKED TERMINATED</span><br><span class="hljs-comment"> * date:2022/3/20</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> fgcy</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> JDK 1.8</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NewRunnableTerminated</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">LOGGER</span> <span class="hljs-operator">=</span><br>            LoggerFactory.getLogger(<span class="hljs-string">&quot;NewRunnableTerminated.class&quot;</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">LOCK</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        testTimed();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testTimed</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">synchronized</span> (LOCK) &#123;<br>                LOGGER.debug(<span class="hljs-string">&quot;before wait(10000000)&quot;</span>);<span class="hljs-comment">//1 before wait(10000000)</span><br>                <span class="hljs-keyword">try</span> &#123;<br>                    LOCK.wait(<span class="hljs-number">10100000</span>);<span class="hljs-comment">//3 进入有限等待（唤醒main，释放锁）</span><br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;, <span class="hljs-string">&quot;t2&quot;</span>);<br>        LOGGER.debug(<span class="hljs-string">&quot;t2-state:&#123;&#125;&quot;</span>, t2.getState());<span class="hljs-comment">//0 t2-state:NEW</span><br>        t2.start();<br>        LOGGER.debug(<span class="hljs-string">&quot;t2-state:&#123;&#125;&quot;</span>, t2.getState());<span class="hljs-comment">//2 t2-state:RUNNABLE</span><br>        <span class="hljs-keyword">synchronized</span> (LOCK) &#123;<br>            LOGGER.debug(<span class="hljs-string">&quot;t2-state:&#123;&#125;&quot;</span>, t2.getState());<span class="hljs-comment">//4 : t2-state:TIMED_WAITING</span><br>            LOCK.notify();<span class="hljs-comment">//5 唤醒t2线程，t2没有锁进入阻塞状态</span><br>            LOGGER.debug(<span class="hljs-string">&quot;t2-state:&#123;&#125;&quot;</span>, t2.getState());<span class="hljs-comment">//6  t2-state:BLOCKED</span><br>        &#125;<br>        LOGGER.debug(<span class="hljs-string">&quot;t2-state:&#123;&#125;&quot;</span>, t2.getState());<span class="hljs-comment">// 7 释放锁 t2进入可运行状态  t2-state:RUNNABLE</span><br>        LOGGER.debug(<span class="hljs-string">&quot;t2-state:&#123;&#125;&quot;</span>, t2.getState());<span class="hljs-comment">//8 控制t2线程跑完 t2-state:TERMINATED</span><br>    &#125;<br>&#125;<br>===============================================<br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">20</span> <span class="hljs-number">16</span>:<span class="hljs-number">11</span>:<span class="hljs-number">47.549</span> [DEBUG] NewRunnableTerminated.class [main] : t2-state:NEW<br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">20</span> <span class="hljs-number">16</span>:<span class="hljs-number">12</span>:<span class="hljs-number">03.106</span> [DEBUG] NewRunnableTerminated.class [t2] : before <span class="hljs-title function_">wait</span><span class="hljs-params">(<span class="hljs-number">10000000</span>)</span><br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">20</span> <span class="hljs-number">16</span>:<span class="hljs-number">12</span>:<span class="hljs-number">12.191</span> [DEBUG] NewRunnableTerminated.class [main] : t2-state:RUNNABLE<br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">20</span> <span class="hljs-number">16</span>:<span class="hljs-number">12</span>:<span class="hljs-number">28.220</span> [DEBUG] NewRunnableTerminated.class [main] : t2-state:TIMED_WAITING<br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">20</span> <span class="hljs-number">16</span>:<span class="hljs-number">12</span>:<span class="hljs-number">39.316</span> [DEBUG] NewRunnableTerminated.class [main] : t2-state:BLOCKED<br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">20</span> <span class="hljs-number">16</span>:<span class="hljs-number">12</span>:<span class="hljs-number">54.137</span> [DEBUG] NewRunnableTerminated.class [main] : t2-state:RUNNABLE<br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">20</span> <span class="hljs-number">16</span>:<span class="hljs-number">13</span>:<span class="hljs-number">01.379</span> [DEBUG] NewRunnableTerminated.class [main] : t2-state:TERMINATED<br></code></pre></td></tr></table></figure>







<h2 id="操作系统层面（5种）"><a href="#操作系统层面（5种）" class="headerlink" title="操作系统层面（5种）"></a>操作系统层面（5种）</h2><hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-20_16-22-35.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-20_16-45-42.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<p>新建状态：进程创建的过程中，所需的资源尚不能得到满足，此时创建工作尚未完成，进程无法被调度执行，进程此时就处于创建状态。<br>就绪状态：此时进程已经分配好除CPU外的所有必要资源，只需获得CPU的调度<br>运行状态：进程已经获得CPU并且正在执行中<br>阻塞状态：处于此状态的进程是因为在执行的过程中由于发生某种需要等待的事件（I&#x2F;O请求、申请缓存失败、等待接收数据等），而暂时无法继续执行<br>终止状态：进程正常运行结束或者出现导致进程终止的错误，或是被OS所终结，或是被父进程终结，则进入终止状态</p>
<ul>
<li>注意</li>
</ul>
<p>java中的RUNNABLE状态包括了就绪、运行、阻塞I&#x2F;O;也可以说是java的RUNNABLE状态无法区分操作系统中的这几种状态。</p>
<h2 id="线程池的核心参数"><a href="#线程池的核心参数" class="headerlink" title="线程池的核心参数"></a>线程池的核心参数</h2><p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823205738853.png" srcset="/img/loading.gif" lazyload alt="image-20220823205738853"></p>
<p>corePoolSize:核心线程数量(可以为零)<br>maximumPoolSize:线程池的最大线程数目(核心线程+救急线程)<br>keepAliveTime：救急线程在停止运行后，最大的存活时间<br>unit:最大存活时间的单位<br>workQueue：用于接收并存放任务的队列<br>handler:当所有线程在忙，任务队列已满，此时再来一个任务，要怎么处理（拒绝策略）</p>
<ul>
<li>代码实现</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.thread;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.*;<br><span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicInteger;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * ClassName: ThreadPoolDemo &lt;br/&gt;</span><br><span class="hljs-comment"> * Description: &lt;br/&gt;</span><br><span class="hljs-comment"> * date: 2022/3/20 19:02&lt;br/&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> fgcy&lt;br /&gt;</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> JDK 1.8</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadPoolDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">1</span>);<br><span class="hljs-comment">/*        ExecutorService pool = new ThreadPoolExecutor(2, 3, 0,</span><br><span class="hljs-comment">                TimeUnit.SECONDS, new ArrayBlockingQueue&lt;&gt;(2), Executors.defaultThreadFactory(), new ThreadPoolExecutor.AbortPolicy());</span><br><span class="hljs-comment">                */</span><br><br>        <span class="hljs-comment">// new ThreadPoolExecutor.DiscardOldestPolicy()当全部线程在忙，任务队列已满，此时再添加一个任务，丢弃任务队列中，存在时间最长的</span><br>        <span class="hljs-comment">//new ThreadPoolExecutor.DiscardPolicy()当全部线程在忙，任务队列已满，此时再添加一个任务，丢弃这个刚加入的任务</span><br>        <span class="hljs-comment">//new ThreadPoolExecutor.CallerRunsPolicy()当全部线程在忙，任务队列已满，此时再添加一个任务，由提交任务的线程执行</span><br>        <span class="hljs-comment">//new ThreadPoolExecutor.AbortPolicy()当全部线程在忙，任务队列已满，此时再添加一个任务，外抛异常</span><br>        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>,<br>                TimeUnit.SECONDS, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="hljs-number">2</span>), r -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(r, <span class="hljs-string">&quot;myThread&quot;</span> + c.getAndIncrement())<br>                , <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.AbortPolicy());<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">            * 什么时候创建救急线程？</span><br><span class="hljs-comment">            *   核心线程在忙，任务队列已满，此时再提交一个任务，就会创建救急线程处理该任务</span><br><span class="hljs-comment">            * 什么时候使用拒绝策略？</span><br><span class="hljs-comment">            *   当全部线程在忙，任务队列已满，此时再添加一个任务</span><br><span class="hljs-comment">            * */</span><br>            pool.submit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Taskk</span>(<span class="hljs-number">100000L</span>, <span class="hljs-string">&quot;1&quot;</span>));<br>            pool.submit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Taskk</span>(<span class="hljs-number">100000L</span>, <span class="hljs-string">&quot;2&quot;</span>));<br>            pool.submit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Taskk</span>(<span class="hljs-number">100000L</span>, <span class="hljs-string">&quot;3&quot;</span>));<br>            pool.submit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Taskk</span>(<span class="hljs-number">100000L</span>, <span class="hljs-string">&quot;4&quot;</span>));<br>            pool.submit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Taskk</span>(<span class="hljs-number">1000L</span>, <span class="hljs-string">&quot;13224&quot;</span>));<br><span class="hljs-comment">//            pool.submit(new Taskk(1000L, &quot;6&quot;));</span><br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Taskk</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Callable</span>&lt;String&gt; &#123;<br>    <span class="hljs-keyword">private</span> Long milliseconds;<br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Taskk</span><span class="hljs-params">(Long milliseconds, String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.milliseconds = milliseconds;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">call</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;正在跑任务&quot;</span> + name);<br>        Thread.sleep(milliseconds);<br>        System.out.println(<span class="hljs-string">&quot;任务&quot;</span> + name + <span class="hljs-string">&quot;结束&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;success&quot;</span>;<br>    &#125;<br>&#125;<br>==========================================================<br>myThread2正在跑任务<span class="hljs-number">2</span><br>myThread3正在跑任务<span class="hljs-number">13224</span><br>myThread1正在跑任务<span class="hljs-number">1</span><br>任务<span class="hljs-number">13224</span>结束<br>myThread3正在跑任务<span class="hljs-number">3</span><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.thread;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.*;<br><span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicInteger;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">1</span>);<br>        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(<span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">4</span><br>                , TimeUnit.SECONDS, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="hljs-number">5</span>),<br>                r -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(r, <span class="hljs-string">&quot;myThread&quot;</span> + c.getAndIncrement())<br>                , <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.CallerRunsPolicy());<br><br>        executorService.execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyRunnable</span>(<span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-number">1000000L</span>));<span class="hljs-comment">//1</span><br>        executorService.execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyRunnable</span>(<span class="hljs-string">&quot;2&quot;</span>, <span class="hljs-number">1000000L</span>));<span class="hljs-comment">//2</span><br>        executorService.execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyRunnable</span>(<span class="hljs-string">&quot;3&quot;</span>, <span class="hljs-number">1000000L</span>));<span class="hljs-comment">//3 三个核心线程在忙</span><br>        executorService.execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyRunnable</span>(<span class="hljs-string">&quot;4&quot;</span>, <span class="hljs-number">1000000L</span>));<span class="hljs-comment">//4</span><br>        executorService.execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyRunnable</span>(<span class="hljs-string">&quot;5&quot;</span>, <span class="hljs-number">1000000L</span>));<span class="hljs-comment">//5</span><br>        executorService.execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyRunnable</span>(<span class="hljs-string">&quot;6&quot;</span>, <span class="hljs-number">1000000L</span>));<span class="hljs-comment">//6</span><br>        executorService.execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyRunnable</span>(<span class="hljs-string">&quot;7&quot;</span>, <span class="hljs-number">1000000L</span>));<span class="hljs-comment">//7</span><br>        executorService.execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyRunnable</span>(<span class="hljs-string">&quot;8&quot;</span>, <span class="hljs-number">1000000L</span>));<span class="hljs-comment">//8 任务队列可以存放五个任务 【此时·还不会创建临时线程】</span><br>        executorService.execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyRunnable</span>(<span class="hljs-string">&quot;9&quot;</span>, <span class="hljs-number">1000000L</span>));<span class="hljs-comment">//9 此时核心线程在忙，任务队列已满，未达到最大线程数量，再来一个线程就开启临时线程</span><br>        <span class="hljs-comment">//10 上面在满的情况下加入了一个，然后又处理了一个；相当于还是处于满的状态；此时再来一个线程，判断核心线程在忙？，任务队列已满？，未达到最大线程数量？创建一个新的临时线程</span><br>        executorService.execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyRunnable</span>(<span class="hljs-string">&quot;10&quot;</span>, <span class="hljs-number">1000000L</span>));<span class="hljs-comment">//10</span><br>        <span class="hljs-comment">//11 java.util.concurrent.RejectedExecutionException</span><br>        executorService.execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyRunnable</span>(<span class="hljs-string">&quot;11&quot;</span>, <span class="hljs-number">1000000L</span>));<span class="hljs-comment">//11 此时 所有线程在忙，任务队列已满，再来一个任务，就会采用线程池配置的策略（由提交该任务的线程执行！！）</span><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">         * 这行代码无法执行，上面抛异常了；但jvm没有挂，说明线程池有捕获异常的机制；</span><br><span class="hljs-comment">         * try catch 中try语句块出错后的代码无法执行，</span><br><span class="hljs-comment">         * */</span><br>        executorService.shutdown();<span class="hljs-comment">//等待所有任务执行完毕后，关闭</span><br>        executorService.shutdownNow();<span class="hljs-comment">//即时任务没有完成，也要立即关闭</span><br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyRunnable</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> Long milliseconds;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyRunnable</span><span class="hljs-params">(String name, Long milliseconds)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.milliseconds = milliseconds;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot;正在跑任务&quot;</span> + name);<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(milliseconds);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;任务&quot;</span> + name + <span class="hljs-string">&quot;结束&quot;</span>);<br>    &#125;<br>&#125;<br>======================================================<br>myThread1正在跑任务<span class="hljs-number">1</span><br>myThread5正在跑任务<span class="hljs-number">10</span><br>myThread4正在跑任务<span class="hljs-number">9</span><br>main正在跑任务<span class="hljs-number">11</span><br>myThread3正在跑任务<span class="hljs-number">3</span><br>myThread2正在跑任务<span class="hljs-number">2</span><br></code></pre></td></tr></table></figure>

<h2 id="sleep-vs-wait"><a href="#sleep-vs-wait" class="headerlink" title="sleep vs wait"></a>sleep vs wait</h2><ul>
<li>共同点</li>
</ul>
<p>wait()、wait(long)、sleep(long)的效果都是让当前线程放弃cpu的使用权（让出cpu），进入阻塞状态(操作系统的阻塞)，java的无限等待或有限等待</p>
<ul>
<li>方法归属不同</li>
</ul>
<p>sleep是Thread的静态方法，直接那类名调<br>wait()、wait(long)属于Object类的成员方法，每个实例都有</p>
<ul>
<li>醒来的时机不同</li>
</ul>
<ol>
<li>执行sleep(long)、wait(long)方法的线程，会在等待相应的毫秒值后醒来</li>
<li>wait()、wait(long)方法可以被锁对象的notify()、notifyAll()方法唤醒，wait()如果一直没有人唤醒，就会一直等下去</li>
<li>他们都可以被打断而唤醒：拿到调用wait或sleep方法的线程，调用Thread.currentThread().interrupt()，让等待的线程外抛一个打断异常，从而唤醒线程</li>
</ol>
<ul>
<li>锁特征不同</li>
</ul>
<ol>
<li>wait方法的调用必须先获取wait对象的锁(必须配合锁一起使用)，而sleep则无此限制</li>
<li>wait方法执行后会释放锁对象，允许其他线程获得该锁对象；（让出锁对象，让出cpu）</li>
<li>sleep方法如果在synchronized代码块中执行，并不会释放锁对象；（让出cpu，不让出锁对象）</li>
</ol>
<ul>
<li>代码实现</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.thread;<br><br><span class="hljs-keyword">import</span> org.slf4j.Logger;<br><span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WaitVsSleep</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">LOGGER</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(<span class="hljs-string">&quot;WaitVsSleep.class&quot;</span>);<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">LOCK</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><span class="hljs-comment">//        illegalWait();</span><br><span class="hljs-comment">//        waiting();</span><br><span class="hljs-comment">//        sleeping();</span><br>        interrupted();<br>    &#125;<br><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">illegalWait</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//java.lang.IllegalMonitorStateException</span><br>            <span class="hljs-comment">//wait方法要配合锁对象一起使用</span><br>            <span class="hljs-comment">//LOCK只是一个普通的对象，只有当其放在synchronized括号中，才成为锁对象</span><br>            <span class="hljs-comment">//LOCK.wait();</span><br>            <span class="hljs-comment">//此时LOCK成为锁对象</span><br>            <span class="hljs-keyword">synchronized</span> (LOCK) &#123;<br>                LOCK.wait();<br>            &#125;<br><br><br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">waiting</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">synchronized</span> (LOCK) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    LOGGER.debug(<span class="hljs-string">&quot;waiting....&quot;</span>);<br>                    <span class="hljs-comment">//3让出cpu，让出锁</span><br>                    LOCK.wait(<span class="hljs-number">5000L</span>);<br>                    <span class="hljs-comment">//等待结束，并得到锁，跑完线程</span><br>                    LOGGER.debug(<span class="hljs-string">&quot;stop waiting....&quot;</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                    LOGGER.debug(<span class="hljs-string">&quot;interrupted....&quot;</span>);<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;, <span class="hljs-string">&quot;t1&quot;</span>);<br>        <span class="hljs-comment">//1.main线程调用t1线程</span><br>        t1.start();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//2确保t1线程得到锁</span><br>            Thread.sleep(<span class="hljs-number">100</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-comment">//4获取锁</span><br>        <span class="hljs-keyword">synchronized</span> (LOCK) &#123;<br>            LOGGER.debug(<span class="hljs-string">&quot;other.....&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">//6结束</span><br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sleeping</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">synchronized</span> (LOCK) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-comment">//3 输出</span><br>                    LOGGER.debug(<span class="hljs-string">&quot;slepping......&quot;</span>);<br>                    <span class="hljs-comment">//4 让出cpu，持有锁5s</span><br>                    Thread.sleep(<span class="hljs-number">5000L</span>);<br>                    <span class="hljs-comment">//5 5秒后输出，跑完程序，释放锁</span><br>                    LOGGER.debug(<span class="hljs-string">&quot;stop slepping......&quot;</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;, <span class="hljs-string">&quot;t1&quot;</span>);<br>        <span class="hljs-comment">//1 main调用t1线程</span><br>        t1.start();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//2 main先睡100ms确保t1线程获取锁</span><br>            Thread.sleep(<span class="hljs-number">100</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-comment">//6 得到锁</span><br>        <span class="hljs-keyword">synchronized</span> (LOCK) &#123;<br>            <span class="hljs-comment">//7 输出</span><br>            LOGGER.debug(<span class="hljs-string">&quot;other......&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">interrupted</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">synchronized</span> (LOCK) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-comment">//3 输出</span><br>                    LOGGER.debug(<span class="hljs-string">&quot;slepping......&quot;</span>);<br>                    <span class="hljs-comment">//4 让出cpu，持有锁 想要等待5秒</span><br>                    <span class="hljs-comment">//Thread.sleep(5000L);</span><br>                    <span class="hljs-comment">//LOCK.wait();</span><br>                    <span class="hljs-comment">// LOCK.wait(10000);</span><br>                    LOGGER.debug(<span class="hljs-string">&quot;stop slepping......&quot;</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                    LOGGER.debug(<span class="hljs-string">&quot;interrupted...&quot;</span>);<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;, <span class="hljs-string">&quot;t1&quot;</span>);<br>        <span class="hljs-comment">//1 main调用t1线程</span><br>        t1.start();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//2 main先睡100ms确保t1线程获取锁</span><br>            Thread.sleep(<span class="hljs-number">100</span>);<br>            <span class="hljs-comment">//6 中断打断sleep、wait 连5秒都不给他</span><br>            t1.interrupt();<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br><br>    &#125;<br>&#125;<br><br>================ waiting()======================<br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">20</span> <span class="hljs-number">23</span>:<span class="hljs-number">20</span>:<span class="hljs-number">46.883</span> [DEBUG] WaitVsSleep.class [t1] : waiting....<br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">20</span> <span class="hljs-number">23</span>:<span class="hljs-number">20</span>:<span class="hljs-number">46.985</span> [DEBUG] WaitVsSleep.class [main] : other.....<br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">20</span> <span class="hljs-number">23</span>:<span class="hljs-number">20</span>:<span class="hljs-number">51.889</span> [DEBUG] WaitVsSleep.class [t1] : stop waiting....<br>================ sleeping()======================  <br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">20</span> <span class="hljs-number">23</span>:<span class="hljs-number">21</span>:<span class="hljs-number">33.892</span> [DEBUG] WaitVsSleep.class [t1] : slepping......<br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">20</span> <span class="hljs-number">23</span>:<span class="hljs-number">21</span>:<span class="hljs-number">38.895</span> [DEBUG] WaitVsSleep.class [t1] : stop slepping......<br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">20</span> <span class="hljs-number">23</span>:<span class="hljs-number">21</span>:<span class="hljs-number">38.895</span> [DEBUG] WaitVsSleep.class [main] : other......<br>================ interrupted()======================  <br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">20</span> <span class="hljs-number">23</span>:<span class="hljs-number">28</span>:<span class="hljs-number">37.489</span> [DEBUG] WaitVsSleep.class [t1] : slepping......<br><span class="hljs-number">2022</span>-<span class="hljs-number">03</span>-<span class="hljs-number">20</span> <span class="hljs-number">23</span>:<span class="hljs-number">28</span>:<span class="hljs-number">37.593</span> [DEBUG] WaitVsSleep.class [t1] : interrupted...<br>java.lang.InterruptedException<br>	at java.lang.Object.wait(Native Method)<br>	at com.itheima.thread.WaitVsSleep.lambda$interrupted$<span class="hljs-number">0</span>(WaitVsSleep.java:<span class="hljs-number">27</span>)<br>	at java.lang.Thread.run(Thread.java:<span class="hljs-number">748</span>)<br>进程已结束，退出代码为 <span class="hljs-number">0</span>    <br></code></pre></td></tr></table></figure>





<h2 id="lock-vs-synchronized"><a href="#lock-vs-synchronized" class="headerlink" title="lock vs synchronized"></a>lock vs synchronized</h2><ul>
<li>语法层面</li>
</ul>
<ol>
<li>synchronized是java中的关键字，是用C++实现的，源码在JVM中（java中的内置锁）</li>
<li>Lock是接口，源码在jdk中可以找到，用java语言实现的</li>
<li>使用synchronized时，退出同步代码块会自动释放锁，而是用Lock时，需要手动释放锁unlock方法 建议在finally块中释放锁</li>
</ol>
<ul>
<li>功能层面</li>
</ul>
<ol>
<li>二者都属于悲观锁，都具备互斥(多个线程争抢同一把锁，在同一时刻只能有一个线程可以获取)、同步(一个线程所需要的数据来源于另一个线程的结果，这种一个线程等待另一	个线程执行完毕，再进行后续操作的情况称为同步；synchronized通过wait、notify实现同步；lock通过await，single实现同步)、锁重入(对同一个对象加多道锁)。</li>
<li>Lock提供了许多synchronized不具备的功能，例如：获取等待状态(可以知到对于某个锁对象来说处于阻塞状态的线程有哪些，可以知到对于某个锁对象来说处于等待状态的		线程有哪些)、公平锁(多个争抢锁，先到先得；非公平锁：多个线程争抢锁，可以插队获得，效率更高；Lock两种都支持)、可打断(等不到锁，就把线程打断了，不能一直		无限等待)、可超时(可以设置超时时间，在规定时间内没能获取锁，就放弃获取该锁)、多条件变量。</li>
<li>Lock有适合不同场景的实现，如ReentrantLock、ReentrantReadWriteLock。</li>
</ol>
<ul>
<li>性能层面</li>
</ul>
<p>在没有竞争时，synchronized做了很多优化，如偏向锁，轻量级锁，性能不错<br>在竞争激烈时，Lock的实现通常可以提供更好的性能</p>
<h2 id="可重入锁理解"><a href="#可重入锁理解" class="headerlink" title="可重入锁理解"></a>可重入锁理解</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.lock;<br><br><span class="hljs-keyword">import</span> org.slf4j.Logger;<br><span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.locks.Condition;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.ReentrantLock;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReentratLockDemo</span> &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">LOGGER</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(<span class="hljs-string">&quot;ReentratLockDemo.class&quot;</span>);<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">LOCK</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>(<span class="hljs-literal">false</span>);<br>    <span class="hljs-comment">//用作同步操作</span><br>    <span class="hljs-comment">//通过ReentrantLock创建的两个等待队列，当线程在运行代码时，发现条件不满足，就会把自己停止，进入等待队列 waiting queue（单链表）</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Condition</span> <span class="hljs-variable">c1</span> <span class="hljs-operator">=</span> LOCK.newCondition();<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Condition</span> <span class="hljs-variable">c2</span> <span class="hljs-operator">=</span> LOCK.newCondition();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        System.out.println(LOCK);<br>        <span class="hljs-comment">//ReentrantLock里面有一个变量owner，记录自己是被哪个线程持有</span><br>        <span class="hljs-comment">// 有一个state变量用于记录被上锁的次数</span><br>        <span class="hljs-comment">// (可重入锁，在该程序中可以进行多次上锁，没上一次锁，state的值就会加一，而通过该锁对象的unlock方法可以解锁一次，state减一，当state值为零时，代表该锁没有被占有)</span><br>        <span class="hljs-comment">//当抢不到该锁的线程就会进入该锁的阻塞队列中blocked queue单链表</span><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            LOCK.lock();<br>            LOGGER.debug(Thread.currentThread().getName() + <span class="hljs-string">&quot; using lock&quot;</span>);<br>        &#125;, <span class="hljs-string">&quot;t1&quot;</span>).start();<br>		<span class="hljs-comment">//保证进入阻塞队列的线程是t1 t2 t3 t4</span><br>        Thread.sleep(<span class="hljs-number">100</span>);<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            LOCK.lock();<br>            LOGGER.debug(Thread.currentThread().getName() + <span class="hljs-string">&quot; using lock&quot;</span>);<br>        &#125;, <span class="hljs-string">&quot;t2&quot;</span>).start();<br><br>        Thread.sleep(<span class="hljs-number">100</span>);<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            LOCK.lock();<br>            LOGGER.debug(Thread.currentThread().getName() + <span class="hljs-string">&quot; using lock&quot;</span>);<br>        &#125;, <span class="hljs-string">&quot;t3&quot;</span>).start();<br><br>        Thread.sleep(<span class="hljs-number">100</span>);<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            LOCK.lock();<br>            LOGGER.debug(Thread.currentThread().getName() + <span class="hljs-string">&quot; using lock&quot;</span>);<br>        &#125;, <span class="hljs-string">&quot;t4&quot;</span>).start();<br>    &#125;<br>&#125;<br>======================================================<br>java.util.concurrent.locks.ReentrantLock@6a2bcfcb[Unlocked]<br><span class="hljs-number">13</span>:<span class="hljs-number">53</span>:<span class="hljs-number">53.151</span> [t1] DEBUG ReentratLockDemo.class - t1 using lock<br><span class="hljs-number">13</span>:<span class="hljs-number">54</span>:<span class="hljs-number">07.188</span> [t2] DEBUG ReentratLockDemo.class - t2 using lock<br><span class="hljs-number">13</span>:<span class="hljs-number">54</span>:<span class="hljs-number">19.461</span> [t3] DEBUG ReentratLockDemo.class - t3 using lock<br><span class="hljs-number">13</span>:<span class="hljs-number">54</span>:<span class="hljs-number">29.408</span> [t4] DEBUG ReentratLockDemo.class - t4 using lock<br></code></pre></td></tr></table></figure>

<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-23_13-57-05.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<h2 id="公平锁-amp-非公平锁"><a href="#公平锁-amp-非公平锁" class="headerlink" title="公平锁 &amp; 非公平锁"></a>公平锁 &amp; 非公平锁</h2><ul>
<li>代码体现</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.lock;<br><br><span class="hljs-keyword">import</span> org.slf4j.Logger;<br><span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.Condition;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.ReentrantLock;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReentratLockDemo</span> &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">LOGGER</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(<span class="hljs-string">&quot;ReentratLockDemo.class&quot;</span>);<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">LOCK</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>(<span class="hljs-literal">false</span>);<br>    <span class="hljs-comment">//用作同步操作</span><br>    <span class="hljs-comment">//通过ReentrantLock创建的两个等待队列，当线程在运行代码时，发现条件不满足，就会把自己停止，进入等待队列 waiting queue（单链表）</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Condition</span> <span class="hljs-variable">c1</span> <span class="hljs-operator">=</span> LOCK.newCondition();<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Condition</span> <span class="hljs-variable">c2</span> <span class="hljs-operator">=</span> LOCK.newCondition();<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">stop</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        System.out.println(LOCK);<br>        <span class="hljs-comment">//ReentrantLock里面有一个变量owner，记录自己是被哪个线程持有</span><br>        <span class="hljs-comment">// 有一个state变量用于记录被上锁的次数</span><br>        <span class="hljs-comment">// (可重入锁，在该程序中可以进行多次上锁，没上一次锁，state的值就会加一，而通过该锁对象的unlock方法可以解锁一次，state减一，当state值为零时，代表该锁没有被占有)</span><br>        <span class="hljs-comment">//当抢不到该锁的线程就会进入该锁的阻塞队列中blocked queue单链表</span><br>        <span class="hljs-comment">//按照阻塞队列的入队顺序执行线程</span><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            LOCK.lock();<br>            LOGGER.debug(Thread.currentThread().getName() + <span class="hljs-string">&quot; using lock&quot;</span>);<br>            sleep1s();<br>            LOCK.unlock();<br>        &#125;, <span class="hljs-string">&quot;t1&quot;</span>).start();<br><br>        Thread.sleep(<span class="hljs-number">100</span>);<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            LOCK.lock();<br>            LOGGER.debug(Thread.currentThread().getName() + <span class="hljs-string">&quot; using lock&quot;</span>);<br>            sleep1s();<br>            LOCK.unlock();<br>        &#125;, <span class="hljs-string">&quot;t2&quot;</span>).start();<br><br>        Thread.sleep(<span class="hljs-number">100</span>);<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            LOCK.lock();<br>            LOGGER.debug(Thread.currentThread().getName() + <span class="hljs-string">&quot; using lock&quot;</span>);<br>            sleep1s();<br>            LOCK.unlock();<br>        &#125;, <span class="hljs-string">&quot;t3&quot;</span>).start();<br><br>        Thread.sleep(<span class="hljs-number">100</span>);<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            LOCK.lock();<br>            LOGGER.debug(Thread.currentThread().getName() + <span class="hljs-string">&quot; using lock&quot;</span>);<br>            sleep1s();<br>            LOCK.unlock();<br>        &#125;, <span class="hljs-string">&quot;t4&quot;</span>).start();<br><br>        <span class="hljs-comment">//没能创建一个打乱公平的线程</span><br><span class="hljs-comment">//        LOGGER.debug(flag + &quot;&quot;);</span><br><br>        <span class="hljs-keyword">while</span> (!stop) &#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-comment">//尝试获得锁，但只会等10秒，10秒后就不等了，返回false</span><br>                    <span class="hljs-comment">//上面直接调用LOCK.lock();就会死等</span><br>                    <span class="hljs-comment">//这个获取不到锁也不会进入阻塞队列，在非公平的情况下，不进入阻塞队列中的线程有机会随机插在有顺序的阻塞队列中的线程里面(外面)</span><br>                    <span class="hljs-comment">//这里记住是10毫秒，太长，就会产生很多线程；因为在没有收到stop标志位改变时，就会一直创建线程，即使这些线程中有一个是创建成功的</span><br>                    <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> LOCK.tryLock(<span class="hljs-number">10</span>, TimeUnit.MILLISECONDS);<br><br>                    <span class="hljs-comment">//这个无参tryLock无论ReentrantLock的参数是真还是假，哪个不进入阻塞队列中的线程会按照不公平的来</span><br><span class="hljs-comment">//                    final boolean b = LOCK.tryLock();</span><br>                    <span class="hljs-comment">//抢到锁</span><br>                    <span class="hljs-keyword">if</span> (b) &#123;<br>                        LOGGER.debug(Thread.currentThread().getName() + <span class="hljs-string">&quot; using lock&quot;</span>);<br>                        stop = <span class="hljs-literal">true</span>;<br>                        sleep1s();<br>                        LOCK.unlock();<br>                    &#125;<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;, <span class="hljs-string">&quot;others&quot;</span>).start();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sleep1s</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">1000</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br>==============有参tryLock====== <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>(<span class="hljs-literal">false</span>)=============<br>java.util.concurrent.locks.ReentrantLock<span class="hljs-meta">@c4437c4</span>[Unlocked]<br><span class="hljs-number">15</span>:<span class="hljs-number">12</span>:<span class="hljs-number">22.267</span> [t1] DEBUG ReentratLockDemo.class - t1 using lock<br><span class="hljs-number">15</span>:<span class="hljs-number">12</span>:<span class="hljs-number">23.270</span> [t2] DEBUG ReentratLockDemo.class - t2 using lock<br><span class="hljs-number">15</span>:<span class="hljs-number">12</span>:<span class="hljs-number">24.278</span> [others] DEBUG ReentratLockDemo.class - others using lock<span class="hljs-comment">//后到先来</span><br><span class="hljs-number">15</span>:<span class="hljs-number">12</span>:<span class="hljs-number">25.291</span> [t3] DEBUG ReentratLockDemo.class - t3 using lock<br><span class="hljs-number">15</span>:<span class="hljs-number">12</span>:<span class="hljs-number">26.303</span> [t4] DEBUG ReentratLockDemo.class - t4 using lock<br>==============有参tryLock====== <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>(<span class="hljs-literal">true</span>)=============<br>java.util.concurrent.locks.ReentrantLock<span class="hljs-meta">@c4437c4</span>[Unlocked]<br><span class="hljs-number">15</span>:<span class="hljs-number">16</span>:<span class="hljs-number">50.291</span> [t1] DEBUG ReentratLockDemo.class - t1 using lock<br><span class="hljs-number">15</span>:<span class="hljs-number">16</span>:<span class="hljs-number">51.291</span> [t2] DEBUG ReentratLockDemo.class - t2 using lock<br><span class="hljs-number">15</span>:<span class="hljs-number">16</span>:<span class="hljs-number">52.291</span> [t3] DEBUG ReentratLockDemo.class - t3 using lock<br><span class="hljs-number">15</span>:<span class="hljs-number">16</span>:<span class="hljs-number">53.291</span> [t4] DEBUG ReentratLockDemo.class - t4 using lock<br><span class="hljs-number">15</span>:<span class="hljs-number">16</span>:<span class="hljs-number">54.760</span> [others] DEBUG ReentratLockDemo.class - others using lock<span class="hljs-comment">//按公平的来，先到先得</span><br>==============无参tryLock====== <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>(<span class="hljs-literal">true</span>)=============<br>java.util.concurrent.locks.ReentrantLock<span class="hljs-meta">@c4437c4</span>[Unlocked]<br><span class="hljs-number">15</span>:<span class="hljs-number">18</span>:<span class="hljs-number">12.650</span> [t1] DEBUG ReentratLockDemo.class - t1 using lock<br><span class="hljs-number">15</span>:<span class="hljs-number">18</span>:<span class="hljs-number">13.651</span> [others] DEBUG ReentratLockDemo.class - others using lock<span class="hljs-comment">//后到先来</span><br><span class="hljs-number">15</span>:<span class="hljs-number">18</span>:<span class="hljs-number">14.667</span> [t2] DEBUG ReentratLockDemo.class - t2 using lock<br><span class="hljs-number">15</span>:<span class="hljs-number">18</span>:<span class="hljs-number">15.667</span> [t3] DEBUG ReentratLockDemo.class - t3 using lock<br><span class="hljs-number">15</span>:<span class="hljs-number">18</span>:<span class="hljs-number">16.667</span> [t4] DEBUG ReentratLockDemo.class - t4 using lock<br></code></pre></td></tr></table></figure>

<h2 id="lock条件变量演示"><a href="#lock条件变量演示" class="headerlink" title="lock条件变量演示"></a>lock条件变量演示</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.lock;<br><br><span class="hljs-keyword">import</span> org.slf4j.Logger;<br><span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.locks.Condition;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.ReentrantLock;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReentratLockDemo1</span> &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">LOGGER</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(<span class="hljs-string">&quot;fgcy&quot;</span>);<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">LOCK</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>(<span class="hljs-literal">false</span>);<br>    <span class="hljs-comment">//用作同步操作</span><br>    <span class="hljs-comment">//通过ReentrantLock创建的两个等待队列，当线程在运行代码时，发现条件不满足，就会把自己停止(让出锁和cpu)，进入等待队列 waiting queue（单链表）</span><br>    <span class="hljs-comment">// 当被人唤醒或等待时间到了就会离开condition队列，当没有获得锁时，在阻塞队列尾部插入自己的线程(等获得锁后，就会从上次终止的位置开始执行)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Condition</span> <span class="hljs-variable">c1</span> <span class="hljs-operator">=</span> LOCK.newCondition();<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Condition</span> <span class="hljs-variable">c2</span> <span class="hljs-operator">=</span> LOCK.newCondition();<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">stop</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//人为控制顺序 1</span><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                LOCK.lock();<br>                LOGGER.debug(Thread.currentThread().getName() + <span class="hljs-string">&quot; using lock&quot;</span>);<br>                LOGGER.debug(Thread.currentThread().getName() + <span class="hljs-string">&quot; before into c1 Condition&quot;</span>);<br>                <span class="hljs-comment">//进入condition队列(释放掉锁和cpu)</span><br>                <span class="hljs-keyword">if</span> (<span class="hljs-literal">true</span>) c1.await();<br>                LOGGER.debug(Thread.currentThread().getName() + <span class="hljs-string">&quot; getout from c1 Condition and getout from blocked queue&quot;</span>);<br>                LOCK.unlock();<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;, <span class="hljs-string">&quot;t1&quot;</span>).start();<br><br>        <span class="hljs-comment">//人为控制顺序 2</span><br>        Thread.sleep(<span class="hljs-number">100</span>);<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                LOCK.lock();<br>                LOGGER.debug(Thread.currentThread().getName() + <span class="hljs-string">&quot; using lock&quot;</span>);<br>                LOGGER.debug(Thread.currentThread().getName() + <span class="hljs-string">&quot; before into c2 Condition&quot;</span>);<br>                <span class="hljs-comment">//在c1 condition queue中随机获取一个线程唤醒</span><br>                c1.signal();<br>                <span class="hljs-comment">//进入condition队列(释放掉锁和cpu)</span><br>                <span class="hljs-keyword">if</span> (<span class="hljs-literal">true</span>) c2.await();<br>                LOGGER.debug(Thread.currentThread().getName() + <span class="hljs-string">&quot; getout from c2 Condition and getout from blocked queue&quot;</span>);<br>                LOCK.unlock();<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;, <span class="hljs-string">&quot;t2&quot;</span>).start();<br><br>        <span class="hljs-comment">//人为控制顺序 3</span><br>        Thread.sleep(<span class="hljs-number">100</span>);<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                LOCK.lock();<br>                LOGGER.debug(Thread.currentThread().getName() + <span class="hljs-string">&quot; using lock&quot;</span>);<br>                LOGGER.debug(Thread.currentThread().getName() + <span class="hljs-string">&quot; before into c2 Condition&quot;</span>);<br>                <span class="hljs-comment">//进入condition队列(释放掉锁和cpu)</span><br>                <span class="hljs-keyword">if</span> (<span class="hljs-literal">true</span>) c2.await();<br>                LOGGER.debug(Thread.currentThread().getName() + <span class="hljs-string">&quot; getout from c2 Condition and getout from blocked queue&quot;</span>);<br>                LOCK.unlock();<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;, <span class="hljs-string">&quot;t3&quot;</span>).start();<br>        <span class="hljs-comment">//人为控制顺序 4</span><br>        Thread.sleep(<span class="hljs-number">100</span>);<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                LOCK.lock();<br>                LOGGER.debug(Thread.currentThread().getName() + <span class="hljs-string">&quot; using lock&quot;</span>);<br>                <span class="hljs-comment">//唤醒condition c2 queue中的全部线程(有没有获得锁的情况下，按照condition c2 queue中顺序进入blocked queue；在获得锁对象情况下，按condition c2 queue中顺序执行)</span><br>                c2.signalAll();<br>                <span class="hljs-comment">//进入condition队列(释放掉锁和cpu)</span><br>                LOGGER.debug(Thread.currentThread().getName() + <span class="hljs-string">&quot; end&quot;</span>);<br>                LOCK.unlock();<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;, <span class="hljs-string">&quot;t4&quot;</span>).start();<br>    &#125;<br>&#125;<br>===================================================================<br><span class="hljs-number">16</span>:<span class="hljs-number">39</span>:<span class="hljs-number">48.707</span> [t1] DEBUG fgcy - t1 using lock<br><span class="hljs-number">16</span>:<span class="hljs-number">39</span>:<span class="hljs-number">48.709</span> [t1] DEBUG fgcy - t1 before into c1 Condition<br><span class="hljs-number">16</span>:<span class="hljs-number">39</span>:<span class="hljs-number">48.709</span> [t2] DEBUG fgcy - t2 using lock<br><span class="hljs-number">16</span>:<span class="hljs-number">39</span>:<span class="hljs-number">48.709</span> [t2] DEBUG fgcy - t2 before into c2 Condition<br><span class="hljs-number">16</span>:<span class="hljs-number">39</span>:<span class="hljs-number">48.709</span> [t3] DEBUG fgcy - t3 using lock<br><span class="hljs-number">16</span>:<span class="hljs-number">39</span>:<span class="hljs-number">48.709</span> [t3] DEBUG fgcy - t3 before into c2 Condition<br><span class="hljs-number">16</span>:<span class="hljs-number">39</span>:<span class="hljs-number">48.709</span> [t4] DEBUG fgcy - t4 using lock<br><span class="hljs-number">16</span>:<span class="hljs-number">39</span>:<span class="hljs-number">48.709</span> [t4] DEBUG fgcy - t4 end<br><span class="hljs-number">16</span>:<span class="hljs-number">39</span>:<span class="hljs-number">48.709</span> [t1] DEBUG fgcy - t1 getout from c1 Condition and getout from blocked queue<br><span class="hljs-number">16</span>:<span class="hljs-number">39</span>:<span class="hljs-number">48.710</span> [t2] DEBUG fgcy - t2 getout from c2 Condition and getout from blocked queue<br><span class="hljs-number">16</span>:<span class="hljs-number">39</span>:<span class="hljs-number">48.710</span> [t3] DEBUG fgcy - t3 getout from c2 Condition and getout from blocked queue<br></code></pre></td></tr></table></figure>

<h2 id="volatile能否保证线程安全"><a href="#volatile能否保证线程安全" class="headerlink" title="volatile能否保证线程安全"></a>volatile能否保证线程安全</h2><h3 id="线程安全要考虑的三个因素"><a href="#线程安全要考虑的三个因素" class="headerlink" title="线程安全要考虑的三个因素"></a>线程安全要考虑的三个因素</h3><ol>
<li>可见性: 一个线程对共享变量做出了修改，其他的线程要能看到最新的结果</li>
<li>有序性: 一个线程内代码必须按编写顺序执行(指令重排序会破坏)</li>
<li>原子性:一个线程内的多行代码以一个整体执行，期间不能被其他线程的代码插队</li>
</ol>
<h3 id="关键字volatile"><a href="#关键字volatile" class="headerlink" title="关键字volatile"></a>关键字volatile</h3><p>volatile关键字只能保证共享变量的有序性和可见性，不能保证原子性</p>
<h4 id="原子性举例"><a href="#原子性举例" class="headerlink" title="原子性举例"></a>原子性举例</h4><ul>
<li>对字节码文件进行反编译</li>
</ul>
<figure class="highlight moonscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs moonscript"><span class="hljs-name">D</span>:\learn\tencentClass\interview\ChanzPodcast\base\Project\one\target\classes\com\itheima\lock&gt;javap -p -v VolatitleDemo1.<span class="hljs-keyword">class</span><br></code></pre></td></tr></table></figure>

<ul>
<li>add方法中的一行java代码对应的指令</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add5</span><span class="hljs-params">()</span>;<br>       <span class="hljs-number">0</span>: getstatic     #<span class="hljs-number">9</span>                  <span class="hljs-comment">// Field N:I //获取常量N的值</span><br>       <span class="hljs-number">3</span>: iconst_5                          <span class="hljs-comment">//准备一个数字五</span><br>       <span class="hljs-number">4</span>: iadd							  <span class="hljs-comment">//将获取到的值加五</span><br>       <span class="hljs-number">5</span>: putstatic     #<span class="hljs-number">9</span>                  <span class="hljs-comment">// Field N:I//将计算到的值给到N</span><br>       <span class="hljs-number">8</span>: <span class="hljs-keyword">return</span>						      <span class="hljs-comment">//结束方法</span><br></code></pre></td></tr></table></figure>

<ul>
<li>substract方法中的一行java代码对应的指令</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">subtract5</span><span class="hljs-params">()</span>;<br>        <span class="hljs-number">0</span>: getstatic     #<span class="hljs-number">9</span>                  <span class="hljs-comment">// Field N:I////获取常量N的值</span><br>        <span class="hljs-number">3</span>: iconst_5						  <span class="hljs-comment">//准备一个数字五</span><br>        <span class="hljs-number">4</span>: isub							  <span class="hljs-comment">//将获取到的值加五</span><br>        <span class="hljs-number">5</span>: putstatic     #<span class="hljs-number">9</span>                  <span class="hljs-comment">// Field N:I//将计算到的值给到N</span><br>        <span class="hljs-number">8</span>: <span class="hljs-keyword">return</span>							 <span class="hljs-comment">//结束方法</span><br></code></pre></td></tr></table></figure>

<ul>
<li>原子性例子</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java">t1 <span class="hljs-number">10</span>         <br><span class="hljs-number">0</span>: getstatic <span class="hljs-number">10</span>    <br>                 t2 <span class="hljs-number">10</span><br>                 <span class="hljs-number">0</span>: getstatic   <span class="hljs-number">10</span>               <br>                 <span class="hljs-number">3</span>: iconst_5						  <br>                 <span class="hljs-number">4</span>: isub		<span class="hljs-number">10</span>+<span class="hljs-number">5</span>					 <br>                 <span class="hljs-number">5</span>: putstatic     <span class="hljs-number">15</span>        <br>                 <span class="hljs-number">8</span>: <span class="hljs-keyword">return</span>	         <br>         <br><span class="hljs-number">3</span>: iconst_5<br><span class="hljs-number">4</span>: isub        <span class="hljs-number">10</span>-<span class="hljs-number">5</span><br><span class="hljs-number">5</span>: putstatic    <span class="hljs-number">5</span>        <br><span class="hljs-number">8</span>: <span class="hljs-keyword">return</span><br></code></pre></td></tr></table></figure>

<p>在多线程下发生指令交错的情况，就可能产生意料之外的结果</p>
<ul>
<li><p>解决:</p>
<ol>
<li><p>保证指令是原子的</p>
</li>
<li><p>加锁，将多条指令用锁锁起来，作为同一条指令（一个整体）</p>
<ol start="3">
<li>CAS来实现无锁原子操作</li>
</ol>
</li>
</ol>
</li>
<li><p>代码体现</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.lock;<br><br><span class="hljs-keyword">import</span> org.slf4j.Logger;<br><span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VolatitleDemo1</span> &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> <span class="hljs-variable">N</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">fgcy</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(<span class="hljs-string">&quot;fgcy&quot;</span>);<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            add5();<br>        &#125;).start();<br><br><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            subtract5();<br>        &#125;).start();<br><br>        Thread.sleep(<span class="hljs-number">1</span>);<br>        fgcy.debug(String.valueOf(N));<span class="hljs-comment">//7 输出N</span><br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">subtract5</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//这虽然一行命令不是一个原子操作，他包含多个命令</span><br>        <span class="hljs-comment">//N -= 5;</span><br>        <span class="hljs-comment">//模拟等价操作</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> N;<span class="hljs-comment">//1 拿到值 10</span><br>        b -= <span class="hljs-number">5</span>;<span class="hljs-comment">//3 用b减五</span><br>        N = b;<span class="hljs-comment">// 4 改变静态成员</span><br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add5</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//这虽然一行命令不是一个原子操作，他包含多个命令</span><br>        <span class="hljs-comment">//N += 5;</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> N;<span class="hljs-comment">//2 拿到值 10</span><br>        b += <span class="hljs-number">5</span>; <span class="hljs-comment">//5 用b加五</span><br>        N = b;<span class="hljs-comment">// 6 改变静态成员</span><br>    &#125;<br>&#125;<br>==============================================<br><span class="hljs-number">21</span>:<span class="hljs-number">00</span>:<span class="hljs-number">19.643</span> [main] DEBUG fgcy - <span class="hljs-number">15</span><br></code></pre></td></tr></table></figure>







<h4 id="可见性例子"><a href="#可见性例子" class="headerlink" title="可见性例子"></a>可见性例子</h4><ul>
<li>问题引出</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.lock;<br><br><span class="hljs-keyword">import</span> org.slf4j.Logger;<br><span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VolatitleDemo2</span> &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">stop</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">fgcy</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(<span class="hljs-string">&quot;fgcy&quot;</span>);<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">100</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            <span class="hljs-comment">//等0.1秒后将stop改为true</span><br>            <span class="hljs-comment">//输出stopping .....并统计次数</span><br>            stop = <span class="hljs-literal">true</span>;<br>            fgcy.debug(<span class="hljs-string">&quot;modify stop to true...&quot;</span>);<br>        &#125;).start();<br>        fool();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fool</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">while</span> (!stop) &#123;<br>            i++;<br>        &#125;<br>        fgcy.debug(<span class="hljs-string">&quot;stopping .....&quot;</span> + i);<br>    &#125;<br>&#125;<br>================================================<br><span class="hljs-number">21</span>:<span class="hljs-number">43</span>:<span class="hljs-number">14.988</span> [Thread-<span class="hljs-number">0</span>] DEBUG fgcy - modify stop to <span class="hljs-literal">true</span>...<span class="hljs-comment">//循环还没有结束，主线程在一直死循环 </span><br>    <br></code></pre></td></tr></table></figure>







<p>问题： 一个线程对共享变量做出修改，另一个线程没能读取到最新的值</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823205351778.png" srcset="/img/loading.gif" lazyload alt="image-20220823205351778"></p>
<hr>
<ol>
<li><p>JIT（java的即时编译器）：JVM的组成部分，主要是对热点代码进行优化解析。</p>
</li>
<li><p>热点代码:频繁调用的方法，包括反复调用的循环。</p>
</li>
<li><p>java代码会转化为字节码指令，然后通过解释器将字节码文件逐行转化为机器码，然后交给cpu执行。</p>
</li>
<li><p>上面的情况，JIT产生了了大胆的想法；它认为哪个while循环执行了十多万次(0.1s)都是执行同样的代码，它直接将stop为false的情况转为机器码缓存起来，等到有人调	用这段代码时，就直接运行缓存起来的机器码；这就才造成了一个线程对共享变量做出修改，其他线程没能读取到最新的值;JIT也留了一手，就是当需要原来的代码时，会将原	  来的代码替换回来。</p>
</li>
</ol>
<ul>
<li>验证</li>
</ul>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-23_23-34-01.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<p>代码体现1 【更改jvm参数，-Xint 功能:只用解释器执行的方法执行java代码，不使用JIT进行代码优化】</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.lock;<br><br><span class="hljs-keyword">import</span> org.slf4j.Logger;<br><span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VolatitleDemo2</span> &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">stop</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">fgcy</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(<span class="hljs-string">&quot;fgcy&quot;</span>);<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">100</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            stop = <span class="hljs-literal">true</span>;<br>            fgcy.debug(<span class="hljs-string">&quot;modify stop to true...&quot;</span>);<br>        &#125;).start();<br>        fool();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fool</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">while</span> (!stop) &#123;<br>            i++;<br>        &#125;<br>        fgcy.debug(<span class="hljs-string">&quot;stopping .....&quot;</span> + i);<br>    &#125;<br>&#125;<br>====================================<br><span class="hljs-number">23</span>:<span class="hljs-number">33</span>:<span class="hljs-number">28.971</span> [main] DEBUG fgcy - stopping ....<span class="hljs-number">.25339669</span><br><span class="hljs-number">23</span>:<span class="hljs-number">33</span>:<span class="hljs-number">28.971</span> [Thread-<span class="hljs-number">0</span>] DEBUG fgcy - modify stop to <span class="hljs-literal">true</span>...<br><br>进程已结束，退出代码为 <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>









<p>代码体现二：让循环的次数没那么多，不足以让JIT认为这是一段热点代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.lock;<br><br><span class="hljs-keyword">import</span> org.slf4j.Logger;<br><span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VolatitleDemo2</span> &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">stop</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">fgcy</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(<span class="hljs-string">&quot;fgcy&quot;</span>);<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">//只等待0.01s 不足以让JIT认为 while代码段是一段热点代码</span><br>                Thread.sleep(<span class="hljs-number">1</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            stop = <span class="hljs-literal">true</span>;<br>            fgcy.debug(<span class="hljs-string">&quot;modify stop to true...&quot;</span>);<br>        &#125;).start();<br>        fool();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fool</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">while</span> (!stop) &#123;<br>            i++;<br>        &#125;<br>        fgcy.debug(<span class="hljs-string">&quot;stopping .....&quot;</span> + i);<br>    &#125;<br>&#125;<br>===============================================<br><span class="hljs-number">23</span>:<span class="hljs-number">43</span>:<span class="hljs-number">13.485</span> [main] DEBUG fgcy - stopping ....<span class="hljs-number">.71036</span><br><span class="hljs-number">23</span>:<span class="hljs-number">43</span>:<span class="hljs-number">13.485</span> [Thread-<span class="hljs-number">0</span>] DEBUG fgcy - modify stop to <span class="hljs-literal">true</span>...<br><br>进程已结束，退出代码为 <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>







<p>体现三【只有被JIT替换掉的热点代码所在的线程不能获取更新后的值，其他线程可以】(JIT的c1编译器能提升5倍的性能，c2编译器能提升10-100倍的性能)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.lock;<br><br><span class="hljs-keyword">import</span> org.slf4j.Logger;<br><span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VolatitleDemo2</span> &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">stop</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">fgcy</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(<span class="hljs-string">&quot;fgcy&quot;</span>);<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">//只等待0.01s 不足以让JIT认为 while代码段是一段热点代码</span><br>                Thread.sleep(<span class="hljs-number">100</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            stop = <span class="hljs-literal">true</span>;<br>            fgcy.debug(<span class="hljs-string">&quot;modify stop to true...&quot;</span>);<br>        &#125;, <span class="hljs-string">&quot;t1&quot;</span>).start();<br><br>        <span class="hljs-comment">//人为控制t1线程先走</span><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">1000</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            fgcy.debug(<span class="hljs-string">&quot;STOP IS &quot;</span> + stop);<br>        &#125;, <span class="hljs-string">&quot;t2&quot;</span>).start();<br><br>        fool();<br><br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fool</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">while</span> (!stop) &#123;<br>            i++;<br>        &#125;<br>        fgcy.debug(<span class="hljs-string">&quot;stopping .....&quot;</span> + i);<br>    &#125;<br>&#125;<br>============================================<br><span class="hljs-number">23</span>:<span class="hljs-number">54</span>:<span class="hljs-number">57.835</span> [t1] DEBUG fgcy - modify stop to <span class="hljs-literal">true</span>...<br><span class="hljs-number">23</span>:<span class="hljs-number">54</span>:<span class="hljs-number">58.745</span> [t2] DEBUG fgcy - STOP IS <span class="hljs-literal">true</span><span class="hljs-comment">//循环还没有结束，主线程在一直死循环 </span><br>    <br></code></pre></td></tr></table></figure>







<p>根本解决办法使用关键字volatitle</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//JIT一旦发现某段代码的某个变量使用volatitle修饰，就不会对这段代码进行优化，即使这段是热点代码</span><br>    <br>  <span class="hljs-keyword">package</span> com.itheima.lock;<br><br><span class="hljs-keyword">import</span> org.slf4j.Logger;<br><span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VolatitleDemo2</span> &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">stop</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">fgcy</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(<span class="hljs-string">&quot;fgcy&quot;</span>);<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">//只等待0.01s 不足以让JIT认为 while代码段是一段热点代码</span><br>                Thread.sleep(<span class="hljs-number">100</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            stop = <span class="hljs-literal">true</span>;<br>            fgcy.debug(<span class="hljs-string">&quot;modify stop to true...&quot;</span>);<br>        &#125;, <span class="hljs-string">&quot;t1&quot;</span>).start();<br><br>        <span class="hljs-comment">//人为控制t1线程先走</span><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">1000</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            fgcy.debug(<span class="hljs-string">&quot;STOP IS &quot;</span> + stop);<br>        &#125;, <span class="hljs-string">&quot;t2&quot;</span>).start();<br><br>        fool();<br><br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fool</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">while</span> (!stop) &#123;<br>            i++;<br>        &#125;<br>        fgcy.debug(<span class="hljs-string">&quot;stopping .....&quot;</span> + i);<br>    &#125;<br>&#125;  <br>=======================================================<br><span class="hljs-number">00</span>:<span class="hljs-number">02</span>:<span class="hljs-number">11.462</span> [main] DEBUG fgcy - stopping ....<span class="hljs-number">.477446346</span><br><span class="hljs-number">00</span>:<span class="hljs-number">02</span>:<span class="hljs-number">11.462</span> [t1] DEBUG fgcy - modify stop to <span class="hljs-literal">true</span>...<br><span class="hljs-number">00</span>:<span class="hljs-number">02</span>:<span class="hljs-number">12.353</span> [t2] DEBUG fgcy - STOP IS <span class="hljs-literal">true</span><br><br>进程已结束，退出代码为 <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>



<h4 id="有序性"><a href="#有序性" class="headerlink" title="有序性"></a>有序性</h4><ul>
<li>当不发生指令重排序时，预料的值</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java">t1:<br> x=<span class="hljs-number">1</span><br> y=<span class="hljs-number">1</span><br> 	t2:<br>    result.r1=y<br>    result.r2=x<br>=================================<br><span class="hljs-string">&quot;1,1&quot;</span><br><br>t1:<br> x=<span class="hljs-number">1</span><br>   	t2:<br>    result.r1=y<br>    result.r2=x  <br> y=<span class="hljs-number">1</span><br> <br>=================================<br><span class="hljs-string">&quot;0,1&quot;</span><br>   <br>t2:<br>  result.r1=y<br>  result.r2=x  <br>        t1:<br>         	x=<span class="hljs-number">1</span><br>         	y=<span class="hljs-number">1</span><br> <br>=================================<br><span class="hljs-string">&quot;0,0&quot;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>当发生指令重排序时，可能的结果</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">y=<span class="hljs-number">1</span><br>    result.r1=y<br>    result.r=x<br>x=<span class="hljs-number">1</span><br>    <br><br>   result.r2=x <br>x=<span class="hljs-number">1</span><br>y=<span class="hljs-number">1</span><br>   result.r1=y<br>===============================<br><span class="hljs-string">&quot;1,0&quot;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>代码体现</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.lock;<br><br><span class="hljs-keyword">import</span> org.openjdk.jcstress.annotations.*;<br><span class="hljs-keyword">import</span> org.openjdk.jcstress.infra.results.II_Result;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 有序性</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Reordering</span> &#123;<br><br><br>    <span class="hljs-meta">@State</span><br>    <span class="hljs-meta">@JCStressTest</span><br>    <span class="hljs-meta">@Outcome(id = &#123;&quot;0,0&quot;, &quot;0,1&quot;, &quot;1,1&quot;&#125;, expect = Expect.ACCEPTABLE, desc = &quot;ACCEPTABLE&quot;)</span><br>    <span class="hljs-meta">@Outcome(id = &quot;1,0&quot;, expect = Expect.ACCEPTABLE_INTERESTING, desc = &quot;INTERESTING&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Case1</span> &#123;<br>        <span class="hljs-type">int</span> x;<br>        <span class="hljs-type">int</span> y;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 每次执行都会调用有<span class="hljs-doctag">@Actor</span>标注的方法(每轮循环分配一个线程进行测试)</span><br><span class="hljs-comment">         * 压力测试会尽可能测试足够巨大的次数(以查看所有的可能性)</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-meta">@Actor</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">actor1</span><span class="hljs-params">()</span> &#123;<br>            x = <span class="hljs-number">1</span>;<br>            y = <span class="hljs-number">1</span>;<br>        &#125;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 每次执行都会调用有<span class="hljs-doctag">@Actor</span>标注的方法(每轮循环分配一个线程进行测试)</span><br><span class="hljs-comment">         * 压力测试会尽可能测试足够巨大的次数(以查看所有的可能性)</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-meta">@Actor</span><br>        <span class="hljs-comment">//II_Result是用来接收结果值的</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">actor2</span><span class="hljs-params">(II_Result result)</span> &#123;<br>            <span class="hljs-comment">//r1对应outcome结果的第一位值，r2是第二位值，多组值之间用逗号隔开</span><br>            result.r1 = y;<br>            result.r2 = x;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-24_17-06-07.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs JAVA"><span class="hljs-keyword">package</span> com.itheima.lock;<br><br><span class="hljs-keyword">import</span> org.openjdk.jcstress.annotations.*;<br><span class="hljs-keyword">import</span> org.openjdk.jcstress.infra.results.II_Result;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 有序性</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Reordering</span> &#123;<br>    <span class="hljs-meta">@State</span><br>    <span class="hljs-meta">@JCStressTest</span><br>    <span class="hljs-meta">@Outcome(id = &#123;&quot;0,0&quot;, &quot;0,1&quot;, &quot;1,1&quot;&#125;, expect = Expect.ACCEPTABLE, desc = &quot;ACCEPTABLE&quot;)</span><br>    <span class="hljs-comment">//使用FORBIDDEN，当出现&quot;1,0&quot;的情况会直接报错</span><br>    <span class="hljs-meta">@Outcome(id = &quot;1,0&quot;, expect = Expect.FORBIDDEN, desc = &quot;FORBIDDEN&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Case2</span> &#123;<br>        <span class="hljs-type">int</span> x;<br>        <span class="hljs-comment">//加在这里可以阻止指令重排序</span><br>        <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> y;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 每次执行都会调用有<span class="hljs-doctag">@Actor</span>标注的方法(每轮循环分配一个线程进行测试)</span><br><span class="hljs-comment">         * 压力测试会尽可能测试足够巨大的次数(以查看所有的可能性)</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-meta">@Actor</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">actor1</span><span class="hljs-params">()</span> &#123;<br>            x = <span class="hljs-number">1</span>;<br>            y = <span class="hljs-number">1</span>;<br>        &#125;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 每次执行都会调用有<span class="hljs-doctag">@Actor</span>标注的方法(每轮循环分配一个线程进行测试)</span><br><span class="hljs-comment">         * 压力测试会尽可能测试足够巨大的次数(以查看所有的可能性)</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-meta">@Actor</span><br>        <span class="hljs-comment">//II_Result是用来接收结果值的</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">actor2</span><span class="hljs-params">(II_Result result)</span> &#123;<br>            <span class="hljs-comment">//r1对应outcome结果的第一位值，r2是第二位值，多组值之间用逗号隔开</span><br>            result.r1 = y;<br>            result.r2 = x;<br>        &#125;<br>    &#125;<br>&#125;<br>=================================<br>没有报错，说明指令重排序的问题被解决<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.lock;<br><br><span class="hljs-keyword">import</span> org.openjdk.jcstress.annotations.*;<br><span class="hljs-keyword">import</span> org.openjdk.jcstress.infra.results.II_Result;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 有序性</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Reordering</span> &#123;<br>    <span class="hljs-meta">@State</span><br>    <span class="hljs-meta">@JCStressTest</span><br>    <span class="hljs-meta">@Outcome(id = &#123;&quot;0,0&quot;, &quot;0,1&quot;, &quot;1,1&quot;&#125;, expect = Expect.ACCEPTABLE, desc = &quot;ACCEPTABLE&quot;)</span><br>    <span class="hljs-comment">//当参数是这个INTERESTING时，表示“1，0”是我感兴趣的结果</span><br>    <span class="hljs-meta">@Outcome(id = &quot;1,0&quot;, expect = Expect.ACCEPTABLE_INTERESTING, desc = &quot;INTERESTING&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Case3</span> &#123;<br>        <span class="hljs-comment">//加在这里不能阻止指令重排序</span><br>        <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> x;<br>        <span class="hljs-type">int</span> y;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 每次执行都会调用有<span class="hljs-doctag">@Actor</span>标注的方法(每轮循环分配一个线程进行测试)</span><br><span class="hljs-comment">         * 压力测试会尽可能测试足够巨大的次数(以查看所有的可能性)</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-meta">@Actor</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">actor1</span><span class="hljs-params">()</span> &#123;<br>            x = <span class="hljs-number">1</span>;<br>            y = <span class="hljs-number">1</span>;<br>        &#125;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 每次执行都会调用有<span class="hljs-doctag">@Actor</span>标注的方法(每轮循环分配一个线程进行测试)</span><br><span class="hljs-comment">         * 压力测试会尽可能测试足够巨大的次数(以查看所有的可能性)</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-meta">@Actor</span><br>        <span class="hljs-comment">//II_Result是用来接收结果值的</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">actor2</span><span class="hljs-params">(II_Result result)</span> &#123;<br>            <span class="hljs-comment">//r1对应outcome结果的第一位值，r2是第二位值，多组值之间用逗号隔开</span><br>            result.r1 = y;<br>            result.r2 = x;<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-24_17-17-54.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<h4 id="volatitle的原理"><a href="#volatitle的原理" class="headerlink" title="volatitle的原理"></a>volatitle的原理</h4><hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823205117219.png" srcset="/img/loading.gif" lazyload alt="image-20220823205117219"></p>
<hr>
<p>写操作内存屏障:保证写操作之前的指令不会越过内存屏障，在屏障之前的指令的顺序是不管的<br>读操作内存屏障:保证读操作之后的指令不能越过内存屏障，在屏障之后的指令的顺序就不管了</p>
<h2 id="悲观锁-amp-乐观锁"><a href="#悲观锁-amp-乐观锁" class="headerlink" title="悲观锁&amp;乐观锁"></a>悲观锁&amp;乐观锁</h2><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><ul>
<li>悲观锁</li>
</ul>
<p>悲观锁的代表是synchronized 和 Lock 锁<br>① 其核心思想是：线程只有占有了锁，才能去操作共享变量，每次只有一个线程占锁成功，获取锁失败的线程，都得停下来等待(进入阻塞队列)；当线程释放锁时，会从阻塞队列中挑一个线程运行<br>② 线程从运行到阻塞(此时需要记录执行到第几行，涉及哪些变量)、再从阻塞到唤醒(将之前保存的信息进行恢复)，涉及线程上下文切换，如果频繁发生，影响性能<br>③ 实际上，线程在获取 synchronized 和 Lock 锁时，如果锁已被占用，都会做几次重试操作(不会立刻阻塞，会先挣扎两下先)，减少阻塞的机会</p>
<ul>
<li>乐观锁</li>
</ul>
<p>乐观锁的代表是AtomicInteger【原子整数类】，使用CAS保证原子性<br>① 其核心思想是无需加锁，每次只有一个线程能成功修改共享变量，【其它失败的线程不需要停止，不断重试直至成功】<br>② 由于线程一直运行，不需要阻塞，因此不涉及线程上下文又切换<br>③ 它需要多核cpu支持，且线程数不应超过cpu核数【如果核数不够，又想让线程不停重试，就会发生频繁的上下文切换】</p>
<ul>
<li>CAS配合volatile实现并发-</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> jdk.internal.misc.Unsafe;<br><span class="hljs-comment">// --add-opens java.base/jdk.internal.misc=ALL-UNNAMED</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SyncVsCas</span> &#123;<br>    <span class="hljs-comment">//这个类可以保证修改共享变量是原子操作</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Unsafe</span> <span class="hljs-variable">U</span> <span class="hljs-operator">=</span> Unsafe.getUnsafe();<br>    <span class="hljs-comment">//获得某个类中的某个方法的偏移位置</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">BALANCE</span> <span class="hljs-operator">=</span> U.objectFieldOffset(Account.class, <span class="hljs-string">&quot;balance&quot;</span>);<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Account</span> &#123;<br>        <span class="hljs-comment">//Unsafe保证原子性操作，volatile保证可见性</span><br>        <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> <span class="hljs-variable">balance</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Account</span> <span class="hljs-variable">account</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Account</span>();<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> account.balance;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> o + <span class="hljs-number">5</span>;<br>            <span class="hljs-comment">//那o的值与最新的的值进行对比，如果一致就赋予新值</span><br>            <span class="hljs-keyword">if</span> (U.compareAndSetInt(account, BALANCE, o, n)) &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>小结</li>
</ul>
<p>synchronized是通过互斥的方式解决线程安全问题；</p>
<p>它将代码块内的多行语句作为一个整体执行(不会发生指令重排现象)，等待的队列进入该锁的阻塞队列；<br>CAS没有通过互斥解决线程安全，它即使是并行执行发生指令重排序也没有关系，但是它可以通过Unsafe类的比较并修改的方法判断此时想要修改的值有没有被人修改，没有就直接修改，有就循环调用逻辑代码，直到他修改的时候没发现有人在它前面做出修改。</p>
<h2 id="HashTable-amp-concurrentHashMap"><a href="#HashTable-amp-concurrentHashMap" class="headerlink" title="HashTable &amp; concurrentHashMap"></a>HashTable &amp; concurrentHashMap</h2><ol>
<li>Hashtable 与 ConcurrentHashMap 都是线程安全的 Map 集合,他们的键和值都不能为空。</li>
<li>Hashtable 并发度低,整个Hashtable 对应一把锁,同一时刻,只能有一个线程操作它【一把锁，锁住千家万户】。</li>
<li>【1.8 之前】 ConcurrentHashMap 使用了 Segment +数组+链表的结构,每个Segment对应一把锁,如果多个线程访问不同的Segment,则不会冲突；既是segment的数量与并发数有关。</li>
<li>【1.8 开始】 ConcurrentHashMap将【数组的每个头节点】(数组元素个数)作为锁,如果多个线程访问的头节点不同,则不会冲突；数组的容量决定了并发数。<br>① 演示并发 put。<br>② 演示扩容,说明三个问题forwardingNode,扩容时的get,扩容时的put。</li>
</ol>
<p>HashTable的初始容量不是2的n次幂，而是11，每次扩容都是上一次的容量*2加一，加载因子是0.75；当此时的数组容量是11时，若此时元素个数为9则触发扩容。<br>因为HashTable的初始容量不是2的n次幂，所以不用进行二次hash，他的容量是质数，所以计算出来的桶下标分布会比较均匀。</p>
<h3 id="concurrentHashMap"><a href="#concurrentHashMap" class="headerlink" title="concurrentHashMap"></a>concurrentHashMap</h3><ul>
<li>初识</li>
</ul>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-25_09-28-20.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<ul>
<li>Segment索引计算</li>
</ul>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-25_10-18-06.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<ul>
<li>扩容</li>
</ul>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-25_11-08-22.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<ul>
<li>比较1.7的ConcurrentHashMap</li>
</ul>
<p><strong>JDK1.7：</strong></p>
<pre><code class="hljs"> 1. segment数组+HashEntry数组+链表
 2. 在使用构造器创建ConcurrentHashMap对象的时候，就会创建好segment的数组(默认长度为11),包括在segment[0]中创建一个长度为2的HashEntry数组，   可以看成是饿汉式初始化。
 3. 头插法。
 4. 当HashEntry数组中的所有元素超过额定值(当前数组长度*加载因子)，扩容为原来的2倍。
 5. HashEntry数组的初始长度为(capacity/clevel)，当大于二时，取大的值；否则取二。
</code></pre>
<p><strong>JDK1.8：</strong></p>
<ol>
<li><p>数组+链表|红黑树。</p>
</li>
<li><p>在使用构造器创建ConcurrentHashMap对象时，并没有创建底层的数组结构；底层的数组结构是在put第一个元素时创建的可以看成式懒汉式初始化。</p>
</li>
<li><p>尾插法。</p>
</li>
<li><p>当数组中的所有元素达到额定值(当前数组长度*加载因子)，扩容为原来的2倍。</p>
</li>
<li><p>当构造器的capacity参数值为16时，这个参数代表我要在这个数组中放16个元素，此时数组长度*0.75(factor)要大于16，所以此时数组长度为32。</p>
</li>
<li><p>构造器中的有两个参数分别是capacity和factor这两个参数都会在第一次创建数组时才生效，其他的时候factor会默认使用加载因子0.75计算额定值 。</p>
</li>
</ol>
<ul>
<li>并发put</li>
</ul>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-25_13-05-50.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<ul>
<li>扩容</li>
</ul>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823211012412.png" srcset="/img/loading.gif" lazyload alt="image-20220823211012412"></p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-25_16-12-13.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<h2 id="谈谈对ThreadLocal的理解"><a href="#谈谈对ThreadLocal的理解" class="headerlink" title="谈谈对ThreadLocal的理解"></a>谈谈对ThreadLocal的理解</h2><ol>
<li>ThreadLocal 可以实现【资源对象】的线程隔离,让每个线程各用各的【资源对象】,避免争用引发的线程安全问题(线程间的资源隔离)</li>
<li>ThreadLocal 同时实现了线程内的资源共享</li>
</ol>
<ul>
<li>代码实现</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> day02;<br><br><br><span class="hljs-keyword">import</span> java.sql.Connection;<br><span class="hljs-keyword">import</span> java.sql.DriverManager;<br><span class="hljs-keyword">import</span> java.sql.SQLException;<br><span class="hljs-comment">//线程间的资源隔离</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestThreadLocal</span> &#123;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        test1();<br>    &#125;<br><br>    <span class="hljs-comment">// 多个线程调用, 得到的是自己的 Connection 对象</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test1</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>                LoggerUtils.get(<span class="hljs-string">&quot;t&quot;</span>).debug(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, Utils.getConnection());<br>            &#125;, <span class="hljs-string">&quot;t&quot;</span> + (i + <span class="hljs-number">1</span>)).start();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Utils</span> &#123;<br>        <br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;Object&gt; tl = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();<br>        <br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getConnection</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> tl.get(); <span class="hljs-comment">// 到当前线程获取资源</span><br>            <span class="hljs-keyword">if</span> (conn == <span class="hljs-literal">null</span>) &#123;<br>                conn = innerGetConnection(); <span class="hljs-comment">// 创建新的对象</span><br>                tl.set(conn); <span class="hljs-comment">// 将资源存入当前线程</span><br>            &#125;<br>            <span class="hljs-keyword">return</span> conn;<br>        &#125;<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">innerGetConnection</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br>================================<br>[DEBUG] <span class="hljs-number">16</span>:<span class="hljs-number">33</span>:<span class="hljs-number">03.210</span> [t3] - java.lang.Object@79e0bff8 <br>[DEBUG] <span class="hljs-number">16</span>:<span class="hljs-number">33</span>:<span class="hljs-number">03.210</span> [t5] - java.lang.Object@8ea112c <br>[DEBUG] <span class="hljs-number">16</span>:<span class="hljs-number">33</span>:<span class="hljs-number">03.210</span> [t4] - java.lang.Object@24ba6b0b <br>[DEBUG] <span class="hljs-number">16</span>:<span class="hljs-number">33</span>:<span class="hljs-number">03.210</span> [t2] - java.lang.Object@64ab4b0c <br>[DEBUG] <span class="hljs-number">16</span>:<span class="hljs-number">33</span>:<span class="hljs-number">03.210</span> [t1] - java.lang.Object@12e3a9c4 <br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> day02;<br><br><br><span class="hljs-keyword">import</span> java.sql.Connection;<br><span class="hljs-keyword">import</span> java.sql.DriverManager;<br><span class="hljs-keyword">import</span> java.sql.SQLException;<br><span class="hljs-comment">//线程间的资源隔离</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestThreadLocal</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        test2();<br>    &#125;<br><br>    <span class="hljs-comment">// 一个线程内调用, 得到的是同一个 Connection 对象</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test2</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">2</span>; i++) &#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>                LoggerUtils.get(<span class="hljs-string">&quot;t&quot;</span>).debug(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, Utils.getConnection());<br>                LoggerUtils.get(<span class="hljs-string">&quot;t&quot;</span>).debug(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, Utils.getConnection());<br>                LoggerUtils.get(<span class="hljs-string">&quot;t&quot;</span>).debug(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, Utils.getConnection());<br>            &#125;, <span class="hljs-string">&quot;t&quot;</span> + (i + <span class="hljs-number">1</span>)).start();<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Utils</span> &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;Object&gt; tl = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getConnection</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> tl.get(); <span class="hljs-comment">// 到当前线程获取资源</span><br>            <span class="hljs-keyword">if</span> (conn == <span class="hljs-literal">null</span>) &#123;<br>                conn = innerGetConnection(); <span class="hljs-comment">// 创建新的对象</span><br>                tl.set(conn); <span class="hljs-comment">// 将资源存入当前线程</span><br>            &#125;<br>            <span class="hljs-keyword">return</span> conn;<br>        &#125;<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">innerGetConnection</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br>====================================<br>[DEBUG] <span class="hljs-number">16</span>:<span class="hljs-number">35</span>:<span class="hljs-number">12.418</span> [t1] - java.lang.Object@12e3a9c4 <br>[DEBUG] <span class="hljs-number">16</span>:<span class="hljs-number">35</span>:<span class="hljs-number">12.418</span> [t2] - java.lang.Object@2b51a3d2 <br>[DEBUG] <span class="hljs-number">16</span>:<span class="hljs-number">35</span>:<span class="hljs-number">12.420</span> [t1] - java.lang.Object@12e3a9c4 <br>[DEBUG] <span class="hljs-number">16</span>:<span class="hljs-number">35</span>:<span class="hljs-number">12.420</span> [t2] - java.lang.Object@2b51a3d2 <br>[DEBUG] <span class="hljs-number">16</span>:<span class="hljs-number">35</span>:<span class="hljs-number">12.420</span> [t2] - java.lang.Object@2b51a3d2 <br>[DEBUG] <span class="hljs-number">16</span>:<span class="hljs-number">35</span>:<span class="hljs-number">12.420</span> [t1] - java.lang.Object@12e3a9c4<br></code></pre></td></tr></table></figure>



<h2 id="ThreadLocal的原理"><a href="#ThreadLocal的原理" class="headerlink" title="ThreadLocal的原理"></a>ThreadLocal的原理</h2><p>原理：<br>    <strong>每个线程内有一个ThreadLocalMap类型的成员变量</strong>,用来存储资源对象</p>
<p>​    调用 set方法,就是以ThreadLocal 自己作为key,资源对象作为value,放入当前线程的ThreadLocalMap集合</p>
<p>​    调用 get 方法,就是以ThreadLocal 自己作为key,到当前线程中查找关联的资源值</p>
<p>​    调用remove 方法,就是以ThreadLocal 自己作为key,移除当前线程关联的资源值</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823203736434.png" srcset="/img/loading.gif" lazyload alt="image-20220823203736434"></p>
<hr>
<h3 id="ThreadLocal的释放"><a href="#ThreadLocal的释放" class="headerlink" title="ThreadLocal的释放"></a>ThreadLocal的释放</h3><p>为什么ThreadLocalMap 中的key (即ThreadLocal)要设计为弱引用?</p>
<pre><code class="hljs">  1. Thread 可能需要长时间运行(如线程池中的线程),如果key不再使用,需要在内存不足(GC)时释放其占用的内存
  2. 但GC仅是让key的内存释放,后续还要根据key 是否为null 来进一步释放值的内存,释放时机有a) 获取key 发现 null keyb) set key 时,会使用启发式扫描,清
  3. 除临近的null key,启发次数与元素个数,是否发现nullkey有关remove 时(推荐) ,因为一般使用ThreadLocal 时都把它作为静态变量,因此GC无法回收0
</code></pre>
<ul>
<li>调用get方法时，发现null key</li>
</ul>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823203534320.png" srcset="/img/loading.gif" lazyload alt="image-20220823203534320"></p>
<hr>
<ul>
<li>set key时发现null key</li>
</ul>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823203513191.png" srcset="/img/loading.gif" lazyload alt="image-20220823203513191"></p>
<hr>
<ul>
<li>使用remove</li>
</ul>
<p>前面两种情况，有一个大前提:就是定义ThreadLocal时不能使用static修饰，否则即使时ThreadLocalMap中的键对是弱引用，但是用static修饰符修饰的变量是一直对ThreadLocal对象保持强引用，所以ThreadLocal对象不会被gc干掉；<br>这种情况下就需要人为地判断什么时候该释放entry，使用remove方法。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E8%A7%86%E9%A2%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="category-chain-item">视频学习笔记</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/java%E5%B9%B6%E5%8F%91-itcast/">#java并发-itcast</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>并发篇-itcast</div>
      <div>http://example.com/2023/03/30/itcast-并发篇/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>John Doe</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>March 30, 2023</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/03/30/%E9%BB%91%E9%A9%AC-IO%E6%A8%A1%E5%9E%8B/" title="IO模型-heima">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">IO模型-heima</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/03/30/itcast-%E5%9F%BA%E7%A1%80%E7%AF%87/" title="基础篇-itcast">
                        <span class="hidden-mobile">基础篇-itcast</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="waline"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#waline', function() {
      Fluid.utils.createCssLink('https://lib.baomitu.com/waline/2.14.1/waline.min.css')
      Fluid.utils.createScript('https://lib.baomitu.com/waline/2.14.1/waline.min.js', function() {
        var options = Object.assign(
          {"serverURL":"https://oze0hj3a.api.lncldglobal.com","path":"window.location.pathname","meta":["nick","mail","link"],"requiredMeta":["nick"],"lang":"zh-CN","emoji":["https://cdn.jsdelivr.net/gh/walinejs/emojis/weibo"],"dark":"html[data-user-color-scheme=\"dark\"]","wordLimit":0,"pageSize":10},
          {
            el: '#waline',
            path: window.location.pathname
          }
        )
        Waline.init(options);
        Fluid.utils.waitElementVisible('#waline .vcontent', () => {
          var imgSelector = '#waline .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>WAITING</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
