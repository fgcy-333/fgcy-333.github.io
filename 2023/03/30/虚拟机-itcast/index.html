<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>虚拟机-itcast | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="JVM内存结构">
<meta property="og:type" content="article">
<meta property="og:title" content="虚拟机-itcast">
<meta property="og:url" content="http://example.com/2023/03/30/%E8%99%9A%E6%8B%9F%E6%9C%BA-itcast/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="JVM内存结构">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823215451825.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823215942253.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823220056427.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823220147367.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823220319923.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823220442153.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823220526715.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823220603957.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-26_13-06-20.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-26_13-15-10.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823220858278.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-26_15-34-36.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823221046921.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-26_15-44-23.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823221225381.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-26_16-57-15.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823221538595.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823221800589.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823221909009.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-27_11-49-55.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-27_14-15-58.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-27_14-09-48.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823222155785.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-27_14-14-15.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-27_14-17-00.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-27_14-17-26.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-27_14-18-43.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-27_15-00-10.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-27_15-00-46.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-27_20-10-09.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-27_21-02-08.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-27_21-02-37.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-27_21-03-02.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823223533970.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-29_17-57-46.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-29_19-37-23.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-29_20-01-43.png">
<meta property="article:published_time" content="2023-03-30T09:56:03.000Z">
<meta property="article:modified_time" content="2023-03-30T14:03:34.178Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="java虚拟机-itcast">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823215451825.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-虚拟机-itcast" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/03/30/%E8%99%9A%E6%8B%9F%E6%9C%BA-itcast/" class="article-date">
  <time class="dt-published" datetime="2023-03-30T09:56:03.000Z" itemprop="datePublished">2023-03-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E8%A7%86%E9%A2%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">视频学习笔记</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      虚拟机-itcast
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="JVM内存结构"><a href="#JVM内存结构" class="headerlink" title="JVM内存结构"></a>JVM内存结构</h2><span id="more"></span> 

<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823215451825.png" alt="image-20220823215451825"></p>
<ol>
<li>创建main线程（有JVM栈为其分配内存）</li>
<li>看方法区中是否有main方法所属类的信息，没有就会触发类加载行为【将字节码文件的所有原始信息(类名，继承关系，成员变量，方法)都行加载进方法区】</li>
<li>将方法区中的main方法提取到栈中运行</li>
<li>遇到类查看方法区中是否有该类，如果没有就触发类加载</li>
<li>方法中的局部变量占有的是当前线程的栈内存，对象占用的是堆内存<br>虚拟机栈:在JVM规范中，方法分为本地方法和java方法，如hashcode是本地方法，study是java方法；但是，oracle的hotspot虚拟机没有实现此规范，只有一个JVM 			Stack；要使用本地方法就要通过本地方法接口调用本地库<br>程序计数器:程序计数器用于记录当前线程执行到第几行代码，即使线程被切换了，回来的时候也能记住是从第几行代码开始恢复执行<br>垃圾回收：当没有任何一个变量引用对象地址时，当内存不足时，就会触发垃圾回收gc，此时就会将没有被引用的对象所占的空间释放开<br>解释器：cup只认识机器码，并不认识字节码，需要通过解释器对字节码进行翻译；<br>即时编译器：即时编译器JIT负责发现热点代码，并将热点代码翻译成机器码，缓存起来的；等待下次有人调用这段代码时，直接从缓存中拿出机器码交给cpu执行，少了解释那一步，效率疯涨<br>属于线程私有的内存结构有:程序计数器、虚拟机栈<br>属于线程共享的内存结构有:堆和方法区</li>
</ol>
<h2 id="哪些部分会出现内存溢出"><a href="#哪些部分会出现内存溢出" class="headerlink" title="哪些部分会出现内存溢出"></a>哪些部分会出现内存溢出</h2><p>不会出现内存溢出的区域-程序计数器<br>出现OutOfMemoryError的情况</p>
<ol>
<li>堆内存耗尽-对象越来越多,又一直在使用,不能被垃圾回收</li>
<li>方法区内存耗尽-加载的类越来越多,很多框架都会在运行期间动态产生新的类（可以给方法区的内存设置上限，超过这个上限就会出OutOfMemoryError）；但是默认不会设置上限，即物理内存有多大，方法区就有多大</li>
<li>虚拟机栈累积-每个线程最多会占用1M内存,线程个数越来越多,而又长时间运行不销毁时【线程过多】出现StackOverflowError的情况虚拟机栈内部-方法调用次数过多(编程能力不足造成的，比如递归没有设置好出口)；溢出是因为每个线程最多占用1M内存，每次调用方法都需要从1M中拿部分内存，当线程内的1M内存用完了就会出现StackOverflowError【方法过多】</li>
</ol>
<h2 id="方法区与永久代、元空间之间的关系"><a href="#方法区与永久代、元空间之间的关系" class="headerlink" title="方法区与永久代、元空间之间的关系"></a>方法区与永久代、元空间之间的关系</h2><p>方法区是【JVM规范】中定义的一块内存区域,用来存储类元数据、方法字节码、即时编译器需要的信息等<br>永久代是Hotspot虚拟机对JVM规范的实现(1.8之前)<br>元空间是Hotspot虚拟机对JVM规范的实现(1.8以后),使用本地内存作为这些信息的存储空间【物理内存有多大，方法区就有多大】</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823215942253.png" alt="image-20220823215942253"></p>
<hr>
<p>当对象c不再被人引用时，Y这个类也没人在使用；此时队中的c对象，Y.class对象可以被垃圾回收；但此时Y类在元空间中的信息不可以被卸载；只有当整个类加载器不再被使用时，被它加载的类的元空间信息才会被卸载；<br>当内存不足，触发gc，将所有没人引用的对象清除掉；此时类加载器发现自己所有的类都被回收了，那它也会被回收；类加载器没了之后才会去将元空间中相关类的原始信息卸载掉<br>一般来说，系统的类加载器是没有机会被回收的，只有自定义的类加载器才有可能被回收</p>
<h2 id="对于JVM内存配置参数"><a href="#对于JVM内存配置参数" class="headerlink" title="对于JVM内存配置参数"></a>对于JVM内存配置参数</h2><h3 id="堆内存设置"><a href="#堆内存设置" class="headerlink" title="堆内存设置"></a>堆内存设置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-Xmx10240m -Xms10240m -Xmn5120m -XX:SurvivorRatio=3其最小内存值和Survivor区总大小分别是</span><br><span class="line"></span><br><span class="line">-Xmx10240m：JVM最大内存是10G</span><br><span class="line">-Xms10240m：JVM最小内存是10G</span><br><span class="line">-Xmn5120m：JVM新生代内存是5G</span><br><span class="line">SurvivorRatio=3：eden区比from区是3：1</span><br><span class="line">survivor区包含from区和to区(1:1)</span><br></pre></td></tr></table></figure>

<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823220056427.png" alt="image-20220823220056427"></p>
<hr>
<p>最小内存是5G survivor内存大小为2G</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823220147367.png" alt="image-20220823220147367"></p>
<hr>
<h3 id="元空间内存分类"><a href="#元空间内存分类" class="headerlink" title="元空间内存分类"></a>元空间内存分类</h3><hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823220319923.png" alt="image-20220823220319923"></p>
<hr>
<p>class space：放置类的基本信息 类名，方法入口【包含两个表，itable和vtable】<br>non-class space：放置方法的字节码，类上的注解<br>-XX:CompressedClassSpaceSize:用来设置class-space区的上限大小，默认初始是一个G<br>–XX:MaxMetaspaceSize:最大元空间大小上限【默认是不设置的，即没有大小限制，物理硬盘有多大，原空间大小就有多大】</p>
<h3 id="代码缓存"><a href="#代码缓存" class="headerlink" title="代码缓存"></a>代码缓存</h3><hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823220442153.png" alt="image-20220823220442153"></p>
<hr>
<p>JIT即时编译器:将热点代码编译成机器码缓存起来，缓存的地方就是CodeCache<br>当<code>-XX:ReservedCodeCacheSize&lt;240m</code>时，会将所有的机器码放在一块<br><code>当-XX:ReservedCodeCacheSize&gt;=240m</code>时,会分为三个区域；<br>    1. non-nmthods:jit自己使用的一些代码<br>    2. prodflednmthods:部分优化后的代码<br>    3. non-profilednmthods:经过完整优化后的代码</p>
<h3 id="线程内存"><a href="#线程内存" class="headerlink" title="线程内存"></a>线程内存</h3><hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823220526715.png" alt="image-20220823220526715"></p>
<hr>
<p>控制每个线程占用的内存，64位的linux操作系统每个线程占用一兆内存</p>
<h2 id="JVM垃圾回收算法"><a href="#JVM垃圾回收算法" class="headerlink" title="JVM垃圾回收算法"></a>JVM垃圾回收算法</h2><ol>
<li>标记清除</li>
</ol>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823220603957.png" alt="image-20220823220603957"></p>
<hr>
<ol>
<li>找到GC Root对象(一定不能被回收的对象)【局部变量正在使用的对象，静态变量引用的对象】</li>
<li>找根对象以及被根对象直接或间接引用的对象，给它加上标记</li>
<li>有标记的对象给它保留下来，没有标记的对象直接给他清除</li>
</ol>
<p>问题：<br>释放后的内存大概率时不连续的，造成内存碎片问题<br>当想要创建一片连续的空间时，发现内存还是不足<br>所以现在大部分的垃圾回收器都不使用标记清除算法</p>
<ol start="2">
<li>标记整理</li>
</ol>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-26_13-06-20.png"></p>
<hr>
<ol>
<li><p>找到根对象以及根对象直接或间接引用的对象</p>
</li>
<li><p>对这些对象进行标记</p>
</li>
<li><p>将没有标记的对象释放掉</p>
</li>
<li><p>将存活的对象向一边无缝隙靠拢(解决内存碎片问题)<br>因为多了整理的步骤【发生内存复制，计算引用地址】所以效率变低</p>
</li>
<li><p>标记复制</p>
</li>
</ol>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-26_13-15-10.png"></p>
<hr>
<p>FROM空间专门用来存储对象，TO空间一开始什么东西都不存</p>
<ol>
<li>找到GC Root对象以及被他们直接或间接引用的对象</li>
<li>对这些对象进行标记</li>
<li>将有标记的对象复制一份到TO(空闲区)【也不存在内存碎片问题】</li>
<li>将FROM区中的对象全部释放掉<br>问题<br>  空间换时间，内存占用多</li>
</ol>
<ul>
<li>小结</li>
</ul>
<p>标记清除法，现在已经没有使用的<br>复制标记法比较适合新生代的垃圾回收【存活的对象少，清除的对象多】<br>复制标记法不适合老年代的垃圾回收【存活的对象多 ，清除的对象少】，所以老年代更适合标记整理法</p>
<h2 id="说说GC和分代回收算法"><a href="#说说GC和分代回收算法" class="headerlink" title="说说GC和分代回收算法"></a>说说GC和分代回收算法</h2><p>GC的目的在于</p>
<ol>
<li>实现无用对象内存自动释放,</li>
<li>减少内存碎片</li>
<li>加快分配速度</li>
</ol>
<p>GC要点:</p>
<pre><code>   1. 回收区域是堆内存,不包括虚拟机栈,在方法调用结束会自动释放方法占用内存
   2. 判断无用对象,使用可达性分析算法【找到GC Root以及被它直接或间接引用的对象】,三色标记法标记存活对象,回收未标记对象
   3. GC具体的实现称为垃圾回收器【并行垃圾回收器，CMS垃圾回收器，GOne垃圾回收器】
   4. GC大都采用了分代回收思想,理论依据是大部分对象朝生夕灭,用完立刻就可以回收,另有少部分对象会长时间存活,每次很难回收,根据这两类对象的特性将回收区域分为新生代【朝生夕灭的对象，频繁运行GC】和老年代【长时间存活的对象，长间隔运行GC】,不同区域应用不同的回收策略
   5. 根据GC的规模可以分成 Minor GC【对新生代进行垃圾回收，小范围垃圾回收，暂停时间短，对系统影响较小】, Mixed GC【新生代发生垃圾回收，部分老年代也发生垃圾回收】, Full GC【对新生代和老年代都进行一次垃圾回收，暂停时间长，能明显感受到系统卡顿】
</code></pre>
<h2 id="分代回收与GC规模"><a href="#分代回收与GC规模" class="headerlink" title="分代回收与GC规模"></a>分代回收与GC规模</h2><h3 id="分代回收"><a href="#分代回收" class="headerlink" title="分代回收"></a>分代回收</h3><p>伊甸园 eden,最初对象都分配到这里,与幸存区合称新生代<br>幸存区survivor,当伊甸园内存不足,回收后的幸存对象到这里,分成from 和to,采用标记复制算法<br>老年代old,当幸存区对象熬过(不确定)几次回收(最多15次,即熬过15次必晋升),晋升到老年代(幸存区内存不足或大对象会导致提前晋升)</p>
<ul>
<li>1</li>
</ul>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823220858278.png" alt="image-20220823220858278"></p>
<hr>
<ul>
<li>2</li>
</ul>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-26_15-34-36.png"></p>
<hr>
<ul>
<li>3</li>
</ul>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823221046921.png" alt="image-20220823221046921"></p>
<hr>
<ul>
<li>4</li>
</ul>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-26_15-44-23.png"></p>
<hr>
<h3 id="GC规模"><a href="#GC规模" class="headerlink" title="GC规模"></a>GC规模</h3><ol>
<li>Minor GC发生在新生代的垃圾回收,暂停时间短【上面演示的都是发生在新生代的Minor GC】</li>
<li>Mixed GC新生代(新生代全部回收一遍)+老年代部分区域(老年区划分为多个区域，挑其中回收价值较高的区域)的垃圾回收, G1收集器特有</li>
<li>Full GC新生代+老年代完整垃圾回收,暂停时间长,应尽力避免</li>
</ol>
<h2 id="三色标记与并发漏标问题"><a href="#三色标记与并发漏标问题" class="headerlink" title="三色标记与并发漏标问题"></a>三色标记与并发漏标问题</h2><h3 id="用三种颜色记录对象的标记状态"><a href="#用三种颜色记录对象的标记状态" class="headerlink" title="用三种颜色记录对象的标记状态"></a>用三种颜色记录对象的标记状态</h3><p>黑色-已标记<br>    沿着根对象找到的引用对象，并且该对象内部的其他引用也已经完成了标记<br>灰色-标记中<br>    沿着根对象找到的引用对象，但是该对象内部的其他引用还未被处理完【正在处理中】<br>白色-还未标记<br>    沿着根对象找到的引用对象，该对象没有被处理且该对象内部的其他引用也没被处理</p>
<ul>
<li>总结</li>
</ul>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823221225381.png" alt="image-20220823221225381"></p>
<hr>
<p>正在处理的对象标记为灰色，被它引用的对象标记为白色<br>处理完成的对象标记为黑色，被它引用的对象标记为灰色<br>没有被处理的对象标记为白色，被它引用的对象标记为白色<br>沿着引用链进行迭代，最后将黑色标记的对象保留，将白色标记的对象清除</p>
<h3 id="并发漏标问题"><a href="#并发漏标问题" class="headerlink" title="并发漏标问题"></a>并发漏标问题</h3><p>标记对象状态是使用垃圾回收线程执行的（垃圾回收线程）<br>用户编写的业务代码是在用户线程中运行的（用户线程）<br>在早期的垃圾回收器中，垃圾回收线程和用户线程是不能同时运行的，垃圾回收线程一但执行，用户线程就得马上停止<br>现在的垃圾回收器支持并发，但不是所有情况下都能并发<br>一种典型的并发场景：老年代的垃圾回收器在进行标记的时候是可以并发的；</p>
<ul>
<li>漏标问题-记录标记过程中变化</li>
</ul>
<ol>
<li>Incremental Update(增量更新)<br>只要赋值发生,【被赋值的对象】就会被记录<br>垃圾回收线程会记录所有的赋值动作，将被赋值的对象的标记改为灰色；<br>当并发标记完成后，会让用户线程停止，对并发标记过程中，记录下来的 标记改变的对象进行处理(重新标记)</li>
<li>Snapshot At The Beginning(原始快照), SATB<br>新加对象会被记录<br>被删除引用关系的对象也被记录<br>当并发标记完成后，会让用户线程停止，对并发标记过程中，记录下来的 标记改变的对象进行处理(重新标记)</li>
</ol>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-26_16-57-15.png"></p>
<hr>
<h2 id="垃圾回收器"><a href="#垃圾回收器" class="headerlink" title="垃圾回收器"></a>垃圾回收器</h2><h3 id="1-Parallel-GC（并行的垃圾回收）"><a href="#1-Parallel-GC（并行的垃圾回收）" class="headerlink" title="1. Parallel GC（并行的垃圾回收）"></a>1. Parallel GC（并行的垃圾回收）</h3><p>有两个垃圾回收器组成:工作代&amp;新生代、工作代老年代<br>特点：</p>
<ol>
<li>eden 内存不足发生Minor GC(新生代),回收算法：标记复制STW(Stop ths work)应用程序暂停，暂停时间短</li>
<li>old 内存不足发生Full GC【新生代和老年代都要进行GC】,新生代使用的回收算法:标记复制法，暂停时间短；老年代使用的算法：标记整理STW，暂停时间长</li>
<li>注重吞吐量</li>
<li>虽然会暂停，但它会启动多个线程执行垃圾回收</li>
</ol>
<h3 id="2-ConcurrentMarkSweep-GC"><a href="#2-ConcurrentMarkSweep-GC" class="headerlink" title="2. ConcurrentMarkSweep GC"></a>2. ConcurrentMarkSweep GC</h3><ol>
<li>old并发标记【有漏标问题】,重新标记时需要STW,并发清除，标记和清除的时候用户线程和GC都可以同时运行，但是重新标记的时候必须停止用户线程【使用标记清除算法，有内存碎片问题】</li>
<li>Failback【并发失败的保底策略，并发速度小于对象创造速度就会失败，失败就会触发—–》 Full GC【stw停止用户线程，让新生代和老年代都进行一次彻底GC】</li>
<li>注重响应时间</li>
<li>在最新的jdk中把它标记为废弃</li>
</ol>
<h3 id="3-G1-GC"><a href="#3-G1-GC" class="headerlink" title="3. G1 GC"></a>3. G1 GC</h3><ol>
<li>响应时间与吞吐量兼顾，综合能力强</li>
<li>将整个堆内存划分成多个大小相等的区域,每个区域都可以充当eden,survivor, old, humongous【存放大对象】</li>
<li>新生代回收:eden 内存不足,标记复制STW</li>
<li>并发标记:old并发标记,重新标记时需要STW</li>
<li>混合收集(既有新生代的内存释放，又有老年代的内存释放):并发标记完成,开始混合收集,参与复制的有eden、survivor, old,其中 old会根据暂停时间目标,选择部分回收价值高的区域,复制时STW</li>
<li>Failback Full GC</li>
</ol>
<p>【jdk9默认的垃圾回收器】</p>
<ul>
<li>新生代垃圾回收1</li>
</ul>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823221538595.png" alt="image-20220823221538595"></p>
<hr>
<ol>
<li>将整个堆内存划分为多个大小相等的区域，这些区域叫region，每个区域都可以充当eden,survivor, old, humongous</li>
<li>当我们创建对象时就会挑选一些空的区域作为eden区</li>
<li>随着对象越来越多，之前创建的eden区内存用完了【eden的大小会受到整个新生代的限制的，G1会自动调整新生代内存大小，有限制，在一定范围内波动】，触发GC</li>
<li>垃圾回收算法采用标记复制算法，标记和复制的过程都会stw复制到survivor</li>
<li>复制完成后可以将Eden区释放掉，是释放Eden区，不是仅仅释放对象</li>
</ol>
<ul>
<li>新生代垃圾回收2</li>
</ul>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823221800589.png" alt="image-20220823221800589"></p>
<hr>
<ol>
<li>当创建的对象越来越多，eden区的空间已经全部用完时，触发GC</li>
<li>将Eden区和上一个survivor区的幸存者对象复制到新的survivor区中；当发现上一个survivor区中有对象满足晋升条件时，会晋升到老年代</li>
<li>释放掉eden区和上一次的survivor区</li>
</ol>
<ul>
<li>并发标记1</li>
</ul>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823221909009.png" alt="image-20220823221909009"></p>
<hr>
<p>老年代的占比达到整个堆内存的45%以上<br>在老年代中寻找存活对象，对其做出标记，与用户线程并发执行【采用原始快照法，解决漏标问题】<br>在老年代中挑选存活对象少，回收价值高的区域进行回收,还有eden区，上一批survivor区，做一次垃圾回收；<br>eden区，survivor区中，存活下来的对象，复制到新的survivor区<br>上一批达到晋升条件的survivor区中的对象，和old区中存活的对象，复制到新的old区<br>释放掉eden区，survivor区，old区的内存<br>多次执行混合收集，逐步将old区的内存释放掉，然后循环执行新生代回收，并发标记，混合回收<br>当对象清除速度小于对象创造速度，就会触发保底策略，Full GC</p>
<h2 id="项目什么情况下会内存溢出，怎么解决"><a href="#项目什么情况下会内存溢出，怎么解决" class="headerlink" title="项目什么情况下会内存溢出，怎么解决"></a>项目什么情况下会内存溢出，怎么解决</h2><h3 id="误用线程池导致的内存溢出1"><a href="#误用线程池导致的内存溢出1" class="headerlink" title="误用线程池导致的内存溢出1"></a>误用线程池导致的内存溢出1</h3><ul>
<li>Executors.newFixedThreadPool</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> day03;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> day02.LoggerUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -Xmx64m</span></span><br><span class="line"><span class="comment">// 模拟短信发送超时，但这时仍有大量的任务进入队列导致内存溢出</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestOomThreadPool</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line">        LoggerUtils.get().debug(<span class="string">&quot;begin...&quot;</span>);</span><br><span class="line">        <span class="comment">//不停创建任务提交到线程池中</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="comment">//前两个任务由线程池的两个核心线程为其服务，后面提交的任务添加到阻塞队列中</span></span><br><span class="line">            executor.submit(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    LoggerUtils.get().debug(<span class="string">&quot;send sms...&quot;</span>);</span><br><span class="line">                    <span class="comment">//是对Thread.sleep方法的包装，实现是一样的，只是多了时间单位转换和验证，然而TimeUnit枚举成员的方法却提供更好的可读性</span></span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">30</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">------------------------Executors---------------------------------------------</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newFixedThreadPool</span><span class="params">(<span class="type">int</span> nThreads)</span> &#123;</span><br><span class="line">    <span class="comment">//核心线程数=最大线程数，即 救急线程数0</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(nThreads, nThreads,</span><br><span class="line">                                      <span class="comment">//救急线程不工作多长时间就会被回收</span></span><br><span class="line">                                      <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                      <span class="comment">//存放任务的阻塞队列，不填参数就是整数有多大，它的容量有多大</span></span><br><span class="line">                                      <span class="comment">//Integer.MAX_VALUE 0x7fffffff</span></span><br><span class="line">                                      <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">=======================</span><br><span class="line">[DEBUG] <span class="number">10</span>:<span class="number">03</span>:<span class="number">36.331</span> [main] - begin... </span><br><span class="line">[DEBUG] <span class="number">10</span>:<span class="number">03</span>:<span class="number">36.333</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] - send sms... </span><br><span class="line">[DEBUG] <span class="number">10</span>:<span class="number">03</span>:<span class="number">36.333</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] - send sms... </span><br><span class="line"></span><br><span class="line">Exception: java.lang.OutOfMemoryError thrown from the UncaughtExceptionHandler in thread <span class="string">&quot;main&quot;</span></span><br><span class="line"></span><br><span class="line">进程已结束，退出代码为 <span class="number">1</span></span><br></pre></td></tr></table></figure>





<ul>
<li>Executors.newCachedThreadPool</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> day03;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> day02.LoggerUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 模拟发送大量短信，此时创建大量线程运行任务，导致系统线程数用完</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestOomThreadPool</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line">        LoggerUtils.get().debug(<span class="string">&quot;begin...&quot;</span>);</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            executor.submit(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    LoggerUtils.get().debug(<span class="string">&quot;send sms...&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">---------------------------Executors.newCachedThreadPool--------------------------------------</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newCachedThreadPool</span><span class="params">()</span> &#123;</span><br><span class="line">    	<span class="comment">//核心线程数量为0，救急线程数量为整数最大值</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">0</span>, Integer.MAX_VALUE,</span><br><span class="line">                                      <span class="comment">//救急线程不工作60秒就会被回收</span></span><br><span class="line">                                      <span class="number">60L</span>, TimeUnit.SECONDS,</span><br><span class="line">                                      <span class="comment">//创建一个只能容纳一个任务的队列</span></span><br><span class="line">                                      <span class="keyword">new</span> <span class="title class_">SynchronousQueue</span>&lt;Runnable&gt;());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">===================================================</span><br><span class="line">别跑这段代码，会死机</span><br></pre></td></tr></table></figure>





<h3 id="查询数据量太大导致的内存溢出"><a href="#查询数据量太大导致的内存溢出" class="headerlink" title="查询数据量太大导致的内存溢出"></a>查询数据量太大导致的内存溢出</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> day03;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.openjdk.jol.info.ClassLayout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 演示对象的内存估算</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestOomTooManyObject</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 【jol-core】对象本身内存仅包含对象头以及基本数据类型的成员变量的大小</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">a</span> <span class="operator">=</span> ClassLayout.parseInstance(<span class="keyword">new</span> <span class="title class_">Product</span>()).instanceSize();</span><br><span class="line">        System.out.println(<span class="string">&quot;对象本身内存仅包含对象头以及基本数据类型的成员变量的大小:(Product)&quot;</span> + a);</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;联想小新Air14轻薄本 英特尔酷睿i5 14英寸全面屏学生笔记本电脑(i5-1135G7 16G 512G MX450独显 高色域)银&quot;</span>;</span><br><span class="line">        <span class="comment">// 一个字符串占用内存【就只是字符串对象的对象头大小，不包含内容】</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">b</span> <span class="operator">=</span> ClassLayout.parseInstance(name).instanceSize();</span><br><span class="line">        System.out.println(<span class="string">&quot;对象本身内存仅包含对象头以及基本数据类型的成员变量的大小(String):&quot;</span> + b);</span><br><span class="line">        <span class="type">String</span> <span class="variable">desc</span> <span class="operator">=</span> <span class="string">&quot;【全金属全面屏】学生商务办公，全新11代处理器，MX450独显，100%sRGB高色域，指纹识别，快充（更多好货）&quot;</span>;</span><br><span class="line">        <span class="comment">// 一个字符串占用内存【就只是字符串对象的对象头大小，不包含内容】</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">c</span> <span class="operator">=</span> ClassLayout.parseInstance(desc).instanceSize();</span><br><span class="line">        System.out.println(<span class="string">&quot;对象本身内存仅包含对象头以及基本数据类型的成员变量的大小(String):&quot;</span> + c);</span><br><span class="line">        <span class="comment">//字节数组头以及基本数据类型的成员变量的大小16字节，加上存放数据的字节数组大小</span></span><br><span class="line">        System.out.println(<span class="string">&quot;String对象头大小+数组对象头和属性大小+字节数组大小：(name)&quot;</span> + (<span class="number">16</span> + name.getBytes(StandardCharsets.UTF_8).length));</span><br><span class="line">        System.out.println(<span class="string">&quot;String对象头大小+数组对象头和属性大小+字节数组大小：(desc)&quot;</span> + (<span class="number">16</span> + desc.getBytes(StandardCharsets.UTF_8).length));</span><br><span class="line">        <span class="comment">// 一个对象估算的内存</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">avg</span> <span class="operator">=</span> a + b + c + <span class="number">16</span> + name.getBytes(StandardCharsets.UTF_8).length + <span class="number">16</span> + desc.getBytes(StandardCharsets.UTF_8).length;</span><br><span class="line">        System.out.println(<span class="string">&quot;一个商品的大小：&quot;</span> + avg);</span><br><span class="line">        <span class="comment">// ArrayList 24【对象头以及基本数据类型的成员变量的大小24字节】, Object[] 16 【数组头以及基本数据类型的成员变量的大小16字节】共 40</span></span><br><span class="line">        <span class="comment">//一百万个商品对象+集合本身大小</span></span><br><span class="line">        System.out.println(<span class="string">&quot;一百万个商品对象+集合本身大小:&quot;</span> + (<span class="number">1_000_000</span> * avg + <span class="number">40</span>) / <span class="number">1024</span> / <span class="number">1024</span> + <span class="string">&quot;Mb&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Product</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> price;</span><br><span class="line">        <span class="keyword">private</span> String desc;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> id;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.id = id;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.name = name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getPrice</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> price;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPrice</span><span class="params">(<span class="type">int</span> price)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.price = price;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getDesc</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> desc;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDesc</span><span class="params">(String desc)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.desc = desc;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">=========================================</span><br><span class="line"># WARNING: Unable to get Instrumentation. Dynamic Attach failed. You may add <span class="built_in">this</span> JAR as -javaagent manually, or supply -Djdk.attach.allowAttachSelf</span><br><span class="line"># WARNING: Unable to attach Serviceability Agent. sun.jvm.hotspot.memory.Universe.getNarrowOopBase()</span><br><span class="line">对象本身内存仅包含对象头以及基本数据类型的成员变量的大小:(Product)<span class="number">32</span></span><br><span class="line">对象本身内存仅包含对象头以及基本数据类型的成员变量的大小(String):<span class="number">24</span></span><br><span class="line">对象本身内存仅包含对象头以及基本数据类型的成员变量的大小(String):<span class="number">24</span></span><br><span class="line">String对象头大小+数组对象头和属性大小+字节数组大小：(name)<span class="number">144</span></span><br><span class="line">String对象头大小+数组对象头和属性大小+字节数组大小：(desc)<span class="number">157</span></span><br><span class="line">一个商品的大小：<span class="number">381</span></span><br><span class="line">一百万个商品对象+集合本身大小:363Mb</span><br><span class="line"></span><br><span class="line">进程已结束，退出代码为 <span class="number">0</span><span class="comment">//不要findAll</span></span><br></pre></td></tr></table></figure>







<h3 id="动态生成类导致的内存溢出"><a href="#动态生成类导致的内存溢出" class="headerlink" title="动态生成类导致的内存溢出"></a>动态生成类导致的内存溢出</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">package</span> day03;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> groovy.lang.GroovyShell;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -XX:MaxMetaspaceSize=24m</span></span><br><span class="line"><span class="comment">// 模拟不断生成类, 但类无法卸载的情况</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestOomTooManyClass</span> &#123;</span><br><span class="line">    <span class="comment">//这个类的内部有一个自定义的类加载器，用于加载执行脚本的时候会动态生成类</span></span><br><span class="line">    <span class="comment">//只要类加载器存在，或类存在，或实例存在，那么在元空间中这个类将一直存在</span></span><br><span class="line">    <span class="comment">//又因为该引用该对象的变量用static修饰，所以这个对象将一直存在，它的成员变量类加载器也会一直存在，元空间中的类信息不会卸载，造成oom</span></span><br><span class="line">    <span class="keyword">static</span> <span class="type">GroovyShell</span> <span class="variable">shell</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GroovyShell</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">AtomicInteger</span> <span class="variable">c</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> (<span class="type">FileReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileReader</span>(<span class="string">&quot;script&quot;</span>)) &#123;</span><br><span class="line">                <span class="comment">//执行脚本的时候会动态生成类（每次都会生成一个）</span></span><br><span class="line">                shell.evaluate(reader);</span><br><span class="line">                System.out.println(c.incrementAndGet());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">=============================================</span><br><span class="line">跑了<span class="number">2595</span>就耗尽元空间</span><br><span class="line">Exception in thread <span class="string">&quot;main&quot;</span> java.lang.OutOfMemoryError: Metaspace</span><br><span class="line">进程已结束，退出代码为 <span class="number">1</span></span><br></pre></td></tr></table></figure>





<ul>
<li>解决</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> day03;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> groovy.lang.GroovyShell;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -XX:MaxMetaspaceSize=24m</span></span><br><span class="line"><span class="comment">// 模拟不断生成类, 但类无法卸载的情况</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestOomTooManyClass</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">AtomicInteger</span> <span class="variable">c</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> (<span class="type">FileReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileReader</span>(<span class="string">&quot;script&quot;</span>)) &#123;</span><br><span class="line">                <span class="comment">//将类定义成局部变量，这个对象不会一直存在，当方法跑完了，这个对象就不会被使用</span></span><br><span class="line">                <span class="comment">//当堆内存不足触发GC时，会将这些没人使用的对象清除掉，此时，哪些动态生成的类，实例，加载这些类的类加载器全部被清除，会清除元空间这些类信息</span></span><br><span class="line">                <span class="type">GroovyShell</span> <span class="variable">shell</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GroovyShell</span>();</span><br><span class="line">                <span class="comment">//执行脚本的时候会动态生成类（每次都会生成一个）</span></span><br><span class="line">                shell.evaluate(reader);</span><br><span class="line">                System.out.println(c.incrementAndGet());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">======================================</span><br><span class="line">跑到<span class="number">35546</span>，一点事都没有</span><br></pre></td></tr></table></figure>



<ul>
<li>打开jconsole观察</li>
</ul>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-27_11-49-55.png"></p>
<hr>
<h2 id="类加载过程"><a href="#类加载过程" class="headerlink" title="类加载过程"></a>类加载过程</h2><ul>
<li><p>类加载过程分为三个阶段</p>
<ol>
<li><p>加载</p>
</li>
<li><p>将类的字节码载入方法区,并创建 类.class对象(类对象)【加载到方法区中的字节码java代码是无法直接访问的，因为字节码里面的数据结构是采C++实现的】类对象存储在堆中</p>
</li>
<li><p>如果此类的父类|接口没有加载,先加载父类|接口</p>
</li>
<li><p>加载是懒惰执行 【当需要用到该类时，才会触发类加载】</p>
</li>
<li><p>连接</p>
</li>
<li><p>验证 验证类是否符合Class规范,合法性、安全性检查</p>
</li>
<li><p>准备 为static变量分配空间,设置默认值【赋值语句是在最后的初始化才执行的】</p>
</li>
<li><p>解析 将常量池的符号引用解析为直接引用 </p>
</li>
<li><p>初始化</p>
</li>
<li><p>执行静态代码块与非final静态变量的赋值【有final修饰的变量在准备阶段就会赋好值，在初始化时不会重复赋值】【没有final修饰的静态变量，其初始化在静态代码块中执行】</p>
</li>
<li><p>初始化是懒惰执行 【new 类】</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestLazy</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt; studentClass;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;未用到 Student&quot;</span>);</span><br><span class="line">        <span class="comment">//需要输入一行数据，否则阻塞</span></span><br><span class="line">        System.in.read();</span><br><span class="line"></span><br><span class="line">        System.out.println(Student.class);   <span class="comment">// 关键代码1，会触发类加载</span></span><br><span class="line">        System.out.println(<span class="string">&quot;已加载 Student&quot;</span>);</span><br><span class="line">        <span class="type">TestLazy</span> <span class="variable">testLazy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TestLazy</span>();</span><br><span class="line">        testLazy.studentClass = Student.class;</span><br><span class="line">        System.in.read();</span><br><span class="line"></span><br><span class="line">        <span class="type">Student</span> <span class="variable">stu</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>();        <span class="comment">// 关键代码2，会触发类初始化</span></span><br><span class="line">        System.out.println(<span class="string">&quot;已初始化 Student&quot;</span>);</span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">=============================================================</span><br><span class="line">未用到 Student</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">day03</span>.loader.Student</span><br><span class="line">已加载 Student</span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">使用jdk17的一个调试工具:jhsdb.exe【观察内存状态】</span><br><span class="line">C:\Users\fgcy&gt;cd /d D:\sofeware\Idea\jdk-17.0.2\bin</span><br><span class="line">D:\sofeware\Idea\jdk-17.0.2\bin&gt;jhsdb.exe</span><br><span class="line">    clhsdb              command line debugger</span><br><span class="line">    hsdb                ui debugger</span><br><span class="line">    debugd --help       to get more information</span><br><span class="line">    jstack --help       to get more information</span><br><span class="line">    jmap   --help       to get more information</span><br><span class="line">    jinfo  --help       to get more information</span><br><span class="line">    jsnap  --help       to get more information</span><br><span class="line"></span><br><span class="line">D:\sofeware\Idea\jdk-17.0.2\bin&gt;jhsdb.exe hsdb</span><br><span class="line"></span><br><span class="line">-----------------------------------------------------</span><br><span class="line">D:\sofeware\Idea\jdk-17.0.2\bin&gt;jps</span><br><span class="line">14000</span><br><span class="line">2080 Launcher</span><br><span class="line">21556 Jps</span><br><span class="line">18296 RemoteMavenServer36</span><br><span class="line">78412 TestLazy</span><br></pre></td></tr></table></figure>

<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-27_14-15-58.png"></p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-27_14-09-48.png"></p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823222155785.png" alt="image-20220823222155785"></p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-27_14-14-15.png"></p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-27_14-17-00.png"></p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-27_14-17-26.png"></p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-27_14-18-43.png"></p>
<hr>
<ul>
<li>证明类的初始化才能给静态变量赋初始值</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查看堆的范围</span></span><br><span class="line">hsdb&gt; universe</span><br><span class="line">Heap Parameters:</span><br><span class="line">garbage-first heap [Ox00000000ff000000, Ox0000000100000000] region size 1024K</span><br><span class="line"></span><br><span class="line"><span class="comment">//查看G1划分的许多Region的范围</span></span><br><span class="line">hsdb&gt; glregiondetails</span><br><span class="line">Region Details:</span><br><span class="line">Region: Ox00000000ff000000, Ox00000000ff100000, Ox00000000ff100000:<span class="number">01d</span></span><br><span class="line">Region: Ox00000000ff100000, Ox00000000ff200000,Ox00000000ff200000:0ld</span><br><span class="line">Region: Ox00000000ff200000, <span class="number">0x00000000ff300000</span>, Ox00000000ff300000:<span class="number">01d</span></span><br><span class="line">Region: Ox00000000ff300000, Ox00000000ff371e00, Ox00000000ff400000:<span class="number">01d</span></span><br><span class="line">Region: Ox00000000ff400000, <span class="number">0x00000000ff400000</span>,Ox00000000ff500000:Free</span><br><span class="line">Region: Ox00000000ff500000, Ox00000000ff500000,Ox00000000ff600000: Free</span><br><span class="line">Region: Ox00000000ff600000, <span class="number">0x00000000ff600000</span>,<span class="number">0x00000000ff700000</span>:Free</span><br><span class="line">Region: Ox00000000ff700000, Ox00000000ff700000,Ox00000000ff800000: Free</span><br><span class="line">Region: Ox00000000ff800000, Ox00000000ff800000,Ox00000000ff900000: Free</span><br><span class="line">Region: Ox00000000ff900000, Ox00000000ffa00000, Ox00000000ffa00000:Survivor</span><br><span class="line">Region: Ox00000000ffa00000, <span class="number">0x00000000ffa00000</span>, Ox00000000ffbo0000: Free</span><br><span class="line">Region: Ox00000000ffbo0000,0x00000000ffbo0000,Ox00000000ffco0000: Free</span><br><span class="line">Region: Ox00000000ffc00000, Ox00000000ffco0000, Ox00000000ffdo0000: Free</span><br><span class="line">Region: Ox00000000ffd00000, Ox00000000ffd00000, Ox00000000ffe00000: Free</span><br><span class="line">Region: Ox00000000ffe00000, <span class="number">0x00000000ffe2e240</span>,<span class="number">0x00000000fff00000</span>:Eden</span><br><span class="line"><span class="comment">//用于查看某个对象的信息（给对象地址）</span></span><br><span class="line">hsdb&gt; inspect Ox00000000fff389a8</span><br><span class="line">instance of oop <span class="keyword">for</span> java/lang/Class@ Ox00000000fff389a8 @ Ox00000000fff389a8 (size = <span class="number">1</span> </span><br><span class="line">a: <span class="number">0</span><span class="comment">//只是用static修饰，在初始化阶段赋值</span></span><br><span class="line">b: <span class="number">0</span><span class="comment">//只是用static修饰，在初始化阶段赋值</span></span><br><span class="line">c: <span class="number">153</span><span class="comment">//用static、final修饰，在连接阶段赋值</span></span><br></pre></td></tr></table></figure>

<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-27_15-00-10.png"></p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-27_15-00-46.png"></p>
<hr>
<ul>
<li>证明类对象属于堆内存</li>
</ul>
<p>scanoops begin end 全类名 ：查找某个范围内某种类型的全部对象的地址<br>inspect 对象地址  ：查看对象的信息<br>因为随便跑一个程序，需要运行的类对象就会有上千个，要找一个类对象十分困难<br>所以将类对象赋给某个类的实例变量，找某个类的一两个实例比较容易，通过这个实例的成员方法定位类对象的地址<br>通过insptect 地址查看类对象信息</p>
<h2 id="静态代码块原理"><a href="#静态代码块原理" class="headerlink" title="静态代码块原理"></a>静态代码块原理</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> day03.loader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">0x77</span>;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Student.class init&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">b</span> <span class="operator">=</span> <span class="number">0x88</span>;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">//基本数据类型的常量不会出现在c-init方法中</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> <span class="number">0x99</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">m</span> <span class="operator">=</span> Short.MAX_VALUE + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">n</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">d</span> <span class="operator">=</span> <span class="number">0x55</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">e</span> <span class="operator">=</span> <span class="number">0x66</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将编译器编译后的字节码文件翻译成人类可读的形式</span></span><br><span class="line">D:\learn\tencentClass\interview\interview\target\classes\day03\loader&gt;javap -p -c -p Student.class</span><br><span class="line">    </span><br><span class="line"><span class="comment">//编译器将所有静态代码的赋值语句，静态代码块中的语句，合并到一个静态方法中【按照原来的顺序存放】，该方法会在类的初始化时才会调用，名叫c-init</span></span><br><span class="line"> <span class="keyword">static</span> &#123;&#125;;</span><br><span class="line">    Code:</span><br><span class="line">       <span class="number">0</span>: bipush        <span class="number">119</span>   				<span class="comment">//准备了一个常数119</span></span><br><span class="line">       <span class="number">2</span>: putstatic     #<span class="number">18</span>                 <span class="comment">// Field a:I  将常数赋值给a</span></span><br><span class="line">       <span class="number">5</span>: getstatic     #<span class="number">21</span>                 <span class="comment">// Field java/lang/System.out:Ljava/io/PrintStream拿到一个静态变量printStream</span></span><br><span class="line">       <span class="number">8</span>: ldc           #<span class="number">27</span>                 <span class="comment">// String Student.class init  准备好一个字符串【从常量池中取出#27的常量】</span></span><br><span class="line">      <span class="number">10</span>: invokevirtual #<span class="number">29</span>                 <span class="comment">// Method java/io/PrintStream.println:(Ljava/lang/String;)V  调用printStream的成员方法println，将字符串当成是参数传给println</span></span><br><span class="line">      <span class="number">13</span>: sipush        <span class="number">136</span>					<span class="comment">//准备一个常量 136</span></span><br><span class="line">      <span class="number">16</span>: putstatic     #<span class="number">35</span>                 <span class="comment">// Field b:I 将常数赋值给b</span></span><br><span class="line">          </span><br><span class="line">      <span class="number">19</span>: <span class="keyword">new</span>           #<span class="number">4</span>                  <span class="comment">// class java/lang/Object</span></span><br><span class="line">      <span class="number">22</span>: dup</span><br><span class="line">      <span class="number">23</span>: invokespecial #<span class="number">3</span>                  <span class="comment">// Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">      <span class="comment">//上面三行语句，创建一个Object对象</span></span><br><span class="line">      <span class="number">26</span>: putstatic     #<span class="number">38</span>                 <span class="comment">// Field n:Ljava/lang/Object; 将Object对象赋值给变量n</span></span><br><span class="line">      <span class="number">29</span>: <span class="keyword">return</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在申明变量时已经确定下来值，不用在后续的初始化中对其进行赋值</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> c;</span><br><span class="line">    descriptor: I</span><br><span class="line">    flags: ACC_STATIC, ACC_FINAL</span><br><span class="line">    ConstantValue: <span class="type">int</span> <span class="number">153</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> m;</span><br><span class="line">    descriptor: I</span><br><span class="line">    flags: ACC_STATIC, ACC_FINAL</span><br><span class="line">    ConstantValue: <span class="type">int</span> <span class="number">32768</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="final修饰基本数据类型变量原理"><a href="#final修饰基本数据类型变量原理" class="headerlink" title="final修饰基本数据类型变量原理"></a>final修饰基本数据类型变量原理</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> day03.loader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestFinal</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// c 是 final static 基本类型,不会触发Student类加载</span></span><br><span class="line">        System.out.println(Student.c);</span><br><span class="line">        System.in.read();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// m 是 final static 基本类型不会触发类加载</span></span><br><span class="line">        System.out.println(Student.m);</span><br><span class="line">        System.in.read();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// n 是 final static 引用类型，即会导致Student类的加载 又会导致Student类的初始化</span></span><br><span class="line">        System.out.println(Student.n);</span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line"><span class="keyword">package</span> day03.loader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">0x77</span>;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Student.class init&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">b</span> <span class="operator">=</span> <span class="number">0x88</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> <span class="number">0x99</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">m</span> <span class="operator">=</span> Short.MAX_VALUE + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">n</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">d</span> <span class="operator">=</span> <span class="number">0x55</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">e</span> <span class="operator">=</span> <span class="number">0x66</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>方法区中类的原始信息(Student)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//类的名字  </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">day03</span>.loader.Student @<span class="number">0x0000000800c01a00</span></span><br><span class="line">View Class Hierarchy</span><br><span class="line">Create .<span class="keyword">class</span> <span class="title class_">File</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//类继承的父类|接口    </span></span><br><span class="line">Super Class</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">java</span>.lang.Object @<span class="number">0x0000000800000d58</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">//类的成员(静态成员、实例成员)    </span></span><br><span class="line">Fields</span><br><span class="line"><span class="keyword">static</span> <span class="type">int</span> a; (offset = <span class="number">116</span>)</span><br><span class="line"><span class="keyword">static</span> <span class="type">int</span> b; (offset = <span class="number">120</span>)</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> c; (offset = <span class="number">124</span>)</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> m; (offset = <span class="number">128</span>)</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> java.lang.Object n; (offset = <span class="number">112</span>)</span><br><span class="line"><span class="type">int</span> d; (offset = <span class="number">12</span>)</span><br><span class="line"><span class="type">int</span> e; (offset = <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//类的方法</span></span><br><span class="line">Methods</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> &lt;init&gt;() @<span class="number">0x0000026d6cc06058</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> &lt;clinit&gt;() @<span class="number">0x0000026d6cc06108</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//类的常量池</span></span><br><span class="line">Constant Pool</span><br><span class="line">Constant Pool of [<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">day03</span>.loader.Student @<span class="number">0x0000000800c01a00</span>] @<span class="number">0x0000026d6cc03d58</span></span><br></pre></td></tr></table></figure>



<ul>
<li>基本数据类型的常量不会触发类加载</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> day03.loader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestFinal</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// c 是 final static 基本类型,不会触发Student类加载</span></span><br><span class="line">        System.out.println(Student.c);</span><br><span class="line">        System.in.read();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// m 是 final static 基本类型不会触发类加载</span></span><br><span class="line">        System.out.println(Student.m);</span><br><span class="line">        System.in.read();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// n 是 final static 引用类型，即会导致Student类的加载 又会导致Student类的初始化</span></span><br><span class="line">        System.out.println(Student.n);</span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Constant pool:</span><br><span class="line">   #<span class="number">1</span> = Methodref          #<span class="number">2.</span>#<span class="number">3</span>          <span class="comment">// java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">     .......</span><br><span class="line">  #<span class="number">30</span> = Utf8               ()I</span><br><span class="line">  #<span class="number">31</span> = Integer            <span class="number">32768</span></span><br><span class="line">  #<span class="number">32</span> = Fieldref           #<span class="number">13.</span>#<span class="number">33</span>        <span class="comment">// day03/loader/Student.n:Ljava/lang/Object;</span></span><br><span class="line"> .................</span><br><span class="line">  #<span class="number">54</span> = Utf8               TestFinal.java</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(java.lang.String[])</span> <span class="keyword">throws</span> java.io.IOException;</span><br><span class="line">    descriptor: ([Ljava/lang/String;)V</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=<span class="number">2</span>, locals=<span class="number">1</span>, args_size=<span class="number">1</span></span><br><span class="line">         <span class="number">0</span>: getstatic     #<span class="number">7</span>                  <span class="comment">// Field java/lang/System.out:Ljava/io/PrintStream;//获取一个printStream对象</span></span><br><span class="line">         <span class="number">3</span>: sipush        <span class="number">153</span>				  <span class="comment">//准备一个常量，写死在main方法中</span></span><br><span class="line">         <span class="number">6</span>: invokevirtual #<span class="number">15</span>                 <span class="comment">// Method java/io/PrintStream.println:(I)V 调用printStream对象的println方法</span></span><br><span class="line">         <span class="number">9</span>: getstatic     #<span class="number">21</span>                 <span class="comment">// Field java/lang/System.in:Ljava/io/InputStream;///获取一个InputStream对象</span></span><br><span class="line">        <span class="number">12</span>: invokevirtual #<span class="number">25</span>                 <span class="comment">// Method java/io/InputStream.read:()I 调用inputstream的read方法</span></span><br><span class="line">        <span class="number">15</span>: pop</span><br><span class="line">        <span class="number">16</span>: getstatic     #<span class="number">7</span>                  <span class="comment">// Field java/lang/System.out:Ljava/io/PrintStream;</span></span><br><span class="line">        <span class="number">19</span>: ldc           #<span class="number">31</span>                 <span class="comment">// int 32768   从常量池中获取#31的常量</span></span><br></pre></td></tr></table></figure>



<ul>
<li>小结</li>
</ul>
<ol>
<li>每个类都有自己的常量池</li>
<li>一个类使用另一个类的基本数据类型的常量，不会对目标类进行类加载包括后续行为，因为他会将本类中要使用目标类的基本常量写死到代码中，或存储到常量池中</li>
<li>如果数值&lt;&#x3D;short的范围，直接写死在代码中，否则放入该类的常量池中</li>
<li>short(32768 ~ -1,0 ~ 32767)</li>
</ol>
<h2 id="双亲委派"><a href="#双亲委派" class="headerlink" title="双亲委派"></a>双亲委派</h2><p>所谓的双亲委派,就是指优先委派上级类加载器进行加载,如果上级类加载器<br>能找到这个类,由上级加载,加载后该类也对下级加载器可见【对上级不可见】<br>找不到这个类,则下级类加载器才有资格执行加载<br>直接层层往上报，到Bootstrap ClassLoader 如果有就直接加载，对下级可见；没有就权力下放给Extension ClassLoader加载 如果有就加载，对下级可见，没有就将权力下放给Application ClassLoader加载</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-27_20-10-09.png"></p>
<hr>
<p>启动类加载器  tr.jar </p>
<p>扩展类加载器<br>应用程序加载器<br>自定义类加载器</p>
<ul>
<li>自己编写类加载器就能加载一个假冒的java.lang.System 【不能】</li>
</ul>
<ol>
<li>假设你自己的类加载器用双亲委派,那么优先由启动类加载器加载真正的java.lang.System,自然不会加载假冒的</li>
<li>假设你自己的类加载器不用双亲委派,那么你的类加载器加载假冒的java.lang.System 时,它需要先加载父类java.lang.Object,而你没有用委派,找不到java.lang.Object所以加载会失败</li>
</ol>
<p>以上也仅仅是假设。实际操作你就会发现自定义类加载器加载以java.打头的类时,会抛安全异常,在jdk9以上版本这些特殊包名都与模块进行了绑定,更连编译都过不了</p>
<ul>
<li>双亲委派的目的有两点</li>
</ul>
<p>让上级类加载器中的类对下级共享(反之不行),即能让你的类能依赖到jdk提供的核心类<br>让类的加载有忧先次序,保证核心类优先加载</p>
<h2 id="对象引用类型分为哪几类"><a href="#对象引用类型分为哪几类" class="headerlink" title="对象引用类型分为哪几类"></a>对象引用类型分为哪几类</h2><ol>
<li>强引用</li>
</ol>
<p>只要用赋值运算符让变量引用对象都是强引用，A a&#x3D;new A();<br>通过GC Root的引用链,如果强引用不到该对象,该对象才能被回收</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-27_21-02-08.png"></p>
<hr>
<ol start="2">
<li>软引用(SoftReference)</li>
</ol>
<p>例如: SoftReference a &#x3D; new SoftReference(new A());【变量直接引用软引用，软引用里面包装类其他对象】<br>如果仅有软引用该对象时,首次垃圾回收不会回收该对象,如果内存仍不足,再次回收时才会释放对象；【GC可以强行断开软引用包装的对象与变量之间的关系】<br>软引用自身需要配合引用队列来释放【GC不能断开变量与软引用对象之间的关系】<br>典型例子是反射数据 </p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-27_21-02-37.png"></p>
<hr>
<ol start="3">
<li>弱引用(WeakReference)</li>
</ol>
<p>例如: WeakReference a &#x3D; new WeakReference(new A());<br>如果仅有弱引用引用该对象时,只要发生垃圾回收,就会释放该对象<br>弱引用自身需要配合引用队列来<br>释放典型例子是ThreadLocalMap 中的Entry对象 key与key的值之间是弱引用</p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-27_21-03-02.png"></p>
<hr>
<ol start="4">
<li>虚引用(PhantomReference)</li>
</ol>
<p>例如: PhantomReference a &#x3D; new PhantomReference(newA());<br>必须配合引用队列一起使用,当虚引用引用的对象被回收时,会将虚引用对象入队,由Reference Handler线程释放其关联的外部资源<br>典型例子是Cleaner释放DirectByteBuffer 占用的直接内存 </p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/image-20220823223533970.png" alt="image-20220823223533970"></p>
<hr>
<h3 id="虚引用"><a href="#虚引用" class="headerlink" title="虚引用"></a>虚引用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> day03.reference;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> day02.LoggerUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.ref.*;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestPhantomReference</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        <span class="comment">//引用队列</span></span><br><span class="line">        ReferenceQueue&lt;String&gt; queue = <span class="keyword">new</span> <span class="title class_">ReferenceQueue</span>&lt;&gt;();</span><br><span class="line">        List&lt;MyResource&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        list.add(<span class="keyword">new</span> <span class="title class_">MyResource</span>(<span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;a&quot;</span>), queue));</span><br><span class="line">        <span class="comment">//&quot;b&quot;是在字符串常量池中的，GC不会清除它</span></span><br><span class="line">        list.add(<span class="keyword">new</span> <span class="title class_">MyResource</span>(<span class="string">&quot;b&quot;</span>, queue));</span><br><span class="line">        list.add(<span class="keyword">new</span> <span class="title class_">MyResource</span>(<span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;c&quot;</span>), queue));</span><br><span class="line">        <span class="comment">// 主动触发垃圾回收</span></span><br><span class="line">        System.gc();</span><br><span class="line">        Thread.sleep(<span class="number">100</span>);</span><br><span class="line">        Object ref;</span><br><span class="line">        <span class="comment">//从队列中取元素</span></span><br><span class="line">        <span class="keyword">while</span> ((ref = queue.poll()) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//这个因该是相当于MyResource resource =(MyResource)resource</span></span><br><span class="line">            <span class="keyword">if</span> (ref <span class="keyword">instanceof</span> MyResource resource) &#123;</span><br><span class="line">                resource.clean();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyResource</span> <span class="keyword">extends</span> <span class="title class_">PhantomReference</span>&lt;String&gt; &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">MyResource</span><span class="params">(String referent, ReferenceQueue&lt;? <span class="built_in">super</span> String&gt; q)</span> &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                Reference(T referent, ReferenceQueue&lt;? super T&gt; queue) &#123;</span></span><br><span class="line"><span class="comment">                //虚引用对象引用的对象</span></span><br><span class="line"><span class="comment">                this.referent = referent;</span></span><br><span class="line"><span class="comment">                //虚引用对象引用的对象被垃圾回收后，虚引用对象需要进入的队列</span></span><br><span class="line"><span class="comment">                this.queue = (queue == null) ? ReferenceQueue.NULL : queue;</span></span><br><span class="line"><span class="comment">                 &#125;</span></span><br><span class="line"><span class="comment">            * */</span></span><br><span class="line">            <span class="built_in">super</span>(referent, q);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 释放外部资源的方法</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">clean</span><span class="params">()</span> &#123;</span><br><span class="line">            LoggerUtils.get().debug(<span class="string">&quot;clean&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">=====================================</span><br><span class="line">[DEBUG] <span class="number">21</span>:<span class="number">13</span>:<span class="number">58.130</span> [main] - clean </span><br><span class="line">[DEBUG] <span class="number">21</span>:<span class="number">13</span>:<span class="number">58.131</span> [main] - clean </span><br><span class="line">    </span><br><span class="line">进程已结束，退出代码为 <span class="number">0</span></span><br></pre></td></tr></table></figure>



<h3 id="弱引用"><a href="#弱引用" class="headerlink" title="弱引用"></a>弱引用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> day03.reference;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.ref.ReferenceQueue;</span><br><span class="line"><span class="keyword">import</span> java.lang.ref.WeakReference;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestWeakReference</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">MyWeakMap</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyWeakMap</span>();</span><br><span class="line">        map.put(<span class="number">0</span>, <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;a&quot;</span>), <span class="string">&quot;1&quot;</span>);</span><br><span class="line">        map.put(<span class="number">1</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;2&quot;</span>);</span><br><span class="line">        map.put(<span class="number">2</span>, <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;c&quot;</span>), <span class="string">&quot;3&quot;</span>);</span><br><span class="line">        map.put(<span class="number">3</span>, <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;d&quot;</span>), <span class="string">&quot;4&quot;</span>);</span><br><span class="line">        System.out.println(map);</span><br><span class="line"></span><br><span class="line">        System.gc();</span><br><span class="line">        System.out.println(<span class="string">&quot;键为a的value是：&quot;</span> + map.get(<span class="string">&quot;a&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;键为b的value是：&quot;</span> + map.get(<span class="string">&quot;b&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;键为c的value是：&quot;</span> + map.get(<span class="string">&quot;c&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;键为d的value是：&quot;</span> + map.get(<span class="string">&quot;d&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;gc后的map是：&quot;</span> + map);</span><br><span class="line">        map.clean();</span><br><span class="line">        System.out.println(map);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 模拟 ThreadLocalMap 的内存泄漏问题以及一种解决方法</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyWeakMap</span> &#123;</span><br><span class="line">        <span class="comment">//jdk的ThreadLoalMap没有用这队列</span></span><br><span class="line">        <span class="comment">//存放弱引用的引用队列</span></span><br><span class="line">        <span class="keyword">static</span> ReferenceQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">ReferenceQueue</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//弱引用类  table————————》entry--------------》String</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Entry</span> <span class="keyword">extends</span> <span class="title class_">WeakReference</span>&lt;String&gt; &#123;</span><br><span class="line">            String value;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="title function_">Entry</span><span class="params">(String key, String value)</span> &#123;</span><br><span class="line">                <span class="comment">//键是弱引用，当key的值(对象)被释放后，会将当前Entry实例放到队列中</span></span><br><span class="line">                <span class="built_in">super</span>(key, queue);</span><br><span class="line">                <span class="comment">//值是强引用</span></span><br><span class="line">                <span class="built_in">this</span>.value = value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">clean</span><span class="params">()</span> &#123;</span><br><span class="line">            Object ref;</span><br><span class="line">            <span class="keyword">while</span> ((ref = queue.poll()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                System.out.println(ref);</span><br><span class="line">                <span class="comment">//遍历Entry数组</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; table.length; i++) &#123;</span><br><span class="line">                    <span class="comment">//只要引用队列中的Entry对象，与table中的entry对象是同一个就可以将该table元素设置为null</span></span><br><span class="line">                    <span class="keyword">if</span> (table[i] == ref) &#123;</span><br><span class="line">                        <span class="comment">//table 与多个entry之间的强引用就没了，下次GC就可以清除</span></span><br><span class="line">                        table[i] = <span class="literal">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Entry[] table = <span class="keyword">new</span> <span class="title class_">Entry</span>[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(<span class="type">int</span> index, String key, String value)</span> &#123;</span><br><span class="line">            table[index] = <span class="keyword">new</span> <span class="title class_">Entry</span>(key, value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">get</span><span class="params">(String key)</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (Entry entry : table) &#123;</span><br><span class="line">                <span class="keyword">if</span> (entry != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//通过弱引用的get方法获取用弱引用包装的对象【键的值】</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">k</span> <span class="operator">=</span> entry.get();</span><br><span class="line">                    <span class="keyword">if</span> (k != <span class="literal">null</span> &amp;&amp; k.equals(key)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> entry.value;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            sb.append(<span class="string">&quot;[&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (Entry entry : table) &#123;</span><br><span class="line">                <span class="keyword">if</span> (entry != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">k</span> <span class="operator">=</span> entry.get();</span><br><span class="line">                    sb.append(k).append(<span class="string">&quot;:&quot;</span>).append(entry.value).append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (sb.length() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                sb.deleteCharAt(sb.length() - <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            sb.append(<span class="string">&quot;]&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> sb.toString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">===================================================================</span><br><span class="line">[a:<span class="number">1</span>,b:<span class="number">2</span>,c:<span class="number">3</span>,d:<span class="number">4</span>]</span><br><span class="line">键为a的value是：<span class="literal">null</span></span><br><span class="line">键为b的value是：<span class="number">2</span></span><br><span class="line">键为c的value是：<span class="literal">null</span></span><br><span class="line">键为d的value是：<span class="literal">null</span></span><br><span class="line">gc后的map是：[<span class="literal">null</span>:<span class="number">1</span>,b:<span class="number">2</span>,<span class="literal">null</span>:<span class="number">3</span>,<span class="literal">null</span>:<span class="number">4</span>]</span><br><span class="line">day03.reference.TestWeakReference$MyWeakMap$Entry@621be5d1</span><br><span class="line">day03.reference.TestWeakReference$MyWeakMap$Entry@573fd745</span><br><span class="line">day03.reference.TestWeakReference$MyWeakMap$Entry@15327b79</span><br><span class="line">[b:<span class="number">2</span>]</span><br></pre></td></tr></table></figure>



<h3 id="Cleaner"><a href="#Cleaner" class="headerlink" title="Cleaner"></a>Cleaner</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> day03.reference;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> day02.LoggerUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.ref.Cleaner;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 前面讲的弱、虚引用配合引用队列，目的都是为了找到哪些 java对象被回收，确定弱引用对象，从而进行对它们关联的资源进行进一步清理</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 为了简化 api 难度，从 java 9 开始引入了 Cleaner 对象，cleaner对象里面其实也是一些虚引用，弱引用，引用队列；但它专门开辟了一个线程用于对在引用队列中的引用释放相关资源</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestCleaner1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Cleaner</span> <span class="variable">cleaner</span> <span class="operator">=</span> Cleaner.create();</span><br><span class="line">        <span class="comment">//第一个参数是可能被GC回收的资源，第二个参数是回收之后执行的逻辑</span></span><br><span class="line">        cleaner.register(<span class="keyword">new</span> <span class="title class_">MyResource</span>(), () -&gt; LoggerUtils.get().debug(<span class="string">&quot;clean 1&quot;</span>));</span><br><span class="line">        cleaner.register(<span class="keyword">new</span> <span class="title class_">MyResource</span>(), () -&gt; LoggerUtils.get().debug(<span class="string">&quot;clean 2&quot;</span>));</span><br><span class="line">        cleaner.register(<span class="keyword">new</span> <span class="title class_">MyResource</span>(), () -&gt; LoggerUtils.get().debug(<span class="string">&quot;clean 3&quot;</span>));</span><br><span class="line">        <span class="type">MyResource</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyResource</span>();</span><br><span class="line">        cleaner.register(obj, () -&gt; LoggerUtils.get().debug(<span class="string">&quot;clean 4&quot;</span>));</span><br><span class="line">        cleaner.register(<span class="keyword">new</span> <span class="title class_">MyResource</span>(), () -&gt; LoggerUtils.get().debug(<span class="string">&quot;clean 5&quot;</span>));</span><br><span class="line">        cleaner.register(<span class="keyword">new</span> <span class="title class_">MyResource</span>(), () -&gt; LoggerUtils.get().debug(<span class="string">&quot;clean 6&quot;</span>));</span><br><span class="line"></span><br><span class="line">        System.gc();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//执行回收后逻辑的线程是守护线程，如果main线程执行完毕，守护线程也会结束</span></span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyResource</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">======================================</span><br><span class="line">[DEBUG] <span class="number">23</span>:<span class="number">38</span>:<span class="number">15.732</span> [Cleaner-<span class="number">0</span>] - clean <span class="number">6</span> </span><br><span class="line">[DEBUG] <span class="number">23</span>:<span class="number">38</span>:<span class="number">15.733</span> [Cleaner-<span class="number">0</span>] - clean <span class="number">5</span> </span><br><span class="line">[DEBUG] <span class="number">23</span>:<span class="number">38</span>:<span class="number">15.734</span> [Cleaner-<span class="number">0</span>] - clean <span class="number">3</span> </span><br><span class="line">[DEBUG] <span class="number">23</span>:<span class="number">38</span>:<span class="number">15.734</span> [Cleaner-<span class="number">0</span>] - clean <span class="number">2</span> </span><br><span class="line">[DEBUG] <span class="number">23</span>:<span class="number">38</span>:<span class="number">15.734</span> [Cleaner-<span class="number">0</span>] - clean <span class="number">1</span> </span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> day03.reference;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> day02.LoggerUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="comment">//jdk内部使用的类(直接内存会使用到这个类)</span></span><br><span class="line"><span class="keyword">import</span> jdk.internal.ref.Cleaner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestCleaner2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Cleaner</span> <span class="variable">cleaner1</span> <span class="operator">=</span> Cleaner.create(<span class="keyword">new</span> <span class="title class_">MyResource</span>(), () -&gt; LoggerUtils.get().debug(<span class="string">&quot;clean 1&quot;</span>));</span><br><span class="line">        <span class="type">Cleaner</span> <span class="variable">cleaner2</span> <span class="operator">=</span> Cleaner.create(<span class="keyword">new</span> <span class="title class_">MyResource</span>(), () -&gt; LoggerUtils.get().debug(<span class="string">&quot;clean 2&quot;</span>));</span><br><span class="line">        <span class="type">Cleaner</span> <span class="variable">cleaner3</span> <span class="operator">=</span> Cleaner.create(<span class="keyword">new</span> <span class="title class_">MyResource</span>(), () -&gt; LoggerUtils.get().debug(<span class="string">&quot;clean 3&quot;</span>));</span><br><span class="line">        <span class="type">Cleaner</span> <span class="variable">cleaner4</span> <span class="operator">=</span> Cleaner.create(<span class="keyword">new</span> <span class="title class_">MyResource</span>(), () -&gt; LoggerUtils.get().debug(<span class="string">&quot;clean 4&quot;</span>));</span><br><span class="line"></span><br><span class="line">        System.gc();</span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyResource</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">==================================</span><br><span class="line"><span class="comment">//不会调参数</span></span><br></pre></td></tr></table></figure>



<h2 id="finalize的理解"><a href="#finalize的理解" class="headerlink" title="finalize的理解"></a>finalize的理解</h2><p>一般的回答是:它是Object中的一个方法,子类重写它,垃圾回收子类对象时，子类对象重写的finalize方法会被调用,可以在其中进行一些资源释放和清理工作<br>较为优秀的回答是:将资源释放和清理放在finalize方法中非常不好,非常影响性能,严重时甚至会引起0OM,从Java9 开始就被标注为@Deprecated,不建议被使用了</p>
<ul>
<li>代码体现</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> day03.reference;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestFinalize</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">fgcy</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="string">&quot;fgcy&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Dog</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Dog</span><span class="params">(String name)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.name = name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//重写Objcet类的finalize方法，当该对象被GC回收时，会先掉调用该方法，再回收对象</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">finalize</span><span class="params">()</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">            fgcy.debug(<span class="string">&quot;&#123;&#125;被干掉了?&quot;</span>, <span class="built_in">this</span>.name);</span><br><span class="line">            <span class="comment">//如果将 finalize 中的代码出现异常，会发现根本没有异常输出</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Dog</span>(<span class="string">&quot;大傻&quot;</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Dog</span>(<span class="string">&quot;二哈&quot;</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Dog</span>(<span class="string">&quot;三笨&quot;</span>);</span><br><span class="line">        System.gc();</span><br><span class="line">        <span class="comment">//运行finalize方法的Finalizer线程是一个守护线程，当main线程不再运行时，Finalizer线程也会消亡</span></span><br><span class="line">        <span class="comment">//使主线程处于等待状态</span></span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    第一，从表面上我们能看出来 finalize 方法的调用次序并不能保证,因为我们不能决定gc回收对象的顺序</span></span><br><span class="line"><span class="comment">    第二，日志中的 Finalizer 表示输出日志的线程名称，从这我们看出是这个叫做 Finalizer 的线程调用的 finalize 方法</span></span><br><span class="line"><span class="comment">    第三，你不能注释掉 `System.in.read()`，否则会发现（绝大概率）并不会有任何输出结果了，从这我们看出 finalize 中的代码并不能保证被执行</span></span><br><span class="line"><span class="comment">    第四，如果将 finalize 中的代码出现异常，会发现根本没有异常输出</span></span><br><span class="line"><span class="comment">    第五，还有个疑问，垃圾回收时就会立刻调用  finalize 方法吗？</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">&#125;</span><br><span class="line">======================================</span><br><span class="line">[DEBUG] <span class="number">17</span>:<span class="number">14</span>:<span class="number">39.577</span> [Finalizer] - 二哈被干掉了? </span><br><span class="line">[DEBUG] <span class="number">17</span>:<span class="number">14</span>:<span class="number">39.580</span> [Finalizer] - 三笨被干掉了? </span><br><span class="line">[DEBUG] <span class="number">17</span>:<span class="number">14</span>:<span class="number">39.580</span> [Finalizer] - 大傻被干掉了? </span><br></pre></td></tr></table></figure>



<h2 id="finalize的执行原理"><a href="#finalize的执行原理" class="headerlink" title="finalize的执行原理"></a>finalize的执行原理</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1. 创建狗对象  </span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Dog</span>(<span class="string">&quot;大傻&quot;</span>);</span><br><span class="line"><span class="comment">//2.调用父类Object构造器</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">Object</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//3. 通过finalizer类的register方法，将狗对象包装成Finalizer对象</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(Object finalizee)</span> &#123;</span><br><span class="line">     <span class="keyword">new</span> <span class="title class_">Finalizer</span>(finalizee);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//4. 初始化finalizer对象，并将其添加到链表中</span></span><br><span class="line"><span class="keyword">private</span> <span class="title function_">Finalizer</span><span class="params">(Object finalizee)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(finalizee, queue);</span><br><span class="line">        <span class="comment">// push onto unfinalized</span></span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            <span class="keyword">if</span> (unfinalized != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.next = unfinalized;</span><br><span class="line">                unfinalized.prev = <span class="built_in">this</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//unfinalized是一个双向链表，用于存储finalizer对象</span></span><br><span class="line">            <span class="comment">//unfinalized就是一个finalizer类型的实例，用于管理所有重写了finalized方法的对象</span></span><br><span class="line">            unfinalized = <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//5. 创建一个名为Finalizer的守护线程</span></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">FinalizerThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> running;</span><br><span class="line">        FinalizerThread(ThreadGroup g) &#123;</span><br><span class="line">            <span class="built_in">super</span>(g, <span class="literal">null</span>, <span class="string">&quot;Finalizer&quot;</span>, <span class="number">0</span>, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">     <span class="comment">//线程主要是从引用队列中拿出jvm想要清除的狗对象关联的finalizer对象</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">// in case of recursive call to run()</span></span><br><span class="line">            <span class="keyword">if</span> (running)</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Finalizer thread starts before System.initializeSystemClass</span></span><br><span class="line">            <span class="comment">// is called.  Wait until JavaLangAccess is available</span></span><br><span class="line">            <span class="keyword">while</span> (VM.initLevel() == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// delay until VM completes initialization</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    VM.awaitInitLevel(<span class="number">1</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException x) &#123;</span><br><span class="line">                    <span class="comment">// ignore and continue</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">JavaLangAccess</span> <span class="variable">jla</span> <span class="operator">=</span> SharedSecrets.getJavaLangAccess();</span><br><span class="line">            running = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//拿出jvm想要清除的狗对象关联的finalizer对象</span></span><br><span class="line">                    <span class="type">Finalizer</span> <span class="variable">f</span> <span class="operator">=</span> (Finalizer)queue.remove();</span><br><span class="line">                    <span class="comment">//操作finalizer对象</span></span><br><span class="line">                    f.runFinalizer(jla);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException x) &#123;</span><br><span class="line">                    <span class="comment">// ignore and continue</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//操作finalizer对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">runFinalizer</span><span class="params">(JavaLangAccess jla)</span> &#123;</span><br><span class="line">        <span class="comment">//将finialzer对象从unfianlized双列表中断开</span></span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.next == <span class="built_in">this</span>)      <span class="comment">// already finalized</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            <span class="comment">// unlink from unfinalized</span></span><br><span class="line">            <span class="keyword">if</span> (unfinalized == <span class="built_in">this</span>)</span><br><span class="line">                unfinalized = <span class="built_in">this</span>.next;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">this</span>.prev.next = <span class="built_in">this</span>.next;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.next != <span class="literal">null</span>)</span><br><span class="line">                <span class="built_in">this</span>.next.prev = <span class="built_in">this</span>.prev;</span><br><span class="line">            <span class="built_in">this</span>.prev = <span class="literal">null</span>;</span><br><span class="line">            <span class="built_in">this</span>.next = <span class="built_in">this</span>;           <span class="comment">// mark as finalized</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">finalizee</span> <span class="operator">=</span> <span class="built_in">this</span>.get();</span><br><span class="line">            <span class="keyword">assert</span> finalizee != <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (!(finalizee <span class="keyword">instanceof</span> java.lang.Enum)) &#123;</span><br><span class="line">                </span><br><span class="line">               <span class="comment">//调用finalizee(狗对象)的finalized方法</span></span><br><span class="line">                jla.invokeFinalize(finalizee);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Clear stack slot containing this variable, to decrease</span></span><br><span class="line">                <span class="comment">// the chances of false retention with a conservative GC</span></span><br><span class="line">                finalizee = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//当发生异常时什么也不做，俗称把异常吞了，调用者甚至不知道有没有释放资源</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable x) &#123; &#125;</span><br><span class="line">        <span class="built_in">super</span>.clear();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-29_17-57-46.png"></p>
<hr>
<ul>
<li>unfinalized队列</li>
</ul>
<p>当重写了finalize方法的对象,在构造方法调用之时,JVM都会将其包装成一个Finalizer 对象,并加入 unfinalized 队列中(静态成员变量、双向链表结构) </p>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-29_19-37-23.png"></p>
<hr>
<ul>
<li>ReferenceQueue队列</li>
</ul>
<p>第二个重要的队列,也是Finalizer类中一个静态成员变量,名为queue(是一个单向链表结构),刚开始它是空的。当狗对象可以被当作垃圾回收时,就会把这些狗对象对应的Finalizer 对象加入这个队列，但注意，此时狗对象并没有被回收，因为还要调用finalized方法；等下一次内存不足触发GC这些狗对象才有可能被清除掉</p>
<h3 id="真正回收时机"><a href="#真正回收时机" class="headerlink" title="真正回收时机"></a>真正回收时机</h3><hr>
<p><img src="https://cdn.jsdelivr.net/gh/fgcy-333/gitnote-images/Snipaste_2022-03-29_20-01-43.png"></p>
<hr>
<p>即使Dog对象没人引用,垃圾回收时也没法立刻回收它,因为Finalizer还在引用它嘛,为的是【先别着急回收啊,等我调完finalize方法,再回收】<br>查看FinalizerThread 线程内的代码,这个线程从ReferenceQueue 中逐一取出每个Finalizer对象,把它们从链表断开,这样没谁能引用到它,以及其对应的狗对象,所以下次gc时就可以被回收了。</p>
<h2 id="为什么finalize方法非常不好-非常影响性能"><a href="#为什么finalize方法非常不好-非常影响性能" class="headerlink" title="为什么finalize方法非常不好,非常影响性能"></a>为什么finalize方法非常不好,非常影响性能</h2><h3 id="非常不好"><a href="#非常不好" class="headerlink" title="非常不好"></a>非常不好</h3><ol>
<li>FinalizerThread 是守护线程,代码很有可能没来得及执行完,线程就结束了,造成资源没有正确释放</li>
<li>异常被吞掉这个就太糟了,你甚至不能判断有没有在释放资源时发生错误.</li>
</ol>
<h3 id="影响性能"><a href="#影响性能" class="headerlink" title="影响性能"></a>影响性能</h3><ol>
<li>重写了finalize 方法的对象在第一次被gc时,并不能及时释放它占用的内存,因为要等着FinalizerThread 调用完finalize,把它从第一个unfinalized队列移除后,第二次gc时才能真正释放内存</li>
<li>可以想象gc本就因为内存不足引起,finalize 调用又很慢(两个队列的移除操作,都是串行执行的,用来释放连接类的资源也应该不快),不能及时释放内存,对象释放不及时就会逐渐移入老年代,老年代垃圾积累过多就会容易full gc, full gc后释放速度如果仍跟不上创建新对象的速度,就会OOM<br>质疑</li>
</ol>
<h3 id="质疑"><a href="#质疑" class="headerlink" title="质疑"></a>质疑</h3><p>有的文章提到【Finalizer线程会和我们的主线程进行竞争,不过由于它的优先级较低,获取到的CPU时间较少,因此它永远也赶不上主线程的步伐】这个显然是错误的, FinalizerThread的优先级较普通线程更高,赶不上步伐的原因应该是finalize执行慢等原因综合导致</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">       <span class="type">ThreadGroup</span> <span class="variable">tg</span> <span class="operator">=</span> Thread.currentThread().getThreadGroup();</span><br><span class="line">       <span class="keyword">for</span> (<span class="type">ThreadGroup</span> <span class="variable">tgn</span> <span class="operator">=</span> tg;</span><br><span class="line">            tgn != <span class="literal">null</span>;</span><br><span class="line">            tg = tgn, tgn = tg.getParent());</span><br><span class="line">       <span class="type">Thread</span> <span class="variable">finalizer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FinalizerThread</span>(tg);</span><br><span class="line">    	<span class="comment">//普通线程优先级是五，这个是八</span></span><br><span class="line">       finalizer.setPriority(Thread.MAX_PRIORITY - <span class="number">2</span>);</span><br><span class="line">    	<span class="comment">//这是一个守护线程，即当其他的非守护线程都结束了，守护线程就要结束</span></span><br><span class="line">       finalizer.setDaemon(<span class="literal">true</span>);</span><br><span class="line">       finalizer.start();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/03/30/%E8%99%9A%E6%8B%9F%E6%9C%BA-itcast/" data-id="clfv6vsx3003ve4cx3xzoe82p" data-title="虚拟机-itcast" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java%E8%99%9A%E6%8B%9F%E6%9C%BA-itcast/" rel="tag">java虚拟机-itcast</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2023/03/30/%E6%A1%86%E6%9E%B6%E7%AF%87-itcast/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          框架篇-itcast
        
      </div>
    </a>
  
  
    <a href="/2023/03/30/File%E4%B8%8E%E9%80%92%E5%BD%92%E4%B8%8EIO-heima/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">File与递归与IO-heima</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%8D%9A%E5%AE%A2%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">博客学习笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%A7%86%E9%A2%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">视频学习笔记</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AIO/" rel="tag">AIO</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/BIO/" rel="tag">BIO</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IO%E6%A8%A1%E5%9E%8B-heima/" rel="tag">IO模型-heima</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JVM-heima/" rel="tag">JVM-heima</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java%E5%9F%BA%E7%A1%80-heima/" rel="tag">Java基础-heima</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95-atguigu/" rel="tag">Java数据结构与算法-atguigu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mybatis-DongLi/" rel="tag">Mybatis-DongLi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NIO/" rel="tag">NIO</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-DongLi/" rel="tag">Spring-DongLi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringBoot-DongLi/" rel="tag">SpringBoot-DongLi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringMVC-DongLi/" rel="tag">SpringMVC-DongLi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringSecurity-sg/" rel="tag">SpringSecurity-sg</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue-atguigu/" rel="tag">Vue-atguigu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dubbo-heima/" rel="tag">dubbo-heima</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git-atguigu/" rel="tag">git-atguigu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java%E5%9F%BA%E7%A1%80-itcast/" rel="tag">java基础-itcast</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java%E5%B9%B6%E5%8F%91-itcast/" rel="tag">java并发-itcast</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java%E6%A1%86%E6%9E%B6-itcast/" rel="tag">java框架-itcast</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java%E8%99%9A%E6%8B%9F%E6%9C%BA-itcast/" rel="tag">java虚拟机-itcast</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/servlet/" rel="tag">servlet</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%8B%E5%8A%A1/" rel="tag">事务</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86-DongLi/" rel="tag">动态代理-DongLi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B0%9A%E7%A1%85%E8%B0%B7/" rel="tag">尚硅谷</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B0%9A%E7%A1%85%E8%B0%B7-%E5%AE%8B%E7%BA%A2%E5%BA%B7-MySQL-%E5%88%9D%E7%BA%A7/" rel="tag">尚硅谷-宋红康-MySQL(初级)</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B0%9A%E7%A1%85%E8%B0%B7-%E5%AE%8B%E7%BA%A2%E5%BA%B7-MySQL-%E9%AB%98%E7%BA%A7/" rel="tag">尚硅谷-宋红康-MySQL(高级)</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%9F%BA%E7%A1%80-msb/" rel="tag">操作系统基础-msb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/" rel="tag">网络基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%A9%AC%E5%A3%AB%E5%85%B5/" rel="tag">马士兵</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/AIO/" style="font-size: 10px;">AIO</a> <a href="/tags/BIO/" style="font-size: 10px;">BIO</a> <a href="/tags/IO%E6%A8%A1%E5%9E%8B-heima/" style="font-size: 10px;">IO模型-heima</a> <a href="/tags/JVM-heima/" style="font-size: 10px;">JVM-heima</a> <a href="/tags/Java%E5%9F%BA%E7%A1%80-heima/" style="font-size: 20px;">Java基础-heima</a> <a href="/tags/Java%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95-atguigu/" style="font-size: 10px;">Java数据结构与算法-atguigu</a> <a href="/tags/MySQL/" style="font-size: 10px;">MySQL</a> <a href="/tags/Mybatis-DongLi/" style="font-size: 10px;">Mybatis-DongLi</a> <a href="/tags/NIO/" style="font-size: 10px;">NIO</a> <a href="/tags/Spring-DongLi/" style="font-size: 10px;">Spring-DongLi</a> <a href="/tags/SpringBoot-DongLi/" style="font-size: 10px;">SpringBoot-DongLi</a> <a href="/tags/SpringMVC-DongLi/" style="font-size: 10px;">SpringMVC-DongLi</a> <a href="/tags/SpringSecurity-sg/" style="font-size: 10px;">SpringSecurity-sg</a> <a href="/tags/Vue-atguigu/" style="font-size: 10px;">Vue-atguigu</a> <a href="/tags/dubbo-heima/" style="font-size: 10px;">dubbo-heima</a> <a href="/tags/git-atguigu/" style="font-size: 10px;">git-atguigu</a> <a href="/tags/java%E5%9F%BA%E7%A1%80-itcast/" style="font-size: 10px;">java基础-itcast</a> <a href="/tags/java%E5%B9%B6%E5%8F%91-itcast/" style="font-size: 10px;">java并发-itcast</a> <a href="/tags/java%E6%A1%86%E6%9E%B6-itcast/" style="font-size: 10px;">java框架-itcast</a> <a href="/tags/java%E8%99%9A%E6%8B%9F%E6%9C%BA-itcast/" style="font-size: 10px;">java虚拟机-itcast</a> <a href="/tags/servlet/" style="font-size: 10px;">servlet</a> <a href="/tags/%E4%BA%8B%E5%8A%A1/" style="font-size: 10px;">事务</a> <a href="/tags/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86-DongLi/" style="font-size: 10px;">动态代理-DongLi</a> <a href="/tags/%E5%B0%9A%E7%A1%85%E8%B0%B7/" style="font-size: 10px;">尚硅谷</a> <a href="/tags/%E5%B0%9A%E7%A1%85%E8%B0%B7-%E5%AE%8B%E7%BA%A2%E5%BA%B7-MySQL-%E5%88%9D%E7%BA%A7/" style="font-size: 13.33px;">尚硅谷-宋红康-MySQL(初级)</a> <a href="/tags/%E5%B0%9A%E7%A1%85%E8%B0%B7-%E5%AE%8B%E7%BA%A2%E5%BA%B7-MySQL-%E9%AB%98%E7%BA%A7/" style="font-size: 16.67px;">尚硅谷-宋红康-MySQL(高级)</a> <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%9F%BA%E7%A1%80-msb/" style="font-size: 10px;">操作系统基础-msb</a> <a href="/tags/%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/" style="font-size: 10px;">网络基础</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 10px;">设计模式</a> <a href="/tags/%E9%A9%AC%E5%A3%AB%E5%85%B5/" style="font-size: 10px;">马士兵</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">March 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/03/30/%E7%AC%AC03%E7%AB%A0-%E5%9F%BA%E6%9C%AC%E7%9A%84SELECT%E8%AF%AD%E5%8F%A5-atguigu-shk/">第03章-基本的SELECT语句-atguigu-shk</a>
          </li>
        
          <li>
            <a href="/2023/03/30/char%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B-heima-xl/">char数据类型-heima-xl</a>
          </li>
        
          <li>
            <a href="/2023/03/30/Collection%E4%B8%8E%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8EList%E4%B8%8E%E6%B3%9B%E5%9E%8B%E6%B7%B1%E5%85%A5-heima-xl/">Collection与数据结构与List与泛型深入-heima-xl</a>
          </li>
        
          <li>
            <a href="/2023/03/30/JAVA-IO-%E4%B8%8B-heima-xl/">JAVA-IO-下-heima-xl</a>
          </li>
        
          <li>
            <a href="/2023/03/30/Set%E4%B8%8ECollections%E4%B8%8EMap%E4%B8%8E%E9%9B%86%E5%90%88%E5%B5%8C%E5%A5%97-heima-xl/">Set与Collections与Map与集合嵌套-heima-xl</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>